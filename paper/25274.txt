                             NBER WORKING PAPER SERIES




       RATIONALIZING RATIONAL EXPECTATIONS? TESTS AND DEVIATIONS

                                    Xavier D'Haultfoeuille
                                     Christophe Gaillac
                                       Arnaud Maurel

                                     Working Paper 25274
                             http://www.nber.org/papers/w25274


                    NATIONAL BUREAU OF ECONOMIC RESEARCH
                             1050 Massachusetts Avenue
                               Cambridge, MA 02138
                                  November 2018




We thank Peter Arcidiacono, Federico Bugni, Zhuoli Chen, Valentina Corradi, Gregory Jolivet,
Jia Li, Matt Masten, Andrew Patton, Basit Zafar, Yichong Zhang and seminar participants at
Amsterdam, Arizona State, Bocconi, CREST, Duke, Helsinki, Mannheim, National University of
Singapore, Singapore Management University, Surrey, Toulouse School of Economics, and
attendees of the 2017 Econometric Study Group (Bristol), the Conference on the Intersection of
Econometrics and Applied Micro (Toronto, Oct. 17), the 2017 Triangle Econometrics
Conference, the 2018 International Association for Applied Econometrics Conference (Montreal),
and the 2018 CEME NSF-NBER conference on “Inference in Nonstandard Problems” (Duke) for
useful comments and suggestions. The views expressed herein are those of the authors and do not
necessarily reflect the views of the National Bureau of Economic Research.

NBER working papers are circulated for discussion and comment purposes. They have not been
peer-reviewed or been subject to the review by the NBER Board of Directors that accompanies
official NBER publications.

© 2018 by Xavier D'Haultfoeuille, Christophe Gaillac, and Arnaud Maurel. All rights reserved.
Short sections of text, not to exceed two paragraphs, may be quoted without explicit permission
provided that full credit, including © notice, is given to the source.
Rationalizing Rational Expectations? Tests and Deviations
Xavier D'Haultfoeuille, Christophe Gaillac, and Arnaud Maurel
NBER Working Paper No. 25274
November 2018
JEL No. C12,D15,D84

                                          ABSTRACT

In this paper, we build a new test of rational expectations based on the marginal distributions of
realizations and subjective beliefs. This test is widely applicable, including in the common
situation where realizations and beliefs are observed in two different datasets that cannot be
matched. We show that whether one can rationalize rational expectations is equivalent to the
distribution of realizations being a mean-preserving spread of the distribution of beliefs. The null
hypothesis can then be rewritten as a system of many moment inequality and equality constraints,
for which tests have been recently developed in the literature. Next, we go beyond testing by
defining and estimating the minimal deviations from rational expectations that can be rationalized
by the data. In the context of structural models, we build on this concept to propose an easy-to-
implement way to conduct a sensitivity analysis on the assumed form of expectations. Finally, we
apply our framework to test for and quantify deviations from rational expectations about future
earnings, and examine the consequences of such departures in the context of a life-cycle model of
consumption.

Xavier D'Haultfoeuille                           Arnaud Maurel
CREST                                            Department of Economics
5 avenue Henry Le Chatelier                      Duke University
91764 Palaiseau cedex                            213 Social Sciences Building
FRANCE                                           Box 90097
xavier.dhaultfoeuille@ensae.fr                   Durham, NC 27708
                                                 and NBER
Christophe Gaillac                               apm16@duke.edu
CREST
5 avenue Henry Le Chatelier
Palaiseau 91764
France
christophe.gaillac@ensae.fr
1       Introduction
How individuals form their beliefs about uncertain future outcomes is critical to understand-
ing decision making. Despite longstanding critiques (see, among many others, Pesaran, 1987;
Manski, 2004), rational expectations remain by far the most popular framework to describe
belief formation (Muth, 1961). This theory states that agents have expectations that do not
systematically differ from the realized outcomes, and efficiently process all private information
to form these expectations. Rational expectations (RE) are a key building block in many macro-
and micro-economic models, and in particular in most of the dynamic microeconomic models
that have been estimated over the last two decades (see, e.g., Aguirregabiria and Mira, 2010;
Blundell, 2017, for recent surveys).

In this paper, we build a new test of RE. Our test only requires having access to the marginal
distributions of subjective beliefs and realizations, and, as such, can be applied quite broadly.
In particular, this test can be used in a data combination context, where individual realizations
and subjective beliefs are observed in two different datasets that cannot be matched. Such
situations are common in practice (see, e.g., Delavande, 2008; Arcidiacono et al., 2012, 2014;
Stinebrickner and Stinebrickner, 2014a; Kuchler and Zafar, 2017; Kapor et al., 2018). Besides,
even in surveys for which an explicit aim is to measure subjective expectations, such as the
Michigan Survey of Consumers or the Survey of Consumer Expectations of the New York Fed,
expectations and realizations can typically only be matched for a subset of the respondents. And
of course, regardless of attrition, whenever one seeks to measure long or medium-term outcomes,
matching beliefs with realizations does require waiting for a long period of time before the data
can be made available to researchers.

The tests of RE implemented so far in this context (see, e.g., Patton and Timmermann, 2012;
Gennaioli et al., 2015) only use specific implications of the RE hypothesis. In contrast, we
develop a test that exploits all possible implications of RE. Using the key insight that we
can rationalize RE if and only if the distribution of realizations is a mean-preserving spread
of the distribution of beliefs, we show that rationalizing RE is equivalent to satisfying one
moment equality and infinitely many moment inequalities.1 As a consequence, if these moment
conditions hold, RE cannot be rejected, given the data at our disposal. By exhausting all relevant
implications of RE, our test is able to detect much more violations of rational expectations than
existing tests.

To develop a statistical test of RE rationalization, we build on the recent literature on inference
based on moment inequalities, and more specifically, on Andrews and Shi (2017). By applying
their results to our context, we show that our test controls size asymptotically and is consistent
    1
    Interestingly, the equivalence on which we rely, which is based on Strassen’s theorem (Strassen, 1965), is also
used in the microeconomic risk theory literature, see in particular Rothschild and Stiglitz (1970).


                                                        2
over fixed alternatives. We also provide conditions under which the test is not conservative.

We then consider several extensions to our baseline test. First, we show that by using a set of
covariates that are common to both datasets, we can increase our ability to detect violations of
RE. Another important issue is that of unanticipated aggregate shocks. Even if individuals have
rational expectations, the mean of observed outcomes may differ from the mean of individual
beliefs simply because of aggregate shocks. We show that our test can be easily adapted to
account for such shocks. Finally, we prove that our test is robust to measurement errors in
the following sense. If individuals have rational expectations but both beliefs and outcomes are
measured with (classical) errors, then our test does not reject RE provided that the amount of
measurement errors on beliefs does not exceed the amount of intervening transitory shocks plus
the measurement errors on the realized outcomes. In particular, this allows for elicited beliefs
to be noisier than realized outcomes. This provides a rationale for our test even in cases where
realizations and beliefs are observed in the same dataset, since a direct test based on a regression
of the outcome on the beliefs (see, e.g., Lovell, 1986) is, at least at the population level, not
robust to any amount of measurement errors on the subjective beliefs.

Next, we go beyond testing and introduce the concept of minimal deviations from rational
expectations that can be rationalized by the data. To do so, we use tools from the optimal
transport literature (see Galichon, 2016, for an overview). In particular, building on the insights
of a recent article by Gozlan et al. (2018), we construct the minimal deviations by projecting the
subjective expectations on the space of expectations compatible with RE. A remarkable property
of this projection is that it does not depend on the particular choice of distance between random
variables that we consider. These minimal deviations from RE allow us to go beyond the binary
result of the statistical test, and quantify the magnitude of the violations from RE. We then
derive a consistent estimator of these minimal deviations. Importantly for practical purposes,
this estimator can be easily implemented, and at a modest computational cost.

We extend the concept of minimal deviations from rational expectations to accommodate re-
strictions on the information set of the agents. In the context of structural models, the proposed
approach yields a natural and easy-to-implement sensitivity check on the assumed form of ex-
pectations. This procedure does not require observing the beliefs in the same dataset as the
one used to estimate the model, and can thus be used quite generally. Overall, this method
offers a middle ground between estimating structural choice models based on realized data only,
under the assumption of rational expectations (standard approach a la Rust, 1987; Keane and
Wolpin, 1997), and estimating more flexible choice models using subjective beliefs (as in, e.g.,
Stinebrickner and Stinebrickner, 2014b; Delavande and Zafar, 2018).

We apply our framework to test for and quantify deviations from rational expectations about fu-
ture earnings. To do so, we combine elicited beliefs about future earnings with realized earnings,


                                                 3
using data from the Labor Market module of the Survey of Consumer Expectations (SCE, New
York Fed), and test whether household heads form rational expectations on their annual labor
earnings. While a naive test of equality of means between earnings beliefs and realizations shows
that earnings expectations are realistic in the sense of not being significantly biased, thus not
rejecting the rational expectations hypothesis, our test does reject rational expectations at the
1% level. Taken together, our findings illustrate the practical importance of incorporating the
additional restrictions of rational expectations that are embedded in our test. The results of our
test also indicate that the RE hypothesis is more credible for certain subpopulations than oth-
ers. For instance, we reject RE for individuals without a college degree, who exhibit substantial
deviations from RE. On the other hand, we fail to reject the hypothesis that college-educated
workers have rational expectations on their future earnings. .

Finally, we explore the sensitivity of a standard life-cycle incomplete markets model of con-
sumption to violations of the rational expectations hypothesis. Even though agents are about
right on average about their future earnings, we show that minimal deviations from RE entail
substantial changes in the predicted responses of consumers to income shocks. In addition to
underlining the sensitivity of the model to the RE hypothesis, our results show that departures
from RE account for some of the over-insurance to permanent income shocks, as well as the ex-
cess sensitivity of consumption to transitory shocks that have been documented in the literature
(see, e.g., Hall and Mishkin, 1982; Blundell et al., 2008; Kaplan and Violante, 2010).

By developing a test of rational expectations in a setting where realizations and subjective beliefs
are observed in two different datasets, we bring together the literature on data combination (see,
e.g., Cross and Manski, 2002, Molinari and Peski, 2006, Fan et al., 2014, Buchinsky et al., 2018,
and Ridder and Moffitt, 2007 for a survey), and the literature on testing for rational expectations
in a micro environment (see, e.g., Lovell, 1986; Gourieroux and Pradel, 1986; Ivaldi, 1992, for
seminal contributions).

On the empirical side, we contribute to a rapidly growing literature on the use of subjective
expectations data in economics (see, e.g., Manski, 2004; Delavande, 2008; Van der Klaauw and
Wolpin, 2008; Van der Klaauw, 2012; Arcidiacono et al., 2014; de Paula et al., 2014; Stinebrickner
and Stinebrickner, 2014b; Wiswall and Zafar, 2015). In this paper, we show how to incorporate
all of the relevant information from subjective beliefs combined with realized data to test for,
and measure deviations from rational expectations.

By developing a new framework allowing to examine the sensitivity of behavioral models to
departures from the rational expectations hypothesis, we also contribute to a small but growing
body of research estimating structural choice models without imposing rational expectations
(see, e.g., Buchinsky and Leslie, 2010; Stinebrickner and Stinebrickner, 2014a; Kapor et al.,
2018; and Agarwal and Somaini, 2018). We add to this literature by showing how a sensitivity


                                                 4
analysis of the RE hypothesis can be conducted in frequent situations where the data used to
estimate the structural model does not include beliefs, but such beliefs are observed in another
dataset. From a methodological point of view, our approach based on minimal deviations shares
some similarities with the sensitivity analysis methods recently proposed by Andrews et al.
(2017), Armstrong and Kolesár (2018) and Bonhomme and Weidner (2018), in that they study
the robustness of a model to local deviations. In these papers, however, such deviations are
assumed to become negligible as the sample size grows, whereas our deviations do not.

The remainder of the paper is organized as follows. In Section 2, we present the set-up and discuss
the main theoretical equivalences that we use to build our testing procedure. In Section 3, we
present the statistical tests for rational expectations, and establish their asymptotic properties.
Section 4 introduces and studies the properties of minimal deviations from rational expectations
that can be rationalized by the data. Section 5 illustrates the finite sample properties of our
tests and estimators through Monte Carlo simulations. Section 6 applies our framework to
expectations about future earnings. Finally, Section 7 concludes. The appendix collects various
theoretical extensions, additional simulation results, additional material on the application, and
all the proofs. A companion R package (RationalExp) and its user guide (D’Haultfœuille et al.,
2018) are available on https://github.com/cgaillac/RationalExp. This package performs
the test of RE and computes the estimator of minimal deviations.


2     Set-up and main theoretical equivalences
2.1   Set-up
We assume that the researcher has access to a first dataset containing the individual outcome
variable of interest, which we denote by Y . She also observes, through a second dataset, the
elicited individual expectation on Y , denoted by ψ. Throughout the paper, we focus on sit-
uations where the researcher has access to elicited beliefs about mean outcomes, as opposed
to probabilistic expectations about the full distribution of outcomes. The type of subjective
expectations data we consider in the paper has been collected in various contexts, and used in
a number of prior studies (see, among others, Delavande, 2008; Zafar, 2011b; Arcidiacono et al.,
2012, 2014; Hoffman and Burks, 2017).

Formally, ψ = E[Y |I], where I denotes the σ-algebra corresponding to the agent’s information
set and E [·|I] is the subjective expectation operator (i.e. for any U , E [U |I] is a I-measurable
random variable). We are interested in testing the rational expectations (RE) hypothesis
ψ = E[Y |I], where E [·|I] is the conditional expectation operator generated by the true data
generating process. Importantly, we remain agnostic throughout most of our analysis on the
information set I. Our analysis therefore complements several studies which primarily focus on


                                                5
testing for different information sets, while maintaining the rational expectations assumption
(see Cunha and Heckman, 2007, for a survey).
It is easy to see that the RE hypothesis imposes restrictions on the joint distribution of realiza-
tions Y and beliefs ψ. In this data combination context, the relevant question of interest is then
whether one can rationalize RE, in the sense that there exists a triplet (Y 0 , ψ 0 , I 0 ) such that (i)
the pair of random variables (Y 0 , ψ 0 ) are compatible with the marginal distributions of Y and
ψ; and (ii) ψ 0 correspond to the rational expectations of Y 0 , given the information set I 0 , i.e.,
E(Y 0 |I 0 ) = ψ 0 . Hence, we consider the test of the following hypothesis:

      H0 : there exists a pair of random variables (Y 0 , ψ 0 ) and a sigma-algebra I 0 such that
           σ(ψ 0 ) ⊂ I 0 , Y 0 ∼ Y, ψ 0 ∼ ψ and E Y 0 I 0 = ψ 0 ,
                                                        


where ∼ denotes equality in distribution. Rationalizing RE does not mean that the true realiza-
tions Y , beliefs ψ and information set I are such that E [Y |I] = ψ. Instead, it means that there
exists a triplet (Y 0 , ψ 0 , I 0 ) consistent with the data and such that E [Y 0 |I 0 ] = ψ 0 . In other words,
rejecting H0 implies that RE does not hold, in the sense that the true realizations, beliefs, and
information set do not satisfy RE (E [Y |I] 6= ψ). The converse, however, is not true.

2.2     Equivalences
2.2.1    Main equivalence

Let δ = E [Y ] − E [ψ], Fψ and FY denote the cumulative distribution functions (cdf) of ψ and
Y , x+ = max(0, x), and define
                                       Z y
                                ∆(y) =      FY (t) − Fψ (t)dt.
                                                 −∞

Throughout most of our analysis, we impose the following regularity conditions on the distribu-
tions of realized outcomes (Y ) and subjective beliefs (ψ):

Assumption 1 E (|Y |) < +∞ and E (|ψ|) < +∞.

The following preliminary result will be useful subsequently.

Lemma 1 Suppose that Assumption 1 holds. Then H0 holds if and only if there exists a pair
of random variables (Y 0 , ψ 0 ) such that Y 0 ∼ Y , ψ 0 ∼ ψ and E [Y 0 |ψ 0 ] = ψ 0 .

Lemma 1 states that in order to test for H0 , we can focus on the constraints on the joint
distribution of Y and ψ, and ignore those related to the information set. This is intuitive given
that we impose no restrictions on this set. Our main result is Theorem 1 below. It states
that rationalizing RE (i.e., H0 ) is equivalent to a set of many moment inequality and equality
constraints.

                                                       6
Theorem 1 Suppose that Assumption 1 holds. The following statements are equivalent:

  (i) H0 holds;

 (ii) (FY is a mean-preserving spread of Fψ ) ∆(y) ≥ 0 for all y ∈ R and δ = 0;

(iii) E (y − Y )+ − (y − ψ)+ ≥ 0 for all y ∈ R and δ = 0.
                           


The implication (i) ⇒ (iii) and the equivalence between (ii) and (iii) are simple to establish.
The key part of the result is to prove that (iii) implies (i). To show this, we first use Lemma 1,
which states that H0 is equivalent to the existence of (Y 0 , ψ 0 ) such that Y 0 ∼ Y , ψ 0 ∼ ψ and
E [Y 0 |ψ 0 ] = ψ 0 . Then the result essentially follows from Strassen’s theorem (Strassen, 1965,
Theorem 8).

It is interesting to note that Theorem 1 is related to the theory of risk in microeconomic theory.
In particular, using the terminology of Rothschild and Stiglitz (1970), (ii) states that realizations
(Y ) are more risky than beliefs (ψ). The main value of Theorem 1, from a statistical point of
view, is to transform H0 into the set of moment inequality (and equality) restrictions given by
(iii). We show in Section 3 how to build a statistical test of these conditions.


Comparison with alternative tests of rational expectations We now compare our test
with alternative ones that have been proposed in the literature. In the following discussion, as
in this whole section, we reason at the population level and thus ignore statistical uncertainty.
Accordingly, the tests we consider here are formally deterministic, and we compare them in
terms of data generating processes violating the null hypothesis associated with each of them.

Our test can clearly detect many more violations of rational expectations than the “naive” test of
rational expectations simply based on the equality E(Y ) = E(ψ). It also detects more violations
than a test based on the restrictions E(Y ) = E(ψ) and V(Y ) ≥ V(ψ) (variance test), which has
been considered in particular in the macroeconomic literature on the accuracy and rationality
of forecasts (see in particular Patton and Timmermann, 2012).2 On the other hand, and as
expected since it relies on the joint distribution of (Y, ψ), the “direct” RE test of E(Y |ψ) = ψ
can detect more violations of rational expectations than ours.

To better understand the differences between these four different tests (“naive”, variance, “di-
rect” tests, and our test), it is helpful to consider important particular cases. Of course, if
ψ = E [Y |I], individuals are rational and none of the four tests reject their null hypothesis.
   2
     We also refer the reader to Elliott et al. (2005), Jin et al. (2017) and references therein, for other recent
contributions to the literature on the accuracy and rationality of forecasts. The framework in this literature
differs however from ours in a number of aspects, and in particular by focusing on the evolution over time of
forecasts.


                                                        7
Next, consider departures from rational expectations of the form ψ = E [Y |I] + η, with η inde-
pendent of E [Y |I]. If E(η) 6= 0, subjective beliefs are biased, and individuals are on average
either over-pessimistic or over-optimistic. It follows that E(Y ) 6= E(ψ), implying that all four
tests reject their null hypothesis.

More interestingly, if E(η) = 0, individuals’ expectations are right on average, and the naive
test does not reject the null. However, it is easy to show that, as long as deviations from RE
are heterogeneous in the population (V(η) > 0), the direct test always leads to a rejection. In
this setting, our test constitutes a middle ground, the rejection of which depends on the degree
of dispersion of the deviations from RE (η) relative to the uncertainty shocks (ε = Y − E(Y |I)).
In other words and intuitively, we reject the null hypothesis with our test whenever departures
from rational expectations dominate the uncertainty shocks affecting the outcome. Formally,
and using similar arguments as in Proposition 4 in Subsection 2.2.4, one can show that if ε is
independent of E [Y |I], our test rejects H0 as long as the distribution of the uncertainty shocks
stochastically dominates at the second-order the distribution of the deviations from RE.

Specifically, if ε ∼ N (0, σε2 ) and η ∼ N (0, ση2 ), our test rejects if and only if ση2 > σε2 . In such a
case, our test boils down to the variance test mentioned above: we reject whenever V(ψ) > V(Y ).
But interestingly, if the discrepancy (η) between beliefs and rational expectations is not normally
distributed, we can reject H0 even if V(ψ) ≤ V(Y ). Suppose for instance that ε ∼ N (0, 1) and

                    η = a (−1{U ≤ 0.1} + 1{U ≥ 0.9}) , U ∼ U[0, 1] and a > 0.

In other words, 80% of individuals are rational, 10% are over-pessimistic and form expectations
equal to E [Y |I] − a, whereas 10% are over-optimistic and expect E [Y |I] + a. Then one can
show that our test rejects when a ≥ 1.755, while for a = 1.755, V(η) ' 0.616 ≤ V(ε) = 1.

Finally, in one particular case, our test reduces to the naive test of E(Y ) = E(ψ). Indeed,
when Y is a binary outcome and ψ ∈ [0, 1], one can easily show that as long as E(Y ) = E(ψ),
the inequalities E (y − Y )+ − (y − ψ)+ ≥ 0 automatically hold for all y ∈ R. This applies to
                                         

expectations about binary events, such as, e.g., being employed or not at a given date. This also
applies to situations where expectations about the distribution of continuous outcomes Y are
elicited through questions of the form “what do you think is the percent chance that [Y] will be
greater than [y]?”, for different values y. We refer the reader to Manski (2004) for discussions
of papers analyzing this type of probabilistic expectations data. In such cases, one can still
apply our analysis after replacing, for the different values y at which the subjective beliefs were
elicited, Y by 1{Y > y}, and defining ψ as the subjective survival function evaluated at y.


Interpretation of the boundary condition Finally, to shed further light on our test and
on the interpretation of H0 , it is instructive to derive the distributions of Y |ψ that correspond


                                                    8
to the boundary condition (∆(y) = 0). The proposition below shows that, in the presence of
rational expectations, agents whose beliefs ψ lies at the boundary of H0 have perfect foresight,
i.e. ψ = E[Y |I] = Y .3

Proposition 1 Suppose that (Y, ψ) satisfies RE, u 7→ FY−1 |ψ (τ |u) is continuous for all τ ∈ (0, 1),
and ∆(y0 ) = 0 for some y0 in the interior of the support of ψ. Then Y |ψ = y0 is degenerate.

2.2.2      Equivalence with covariates

In practice we may observe additional variables X ∈ RdX in both datasets. Assuming that X is
in the agent’s information set, we modify H0 as follows:4

       H0X : there exists a pair of random variables (Y 0 , ψ 0 ) and a sigma-algebra I 0 such that
             σ(ψ 0 , X) ⊂ I 0 , Y 0 |X ∼ Y |X, ψ 0 |X ∼ ψ|X and E Y 0 I 0 = ψ 0 .
                                                                        


Adding covariates increases the number of restrictions that are implied by the rational ex-
pectation hypothesis, thus improving our ability to detect violations of rational expectations.
Proposition 2 below formalizes this idea and shows that H0X can be expressed as a system of
many conditional moment inequalities and equalities.

Proposition 2 Suppose that Assumption 1 holds. The following two statements are equivalent:

  (i) H0X holds;

 (ii) Almost surely, E (y − Y )+ − (y − ψ)+ X ≥ 0 for all y ∈ R and E [Y − ψ|X] = 0.
                                            

Moreover, if H0X holds, H0 holds as well.

2.2.3      Equivalence with unpredictable aggregate shocks

There may be cases where the restriction E [Y |ψ] = ψ (or, in the presence of covariates,
E [Y |ψ, X] = ψ) is too strong, in the sense that such a restriction may be violated, even though
the rational expectations hypothesis holds. This occurs in particular in frequent situations where
the outcome Y is affected by unpredictable, aggregate shocks.
These types of shocks arise in a variety of contexts, but for concreteness we consider in the
following the case of individual income. Suppose that the logarithm of income of individual i at
period t, denoted by Yit , satisfies a Restricted Income Profile model:

                                             Yit = αi + βt + εit ,
   3
    For any cdf F , we let F −1 denote its quantile function, namely F −1 (τ ) = inf{x : F (x) ≥ τ }.
   4
    See complementary work by Gutknecht et al. (2018), who use subjective expectations data to relax the rational
expectations assumption, and propose a method allowing to test whether specific covariates are included in the
agents’ information sets.


                                                       9
where βt capture aggregate (macroeconomic) shocks, εit follows a zero-mean random walk, and
αi , (βt )t and (εit )t are assumed to be mutually independent. Let Iit−1 denote individual i’s
information set at time t−1, and suppose that Iit−1 = σ (αi , (βt−k )k≥1 , (εit−k )k≥1 ). If individuals
form rational expectations on their future outcomes, their beliefs in period t − 1 about their
future log-income in period t are given by

                         ψit = E [Yit |Iit−1 ] = αi + E [βt |(βt−k )k≥1 ] + εit−1 .

Thus, Yit = ψit + ct + εit − εit−1 , with ct = βt − E [βt |(βt−k )k≥1 ]. Therefore, although individuals
form rational expectations, we have

                                   E [Yit |Iit−1 , ct ] = ψit + ct 6= ψit .

Note that we condition on ct here since it is an aggregate shock that is common to all individ-
uals. This implies that we can only identify the distributions of Yit and ψit conditional on ct .
Equivalently, ct may be considered as non-random here.
In such context, dropping indexes i and t and maintaining the conditioning on the aggregate
shocks implicit, rationalizing RE does not correspond to E [Y |I] = ψ, but instead to E [Y |I] =
c0 +ψ for some c0 ∈ R. A similar reasoning applies to multiplicative instead of additive aggregate
shocks. In such a case, the null takes the form E [Y |I] = c0 ψ, for some c0 > 0. In these two
examples, c0 is identifiable: by c0 = E(Y ) − E(ψ) in the additive case, and by c0 = E(Y )/E(ψ)
in the multiplicative case. Formally, we consider the following null hypothesis for testing RE in
the presence of aggregate shocks:

    H0S : there exist random variables Y 0 , ψ 0 , a sigma-algebra I 0 and c0 ∈ R such that
                                                  

         σ(ψ 0 ) ⊂ I 0 , Y 0 ∼ Y, ψ 0 ∼ ψ and E q Y 0 , c0 I 0 = ψ 0 .
                                                          


where q(., .) is a known function supposed to satisfy the following restrictions.

Assumption 2 E (|ψ|) < +∞ and for all c, E (|q (Y, c) |) < +∞. Moreover, E [q(Y, c)] = E[ψ]
admits a unique solution, c0 .

In the previous examples of additive and multiplicative aggregate shocks, we have, respectively,
q(y, c) = y − c and q(y, c) = y/c. Then Assumption 2 holds under Assumption 1 above. By
applying our main equivalence result (Theorem 1) to q(Y, c0 ) and ψ, we obtain the following
result.

Proposition 3 Suppose that Assumption 2 holds. Then the following statements are equivalent:

  (i) H0S holds;

 (ii) E (y − q (Y, c0 ))+ − (y − ψ)+ ≥ 0 for all y ∈ R.
                                   


                                                     10
Note that with aggregate shocks, the null hypothesis does not involve a moment equality re-
striction anymore; the corresponding moment is used instead to identify c0 . Related, a clear
limitation of the naive test (E(Y ) = E(ψ)) is that, unlike our test, it is not robust to aggre-
gate shocks. In this case, rejecting the null could either stem from violations of the rational
expectation hypothesis, or simply from the presence of aggregate shocks.

2.2.4    Measurement errors

We have assumed so far that Y and ψ were perfectly observed; yet measurement errors in survey
data are pervasive (see, e.g. Bound et al., 2001). We explore in the following the extent to which
our test is robust to measurement errors. Specifically, assume that the true variables (ψ, Y ) are
unobserved. Instead, we only observe ψb and Yb , which are affected by classical measurement
errors.5 Namely:

                                 ψb = ψ + ξψ with ξψ ⊥
                                                     ⊥ ψ, E[ξψ ] = 0
                                                                                                             (1)
                                Yb = Y + ξY      with ξY ⊥
                                                         ⊥ Y, E[ξY ] = 0.

Then one can show that if RE holds (and assumingh    iaway aggregate shocks, for simplicity), so that
E [Y |ψ] = ψ, it is nevertheless the case that E Y ψ 6= ψ,
                                                  b b     b as long as Cov(ξY , ψ)
                                                                                b =Cov(ξψ , Y ) = 0
and V(ξψ ) > 0. In other words, the direct test is not robust to any measurement errors on the
subjective beliefs ψ. Even if individuals have rational expectations, the direct test will reject
the null in the presence of even a small degree of measurement errors on the elicited beliefs. The
following proposition shows that our test, on the other hand, is robust to a certain degree of
measurement errors on the beliefs. As above, we let ε = Y − ψ denote the uncertainty shocks.
                                                                   
Proposition 4 Suppose that Y and ψ satisfy H0 and let ψ,        b Yb be defined as in (1). Suppose
also that ε + ξY ⊥ ⊥ ψ and Fξ dominates at the second order Fξ +ε . Then Yb and ψb satisfy H0 .
                                 ψ                                         Y




The key condition is that Fξψ dominates at the second order FξY +ε , or, equivalently here,
that FξY +ε is a mean-preserving spread of Fξψ . Recall that in the case of normal variables,
ξψ ∼ N (0, σ12 ) and ξY + ε ∼ N (0, σ22 ), this is in turn equivalent to imposing σ12 ≤ σ22 . Thus, even
if there is no measurement error on Y , so that ξY = 0, this condition may hold provided that
the variance of measurement errors on ψ is smaller than the variance of the uncertainty shocks
on Y . More generally, this allows elicited beliefs to be - potentially much - noisier than realized
outcomes, a setting which may be relevant in practice. Overall, these results support the use of
our test rather than the direct test even in cases where realizations and beliefs are observed in
the same dataset.
   5
    See Zafar (2011a) who do not find evidence of non-classical measurement errors on subjective beliefs elicited
from a sample of Northwestern undergraduate students.


                                                       11
2.2.5     Other extensions

We conclude this section by briefly discussing other relevant directions in which Theorem 1 can
be extended. Another potential source of uncertainty on ψ is rounding. Rounding practices by
interviewees are common in the case of subjective beliefs. Under additional restrictions, it is
possible in such a case to construct bounds on the true beliefs ψ (see, e.g., Manski and Molinari,
2010). We show in Appendix B that our test can be generalized to accommodate this rounding
practice.
Finally, we have implicitly maintained the assumption so far that subjective beliefs and realized
outcomes are drawn from the same population. In Appendix C, we relax this assumption and
show that our test can be easily extended to allow for sample selection under unconfoundedness,
through an appropriate reweighting of the observations.


3       Statistical tests
In this section we propose a testing procedure for H0X , which can be easily adapted to the
case where no covariate common to both datasets is available to the analyst. To simplify
notation, we use a potential outcome framework to describe our data combination problem.
Specifically, instead of observing (Y, ψ), we suppose to observe only, in addition to the covariates
X, Ye = DY + (1 − D)ψ and D, where D = 1 (resp. D = 0) if the unit belongs to the dataset
of Y (resp. ψ). We assume that the two samples are drawn from the same population, which
amounts to D ⊥   ⊥ (X, Y, ψ) (see Assumption 3-(i) below). In order to build our test, we use the
characterization (ii) of Proposition 2:

                 E (y − Y )+ − (y − ψ)+ X ≥ 0
                                        
                                                          ∀y ∈ R and E [Y − ψ|X] = 0.

Equivalently but written more compactly with Ye only,
                             +                    h    i
                  E W y−Y    e    X ≥ 0 ∀y ∈ R and E W Ye X = 0,

where W = D/E(D) − (1 − D)/E(1 − D). This formulation of the null hypothesis allows us to
apply the instrumental functions approach of Andrews and Shi (2017, AS), who consider the issue
of testing many conditional moment inequalities and equalities. We then build on their results to
establish that our test controls size asymptotically and is consistent over fixed alternatives.6 The
initial step is to transform the conditional moments into the following unconditional moments
conditions:                         +     
                        E W y − Ye       h(X) ≥ 0, E [(Y − ψ) h(X)] = 0.

    6
    Other testing procedures could be used to implement our test, such as that proposed by Chernozhukov et al.
(2018).


                                                     12
for all y ∈ R and h belonging to a suitable class of non-negative functions.
We suppose to observe a sample (Di , Xi , Yei )i=1...n of n i.i.d. copies of (D, X, Ye ). For notational
convenience, we let X
                    ei denote the nontransformed vector of covariates, and redefine Xi as:
                                                               
                                Xi = Φ0 Σ     b −1/2 X  ei − Xei ,
                                                eX,n

where, for any x = (x1 , . . . , xdX ), we let Φ0 (x) = (Φ(x1 ), . . . , Φ(xdX
                                                                                 ))> . Here Φ denotes the
standard normal cdf, Σ
                     b e is the sample covariance matrix of X
                       X,n
                                                                            ei          and X
                                                                                            e n its sample
                                                                                i=1...n
mean.
Now that Xi ∈ [0, 1]dX , we consider instrumental functions h that are indicators of belong-
ing to specific hypercubes within [0, 1]dX . Namely, we consider the class of functions Hr =
{ha,r , a ∈ Ar }, with Ar = {1, 2, . . . , 2r}dX (r ≥ 1), ha,r (x) = 1l {x ∈ Ca,r } and, for any a =
(a1 , ..., adX )> ∈ Ar ,
                                                dX             
                                               Y     au − 1 au
                                      Ca,r =               ,      .
                                                       2r    2r
                                              u=1

Finally, to define the test statistic T , we need to introduce additional notation. First, we define,
for any given y,
                                                                             +       
                                     m1 Di , Yei , Xi , h, y
                                                               =  wi y − Yi h (Xi )  ,
                                                                              e
       m Di , Yei , Xi , h, y =                                                                     (2)
                                     m2 Di , Yei , Xi , h, y               wi Yei h (Xi )
                                                                                                    
where wi = nDi / nj=1 Dj −n(1−Di )/ nj=1 (1−Dj ). Let mn (h, y) = ni=1 m Di , Yei , Xi , h, y /n
                    P                       P                                  P

and define similarly mn,j for j = 1, 2. For any function h and any y ∈ R, we also define, for
some  > 0,                                                        
                             Σn (h, y) = Σ
                                         b n (h, y) + Diag V          b Ye ,
                                                                b Ye , V

       b n (h, y) is the sample covariance matrix of √nmn (h, y) and V
                                                                                       
where Σ                                                                             b Ye is the empirical
variance of Ye . We then denote by Σn,jj (h, y)(j = 1, 2) the j-th diagonal term of Σn (h, y).
Then the (Cramér-von-Mises) test statistic T is defined by:
            rn                           √                     +2    √                   2 !
           X    (2r)−dX X                     nmn,1 (ha,r , y)            nmn,2 (ha,r , y)
  T = sup        2
                                 (1 − p) −                          +p                           ,
         b r=1 (r + 100) a∈A
       y∈Y                                  Σn,11 (ha,r , y)1/2         Σn,22 (ha,r , y)1/2
                             r
                              
where Y = min Yi , max Yi , p is a parameter that weights the moments inequalities versus
      b            e       e
              i=1,...,n   i=1,...,n
equalities and (rn )n∈N is a deterministic sequence tending to infinity.
To test for rational expectations in the absence of covariates, we set the instrumental function
equal to the constant function h(X) = 1, and the test statistic is simply written as:
                                     √              +2    √             2
                                          nmn,1 (y)             nmn,2 (y)
                     T = sup (1 − p) −                   +p                   ,
                         y∈Y
                           b            Σn,11 (y)1/2          Σn,22 (y)1/2

                                                    13
where, using the notations introduced above, mn,j (y) = mn,j (1, y) and Σn,jj (y) = Σn,jj (1, y)
(j = 1, 2).

Whether or not covariates are included, the resulting test is of the form ϕn,α = 1l T > c∗n,α
                                                                                       

where the estimated critical value c∗n,α is obtained by bootstrap using as in AS the Generalized
Moment Selection method. Specifically, we follow these three steps:
                                                        >
   1. Compute the function ϕn (y, h) = ϕn,1 (y, h) , 0 for (y, h) in Yb × ∪rr=1n
                                                                                 Hr , with
                                                  (                          )
                                         1/2        n1/2 −1/2
                        ϕn,1 (y, h) = Σn,11 Bn 1l       Σ     mn,1 (y, h) > 1 ,
                                                     κn n,11

     and where Bn = (b0 ln(n)/ ln(ln(n)))1/2 , b0 > 0, κn = (κ ln(n))1/2 , and κ > 0. To compute
     Σn,11 , we fix  to 0.05, as in AS.
                         
  2. Let Di∗ , Yei∗ , Xi∗            denote a bootstrap sample, i.e., an i.i.d. sample from the empirical
                         i=1,...,n
     cdf of D, Ye , X , and compute from this sample the bootstrap counterparts of mn and
                     ∗
      Σn , m∗n and Σn . Then compute the bootstrap counterpart of T , T ∗ , replacing Σn (y, ha,r )
           √                  ∗              √
      and nmn (y, ha,r ) by Σn (y, ha,r ) and n (m∗n − mn ) (y, ha,r ) + ϕn (y, ha,r ), respectively.

  3. The threshold c∗n,α is the quantile (conditional on the data) of order 1 − α + η of T ∗ + η
     for some η > 0. Following AS, we set η to 10−6 .

Note that, despite the multiple steps involved, the testing procedure remains computationally
easily tractable. In particular, for the baseline sample we use in our application (see Section 6.1),
the RE test only takes 2 min.7

We now turn to the asymptotic properties of the test. For that purpose, it is convenient to
introduce additional notation. Let Y and X denote the support of Y and X respectively, and
                                                              +            
         LF = (y, ha,r ) : y ∈ Y, (a, r) ∈ Ar × N : EF W y − Y e    ha,r (X) = 0 ,

where, to make the dependence on the underlying probability  measure explicit, EF denotes the
expectation with respect to the distribution F of D, Y , X . Finally, let F denote a subset of
                                                         e
                                                          
all possible cumulative distribution functions of D, Ye , X and F0 be the subset of F such that
H0X holds. We impose the following conditions on F and F0 :

Assumption 3

  (i) For all F ∈ F, D ⊥
                       ⊥ (X, Y, ψ);
  7
   This CPU time is obtained using our companion R package, on an Intel Xeon CPU E5-2643, 3.30GHz with
256Gb of RAM.


                                                  14
                                                                                  
 (ii) There exists M > 0 such that Ye ∈ [−M, M ] for all F ∈ F. Also, inf F ∈F VF Ye > 0 and
      0 < inf F ∈F EF [D] ≤ supF ∈F EF [D] < 1;
                                                                               −1/2
(iii) For all F ∈ F0 , KF , the asymptotic covariance kernel of n−1/2 Diag VF Ye        mn is
      in a compact set K2 of the set of all 2 × 2 matrix valued covariance kernels on Y × ∪r≥1 Hr
      with uniform metric d defined by
                  d(K, K 0 ) =                 sup           K(y, h, y 0 , h0 ) − K 0 (y, h, y 0 , h0 ) .
                                                           2
                                               (Y×∪r≥1 Hr )
                                 (y,h,y 0 ,h0 )∈

The main result of this section is Theorem 2. It shows that, under Assumption 3, the test ϕn,α
controls the asymptotic size and is consistent over fixed alternatives.

Theorem 2 Suppose that rn → ∞ and Assumption 3 holds. Then:
  (i) lim supn→∞ supF ∈F0 EF [ϕn,α ] ≤ α;

 (ii) If there exists F0 ∈ F0 such that LF0 is nonempty and there exists (j, y0 , h0 ) in {1, 2} × LF0
      such that KF0 ,jj (y0 , h0 , y0 , h0 ) > 0, then, for any α ∈ [0, 1/2),
                                           lim lim sup sup EF [ϕn,α ] = α.
                                           η→0 n→∞ F ∈F0

(iii) If F ∈ F\F0 , then limn→∞ EF (ϕn,α ) = 1.

Theorem 2 (i) is closely related to Theorem 5.1 and Lemma 2 in AS. It shows that the test ϕn,α
controls the asymptotic size, in the sense that the supremum over F0 of its level is asymptoti-
cally lower or equal to α. To prove this result, the key is to establish that, under Assumption 3,
the class of transformed unconditional moment restrictions that characterize the null hypothesis
satisfies a manageability condition (see Pollard, 1990). Using arguments from Hsu (2016), we
then exhibit cases of equality in Theorem 2 (ii), showing that, under mild additional regularity
conditions, the test has asymptotically exact size (when letting η tend to zero). Finally, The-
orem 2 (iii), which is based on Theorem 6.1 in AS, shows that the test is consistent over fixed
alternatives.


Extension to account for aggregate shocks This testing procedure can be easily modified
to accommodate unanticipated aggregate shocks. Specifically, using the notation defined in
Section 2.2.3, we consider the same test as above after replacing Ye by Yebc = Dq(Y, b   c) + (1 −
D)ψ, where b    c denotes a consistent estimator of c0 . The resulting test is given by ϕn,α,bc =
              ∗
  
1l T (b c) > cn,α (where T (bc) is obtained by replacing Ye by Yebc in the original test statistic).
Such tests have the same properties as those above under some mild regularity conditions on
q(·, ·), which hold in particular for the leading examples of additive and multiplicative shocks
(q(y, c) = y − c and q(y, c) = y/c). We refer the reader to Appendix A for a detailed discussion
of this extension.

                                                          15
4     Minimal deviations from rational expectations
In this section we introduce the concept of minimal deviations from rational expectations, and
build on optimal transport methods to provide conditions under which these minimal deviations
exist and are unique. We first consider in Section 4.1 such deviations while remaining agnostic
on the information set of the agents. Then, in Section 4.2, we characterize such deviations when
the information set is known, as is typically the case in structural models. Finally, we show
how these deviations can be used to assess the sensitivity of structural models to violations of
rational expectations.

4.1     Unconstrained information set
4.1.1    Existence and uniqueness

For the cases where H0 is rejected, we propose a way to quantify the degree to which subjective
expectations differ from rational expectations. To do so, we consider the minimal modifications
- in a sense to be made precise below - to the distribution of subjective beliefs ψ that are such
that the modified distribution of beliefs is compatible with the rational expectations hypothesis.
We refer to the discrepancy between the true beliefs and the modified beliefs as the minimal
deviations from rational expectations. We first consider such deviations without imposing any
constraints on the information set of the agents.

Formally, we define the set:

                    Ψ = (Y 0 , ψ 0 , ψ 00 ) : Y 0 ∼ Y, ψ 0 ∼ ψ and E(Y 0 |ψ 00 ) = ψ 00 .
                       
                                                                                                      (3)

In this set, (Y 0 , ψ 0 ) corresponds to a vector that is compatible with the data, whereas ψ 00 corre-
spond to alternative individual expectations, in a counterfactual situation where people would
form rational expectations on their future outcomes. Thus, in view of Lemma 1, the subset of
Ψ for which ψ 0 = ψ 00 corresponds to the set of random variables (Y 0 , ψ 0 ) that are compatible
with the data and with the rational expectations hypothesis. However, if H0 does not hold -
which is the relevant situation here - such a subset is, by definition, empty. The idea is then to
try and find a vector (Y 0 , ψ 0 , ψ 00 ) ∈ Ψ such that ψ 0 and ψ 00 are closest, in the sense of a family
of metrics defined below.

The following theorem shows that there exists a solution to this problem. Importantly, this
solution turns out to be, for a large class of metrics, independent of the specific metric considered.
The solution is also unique.

Assumption 4 E(Y 2 ) < +∞, E(ψ 2 ) < +∞, and Fψ has no atom.




                                                     16
Theorem 3 Suppose that Assumption 4 holds. Then there exists a unique function g ∗ such
that:
(i) g ∗ (ψ) is consistent with RE (namely, there exists Y 0 such that (Y 0 , ψ, g ∗ (ψ)) ∈ Ψ);
(ii) for any convex function ρ : R+ → R+ satisfying ρ(0) = 0,

                                     E[ρ(|ψ − g ∗ (ψ)|)] =          inf            E[ρ(|ψ 0 − ψ 00 |)].    (4)
                                                             (Y 0 ,ψ 0 ,ψ 00 )∈Ψ

Moreover, g ∗ is non-decreasing.

Theorem 3 shows that there exists a unique transformation of the subjective beliefs ψ such that
(i) the transformed beliefs g ∗ (ψ) are consistent with RE, and, remarkably, (ii) this transformation
is minimal for all metrics (indexed by ρ) used to measure the distance between the true and
modified beliefs distributions. Moreover, the modified beliefs are obtained as a monotonically
increasing change of the original beliefs. These minimal modifications can be geometrically
interpreted as the projections from the true subjective beliefs onto the set of beliefs that are
consistent with RE.
The proof of Theorem 3 can be summarized as follows. We first show, using our main equivalence
result (Theorem 1 above) and Proposition 3.1 in Gozlan et al. (2018), that

                        E[ρ(|ψ 0 − ψ 00 |)] =           E ρ ψ 0 − E Y 0 |ψ 0
                                                                            
                inf                             inf                               .
               (Y 0 ,ψ 0 ,ψ 00 )∈Ψ                      (Y 0 ,ψ 0 ): Y 0 ∼Y, ψ 0 ∼ψ

The optimization problem on the right-hand side is an optimal transport problem, in the sense
that it corresponds to an optimization over probability measures whose marginals are fixed.
Though non-standard, as it involves E [Y 0 |ψ 0 ], this problem has been recently studied by Gozlan
et al. (2018). In particular, it follows from their results that there exists a cdf G∗ such that the
problem can be rewritten as

                            E[ρ(|ψ 0 − ψ 00 |)] =                  E ρ |ψ 0 − ψ 00 | .
                                                                                   
                    inf                                  inf
                  (Y 0 ,ψ 0 ,ψ 00 )∈Ψ                        (ψ 0 ,ψ 00 ): ψ 0 ∼ψ, ψ 00 ∼G∗

Then, by a strict convexity argument based on Theorem 1 again and Pass (2013), we show
that such a G∗ is unique. Finally, using standard results in optimal transport, we show that
g ∗ = G∗−1 ◦ Fψ is the unique function satisfying (4).

4.1.2    Consistent estimation

While g ∗ does not have a simple form in general, we propose a simple procedure to construct a
consistent estimator of it, based on i.i.d. copies (Yi )i=1...nY and (ψi )i=1...nψ of the realizations Y
and subjective beliefs ψ. For simplicity, we suppose in the following that the two samples have
equal size, which we denote (with a slight abuse of notation) by n.8
   8
    If both samples do not have equal size, one can first apply our analysis after taking a random subsample of
the larger one, with the same size as the smaller one. Then we can compute the average of the estimates over a
large number of such random subsamples.


                                                                17
To define our estimator, it is useful to note first that, from the proof of Theorem 3, we have
                                                   h            i
                                  g ∗ = arg min E (ψ − g(ψ))2 ,                               (5)
                                                      g∈G0

where the set G0 is defined by

      G0 = g non-decreasing : E (y − Y )+ − (y − g(ψ))+ ≥ 0 ∀y ∈ R, E[g(ψ)] = E[Y ] .
                                                     


By Theorem 1, g ∈ G0 means that we can rationalize E(Y |g(ψ)) = g(ψ). Among such functions
g, g ∗ (ψ) is then defined as being closest to ψ for the L2 norm.

To estimate g ∗ , the idea is to replace expectations and cdfs by their empirical counterpart,
both in (5) and in the set G0 . Denoting by (Y(i) )i=1...n and (ψ(i) )i=1...n the ordered statistics
of (Yi )i=1...n and (ψi )i=1...n , we first focus on the estimation of g ∗ (ψ(1) ), ..., g ∗ (ψ(n) ) . The
                                                                                                     

empirical counterpart Gb0 of G0 is
                                                             n
              (
                                                           X                         +
       Gb0 =      ψe(1) , ..., ψe(n) : ψe(1) < ... < ψe(n) ,   (y − Y(i) )+ − y − ψe(i)    ≥ 0 ∀y ∈ R,
                                                               i=1
              n
                                     )
              X
                    Y(i) − ψe(i) = 0 .                                                                                    (6)
              i=1
                                                    
Note that here we consider vectors ψe(1) , ..., ψe(n) instead of functions g as in G0 , since g may
be assimilated with a vector when ψ has a finite support. On the surface, the set Gb0 appears
to be complicated because of the infinitely many inequalities. However, one can show, using
Proposition 2.6 in Gozlan et al. (2018), that Gb0 boils down to the following set, which only
involves a finite number of inequalities:
                                                                                                       
                                                  n
                                                     X                                n
                                                                                      X                 
 Gb0 =    ψe(1) , ..., ψe(n) : ψe(1) < ... < ψe(n) ,   Y(i) − ψ(i) ≥ 0 j = 2, ..., n,   Y(i) − ψe(i) = 0 .
                                                                                                       
                                                        i=j                                          i=1


Then, as the empirical counterpart of (5), our estimator of g ∗ (ψ(1) ), ..., g ∗ (ψ(n) ) satisfies:
                                                                                         

                                                       n 
                                                       X                     2          n
                                                                                         X
   gb∗ (ψ(1) ), ..., gb∗ (ψ(n) ) = arg
                                
                                             min              ψ(i) − ψe(i)        s.t.         Y(i) − ψe(i) ≥ 0, j = 2...n,
                                         ψ
                                         e(1) <···<ψ
                                                   e(n)
                                                        i=1                              i=j
                                                                                         n
                                                                                         X
                                                                                               Y(i) − ψe(i) = 0.          (7)
                                                                                         i=1

Finally, for any t ∈ R, we let

                            gb∗ (t) = gb∗ min{(ψi )i=1...n : ψi ≥ min{t, ψ(n) }} .
                                                                                


Theorem 4 shows that gb∗ is a consistent estimator of the transformation g ∗ .

                                                              18
Theorem 4 (Convergence of empirical minimal deviations) Suppose that Assumption 4
holds. Then, for all t that is a continuity point of g ∗ and such that Fψ (t) ∈ (0, 1), we have, as
n → ∞,
                                       gb∗ (t) → g ∗ (t) a.s.

Program (7) is a particular convex quadratic programming problem, which turns out to be
solvable very efficiently. The algorithm below, devised by Suehiro et al. (2012), shows that
 gb∗ (ψ(1) ), ..., gb∗ (ψ(n) ) can be obtained with only O(n2 ) elementary operations. The idea is to
                              

rely on the first-order conditions of the program, which have a simple form. Using our R package
and for the baseline sample we use in the application, the estimation of the minimal deviations
from RE takes less than a minute.

Computation of gb∗ (ψ(1) ), ..., gb∗ (ψ(n) ) .
                                               


  1. Let t = 0 and i0 = 0.

  2. While it < n:

        (a) Let t = t + 1.
                          Pn−it−1
        (b) Let C t (i) =
                                                       
                             k=n+1−i Y(k) − ψ(k) /(i − it−1 ), for i = it−1 + 1, ..., n and let it =
            argmini∈{it−1 +1,...,n} C t (i). If there are multiple minimizers, choose the largest one as
            it .
        (c) Set gb∗ (ψ(k) ) = ψ(k) + C t (it ), for k ∈ {n + 1 − it , ..., n − it−1 }.

4.2     Constrained information set and sensitivity analysis in structural models
4.2.1    Existence and uniqueness

We now consider minimal deviations from rational expectations in the presence of constraints
on the information set. Such constraints are typically imposed in structural models, along
with the rational expectations hypothesis. An important motivation for considering minimal
deviations from RE in this setting, then, is to assess the sensitivity of structural models to
the RE hypothesis. A more direct way of evaluating how critical the rational expectations
hypothesis is for a given model would be to solve the model and estimate it, using elicited
beliefs about future outcomes both on and off the agents’ actual choice paths. However, the
data requirements are formidable, and, as a consequence, this approach has only been pursued in
a handful of studies (see, e.g., Arcidiacono et al., 2014; Stinebrickner and Stinebrickner, 2014a,b;
Wiswall and Zafar, 2015, 2018). Our approach can be used more broadly. Notably, it applies to
the frequent cases where the model cannot be solved and estimated using available subjective
beliefs data, the only requirement being that the beliefs are observed in an auxiliary dataset.



                                                       19
Specifically, consider a structural model that imposes both a rational expectations formation
process and an information set I M of the agents, such that individual expectations about the
outcome Y are given by E Y |I M . In the following, we refer to this assumption (ψ = E Y I M )
                                                                                            

as the restricted RE hypothesis. Note that with auxiliary data on the subjective beliefs, we can
test for the restricted RE hypothesis by simply testing whether Fψ = FE[Y |I M ] .
Suppose that the restricted RE hypothesis is rejected. Then, consider the set

                              ΨM = (ψ 0 , ψ 00 ) : ψ 0 ∼ ψ, ψ 00 ∼ E Y I M .
                                                                        


As with the set Ψ in the unconstrained case, if we reject RE, there is no pair of the form
(ψ 0 , ψ 0 ) in ΨM .9 The goal here is then to find a pair (ψ 0 , ψ 00 ) ∈ ΨM such that ψ 0 is as close
to ψ 00 as possible. The discrepancy between the restricted model-based RE and the beliefs ψ 0
corresponds to the minimal deviations from RE that are consistent with the data on subjective
beliefs.10 Similarly to Theorem 3 in the absence of constraints on the information set, Theorem
5 below shows that there exists a solution to this problem, which is moreover independent of
the metric. To define this solution, we introduce hM = Fψ−1 ◦ FE[Y |I M ] .

Theorem 5 Suppose that FE[Y |I M ] has no atom. Then, for any convex function ρ : R+ → R+
satisfying ρ(0) = 0, we have

                     hM E Y I M , E Y I M ∈ arg                                  E[ρ(|ψ 0 − ψ 00 |)].
                                     
                                                                   min                                         (8)
                                                               (ψ 0 ,ψ 00 )∈ΨM

Moreover, if ρ is strictly convex, hM E Y I M is unique in the sense that for any other ψ 0
                                               

such that (ψ 0 , E Y I M ) ∈ ΨM satisfying (8), ψ 0 = hM E Y I M almost surely.
                                                             


Theorem 5 implies that among all random variables that are consistent with the true subjective
beliefs, hM E Y I M is closest to the rational expectations E Y I M , for any metric indexed
                                                                 

by ρ. Theorem 5 relies on results on optimal transport on the real line. In such a case, the
optimal map has been shown to be independent of the cost function (see, e.g., Rachev and
Rüschendorf, 1998, Chapter 3), which is why again here, the minimal deviations from RE do
not depend on the specific metric considered.
A couple of remarks are in order. First, hM E Y I M is I M -measurable, which implies that
                                                    

it is compatible with the information set I M imposed by the model. Second, by construc-
tion, hM E Y I M is consistent with the observed subjective beliefs, since their marginal
                  

   9
     In this context, the distribution of rational expectations E Y I M is identified. It follows that the set ΨM
                                                                        

only involves the distribution of expectations, in contrast to the set Ψ in the unconstrained case, which also
depends on the distribution of realizations.
  10
     At a high level, it is interesting to note that our approach to measuring the deviations from RE is similar in
spirit to the approach proposed by Hansen and Jagannathan (1997) to quantify specification error when estimating
stochastic discount factors in the context of GMM asset pricing models.


                                                        20
distributions coincide. Hence, given the data and the constraints imposed by the model on
the information set, we can rationalize that ψ = hM E Y I M .11 For this reason, we refer
                                                                

to hM E Y I M as pseudo-beliefs. We use the term pseudo-beliefs here to emphasize that,
                

even though both sets of beliefs are observationally equivalent, hM E Y I M does in general
                                                                          

not coincide with the true subjective expectations ψ. By construction, the pseudo-beliefs are
identifiable.

Finally, since hM = Fψ−1 ◦ FE[Y |I M ] , the pseudo-beliefs are simply obtained by an equipercentile
mapping from the distribution of rational expectations to the distribution of the true subjective
beliefs. It follows that the pseudo-beliefs can also be easily estimated, as discussed in more detail
below.

Next, having computed the pseudo-beliefs for a given structural model, we can compare the
results obtained with these pseudo-beliefs with those obtained under the baseline RE model.
Importantly, this provides a way to assess the sensitivity of the findings to violations of RE,
holding fixed the restrictions on the information set implied by the model. Findings from
the baseline model that exhibit significant sensitivity to these minimal deviations should be
interpreted with caution.

We conclude this discussion by noting that, in certain models, the parameters or predictions of
interest may also involve subjective beliefs about additional features of the distribution of fu-
ture outcomes, such as, e.g., subjective variances. In these cases, one can still use our approach
to evaluate the sensitivity of the model predictions to minimal deviations from rational expec-
tations, after replacing rational expectations by pseudo-beliefs about future outcomes, while
leaving the higher-order moments unchanged.12

4.2.2    Consistent estimation

Estimation of hM is simpler than that of g ∗ in the absence of restrictions on the information set,
given its simple, explicit form. Specifically, for a given vector of parameters θ of the structural
model, we can estimate hM by
                                      hM = Fbψ−1 ◦ FE[Y |I M ],θ ,
                                      b                                                            (9)

where FE[Y |I M ],θ denotes the distribution of E Y I M when the true value of the parameter
                                                         

vector is θ, and Fbψ−1 is the empirical quantile of the subjective beliefs. For a fixed θ, it follows
  11
      On the other hand, it is generally impossible to rationalize the model-free beliefs generated from g ∗ , namely
(g ∗ )−1 E Y I M . Their distribution does not coincide with the distribution of the observed subjective beliefs
                   

in general.
   12
      Of course, in a richer data environment where elicited beliefs about higher moments of the outcome distribution
are available to the analyst, one can also use our method to compute the pseudo-beliefs associated with each of
these moments, and then incorporate the corresponding departures from RE in the model.



                                                         21
from the asymptotic normality of quantiles (see, e.g. Van der Vaart, 2000, Corollary 21.5) that
this estimator is root-n consistent and asymptotically normal.
Recall, however, that the primary motivation behind the estimation hM is to conduct a sensitiv-
ity analysis on the structural model. In other words, hM is usually not the parameter of interest.
Instead, the parameters (or predictions) of interest are generally a function of θ, and possibly of
the beliefs too. In the modified model where rational expectations are replaced by the pseudo-
beliefs hM (E Y I M ), it follows that such a parameter of interest is given by φ = f (θ, Fψ ), for
                      

some function f . This parameter can be estimated in two steps. First, θ is estimated in the
modified model. Letting θb denote the corresponding estimator, we then estimate in a second step
φ by φb = f (θ,
              b Fbψ ), where Fbψ denotes the empirical cdf. of the subjective beliefs. In particular,
if θ is estimated by maximum likelihood or GMM, θb can be represented as a GMM estimator
including a first-step estimator (that of Fψ ). Since the estimator of Fψ is root-n consistent,
θb is also root-n consistent and asymptotically normal, under mild regularity restrictions (see,
e.g. Chen et al., 2003). Root-n consistency and asymptotic normality of φb follows, as long as
f is (Hadamard) differentiable. Importantly for practical purposes, bootstrap will also be valid
under standard regularity conditions (Chen et al., 2003).


5    Monte Carlo simulations
In this section we study the finite sample performances of the test without covariates through
Monte Carlo simulations. The finite sample performances of the version of our test that accounts
for covariates are reported and discussed in Appendix D.
We suppose that the outcome Y is given by

                                            Y = ρψ + ε,

with ρ ∈ [0, 1], ψ ∼ N (0, 1) and

                               ε = ζ (−1l{U ≤ 0.1} + 1l{U ≥ 0.9}) ,

where ζ, U and ψ are mutually independent, ζ ∼ N (2, 0.1) and U ∼ U[0, 1].
In this setup, E(Y |ψ) = ρψ and expectations are rational if and only if ρ = 1. But since we
observe Y and ψ in two different datasets, there are values of ρ 6= 1 for which our test cannot
reject the null hypothesis. More precisely, we can show that as the sample size n grows to infinity,
we reject the null if and only if ρ ≤ ρ∗ ' 0.616. Besides, given this data generating process, the
naive test E(Y ) = E(ψ) always fails to reject RE, while the RE test based on variances is only
able to detect a subset of violations of RE that correspond to ρ < 0.445.
Results reported in Figure 1 show the power curves of the test ϕα for five different sample sizes
(nY = nψ = n ∈ {400; 800; 1, 200; 1, 600; 3, 200}) as a function of the parameter ρ, using 800

                                                 22
simulations for each value of ρ. We use 500 bootstrap simulations to compute the critical values
of the test. The test statistic T involves the three tuning parameters b0 , κ, and p (see Section 3
for definitions). As described p.643 in Andrews and Shi (2013), there exists in practice a large
range of admissible values for these parameters. Following Section 4.2 of Beare and Shi (2018),
we set them equal to the smallest (resp. highest) value such that the rejection rate under the
null is below the nominal size 0.05, and obtain b0 = 0.3, κ = 0.001, and p = 0.05.




    Notes: The vertical line at ρ ' 0.616 corresponds to the theoretical limit for the rejection of the null
    hypothesis using our test. The dotted horizontal line corresponds to the 5% level.

                                         Figure 1: Power curves.


Several remarks are in order. First, as expected, under the alternative (i.e. for values of ρ ≤
ρ∗ = 0.616), rejection frequencies increase with the sample size n. In particular, for the largest
sample size n = 3, 200, our test always results in rejection of the RE hypothesis for values of
ρ as large as .45. Second, in this setting, our test is conservative in the sense that rejection
frequencies under the null are smaller than α = 0.05, for all sample sizes. This should not
necessarily come as a surprise since the test proposed by AS has been shown to be conservative
in alternative finite-sample settings (see, e.g. Table 1 p.22 in AS for the case of first-order
stochastic dominance tests). However, for the version of our test that accounts for covariates
and for the data generating process considered in Appendix D, rejection frequencies under the
null are very close to the nominal level.

Next, we report in Figure 2 below the estimated minimal deviations from rational expectations.
Specifically, we plot the differences between the beliefs ψ and the modified beliefs gb∗ (ψ), where
the transformation gb∗ is computed using the estimator of Section 4.1.2, for ρ = 0.3 and n = 800.
In the same figure, we also report the true minimal deviations ψ − g ∗ (ψ), obtained by solving


                                                      23
(7) with a large number of observations (n = 10, 000), as g ∗ does not have a closed form
representation in this setting.




          Note: The plain black curve corresponds to the average of ψ − gb∗ (ψ) over 1, 000 simulations (with
          n = 800), and the light dotted black curves are the 2.5% and 97.5% quantiles of ψ − gb∗ (ψ).

                               Figure 2: Estimation and true value of ψ − g ∗ (ψ).


Comparing these two curves shows that the estimator g ∗ exhibits a fairly small bias over the
support of ψ. The 2.5% and 97.5% quantiles of ψ − gb∗ (ψ), in light dotted black lines, are
also reasonably close to each other, showing that the estimator is already fairly accurate with
a sample of size n = 800.13 Finally, we computed the coverage of the bootstrap confidence
intervals of g ∗ (ψ), which is very close to the nominal rates for most values of ψ in [−3, 3]. For
ρ = 0.3 and n = 800, the mean coverage rates over values of ψ in [−3, 3] are equal to 98.6% and
95.4% for nominal rates of 99% and 95%, respectively. Overall, these findings support the use
of bootstrap to construct confidence intervals around the estimated minimal deviations.


6         Application to earnings expectations
6.1         Data
Using the tests discussed in Section 3, we now investigate whether household heads form rational
expectations on their future earnings. We use for this purpose data from the Survey of Con-
    13
         We obtain very similar patterns on the accuracy of the estimator for alternative values of ρ.


                                                            24
sumer Expectations (SCE), a monthly household survey that has been conducted by the Federal
Reserve Bank of New York since 2012 (see Armantier et al., 2017, for a detailed description
of the survey, and Kuchler and Zafar, 2017; Conlon et al., 2018; Fuster et al., 2018 for recent
articles using the SCE). The SCE is conducted with the primary goal of eliciting consumer ex-
pectations about inflation, household finance, labor market, as well as housing market. It is a
rotating internet-based panel of about 1,200 household heads, in which respondents participate
for up to twelve months.14 Each month, the panel consists of about 180 entrants, and 1,100
repeated respondents. While entrants are overall fairly similar to the repeated respondents, they
are slightly older and also have slightly lower incomes (see Table 1 in Armantier et al., 2017).

Of particular interest for this paper is the supplementary module on labor market expectations.
This module is repeated every four months since March 2014. Since March 2015, respondents
are asked the following question about labor market earnings expectations (ψ) over the next
four months: “What do you believe your annual earnings will be in four months?”. In this
module, respondents are also asked about current job outcomes, including their current annual
earnings (Y ), through the following question: “How much do you make before taxes and other
deductions at your [main/current] job, on an annual basis?”.

Specifically, we use for our baseline test the elicited earnings expectations (ψ), which are available
for three cross-sectional samples of household heads who were working either full-time or part-
time at the time of the survey, and responded to the labor market module in March 2015,
July 2015, and November 2015, respectively. We combine this data with current earnings (Y )
declared in July 2015, November 2015 and March 2016 by the respondents who are working
full-time or part-time at the time of the survey.15 This leaves us with a final sample of 2,993
observations, which is composed of 1,565 earnings expectation observations, and 1,428 realized
earnings observations (see Table 4 in Appendix E.1 for descriptive statistics).16

6.2    Are earnings expectations rational?
In Table 1 below, we report the results from the naive test of RE (E(Y ) = E(ψ)), and our
preferred test (“Full RE”), where we allow for multiplicative aggregate shocks. Several remarks
are in order. First, using our test, we reject for the whole population, at any standard level, the
hypothesis that agents form rational expectations over their future earnings. Second, we also
  14
     Each survey takes on average about fifteen minutes to complete, and respondents are paid $15 per survey
completed.
  15
     Throughout our analysis (with the exception of the number of observations reported in Table 1) we use the
monthly survey weights of the SCE in order to obtain an estimation sample that is representative of the population
of U.S. household heads. See Armantier et al. (2017) for more details on the construction of these weights. We
also Winsorize the top 5 percentile of the distributions of realized earnings and earnings beliefs.
  16
     51% (1,536) of these observations correspond to the sub-sample of respondents who are reinterviewed at least
once.


                                                       25
reject RE (at the 5% level) when we apply our test separately for white (non-Hispanics) and
minorities, as well as low vs. high numeracy test scores.17 Third, the results from our test point
to beliefs formation being heterogeneous across schooling (college degree vs. no college degree)
and tenure (more or less than 6 months spent in current job) levels. In particular, we cannot
rule out that the beliefs about future earnings of individuals with more schooling experience
correspond to rational expectations with respect to some information set. Similarly, while we
reject RE at any standard level for the subgroup of workers who have accumulated less than
6 months of experience in their current job, we can only marginally reject at the 10% level
RE for those who have been in their current job for a longer period of time. As such, these
findings complement some of the recent evidence from the economics of education and labor
economics literatures that individuals have more accurate beliefs about their ability as they
progress through their schooling and work careers (see, e.g., Stinebrickner and Stinebrickner,
2012; Arcidiacono et al., 2016).

                                Table 1: Tests of RE on annual earnings

                                   E(Y − ψ)/E(Y )     Naive RE      Full RE       Number of obs.
                                                       (p-val)      (p-val)       ψ         Y

            All                         0.034            0.23      < 0.001∗∗    1,565       1,428
            Women                       0.059            0.13      < 0.001∗∗     730         649
            Men                         0.025            0.48        0.210       835         779
            White                       0.032            0.31       0.021∗      1,200       1,097
            Minorities                  0.046            0.43       0.006∗∗      365         331
            College degree              -0.001          0.96        0.130       1,106       1,053
            No college degree           0.093           0.04∗       0.013∗       459         375
            High numeracy               0.033            0.28       0.012∗      1,158       1,070
            Low numeracy                0.055            0.27       0.022∗       407         358
            Tenure ≤ 6 months           0.105            0.24       0.001∗∗      271         180
            Tenure > 6 months           0.007            0.81       0.091†      1,294       1,248
              Notes: significance levels: † : 10%, ∗ : 5%, ∗∗ : 1%. “Naive RE” denotes the naive
              RE test of equality of means between Y and ψ. “Full RE” denotes the test without
              covariates, where we test H0S with q(y, c) = y/c. We use 5,000 bootstrap simulations
              to compute the critical values of the Full RE test. Distributions of realized earnings
              (Y ) and earnings beliefs (ψ) are both Winsorized at the 95% quantile.



Fourth, using the naive test of equality of means between earnings beliefs and realizations, one
would instead generally not reject the null at any standard levels. The only exception is the
  17
    Respondents’ numeracy is evaluated in the SCE through five questions involving computation of sales, interests
on savings, chance of winning lottery, of getting a disease and being affected by a viral infection. Respondents
are then partitioned into two categories: “High numeracy” (4 or 5 correct answers), and “low numeracy” (3 or
fewer correct answers).


                                                        26
subgroup of workers without a college degree, for whom the naive test yields rejection of RE
at the 5% level. But, as discussed before, one cannot rule out that such a rejection is due to
aggregate shocks.
Even though individuals in the overall sample form expectations over their earnings in the
near future that are realistic, in the sense of not being significantly biased, the result from our
preferred test shows that earnings expectations are nonetheless not rational. Taken together,
these findings highlight the importance of incorporating the additional restrictions of rational
expectations that are embedded in our test, using the full distributions of subjective beliefs and
realized outcomes to detect violations of rational expectations.
We do not report in this table the results of the direct test of RE. Beyond the obvious implication
that restricting to the subsample of individuals who are followed over four months results in a
loss of statistical power, there are a couple of important issues associated with the direct test.
First, as already discussed in Section 2.2.4, the direct test is not robust to measurement errors on
the subjective beliefs ψ. Second, attrition from the survey may be endogenous. To explore this
possibility, we report in Table 2 the estimation results from a logit model of attrition on earnings
beliefs, gender, race/ethnicity, college degree attainment, numeracy test score, and tenure.

                                     Table 2: Logit model of attrition

    Population    Intercept         ψ          Male      White         Coll. Degree       Low Num.   Tenure > 6
                         ∗∗              ∗∗
    All            1.054       -5.279e-06      0.091      -0.249          -0.069            -0.110    -0.559∗∗
                   (0.264)      (1.341e-06)   (0.108)    (0.170)         (0.119)           (0.125)     (0.141)
      Notes: 1,565 observations. Significance levels: † : 10%,   ∗
                                                                     : 5%,   ∗∗
                                                                                  : 1%.



The main takeaway from this table is that earnings beliefs ψ are significantly associated with
attrition, even after controlling for this extensive set of characteristics. This result suggests that
individuals for whom we observe both earnings expectations and realizations are likely to earn
more than those who are not followed across the two waves. Along the same lines, a Kolmogorov-
Smirnov test rejects at the 1% level the equality of the distributions of realized earnings between
the whole sample and the subsample that would be used for the direct test. Similarly, we reject
the equality of the distributions of expected earnings between these two samples. These results
indicate that, in this context, the direct RE test is likely to be misleading.
Finally, going beyond testing, Figure 3 offers additional insights regarding the deviations from
rational expectations on earnings. We focus on the whole population, for which, using our test,
we strongly reject (at the 0.1% level) the hypothesis of rational expectations. This figure shows
that deviations from rational expectations are in fact primarily due to the coexistence of over-
pessimistic (i.e., individuals for whom earnings beliefs are smaller than the RE constructed from

                                                        27
minimal deviations) and over-optimistic individuals.




      Notes: pointwise confidence intervals are obtained by percentile bootstrap, with 200 bootstrap samples.
      All results are in 2015 US dollars.

                                  Figure 3: Minimal deviations from RE


Both types of deviations from rational expectations largely offset one another when computing
the average across all observations, so that the naive test fails to detect this pattern of violations
from rational expectations. In contrast, our test, which exploits the full distributions of earnings
beliefs and realizations, is able to detect these deviations. We observe similar patterns within
sub-populations for which we reject RE. In particular, we report in Figure 6 in Appendix E the
minimal deviations from RE for the subsample of workers without a college degree. This graph
points again to a substantial degree of over-pessimism for low values of ψ, and over-optimism
for larger values of ψ, with even larger deviations (in relative terms) from rational expectations
than in the whole population.

6.3     Deviation from RE in a life-cycle consumption model
In this section, we examine the sensitivity of a standard life-cycle incomplete markets (SIM)
model of consumption to the relaxation of the assumption that individuals form rational ex-
pectations about their future earnings. In the baseline SIM model, as in the vast majority of
life-cycle consumption models, the rational expectations hypothesis is maintained. However,
if a substantial fraction of the individuals do not have rational expectations on their future
earnings, some of the conclusions that are drawn from this model may be misleading. In the
following, we address this issue by conducting a sensitivity analysis along the lines of Section 4.2.

                                                        28
Specifically, we use a benchmark SIM model as a starting point, which we modify to account for
the fact that individuals may not have rational expectations about their income process. Using
this framework, we then illustrate how the minimal deviations from rational expectations that
are consistent with the SCE data impact partial insurance mechanisms, and in particular the
predicted effects of transitory and permanent income shocks on consumption.

6.3.1   Benchmark model and deviation

The SIM model we consider closely resembles that of Kaplan and Violante (2010, KV), who also
focus on the responsiveness of consumption to income shocks. Time is assumed to be discrete,
t ∈ {1, ..., T }. The economy is constituted of agents (household heads) who work for T ret − 1
periods, before retiring. Their unconditional probability of surviving until period t is denoted
by ξt , and we assume that ξt = 1 for all t < T ret (and ξT +1 = 0). Agents are assumed not to be
altruistic. At each period t, consumption, income and assets of agent i are denoted respectively
by Ci,t , Yi,t and Ai,t , with Ai,1 = 0. The assets are made of a tradable risk-free one-period bond
with a rate of return r. Assuming perfect annuity markets, the budget constraint can be written
as follows:
                                             
                                          ξt
                                Ci,t +          Ai,t+1 = (1 + r)Ai,t + Yi,t .                    (10)
                                         ξt+1

We also assume that agent i faces at each period a constraint on the level of her assets,

                                              Ai,t ≥ A.                                          (11)

Agents are forward-looking, and choose at the beginning of period t, if still alive and before
observing their income, their sequence of consumption. They do so by sequentially maximizing
the present value of subjective expected lifetime utility given their information set, denoted by
Ii,t−1 for agent i, and given the constraints in (10)-(11). This present value at period t is equal
to                                  " T                        #
                                     X 0 ξt0
                                         β t −t u Ci,t0 Ii,t−1 ,
                                                        
                                  E                                                            (12)
                                      0
                                               ξt
                                     t =t

where β denotes the discount factor and u(.) is the flow utility of consumption. E [·|Ii,t−1 ] denotes
the (conditional) subjective expectation operator. In order to make the problem tractable, we
assume that this operator shares the same properties as the conditional expectation operator
E [·|Ii,t−1 ], the key difference being that it integrates over the subjective - rather than the true
- conditional distribution of the data.

During worklife (t < T ret ), the log income ln(Yi,t ) is supposed to be the sum of a deterministic
experience profile, κi,t , a permanent component, zi,t−1 , a permanent shock, ηi,t , and a transitory



                                                 29
shock, i,t :

                                           ln (Yi,t ) = κi,t + zi,t + i,t ,
                                                zi,t = zi,t−1 + ηi,t .

We also assume that i,t and ηi,t are normally distributed with mean zero and variances σ2 and ση2
respectively. They are mutually independent and independent over time and across agents. The
initial permanent shock zi,0 is also normally distributed with mean zero and variance σz20 . As in
KV, we assume that the information set at date t, It , is composed of the permanent component
zi,t−1 , as well as past transitory shocks. Finally, when t ≥ T ret , the post-retirement social
security transfers Yi,t are computed as a piecewise constant function of the lifetime individual
income, following the procedure described pp.64-65 in KV.

We adopt the following specification for the model. As in KV, we suppose that agents start
working in the first period (t = 1), at age 25; we then set T ret = 35 and T = 70 (years). We fix
the interest rate r at 3% and consider two extreme cases for A: a natural borrowing constraint
(NBC) economy, with A = −108 , and a zero borrowing constraint (ZBC) economy, with A = 0.
Following, e.g., Hall and Mishkin (1982), we use a quadratic specification for the flow utility of
consumption, namely u(C) = −(C ∗ − C)2 /2, with C ∗ = 200, 000. Finally, as in KV and given
the model in hand, the discount factor β is set to match an aggregate wealth-income target ratio
of 2.5.

Finally, we consider two alternative specifications regarding the subjective expectations. First,
in the benchmark model, all individuals form rational expectations on their future income.
Second, we consider an alternative specification in which individual beliefs deviate from rational
expectations, and replace the rational expectations on Yit by the pseudo-beliefs, following the
approach described in Section 4.2.18 Specifically, using our previous notation, the pseudo-beliefs
on income are computed as a function of the rationally expected income as follows:

                                     E [Yi,t |Ii,t−1 ] = hM (E [Yi,t |Ii,t−1 ]) .                               (13)

where the function hM is estimated using the empirical counterpart of (denoting by ψt the
subjective beliefs at period t < T ret ):
                                                        ret −1
                                                       TX
                                               1
                                 M
                               h (y) =                           Fψ−1 ◦ FE[Yt |It−1 ] (y).                      (14)
                                           T ret − 1                t
                                                        t=1

We provide additional details regarding the specification of the model, in particular the income
process, as well as the estimation of the pseudo-beliefs in Appendix E.2.
  18
    Given the specification of the model, and in particular the quadratic specification of the utility of consumption,
one can show that the optimal consumption path depends on the subjective expectations on Yit only.


                                                          30
6.3.2    Results

A Kolmogorov-Smirnov test rejects at the 1% level the equality of the distributions of rationally
expected income and the pseudo income beliefs obtained using (13), with a p-value lower than
10−5 . This indicates that, consistent with the earlier findings discussed in Section 6.2, RE does
not hold in this context. Figure 4 displays b hM used in equation (13) to compute the pseudo-
beliefs from the rational expectations. We return to this graph below when we discuss the
sources and consequences of departures from RE in the context of our model.




     Notes: pointwise confidence intervals are obtained by percentile bootstrap, with 200 bootstrap samples.
     All results are in 2015 US dollars.

                                           Figure 4: Estimate of hM


Next, and following KV, we simulate the model both in the zero borrowing constraint case and in
the natural borrowing constraint case, for an artificial panel of 10,000 households for 70 periods.
Our main object of interest is the partial insurance coefficient, namely the share of the variance
of the income shock xi,t (with x ∈ {η, }) that does not translate into consumption growth:

                                                  Cov(∆ ln(Ci,t ), xi,t )
                                       φx = 1 −                           ,
                                                       V(xi,t )
where the covariance and variance are computed cross-sectionally over the entire population
of agents between ages 25 and 60. We also consider and discuss below φxt , which is the same
quantity but computed conditionally on being of age 24 + t.
We report the partial insurance coefficients to permanent income shocks (φη ) and transitory
income shocks (φ ) in Table 3 below. We first display the coefficients under rational expectations,

                                                       31
and then the estimates obtained under our minimal deviations from RE. The changes in the
insurance coefficients across both scenarios reflect the changes in the income expectations (RE
vs. pseudo beliefs), combined with the change in the discount factor β which, in both cases,
is set to match an aggregate wealth-income target ratio of 2.5. Specifically, β decreases from
around 97% to 94-95%, depending on the borrowing constraints assumption (ZBC or NBC).19

                    Table 3: Insurance coefficients under RE or deviations from RE.

                                    Zero borrowing constraint            Natural borrowing constraint
                                      φη          φ          β             φη          φ             β
       Model with RE                 0.223      0.757      0.971          0.100       0.938         0.973
       Model with deviations         0.425      0.539      0.938          0.568       0.728         0.947
       from RE                      (0.019)    (0.019)    (0.003)        (0.068)     (0.038)       (0.003)
        Notes: we use ση2 = 0.02, σ2 = 0.05, σz20 = 0.15, and an aggregate wealth-income ratio of 2.5.
        Standard errors in parentheses.



Turning to our main parameters of interest, we find that consumption responses to both tran-
sitory and permanent income shocks are significantly affected by the minimal deviations from
RE. In particular, consumption is found to be significantly less responsive to permanent income
shocks when we relax RE, with substantial increases in the partial insurance coefficient φη for
both ZBC and NBC specifications. In that sense, accounting for deviations from RE with our
pseudo-beliefs takes the model predictions further away from those obtained with a canonical
permanent income hypothesis model (in which φη = 0). Conversely, accounting for deviations
from RE also results in consumption being more responsive to transitory income shocks (i.e.,
lower insurance coefficient φ ). The age profile of the insurance coefficients is also sensitive to the
type of beliefs that are used to simulate the consumption paths. Figure 7 in Appendix E.2 shows
that, in particular, household heads between the ages of 35 and 50 tend to smooth permanent
(transitory) income shocks significantly more (less) when we allow for deviations from RE.

It is interesting to discuss the findings from Table 3 in light of previous empirical estimates that
have been obtained in the consumption literature. In particular, in the presence of borrowing
constraints (ZBC), the partial insurance coefficient to permanent shocks implied by the model
under RE (φη = 0.22) is lower than the estimated coefficient obtained by Blundell et al. (2008,
BPP) (φη = 0.36) using US data on income and consumption.20 Accounting for minimal de-
  19
     The direction of the change is consistent with prior evidence from lab and field experiments (see, e.g. Andersen
et al., 2008; Andreoni and Sprenger, 2012; Belzil et al., 2017), which generally points to discount factors lower
than 97%.
  20
     While BPP provide a range of estimates for the insurance coefficient, the estimate 0.36 is obtained when labor


                                                         32
viations from RE using our method, the insurance coefficient increases substantially, to about
φη = 0.43. Hence, relaxing the assumption that agents form rational expectations about their
future incomes reduces the gap between the partial insurance coefficient to permanent shocks
implied by the SIM model, and the empirical estimates obtained by BPP. This suggests that
part of the over-insurance phenomenon to permanent income shocks that has been documented
in the literature (see, e.g., Blundell et al., 2008) may in fact be attributable to departures from
the RE hypothesis that is typically maintained in consumption models. Note that in the nat-
ural borrowing constraint (NBC) economy, the model with deviations from RE also results in
significantly larger insurance coefficients to permanent shocks than in the baseline RE model
(0.57 vs. 0.10). While the estimated coefficient that accounts for deviations from RE is larger
than the BPP estimate, the discrepancy remains smaller than in the benchmark RE model.
Turning to the transitory income shocks, we find that relaxing RE results in a significant de-
crease, of about 20 pp. for both ZBC and NBC cases, in the insurance coefficients φ . This
suggests that departures from RE also play a role in accounting for the excess sensitivity of
consumption to transitory shocks that has been documented in some of the literature using
standard realized data on income and consumption (see, e.g., Hall and Mishkin, 1982), and,
more recently, in Kaufmann and Pistaferri (2009), using subjective expectations data from the
Survey of Household Income and Wealth in Italy.
In order to shed light on the underlying mechanisms, it is instructive to examine the lifetime
net worth profiles that are implied by the model with RE, versus the model where we relax RE
using the pseudo-beliefs. These profiles are plotted in Figure 8 in Appendix E.2. A couple of
comments are in order. First, household heads below 40 are less indebted in the model with
deviations from RE. This is due to the fact that, for more than half of them, their expected
income is between 40,000$ and 100,000$ and thus, from Figure 4, they tend to be over-pessimistic
(i.e., pseudo-beliefs are smaller than RE). It follows that they tend to insure more than in the
RE model against permanent shock. Second, later in the life-cycle, household heads tend to
be over-optimistic. This translates into a lower propensity to insure against transitory shocks
compared with the RE environment, which, in turn, results in a stepper decay of the assets after
retirement in Figure 8.21
Taken together, the findings from this analysis show that accounting for minimal deviations
from rational expectations results in significant and sizable changes in the predicted consump-
income is defined as household earnings after tax and transfers, and, as such, is arguably the relevant benchmark
here.
   21
      The model with deviations from RE fits the data substantially better than the benchmark model, comparing
the worth profiles for both models to the local linear regression obtained from the 1992 Survey of Consumer
Finance (SCF) data (the dotted curves in Figure 8). This is true in particular around and after retirement age.
Over the life cycle, the average prediction error decreases by about 16.5% in both ZBC and NBC cases when we
allow for deviations from RE.


                                                       33
tion responses to both transitory and permanent income shocks. As such, they highlight the
importance of collecting subjective expectations data in order to analyze consumption dynamics
while allowing for departures from rational expectations.


7    Conclusion
In this paper, we develop a new test of rational expectations that can be used in a broad
range of empirical settings. In particular, our test only requires having access to the marginal
distributions of realizations and subjective beliefs, and, as such, can be applied in frequent
cases where realizations and beliefs are observed in two separate datasets. We establish that
whether one can rationalize rational expectations is equivalent to the distribution of realizations
being a mean-preserving spread of the distribution of beliefs, a condition which can be tested
using recent tools from the moment inequalities literature. We show that our test can easily
accommodate covariates and aggregate shocks, and, importantly for practical purpose, is robust
to some degree of measurement errors on the elicited beliefs.

Going beyond testing, we also introduce the concept of minimal deviations from rational ex-
pectations that can be rationalized by the data. Using recent tools from the optimal transport
literature, we show that, under mild regularity conditions, these deviations exist, are unique,
and are also easily estimated. In the context of structural models, these deviations offer a novel
and tractable way to conduct a sensitivity analysis on the assumed form of expectations.

We apply our method to test and quantify deviations from rational expectations about future
earnings. While individuals tend to be right on average about their future earnings, our test
strongly rejects rational expectations. Using the deviations from rational expectations within a
standard life-cycle incomplete markets, we then provide evidence that the behavioral responses
of consumers to income shocks are sensitive to departures from rational expectations. In partic-
ular, our results suggest that part of the over-insurance to permanent income shocks that has
been documented in the literature is attributable to departures from the rational expectations
hypothesis.




                                                34
References
Agarwal, N. and Somaini, P. (2018), ‘Demand analysis using strategic reports: an application
  to a school choice mechanism’, Econometrica 86(2), 391–444.

Aguirregabiria, V. and Mira, P. (2010), ‘Dynamic discrete choice structural models: A survey’,
  Journal of Econometrics 156, 38–67.

Andersen, S., Harrison, G. W., Morten, L. and E., R. E. (2008), ‘Eliciting risk and time prefer-
 ences’, Econometrica 76(3), 583–618.

Andreoni, J. and Sprenger, C. (2012), ‘Estimating time preferences from convex budgets’, Amer-
 ican Economic Review 102(7), 3333–56.

Andrews, D. (1994), ‘Empirical process methods in econometrics’, Handbook of econometrics
 4, 2247–2294.

Andrews, D. and Shi, X. (2013), ‘Inference based on conditional moment inequalities’, Econo-
 metrica 81(2), 609–666.

Andrews, D. and Shi, X. (2017), ‘Inference based on many conditional moment inequalities’,
 Journal of Econometrics 196(2), 275–287.

Andrews, I., Gentzkow, M. and Shapiro, J. M. (2017), ‘Measuring the sensitivity of parameter
 estimates to estimation moments’, The Quarterly Journal of Economics 132(4), 1553–1592.

Arcidiacono, P., Aucejo, E., Maurel, A. and Ransom, T. (2016), College attrition and the
  dynamics of information revelation. NBER Working Paper No. 22325.

Arcidiacono, P., Hotz, J. and Kang, S. (2012), ‘Modeling college major choices using elicited
  measures of expectations and counterfactuals’, Journal of Econometrics 166(1), 3–16.

Arcidiacono, P., Hotz, J. V., Maurel, A. and Romano, T. (2014), Recovering ex ante returns
  and preferences for occupations using subjective expectations data, Technical report. NBER
  Working Paper No. 20626.

Armantier, O., Topa, G., Van der Klaauw, W. and Zafar, B. (2017), ‘An overview of the survey
  of consumer expectations’, Economic Policy Review 23(2), 51–72.

Armstrong, T. B. and Kolesár, M. (2018), ‘Sensitivity analysis using approximate moment con-
  dition models’. Working paper.

Beare, B. and Shi, X. (2018), ‘An improved bootstrap test of density ratio ordering’, Economet-
  rics and Statistics forthcoming.

                                              35
Belzil, C., Maurel, A. and Sidibé, M. (2017), Estimating the value of higher education financial
  aid: Evidence from a field experiment, Technical report. NBER Working Paper No. 23641.

Blundell, R. (2017), ‘What have we learned from structural models?’, American Economic Re-
  view: Papers and Proceedings 107(5), 287–292.

Blundell, R., Pistaferri, L. and Preston, I. (2008), ‘Consumption inequality and partial insur-
  ance’, The American Economic Review 98(5), 1887–1921.

Bonhomme, S. and Weidner, M. (2018), ‘Minimizing sensitivity to model misspecification’, arXiv
  preprint arXiv:1807.02161 .

Bound, J., Brown, C. and Mathiowetz, N. (2001), ‘Measurement error in survey data’, Handbook
  of Econometrics 5, 3705–3843.

Buchinsky, M. and Leslie, P. (2010), ‘Educational attainment and the changing u.s. wage
  structure: Dynamic implications on young individuals’ choices’, Journal of Labor Economics
  28(3), 541–594.

Buchinsky, M., Li, F. and Liao, Z. (2018), ‘Estimation and inference of semiparametric models
  using data from several sources’. Working paper.

Chen, X., Linton, O. and Van Keilegom, I. (2003), ‘Estimation of semiparametric models when
  the criterion function is not smooth’, Econometrica 71(5), 1591–1608.

Chernozhukov, V., Chetverikov, D. and Kato, K. (2018), ‘Inference on causal and structural
  parameters using many moment inequalities’, Review of Economic Studies pp. 1–40.

Conlon, J. J., Philossoph, L., Wiswall, M. and Zafar, B. (2018), Labor market search with
  imperfect information and learning, Technical report. NBER Working Paper No. 24988.

Cross, P. J. and Manski, C. F. (2002), ‘Regressions, short and long’, Econometrica 70(1), 357–
  368.

Cunha, F. and Heckman, J. J. (2007), ‘Identifying and estimating the distributions of ex post
  and ex ante returns to schooling’, Labour Economics 14(6), 870–93.

Davydov, Y. A., Lifshits, M. A. and Smorodina, N. V. (1998), Local properties of distributions
  of stochastic functionals, American Mathematical Society.

de Paula, A., Shapira, G. and Todd, P. E. (2014), ‘How beliefs about hiv status affect risky
  behaviors: Evidence from malawi’, Journal of Applied Econometrics 29(6), 944–964.

Delavande, A. (2008), ‘Pill, patch, or shot? subjective expectations and birth control choice’,
  International Economic Review 49(3), 999–1042.

                                               36
Delavande, A. and Zafar, B. (2018), ‘University choice: the role of expected earnings, non-
  pecuniary outcomes, and financial constraints’, Journal of Political Economy forthcoming.

D’Haultfœuille, X., Gaillac, C. and Maurel, A. (2018), Rationalexp: Tests of and deviations
  from rational expectations. Working paper.

Elliott, G., Komunjer, I. and Timmermann, A. (2005), ‘Estimation and testing of forecast
  rationality under flexible loss’, Review of Economic Studies 72(4), 1107–1125.

Fan, Y., Sherman, R. and Shum, M. (2014), ‘Identifying treatment effects under data combina-
  tion’, Econometrica 82(2), 811–822.

Fuster, A., Kaplan, G. and Zafar, B. (2018), What would you do with $500? spending responses
  to gains, losses, news and loans, Technical report. NBER Working Paper No. 24386.

Galichon, A. (2016), Optimal transport methods in economics, Princeton University Press.

Gennaioli, N., Ma, Y. and Shleifer, A. (2015), Expectations and investment, in ‘NBER Macroe-
 conomics Annual 2015, Volume 30’, University of Chicago Press.

Gourieroux, C. and Pradel, J. (1986), ‘Direct test of the rational expectation hypothesis’, Eu-
 ropean Economic Review 30(2), 265–284.

Gozlan, N., Roberto, C., Samson, P.-M., Shu, Y. and Tetali, P. (2018), ‘Characterization of a
 class of weak transport-entropy inequalities on the line’, Annales de l’IHP 54(3), 1667–1693.

Gutknecht, D., Hoderlein, S. and Peters, M. (2018), ‘Constrained information processing and
 individual income expectations’. Working paper.

Hall, R. E. and Mishkin, F. S. (1982), ‘The sensitivity of consumption to transitory income:
  Estimates from panel data on households’, Econometrica 50(2), 461–81.

Hansen, L. P. and Jagannathan, R. (1997), ‘Assessing specification errors in stochastic discount
  factor models’, Journal of Finance 52(2), 557–590.

Hoffman, M. and Burks, S. V. (2017), Worker overconfidence: Field evidence and implications
  for employee turnover and returns from training, Technical report. NBER Working Paper No.
  23240.

Hsu, Y.-C. (2016), ‘Consistent tests for conditional treatment effects’, The Econometrics Journal
  20(1), 1–22.

Ivaldi, M. (1992), ‘Survey evidence on the rationality of expectations’, Journal of Applied Econo-
  metrics 7(3), 225–241.


                                               37
Jin, S., Corradi, V. and Swanson, N. R. (2017), ‘Robust forecast comparison’, Econometric
  Theory 33(6), 1306–1351.

Kaplan, G. and Violante, G. L. (2010), ‘How much consumption insurance beyond self-
 insurance?’, American Economic Journal: Macroeconomics 2(4), 53–87.

Kapor, A., Neilson, C. A. and Zimmerman, S. (2018), Heterogeneous beliefs and school choice
 mechanisms. NBER Working paper No. 25096.

Kaufmann, K. and Pistaferri, L. (2009), ‘Disentangling insurance and information in intertem-
 poral consumption choices’, American Economic Review 99(2), 387–92.

Keane, M. and Wolpin, K. (1997), ‘The career decisions of young men’, Journal of Political
 Economy 105(3), 473–522.

Kuchler, T. and Zafar, B. (2017), ‘Personal experiences and expectations about aggregate out-
 comes’. Working paper.

Lovell, M. C. (1986), ‘Tests of the rational expectations hypothesis’, American Economic Review
  76(1), 110–124.

Manski, C. (2004), ‘Measuring expectations’, Econometrica 72(5), 1329–1376.

Manski, C. and Molinari, F. (2010), ‘Rounding probabilistic expectations in surveys’, Journal
 of Business & Economic Statistics 28(2), 219–231.

Molinari, F. and Peski, M. (2006), ‘Generalization of a result on “regressions, short and long”’,
 Econometric Theory 22(1), 159–163.

Muth, J. F. (1961), ‘Rational expectations and the theory of price movements’, Econometrica
 29(3), 315–335.

Pass, B. (2013), ‘Optimal transportation with infinitely many marginals’, Journal of Functional
  Analysis 264, 947–963.

Patton, A. J. and Timmermann, A. (2012), ‘Forecast rationality tests based on multi-horizon
  bounds’, Journal of Business & Economic Statistics 30(1), 1–17.

Pesaran, M. H. (1987), The limits to rational expectations, Basil Blackwell.

Pollard, D. (1990), Empirical processes: theory and applications, in ‘NSF-CBMS regional confer-
  ence series in probability and statistics’, Institute of Mathematical Statistics and the American
  Statistical Association, pp. i–86.



                                                38
Rachev, S. T. and Rüschendorf, L. (1998), Mass Transportation Problems: Volume I: Theory,
  Springer Science & Business Media.

Ridder, G. and Moffitt, R. (2007), ‘The econometrics of data combination’, Handbook of Econo-
  metrics 6, 5469–5547.

Rothschild, M. and Stiglitz, J. (1970), ‘Increasing risk: I. a definition’, Journal of Economic
  Theory 2(3), 225–243.

Rust, J. (1987), ‘Optimal replacement of gmc bus engines: An empirical model of harold zurcher’,
 Econometrica 55(5), 999–1033.

Santambrogio, F. (2015), ‘Optimal transport for applied mathematicians’, Birkäuser .

Stinebrickner, R. and Stinebrickner, T. (2012), ‘Learning about academic ability and the college
  dropout decision’, Journal of Labor Economics 30(4), 707–748.

Stinebrickner, R. and Stinebrickner, T. (2014a), ‘Academic performance and college dropout:
  Using longitudinal expectations data to estimate a learning model’, Journal of Labor Eco-
  nomics 32(3), 601–644.

Stinebrickner, R. and Stinebrickner, T. (2014b), ‘A major in science? initial beliefs and final
  outcomes for college major and dropout’, The Review of Economic Studies 81(1), 426–472.

Strassen, V. (1965), ‘The existence of probability measures with given marginals’, The Annals
  of Mathematical Statistics 36(2), 423–439.

Suehiro, D., Hatano, K., Kijima, S., Takimoto, E. and Nagano, K. (2012), Online prediction
  under submodular constraints, in ‘International Conference on Algorithmic Learning Theory’,
  pp. 260–274.

Van der Klaauw, W. (2012), ‘On the use of expectations data in estimating structural dynamic
  choice models’, Journal of Labor Economics 30(3), 521–554.

Van der Klaauw, W. and Wolpin, K. I. (2008), ‘Social security and the retirement and savings
  behavior of low-income households’, Journal of Econometrics 145(1-2), 21–42.

Van der Vaart, A. (2000), Asymptotic statistics, Cambridge University Press.

Van der Vaart, A. and Wellner, J. (1996), Weak convergence, in ‘Weak Convergence and Em-
  pirical Processes’, Springer, pp. 16–28.

Villani, C. (2008), Optimal transport: old and new, Vol. 338, Springer Science & Business Media.



                                              39
Wiswall, M. and Zafar, B. (2015), ‘Determinants of college major choice: Identification using
 an information experiment’, The Review of Economic Studies 82(2), 791–824.

Wiswall, M. and Zafar, B. (2018), ‘Preference for the workplace, investment in human capital,
 and gender’, The Quarterly Journal of Economics 133(1), 457–507.

Zafar, B. (2011a), ‘Can subjective expectations data be used in choice models? evidence on
  cognitive biases’, Journal of Applied Econometrics 26(3), 520–544.

Zafar, B. (2011b), ‘How do college students form expectations?’, Journal of Labor Economics
  29(2), 301–348.




                                             40
A     Statistical tests in the presence of aggregate shocks
In this appendix, we show how to adapt the construction of the test statistic and obtain similar
results as in Theorem 2 in the presence      of aggregate shocks. As explained in Section 2.2.3, we
mostly have to replace Y by Yc = Dq Ye , c + (1 − D)ψ. Because we include covariates here, as
                         e       e
in Section 3, c is actually a function of X. Also, the true function c0 has to be estimated. We
let b
    c denote such a nonparametric estimator, which is based on E(q(Y, c0 (X))|X) = E(ψ|X).
When q(y, c) = y − c or q(y, c) = y/c, we get respectively c0 (X) = E(Y |X) − E(ψ|X) and
c0 (X) = E(Y |X)/E(ψ|X), and b      c is easy to compute using nonparametric estimators of E(Y |X)
and E(ψ|X).
                                                                                                       
Because in Proposition 3 (ii) we do not test for a moment equality anymore, m Di , Yei , Xi , h, y
                                                                                                 
reduces to m1 Di , Yec,i , Xi , h, y . We let hereafter mn (h, y) = ni=1 m1 Di , Yec,i , Xi , h, y /n.
                                                                        P

In thetest
           statistic
                      , we replace, for (y, h) ∈ 
                    T                              Y ×∪r≥1 Hr , Σn (h, y) by Σn (h, y) = Σ
                                                                                             b n (h, y) +
Diag V b Yeĉ , V
                 b Yeĉ , where Σ    b n (h, y) and V
                                                    b Yeĉ are respectively the sample covariance ma-
       √
trix of nmn (h, y) and the empirical variance of Yeĉ . The last difference with the test considered
in Section 3 is that when using the bootstrap to compute the critical value, we also have to re-
estimate c0 in the bootstrap sample.

We obtain in this context a result similar to Theorem 2 above, under the regularity conditions
stated in Assumption 5. We let hereafter Cs [0, 1]dX denote the space of continuously differen-
                                                        

tiable functions of order s on [0, 1]dX that have a finite norm kcks,∞ = max supx∈[0,1]dX c(k) (x) .
                                                                             |k|≤s
We also let, for any function f on a set H, kf kH = supx∈H |f (x)|. Finally, when the distribution
                                                                                −1/2
of D, Ye , X is F , KF denotes the asymptotic covariance kernel of n−1/2 Diag V Yec0            m.

                         c and c0 belong to Cs [0, 1]dX , with s ≥ dX . Moreover, kb
                                                       
Assumption 5         (i) b                                                         c − c0 k[0,1]dX =
    oP (1).

 (ii) For all y ∈ Y, q is Lipschitz on Y × [−C, C] for some C > kc0 k[0,1]dX . Moreover,
      sup(y,c)∈Y×[−C,C] |q(y, c)| ≤ M0 ;

(iii) For all c ∈ R, the function q(·, c) : Y → Y is bijective and its inverse q I (·, c) is Lipschitz
      on Y;

 (iv) Fψ|X (·|x), FY |X (·|x) are Lipschitz on Y uniformly in x ∈ [0, 1]dX with constants QF,1 sat-
      isfying supF ∈F0 QF,1 ≤ Q1 < +∞. Alson Fq(ψ,c(X)) , Fq(Y,c(X)) are Lipschitz on [−M0 , M0 ]
      with constants QF,2 satisfying supF ∈F0 QF,2 ≤ Q2 < +∞;
                  h i
 (iv) inf F ∈F VF Yec2 > 0 and 0 ≤ inf F ∈F EF [D] ≤ supF ∈F EF [D] ≤ 1 − 0 for some ε0 ∈
                           h i                                  h i
      (0, 1/2). Also, Vb F Ye 2 is a consistent estimator of VF Ye 2 .
                              c
                              b                                    c


                                                   41
Part (i) imposes some regularity conditions on c0 and its nonparametric estimator b       c. It is
                                                c with kernel or series estimators of E(Y |X) and
possible to check such regularity conditions on b
E(ψ|X). Parts (ii) and (iii) also hold when q(y, c) = y − c and q(y, c) = q(y)/c, by imposing in
the second case that c belongs to a compact subset of (0, ∞). Proposition 5 shows that under
these conditions, the test has asymptotically correct size.

Proposition 5 Suppose that rn → ∞ and that Assumptions 3 and 5 hold. Then (i) in Propo-
sition 2 holds, replacing ϕn,α by ϕn,α,bc .

Results like (ii) and (iii) in Proposition 2 could also be obtained under the conditions of Propo-
sition 5, modifying directly the proof of Proposition 2.


B      Tests with rounding practices
We have considered in Section 2.2.4 the possibility of measurement errors on ψ. Another source
of uncertainty on ψ is rounding. Rounding practices by interviewees are common. A way to
interpret these practices is that in situations of ambiguity, individuals may only be able to bound
the distribution of their future outcome Y (Manski, 2004). If individuals round at 5% levels,
for instance, an answer ψ = 0.05 for the beliefs about percent increase of income should then
only be interpreted as ψ ∈ [0.025, 0.075]. Another case where only bounds on ψ are observed is
when questions to elicit subjective expectations take the following form: “What do you think
is the percent chance that your own [Y ] will be below [y]?”, for a certain grid of y. If 0 and
100 are always observed, or if we assume that the support of subjective distributions is included
in [y, y], we can still compute bounds on ψ.22 In such cases, we only observe (ψL , ψU ), with
ψL ≤ ψ ≤ ψU . For a thorough discussion of this issue, and especially of how to infer rounding
practices, see Manski and Molinari (2010).

In this setting, rationalizing rational expectations is less stringent than in our baseline set-up
since the constraints on the distribution of ψ are weaker. Formally, the null hypothesis takes
the following form:

         H0B : ∃(Y 0 , ψ 0 , I 0 ) : σ(ψ 0 ) ⊂ I 0 , Y 0 ∼ Y, FψU ≤ Fψ0 ≤ FψL and E(Y 0 |I 0 ) = ψ 0 .

To obtain an equivalent formulation to H0B , a natural idea would be to fix a candidate cdf F ∈
                                                                              Ry
[FψU , FψL ] for Fψ and apply Theorem 1 with this F . Then, letting ∆F (y) = −∞ FY (t) − F (t)dt
                     R
and δF = E(Y ) − udF (u), H0B would hold as long as for some F ∈ [FψU , FψL ], ∆F (y) ≥ 0
for all y ∈ R and δF = 0. In practice though, directly checking whether such a distribution
exists would be very difficult. Fortunately, we show in the following proposition that it is in fact
  22
    Note however that in this case, our approach does not take into account all the information on the subjective
distribution.


                                                       42
sufficient to check that these conditions hold for a specific candidate distribution. To define the
cdf of this distribution, we introduce, for all b ∈ R, the random variables

                          ψ b = ψU 1l{ψU < b} + max(b, ψL )1l{ψU ≥ b}.

We also let ψ −∞ = ψL and ψ +∞ = ψU . The cdf of ψ b is then F b (t) = FψU (t)1l{t < b} +
FψL (t)1l{t ≥ b}, for all b ∈ R. We let FB = {F b , b ∈ R} denote the set of all such cdfs.

Assumption 6 E(|Y |) < +∞, E(|ψL |) < +∞ and E(|ψU |) < +∞.

Proposition 6 Suppose that Assumption 6 holds. First, if E[ψL ] ≤ E[Y ] ≤ E[ψU ], there exists
a unique F ∗ ∈ FB such that δF ∗ = 0. Second, the following statements are equivalent:

  (i) H0B holds.

 (ii) E[ψL ] ≤ E[Y ] ≤ E[ψU ] and ∆F ∗ (y) ≥ 0 for all y ∈ R.

This test shares some similarities with the test in the presence of aggregate shocks. Specifically,
if E[ψL ] ≤ E[Y ] ≤ E[ψU ], we first identify b0 ∈ R such that the candidate belief ψ b0 , which
plays a similar role as the modified outcome q(Y, c0 ) in the test with aggregate shocks, satisfies
the equality
      h       constraint E[ψ b0 i] = E[Y ]. Noting that the inequality ∆F ∗ (y) ≥ 0 can be rewritten
                            +
as E (y − Y )+ − y − ψ b0          ≥ 0, it follows from (ii) that rationalizing RE in this context
(i.e., H0B ) is then equivalent to a set of many moment inequality constraints involving the
distributions of realizations Y and candidate belief ψ b0 .


C     Tests with sample selection in the datasets
We consider here cases where the two samples are not representative of the same population, or
formally, D is not independent of (Y, ψ). This may arise for instance because of oversampling of
some subpopulations or differences in nonresponse between the two surveys that are used. We
assume instead that selection is conditionally exogenous, that is to say:

                                          D⊥
                                           ⊥ (Y, ψ)|X.                                         (15)

We show how to use a propensity score weighting to handle such a selection. Denote by p(x) =
P (D = 1|X = x) = E [D|X = x] the propensity score and by

                                              D     1−D
                                   W (X) =       −         .
                                             p(X) 1 − p(X)

The law of iterated expectations combined with Proposition 2 directly yields the following propo-
sition:


                                                43
Proposition 7 Suppose that (15) and Assumption 1 hold. Then H0X is equivalent to
                                            + 
                              E W (X) y − Y e   |X ≥ 0

                   h          i
for all y ∈ R and E W (X)Ye |X = 0.

This proposition shows that under sample selection, we can build a statistical test of H0X akin
to that developed in Section 3, by merely estimating nonparametrically p(X). We could consider
for that purpose a series logit estimator, for instance. Validity of such a test would follow using
very similar arguments as for the test with aggregate shocks considered above.


D     Simulations with covariates
We consider here simulations including covariates. The DGP is similar to that considered in
Section 3. Specifically, we assume that
                                                     √
                                         Y = ρψ +        Xε,

with ρ ∈ [0, 1], ψ ∼ N (0, 1), X ∼ Beta(0.1, 10) and

                              ε = ζ (−1l{U ≤ 0.1} + 1l{U ≥ 0.9}) ,

where ζ ∼ N (2, 0.1) and U ∼ U[0, 1]. (ψ, ζ, U, X) are supposed to be mutually independent.

Like in the test without covariates, we can show that the test with covariates is able to reject
RE if and only if ρ < 0.616. On the other hand, by construction E [Y |X] = E [ψ|X], so the naive
conditional test has no power. The test based on conditional variances rejects only if ρ < 0.445.
Finally, we can show that without using X, our test has power only for ρ < 0.52. Hence, relying
on covariates allows us to gain power for ρ ∈ [0.521, 0.616).

Again, we consider hereafter nψ = nY = n ∈ {400, 800, 1200, 1600, 3200}, use 500 bootstrap
simulations to compute the critical value, and rely on 800 Monte-Carlo replications for each
value of ρ and n. We use the same parameters p = 0.05 and b0 = 0.3 as above. Figure 5 shows
that the RE test with covariates asymptotically outperforms the RE test without covariates.
The test exhibits a similar behavior as that without covariates, though, as we could expect, the
power converges less quickly to one as n tends to infinity.




                                                44
      Notes: the dotted vertical lines correspond to the theoretical limit for the rejection of the null hypoth-
      esis for test based on variance (ρ ' 0.445), our test without covariates (ρ ' 0.521) and our tests with
      covariates (ρ = 0.616). The dotted horizontal line corresponds to the 5% level.

                           Figure 5: Power curves for the test with covariates.


E      Additional material on the application
E.1     Descriptive statistics and minimal deviations for non-college graduates

                            Table 4: Descriptive statistics of the SCE sample

                                                          Mean          Std. dev.
                               Male                       0.53            0.50
                               White                      0.74            0.43
                               College degree             0.49             0.46
                               Low numeracy                0.33            0.47
                               Tenure ≤ 6 months           0.17            0.38
                               Age                         45.8            13.0
                               ψ (Earnings beliefs)      $50,592         $40,889
                               Y (Realized earnings)     $52,354         $38,634




                                                         45
Notes: the pointwise confidence intervals are obtained by percentile bootstrap. All results are in 2015
US dollars.

                  Figure 6: Minimal deviations for individuals without a college degree

E.2        Additional details and results on the life-cycle consumption model
The income process is specified as follows. First, we estimate the deterministic trend κi,t as a
smooth function of age (second-order polynomial) using the dataset of Blundell et al. (2008)
built from the PSID.23 We use the same value as in the baseline specification of KV for σ2 and
σz20 , namely σ2 = 0.05 and σz20 = 0.15. We choose ση2 = 0.02 as it is in the range of Blundell
et al. (2008) and appears to fit the 1989 and 1992 Survey of Consumer Finances data better
than the baseline value used by KV. Our main results remain qualitatively unchanged when we
use the same values as in BPP for both variances σ2 (0.037) and ση2 (0.019).
To estimate hM , we rely on (14). Given the specification of our model, E [Yi,t |Ii,t−1 ], when
t < T ret , is lognormally distributed with parameters κi,t + (ση2 + σ2 )/2 and σz20 + (t − 1)ση2 . To
estimate Fψ−1  t
                 , we use the subjective beliefs of individuals between 25 and 60 measured in the SCE
survey. Since in KV, Yi,t is interpreted as household income after taxes and transfers, whereas
we only observe subjective expectations on individual labor earnings, we use an equipercentile
mapping based on the two distributions of realized (expected) individual labor earnings and
realized (expected) household income. We estimate this equipercentile mapping using the dataset
from Blundell et al. (2008), built from the PSID, where both realized individual labor earnings
and household income are observed from 1989 to 1992. Finally, we assume that the quantile of
income expectations is linear in age, and thus estimate Fψ−1     t
                                                                   by a quantile regression of subjective
  23
       Results are robust to the use of a more flexible fourth-order polynomial for κi,t .


                                                           46
expectations on age. We finally estimate hM using (14), replacing Fψ−1
                                                                     t
                                                                       by the quantile regression
estimator.

                            Figure 7: Age profiles of insurance coefficients.




                                         (a) With borrowing constraints




                                       (b) Without borrowing constraints


Notes: the curves in gray (resp. in black) correspond to insurance coefficients under RE (resp. minimal deviations
from RE). The dotted black curves are the 2.5 and 97.5 quantiles of bootstrap simulations, taking into account
                  hM . They are obtained using 200 bootstrap samples.
the randomness of b




                                                       47
                     Figure 8: Average lifetime net worth (in $00,000) profiles.




             (a) Zero borrowing constraint                          (b) Natural borrowing constraint


Notes: SCF stands for the 1992 Survey of Consumer Finance. The dotted black curve is the estimated non-
parametric regression function of net worth of households in this dataset on age using local polynomials and a
                                                                     hM are obtained with 200 bootstrap samples.
bandwidth selected via cross-validation. The confidence intervals on b



F     Proofs
F.1    Notation and preliminaries
For any set H, let us denote by l∞ (H) the collection of all uniformly bounded real functions on
H equipped with the supremum norm kf kH = supx∈H |f (x)|. Denote by L2 (F ) the square inte-
grable space with respect to the measure associated with F , and let k·kF,2 be the corresponding
norm. We let N (, T , L2 (F )) denote the minimal number of -balls with respect to k·kF,2 needed
to cover T . An -bracket (with respect to F ) is a pair of real functions (l, u) such that l ≤ u
and ku − lkF,2 ≤ . Then, for any set of real functions M, we let N[] (, M, L2 (F )) denote the
minimum number of -brackets needed to cover M. We denote by H = (∪r≥1 Hr ). For x ∈ Rd ,
d > 1, we denote by kxk∞ = maxj=1,...,d |x|.
For a sequence of random variable (Un )n∈N and a set F0 , we say that Un = OP (1) uniformly in
F ∈ F0 if for any  > 0 there exist M > 0 and n0 > 0 such that supF ∈F0 PF (|Un | > M ) < 
for all n > n0 . Similarly we say that Un = oP (1) uniformly in F ∈ F0 if for any  > 0,
supF ∈F0 PF (|Un | > ) → 0.

                                                      48
Finally, we add stars to random variables whenever we consider their bootstrap
                                                                              versions,
                                                                                            as
        ∗
with T versus T . We define oP ∗ and OP ∗ as above, but conditional on Yei , Di , Xi           .
                                                                                     i=1...n
Convergence in distribution conditional on Yei , Di , Xi   is denoted by →d∗ .
                                                                 i=1...n


F.2     Proof of Lemma 1
Under H0 , there exists Y 0 , ψ 0 and I 0 such that Y 0 ∼ Y , ψ 0 ∼ ψ, σ(ψ 0 ) ⊂ I 0 and E(Y 0 |I 0 ) = ψ 0 .
Then, by the law of iterated expectations,

                              E[Y 0 |ψ 0 ] = E E Y 0 I 0 ψ 0 = E ψ 0 |ψ 0 = ψ 0 .
                                                                    


Conversely, if there exists (Y 0 , ψ 0 ) such that Y 0 ∼ Y , ψ 0 ∼ ψ and E[Y 0 |ψ 0 ] = ψ 0 , let I 0 = σ (ψ 0 ).
Then ψ 0 = E [Y 0 |ψ 0 ] = E [Y 0 |I 0 ] and H0 holds.

F.3     Proof of Theorem 1.
(i) ⇔ (iii). By Strassen’s theorem (Strassen, 1965, Theorem 8), the existence of (Y, ψ) with
                                                                              R           R
margins equal to FY and Fψ and such that E [Y |ψ] = ψ is equivalent to f dFψ ≤ f dFY
for every convex function f . By, e.g., Proposition 2.3 in Gozlan et al. (2018), this is, in turn,
equivalent to (iii).
                                           Ry                 hR               i
                                                                 y
(ii) ⇔ (iii). By Fubini-Tonelli’s theorem, −∞ FY (t)dt = E −∞ 1l{t ≥ Y }dt = E [(y − Y )+ ] .
The same holds for ψ. Hence, ∆(y) ≥ 0 for all y ∈ R is equivalent to E (y − Y )+ ≥ E (y − ψ)+
                                                                                              

for all y ∈ R. The result follows.

F.4     Proof of Proposition 1.
First, by Jensen’s inequality,

                            E[(y0 − Y )+ |ψ] ≥ (y0 − E(Y |ψ))+ = (y0 − ψ)+ .

Moreover, ∆(y0 ) = 0 implies that E((y0 − Y )+ ) = E((y0 − ψ)+ ). Hence, almost surely,

                                       E[(y0 − Y )+ |ψ] = (y0 − ψ)+ .

Equality in the Jensen’s inequality implies that the function is affine on the support of the
random variable. Therefore, for almost all u, we either have S(Y |ψ = u) ⊂ [y0 , +∞) or S(Y |ψ =
u) ⊂ (−∞, y0 ]. Because E [Y |ψ] = ψ, S(Y |ψ = u) ⊂ [y0 , +∞) for almost all u > y0 and
S(Y |ψ = u) ⊂ (−∞, y0 ] for almost all u < y0 . Then, for all τ ∈ (0, 1), FY−1  |ψ (τ |u) ≥ y0 for almost
                        −1
all u ≥ y0 and FY |ψ (τ |u) ≤ y0 for almost all u ≤ y0 . Thus, for all τ ∈ (0, 1), by continuity of
FY−1            −1
    |ψ (τ |·), FY |ψ (τ |y0 ) = y0 . This implies that Y |ψ = y0 is degenerate.




                                                       49
F.5    Proof of Proposition 2.
We first prove that H0X is equivalent to the existence of (Y 0 , ψ 0 ) such that DY 0 + (1 − D)ψ 0 = Ye ,
  ⊥ (Y 0 , ψ 0 )|X and E((Y 0 |ψ 0 , X) = ψ 0 . First, under H0X , there exists (Y 0 , ψ 0 , I 0 ) such that
D ⊥
DY 0 + (1 − D)ψ 0 = Ye , D ⊥
                           ⊥ (Y 0 , ψ 0 )|X, σ(ψ 0 , X) ⊂ I 0 andE((Y 0 |I 0 ) = ψ 0 . Then

                       E[Y 0 |ψ 0 , X] = E E Y 0 I 0 ψ 0 , X = E ψ 0 |ψ 0 , X = ψ 0 .
                                                                        


Conversely, if there exists (Y 0 , ψ 0 ) such that DY 0 + (1 − D)ψ 0 = Ye , D ⊥           ⊥ (Y 0 , ψ 0 )|X and
E(Y 0 |ψ 0 , X) = ψ 0 , let I 0 = σ (X 0 , ψ 0 ). Then ψ 0 = E(Y 0 |ψ 0 , X) = E(Y 0 |I 0 ) and H0X holds.
The proposition then follows as Theorem 1.

F.6    Proof of Proposition 4
For all y, ξ 7→ E[(y − ψ − ξ)+ ] is decreasing and convex. Then, because Fξψ dominates at the
second order FξY +ε ,
                  Z                                Z
                      E (y − ψ − ξ)+ dFε+ξY (ξ) ≥ E (y − ψ − ξ)+ dFξψ (ξ).
                                                                 


As a result, for all y,
                        +  Z 
                              = E (y − ψ − ε − ξY )+ |ε + ξY = ξ dFε+ξY (ξ)
                                                                
                 E y−Y  b
                               Z
                              = E (y − ψ − ξ)+ dFε+ξY (ξ)
                                             

                               Z
                              ≥ E (y − ξ − ψ)+ dFξψ (ξ)
                                             

                                 h       i
                                      b+ .
                              =E (y − ψ)
                 
Moreover, E Yb = E ψb . By Theorem 1, Yb and ψb satisfy H0 .

F.7    Proof of Theorem 2.
(i) This is a particular case of Proposition 5 below, with q(Y, c0 ) = Y . The proof is therefore
omitted.

(ii) We show that equality holds for F0 ∈ F0 satisfying the conditions stated in (ii). The proof
is divided in three steps. We first prove convergence in distribution of T to S defined below,
and conditional convergence of T ∗ towards the same limit. Then we show that the cdf H of S
is continuous and strictly increasing in the neighborhood of its quantile of order 1 − α, for any
α ∈ (0, 1/2). The third step concludes.

1. Convergence in distribution of T and T ∗ .

                                                     50
First, let us introduce some notation. Let Kj,j (j ∈ {1, 2}) be the j-th diagonal element
                                                           1/2 +2           1/2 2
                                                                            
of the covariance kernel K, S : (ν, K) 7→ (1 − p) −ν1 /K1,1       + p ν2 /K2,2 , q(r) =
          −1
 r2 + 100     (2r)−dX , and
                       n      −1/2  
                 1 X                                             h                      i
 νn,F0 (y, h) = √    Diag VF0 Ye       m Di , Yei , Xi , h, y − EF0 m Di , Yei , Xi , h, y     .
                  n
                      i=1

                                                            −1/2    h                    i
Finally, we define kn,F0 (y, h) =      n1/2 Diag         VF0 Y
                                                             e       EF0 m Di , Yi , Xi , h, y ,
                                                                                e

                                       −1/2            √            √                        −1/2
Kn,F0 (y, h, y 0 , h0 ) = Diag VF0 Ye                        nmn (y, h), nmn (y 0 , h0 ) Diag VF0 Ye
                                                                                        
                                                      Cov
                                                       d
                                                               −1/2                         −1/2
K n,F0 (y, h, y 0 , h0 ) = Kn,F0 (y, h, y 0 , h0 ) + Diag VF0 Ye         Diag V b Ye Diag VF Ye
                                                                                                  0



and use the notations Kn,F0 (y, h) = Kn,F0 (y, h, y, h) and K n,F0 (y, h) = K n,F0 (y, h, y, h).

With this notation, we have, by definition of T ,
                             X                                                                             
         T = sup                               q(r)S νn,F0 (y, ha,r ) + kn,F0 (y, ha,r ), K n,F0 (y, ha,r ) .
              y∈Y
                    (a,r):r∈{1,...,rn },a∈Ar

To characterize the distribution of T (resp. T ∗ ), we first prove the convergence of νn,F0 and
                         ∗
Kn,F0 (y, ha,r ) (resp. νn,F        ∗
                               and Kn,F   (y, ha,r )). For those purposes, we use a class of functions
                             0          0
which is a general form taken by m1 defined in (2), namely for any 0 < N1 < M1 , the class of
functions

                                  y , x, d) = dφ1 (y − ye)+ − (1 − d)φ2 (y − ye)+ h(x),
                                                                                 
              M0 = {fy,φ1 ,φ2 ,h (e
                                                             (y, φ1 , φ2 , h) ∈ Y × [N1 , M1 ]2 × H}.

Remark first that this class is a particular case of classes M defined in (25) below. Then, by
the proof of Proposition 5 below, Assumptions PS1 and PS2 in AS are satisfied. Thus the
assumptions of Lemma D.2 in AS hold as well. This entails that Assumptions PS4 and PS5 in
AS hold. Namely, there exists a Gaussian process νF0 such that
                        ∗
    - νn,F0 →d νF0 and νn,F   →d∗ νF0 ;
                            0

                                                                                 ∗
    - For all r ∈ N and (y, h) ∈ Y × Hr , K n,F0 (y, h) →P KF0 (y, h) + I2 and Kn,F  (y, h) →P ∗
                                                                                    0
      KF0 (y, h) + I2 , where I2 is the 2 × 2 identity matrix.

Moreover, letting kF0 (y, h) denote the limit in probability of kn,F0 (y, h), we have kF0 (y, h) = 0
if (y, h) ∈ LF0 and +∞ otherwise. Note that by assumption, the set LF0 is nonempty.




                                                             51
Thus, using Equation (D.11) in the proof of Theorem D.3. in AS, which is based on the uniform
continuity of the function S in the sense of Assumption S2 therein, we have, under F0 ,
                            X
               T →d sup            S (νF0 (y, ha,r ) + kF0 (y, h), KF0 (y, ha,r ) + I2 )
                        y∈Y
                              (a,r)∈Ar ×N
                                           X
                 = S := sup                               q(r)S (νF0 (y, ha,r ), KF0 (y, ha,r ) + I2 ) ,
                              y∈Y
                                    (a,r):(y,ha,r )∈LF0

where the equality follows by definition of S and kF0 (y, h). Similarly, using Assumption PS5
and (D.11) in AS, replacing T by T ∗ and quantities νn,F0 (y, ha,r ) and Kn,F0 (y, ha,r ) by their
bootstrap counterparts (see the proof of Lemma D.4 in AS) we have T ∗ →d∗ S.
2. The cdf H of S is continuous and strictly increasing in the neighborhood of any
of its quantile of order 1 − α > 1/2.
First, the cdf H of S is a convex functional of the Gaussian process νF0 . Then, as in the proof
of Lemma B3 in Andrews and Shi (2013), we can use Theorem 11.1 of Davydov et al. (1998)
p.75 to show that H is continuous and strictly increasing at every point of its support except
r = inf{r ∈ R : H(r) > 0}. Moreover, for any r > 0,
                                                                                    
                           X
      H(r) ≥ P sup                 q(r)S (νF0 (y, ha,r ), KF0 (y, ha,r ) + I2 ) < r
                  y∈Y
                        (a,r):(y,ha,r )∈LF0
                                                                                                              p     !
                                                                                 −1/2                         r/2
           ≥P                   sup                 (K2,F0 ,j,j (y, ha,r ) + )         νF0 ,j (y, ha,r ) <
                 j∈{1,2},(y,a,r):(y,ha,r )∈LF0                                                                Q

            > 0,
             P
where Q = (a,r):(y,ha,r )∈LF q(r) < ∞ and we use Problem 11.3 of Davydov et al. (1998) p.79
                             0
for the last inequality. Thus, r > r and H is continuous and strictly increasing on (0, ∞).
Then, we show that for any α ∈ (0, 1/2), the quantile of order 1 − α of the distribution of S is
positive. By assumption, there exists (y0 , h0 ) ∈ LF0 such that either either KF0 ,11 (y0 , h0 ) > 0
or KF0 ,2 (y0 , h0 ) > 0. Then
                                                                                               
                                   X
       P (S > 0) = 1 − P sup                  q(r)S (νF0 (y, ha,r ), KF0 (y, ha,r ) + I2 ) = 0
                                y∈Y
                                       (a,r):(y,ha,r )∈LF0

                 ≥ 1 − P (νF0 ,1 (y0 , h0 ) ≤ 0, νF0 ,2 (y, h0 ) = 0)
                 ≥ 1 − min {P (νF0 ,1 (y0 , h0 ) ≤ 0) , P (νF0 ,2 (y0 , h0 ) = 0)}
                 ≥ 1/2.                                                                                                 (16)

The first inequality holds by definition of the supremum and because S is nonnegative. To
obtain the last inequality, note that either νF0 ,1 (y0 , h0 ) is non-degenerate, in which case the

                                                              52
first probability is 1/2 (since νF0 ,1 (y0 , h0 ) is normal with zero mean), or νF0 ,2 (y0 , h0 ) is non-
degenerate, in which case the second probability is 0.

Finally, using that H is strictly increasing on (0, ∞), (16) ensures that any quantile of S of
order 1 − α with α ∈ [0, 1/2) is positive. Hence, H is continuous and strictly increasing in the
neighborhood of any such quantiles.

3. Conclusion.

Using T ∗ →d∗ S in distribution, Step 2 and Lemma 21.2 in Van der Vaart (2000), we have that
for η > 0, c∗n,α →d∗ c(1 − α + η) + η, where c(1 − α + η) is the (1 − α + η)-th quantile of the
distribution of S. Because T →d S and H is continuous at c(1 − α + η) + η > 0, we obtain that

                                              lim lim sup PF0 T > c∗n,α = α.
                                                                       
                                              η→0    n→∞

Combined with the inequality of Part (i) above, this yields the result.
                                                                                            
(iii) This results Theorem E.1 in AS. First, Assumption SIG2 in AS holds for σF2 = VF Ye ,
following the proof of Lemma 7.2 (b) under Assumption 3-(ii). Second, Assumptions PS4 and
PS5 are satisfied using the point (ii) above. Third, Assumptions CI, MQ, S1, S3, S4 in AS are
also satisfied by construction of the statistic T . Thus, we can apply Theorem E.1 in AS and the
result follows.                                                                               

F.8     Proof of Theorem 3.
For any positive convex function ρ, we let

                                      Wρ (F, G) =              inf          E [ρ (|U − V |)] .
                                                         FU,V :U ∼F,V ∼G

We also define
                    Z            y                  Z   y                           Z                   Z           
         G = G cdf :                      G(t)dt ≤           FY (t)dt ∀y ∈ R,            ydG(y) =            ydFY (y) .
                                 −∞                   −∞

The proof is divided in three steps. First, we prove that the initial infimum is equal to
inf G∈G Wρ (Fψ , G). Second, we prove that there is a unique G∗ that reaches this infimum for
all convex function ρ : R+ → R+ such that ρ(0) = 0. Third, we prove that there is a unique
function g ∗ such that (4) holds, and that this function is increasing.

1. inf (Y 0 ,ψ0 ,ψ00 )∈Ψ E[ρ(|ψ 0 − ψ 00 |)] = inf G∈G Wρ (Fψ , G).

First, by definition of Wρ and because for all (Y 0 , ψ 0 , ψ 00 ) ∈ Ψ Fψ0 = Fψ , we have

                           inf            E[ρ(|ψ 0 − ψ 00 |)] =                inf                  Wρ (Fψ , G).
                    (Y 0 ,ψ 0 ,ψ 00 )∈Ψ                           G:∃(Y 0 ,ψ 0 ,ψ 00 )∈Ψ: Fψ00 =G




                                                                  53
Thus, it remains to prove that G 0 = G, with G 0 defined by

                                G 0 = G : ∃(Y 0 , ψ 0 , ψ 00 ) ∈ Ψ : Fψ00 = G .
                                     
                                                                                                       (17)

First, let G ∈ G 0 . Let (Y 0 , ψ 0 , ψ 00 ) ∈ Ψ be such that Fψ00 = G. By definition of Ψ, we have
E(Y 0 |ψ 00 ) = ψ 00 and FY 0 = FY . Therefore, by implication (i)⇒ (ii) of Theorem 1 applied to Y 0
and ψ 00 , G = Fψ00 ∈ G. Hence, G 0 ⊂ G. Conversely, let G ∈ G. Then, by implication (ii)⇒ (i)
of Theorem 1, there exists (Y 0 , ψ 00 ) such that Y 0 ∼ Y , Fψ00 = G and E(Y 0 |ψ 00 ) = ψ 00 . Define
ψ 0 = ψ. Then (Y 0 , ψ 0 , ψ 00 ) ∈ Ψ and G ∈ G 0 . Equation (17) follows.

2. There exists a unique G∗ such that for all ρ, Wρ (Fψ , G∗ ) = inf G∈G Wρ (Fψ , G) .

Because Fψ has no atom, the distribution of H −1 ◦ Fψ (ψ) is H, for any cdf H. Hence, the set

  Fg(ψ) , g measurable is actually the set of all cdf’s. Then, by Proposition 3.1 and Remark 3.2
in Gozlan et al. (2018), we have, for any convex function ρ : R+ → R+ such that ρ(0) = 0,

                                                                         E ρ ψ 0 − E Y 0 |ψ 0
                                                                                             
                  inf Wρ (Fψ , G) =                     inf                                        .   (18)
                  G∈G                     FY 0 ,ψ0 : FY 0 =FY ,Fψ0 =Fψ


Third, by Theorem 1.4 in Gozlan et al. (2018), there exists a distribution G∗ such that

                              f dG∗ ≤
                          R               R
   1. For all f convex,                       f dFY ;

   2. for any convex function ρ : R+ → R+ such that ρ(0) = 0,

                                                       E ρ ψ 0 − E Y 0 |ψ 0      = Wρ (Fψ , G∗ ).
                                                                           
                                    inf                                                                (19)
                        FY 0 ,ψ0 : FY 0 =FY ,Fψ0 =Fψ


By, e.g., Proposition 2.3 in Gozlan et al. (2018), Point (1) is equivalent to G∗ satisfying (iii) in
Theorem 1. Therefore, in view of Theorem 1, we have G∗ ∈ G. Combining (18) and (19), we
obtain:
                                    G∗ ∈ arg min Wρ (Fψ , G).
                                                          G∈G

Now, G is convex. Moreover, by Lemma 3.2.1 of Pass (2013) and because Fψ has no atom,
G 7→ Wρ (Fψ , G) is strictly convex for ρ(x) = x2 . Therefore, G∗ is the unique minimizer of
G 7→ Wρ (Fψ , G) for this ρ. It is therefore the unique G ∈ G minimizing Wρ (Fψ , G) for all convex
function ρ : R+ 7→ R+ such that ρ(0) = 0.

3. There exists a unique g ∗ such that E[ρ(|ψ − g ∗ (ψ)|)] = inf (Y 0 ,ψ0 ,ψ00 )∈Ψ E[ρ(|ψ 0 − ψ 00 |)]
and g ∗ is increasing.

Let g ∗ = G∗−1 ◦ Fψ . g ∗ is increasing. We now prove that it satisfies the equality above. First, by
construction, Fg∗ (ψ) = G∗ . Moreover, by e.g., Theorem 5.26 of Villani (2008), g ∗ is the unique
function satisfying
                                   E [ρ(|ψ − g ∗ (ψ)|)] = Wρ (Fψ , G∗ ).                         (20)

                                                              54
This equation, together with the first and second steps, imply that

                         E [ρ(|ψ − g ∗ (ψ)|)] =          inf            E[ρ(|ψ 0 − ψ 00 |)].         (21)
                                                  (Y 0 ,ψ 0 ,ψ 00 )∈Ψ

Now, consider g 6= g ∗ such that Fg(ψ) = G∗ . By unicity of g ∗ satisfying (20), we have
E [ρ(|ψ − g(ψ)|)] > Wρ (Fψ , G∗ ). Finally, if g =
                                                 6 g ∗ is such that Fg(ψ) = G 6= G∗ for some
G ∈ G, we have, taking ρ(x) = x2 ,

                          E [ρ(|ψ − g(ψ)|)] ≥ Wρ (Fψ , G) > Wρ (Fψ , G∗ ).

Therefore, g ∗ is the unique function satisfying (21) for all convex function ρ : R+ 7→ R+ such
that ρ(0) = 0.

F.9    Proof of Theorem 4.
First, in Step 1 of the proof of their Theorem                                       b ∗ , defined as
                                                  1.4, Gozlan et al. (2018) show that G
                                                                                       n
the empirical distribution of ψe1 , ..., ψen satisfies

                                      b ∗n = arg min W2 (Fbψ , G),
                                      G
                                                   G∈G


where Fbψ denotes the empirical cdf of ψ and for any q ≥ 1, Wp (F, G) = Wρq (F, G)1/q with
ρq (x) = |x|q . Given the definition of g ∗ , we also have gb∗ = G
                                                                 b ∗−1 ◦ Fbψ . Moreover, Fbψ (x)
                                                                   n
converges almost surely to Fψ (x).

Let us focus hereafter on the event of probability one for which Fbψ and FbY converges 
                                                                                       to Fψ and
FY , respectively, for the W2 distance. On this event, consider any subsequence of G     b ∗n   .
                                                                                                     n∈N
Following Step 2 of the proof of Theorem 1.4 in Gozlan et al. (2018), but replacing |x| by x2
and using the fact that E(ψ 2 ) < +∞ and E(Y 2 ) < +∞, there exists a further subsequence
converging for the W2 distance. Moreover, the corresponding limit Ge satisfies, for all convex
function ρ : R+ → R+ such that ρ(0) = 0,
                           
                                                  E ρ ψ 0 − E Y 0 |ψ 0
                                                                      
                  Wρ Fψ , G
                          e =           inf                                 .
                                   FY 0 ,ψ0 : FY 0 =FY ,Fψ0 =Fψ

                                           
                                          e = Wρ (Fψ , G∗ ). Because
Hence, by the proof of Theorem 3, Wρ Fψ , G

                                      G∗ = arg min W2 (Fψ , G),
                                                   G∈G
                                               
we have Ge = G∗ . Hence, any subsequence of G   b ∗n        admits a converging further subsequence
                                                     n∈N 
converging to G∗ . This implies that almost surely, G  b ∗n      converges to G∗ for the W2 distance.
                                                             n∈N          
Because convergence for the W2 distance implies weak convergence, G        b ∗n     converges weakly
                                                                                               n∈N


                                                     55
                                                                               
to G∗ , almost surely. But then, by Lemma 21.2 in Van der Vaart (2000), Gb −1∗
                                                                           n (x)                   converges
                                                                                            n∈N
almost surely to   G∗−1 (x),   for all x that is a continuity point of           G∗−1 .

Finally, let us prove the almost sure convergence of gb∗ (t) to g ∗ (t) for all t that is a continuity
point of g ∗ and such that Fψ (t) ∈ (0, 1). Fix ε > 0 and let us prove that for all n large enough,
 g ∗ (t) − g ∗ (t)| < ε with probability one. Because Fψ (t) is a continuity point of G∗−1 , there exists
|b
δ > 0 such that for all u satisfying |u − Fψ (t)| < δ, |G∗−1 (u) − G∗−1 (Fψ (t))| < ε/2. It is easy
to see that the set of points of discontinuity of G∗−1 is at most countable. Thus, there exists
η ∈ (0, δ) such that Fψ (t) + η and Fψ (t) − η are continuity points of G∗−1 . Moreover, with
probability one and for all n large enough, |Fbψ (t) − Fψ (t)| ≤ η. Then, for all n large enough and
with probability one,
                                   Gb ∗−1 ◦ Fbψ (t) ≤ G
                                                      b ∗−1 ◦ [Fψ (t) + η] .
                                      n                 n

Because Fψ (t) + η is a continuity points of G∗−1 , we have by what precedes that for all n large
enough and with probability one,

                                b ∗−1 ◦ Fbψ (t) ≤ G
                                G                 b ∗−1 ◦ [Fψ (t) + η]
                                  n                 n

                                                      ≤ G∗−1 ◦ [Fψ (t) + η] + ε/2
                                                      ≤ G∗−1 ◦ Fψ (t) + ε.

                                                            b ∗−1
Similarly, for all n large enough and with probability one, G n   ◦ Fbψ (t) ≥ G∗−1 ◦ Fψ (t) − ε. The
result follows by definition of gb∗ (t).

F.10     Proof of Theorem 5.
Note first that because FE[Y |I] is continuous, FE[Y |I] (E [Y |I]) is uniformly distributed (see,e.g.
Van der Vaart, 2000, p.305). In turn, this implies that the cdf of hM (E [Y |I]) is Fψ . Hence,
(hM (E [Y |I]) , E [Y |I]) ∈ ΨM . If for all (ψ 0 , ψ 00 ), E(ρ(|ψ 0 − ψ 00 |)] = +∞, Equality (8) holds. If
not, let (ψ 0 , ψ 00 ) ∈ ΨM be such that E(ρ(|ψ 0 − ψ 00 |)] < +∞. Because ρ is convex, we have, for all
x0 ≥ x and y 0 ≥ y,

                       ρ(|x0 − y 0 |) − ρ(|x − y 0 |) − ρ(|x0 − y|) + ρ(|x − y|) ≤ 0.

Then, by Theorem 3.1.2 in Rachev and Rüschendorf (1998),
                                Z   1                                       
                   0    00
           E[ρ(|ψ − ψ |)] ≥             ρ       Fψ−1 (u) − FE(Y
                                                            −1
                                                                 du.
                                                                |I M )
                                                                       (u)
                               Z0                                               
                             = ρ Fψ−1 ◦ FE[Y |I] (v) − FE[Y
                                                          −1
                                                             |I] ◦ F E[Y |I] (v)   dFE[Y |I] (v)
                                 h                                                 i
                                                      −1
                             = E ρ hM (E [Y |I]) − FE[Y  |I] ◦ F E[Y |I] (E [Y |I])    .                (22)



                                                             56
                        −1
Finally, note that FE[Y     |I] ◦ FE[Y |I] (v) < v only if v is in the interior or at the right end of a
“flat” of FE[Y |I] (see, e.g., lemma 21.1 in Van der Vaart, 2000). Because the set of such right end
                                                       −1
points is countable and FE[Y |I] has no atom, FE[Y        |I] ◦ FE[Y |I] (E [Y |I]) = E [Y |I] almost surely.
Combined with Equation (22), this implies (8).

Now, let us suppose that ρ is strictly convex and let (ψ 0 , E [Y |I]) ∈ ΨM satisfy (8). We can apply
the first part of the proof of Theorem 2.2.1 in Santambrogio (2015), remarking that it does not
rely on the asssumption of compact supports. This implies that the distribution of (ψ 0 , E [Y |I])
is equal to that of (hM (E [Y |I]), E [Y |I]). Hence, conditional on E [Y |I], ψ 0 is degenerate and
equal to hM (E [Y |I]). The result follows.

F.11     Proof of Proposition 5
                      h                       i
We introduce EF,c = EF m Di , Yec,i , Xi , h, y and

                             n           −1/2  
                          1 X                                                    
           νn,F (y, h) = √     Diag Vb F Yebc     m Di , Yebc,i , Xi , h, y − EF,bc ,
                           n
                               i=1
                              n         −1/2  
                           1 X                                                   
           ν n,F (y, h) = √     Diag VF Yec0     m Di , Yec0 ,i , Xi , h, y − EF,c0 .
                            n
                               i=1

The proof is based on Theorem 5.1 in AS, hence we have to check that the corresponding
assumptions PS1, PS2, and SIG1 hold. Namely, we have to ensure that

    - PS1: for all sequence F ∈ F and all (d, y 0 , x, h, y, c) ∈ {0, 1} × Y × [0, 1]dX × Hr × Y ×
      Cs [0, 1]dX
                  


            m(d, y 0 , x, h, y)
                                                                                  2+δ 
                                         0
                              ≤ M (d, y , x, h, y) and EF M Di , Yc,i , Xi , h, y
                                                                   e                       ≤ C < ∞,
              VF Yec,i

       where δ > 0 and for some function M ;

    - PS2: for all sequence Fn ∈ F, the i.i.d triangular array of processes
                                                
              m D , Ye
                      i n,c(Xn,i ) , Xn,i , h, y                                                 
       Tn0 =                                     , (c, y, h) ∈ Cs [0, 1]dX × Y × H, i ≤ n, n ≥ 1
                      VFn Yen,c(X )  n,i


      is manageable with respect to some envelope function U1 (see Pollard, 1990, p.38 for the
      definition of a manageable class);
                                                                             
    - SIG1: for all ζ > 0, supF ∈F ,c∈Cs ([0,1]dX ) P Vb F Yei,c /VF Yei,c − 1 > ζ → 0.

                                                               −1/2
We proceed in two steps, to handle the fact that c0 and Diag VF Yec0    are estimated:

                                                     57
   1. We first show that

                               sup          sup        kνn,F (y, h) − ν n,F (y, h)k∞ =oP (1),                   (23)
                              F ∈F0 h∈∪r≥1 Hr ,y∈Y
                                                         ∗
                               sup         sup          νn,F (y, h) − ν ∗n,F (y, h)       ∞
                                                                                              =oP ∗ (1).        (24)
                              F ∈F0 h∈∪r≥1 Hr ,y∈Y


   2. Next, we show that m satisfies assumptions PS1, PS2, and that SIG1 in AS also holds for
                                                P                            2
      σF2 = VF Yec0 , where F ∈ F and σ  bn2 = n−1 ni=1 Yebc,i − n−1 nj=1 Yebc,j .
                                                                    P

1. Proof of (23)-(24).
We apply the uniform version over F ∈ F0 of Theorem 3 in Chen et al. (2003) to a general
class of functions
               to which pertain the moment condition m (see (2), with Y replaced here by
                                                                                    e
Yec = Dq Ye , c +(1−D)ψ and without the moment equality m2 ). Hence, it suffices to verify that
Assumptions (3.2) and (3.3) of Theorem 3 in Chen et al. (2003) are satisfied. Let us introduce,
for any 0 < N1 < M1 , the classes of functions
       n                                                                                           o
M1 = fc,y,φ,h (e                    y , c(x)))+ h(x), (c, y, φ, h) ∈ Cs [0, 1]dX × Y × [N1 , M1 ] × H ,
                 y , x) = φ (y − q (e
                                                                                                                (25)
    n                                                                                  o
               y , x) = φ (y − ye)+ h(x), (c, y, φ, h) ∈ Cs [0, 1]dX × Y × [N1 , M1 ] × H ,
M2 = fc,y,φ,h (e

 M ={fc,y,φ1 ,φ2 ,h (e
                     y , x, d) = (dgc,y,φ1 ,h − (1 − d)qc,y,φ2 ,h ) (ey , x) , g ∈ M1 , q ∈ M2 ,
                                                                                   
                                                  (c, y, φ1 , φ2 , h) ∈ Cs [0, 1]dX × Y × [N1 , M1 ]2 × H}.

Note that φ1 , φ2 , and c in the class M denote components of m that are estimated.
Consider the space Cs [0, 1]dX × Y × [N1 , M1 ]2 × H equipped with the norm
                                    

                                             n                                             o
                  k(c, y, φ1 , φ2 , h)k = max kck[0,1]dX , |y| , |φ1 | , |φ2 | , khk[0,1]dX .

For v = (c, y, φ1 , φ2 , h), v 0 = (c0 , y 0 , φ01 , φ02 , h0 ) ∈ Cs [0, 1]dX × Y × [N1 , M1 ]2 × H and (e
                                                                             
                                                                                                         y , x, d) ∈
          d
Y × [0, 1] × {0, 1}, we have, by the triangular inequality and Assumptions 5-(i) and 5-(v),
            X



       |fv (e
            y , x, d) − fv0 (e
                             y , x, d)| ≤ gc,y,φ1 ,h (e
                                                      y , x) − gc0 ,y0 ,φ01 ,h0 (e
                                                                                 y , x)

                                                         y , x) − qc0 ,y0 ,φ02 ,h0 (e
                                           + qc,y,φ2 ,h (e                          y , x)

                                         ≤(M + M0 ) φ1 − φ02 + φ2 − φ02
                                                                                         

                                           + 2M1 y − y 0 + q (e        y , c(x)) − q ye, c0 (x)
                                                                                                  

                                                                                              y , c(x)) ≤ y 0
                                                                                          
                                           + 2M0 M1 1l {q(e     y , c(x)) ≤ y} − 1l q(e
                                                                   y , c(x)) ≤ y 0 − 1l q ye, c0 (x) ≤ y 0
                                                                                                        
                                                       + 1l q (e
                                                       + h(x) − h0 (x) .
                                                                                


                                                             58
        y , .) is Lipschitz and by convexity of x 7→ x2 , we obtain
Since q(e
                                                                               
                                                                2             2
   |fv (e                y , x, d)|2 /7 ≤(M + M0 )2 φ1 − φ01 + φ2 − φ02
        y , x, d) − fv0 (e
                                                h                                i
                                                        2                 2
                                          + 4M12 y − y 0 + Kq c − c0 [0,1]dX

                                          + 4(M0 M1 )2 1l {q(e                       y , c(x)) ≤ y 0
                                                                                
                                                             y , c(x)) ≤ y} − 1l q(e
                                                              y , c(x)) ≤ y 0 − 1l q ye, c0 (x) ≤ y 0
                                                                                              
                                                     + 1l q (e
                                                                  2
                                                     + h − h0 [0,1]dX .
                                                                        


for some constant Kq > 0. Fix δ > 0. If kv − v 0 k ≤ δ, then

                       y , x, d)|2 /7 ≤δ 2 2(M + M0 )2 + 4M12 (1 + Kq ) + 4(M0 M1 )2
                                                                                          
 |fv (e
      y , x, d) − fv0 (e
                                        + 4(M0 M1 )2 1l {q(e
                                                    
                                                           y , c(x)) ≤ y + δ} − 1l {q(e
                                                                                      y , c(x)) ≤ y − δ}
                                                   + 1l ye ≤ q y , c(x) − 1l ye ≤ q I y 0 , c0 (x)
                                                                  I  0
                                                                                                   
                                                                                                         .

Next, by Assumption 5-(iv),
                    h n                 o    n                  oi
                  E 1l q Ye , c(X) ≤ y + δ − 1l q Ye , c(X) ≤ y − δ

                    =Fq(Ye ,c(X)) (y + δ) − Fq(Ye ,c(X)) (y − δ)

                    ≤2Q2 δ.

Finally,

               E 1l Y ≤ q I y 0 , c(X) − 1l ye ≤ q I y 0 , c0 (X)
                                                              

              ≤E 1l Y ≤ q I y 0 , c(X) − QF,2 δ − 1l ye ≤ q I y 0 , c(X) + QF,2 δ
                                                                             

              ≤E FY |X q I y 0 , c(X) − QqI δ X − FY |X q I y 0 , c(X) + QqI δ X
                                                                              

              ≤2QF,1 QqI δ,

where QqI is the Lipschitz constant of q I . Thus, by Assumption 5, there exists Q > 0 such that
                              "                                                    #
                                                                           2
                      sup E       sup       fv Ye , X, D − fv0 Ye , X, D               ≤ Qδ.            (26)
                      F ∈F0    kv−v 0 k≤δ

Therefore the class M satisfies Condition (3.2) of Theorem 3 in Chen et al. (2003) uniformly in
F ∈ F0 . Moreover, the class H is manageable and thus Donsker (see Lemma 3 in Andrews and
Shi, 2013). Finally, by Remark 3 (ii) in Chen et al. (2003), Cs [0, 1]dX is also Donsker. Then,
                                                                          

Cs [0, 1]dX , Y, [N1 , M1 ], and H satisfy Condition (3.3) of Theorem 3 in Chen et al. (2003). The
            

result follows by Theorem 3 in Chen et al. (2003).

2. m satisfies PS1 and PS2 of AS and SIG1 of AS also holds for σF2 and σ
                                                                       bn2 .

                                                     59
From Assumption 5 (iii) and the proof of Lemma 7.2 (a) in AS, PS1 is satisfied replacing B by
max(M, M0 ) in the proof of Lemma 7.2-(a) in AS.
We now show that PS2 in AS also holds. As the result is uniform over F0 , we have to consider
sequences for the cdfs Fn of (Dn,i , Yn,i , Xn,i )i=1...n (with Fn ∈ F0 ). We also define

                     Yen,c(Xn,i ) = Dn,i q (Yn,i , c(Xn,i )) + (1 − Dn,i )ψn,i ,
                          Wn,i = Dn,i /EFn [Dn,i ] − (1 − Dn,i )/EFn [1 − Dn,i ] ,
                                                 
                          σF2 n = VFn Yen,c(Xn,i ) .

Note that by Assumption 3 (iii), σF2 n ≥ σ > 0 for all Fn ∈ F. Let (Ω, F, Fn ) be a probability
space and let ω denote a generic element in Ω. Showing Assumption PS2 in AS then boils down
to prove that for any 0 < N1 < M1 := 1/ inf F σF2 , the i.i.d triangular array of processes
                                 +                                   
   T1,n,ω = Wn,i φ y − Yen,c(Xn,i ) h(Xn,i ), (c, y, φ, h) ∈ Cs [0, 1]dX × Y × [N1 , M1 ] × H,
                           
              i ≤ n, n ≥ 1

is manageable with respect to some envelope function U1 . Lemma 3 in Andrews and Shi (2013)
shows that the processes {h(Xn,i ), h ∈ H, i ≤ n, n ≥ 1} are manageable with respect to the
constant function 1. Then, using Lemma D.5 in AS, it remains to show that
                                +                                                       
     0                                                    dX
   T1,n,ω = Wn,i φ y − Yn,c(Xn,i ) , (c, y, φ) ∈ Cs [0, 1]
                        e                                      × Y × [N1 , M1 ], i ≤ n, n ≥ 1 ,

is manageable with respect to some envelope. For such an envelope, we can consider U10 (ω) =
(M0 + M )/(σ0 ). We now prove the manageability of T1,n,ω     0   . Let us define

           M0 = fc,y,φ1 ,φ2 (e                          y , c(x)))+ − (1 − d)φ2 (y − ye)+ ,
                  
                                y , x, d) = dφ1 (y − q (e
                                                                    o
                   (c, y, φ1 , φ2 ) ∈ Cs [0, 1]dX × Y × [N1 , M1 ]2 .

Reasoning as for the class M defined in (25), and using the last equation of the proof of Theorem
3 in Chen et al. (2003), p.1607, we have that for  > 0,
                                                                                                  
   N[·] , M0 , k · k2 ≤ N 0 , [N1 , M1 ]2 , |·| × N 0 , Y, |·| × N 0 , Cs [0, 1]dX , k · k[0,1]dX ,
                                                               


with 0 = (/(2Q))2 and Q defined in (26). Using Theorem 2.7.1 page 155 in Van der Vaart and
Wellner (1996), there exists a constant Q2 depending only on s, dX , and [0, 1]dX such that
                                                            
                       ln N 0 , Cs ([0, 1]dX ), k · k[0,1]dX    ≤ Q2 0−dX /s .

Moreover, because Y and [N1 , M1 ] are compact subsets of two Euclidean spaces, there exist Q3 ,
Q4 such that
                  N 0 , [N1 , M1 ]2 , |·| ≤ Q3 0−4 and N 0 , Y, |·| ≤ Q4 0−2 .
                                                                     
                                                                                           (27)

                                                     60
This yields
                                                                              
              ln N[·] , M0 , k · k2        ≤ (6 + Q2 ) max − ln(0 ), 0−dX /s + ln(Q3 Q4 ).
                                       
                                                                                                 (28)

Let denote element-by-element product and D  |α U10 (ω)| , α T1,n,ω0
                                                                       
                                                                          denote random pack-
ing numbers. By (A.1) in Andrews (1994, p.2284), we have
                                                                               
                           D  α U10 (ω) , α T1,n,ω
                                                0
                                                                   , M0 , k · k2
                                                    
                  sup                                 ≤ sup N
             ω∈Ω,n≥1, α∈Rn
                         +                              F ∈F0    2
                                                      ≤ sup N[·] , M0 , k · k2 ,
                                                                                 
                                                                                         (29)
                                                                    F ∈F0

where the second inequality follows as in e.g., Van der Vaart and Wellner (1996, p.84). Then,
(28) ensures (see Definition 7.9 in Pollard (1990), p.38) that

                                     D  α U10 (ω) , α T1,n,ω 0
                                                                
                             sup                                  ≤ λ(),
                        ω∈Ω,n≥1, α∈Rn
                                    +

                                                                          
where λ() = exp (6 + Q2 ) max −2 ln (/(2Q)) , (/(2Q))−2dX /s + ln(Q3 Q4 ) . Moreover, by
     √         √     √
using a + b ≤ a + b for all a, b ≥ 0,
 Z 1p                       Z 1h                                     i1/2
                                 max −2 ln (/(2Q)) , (/(2Q))−2dX /s
                    p                                                           p
       ln(λ())d ≤ 6 + Q2                                                  d + ln(Q3 Q4 )
   0                              0
                   < ∞.
        0
Thus, T1,n,ω hence T1,n,ω are manageable. Therefore, m satisfies PS2 in AS.
Finally, in order to show that SIG1 in AS is satisfied, we use Assumption 5 (iii) and follow the
proof of Lemma 7.2 (b) in AS where we replace Y by q(Y, c(X)) and B by max(M, M0 ). The
result follows.

F.12    Proof of Proposition 6
We first prove that if E[ψL ] ≤ E[Y ] ≤ E[ψU ], there exists a unique F ∗ ∈ FB such that δF ∗ = 0.
                                0                                                           0
First, suppose that F b 6= F b and, without loss of generality, b > b0 . Then ψ b ≤ ψ b , implying
                   0
that F b (y) ≤ F b (y) for all y. Moreover, the inequality is strict for at least one y. As a result,
                0
E(ψ b ) > E(ψ b ). In other words, there is at most one F ∗ ∈ FB such that δF ∗ = 0. If E[ψL ] = E[Y ]
or E[ψU ] = E[Y ], such a solution also exists by taking b = −∞ and b = +∞, respectively. Now,
suppose that E[ψL ] < E[Y ] < E[ψU ]. For all +∞ > b > b0 > −∞,
                     0
            ψ b − ψ b = ψU − max(ψL , b0 ) 1l{ψU ∈ [b0 , b)} + (b − b0 )1l{ψL < b0 , ψU ≥ b}
                                            

                       + (b − ψL )1l{ψL ∈ [b0 , b), ψU ≥ b}.
                       0
As a result, |ψ b − ψ b | ≤ |b − b0 |. This implies that δe : b 7→ E[ψ b ] is continuous. Moreover,
limb→−∞ δ(b)
         e = E[ψL ] < E(Y ) and limb→+∞ δ(b)    e = E[ψU ] > E(Y ). By the intermediate value


                                                       61
theorem, there exists b∗ such that δ(b
                                   e ∗ ) = E(Y ). Hence, there exists F ∗ ∈ FB such that δF ∗ = 0.
The first part of Proposition 6 follows.
Let us turn to the second part of the proposition. First, if (ii) holds, there exists b0 ∈ R
such that F ∗ = F b0 . Then, by construction and Theorem 1, Y and ψ b0 satisfy H0 . Moreover,
F b0 ∈ [FψU , FψL ]. Therefore, H0B holds as well.
Now, let us prove that (i) implies (ii). Let us denote by D the set of all the cdfs for ψ such that
H0B holds. By Theorem 1, these are cdfs F satisfying FψU ≤ F ≤ FψL , δF = 0 and dominating
at the second order FY . We show below that all F ∈ D are dominated at the second order by
F ∗ . Then, because FψU ≤ F ∗ ≤ FψL and ydF ∗ (y) = ydFY (y), D is not empty only if F ∗
                                             R            R

dominates at the second order FY . The result then follows by Theorem 1.
Thus, we have to show that for all t ∈ R,
                                                                   Z   t
                                         F ∗ = argminFψ ∈D                     Fψ (y)dy.                                       (30)
                                                                   −∞

First, if F ∗ = F −∞ , we have for all F 6= F ∗ , F (y) ≤ FψL (y) = F ∗ (y) for all y, with strict
inequality for some y. Then δF > δF ∗ = 0 and D = {F ∗ }, implying that (30) holds. Similarly,
(30) holds if F ∗ = F +∞ .
Suppose now that F ∗ = F b0 for some b0 ∈ R. Because FψU (y) ≤ Fψ (y) for all y < b0 and
all Fψ ∈ D, (30) holds for all t < b0 . We now prove that (30) holds also for t ≥ b0 . First
                                               R            R
suppose that t ≥ max(b0 , 0). For all Fψ ∈ D, ydFY (y) = ydFψ (y)dy. As a result, by Fubini’s
theorem,
                   Z 0               Z t                  Z ∞
                           ∗                    ∗
                 −       F (y)dy +       (1 − F (y)) dy +     (1 − F ∗ (y)) dy
                      −∞                      0                                  t
                        Z   0                     Z   t                              Z       ∞
                   =−           Fψ (y)dy +                (1 − Fψ (y)) dy +                      (1 − Fψ (y)) dy.
                        −∞                        0                                      t

Because Fψ ≤ FψL = F ∗ on [b0 , +∞], this implies that
           Z 0            Z t                      Z 0            Z t
                 ∗                    ∗
         −     F (y)dy +        (1 − F (y)) dy ≥ −     Fψ (y)dy +     (1 − Fψ (y)) dy
              −∞                     0                                 −∞                               0

and thus (30) holds for t ≥ max(b0 , 0). Now, if b0 < 0 and t ∈ (b0 , 0), we have
                     Z t               Z 0           Z ∞
                             ∗                ∗
                  −         F (y)dy +       F (y)dy +        (1 − F ∗ (y)) dy
                        −∞               t                0
                        Z t               Z 0          Z ∞
                  =−          Fψ (y)dy +       Fψ (y)dy +       (1 − Fψ (y)) dy.
                                −∞                        t                          0

Using again Fψ ≤ FψL =      F∗on [t, +∞) yields
            Z 0             Z ∞                      Z                     0                       Z    ∞
         −      F ∗ (y)dy +     (1 − F ∗ (y)) dy ≤ −                           Fψ (y)dy +                   (1 − Fψ (y)) dy.
              t                  0                                     t                            0
Therefore, the result also follows in this case.

                                                              62
