                                NBER WORKING PAPER SERIES




  NONPARAMETRIC IDENTIFICATION OF DIFFERENTIATED PRODUCTS DEMAND
                         USING MICRO DATA

                                           Steven T. Berry
                                           Philip A. Haile

                                        Working Paper 27704
                                http://www.nber.org/papers/w27704


                      NATIONAL BUREAU OF ECONOMIC RESEARCH
                               1050 Massachusetts Avenue
                                 Cambridge, MA 02138
                                     August 2020




Early versions of this work were presented in the working paper "Nonparametric Identification of
Multinomial Choice Demand Models with Heterogeneous Consumers," first circulated in 2007 and
superseded by the present paper. We thank Suk Joon Son and numerous seminar participants for helpful
comments. Jaewon Lee provided capable research assistance. The views expressed herein are those
of the authors and do not necessarily reflect the views of the National Bureau of Economic Research.

NBER working papers are circulated for discussion and comment purposes. They have not been peer-
reviewed or been subject to the review by the NBER Board of Directors that accompanies official
NBER publications.

© 2020 by Steven T. Berry and Philip A. Haile. All rights reserved. Short sections of text, not to exceed
two paragraphs, may be quoted without explicit permission provided that full credit, including © notice,
is given to the source.
Nonparametric Identification of Differentiated Products Demand Using Micro Data
Steven T. Berry and Philip A. Haile
NBER Working Paper No. 27704
August 2020
JEL No. C14,C26,C3,D12,L0

                                            ABSTRACT

A recent literature considers the identification of heterogeneous demand and supply models via
"quasi-experimental'' variation, as from instrumental variables. In this paper we establish
nonparametric identification of differentiated products demand when one has "micro data'' linking
characteristics of individual consumers to their choices. Micro data provide a panel structure
allowing one to exploit variation across consumers within each market, where latent demand
shocks are fixed. This facilitates richer demand specifications while substantially softening the
reliance on instrumental variables, reducing both the number and types of instruments required.
Our results require neither the structure of a "special regressor'' nor a "full support'' assumption on
consumer-level observables.


Steven T. Berry
Department of Economics
Yale University
Box 208264
37 Hillhouse Avenue
New Haven, CT 06520-8264
and NBER
steven.berry@yale.edu

Philip A. Haile
Department of Economics
Yale University
37 Hillhouse Avenue
P.O. Box 208264
New Haven, CT 06520
and NBER
philip.haile@yale.edu
1    Introduction
Empirical models of differentiated products demand are an important part of
the applied econometrics toolkit, underlying influential empirical work in many
fields of economics. Indeed, quantifying counterfactual demand responses is
essential for answering positive and normative questions in almost any market
setting, and most markets involve differentiated products. Although practi-
cal considerations typically dictate reliance on parsimonious functional forms
for estimation of demand, an important question concerns the nonparamet-
ric foundation for demand estimation. Researchers focused on program eval-
uation have declared a "credibility revolution," as in Angrist and Pischke
(2010), reflecting redoubled attention to identification obtained through quasi-
experimental variation such as that arising from instrumental variables, geo-
graphic boundaries, or repeated observations within a single economic unit.
A critical question is whether these same types of variation identify counter-
factuals in the more complex but ubiquitous context of market demand and
supply with richly heterogeneous consumers and firms.
    The answer turns out to be yes. In Berry and Haile (2014), we demon-
strated identification of demand and supply in the case of "market level" data.
In this paper we consider the identification of nonparametric differentiated
products demand models, focusing on the case in which one has access to
"micro data" matching attributes of individual consumers to their purchase
decisions. We show that the availability of micro data not only allows a more
richly specified model, but also can substantially relax the both the number
and types of instrumental variables relied upon for identification.
    Many empirical applications offer micro data. A classic example is Mc-
Fadden's study of transportation demand (McFadden, Talvitie and Associates
(1977)), where each consumer's preferences over different modes of transport
are affected by the distance from her location to each mode. This exam-
ple illustrates the defining characteristic of the type of micro data considered
here: consumer-specific observables that alter the relative attractiveness of
different options. Consumers' distances to different options have been used
in a number of other applications as well, including those involving demand
for hospitals, retail outlets, residential locations, or schools, as in the exam-
ples of Capps, Dranove and Satterthwaite (2003), Burda, Harding and Haus-
man (2015), Bayer, Keohane and Timmins (2009), and Neilson (2019). More
broadly, observable consumer-level attributes that shift tastes for products
might include a household's income or other sociodemographic measures. For
example, income and family size have been modeled as shifting preferences for
cars (Goldberg (1995), Petrin (2002)); race, education, and birth state have
been modeled as shifting preferences for residential location (Diamond (2016)).


                                       1
Other examples of consumer-level observables include product-specific adver-
tising exposure (Ackerberg (2003)), consumer-newspaper ideological match
(Gentzkow and Shapiro (2010)), the match between household demographics
and those of a school or neighborhood (Bayer, Ferreira and McMillan (2007),
Hom (2018)), and the match between voter demographics and candidate char-
acteristics (Kawai, Toyama and Watanabe (2020)).1
    It is unsurprising that micro data can allow richer empirical specifications
of demand. Our main insight, however, is that such data can also substantially
reduce the reliance on instrumental variables for identification. A fundamental
challenge to identification of demand arises from the elementary observation
that the quantity demanded of any one good depends on all characteristics
of that good and all related goods (complements or substitutes). Such char-
acteristics include not only prices and other observables, but also unobserved
characteristics (more generally, the latent "demand shocks") associated with
all goods in the market. Likewise, the equilibrium price of each good typically
depends on the observed characteristics and demand shocks associated with
all related goods.2 Thus, in a market with J goods, prices and quantities
are determined in system of 2J fully simultaneous equations. Absent strong
functional form restrictions, identification cannot be obtained in such sys-
tems using strategies (e.g., control functions) familiar from triangular models.3
However, Berry and Haile (2014) showed that nonparametric identification of
demand can be established under standard instrumental variables (IV) condi-
tions, given instruments for all prices and quantities. The need to instrument
for quantities--indeed, to contemplate a system of equations for both supply
and demand to identify demand alone--may be surprising. But this need is
tightly connected to identification results for other simultaneous models, and is
easily recognized in the IV requirements of parametric demand models used in
practice.4 Intuitively, to measure any own- or cross-price elasticity one must
isolate the (counterfactual) change in quantity demanded that results from
shifting one price while holding fixed J - 1 other prices and J latent demand
shocks; 2J excluded instruments can provide the independent variation needed
to isolate this response. One important finding in Berry and Haile (2014) is

   1
   Here we cite only a small representative handful of papers out of a selection that spans
many topics and many years. See also the examples in section 3.
   2
    We emphasize prices as the leading case of endogenous product characteristics. Our
results generalize directly to cases with additional endogenous product characteristics, al-
though additional instruments will be required.
   3
    See Blundell and Matzkin (2014) and the discussion in Blundell, Kristensen and Matzkin
(2013, 2014), Matzkin (2015), and Berry and Haile (2016, 2018).
   4
    See, e.g., Matzkin (2015) and Berry and Haile (2014, 2018), and the discussion of nested-
and mixed-logit models in Berry (1994) and Berry and Haile (2016).


                                             2
the essential role of competing goods' exogenous characteristics--sometimes
called "BLP instruments"--in providing instruments for quantities.
    In this paper, we develop conditions under which the availability of micro
data cuts the number of required instruments in half. In particular, variation
in micro data can eliminate the need to instrument for quantities and, there-
fore, the necessary reliance on BLP instruments. The use of micro data also
makes it possible to specify a more flexible demand model and can make new
kinds of instruments available. The reduction in IV requirements is obtained
because micro data provide a form of observable variation in the choice prob-
lems faced by different consumers in the same market. This creates a panel
structure, where one can exploit both within-market and between-market vari-
ation. Critically, within a single market the latent market-level demand shocks
are fixed; thus, the observed responses to variation in choice problems within
a given market cannot be confounded by variation in these shocks. Of course,
prices are also typically fixed within a market. But "clean" within-market
variation can make it possible to pin down the latent demand shocks by in-
strumenting only for prices in the cross-section of markets. Once the latent
demand shocks are known, identification of demand becomes trivial.
    Our model of demand is nonparametric and, although we focus on discrete
choice, our results generalize to continuous demand systems with representa-
tions satisfying the "connected substitutes" condition of Berry, Gandhi and
Haile (2013) or other conditions ensuring "invertibility" of demand. We al-
low all consumer attributes to shift preferences for all products, avoiding any
a priori exclusivity assumptions on these observables.5 However, in addition
to standard IV conditions, our results rely on three important assumptions.
First, we require a nonparametric index restriction--formally a weak sepa-
rability assumption--on the way the market-level demand shocks and some
observed consumer attributes enter the model.6 Second, we require injectivity
of the mappings that link observed consumer attributes to choice probabilities.
    Finally, we require sufficient variation in the consumer observables to sat-
isfy a "common choice probability" condition that we believe is new to the
literature. Given a set of available products, this condition requires that there
be some point s in the probability simplex such that in every market one can
   5
    This contrasts with the frequent reliance on exclusion restrictions in the nonparametric
simultaneous equations literature, as in Matzkin (2015) and Berry and Haile (2018).
    6
      Despite some superficial similarity, both the form and role of this index restriction
differ from those in our earlier work (Berry and Haile (2014, 2018)). In each case the index
restriction helps to deal with the issue of a large vector of unobservables that nonlinearly
affect the demand for each product. But the indices in this paper are tied to consumer
attributes rather than product characteristics, and this index structure is employed in a
different way to obtain identification.


                                             3
obtain s as the conditional choice probability vector by conditioning on the
"right" set of consumer observables for that market. Implicit in this condition
is a requirement that the number of observed consumer attributes be at least
as large as the number of products. However, our assumption contrasts with a
standard "full support" condition, which would imply that every every point s
within the simplex is a common choice probability. Our condition allows for a
broad range of cases where choice probabilities are never close to one or zero.
It is also verifiable.
     Our insights build on strategies used in the parametric applied literature
by, e.g., Berry, Levinsohn and Pakes (2004) and Bayer, Ferreira and McMillan
(2007), who pointed out the potential for certain types of panel data to pin
down "substitution patterns" without instruments beyond those for prices.
We also connect to a substantial econometrics literature on the use of micro
data to identify discrete choice models. Indeed, the traditional individual-level
discrete choice literature exploits micro data almost by definition. However,
our approach generalizes earlier work in several directions. As in the large
empirical literature building on Berry (1994) and Berry, Levinsohn and Pakes
(1995), we emphasize the role of latent market-level demand shocks that result
in the econometric endogeneity of prices. Fully accounting for the effects of
these shocks is essential to the identification of policy-relevant demand elastic-
ities. This drives our focus on market-level endogeneity, which differentiates
our work from much of the classic work on identification of discrete choice
models. In addition, many existing nonparametric and semiparametric iden-
tification results for discrete choice models require an observable attribute for
each choice with at least some features of a "special regressor."7 Such vari-
ables are typically specified as entering conditional indirect utilities linearly,
with each such attribute restricted to affect the utility of only one choice.
These functional form and exclusion restrictions are then typically combined
with a "full support" assumption. We relax the functional form restrictions
of this approach, avoid the full support assumption, and drop the exclusion
restrictions.
     Although we focus on demand for differentiated products, our results also
apply to other choice settings. One example is a discrete choice model of
voting in a two-party election (e.g., Gordon and Hartmann (2013)) applied
to data matching individual votes to voter demographics, along with data on
candidate characteristics and market-level (e.g., metro area level) variation in
campaign advertising. Here, market-level unobservables capture the effects of
unmeasured candidate characteristics and local political preferences. Although
there are no prices, advertising plays the role of the endogenous choice char-
  7
    See the review by Lewbel (2014) and references therein. Our earlier work, Berry and
Haile (2010), featured an example of this sort.


                                          4
acteristic.8 Observed demographic characteristics, say education and income,
create variation in voter preferences for the two candidates within a given mar-
ket. If we treat the discrete choices as D, R and "Not Voting," our common
choice probability condition requires existence of a vote share (choice proba-
bility) vector--say 0.4 for D and 0.4 for R--such that in each market there is
a combination of education and income that generates that conditional vote
share. The level of education required to match the given vote share might be
higher (and income lower) in a conservative as opposed to a liberal area. Note
that there is no exclusion restriction here: a voter's utility from voting for a
given candidate can be affected by both of her demographic measures.
    Throughout the paper, we maintain an exclusive focus on identification.9
Nonparametric identification results do not eliminate concerns about the im-
pact of parametric assumptions relied on in practice. But they address the im-
portant question of whether such assumptions can be viewed properly as finite-
sample approximations rather than essential maintained hypotheses. Formal
identification results can also clarify which maintained assumptions may be
most difficult to relax, can reveal the essential sources of exogenous variation
in the data, can offer assurance that robustness analysis is possible, and can
lead to new (parametric or nonparametric) estimation approaches.
    In what follows, section 2 sets up the model we consider. Section 3 con-
nects the model to parametric examples from the empirical literature. Section
4 then establishes identification in two steps, reflecting the panel structure of
the micro data setting. We first demonstrate identification of the index func-
tion using within-market variation in consumer attributes and consumer choice
probabilities. Intuitively, up to normalizations, the variation in within-market
behavior reveals the effects of consumer attributes on choices. It also re-
veals the vector of consumer characteristics for each market that generates the
common choice probability. Plugging this vector into the index function, we
obtain for each product and market an index that is a nonparametric function
of observable product characteristics (including prices) and a single additively
separable demand shock. These nonparametric functions are then identified
following standard results for nonparametric IV regression, with prices as the
only endogenous variables. Identification of these functions reveals the values
of the demand shocks, and identification of demand follows directly. We con-
clude in section 5 with a discussion implications and extensions, including the
case of continuous demand.
   8
     See, e.g., Gerber (1998) and Gordon and Hartmann (2013). Instruments from the
literature include candidate wealth, market-specific measures of advertising cost, and com-
binations of statewide characteristic and features of the electoral college system.
   9
     We also focus exclusively on demand. With demand identified, identification (and fal-
sifiability) of standard models of supply follows results in Berry and Haile (2014).


                                            5
2      Multinomial Choice Model
2.1     Setup
We consider multinomial choice among J goods (or "products") and an outside
option ("good 0") by consumers i in "markets" t. A market is defined formally
by:10

    · a set Xt of exogenous observables common to all consumers;11

    · a price vector (or other endogenous characteristics common to all con-
      sumers), Pt = (P1t , . . . , PJt );

    · a vector t = (1t , . . . , Jt ) of unobservables common to all consumers;12

    · a distribution FY Z (·; t) of consumer observables (Yit , Zit )  RH × RJ ,
      H  0, with support  (Xt );

     Although Xt will typically include observable product characteristics, it
may also include any number of factors defining markets. For example, the
population of consumers may be partitioned into "markets" based on a com-
bination of geography, time, product availability, and average demographics
included in Xt . In contrast, observables varying across consumers within a
market are represented by Yit and Zit . We make a distinction between Yit and
Zit in order to isolate our requirements on consumer-level data. Key condi-
tions, made precise below, are that consumer observables have dimension of at
least J (hence, Zit  RJ ) and that changes in Zit alter the relative attractive-
ness of different goods. We do not require the additional consumer observables
Yit ; however, we can accommodate them in an unrestricted way, and condition-
ing on an appropriate value of Yit can weaken some assumptions. Although our
requirements on Zit will permit the case in which each of its components Zijt

  10
    More generally, the definition of a market could also include the number of goods avail-
able, Jt . We condition on a fixed number of products J without loss.
  11
     Although we describe Xt as exogenous and this is the standard assumption in the lit-
erature, we will not formally require this. The assumptions and results below are stated
conditional on Xt , and identification of demand conditional on Xt suffices for many purposes
(e.g., identification of own- and cross-price elasticities) regardless of any dependence between
Xt and t . We caution, however, that excluded variables that are valid instruments condi-
tional on exogenous variables are often not valid conditional on endogenous variables. And
identification of counterfactual quantities involving changes in Xt would typically require
either exogeneity of Xt or additional instruments.
  12
    For clarity we write random variables in uppercase and their realizations lowercase. Note
that  is the uppercase form of the standard notation  for product×market unobservables.


                                               6
is a consumer-specific factor assumed to alter only the attractiveness of good
j , we will not require this. Nor do we require independence (full, conditional,
or mean independence) between (Yit , Zit ) and the demand shocks t .
     The choice environment of consumer i in market t is then represented by
                                  Cit = (Zit , Yit , Xt , Pt , t ) .
Let C denote the support of Cit . The most basic primitive characterizing
consumer behavior in this setting is a distribution of decision rules for each
cit  C .13 As usual, heterogeneity in decision rules (i.e., nondegeneracy of
the distribution) within a given choice environment may reflect latent prefer-
ence heterogeneity, stochastic elements of individual preferences, or stochastic
elements of choice (e.g., optimization error).
    The choice made by consumer i is represented by Qit = (Qi1t , . . . , QiJt ),
where Qijt denotes the quantity (here, 0 or 1) of good j purchased. A distribu-
tion of decision rules is characterized by the conditional cumulative distribu-
tion functions FQ (q |Cit ) = E [1 {Qit  q } |Cit ]. In the case of discrete choice,
this joint distribution can be represented without loss by the structural choice
probability functions
                       (Cit ) = (1 (Cit ), . . . , J (Cit )) = E [Qit |Cit ] .
Given the total measure of consumers in each choice environment, the mapping
 fully characterizes consumer demand. Thus, our goal is to demonstrate
identification of  on C .
   So far we have implicitly made two significant assumptions: (i) unobserv-
ables at the market level can be represented by a J -vector t ; (ii) conditional
on Xt , the support of (Yit , Zit ) is the same in all markets. The first is standard
but important. The second seems mild for many applications and can be re-
laxed at the cost of more cumbersome exposition.14 Our results will also rely
on the following key structure.
  13
     As is well known, under additional conditions a distribution of decision rules can be rep-
resented as the result of utility maximization. See, e.g., Mas-Colell, Whinston and Green
(1995), Block and Marschak (1960), Falmagne (1978), and McFadden (2005). We do not
require such conditions and will not consider a utility-based representation of choice behav-
ior. A related issue is identification of welfare effects. Standard results allow construction of
valid measures of aggregate welfare changes from a known demand system in the absence of
income effects. Bhattacharya (2018) provides results on identification of welfare effects for
counterfactuals of interest from the distribution of decision rules for discrete choice settings
when income effects are present. Bhattacharya (2018) suggests the use of control func-
tion methods for identification/estimation of demand. As noted in the introduction, such
methods are valid only under strong functional form restrictions, which are violated even in
standard parametric specifications.
  14
       For example, a sufficient condition for what follows is that conditional on Xt there exist


                                                  7
Assumption 1 (Index).  (Cit ) =  ( (Zit , Yit , Xt , t ) , Yit , Xt , Pt ), with
 (Zit , Yit , Xt , t )  RJ .

Assumption 2 (Invertible Demand).  (·, Yit , Xt , Pt ) is injective on the sup-
port of  (Zit , Yit , Xt , t )|(Yit , Xt , Pt ).

Assumption 3 (Injective Index).  (·, Yit , Xt , t ) is injective on the support
of Zit |(Yit , Xt ).

     Assumption 1 requires that, given (Yit , Xt , Pt ), Zit and t affect choices
only through indices (1 (Zit , Yit , Xt , t ) , . . . , J (Zit , Yit , Xt , t )) that exclude
Pt . This is a type of weak separability assumption. Observe that Xt and Yit
can affect demand both directly (in fully flexible form) and through the indices.
As we illustrate below, this index structure generalizes standard specifications
used in practice. Assumption 2 further requires that the choice probabil-
ity function be "invertible" with respect to the index vector--that, holding
(Xt , Pt ) fixed, distinct index vectors map to distinct choice probabilities. This
is not without loss, and in general injectivity requires that  map to interior
values, i.e., that j (Cit ) > 0 for all j . Berry, Gandhi and Haile (2013) pro-
vide sufficient conditions for invertibility and point out that these are natural
in discrete choice settings when each j (Zit , Yit , Xt , t ) can be interpreted as
a (here, consumer-specific) quality index for good j . Assumption 3 requires
injectivity of the index function  with respect to the vector Zit . This gen-
eralizes common utility-based specifications in which each Zijt is assumed to
affect only the conditional indirect utility of good j and to do so monotoni-
cally. For example, if each index were a linear function of the J components
of Zit , Assumption 3 would require the matrix of coefficients to be full rank.
     We henceforth condition on an arbitrary value of Xt and suppress it in
the notation. The remaining assumptions and results should be interpreted
to hold conditional on Xt . As usual, this treats Xt fully flexibly, implicitly
applying the same identification argument at every value of Xt . We let Y then
denote the support of Yit and Z (y ) the support of Zit |{Yit = y }. We also focus
on the case in which the indices j (Zit , Yit , t ) are additively separable in t
(Assumption 4). In Assumption 5 we assume sufficient smoothness (as well as
openness of Z (y )) to permit our applications of calculus below.15 Part (iv) of

y 0 and an open connected set Z (y 0 ) such that the support of FY Z (·, ·; t) includes (y 0 , Z (y 0 ))
for all t. The results below then hold letting this "common support set" Z (y 0 ) replace the
fixed support Z appearing in section 4.
  15
     Although we state Assumption 5 with the quantifier "for all y  Y ," we require only
that these properties hold at the arbitrary point y 0 selected below. Observe that, given
parts (i) and (ii) of Assumption 5, the injectivity of g required by Assumption 3 implies (by
invariance of domain) that the image g (O, y ) of any open set O  Z (y ) is open.


                                                   8
Assumption 5 also strengthens the injectivity requirements of Assumptions 2
and 3 by requiring that the Jacobian matrices g (z, y )/z and  (, y, p)/
be nonsingular almost surely.16

Assumption 4 (Separable Index). j (Zit , Yit , t ) = gj (Zit , Yit ) + jt for all
j.

Assumption 5 (Regularity). For all y  Y , (i) Z (y ) is open and con-
nected; (ii) g (z, y ) is continuously differentiable with respect to z on Z (y );
(iii)  (, y, p) is continuously differentiable with respect to  for all (, p) 
supp ( (Zit , Yit , t ) , Pt ) |{Yit = y }; and (iv) g (z, y )/z and  (, y, p)/
are nonsingular almost surely on Z (y ) and supp ( (Zit , Yit , t ), Pt )|{Yit = y },
respectively.

2.2      Normalization
The model requires two types of normalizations for the identification ques-
tion to be properly posed.17 The first requirement reflects the fact that the
unobservables have no natural location; therefore, adding a constant vector
to t and subtracting the same vector from g yields the same distribution
of consumer choice at every (zit , yit , t , pt ). Thus, we take an arbitrary point
(y 0 , z 0 )   and set
                                g z 0 , y 0 = 0,                                (1)
where the right-hand side is the zero J -vector.
    The second normalization requirement arises from the fact that any in-
jective transformation of the index vector  (Zit , Yit , t ) can be reversed by a
modification of the function  . For example, let A be any J -vector of con-
stants, let B be any nonsingular J × J matrix, and define

                         ~ (Zit , Yit , t ) = A + B (Zit , Yit , t ) .                       (2)

If we then define ~ by

                                , Pt ) =  B -1 (~
                            ~ (~                 - A) , Pt ,                                 (3)

  16
     Even without part (iv) there could be no non-empty open set O  Z (y ) on which
g (z, y )/z was singular, as (see footnote 15) g (O, y ) would then be a nonempty open
subset of RJ , contradicting Sard's theorem. A similar observation applies to  (, y, p)/ .
Thus, part (iv) rules out injective continuously differentiable functions g (·, y ) or  (·, y, p)
with (uncountably many) critical points forming a set  containing no non-empty open
subset of RJ but having positive measure nonetheless--e.g., for J = 1, a fat Cantor set.
  17
    We emphasize that, like the choice of location and scale for utility functions, our nor-
malizations place no restriction on demand.


                                               9
then (,  ) and (~  ,    ~ ) are two representations of the same distribution of de-
cision rules, the latter satisfying our assumptions whenever the former does.18
We must choose a single representation before exploring whether the observ-
ables allow identification. We do this by taking the representation in which
the index  (z 0 , y 0 , t ) = g (z 0 , y 0 ) + t has expectation zero, i.e.,

                                         E [t ] = 0,

and is such that
                                      g (z 0 , y 0 )
                                                     = I.                                  (4)
                                         z
For example, this representation is obtained from (2) and (3) by letting
                                                         -1
                                 B = g (z 0 , y 0 )/z         ,
                                 A = -B E [t ] ,

and then dropping the tildes from the notation for the transformed model.
Note that this normalization does not specify the value of g (z, y )/z at any
point other than (z 0 , y 0 ).


3      Parametric Examples from the Literature
The empirical literature in economics includes many examples of parametric
specifications that are special cases of our model. Discrete choice demand
models are frequently formulated using a random utility specification of the
form
                       uijt = xjt it - it pjt + jt + ijt ,               (5)
where uijt represents individual i's conditional indirect utility from choice j
in market t. As in our model, xjt , pjt and jt are, respectively, observed
product/market characteristics, prices, and latent demand shocks such as un-
observed product characteristics.
   The additive ijt is typically specified as a draw from a type-1 extreme
value distribution or a normal distribution, yielding a mixed multinomial logit
  18
    This illustrates an inherent ambiguity in the interpretation of how variation in a given
variable alters preferences. For example, in terms of consumer behavior, there is no difference
between a change in Zijt (all else fixed) that makes good j more desirable and a change in
Zijt that makes all other goods (including the outside good) less desirable. In practice, this
ambiguity is often resolved with a priori exclusion assumptions--e.g., an assumption that
Zijt affects only the utility obtained from good j (globally). Some of the examples discussed
below utilize this additional structure. Such assumptions could only aid identification, and
our choice of normalization remains valid under these restrictions.


                                              10
or probit model. Components k of the random coefficient vector it are often
specified as
                                                   L
                              (k)       (k )               (k, )        (k)       (k)
                              it    =   0      +           z     zi t +     it ,
                                                   =1

where each zi t represents an observable characteristic of individual i, and
        (k)
each it is a random variable with a pre-specified distribution. Often, the
coefficient on price is also specified as varying with some observed consumer
characteristics yit , such as income. A typical specification of it takes the form
                                                                            (0)
                                   ln(it ) = 0 + y yit +  it .

       We can then rewrite (5) as

                                    uijt = gj (zit , xt ) + jt + µijt ,                                   (6)

where
                                                                   L
                                                             (k)        (k, )
                                gj (zit , xt ) =            xjt         z     zi t
                                                       k           =1

and
                     (k)     (k)(k )       (k )                                             (0)
       µijt =       xjt     0 +      it            - pjt exp(0 + y yit +  it ) +                  ijt .   (7)
                k

Fixing xt now (and dropping it from the notation), observe that all effects of
zit and t operate though indices

                           j (zit , t ) = gj (zit ) + jt                j = 1, . . . , J,

satisfying our Assumptions 1 and 4. It is easy to show that the resulting choice
probabilities satisfy Berry, Gandhi and Haile's (2013) "connected substitutes"
condition with respect to the vector of indices (1 (zit , t ) , . . . , J (zit , t ));
therefore, the injectivity of demand required by Assumption 2 holds. Our
assumptions require L  J .19 Injectivity of g (zit ) = (g1 (zit ), . . . , gJ (zit )) (As-
sumption 3) might be assumed as a primitive condition of the model or else
derived from other conditions, as in the example we discuss below.
    Of course, our model does not rely on the linear structure of this example,
nor on any parametric distributional assumptions. But this example con-
nects our model to a large number of applications and shows one way that
  19
     If L > J , we can combine the "extra" components of Zit with income to redefine the
partition of consumer observables as (Yit , Zit ) with Zit  RJ . More generally, income and
any extra components of Zit may affect both the index (reintroducing Yit as an argument
of g ) and the coefficients on (Xt , Pt ).


                                                           11
the individual-level observables zit can interact with product characteristics
to generate preference heterogeneity across consumers facing the same choice
set (i.e., where all xjt , pjt and jt are fixed). Note that this standard specifi-
cation lacks features sometimes relied on in results showing identification of
discrete choice models: in addition to the absence of individual characteristics
that exclusively affect the utility from one choice j , this model does not ex-
hibit independence between the "error term" µijt and any of the observables
zijt , xt , pt .20
      To see another way that our index structure arises in practice, consider
Ho's (2009) model of demand for health insurance. Each consumer i in mar-
ket t considers J insurance plans as well as the outside option of remaining
uninsured. Each consumer has a vector of observable characteristics dit .21 Let
njt denote the set of hospitals in plan j 's network, along with their character-
istics (e.g. location and the availability of speciality services like cardiac care).
Each insurance plan is associated with its network njt , an annual premium
pjt , additional observed plan characteristics xjt (e.g., the size of its physician
network), and an unobservable jt .
      A consumer's insurance plan demand depends on her particular likelihood
of having of each type of hospital need (diagnosis), as well as how her prefer-
ences over hospital characteristics will vary with the type of need. This gives
each consumer i an expected utility EU (njt , dit ) for the option to use plan
j 's hospital network. Ho derives this expected utility from auxiliary data on
hospital choice,22 which yields, from the perspective of identification, a known
functional form for the consumer/choice measures

                                    zijt  EU (njt , dit ) .

Similar to (5), consumer i's conditional indirect utility for plan j then takes
the form23
                   uijt = zijt + xjt  - (yit )pjt + jt + ijt                (8)

  20
    The individual "taste shock" vectors it and it are typically assumed independent across
i and t; however, xjt and pjt enter the composite error µijt . The variables xjt and pjt are
also typically correlated and, in our framework, are allowed to be correlated with changes
in the distribution of zit across markets.
  21
   Ho's data include measures of individual age, gender, income, home location, employ-
ment status, and industry of employment.
  22
    See also Ho (2006). Here dit affects both diagnosis probabilities and preferences over
hospitals condition on diagnosis. Ho and Lee (2016) extend the model to treat insurance
choice at the household level, with households anticipating diagnosis probabilities for each
household member.
  23
       Ho (2009) uses excluded plan-level cost shifters as instruments for premiums.


                                              12
where yit  dit represents the consumer's income. Ho assumes each ijt is
an independent draw from a type-1 extreme value distribution, yielding a
multinomial logit model.
    Observe that in this example Ho combines data on the characteristics of
consumers and choices with additional modeling to derive a scalar zijt that
exclusively affects only the utility of choice j . In this case, the injectivity of
the index vector  (zit , t ), as required by our Assumption 3, holds under an
assumption that  = 0. Given this condition, Assumption 5 is also satisfied
as long as the support of Zit conditional on income is an open and connected
subset of RJ . Satisfaction of our remaining assumptions follows as in the
previous example.


4      Identification
We consider identification of the demand system
                                       (Zit , Yit , Pt , t )
from observation of the choice decisions of the population of consumers i in
a population of markets t. In addition to the suppressed Xt , the observables
consist of Pt , Zit , Yit , Qit , and a vector of instruments Wt discussed further
below. Our broad strategy is to demonstrate identification of the realized
demand shocks t = (1t , . . . , Jt ) in all markets t. Once these demand shocks
are known, identification of demand follows immediately from the equations
 j (zit , yit , pt , t ) = E [Qijt |Zit = zit , Yit = yit , Pt = pt , t = t ]   j = 1, . . . , J.
     We demonstrate identification of the demand shocks through four lemmas,
developed in sections 4.1 and 4.2. Because our results do not require variation
Yit , in most of what follows we simplify notation by fixing Yit at the arbitrary
value y 0 and dropping Yit from the notation. All remaining assumptions are
to be interpreted to hold conditional on Yit = y 0 .24 We reintroduce Yit only
when stating our main result in section 4.3.
     To document a key observation for what follows, for (, p)  supp (t , Pt )
let
                            S (, p) =  (g (Z ) + , p) .                       (9)
Thus, S (, p) denotes the support of choice probabilities in markets t for which
t =  and Pt = p.25 Observe that, by Assumptions 2 and 3, for each s 
  24
     We emphasize that, unlike our conditioning on Xt , identification of demand will not
implicitly require repeating the argument at other values of Yit .
  25
    Because Z is open, continuity and injectivity of  with respect to the index and of the
index with respect to Zit imply (by invariance of domain) that S (, p) is open.


                                               13
S (, p) there must be a unique z   Z such that  (g (z  ) + , p) = s. So
for (, p)  supp (t , Pt ) and s  S (, p), we define the function z  (s; , p)
implicitly by
                          (g (z  (s; , p)) + , p) = s.                  (10)
By the invertibility of  (Assumption 2), we then have

                          g (z  (s; , p)) +  =  -1 (s; p)                        (11)

for all (, p)  supp (t , Pt ) and s  S (, p). Note that in each market t, the
set S (t , pt ) and the values of z  (s; t , pt ) for all s  S (t , pt ) are observed,
even though the value of the argument t is unknown.

4.1    Identification of the Index Function
Let || · || denote the Euclidean norm and let B (b, ) denote an open ball in
RJ of radius  > 0, centered at b. We demonstrate identification of the index
function g = (g1 , . . . , gJ ) under the following condition.

Assumption 6 (Nondegeneracy). For some  > 0 and some p  supp Pt ,
supp t |{Pt = p} contains an open ball of radius .

    Assumption 6 requires continuously distributed t but is otherwise mild.
It can be derived as an implication of standard models of supply in which cost
shifters (which need not be observed) allow the same equilibrium price vector p
to arise under different demand conditions (different t ). The key implication,
exploited in the following result, is that there exist p  supp Pt and  > 0
such that for any d  RJ satisfying ||d|| < , supp t |{Pt = p} contains points
 and  satisfying  -  = d.

Lemma 1. Let Assumptions 1­6 hold and take (p, ) as defined by Assump-
tion 6. Then for every z and z in Z such that ||g (z ) - g (z )|| <  there exist
a choice probability vector s and values of  and  in supp t |{Pt = p} such
that z = z  (s; , p) and z = z  (s;  , p).

Proof. Take any z and z in Z such that ||g (z ) - g (z )|| < . By Assumption
6 and the choice of (p, ), there exist  and  in supp t |{Pt = p} such that
 -  = g (z ) - g (z ) , i.e.,  (z ,  ) =  (z,  ). Taking s =  ( (z ,  ), p) =
 ( (z,  ), p), the result follows from the definition (10).
    With this result in hand, we can use equation (11) to relate the derivatives
of g at any point z to those at nearby points z by examining the change in
consumer characteristics required to create a given change in the vector of
choice probabilities.

                                         14
Lemma 2. Let Assumptions 1­6 hold. Then there exists  > 0 such that for
                                                                               -1
                                                                      g (z )        g (z )
almost all z, z  Z satisfying ||g (z ) - g (z )|| <  the matrix       z             z
is identified.
Proof. Take p and  as in Assumption 6. Consider markets t and t in which
Pt = Pt = p but, for some choice probability vector s,

                       z = z  (s; t , p) = z = z  (s; t , p) ,                        (12)

revealing that t = t . Lemma 1 ensures that such t, t , and s exist for all
z, z  Z satisfying ||g (z ) - g (z )|| < . And although t and t are latent,
the identities of markets t and t satisfying (12) are observed. Differentiating
(11) with respect to the vector s within these two markets, we obtain

                        g (z ) z  (s; t , p)    -1 (s; p)
                                             =                                        (13)
                        z          s             s
and
                     g (z ) z  (s; t , p)    -1 (s; p)
                                          =            .
                      z          s              s
Thus, recalling Assumption 5, for almost all such z, z we have
                       -1                                            -1
              g (z )        g (z )   z  (s; t , p) z  (s; t , p)
                                   =                                      .
               z            z            s             s
The matrices on the right-hand side are observed.

   This leads us to the main result of this section, obtained by connecting
                                 -1
                        g (z )        g (z )
the matrix products     z             z
                                                  identified in Lemma 2 to the known
                                         g (z )
(normalized) value of the matrix         z
                                                    at z = z 0 .

Lemma 3. Under Assumptions 1­6, g is identified on Z .
Proof. Take  > 0 as in Lemma 2. For each vector of integers   ZJ , define
the set
                 B = g (Z )  B g z 0 +  /2, /2 ,
and let I denote the pre-image of B under g . By construction, all z and z
in any given set I satisfy ||g (z ) - g (z )|| < . So by Lemma 2,

                             [g (z )/z ]-1 [g (z )/z ]

is known for almost all z and z in any set I . Because  ZJ B forms an
open cover of g (Z ),  ZJ I forms an open cover of Z . Thus, given any

                                               15
z  Z there exists a simple chain of open sets I in Z linking the point z 0
                            -1
to z .26 Thus, [g (z 0 )/z ] [g (z )/z ] is known for almost all z  Z . With
the normalization (4) and the continuity of g (z )/z , the result then follows
from the fundamental theorem of calculus for line integrals and the boundary
condition (1).

     Before moving to identification of the demand shocks, we pause to point
out that our constructive identification of g (·) used only a single price vector
p--that required by Assumption 6. In typical models of supply this condition
would hold for almost all price vectors in the support of Pt . In addition
to providing falsifiable restrictions, this indicates a form of redundancy that
would typically be exploited by estimators used in practice. Similarly, our
proof of Lemma 3 used, for each z  Z , only one of infinitely many paths
between z 0 and z ; integrating along any such path must yield the same function
g (·).27

4.2        Identification of the Demand Shocks
We demonstrate identification of the demand shocks under the following ad-
ditional conditions.

Assumption 7 (Common Choice Probability). There exists a choice proba-
bility vector s such that s  S (, p) for all (, p)  supp (t , Pt ).

Assumption 8 (Instruments for Prices). (i) For all j = 1, . . . , J , E [jt |Wt ] =
0 almost surely; (ii) In the class of functions  (Pt ) with finite expectation,
E [ (Pt ) |Wt ] = 0 almost surely implies  (Pt ) = 0 almost surely.

    Assumption 7 requires that there exist some choice probability vector s
that is common to all markets--that (,p)supp (t ,Pt ) S (, p) be nonempty. The
nondegeneracy of each set S (t , pt ) (recall (9)) reflects variation in Zit across
its support. Assumption 7 requires sufficient variation in Zit that for some s
we have s  S (t , pt ) for all (t , pt ). The strength of this assumption depends
on the joint support of (t , Pt ) and the relative impacts of (Zit , t , Pt ) on choice
behavior. Observe that Pjt and jt typically will have opposing impacts and
will be positively correlated under equilibrium pricing behavior; thus, large
support for g (Zit ) may not be required even if t were to have large support.
Indeed, we can contrast our assumption of a single common choice probability
vector with a requirement of a special regressor with large support: the latter
  26
       See, e.g., van Mill (2002, Lemma 1.5.21).
  27
     Alternatively, the need for identification of the derivatives of g along only one such path
illustrates further potential for softening of our requirements on the support of Zit .


                                               16
would imply that every interior choice probability vector s is a common choice
probability.28 Note also that, because choice probabilities conditional on Zit
are observable in all markets (i.e., for all realizations of (t , Pt )), Assumption 7
is verifiable--i.e., its satisfaction or failure is identified.29 Thus, because the
choice of y 0 is arbitrary, we require only existence of one such y 0  Y such
that Assumption 7 holds.30 Finally, note that the value of any common choice
probability vector s may be treated as known.
    Assumption 8 requires instruments for prices satisfying standard nonpara-
metric IV conditions. Part (i) is the exclusion restriction, ensuring that vari-
ation in Wt not alter the mean of the unobservables t . Part (ii) is a stan-
dard completeness condition--the nonparametric analog of the classic rank
condition for linear regression. For example, Newey and Powell (2003) have
shown that under mean independence, completeness is necessary and sufficient
for identification in separable nonparametric regression. The following result
demonstrates that, given knowledge of the index function g and existence of a
common choice probability vector s , the same instrumental variables condi-
tions suffice here to allow identification of the demand shocks.

Lemma 4. Under Assumptions 1­8, jt is identified for all j and t.

Proof. Taking s = s in equation (11) we have

                             g (z  (s ; t , pt )) =  -1 (s ; pt ) - t

for all t; i.e., for all t and each j = 1, . . . , J ,
                                                    -1
                            gj (z  (s ; t , pt )) = j  (s ; pt ) - jt .               (14)

By Lemma 3 the left side of (14) is known (recall that the values of each
z  (s ; t , pt ) are observable, even though the value of each t is not). Thus, for
each j this equation takes the form of a separable nonparametric regression
                                            -1
model. Identification of each function j       (s ; ·) follows immediately from the
identification result of Newey and Powell (2003). This implies identification
of each jt as well.


  28
    Identification arguments exploiting special regressors also commonly rely on linearity,
exclusion, and independence conditions that we have not required.
  29
       See Berry and Haile (2018) for a formal definition of verifiability.
  30
    When more than one such value y 0 exists, or when there is more than one common
choice probability vector s , this introduces additional falsifiable restrictions.




                                                17
4.3    Identification of Demand
We now drop the conditioning on Yit = y 0 in each market. With the identifica-
tion of the demand shocks guaranteed by Lemma 4, identification of demand
follows immediately from the definition

              j (Cit ) = j (Zit , Yit , t , Pt ) = E [Qijt |Zit , Yit , t , Pt ] ,

since the realizations of Qijt and all conditioning variables are known. Thus,
we have our main result.

Theorem. Under Assumptions 1­8,  is identified on C .


5     Discussion
Although our identification proof required several steps, in hindsight the logic
is straightforward. Within-market variation directly reveals how choice proba-
bilities respond to variation in the consumer-level measures Zit , holding all else
fixed. With the index structure, this variation also pins down how choice prob-
abilities respond (all else fixed) to variation in the vector of demand shocks
t . The latter can be of direct interest as a feature of the demand system
 (Zit , Yit , Xt , Pt , t ); but it also provides a way to hold the effects of the de-
mand shocks fixed when examining how choice probabilities respond to the
cross-market price variation associated with market-level instrumental vari-
ables. More precisely--following the second half of our proof more closely--it
allows us to infer the demand shocks by observing the vectors of consumer
measures Zit required to match the common choice probability vector s in
each market, while controlling for the variation in prices with instruments. As
we've noted already, once demand shocks are known, identification of demand
is trivial.
    Thus, our results yield two primary messages. First, identification of
demand for differentiated products follows using the same sorts of quasi-
experimental variation relied upon in simpler settings. Indeed, the exploitation
of within-unit variation and instrumental variables is arguably the bread and
butter of empirical economics. Given the relevance of demand (and choice
more generally) to a broad range of economic questions, it should be encour-
aging that these standard types of variation suffice to allow identification here.
Second, the availability of micro data not only permits demand specifications
that condition on consumer-level observables, but also can substantially re-
duce the reliance on instrumental variables to address the key challenge to
identification of demand: the presence of unobserved product characteristics
or other latent demand shocks that affect the prices and quantities of all goods

                                              18
in the demand system. The softening of instrumental variables requirements
is achieved because consumer-level observables create within-market variation
in consumers' choice problems. Such variation is similar in some ways to that
which can be generated by instruments for quantities; however, the exogene-
ity of the micro-data variation arises not from an exclusion restriction in the
cross-section of markets but from the fact that within a single market the
market-level demand shocks simply do not vary. Thus, our insights also have
some connection to those underlying "within estimation" of slope parameters
in panel data models with fixed effects.
    Our results do lead to several natural questions, which we discuss in the
remainder of this concluding section. For notational simplicity we suppress
the variables Yit in what follows.

5.1        What Are Appropriate Instruments?
The fact that reliance on instruments is standard does not imply that instru-
ments will always be available. Rather, this merely shifts discussion of iden-
tification largely to standard questions concerning the availability of suitable
instruments. What are likely instruments in practice?
     Candidate instruments for prices include most of those typically relied upon
in the case of market-level data (see, e.g., Berry and Haile (2016) for a more
complete discussion). Classic instruments for prices are cost shifters that are
excluded from the demand system and (mean-) independent of the demand
shocks t . When cost shifters are not observed, proxies for cost shifters may
be available and can satisfy the required mean independence.31 Exogenous
shifters of market structure (e.g., firm ownership) that affect prices through
equilibrium markups can also serve as instruments. Micro data can also result
in availability of a related category of candidate instruments: market-level de-
mographics such as the distribution of age, income, education, and ethnicity
that alter equilibrium markups. Berry and Haile (2014, 2016) refer to these
as "Waldfogel" instruments, after Waldfogel (2003).32 When micro-data are
available, we can directly account for the impacts of individual-specific demo-
graphics, so it may be reasonable to assume that market-level demographics are
excluded from the conditional demands we seek to identify. The requirement
that these market-level measures be mean independent of the market-level de-
mand shocks is a significant assumption, ruling out certain kinds of geographic
  31
   An example, plausibly exogenous in some applications, are so-called "Hausman instru-
ments": prices of the same good in other markets (e.g., Hausman, Leonard and Zona (1994),
Hausman (1996), or Nevo (2000, 2001)).
  32
       See also Gentzkow and Shapiro (2010) and Fan (2013).



                                            19
sorting or peer effects. But in many applications such an assumption may be
natural.

5.2     What About Stronger Functional Forms?
In practice, estimation is almost always influenced by functional form assump-
tions -- e.g., the choice of parametric structure, kernel functions, or sieve basis.
Such functional forms enable interpolation, extrapolation, and bridging of gaps
between the exogenous variation present in the sample and that needed for non-
parametric identification. A study of nonparametric identification can reveal
whether functional form assumptions play a more essential role in one precise
sense. One interpretation of our results is that only limited nonparametric
structure is essential: for our nonparametric model, the main requirement
for identification is adequate exogenous variation of dimension equal to the
dimension of the endogenous variables.
    But one can also ask how imposing additional structure on the demand
model might allow relaxation of our identification requirements. Answers to
this question may be of direct interest and can also suggest the sensitivity of
identification to particular conditions. For example, we may feel more comfort-
able when we know that relaxation of one condition for identification can be
offset by strengthening another. A full exploration of these potential trade-offs
describes an entire research agenda. But some examples can illustrate three
directions one might go to enlarge the set of potential instruments, further
reduce the number of required instruments, or reduce the required dimension-
ality of the micro data.

5.2.1    Strengthening the Index Structure
Our model made no assumption on the way the characteristics Xt enter de-
mand. For example, we have not assumed that there are certain elements
Xjt of Xt that in some sense only affect good j . With such a restriction,
however, another class of instruments--the exogenous characteristics of com-
peting goods (i.e., BLP instruments)--can become available.33 One way to
re-introduce the BLP instruments is to assume that for at least some compo-
        (1)
nent Xt of Xt , choice probabilities can be written as (now conditioning out
                          (1)
and suppressing only xt \xt )
                                     (1)
                              (zit , xt , t , pt ) =  (it , pt ),

  33
    The "relevance" of these instruments reflects the fact that in standard oligopoly models
each good's markup depends on the characteristics of related goods.



                                             20
with
                                                        (1)
                         ijt = gj (zjt ) + jt + hj xjt        .
                                                                         (1)
Here we have strengthened our index structure by including Xjt in the index
for good j and assuming that Zjt is also exclusive to the index for good j . Many
specifications in the empirical literature satisfy these additional restrictions.
    In this case, the IV regression equation (14) becomes

                                      -1                      (1)
                gj zj (s ; t , pt ) = j  (s , pt ) - hj xjt         - jt .

                  -1
Identification of j  (s , ·) and hj (·) then follows with instruments for Pt when
  (1)                                         (1)
Xjt is mean independent of jt . When X-jt is assumed mean independent of
      (1)
jt , X-jt are available as instruments for Pjt .

5.2.2   A Special Regressor
Following Berry and Haile (2010), a different approach is to assume that the
demand system of interest is generated by a random utility model with con-
ditional indirect utilities of the form

                            uijt = gj (zijt ) + jt + eijt ,

where eijt is a scalar random term whose nonparametric distribution depends
on xjt and pjt (equation (7) gives a parametric example). In this case, our
Lemma 3 demonstrates identification of each function gj (·) up to a units nor-
malization on the utility associated with product j .
    If one is willing to make the assumption of independence between Zijt
and Eijt , this turns gj (Zijt ) into a known special regressor. Under an addi-
tional (typically very restrictive) full support assumption on gj (Zj ), a stan-
dard argument demonstrates identification of the marginal distribution of
(jt + Eijt )|(Xjt , Pjt ) for all j, t. Berry and Haile (2010) show that one can use
this marginal distribution to define a nonparametric IV regression equation for
each choice j , where jt is the additive error term. In each equation the prices
and characteristics of goods k = j are excluded. Thus, in this framework one
needs only one instrument for price, and exogenous characteristics of compet-
ing goods (BLP instruments) are again available under the assumption that
  (1)
X-jt is mean independent of jt .

5.2.3   A Semiparametric Model
Another way to add structure is to consider semiparametric models. As one
example, consider a semiparametric nested logit model where inverse demand,

                                          21
given zt , is34

             gj (zt ) + jt = ln(sjt (zt )/s0t (zt )) -  ln(sj/g,t (zt )) + pjt .          (15)

Here sj/g,t (zt ) denotes the within-group share and  denotes the usual "nesting
parameter."
   Take any market t and any z  Z . Differentiating (15) with respect to one
(possibly, the only) element of zt --say z1t --at the point z yields

                  gj (z )    ln sjt (z )  ln s0t (z )    ln sj/gt (z )
                          =             -             -                .                  (16)
                  z1           z1           z1              z1
                    g (z )
                    j
In this equation, z   1
                        and  are the only unknowns. Moving to another market
t , we can obtain a second equation of the same form in which the left-hand
side is identical to that in (16). Equating the right-hand sides yields

 ln sjt (z )  ln s0t (z )  ln sj/gt (z )    ln sjt (z )  ln s0t (z )  ln sj/gt (z )
            -            -               =             -            -               .
   z1           z1            z1              z1           z1            z1
Thus, we can solve for  as long as

                                ln sj/gt (z )    ln sj/gt (z )
                                              =                ,
                                   z1               z1
a condition that will typically hold when t = t or pt = pt , and which is
directly observed. With  known, we then identify (indeed, over-identify) all
derivatives of gj (z ) from (16). Identification of the remaining parameter 
can then be obtained from (15) with a single excluded instrument--e.g., an
excluded exogenous market-level cost shifter or markup shifter that affects all
prices.
    Although this example involves a model that is more flexible than nested
logit models typically estimated in practice, it moves a considerable distance
from our fully nonparametric model. But this example makes clear that ad-
ditional structure can further reduce the dimension of the required exogenous
variation. Indeed, here we can obtain identification with a single instrument
(vs. the usual requirement of two instruments for the fully parametric nested

  34
   As before, we have conditioned on xt , permitting it to enter the model flexibly. For
example, conditional indirect utilities might take the form

                    uijt = h (xt , gj (zt , xt ) + jt -  (xt ) pjt + µijt (xt )) ,

where h is strictly increasing in its second argument,  (xt ) is arbitrary, and µijt (xt ) is a
stochastic component taking the standard composite nested-logit form at each xt .



                                                 22
logit (see Berry (1994))) and a scalar individual level observable zit . Other
semiparametric models may offer more intermediate points in the set of feasible
trade-offs between the flexibility of the model and the dimension of exogenous
variation needed for identification.

5.3     What about Continuous Demand Systems?
Although we have focused on the case in which the consumer-level quantities
Qijt are binary outcomes arising from a discrete choice model, there is nothing
in our proofs requiring this. Applying our results to continuous demand is
therefore just a matter of verifying the suitability of our assumptions.
    As an example, consider a "mixed CES" model of continuous choice, similar
to the model in Adao, Costinot and Donaldson (2017), with J + 1 products.
Each consumer i has utility over consumption vectors q  RJ     +
                                                                +1
                                                                   given by

                                                         J              1/
                                                                    
                         u (q ; zit , xt , pt , t ) =          ijt qj        ,
                                                        j =0


where   (0, 1) is a parameter and each ijt represents idiosyncratic prefer-
ences of consumer i for the product characteristics x. We set i0t = 1 and
let
           ijt = exp [(1 - ) (gj (zit ) + jt + xjt it )] , j = 1, . . . , J,
where it is a random vector with distribution F representing consumer-level
preferences for product characteristics. With p0t = 1 and consumer income of
yit , familiar CES algebra shows that Marshallian demands are
                            yit exp (gj (zit ) + jt + xjt it -  ln(pjt ))
           qijt =                                                                       ,      (17)
                              J
                    1+        k=1   exp (gk (zit ) + kt + xkt it -  ln(pkt ))

where  = 1/1 - . Equation (17) resembles a choice probability for a random
coefficients logit model, although the quantities qit here take on continuous
values and do not sum to one. Conditioning on yit (formally, using income
level as one factor defining markets), it is easy to show that our Assumptions
1­4 are satisfied for the expected CES demand functions, which take the form

                     t (g (zit ) + t , xt , pt ) = E [Qit |zit , xt , pt , t ] ,

where the j th component of E [Qit |zit , xt , pt , t ] is

                    yit exp (gj (zit ) + jt + xjt it -  ln(pjt ))
                                                                                   dF (it ).
                      J
            1+        k=1   exp (gk (zit ) + kt + xkt it -  ln(pkt ))

                                                 23
   Berry, Gandhi and Haile (2013) also describe a broad class of continuous
choice models that can satisfy the key injectivity property of Assumption 2.
These models can include mixed continuous/discrete settings, where individual
consumers may purchase zero or any positive quantity of each good.




                                     24
References
Ackerberg, Daniel, "Advertising Learning and Customer Choice in Expe-
 rience Good Markets: A Structural Empirical Examination," International
 Economic Review, 2003, 44 (3), 1007­1040.
Adao, Rodrigo, Arnaud Costinot, and Dave Donaldson, "Nonpara-
 metric Counterfactual Predictions in Neoclassical Models of International
 Trade," American Economic Review, March 2017, 107 (3), 633­89.
Angrist, Joshua D. and J¨   orn-Steffen Pischke, "The Credibility Revo-
 lution in Empirical Economics: How Better Research Design Is Taking the
 Con out of Econometrics," Journal of Economic Perspectives, June 2010, 24
 (2), 3­30.
Bayer, Patrick, Fernando Ferreira, and Robert McMillan, "A Uni-
 fied Framework for Measuring Preferences for Schools and Neighborhoods,"
 Journal of Political Economy, 2007, 115 (4), 588­638.
  , Nathaniel Keohane, and Christopher Timmins, "Migration and
  Hedonic valuation: The Case of Air Quality," Journal of Environmental
  Economics and Management, 2009, 58 (1), 1 ­ 14.
Berry, Steven, "Estimating Discrete Choice Models of Product Differentia-
 tion," RAND Journal of Economics, Summer 1994, 23 (2), 242­262.
  , James Levinsohn, and Ariel Pakes, "Automobile Prices in Market
  Equilibrium," Econometrica, July 1995, 60 (4), 889­917.
  ,   , and , "Differentiated Products Demand Systems from a Combi-
  nation of Micro and Macro Data: The New Vehicle Market," Journal of
  Political Economy, February 2004, 112 (1), 68­105.
Berry, Steven T., Amit Gandhi, and Philip A. Haile, "Connected
 Substitutes and Invertibility of Demand," Econometrica, 2013, 81 (5), 2087­
 2111.
   and Philip A. Haile, "Nonparametric Identification of Multinomial
  Choice Demand Models with Heterogeneous Consumers," Discussion Paper
  1718, Cowles Foundation, Yale University 2010.
   and , "Identification in Differentiated Products Markets Using Market
  Level Data," Econometrica, September 2014, 82 (5), 1749­1797.
   and , "Identification in Differentiated Products Markets," Annual Review
  of Economics, 2016, 8, 27­52.

                                    25
   and , "Nonparametric Identification of Simultaneous Equations Models
  with a Residual Index Structure," Econometrica, 2018, 86 (1), 289­315.

Bhattacharya, Debopam, "Empirical Welfare Analysis for Discrete Choice:
 Some General Results," Quantitative Economics, 2018, 9, 571­615.

Block, H.D. and Jacob Marschak, "Random Orderings and Stochastic
  Theories of Responses," in Ingra Olkin, Sudhish Ghurye, Wassily Hoeffding,
  William G. Mado, and Henry B. Mann, eds., Contributions to Probability
  and Statistics: Essays in Honor of Harold Hotelling, Stanford University
  Press, 1960, pp. 97­132.

Blundell, Richard and Rosa L. Matzkin, "Control Functions in Nonsep-
  arable Simultaneous Equations Models," Quantitative Economics, 2014, 5
  (2), 271­295.

  , Dennis Kristensen, and Rosa L. Matzkin, "Control Functions and
  Simultaneous Equations Methods," American Economic Review, Papers and
  Proceedings, 2013, 103, 563­569.

  , , and , "Bounding Quantile Demand Functions Using Revealed Pref-
  erence Inequalities," Journal of Econometrics, 2014, 179, 112­127.

Burda, Martin, Matthew Harding, and Jerry Hausman, "A Bayesian
 Mixed Logit-Probit Model for Multinomial Choice," Journal of Applied
 Econometrics, 2015, 30, 353­376.

Capps, Cory, David Dranove, and Mark Satterthwaite, "Competition
 and Market Power in Option Demand Markets," RAND Journal of Eco-
 nomics, 2003, 34 (5), 737­763.

Diamond, Rebecca, "The Determinants and Welfare Implications of US
 Workers' Diverging Location Choices by Skill: 1980­2000," The American
 Economic Review, 2016, 106, 479­524.

Falmagne, Jean-Claude, "A Representation Theorem for Finite Random
  Scale Systems," Journal of Mathematical Psychology, 1978, 18, 52­72.

Fan, Ying, "Ownership Consolidation and Product Characteristics: A Study
  of the U.S. Daily Newspaper Market," American Economic Review, 2013,
  103 (5), 1598­1628.

Gentzkow, Matthew and Jesse Shapiro, "What Drives Media Slant?
 Evidence from U.S. Newspapers," Econometrica, 2010, 78, 35­71.


                                    26
Gerber, Alan, "Estimating the Effect of Campaign Spending on Senate Elec-
 tion Outcomes Using Instrumental Variables," The American Political Sci-
 ence Review, 1998, 92 (2), 401­411.

Goldberg, Pinelopi Koujianou, "Product Differentiation and Oligopoly in
 International Markets: The Case of the U.S. Automobile Industry," Econo-
 metrica, July 1995, 63 (4), 891­951.

Gordon, Brett and Wesley R. Hartmann, "Advertising Effects in Presi-
 dential Elections," Marketing Science, 2013, 32 (1), 19­35.

Hausman, J., G. Leonard, and J.D. Zona, "Competitive Analysis with
 Differentiated Products," Annales d'Economie et de Statistique, 1994, 34,
 159­180.

Hausman, Jerry A., "Valuation of New Goods under Perfect and Imper-
 fect Competition," in Timothy F. Bresnahan and Robert J. Gordon, eds.,
 The Economics of New Goods, Chicago: University of Chicago Press, 1996,
 chapter 5, pp. 209­248.

Ho, Katherine, "The Welfare Effects of Restricted Hospital Choice in the
 U.S. Medical Care Market," Journal of Applied Econometrics, 2006, 21,
 1039­1079.

  , "Insurer-Provider Networks in the Medical Care Market," American Eco-
  nomic Review, 2009, 99, 393­430.

   and Robin Lee, "Insurer Competition in Health Care Markets," Econo-
  metrica, 2016, forthcoming.

Hom, Matthew, "School Choice, Segregation and Access to Quality Schools:
 Evidence from Arizona," Technical Report, Yale University 2018.

Kawai, Kei, Yuta Toyama, and Yasutora Watanabe, "Voter Turnout
 and Preference Aggregation," American Economic Journals: Microeco-
 nomics, 2020, forthcoming.

Lewbel, Arthur, "An Overview of the Special Regressor Method," in Jef-
  frey S. Racine, Liangjun Su, and Aman Ullah, eds., The Oxford Handbook
  of Applied Nonparametric and Semiparametric Econometrics and Statistics,
  Oxford University Press, 2014, pp. 38­62.

Mas-Colell, Andreu, Michael D. Whinston, and Jerry R. Green,
 Microeconomic Theory, Oxford University Press, 1995.


                                   27
Matzkin, Rosa L., "Estimation of Nonparametric Models with Simultane-
 ity," Econometrica, 2015, 83, 1­66.

McFadden, Daniel, "Revealed Stochastic Preference: A Synthesis," Eco-
 nomic Theory, 2005, 26, 245­264.

  , A. Talvitie, and Associates, Demand Model Estimation and Validation,
  Berkeley CA: Institute of Transportation Studies, 1977.

Neilson, Christopher, "Targeted Vouchers, Competition Among Schools,
 and the Academic Achievement of Poor Students," Working Paper, Prince-
 ton University 2019.

Nevo, Aviv, "A Practitioner's Guide to Estimation of Random Coefficients
 Logit Models of Demand," Journal of Economics & Management Strategy,
 2000, 9 (4), 513­548.

Newey, Whitney K. and James L. Powell, "Instrumental Variable Esti-
 mation in Nonparametric Models," Econometrica, 2003, 71 (5), 1565­1578.

Petrin, Amil, "Quantifying the Benefits of New Products: The Case of the
 Minivan," JPE, August 2002, 110 (4), 705­729.

van Mill, Jan, The Infinite-Dimensional Topology of Function Spaces, Else-
  vier, 2002.

Waldfogel, Joel, "Preference Externalities: An Empirical Study of Who
 Benefits Whom in Differentiated-Product Markets," RAND Journal of Eco-
 nomics, Autumn 2003, 34 (3), 557­568.




                                   28
