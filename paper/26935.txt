                             NBER WORKING PAPER SERIES




          ESTIMATING MACROECONOMIC MODELS OF FINANCIAL CRISES:
               AN ENDOGENOUS REGIME-SWITCHING APPROACH

                                      Gianluca Benigno
                                      Andrew Foerster
                                     Christopher Otrok
                                     Alessandro Rebucci

                                     Working Paper 26935
                             http://www.nber.org/papers/w26935


                    NATIONAL BUREAU OF ECONOMIC RESEARCH
                             1050 Massachusetts Avenue
                               Cambridge, MA 02138
                                    April 2020




We are grateful to Yan Bai, Dario Caldara, Pablo Guerron-Quintana, Giorgio Primiceri, Felipe
Saffie, and Frank Schorfheide for helpful comments and discussions. We also thank participants
at the NASMES, the SED, the EABCN-CEPR EUI Conf., the CEF, the Taipei Conf. on Growth,
Trade and Dynamics, the CEPR ESSIM, the NBER Meeting on Methods and Applications for
DSGE Models, the Midwest Macro Meetings, the Norges Bank Workshop on Nonlinear Models,
the NBER Summer Institute, and the NBER IFM Spring Meeting, as well as seminar participants
at Beijing Univ., Central Florida, ECB, Fudan Univ., Indiana, Notre Dame, Texas A&M, KU
Leuven, JHU Carey Business School, the Central Bank of Belgium, the ECB, and the Dallas and
San Francisco Feds. Sanha Noh provided outstanding research assistance. The authors gratefully
acknowledge financial support from NSF Grant SES1530707 and the Johns Hopkins Catalyst
Award. The views expressed are solely those of the authors and do not necessarily reflect the
views of the Federal Reserve Banks of New York, San Francisco, or St. Louis, the Federal
Reserve System, or the National Bureau of Economic Research.

NBER working papers are circulated for discussion and comment purposes. They have not been
peer-reviewed or been subject to the review by the NBER Board of Directors that accompanies
official NBER publications.

© 2020 by Gianluca Benigno, Andrew Foerster, Christopher Otrok, and Alessandro Rebucci. All
rights reserved. Short sections of text, not to exceed two paragraphs, may be quoted without
explicit permission provided that full credit, including © notice, is given to the source.
Estimating Macroeconomic Models of Financial Crises: An Endogenous Regime-Switching
Approach
Gianluca Benigno, Andrew Foerster, Christopher Otrok, and Alessandro Rebucci
NBER Working Paper No. 26935
April 2020
JEL No. C11,E30,F41,G01

                                          ABSTRACT

We estimate a workhorse DSGE model with an occasionally binding borrowing constraint. First,
we propose a new specification of the occasionally binding constraint, where the transition
between the unconstrained and constrained states is a stochastic function of the leverage level and
the constraint multiplier. This specification maps into an endogenous regime-switching model.
Second, we develop a general perturbation method for the solution of such a model. Third, we
estimate the model with Bayesian methods to fit Mexico's business cycle and financial crisis
history since 1981. The estimated model fits the data well, identifying three crisis episodes of
varying duration and intensity: the Debt Crisis in the early-1980s, the Peso Crisis in the
mid-1990s, and the Global Financial Crisis in the late-2000s. The crisis episodes generated by the
estimated model display sluggish and long-lasting build-up and stagnation phases driven by
plausible combinations of shocks. Different sets of shocks explain different variables over the
business cycle and the three historical episodes of sudden stops identified.

Gianluca Benigno                                 Christopher Otrok
Department of Economics                          Department of Economics
London School of Economics                       University of Missouri
WC2A 2AE                                         Columbia, MO 65211
London WC2A 2AE                                  and Federal Reserve Bank of St Louis
United Kingdom                                   otrokc@missouri.edu
and International Research Function,
Federal Reserve Bank of New York                 Alessandro Rebucci
g.benigno@lse.ac.uk                              Johns Hopkins Carey Business School
                                                 100 International Drive
Andrew Foerster                                  Baltimore, MD 21202
Federal Reserve Bank of San Francisco            and NBER
101 Market St                                    arebucci@jhu.edu
San Francisco, CA 94105
andrew.foerster@sf.frb.org
1     Introduction
The Global Financial Crisis triggered strong renewed interest in understanding the
causes, consequences, and remedies of financial crises. In this context, dynamic
stochastic general equilibrium (DSGE) models with occasionally binding frictions
proved successful as laboratories to study the anatomy of both business cycles and
crises, and to explore optimal policy responses to these dynamics. This success is
because occasionally binding financial frictions are mechanisms that create ampli-
fication of regular business cycle dynamics. For example, even in the case of the
COVID-19 crisis, which did not originate in the financial sector, suddenly binding
financial frictions powerfully amplified the initial impulse. Structural estimation of
these models is challenging, yet important for inference on key parameters governing
financial frictions, counterfactual policy analysis, and structural real-time forecasts.
    In this paper, we structurally estimate a model with an occasionally binding bor-
rowing constraint. We make three main contributions. First, we propose a new
specification of the occasionally binding collateral constraint. Second, we develop
a perturbation solution method suitable for solving models like ours in a way that
permits likelihood-based estimation. Third, we focus on one particular type of cri-
sis, the so-called sudden stop in international capital flows, and apply the proposed
approach to the estimation of a medium-scale workhorse DSGE model of such crises,
investigating sources and frictions of business cycles and crises in Mexico since 1981.
    As a first step, we propose a new formulation of occasionally binding constraint
models. As in models with constraints written as inequalities, our set up has two
states or regimes: in the first, limited leverage amplifies regular shocks and gives
rise to financial crises episodes; in the second, access to financing is unconstrained
and the economy displays regular business cycles. In our specification, however, the
transitions between the two regimes depend on a range rather than a unique level of
leverage, with endogenous probabilities that depend on the borrowing capacity and
the multiplier associated with the leverage constraint. This formulation maps the
model with an occasionally binding leverage constraint into an endogenous regime-
switching model. The paper focuses on a particular friction and type of crisis, the
so called sudden stop in capital flows, but the proposed specification has broader
applicability to other types of occasionally binding constraints.
    Next, we develop a perturbation-based solution method for solving the endoge-


                                           2
nous regime-switching model. The perturbation method is fast enough to permit
likelihood-based estimation, is readily scalable to models larger than the one we es-
timate in this paper, and displays typical levels of accuracy. We also show analyti-
cally that to capture the effects of endogenous transition probabilities on the policy
functions characterizing optimal behavior, and hence precautionary behavior, it is
necessary to approximate the model solution at least to second-order, and that these
effects would be missed by linear approximations. As with our first contribution,
the solution method that we develop can be used with a wide range of endogenous
regime-switching models.
   Finally, we apply our borrowing constraint specification and solution method, and
perform Bayesian estimation of a workhorse small open-economy model to character-
ize both financial crises and business cycles in Mexico. While our application focuses
on an emerging market economy, our specification can be applied to the formulation
and estimation of other model settings with occasionally binding constraints. For
example, the approach that we propose could be applied to the formulation and esti-
mation of models of occasionally binding credit frictions, housing constraints, banking
with asymmetric information, downward wage rigidity, the zero lower bound, or a SIR-
macro model in which the probability of being infected depends on agents' decisions
as in Eichenbaum et al. (2020).
   Figure 1 plots two critical variables in our application to Mexico: the current
account balance as a share of GDP and the quarterly real GDP growth in deviation
from sample mean. The figure illustrates the regular fluctuations in the data as well
as multiple episodes of large current account reversals and persistent output growth
declines. Large current account reversals and output drops of heterogeneous size and
persistence are the two main empirical features commonly associated with sudden
stops in capital flows, not only in Mexico but also in many other emerging markets
exposed to volatile capital flows. In this paper, we focus on the challenge of fitting a
structural model to Mexico's business cycle and sudden stop history.
   Despite the econometric challenges in characterizing data like those displayed in
Figure 1, our estimated model fits Mexico's business cycles and sudden stop episodes
well, and does not rely on large shocks to explain crises but instead lets the structure
of the model explain those events. It produces business cycle statistics that match
the second moments of the data and provides evidence on the relative importance of
different shocks. Most importantly, our new specification of the collateral constraint

                                           3
       Figure 1: Current Account and Output in Mexico, 1981-2016
                       (a) Current Account to Output Ratio




                         (b) Quarterly Output Growth Rate




   Note: Panel (a) plots Mexico's current account balance as a share of GDP. Panel (b) shows
   Mexico's quarterly log-change of real GDP. See the Appendix for data sources. Sample
   period 1981:Q1-2016:Q4.


identifies crisis episodes and dynamics of varying duration and intensity, consistent
with evidence not only of large economic dislocation during financial crises but also
sluggish build-up and recovery phases surrounding them (Cerra and Saxena, 2008;
Reinhart and Rogoff, 2009; Boissay et al., 2016).
   In particular, the estimated model identifies three financial crises: the Debt Cri-
sis from 1981:Q3 to 1983:Q2, the Mexican peso crisis commonly referred to as the
"Tequila crisis" from 1994:Q1 to 1996:Q1, and the spillover effect from the Global Fi-
nancial Crisis from 2008:Q4 to 2009:Q3. The identified crisis episodes align well with
a purely empirical notion of financial crisis in Mexico (Reinhart and Rogoff, 2009)
and display duration about twice as long as the crisis peaks previously identified
as sudden stops (Cerra and Saxena, 2008). The model-simulated dynamics of crisis
episodes indicate that they are preceded by slowly unfolding booms and followed by
economic stagnation, and are not only driven by a favorable external environment
that suddenly reverses, but also domestic factors such as technology and demand
shocks. We also show that different shocks matter more for different historical crisis

                                              4
episodes, as well as different phases of a given episode.

Related Literature A few papers have already estimated models with occasionally
binding constraints. Bocola (2016), in particular, builds and estimates a model of
occasionally occurring debt and banking crises. Notably, estimation is accomplished
while solving the model with global methods, which avoids the use of approximations.
However, this estimation is accomplished by first estimating the model outside the
crisis, and then appending an estimate of the crisis in a second step. While this
procedure does not matter for the specific application in Bocola (2016), it is not
necessarily applicable more generally. Our approach permits joint estimation of the
model inside and outside the crises and is potentially scalable to larger and more
complex models, while maintaining a satisfactory level of accuracy relative to global
solution methods.
       Our paper relates also to Guerrieri and Iacoviello (2015), who develop OccBin,
a set of procedures for the solution of models with occasionally binding constraints.
OccBin is a certainty equivalent solution method that captures non-linearities but not
precautionary effects, which are a critical feature of models with occasionally binding
collateral constraints.1 A key feature of our approach is to preserve precautionary
saving effects, as agents in the model adjust their behavior due to the presence of the
constraint even when the constraint does not bind, and vice versa.
       In the literature on Markov-switching DSGE models, our paper builds upon the
method developed by Foerster et al. (2016), who developed perturbation methods for
the solution of exogenous regime-switching models. The perturbation approach that
we propose allows for second- and higher-order approximations that go beyond the
linear models studied by Davig and Leeper (2007) and Farmer et al. (2011). In fact,
we show that at least a second-order approximation is necessary in order to capture
the effects of the endogenous switching.
       The paper is also related to the literature that focuses on solving endogenous
regime-switching models. Davig and Leeper (2008), Davig et al. (2010), and Alpanda
and Ueberfeldt (2016) all consider endogenous regime-switching, but employ com-
putationally costly global solution methods that hinder likelihood-based estimation.
Lind (2014) develops a regime-switching perturbation approach for approximating
   1
    Cuba-Borda et al. (2019) study how the solution method and likelihood misspecification interact
and possibly compound each other.



                                                5
non-linear models, but it requires repeatedly refining the points of approximation
and hence it is not suitable for estimation purposes. Maih (2015) and Barthlemy and
Marx (2017) also propose perturbation methods for endogenous switching models,
but employ a technique that approximates around regime-dependent steady states,
which may not be a suitable choice given the relatively rare frequency of crises. In
contrast, our perturbation method uses a single approximation point in the area of
the state-space where the economy spends most of the time.
   Importantly, we also contribute to the literature on likelihood-based estimation
of Markov-switching DSGE models initiated by the seminal contributions of Bianchi
(2013), and applied in Bianchi and Ilut (2017) and Bianchi et al. (2018). Our al-
gorithm differs in two key respects. First, our regime-switching transition matrix
reflects the endogenous nature of the switching. Second, conditional on the regime,
we have a second order solution, so we employ the Sigma Point Filter to evaluate the
likelihood function in place the modified Kalman filter in Bianchi (2013).
   The specification of the constraint that we propose and the accompanying pertur-
bation solution method could be easily applied to models with occasionally binding
zero-lower bound on interest rates (for example, Adam and Billi, 2007; Aruoba et al.,
2018; Atkinson et al., 2018). Existing methods for the estimation of such models
may limit scalability due computational costs (Gust et al., 2017). Moreover, the
occasionally binding zero lower bound is not comparable to the kind of constraints
with endogenous collateral value that we estimate in this paper and is used in the
normative literature on macroprudential policies (Benigno et al., 2013, 2016). Indeed,
endogenous collateral valuation features different amplification mechanisms and en-
tails additional computational complexities (Bianchi and Mendoza, 2018; Devereux
et al., 2019).
   The application of the methodology that we propose relates to the literature
on emerging market business cycles, which includes Aguiar and Gopinath (2007),
Mendoza (2010), Garcia-Cicco et al. (2010), Fernandez-Villaverde et al. (2011), and
Fernandez and Gulan (2015), among others. Encompassing most shocks previously
considered, we include in our analysis technology, preference, expenditure, interest
rate, and terms of trade shocks. Relative to Mendoza (2010), we provide a Bayesian
estimation of the model and consider a wider set of structural shocks, finding that
some of the estimated values of the parameters that are not easily calibrated to the
stylized facts of the data differ substantially. Relative to Garcia-Cicco et al. (2010),

                                           6
we evaluate empirically the relative importance of interest rate shocks in an fully
non-linear framework, with a more articulated specification of the financial frictions
driving amplification. Consistent with Fernandez and Gulan (2015) and Ates and
Saffie (2016), we can fit ergodic second moments of the data well with uncorrelated
shocks, but specific combinations of shocks are associated with crisis dynamics.
        Finally, our paper relates to the now large literature on the Bayesian estimation
of DSGE models (for example, Schorfheide, 2000; Otrok, 2001; Smets and Wouters,
2007; Liu et al., 2013). Our paper extends that successful approach to models with
occasionally binding collateral constraints, which have become the benchmark for
normative analysis of macro-prudential optimal policy (Bianchi and Mendoza, 2018;
Benigno et al., 2013, 2016). Welfare-base analysis of optimal macroprudential policies
with occasionally binding constraints depends critically on calibrations assumptions
and collateral constraint formulations. Structural estimation of these parameters and
likelihood based model validation can discipline model formulation, which in turn is
critical for normative policy recommendations.
        The rest of the paper is organized as follows. Section 2 describes the model and
discusses the proposed formulation of the collateral constraint. Section 3 presents
our perturbation solution method for endogenous regime-switching models. Section 4
describes the Bayesian estimation procedure. Section 5 reports the estimation results
on parameters, model fit, and business cycle properties. Section 6 presents results
on financial crises. Section 7 concludes. The Appendices include additional technical
details and empirical results.


2         The Model
The model is a medium scale, workhorse framework for the analysis of business cycles
and sudden stop crises in emerging market economies. The core of the model is as
in Mendoza (2010), although we consider a larger set of shocks as in Garcia-Cicco
et al. (2010). It features a small, open, production economy with an occasionally
binding collateral constraint, that is subject to temporary productivity, intertempo-
ral preference, expenditure, interest rate, and terms of trade shocks.2 The collateral
    2
    We omit permanent technology shocks that could of the type analyzed by Aguiar and Gopinath
(2007) because these long-run components cannot be estimated precisely over samples periods of
length comparable to ours. Moreover, Garcia-Cicco et al. (2010) and Miyamoto and Nguyen (2017)


                                              7
constraint that we specify depends on the endogenous variables of the model, includ-
ing borrowing, capital and its relative price, and hence leverage. Capital and debt
choices respond to exogenous shocks, affecting borrowing, which in turn affects the
probability of a binding collateral constraint.
   Due to the occasionally binding nature of the constraint, this framework can ac-
count not only for normal business cycles, but also key aspects of financial crises in
both emerging markets and advanced economies (Bianchi and Mendoza, 2018). While
our application focuses on one particular type of crisis, the so called sudden stop in
capital flows, our framework is generally applicable to other macroeconomic mod-
els with occasionally binding frictions and crises (for example, Kiyotaki and Moore,
1997; Iacoviello, 2005; Gertler and Karadi, 2011; Jermann and Quadrini, 2012; Liu
et al., 2013; Gertler and Kiyotaki, 2015; Bocola, 2016; Schmitt-Grohe and Uribe,
2016; Boissay et al., 2016; Eichenbaum et al., 2020).
   In the rest of this section, we discuss the representative household-firm and the
borrowing constraint specification. The formal definition of the equilibrium and the
full set of equilibrium conditions is reported in Appendix A.


2.1     Preferences, Constraints, and Shock Processes
There is a representative household-firm that maximizes the following utility function

                                                                1-
                                            1           H
                        U  E0          dt  t
                                                    Ct - t             ,                    (1)
                                 t=0
                                           1-            

where Ct denotes consumption, Ht the supply of labor, and dt an exogenous and
stochastic preference shock specified below. Households choose consumption, labor,
capital Kt , imported intermediate inputs Vt given an exogenous stochastic relative
price Pt also specified below, and holdings of real one-period international bonds, Bt .
Negative values of Bt indicate borrowing from abroad. The household-firm faces the
budget constraint:

                                                               1
              Ct + It + Et = Yt - rt (Wt Ht + Pt Vt ) -               Bt + Bt-1 ,           (2)
                                                            (1 + rt )
also find that the permanent technology shock is not quantitatively important in frameworks with
financial frictions like ours in the case of Mexico.




                                               8
where Yt is gross domestic product and is given by

                                Yt = At Kt-1 Ht Vt1-- - Pt Vt .                                  (3)

Here, At denotes the exogenous and stochastic level of technology. Et is an exogenous
and stochastic expenditure process possibly interpreted as a fiscal or net export shock
as in Garcia-Cicco et al. (2010). The term rt (Wt Ht + Pt Vt ) describes a working
capital constraint, stating that a fraction of the wage and intermediate good bill
must be paid in advance of production with borrowed funds. The relative price of
labor and capital are given by Wt and qt , respectively, both of which are endogenous
market prices, but taken as given by the individual household-firm. Gross investment,
It , is subject to adjustment costs as a function of net investment:

                                                              Kt - Kt-1
                    It = Kt-1 + (Kt - Kt-1 ) 1 +                               .                 (4)
                                                          2     Kt-1

       Household-firms can borrow in international markets issuing one-period bonds
that pay a market or country net interest rate rt . The country interest rate between
period t and t + 1, rt , has three components: an exogenous persistent component,
an exogenous transitory component, an endogenous component that depends on the
level of debt. Thus, the country interest rate is given by

                                                         ¯
                              rt = rt + r r,t + r eB -Bt - 1 ,                                   (5)

                                           
where the persistent exogenous component, rt , follows the process

                              
                             rt           r + r rt
                                = (1 - r )¯      
                                                   -1 + r r ,t ,                                 (6)

with r ,t and r,t i.i.d. N (0, 1) and r and r denoting parameters that control the
variance of the two components.3
       As Mendoza (2010) notes, in our model, the household-firm also faces a endoge-
nous external financing premium on debt (EFPD), measured by the difference between
the effective real interest rate, which corresponds to the intertemporal marginal rate
   3
    While contemporaneous movements in r ,t and r,t are not identified separately in equations
(5) and (6), r,t will be identified in the data because of differences in persistence. Including both
types of shocks helps fitting the observable counterpart variable in estimation.



                                                 9
                                 h
of substitution in consumption, rt = µt /Et [µt+1 ], and the market interest rate, rt . In
fact, the Euler equation for bt , µt = t +  (1 + rt ) Et µt+1 , can be rearranged to show
                   h
that EF P D = Et [rt - rt ] = t /Et [µt+1 ], where µt is the Lagrange multiplier on
the budget constraint and t is the multiplier on the collateral constraint to be intro-
duced shortly. Because of this feature, the endogenous interest rate component of rt ,
        ¯
r eB -Bt - 1 in equation (5) will be calibrated to serve the sole purpose of inducing
independence of the model steady state from initial conditions, as in Schmitt-Grohe
and Uribe (2003), by setting r to a very small value.4 In addition, we do not im-
pose any correlation between the innovations to the interest rate process and the
productivity process specified below.
       The remaining exogenous processes for the preference shock dt , the temporary
technology shock At , the shock to the relative price of intermediate goods Pt , and the
domestic expenditure shock Et , are specified as follows:

                        log dt = d log dt-1 + d d,t ,                                                (7)
                       log At = (1 - A )A + A log At-1 + A A,t ,                                     (8)
                        log Pt = (1 - P )P  + P log Pt-1 + P P,t ,                                   (9)
                       log Et = (1 - E )E  + E log Et-1 + E E,t ,                                  (10)

where the starred variables and the . coefficients denote the unconditional mean
value and the persistence parameter of the processes, .,t are assumed i.i.d. N (0, 1)
innovations, and the .,t parameters control the size of the process variances.5


2.2         The Occasionally Binding Borrowing Constraint: An En-
            dogenous Regime-Switching Specification
The central idea of this paper is to model the occasionally binding nature of a tra-
ditional inequality borrowing constraint as an endogenous regime-switching process.
   4
     Mendoza (2010) uses an endogenous rate of time preference for this purpose.
   5
     While possible in principle, we do not allow for regime-switching in the shocks processes, either
in the intercepts or in the volatilities. This assumption is because we want the collateral constraint to
drive regime-switching, rather than changes in the stochastic processes. Allowing for regime change
in the shock processes might improve overall fit, but we want the economic features of the model and
not changes in the exogenous shock processes to drive fluctuations and crisis episodes. Nonetheless,
stochastic volatility may be an important feature of emerging markets (Fernandez-Villaverde et al.,
2011; Arellano et al., 2019)


                                                   10
In one regime, denoted st = 1, the constraint binds strictly; in the second regime,
denoted st = 0 the constraint does not bind. In the binding regime, total borrowing
equals a fraction  of the value of collateral qt Kt :

                         1
                                Bt -  (1 + rt ) (Wt Ht + Pt Vt ) = -qt Kt .                       (11)
                      (1 + rt )

Thus, in this regime total debt, which is borrowing for consumption smoothing plus
working capital for the purchase of intermediate inputs and labor for production,
is limited by the value of collateral. Limited working capital, as in Neumeyer and
Perri (2005), Mendoza (2010), Fernandez and Gulan (2015), and Ates and Saffie
(2016), amplifies the supply response of the economy to shocks in the constrained
regime. In the unconstrained regime, lenders finance all desired borrowing, and the
only constraint on borrowing is the natural debt limit.6
       Given these two regimes representing the occasionally binding nature of the bor-
rowing constraint, we assume a stochastic characterization of the transition between
them, which eliminates the non-differentiability of the traditional inequality specifi-
cation and has appealing empirical properties. The typical inequality specification
of the borrowing constraint implies that, for given values of the endogenous and ex-
ogenous states, there is one specific level of leverage at which the constraint binds,
and at that level of leverage the constraint always binds. In contrast, we assume
that, for given values of the endogenous and exogenous states, there is a probability
of switching to the constrained regime, but no specific level of leverage that triggers
a switch to the constrained regime.
       We assume that the probabilities of switching from one regime to the other depend
on critical endogenous variables of the model. The probability of switching from the
non-binding to the binding regime is a logistic function of the distance between actual
borrowing and the borrowing limit equal to a fraction of the value of collateral. The
probability of switching from the binding regime back to the nonbinding one is a
logistic function of the collateral constraint multiplier. Therefore the transitions are
affected by all endogenous variables in the model and agents have full information
with rational expectations about these transitions probabilities.
       This regime switching specification of the occasionally binding nature of the the
   6
    An alternative interpretation for our setup is that  switches between a finite value in the binding
regime that produces equation (11), and infinity in the non-binding regime.


                                                  11
collateral constraint captures the salient macroeconomic empirical finding that the
likelihood of a financial crisis increases with leverage, but high leverage does not
necessarily lead to a financial crisis. For example, Jorda et al. (2013) proxy finan-
cial leverage by the rate of change of private bank credit relative to GDP. In their
database of 14 advanced countries from 1870 to 2008 there are 35 recessions associ-
ated with financial crises. Across these episodes, the change in leverage before a crisis
is highly heterogeneous, with the standard deviation of financial leverage twice the
mean. This evidence suggests that the exact level of leverage at which a crisis occurs
varies considerably across crisis episodes.7
       In addition, a growing body of microeconomic evidence indicates that a determin-
istic specification of occasionally binding collateral constraints does not accurately
capture lending and borrowing behaviors at the household and firm or bank level.
For example, Chodorow-Reich and Falato (2017) and Greenwald (2019) among oth-
ers, show that loan covenants are used to renegotiate credit lines as borrowers ap-
proach their limits, rather than simply being cut off from funding as soon as they face
financial stress. Campello et al. (2010) provide survey information on the behavior of
financially constrained firms, and Ivashina and Scharfstein (2010) examine loan level
data, showing that firms drew down pre-existing credit lines in order to satisfy their
liquidity needs. Bank lending standards fluctuating over the cycle could also be con-
sistent with a stochastic specification of the collateral constraint. Thus, in practice,
collateral constraints do not seem to bind at any particular leverage ratio.8
       In the rest of this section, we discuss a modified slackness condition associated
with our specification of the occasionally binding borrowing constraint and how it
permits casting a occasionally binding constraint model in the form of an endogenous
regime-switching framework. We then spell out the assumptions that we make to
model the transition between regimes. We conclude the section with some remarks
about the implications of our formulation for model dynamics.
   7
      The notion of "debt intolerance" discussed by Reinhart and Rogoff (2009) and credit surface of
Fostel and Geanakoplos (2015) also are consistent with our stochastic specification.
    8
      Exploring whether the our specification of the borrowing constraint may result from the solution
of a limited enforcement problem with renegotiation, hidden liquidity, or random monitoring shocks
is beyond the scope of this paper.




                                                 12
2.2.1      The Regime-Switching Slackness Condition

Denote the Lagrange multiplier associated with equation (11) as t and define the
                      
"borrowing cushion," Bt as the distance of actual borrowing from the debt limit:

                              1
                   Bt =              Bt -  (1 + rt ) (Wt Ht + Pt Vt ) + t qt Kt .                  (12)
                           (1 + rt )

When the borrowing cushion is small, total borrowing is high relative to the value of
collateral, meaning that the leverage ratio is high.
                                                                  
       The critical step is to implement the slackness condition Bt t = 0 so that the
                
two variables, Bt and t , are zero if the economy is in the relevant regime: t =
                                  
0 in the non-binding regime, and Bt = 0 in the binding regime. To implement
this restriction and be consistent with regime-switching DSGE models in which the
parameters are the model objects that change state, we define two auxiliary regime-
dependent parameters,  (st ) and  (st ), such that  (0) =  (0) = 0, and  (1) =
 (1) = 1.9 Next, we introduce the following regime-switching slackness condition :

                                   
         (st ) Bss +  (st ) (Bt - Bss ) = (1 -  (st )) ss + (1 -  (st )) (t - ss ) ,               (13)

       
where Bss and ss are the steady state borrowing cushion and collateral constraint
multiplier, respectively, defined more precisely in Section 3 below. It is now easy to
see that equation (13) implies that, as desired, when st = 0 then t = 0, and when
                                                                             
st = 1 then Bt = 0. Thus, our formulation satisfies the slackness condition Bt t = 0
characterizing the representative household-firm's optimization problem. Yet, given
                                                                                  
a regime st , equation (13) remains continuously differentiable for any value of Bt or
t , as no inequality constraint is imposed.
       Technically, equation (13) "preserves" information in the perturbation approxima-
tion that we introduce in Section 3, since, at first order, both variables are constant
in the respective regimes. The use of the regime-dependent switching parameters,
 (st ) and  (st ), follows from the Partition Principle of Foerster et al. (2016), which
separates parameters based upon whether they affect the steady state or not. Intu-
   9
    In our model these parameters coincide with the regime-switching indicator variable st , but in
more general settings they may not. The notation provides a general formulation of the modified
slackness condition that is applicable to other setups possibly different than the one associated with
our specific application. See, for example, the discussion of our stochastic specification in the context
of other model settings in Binning and Maih (2017).


                                                   13
itively, (st ) captures the level of the economy changing across regimes (e.g., capital
is lower when the constraint binds), while  (st ) captures the dynamic responses dif-
fering across regimes (e.g., the response of investment to shocks changes when the
constraint binds).

2.2.2      Modelling Endogenous Regime-Switching

To model the transition from one regime to the other, we rely on logistic functions
of endogenous variables determined in equilibrium.10 Specifically, we assume that
the transition from the non-binding to the binding regime depends on the borrowing
          
cushion, Bt :
                                                                 
                                                        exp (-0 Bt )
                        Pr (st+1 = 1|st = 0, Bt )=                   
                                                                        .                     (14)
                                                      1 + exp (-0 Bt  )
Thus, the likelihood that the constraint binds in the following period depends on the
size of the borrowing cushion in the current period. The parameter 0 controls the
steepness of the logistic function, determining the sensitivity of the probability of
switching regime to the size of the borrowing cushion. When 0 is positive, as the
cushion declines the probability of switching to the binding regime increases. Note
here that, for certain draws from the logistic function, the borrowing cushion could
be negative and the economy could temporarily remain in the non-binding regime.
       Similarly, when the constraint binds, the transition probability to the non-binding
regime is a logistic function of the Lagrange multiplier, t , according to

                                                        exp (-1 t )
                         Pr (st+1 = 0|st = 1, t ) =                   .                       (15)
                                                      1 + exp (-1 t )

The probability of switching back from the constrained to the unconstrained regime,
therefore, depends on the shadow value of the economy's desired borrowing relative
to the limit set by the collateral constraint. As in the case of a switch from the
constrained to constrained regime, the parameter 1 affects the sensitivity of this
probability to the value of the multiplier. For positive 1 , a large positive multiplier
implies that the constraint binds tightly, and the probability of exiting the binding
regime is lower. As the multiplier declines, this probability increases. Again, as
  10
    Logistic functions have the advantage that they are tractable and parsimoniously parameterized.
Bocola (2016) and Kumhof et al. (2015) use a logistic function to model the transition to a default
regime, and Davig et al. (2010) and Bi and Traum (2014) use it to study hitting a fiscal limit.



                                                14
before, in the binding regime, it is possible that the desired level of borrowing is less
than the level forced upon it by the binding regime, which would manifest itself with
a negative collateral constraint multiplier.11
       Putting equations (14) and (15) together, the regime-switching model has an
endogenous transition matrix

                                       exp(-0 Bt)                 )
                                                          exp(-0 Bt
                                 1-   1+exp(-0 Bt)       1+exp(-0 Bt)
                        Pt =         exp(-1 t )              exp(-1 t )
                                                                          .                    (16)
                                    1+exp(-1 t )
                                                     1   - 1+exp(-1 t )

2.2.3      Remarks on the Endogenous Regime-Switching Formulation

A few remarks are useful on how our stochastic formulation of the borrowing con-
straint works and differs relative to the typical inequality formulation.
       First, the regime draw from the logistic functions in a given period is determined
before exogenous shocks are realized and economic decisions are made during that
period. Figure 2 summarizes the model timing and shows that, at the start of a given
period t, the regime outcome st is drawn from the logistic distributions as a function
                                                                            
of previous period borrowing cushion and collateral constraint multiplier, Bt -1 and
t-1 . Next, exogenous shocks, which are orthogonal to the realization of the regime,
are realized, and agents take decisions during period t based on the regime outcome,
st , as well as a probability distribution over the next regime realization, st+1 , as in
equation (14) or (15). These decisions pin down all endogenous variables, including
                       
the borrowing cushion Bt or the multiplier t . Finally, the regime realization for
                                
period t + 1 is drawn based on Bt and t , and so on.
       Second, as we have already noted, an implication of our setup is that entry and
exit of the economy from the binding regime occurs stochastically and hence may
happen earlier or later than a deterministic formulation might imply. The fact that
the borrowing cushion and multiplier can take negative values implies that the build
up to, or duration of financial crises might persist. Likewise, the fact that a regime-
switch can occur despite positive values of the cushion and multiplier implies the
entry into or exit from crises might occur relatively sooner than it might otherwise.
As a result, the framework can potentially capture both rapid movements and slow
  11
     By construction, the transition probabilities equal 0.5 when their arguments are zero. In prin-
ciple, one could relax this assumption by introducing a constant into the arguments of equations
(14-15). However, preliminary estimates that allowed for this degree of freedom indicated these
additional parameters were effectively zero, so for simplicity we omit them from the beginning.


                                                15
                                      Figure 2: Model Timing



        t                                                                  t+1

             The regime  is               Period t shocks (orthogonal            The regime +1 is
             realized as a function       to regime realization  )               realized as a function
             of the previous period       are realized, and agent                of the previous period
             shocks and decisions,        decisions are made with a              shocks and decisions,
                               
             summarized by -1             probability distribution over                            
                                                                                 summarized by 
             and t-1.                     future regime realization              and t, etc.
                                                                 
                                          +1 , pinning down       and t.



descents into crises and their recoveries. For instance, negative values of the borrowing
cushion in the non-binding regime are possible if the probability of a binding regime is
elevated but such outcome is not realized; such an outcome will tend to postpone crisis
episodes. Conversely, in the non-binding regime, the logistic function can switch the
economy into the binding regime in the following period even if the borrowing cushion
in the current period is still positive; such an outcome accelerates the occurrence
of crises. How likely these outcomes are depend on the parameter of the relevant
logistic function, 0 . The same logic applies to a probabilistic exit from the binding
regime that depends on the multiplier t and the parameter 1 . The economy might
be stuck in the constrained regime past the time when the collateral constrained
multiplier turned negative, extending the duration of the crisis. In fact, in this case,
the economy may be "forced" to borrow the amount set by the constraint, which
might be more than desired, until a non-binding realization of the regime is drawn.
Conversely, despite positive values of the multiplier, the economy may end up coming
out of the binding regime early.
   The third implication of our setup is that, as the the transition probability are
endogenous, they are time-varying. In contrast, the exogenous Markov-switching
setup (Davig and Leeper, 2007; Farmer et al., 2011; Bianchi, 2013; Foerster et al.,
2016) has a constant probability of transitioning between regimes that is independent
of the structural shock realizations and the agent decisions. For this reason, our
endogenous-switching framework is capable of generating long- or short-lived-binding-
regime episodes depending on the realization of shocks and agents' decisions.
   Last but not least, in our set up, agents in the non-binding regime know that


                                                     16
higher leverage increases the probability of switching to the binding regime, and vice-
versa. This knowledge preserves the interaction in agents' behavior between the two
regimes and gives rise to precautionary behavior, distinguishing this class of models
from those in which financial frictions are always binding or are approximated with
solution methods that eliminate the interactions across regimes.


3     Solving the Endogenous Switching Model
This Section describes our solution method for endogenous regime-switching models.
The model proposed in the previous section can in principle be solved using global
methods, as for example in Davig et al. (2010). In the case of our application, with
two endogenous and five exogenous state variables, the regime indicator, plus six
exogenous shocks, using a global solution method would be extremely time consuming,
and it would quickly become prohibitive with larger modes, precluding likelihood-
based estimation. Instead, we solve the model using a perturbation approach, which
allows for an accurate approximation that is fast enough to permit estimation and
potentially applicable to larger frameworks beyond our medium-scale model. We now
describe the approximation point and how to define a steady state in this setup, the
Taylor-series expansions, and discuss the importance of approximating at least to
a second-order in our framework. The competitive equilibrium of the endogenous
regime-switching model is defined formally in Appendix A. The derivations of the
Taylor-series expansions and other details of the solution method are reported in
Appendix B.


3.1    Defining the Steady State
Given the regime-switching slackness condition (13), defining a non-stochastic steady
state of an endogenous regime-switching model is challenging. A steady state in this
setting can be defined as a state in which all shocks have ceased and the regime-
switching variables that affect the level of the economy ((st )) take the ergodic mean
associated with the steady state transition matrix:

                                  exp(-0 Bss )                  )
                                                       exp(-0 Bss
                            1-   1+exp(-0 Bss )                   )
                                                      1+exp(-0 Bss
                   Pss =        exp(-1 ss )               exp(-1 ss )   .         (17)
                               1+exp(-1 ss )
                                                  1   - 1+exp(-1 ss )


                                           17
Since this matrix depends on the steady state level of the borrowing cushion and the
             
multiplier, Bss and ss , which in turn depend upon the ergodic mean of the regime-
switching parameter (st ), such a steady state is the solution of a fixed point problem
that is described in more detail in Appendix B.
       More specifically, consider the model regime-specific parameters defined above and
distinguish between (st ), which affect the level behavior of the economy, and  (st ),
which affect only its dynamics with no effects on the steady state. Then denote with
 = [0 , 1 ] the ergodic vector of Pss . Next, apply the Partition Principle of Foerster
et al. (2016), to focus only on parameters that affect the level of the economy, and
write their ergodic mean of (st ), denoted ¯, as

                                   ¯ = 0  (0) + 1  (1) .                                    (18)

       Defining the steady state as the state in which the auxiliary parameter  (st ) is
at its ergodic mean value ¯ implies that the approximation point constructed is a
weighted average of the steady states of two separate models: a model in which only
the non-binding regime occurs, and one in which only the binding regime occurs. How
close our approximation point is to each of these two other steady states, therefore,
depends on the frequency of being in each of the two regimes. As in our application
episodes of binding regime have limited duration, the ergodic mean is a natural can-
didate as perturbation point. Given the nature of our application with slow-moving
capital and debt state variables, this perturbation point will be in the area of the
state space in which the economy operates most frequently. In fact, since the bind-
ing regime tends to be self-limiting­that is, being in the binding regime causes the
economy to reduce leverage and hence switch back to the non-binding regime­the
economy will rarely reach the area around the steady state of the "binding regime
only."12
  12
    Alternative methods for finding solutions to endogenous regime-switching models, such as Maih
(2015) and Barthlemy and Marx (2017), propose using regime-dependent steady states as multiple
approximation points. Such a strategy would not be suitable for our purposes because the binding
regime steady state is a poor approximation point given that the regime is infrequent and usually
of shorter duration than normal cycles of expansions and contractions.




                                               18
3.2    The Solution and Its Properties
Equipped with the steady state of the endogenous regime-switching economy, we
construct a second-order approximation to the policy functions by taking derivatives
of the equilibrium conditions. We relegate details of these derivations to the Appendix
B, but here we provide a summary.
   For each regime st , the policy functions of our model take the form

                  xt = hst (xt-1 , t , ) ,         yt = gst (xt-1 , t , ) ,        (19)

where xt denotes predetermined variables, yt non-predetermined variables, t the set
of shocks, and  a perturbation parameter such that when  = 1 the fully stochas-
tic model results and when  = 0 the model reduces to the non-stochastic steady
state defined above. Using these functional forms, we can express the equilibrium
conditions conditional on regime st as

                                    Fst (xt-1 , t , ) = 0.                         (20)

We then stack the regime-dependent conditions for st = 0 and st = 1, denoting the
resulting system of equations with F (xt-1 , t , ), and successively differentiate with
respect to (xt-1 , t , ), evaluating them at the steady state. The systems

             Fx (xss , 0, 0) = 0,    F (xss , 0, 0) = 0,      F (xss , 0, 0) = 0   (21)

can then be solved for the unknown coefficients of the first-order Taylor expansion of
the policy functions in equation (19).
   A second-order approximation can be found by taking the second derivatives of
                                                  (1)        (1)
F (xt-1 , t , ). In the end, we have matrices Hst and Gst characterizing the first-order
                   (2)        (2)
coefficients, and Hst and Gst characterizing the second-order coefficients. Therefore,
the approximated policy functions are

                                     (1)     1 (2)
                         xt  xss + Hs t
                                         St + Hs    (St  St )                      (22)
                                             2 t
                                              1 (2)
                          yt  yss + G(1)
                                      st St + Gst (St  St )                        (23)
                                              2

where St =    (xt-1 - xss )    t 1     .

                                             19
      Our perturbation method produces a single approximated set of policy functions,
but cannot be used to guarantee that the solution is unique. This limitation is
common to models of occasionally binding constraints that are solved globally with
converging numerical algorithms without guaranteeing uniqueness. With endogenous
regime-switching, we also lack conditions for ensuring stability of the full solution;
instead, we check the mean-squared stability of the first-order approximation paired
with the steady state transition matrix Pss (Farmer et al., 2011; Foerster et al., 2016),
and additionally check for explosive simulations.
      Our solution method is fast, and can readily be scaled to handle larger models. In
all, we have 23 equations that characterize the equilibrium, two endogenous and five
exogenous state variables, one regime indicator, and six shocks. Our computational
approach is similar to that in Fernandez-Villaverde et al. (2015): we use Mathematica
to take symbolic derivatives and export these derivatives so that we can use Matlab
to solve the model repeatedly for different parameterizations. The model solves in
about a second on a standard laptop.13
      The proposed solution method is also accurate. We tested for accuracy of the
proposed solution method applied to our model, as well as in the smaller model of
Jermann and Quadrini (2012) in which we can more easily compare our perturbation
method to with global solution methods. We find Euler equation errors for the model
we use in this paper on the order of $1 per $1,000 of consumption, a figure in line with
the accuracy of perturbation methods applied to exogenous regime-switching models
(Foerster et al., 2016) and standard models without regime-switching (Aruoba et al.,
2006). When we compare the perturbation method we propose with a standard
global method applied to the endogenous regime-switching version of the model in
Jermann and Quadrini (2012), or the same model with the inequality constraint, we
find that our solution methods produce similar second moments and model dynamics
for key variables of interest. Moreover, the global and perturbation solutions of
the endogenous regime-switching version of this model produce very similar Euler
equation errors­see Appendix C for more details.
 13
      A core code that demonstrates the solution algorithm is available on request from the authors.




                                                 20
3.3    Approximation Order, Endogenous Switching and Pre-
       cautionary Saving
Our endogenous regime-switching framework must be solved at least to the second
order to capture the effects of endogenous probabilities on the policy rules, which in-
clude state-varying precautionary effects. If we were to use only a first-order approx-
imation, our estimation would not capture precautionary behavior associated with
rational expectations about the dependency of the probability of a regime change on
the borrowing cushion and the multiplier. The following Proposition states this result
formally.

Proposition 1 (Irrelevance of Endogenous Switching in a First-Order Ap-
proximation). The first-order solution to the endogenous regime-switching model is
identical to the first-order solution to an exogenous regime-switching model in which
the transition probabilities are given by the steady-state value of the time-varying tran-
sition matrix.
Proof. See Appendix C.

    The Proposition illustrates that using a second-order approximation to the solu-
tion is necessary to characterize the model properties associated with the endogenous
nature of the regime-switching, including particularly precautionary behavior. This
result is similar to the one stating that, in models with only one regime, first-order
solutions are invariant to the size of shocks, second-order solutions captures pre-
cautionary behavior, and third-order solutions are needed to capture the effects of
stochastic volatility (Fernandez-Villaverde et al., 2015).
    Unfortunately, the need to use a second-order approximation along with regime-
switching creates additional challenges for estimation purposes. We now turn to our
strategy to address them.


4     Estimating the Endogenous Switching Model
We estimate the model with a full information Bayesian procedure. The posterior dis-
tribution has no analytical solution and we use Markov-Chain Monte Carlo (MCMC)
methods to sample from it. Since the Metroplis-Hastings algorithm that we use for
sampling is a standard tool used in the literature, we omit a discussion of this step in

                                           21
our procedure. The details of the construction of the state space representation and
the filtering steps for the evaluation of the likelihood are reported in Appendix D.
       A key obstacle in sampling from the posterior is the evaluation of the likelihood
function. We face three difficulties here relative to linear DSGE models. The first is
the non-linearity due to the presence of multiple regimes. The second is the need to
approximate to the second-order the model solution that governs the decision rules
in each regime. The third is the fact that the transition probabilities are endoge-
nous. Bianchi (2013) develops an algorithm to address the first difficulty. Here we
must use an alternative filter to deal with the second order solution and endogenous
probabilities in a tractable manner. We use the Unscented Kalman Filter (UKF)
to compute approximations to the evaluation of the likelihood function using Sigma
Points. An alternative would be to use the Particle Filter (Fernandez-Villaverde and
Rubio-Ramirez, 2007). However, the Particle Filter is not well-suited to our applica-
tion, because the regime switching can lead to discarding a large number of simulated
particles, lowering accuracy for a given number of particles and greatly increasing
the computational cost of obtaining a given level of accuracy. Further, even with a
deterministic filter, the filtering step in estimation is relatively costly at about 10 sec-
onds per likelihood evaluation using Matlab; incorporating the Particle Filter would
increase computing time significantly.14
       The model's posterior distribution is highly non-linear, with many local modes
due to the complexity of the model. To deal with this issue, we took the following
steps: first, we estimated a version of the model without working capital and the
occasionally binding constraint, this step yield an initial estimate of the exogenous
processes and the non-financial parameters; second, conditional on these initial esti-
mates, we performed a grid search over the remaining parameters (, , 0 , and 1 ) to
find high posterior regions; third, from the high posterior regions of the grid search,
we used a mode-finding routine to identify the posterior mode, which forms the basis
for our empirical results; lastly, we sampled 500, 000 times from the posterior with a
random-walk Metropolis-Hastings algorithm to explore the parameter space around
the mode and characterize credible sets for the parameter estimates.15
  14
     See Binning and Maih (2015) for a comparison between the Sigma Point filter and the Particle
Filter in a regime-switching context, which includes degeneracy issues.
  15
     For the last MCMC step, we adjusted the scale of the proposal density until we achieved an
acceptance rate of 0.25. The entire MCMC algorithm takes 58 days to complete.



                                               22
4.1       Observables, Data, and Measurement Errors
The model is estimated with quarterly data for GDP growth (gross output less inter-
mediate input payments), consumption growth, investment growth, and intermediate
import price growth, as well as the current account-to-output ratio, and a measure of
the country real interest rate. GDP, consumption, and investment are in quarterly,
demeaned log differences.16
       As there are six shocks with six observables, we do not need measurement errors.
However, measurement errors in the observation equation improves performance of
the non-linear filter and accounts for any actual measurement error in the data. To
limit their impact on the inference, we limit their variance to 5% of the variance of
the observable variables. This means that our model will fit the data relatively closely
on average; thus, how it performs across cycles and crises and whether it relies on
large shocks to fit the data will be important in assessing model performance.


4.2       Calibrated Parameters and Prior Distributions
Our objective is to estimate critical parameters governing the model's dynamics in
both the binding and non-binding regime, as well as the parameters that govern the
transitions between regimes on which we do not have any prior information. To
make inference on the parameters of interest while using relatively diffuse priors, we
calibrate a subset of parameters on which we have reliable prior information. We now
discuss our calibrated parameters, and then our use of priors in estimation.
       Table 1 lists the parameters that we calibrate.17 We set these parameters largely
following Mendoza (2010), who calibrated them based upon stylized facts from Mex-
ico's National Accounts, but adapted to our model specification. One parameter that
does not come from Mendoza (2010) is  , which we set to match the capital-to-output
ratio. Another important parameter that we calibrate is r , which is estimated in
Garcia-Cicco et al. (2010). We set it to a very small value for the sole purpose of elim-
inating the dependency of the steady state on initial conditions, while not allowing
the parameter to affect the model dynamics (see Schmitt-Grohe and Uribe, 2003).18
  16
     See Appendix F for details on variable definitions and data sources. The country interest rate is
constructed, following Uribe and Yue (2006), and it is the US 3-Month Treasury Bill minus ex post
US CPI inflation rate plus Mexico's EMBI Spread.
  17
     See Appendix E for more details on the calibration and the targeted data moments.
  18
     Even though we have a borrowing constraint and precautionary savings, the presence of r >


                                                 23
                           Table 1: Calibrated Parameters

                 Parameter               Description                 Value
                                       Discount Factor               0.9798
                                        Risk Aversion                2.0000
                                        Labor Supply                 1.8460
                                        Capital Share                0.3053
                                         Labor Share                 0.5927
                                      Depreciation Rate              0.0228
                    P                Mean Import Price               1.0280
                    E                Mean Expenditure                0.2002
                    r           Interest Rate Debt Elasticity        0.0010
                     ¯
                     B               Neutral Debt Level             -6.1170


Setting r to a very small value allows us to evaluate the model's ability to match
the behavior of the trade balance and the other key stylized facts of the data without
introducing an additional financial friction, in the form of a quantitatively important
endogenous component of the market interest rate in equations (5)-(6).
   Table 2 below summarizes our assumptions on the prior distributions. We set two
types of priors on the parameters to be estimated. The first type is priors directly on
the parameters. They impose sign restrictions and put lower prior probability on pa-
rameter values that generate implausible moments in model simulations. The second
type of prior is on a model-implied object: the steady state transition probability of
switching from the binding to to the non-binding regime, given by the steady state
                                             
value of equation (14), Pr(st+1 = 1|st = 0, Bss ). We set this prior to be a Beta distri-
bution with mean 0.25 and variance of 0.25. This prior puts lower probability mass
on combinations of parameters that either generate extremely infrequent transitions
to the binding regime, or that imply the economy exits the binding regime almost
immediately.19
0 serves the same purpose as endogenous discounting in Mendoza (2010). Recall here that our
perturbation solution is constructed around a point between the steady state of the "non-binding
regime", which depends on r , and the "binding regime".
  19
     Priors on model-implied objects have been used by, for example, Otrok (2001) and Del Negro
and Schorfheide (2008).




                                              24
                            Table 2: Estimated Parameters

 Par.            Description                  Prior                     Posterior
                                                            Mode       5%      50%        95%
                 Capital Adj.               N(10,5)         12.703   12.649 12.701       12.724
                Working Cap.                U(0,1)          0.7113   0.7102 0.7153       0.7207
    r          Mean Int. Rate            N(0.0177,0.01)     0.0172   0.0115 0.0165       0.0216
                   Leverage                 U(0,1)          0.1727   0.1592 0.1756       0.1989
    a          Autocor. TFP                B(0.6,0.2)       0.9796   0.9653 0.9793       0.9881
    e           Autocor. Exp               B(0.6,0.2)       0.9111   0.9066 0.9132       0.9237
    p        Autocor. Imp Price            B(0.6,0.2)       0.9711   0.9609 0.9754       0.9549
    d          Autocor. Pref.              B(0.6,0.2)       0.9810   0.9753 0.9810       0.9843
    r     Autocor. Persist. Int. Rate      B(0.6,0.2)       0.8929   0.8782 0.8896       0.8995
    a              SD TFP                IG(0.01,0.01)      0.0083   0.0066 0.0081       0.0098
    e              SD Exp.                IG(0.1,0.1)       0.1806   0.1672 0.1816       0.1892
    p          SD Imp. Price              IG(0.1,0.1)       0.0471   0.0382 0.0452       0.0524
    d              SD Pref.               IG(0.1,0.1)       0.1123   0.0998 0.1123       0.1194
    r        SD Trans. Int. Rate         IG(0.01,0.01)      0.0028   0.0013 0.0025       0.0044
    r       SD, Persist Int. Rate        IG(0.01,0.01)      0.0047   0.0037 0.0047       0.0059
    0      Logistic, Enter Binding         U(0,150)         13.552   10.903 13.712       18.014
    1       Logistic, Exit Binding         U(0,150)         17.798   15.784 17.800       19.806
Notes: Estimated parameters, with prior distribution and posterior moments. Priors are Normal,
Uniform, Beta, or Inverse Gamma; prior distributions show mean and variance, except for uniform
where lower and upper bounds are shown. Posterior distribution shows mode, along with 5-th, 50-th,
and 95-th percentiles from MCMC posterior draws.


5        Empirical Results
Our empirical findings comprise four sets of results. First, we present the estimated
parameters, which helps us to characterize the tightness of the working capital and
borrowing constraints, and the endogenous transition probabilities. Second, we exam-
ine the estimated model's fit to the data. Third, we examine the model's performance
from a business cycle perspective, comparing moments in the model and the data and
assessing the relative importance of different shocks for regular business cycles. Our
fourth set of results focuses on financial crises. We report and discuss the first three
sets of results in this section, and present the fourth set in Section 6.




                                               25
5.1    Estimated Parameters
For our first set of results focuses on the estimated parameters. Table 2 reports the
mode, the median, the 5th, and the 95th percentile of the posterior distribution of the
estimated parameters. The estimated mean interest rate, slightly below 1.75% per
quarter, is close to the value estimated by Mendoza (2010). Note that the posterior
coverage interval for this variable is fairly diffuse, indicating some uncertainty in its
true value. The remaining parameters have tightly estimated posteriors, so we will
focus the discussion on posterior modes for the remaining parameters.
   Importantly, the model provides precise estimates of critical parameters, namely
the investment adjustment cost, working capital, and leverage parameters, and the
parameters of the logistic function that help match the time series of the observable
variables during both business cycles and financial crises. These parameters cannot be
easily measured directly from stylized facts of the data­unlike, for example, capital or
labor shares­but are nonetheless important for explaining the behavior of the economy
and the amplification of shocks.
   The estimate of the investment adjustment cost parameter, , which controls in-
vestment volatility, is 12.7. This parameter is model dependent and has no real
interpretation outside of a particular model; for example, considering an annual fre-
quency, Mendoza (2010) calibrated this parameter to 2.75. The estimate for the
working capital constraint parameter indicates that 71% of the wage and interme-
diate good bill needs to be paid in advance with borrowed funds; this estimate is
substantially higher than the 25.79% value set by Mendoza (2010), but much lower
than the 100% used by Neumeyer and Perri (2005) or the 125% used by Uribe and
Yue (2006). The estimate is close to the 60% calculated by Ates and Saffie (2016),
who use interest payments and production costs from Chilean microeconomic data.
The estimated value of the leverage parameter in the borrowing constraint () is 0.17,
indicating less than a fifth of the value of capital serves as collateral. The estimate is
slightly tighter than the benchmark value of 0.20 chosen by Mendoza (2010), which
is is right inside the confidence set, and on the low end of the 0.15 to 0.30 range of
alternative values considered in that calibration.
   The posterior modes of the logistic parameters in equations (14) and (15) are
13.6 and 17.8, respectively, estimated in a tight range relative to the very loose prior.
These estimates are significantly different from zero, thus suggesting that the data


                                           26
   Figure 3: Logistic Functions and Distributions of Their Arguments
  (a) Borrowing Cushion and Transition Probability in Non-Binding Regime




          (b) Multiplier and Transition Probability in Binding Regime




   Note: The top panel shows the model-implied distribution of the borrowing cushion B 
   in the non-binding regime, and the logistic transition function to the binding regime as
   in equation (14) implied by our estimates. The bottom panel shows the model-implied
   distribution of the multiplier  in the binding regime, and the transition function to the
   non-binding regime as in equation (15) implied by our estimates.


reject a model specification in which the transition probabilities are exogenous, which
is in principle allowed for under the prior distribution.
   Figure 3 plots the implied probabilities from equation (14) and (15), evaluated at
the posterior mode value of 0 and 1 , together with the estimated ergodic distribu-
tions of their arguments, the borrowing cushion, B  and the the constraint multiplier,
. The figure shows that the ergodic distribution of the borrowing cushion is cen-
tered on a positive value, as the economy spends most of its time in the non-binding
regime, above the borrowing limit. As the borrowing cushion falls, the probability
of switching to the binding regime increases, and gradually reaches 1 for small neg-
ative values, with very little probability mass on large negative realizations of the
borrowing cushion.

                                              27
   On the other hand, once the economy is in the binding regime, the ergodic distri-
bution of the multiplier is centered on small negative values, with more probability
mass on the right tail than the left tail. As  approaches 0, the probability of switch-
ing to the non-binding regime increases and quickly reaches 1, with a mode on a small
negative value. Nonetheless, the there is a significant probability mass for larger neg-
ative values. As we explained earlier, negative values of  reflect instances in which,
had the economy been in the non-binding regime, the borrowing cushion would be
positive (as a result of the shock realizations and agent decisions as illustrated in
Figure 2), but a switch to the non-binding regime at has not been drawn yet.20


5.2     Model Fit
Our second set of results provides evidence on how the estimated model fits the
observable variables. The model fit is summarized by Figure 4, which plots observable
variables used in the estimation together with the fitted values. The Figure also
includes the peaks of the model-identifed crises (red bars), which we define and discuss
in more detail in Section 6 and are the trough quarters of the model-identified crisis
episodes. The fitted series tracks the actual data very closely. Importantly, the model
estimates track the data consistently throughout the sample, during both regular
business cycle and crisis periods. For example, around the 1995 "Tequila Crisis," the
data show large drops and rebounds in output, consumption, and investment growth,
and a very sharp reversal in the current account to output ratio. If, by contrast, one
were to observe a loss of fit during crisis episodes, it would suggest that our estimated
model finds it difficult to match the data dynamics during these episodes of critical
interest in the empirical analysis. As additional results reported in Appendix G on
the estimated structural shocks illustrate, the estimated model fits the data without
relying on large shocks. Instead, it explains crisis dynamics using the model's internal
propagation mechanisms that amplify the effects of usual sized shocks.
  20
     Sufficiently negative values of , approximately below -0.2, produce a nearly deterministic
switch back to the binding regime. The ergodic distribution of  in the binding regime (Figure 3b)
implies that the probability of exiting that regime exceeds 99% about 1/4-th of the time.




                                               28
                        Figure 4: Data and Model Estimates
                                     (a) Output Growth




                                 (b) Consumption Growth




                                   (c) Investment Growth




                                       (d) Interest Rate




                          (e) Current Account to Output Ratio




                                  (f ) Import Price Growth




Note: The figure plots observable variables used in estimation (dashed blue lines) and fitted values
(i.e., model implied smoothed estimated series based upon the full sample, solid black lines). Red
bars indicate model-identified periods of crisis, see text for definition.



                                                29
              Table 3: Simulated Second Moments: Data and Model

                                                    Relative Std. Dev.         Correlations
           Data Series                              Data      Model           Data Model
           Output Growth                            1.00       1.00           1.00    1.00
           Consumption Growth                       1.25       1.92           0.73    0.98
           Investment Growth                        5.37       5.75           0.53    0.90
           Trade Balance to Output Ratio            1.24       0.80           -0.20 -0.21
           Country Interest Rate                    1.36       0.15           -0.11 -0.03
          Notes: The table compares second moments of the data, relative to the same mo-
          ments simulated from the model.


5.3       The Anatomy of Business Cycles
In our third set of results, we discuss second moments to characterize the estimated
model dynamics and variance decompositions to identify key drivers of the business
cycle.21 All statistics reported are unconditional, rather than conditional on a par-
ticular regime.
       Table 3 compares data and simulated model second moments, reporting results for
three variables used in estimation (output, consumption, investment and the country
interest rate), and one critical variable, the trade balance ratio, not used in estimation.
The model matches the business cycle moments quite well, fitting both the relative
volatilities and the correlations with output. The volatility ranking is correct, with
consumption significantly more volatile than output, which is a robust stylized fact of
emerging market business cycles. The model underestimates the relative volatility or
the trade balance ratio and, particularly, the country interest rate. The model implied
comovements of all variables match the data counterparts remarkably well, again
with the exception of the country interest rate, whose correlation is not estimated
precisely in the model. The trade balance, in particular, which is not an observable
variable used in estimation, is counter-cyclical as in the data, with a model-implied
autocorrelation coefficient (not reported) well below one.
       Table 4 reports variance decompositions. The table illustrates that all shocks play
a quantitatively sizable role in the model, even though different shocks matter more
  21
    All business cycle and crisis statistics in this and the following section relying on simulated data.
For these simulations, based on the posterior mode estimates, we generate 10,000 samples of 144
quarters length (the same as our data sample), after a burn-in period of 1,000 quarters. We then
compute and report median values across these 10,000 runs. We use a pruning method (Andreasen
et al., 2018) to avoid explosive simulation paths.


                                                   30
         Table 4: Estimated Unconditional Variance Decomposition

                                                 Import               Temp.        Pers.
    Variables / Shocks      TFP      Expend.      Prices   Pref.    Int. Rate    Int. Rate
    Output                  33.2      17.2         15.7    25.4        2.5           6.0
    Consumption             30.3      23.4         14.3    20.6        3.8           7.6
    Investment              19.2      29.8         10.3    25.6        4.6          10.5
    Trade Bal/Output         9.5      35.2         8.8     17.2        9.2          20.1
    Interest Rate            0.0       0.0         0.0      0.0        21.1         78.9
    Borrowing Cush.         10.6      32.3         9.9     21.3        9.9          16.0
    Debt/Output             15.2      25.5         7.6     40.9        1.4           9.5
    Multiplier               9.5      40.5         9.5     18.1        9.6          12.8
Note: The variance decomposition is normalized to sums to 100 by row; estimates may not add up to
100 exactly due to rounding. The decomposition is computed by setting each shock to zero to com-
pute its marginal impact on each variable. The computation abstracts from non-linear interactions
across shocks for ease of comparison with linear models.


for different variables. Output and consumption are mostly driven by productivity,
preference, expenditure, and terms of trade shocks, respectively. Investment is signifi-
cantly affected by expenditure, preference, productivity, terms of trade, and persistent
interest rate shocks. Expenditure and persistent interest rate shocks are the most im-
portant drivers of the trade balance, while the country interest rate is clearly driven
by persistent interest rate shocks, and to a lesser extent by the temporary component
of the cost of borrowing. Demand shocks (expenditure and preference) and interest
rate shocks (permanent and temporary components) play a more important role than
productivity and terms of trade shocks for financial variables and the multiplier.
   While the magnitude of these variance shares are not directly comparable with
those estimated by Garcia-Cicco et al. (2010), Fernandez and Gulan (2015), and
Schmitt-Grohe and Uribe (2018), they suggest that both real and financial shocks
matter for Mexico business cycles. In particular, we find a lower share for productivity
and interest rate shocks than Fernandez and Gulan (2015), although we also consider
terms of trade and demand shocks. We also find a share of variance explained by
terms of trade shocks that is very close to the structural vector autoregression model
estimated by Schmitt-Grohe and Uribe (2018). The estimated share of the variances
explained by interest rates shocks is in general smaller than those estimated by Garcia-
Cicco et al. (2010), who use a different specification of the financial friction with
a debt elastic country premium and a risk premium shock, without amplification

                                               31
mechanism from the financial accelerator (Fernandez and Gulan, 2015), or working
capital (Neumeyer and Perri, 2005; Mendoza, 2010; Fernandez and Gulan, 2015; Ates
and Saffie, 2016).


6        The Anatomy of Financial Crises
In this Section, we turn to our fourth and main set of empirical results, which examine
the model's ability to describe and interpret financial crises. The defining feature of
our model is its ability to characterize dynamics and identify shocks not only over
regular business cycles, but also during periods of a particular type of crisis, the
so-called sudden stop in capital flows. We start by defining financial crises episodes
in a model consistent manner and discuss the inference that we can draw based on
the estimated model about when Mexico appeared to be experiencing them. Next,
we investigate the drivers of the three historical episodes of sudden stop that the
estimated model identifies in the data: the Debt Crisis of the 1980s, the 1995 `Tequila'
Crisis, and the spillover of the Global Financial Crisis (GFC) in 2008-2009. Then we
study the model-implied duration and frequency of these episodes in simulations.
Finally, we illustrate the model-based dynamics of sudden stop episodes of duration
comparable to those realized over Mexico's recent history.


6.1       Model-based Definition and Estimates of Sudden Stop
          Episodes
The estimated model allows us to make inference on whether the economy is in
the binding regime, and hence identify periods of sudden stop crisis in a model-
consistent manner. In the model, the regime is known by the household-firm, but the
estimation procedure does not observe the regime, and it must be inferred based on
the information in the data. The estimation results, therefore, can provide a time-
varying estimate of the (smoothed, i.e. based upon the full sample) probability of
being in each regime. Figure 5 plots this estimated probability (solid black line).22
       Using the information in Figure 5, we can provide a model-consistent definition of
  22
    The estimated model also provides an estimate of the time-varying transition probability based
upon equations (14-15). These are reported in Appendix G and confirm that an exogenous regime
switching specification would be rejected by the data.



                                               32
                Figure 5: Mexico's Model-identified Crisis Episodes
         (a) Probability of Binding Regime and Reinhart-Rogoff Tally Index




                   (b) Probability of Binding and OECD Recessions




Notes: Black line shows the model implied smoothed probability of being in the binding regime. The
dark gray regions in panel (a) indicates Reinhart and Rogoff (2009) tally index of financial crisis,
normalized so that it takes values between 0 (no crisis) and 6 (most severe). Light gray regions in
panel (b) indicate OECD recession dates for Mexico. Red bars indicate model-identified crisis peaks,
vertical blacked dash lines indicate the beginning and the end of the estimated crisis episodes; see
text for details.


a crisis quarter as one in which the economy is in the binding regime with probability
higher than at least a 90% probability.23 A crisis episode can then be defined as a
sequence of such periods. For reference, we also identify the peaks of crisis episodes
(red bars) as periods in which (i) the smoothed estimate of the probability of being in
the binding regime is at least 90%, (ii) the model estimate of output growth (Figure
4, Panel a) is negative by more than one standard deviation, and (iii) the model
estimate of the current account ratio (Figure 4, Panel e) increases by more than one
standard deviation.24
       Figure 5 shows that the model identifies three crisis episodes (start and end quar-
ters marked by vertical dashed lines). The first is the Debt Crisis, which the model
identifies as occurring from 1981:Q3-1983:Q2, with an associated peak in 1983:Q1.
The second episode is the Tequila Crisis, which the model identifies in 1994:Q1-
  23
     This threshold is intuitive but somewhat arbitrary. The duration of the identified sudden stop
episode identified, however, is robust to using a wider range of values.
  24
     As Figure 4 shows, the identified peak crises periods corresponds to the trough in output,
consumption, investment growth in the data, and the peaks in the current account adjustment and
interest rate increases. The definition of these crisis peaks in line with the one employed in the
quantitative literature modeling sudden stops with occasionally binding constraints (for example,
Mendoza, 2010; Benigno et al., 2013).



                                                33
1996:Q1, with its peak in 1995:Q1-Q2. Last, the model identifies the GFC as produc-
ing a crisis in Mexico during 2008:Q4-2009:Q3, with a peak in 2009:Q1-Q2. Figure
5 also reports a purely empirical definition of financial crisis (dark grey shaded areas
in Panel a) and the OECD dating of the business cycle of Mexico (light grey shaded
areas in Panel b). The empirical notion of financial crisis reported is a normalized
version of the crisis tally index of Reinhart and Rogoff (2009) (RR).25 Figure 5 il-
lustrates that our estimated probability of being in a binding regime, which is our
model-consistent definition of crisis, align quite well with the RR tally index. The
crises episodes that our model identifies track the RR tally index remarkably well in
the case of the Tequila and GFC episodes, and are much more persistent than the
crisis peaks typically identified in the sudden stop literature. This result is consistent
with the idea that our stochastic specification of the borrowing constraint better char-
acterize how lending limits applies to households and firms in the data. Our model's
crisis signal is less persistent than the tally index in the aftermath of the Debt crisis.
This is to be expected, however, as our model economy is not designed to capture
debt overhang or financial intermediation disruptions that drive the classification of
RR between 1983 and 1989 and in the mid-1990s.
       Importantly, our model estimates of these sudden stop episodes do not mistake
ordinary recessions, not associated with spikes in the tally index, for crisis periods.
Mexico OECD recessions are illustrated by the light dark shaded areas in Figure 5
Panel (b). The estimated probability of a binding regime is close to 0 during the
OECD recessions before the Tequila crisis, during the US recession in 2001, and the
Argentine crisis in 2000-2001. The estimated probability of a binding regime also
does not register stress during the 1998 Russian default and US Long-Term Capi-
tal Management debacle that affected only the currency and stock market, without
triggering a sudden stop in Mexico.
       Overall, Figure 5 shows that our model provides an accurate signal of when the
economy is likely to have experienced a crisis, without mistaking regular recessions or
large currency and stock market movements for financial crisis episodes. In the rest
  25
    The RR tally index ranges from 0 to 6, depending on whether a country-year observation is
deemed to be in one or more of the following 6 varieties of crisis, assigning the value of one if a
variety is present: Currency, Inflation, Stock Market, Sovereign Domestic or External Debt, and
Banking Crisis. See Chapter 1 of Reinhart and Rogoff (2009) for more details. We follow their
methodology to extend the index to cover our full sample. In Figure 5, the index is normalized to
range between 0 and 1.



                                                34
of this section, we study the model-implied properties of these crises episodes­first
examining which shocks drove the three identified episodes in Mexico's history, and
then studying the frequency and duration and dynamics of model-implied episodes
based on simulations.


6.2    Drivers of Mexico's Sudden Stop Episodes
Our estimated model fits Mexican data well (Figure 4), including during the crisis
episodes identified in Figure 5. We now examine the sudden stop episodes identified
by the estimated model, evaluating the relative importance of different shocks driving
the economy before, during and after the Debt Crisis of the early 1980s, the Tequila
Crisis of 1994-1995, and the spillover on Mexico from the GFC that originated in
the United States in 2008-09. This exercise is possible because we have a likelihood-
based estimation of the model that produces sequences of shocks, allowing for the
construction of such historical counterfactuals.
   The multiple sources of non-linearity in our estimated model, the endogenous
regime-switching plus the second-order approximation, pose a challenge for computing
historical counterfactuals. The task is complicated by the fact that shocks not only
have non-linear effects on the endogenous variables, but also on the realization of the
regimes in subsequent periods. Therefore, rather than decomposing the change in
endogenous variables such as output, we will focus on a broader summary measure,
the importance of each shock in terms of model fit, and hence likelihood.
   Specifically, we counterfactually recalculate the model likelihood, evaluated at the
posterior mode, turning one shock off at the time, while leaving all other shocks
at their estimated values, over a particular sub-sample periods. As the variance
decomposition in 4 showed, each shock plays a role in explaining fluctuations un-
conditionally, with different shocks potentially explaining different variables. Here,
we compute the loss of model fit as measured by the log-likelihood change when we
turn off one particular shock in a given quarter, and repeat the calculation for all six
structural shocks. The details of this calculation are in Appendix G.2.
   Table 5 reports a likelihood-based measure of relative importance. As Appendix
G.2 documents, the measure is the importance of a shock in a given period relative
to all shocks in the model, relative to their importance over the full sample. "Impor-
tance" is assessed in terms of likelihood point loss when the shock considered is set to


                                          35
  Table 5: Estimated Relative Importance of Shocks in Mexico's Crises

                                                              Imp.             Trans     Persist
   Time Period                              TFP        Exp.   Prices   Pref   Int Rt.    Int Rt.
   1983 Debt Crisis
   Two Quarters Prior (81:Q1-Q2)            0.4        0.4     0.7     -3.2     0.9        0.8
   During Crisis (81:Q3-83:Q2)              0.4        5.3     -2.0    -2.8      0.0       -0.8
   Two-years After (83:Q3-85:Q2)            0.8        1.0     -0.6     0.2     -0.7       -0.7

   1995 Tequila Crisis
   Two-years Prior (92:Q1-93:Q4)            -0.1       -1.0    0.4     0.7       0.1       -0.1
   During Crisis (94:Q1-96:Q1).             -2.2       -0.7    0.5     1.3       0.2        0.9
   Two-years After (96:Q2-98:Q1)            -0.1       -0.2    0.2     1.1      -0.6       -0.4

   2009 Global Fin. Crisis
   Two-years Prior (06:Q4-08:Q3)            -0.7       2.1     -0.7    -0.2     -0.7       0.2
   During Crisis (08:Q4-09:Q3).             0.2        -1.2    0.3     0.5      0.2        0.0
   Two-years After (09:Q4-11:Q3)            -0.4       -1.1    0.4     0.8      0.1        0.1
Note: The table reports a likelihood-based measure of the importance of each shocs relative to all
shocks in the model, during different subperiods, compared to their average relative importance over
the full sample, in percentage point differences. For example, a value of +1 indicates the shock has
a 1 percentage point greater relative importance in the subsample relative to its average relative
importance over the full sample, and indicates a change in the log-likelihood of about 5 points, on
average. See Appendix G.2 for details. Bold font highlight the most important shocks in each period
according to this metric. Prior period for the 1983 Debt Crisis is limited by the data sample length.


zero. For each of the three crisis episodes, we consider the crisis episodes themselves,
as well as two years before and two years after the episode. Positive (negative) num-
bers denote relatively more (less) important shocks in a given period. For example, a
value of +1 means that the shock is relatively more important in that period relative
to its average importance over the full sample. A one percentage point change implies
a change in the log-likelihood by about 5 log points, on average. By definition, the
percentages in Table 5 sum by row.
    Consider first the Debt Crisis. Since this episode starts right at the beginning
of the sample period, we can only look at the two quarters before its start. The
counterfactual analysis suggests that in the immediate run up, the most important
shocks were imported intermediate input prices and both temporary and persistent
interest rate shocks, consistent with the drop in oil prices starting in 1981 and the
Volcker disinflation in the United States. The crisis episode itself and its aftermath

                                                  36
appears driven by the expenditure and technology shocks, possibly reflecting the im-
port and fiscal contraction typically associated with a sudden stop and its aftermath,
and the loss of efficiency associated with sudden adjustment of expenditure plans due
to tighter financial frictions.
       Next, consider the Tequila Crisis. Our estimated model identified a peak crisis
lasting for two quarters in 1995:Q1-Q2. According to our counterfactual results,
in the run up to this crisis episode, the most important drivers were the preference
shock and imported input price shocks. The importance of these two shocks increases
during the crisis episode, even though the shock to the persistent component of the
interest rate also becomes more important. The likelihood weight of preference and
interest rate shocks declines after the crisis, while the weight in the likelihood of the
technology shocks increases during this phase in relative terms. In the post-crisis
period, the preference shock continues to play a role, while the importance of shocks
to both components of the interest rate decline markedly.
       Lastly, consider the GFC episode. The counterfactual likelihood analysis suggests
that, before the crisis, expenditure and to a lesser extent a shock to the persistent
component of the interest rate were the most important drivers. This is consistent
with the lax international financial conditions, strong external demand, and possibly
loose fiscal domestic policy prevailing before the GFC. However, all other shocks
become more important during the crisis episode itself. In the aftermath of the
episode, the likelihood weight of the import price shock and temporary interest rate
shock diminishes, while that of the preference and persistent interest shocks increases.


6.3       Duration and Frequency of Simulated Crisis Episodes
We now look at the duration and frequency of crisis episodes simulated from the
estimated model, shown in Figure 6.26 The estimated model generates substantial
heterogeneity in crisis duration and frequency. Panel (a) is an histogram of simulated
crisis episodes. Given that the shortest of the three estimated crisis episode, the GFC,
lasted four quarters, here we consider episodes in which the economy is in the binding
regime for at least four consecutive quarters. The average conditional duration is 4.95
  26
    We simulate 10,000 samples of 144 quarters length, as in our data sample. Note, however, that in
these simulations the household-firm always knows in which regime the economy is without sampling
uncertainty. Therefore, there is no uncertainty about being in the binding regime, in contrast to the
econometrician's perspective reported in Figure 5.


                                                 37
         Figure 6: Model-simulated Crisis Duration and Frequency
(a) Conditional Duration: Crisis Episodes of at least Four Consecutive Quarters




         (b) Frequency of Crisis Episodes of Any Duration per Sample




             (c) Number of Quarters in Binding Regime per Sample




   Note: Histograms of the model-implied (a) conditional crisis duration, (b) frequency of
   distinct episodes of any duration in 144 quarter-long samples, and (c) number of quarters
   in the binding regime in 144 quarter-long samples.


consecutive quarters in the binding regime. Some of the simulated episodes last up to
22 consecutive quarters though, but they are rare events, as they make up less than
a half-percent of all crisis episodes.
   Panel (b) counts of crisis episodes of at least four quarters per sample period of 144
quarters length. The most common occurrence is four distinct crisis episodes that is
close to our estimation results, which show three distinct events in Mexico's history.
However, there is significant heterogeneity, as some samples have no episodes at all,
while others experience as many as eight-ten events of short duration per sample.
   Building on Panels (a) and (b), Panel (c) counts the total number of quarters

                                              38
in crisis episodes out of 144. The model-implied mean is 21.5 quarters, consistent
with our estimates in Figure 5, indicating that Mexico spends 21 quarters in crisis on
average. The standard deviation, however, is about 10 quarters, with a long right-tail
and a maximum of 62 quarters in the binding regime.27


6.4       Dynamics of Model-simulated Crisis Episodes
We finally turn to model-simulated crisis dynamics shown in Figure 7. As the more
severe historical episodes of sudden stop identified in Figure 5 in the early 1980s and
mid-1990s lasted about 8 quarters, we report results for episodes of such duration. The
Figure plots the model dynamics during crisis episodes of eight consecutive quarters
(starting at t = 0 and ending at t = 7, vertical dashed lines), as well as 5 years (20
quarters) before the beginning of the episode and 10 years (40 quarters) after the end
of the event. Variables are in log-levels, normalized to zero at the beginning of the
pre-crisis period that is time t = -20.
       Figure 7 shows the distinctive combinations of shocks that drive the economy
before, during and after the crisis episode. Crisis episodes are preceded by a long-
lasting "boom" phase, driven by improving technology and a favorable international
environment, with improving terms of trade and a persistently lower component of
the market interest rate. These three forces drive the expansion gradually, with
increasing output, consumption and investment, in a manner consistent with empirical
characterizations of the boom phases of financial crises (Boissay et al., 2016).
       The economy enters the crisis episode at t = 0, after a final acceleration, driven by
an increase in expenditures and a fall in patience. The crisis episode is precipitated
by a sudden reversal of the favorable external environment that drove the boom
phase. During the crisis episode, imported intermediate inputs and the market cost of
funding increase; the effective cost of borrowing spikes, driven by the external finance
premium on debt (EFPD). Technology stagnates and patience increases sharply. The
constraint on borrowing limits consumption smoothing and curtail the output supply
through the working capital constraint, causing output, consumption and investment
to drop sharply. The output drop from peak to through is eight percentage points,
  27
    Also, when we compute frequency statistics for simulated crisis peaks­the analogous to the red
bars in Figure 5­we find a mean frequency of about 2.4% of the quarters in the binding regime, very
close to the typical estimates in the empirical literature on sudden stops (Calvo et al., 2006), but
with significant heterogeneity (results not reported).


                                                39
                       Figure 7: Dynamics of Crisis Episodes
      (a) Technology                  (b) Import Prices                  (c) Expenditure




         (d) Preference             (e) Persist. Int. Rate             (f ) Temp. Int. Rate




          (g) Output                   (h) Consumption                    (i) Investment




           (j) CA/Y                        (k) TB/Y                           (l) EFPD




Notes: The figure plot model-simulated dynamics during crisis episodes of eight quarters, five years
(20 quarters) before the crisis, and 10 years after the crisis (40 quarters). The economy is in the
binding regime from period t = 0 to period t = 7 (vertical dashed lines). The plotted dynamics in
panels are medians across all crisis episodes identified, in log-levels setting t - 20 = 0.


in line with what observed during the Tequila crisis. The trade-balance-to-output
ratio suddenly reverts, improving persistently during the crisis phase, after a sharp
deterioration right before the beginning of the event, by about six percentage points as
a share of output from trough to peak. In line with these dynamics, the autonomous
component of expenditure continues to increase during the crisis period, which can
be interpreted in terms of the import compression typically associated with sudden
stops.
    The economy rebounds quickly from these crisis episodes, but only partially, re-
covering only half of the ground lost during the crisis or about 4 percentage points.

                                                40
After the initial rebound, a combination of persistently adverse external and internal
circumstances coalesces to produce a protracted output decline, as we can see in the
Mexican data after the Debt crisis, and also in line with empirical evidence on the
long-term consequences of financial crises in other emerging markets in (Cerra and
Saxena, 2008). The cost of borrowing and intermediate imported inputs remains ele-
vated for an extended period of time after the crisis episode. The productivity decline
is very long lasting, reaching a significantly lower level compared to before the begin-
ning of the boom phase of the crisis. Expenditure and patience also do not recover to
pre-crisis levels ten years after the end of the episode. During the post-crisis period,
investment and to a lesser extent consumption stagnate below their pre-crisis levels
(Benigno and Fornaro, 2017). As a result, the trade balance remains above its the
pre-crisis level long after the crisis has ended.


7     Conclusions
In this paper we propose a new approach to specifying and solving Dynamic Stochastic
General Equilibrium models with occasionally binding frictions that is suitable for
structural estimation. This permits estimating such models using full information
methods, obtaining estimates of critical model parameters and conducting likelihood-
based inference and counterfactual experiments. The critical step in our approach is
to specify the occasionally binding nature of the friction stochastically, so that the
formulation can be mapped into an endogenous regime-switching model.
    We apply this new approach to a workhorse medium-scale model of financial crises,
the so-called sudden stops in capital flows, and estimate it with Bayesian methods
on quarterly data for Mexico since 1981. We find that the estimated model fits
Mexico's business cycle and crisis episodes well, critical parameter estimates differ
from values previously used in the literature, and that different shocks matter for
different variables and phases of financial crisis dynamics. In particular, we show that
the model can generate heterogeneous crisis episodes of varying duration, frequency,
and intensity. Specific combinations of shocks typically drive the economy before,
during, and after crisis episodes, helping to explain why calibrated models of emerging
market business cycles perform better assuming that productivity and interest shocks
are negatively correlated. Finally, we document that our estimated model identifies
sudden stops that are longer lasting and more in line with narratives of Mexico's

                                            41
history of financial crises than those typically simulated with traditional inequality
specifications of the collateral constraint.
   We regard the estimation of larger models­including those with nominal or labor
market frictions, those with permanent and temporary productivity shocks over longer
sample periods, those with financial intermediation or equilibrium default, and those
that embed endogenous probability of infection­as important areas of future research.
Such models would be useful lenses to understand episodes like the Great Depression,
the Global Financial, and the COVID-19 Crises.


References
Adam, K. and R. M. Billi (2007). Discretionary Monetary Policy and the Zero Lower
 Bound on Nominal Interest Rates. Journal of Monetary Economics 54 (3), 728­752.
Aguiar, M. and G. Gopinath (2007). Emerging Market Business Cycles: The Cycle
  Is the Trend. Journal of Political Economy 115, 69­102.
Alpanda, S. and A. Ueberfeldt (2016). Should Monetary Policy Lean Against Housing
  Market Booms? Staff Working Papers 16-19, Bank of Canada.
Andreasen, M. M., J. Fernandez-Villaverde, and J. F. Rubio-Ramirez (2018). The
 Pruned State-Space System for Non-Linear DSGE Models: Theory and Empirical
 Applications. Review of Economic Studies 85 (1), 1­49.
Aportela Rodriguez, F., J. A. A. Ituarte, and Y. C. Aguayo (2001). Comportamiento
 Histrico de Las Tasas de Inters Reales en Mxico: 1951-2001. Documento de Inves-
 tigacin (Working Paper) No. 2001-0, Direccin General de Investigacin Econmica,
 Banco de Mexico.
Arellano, C., Y. Bai, and P. Kehoe (2019). Financial Frictions and Fluctuations in
  Volatility. Journal of Political Economy 127 (5), 2049­2103.
Aruoba, B., P. Cuba-Borda, and F. Schorfheide (2018). Macroeconomic Dynamics
  Near the ZLB: A Tale of Two Countries. Review of Economic Studies 85 (1), 87­
  118.
Aruoba, S. B., J. Fernandez-Villaverde, and J. F. Rubio-Ramirez (2006). Compar-
  ing Solution Methods for Dynamic Equilibrium Economies. Journal of Economic
  Dynamics and Control 30 (12), 2477­2508.
Ates, S. and F. Saffie (2016). Fewer but Better: Sudden Stops, Firm Entry, and Finan-
  cial Selection. International Finance Discussion Papers 1187, Board of Governors
  of the Federal Reserve System (U.S.).

                                               42
Atkinson, T., A. W. Richter, and N. Throckmorton (2018). The Zero Lower Bound
  and Estimation Accuracy. Working Papers 1804, Federal Reserve Bank of Dallas.

Barthlemy, J. and M. Marx (2017). Solving Endogenous Regime Switching Models.
  Journal of Economic Dynamics and Control 77 (C), 1­25.

Benigno, G., H. Chen, C. Otrok, A. Rebucci, and E. Young (2013). Financial Crises
  and Macro-Prudential Policies. Journal of International Economics 89 (2), 453­
  470.

Benigno, G., H. Chen, C. Otrok, A. Rebucci, and E. R. Young (2016). Optimal Capital
  Controls and Real Exchange Rate Policies: A Pecuniary Externality Perspective.
  Journal of Monetary Economics 84 (C), 147­165.

Benigno, G. and L. Fornaro (2017). Stagnation Traps. mimeo.

Bi, H. and N. Traum (2014). Estimating Fiscal Limits: The Case Of Greece. Journal
  of Applied Econometrics 29 (7), 1053­1072.

Bianchi, F. (2013). Regime Switches, Agents Beliefs, and Post-World War II U.S.
  Macroeconomic Dynamics. Review of Economic Studies 80 (2), 463­490.

Bianchi, F. and C. Ilut (2017). Monetary/Fiscal Policy Mix and Agents' Beliefs.
  Review of Economic Dynamics 26, 113­139.

Bianchi, F., C. Ilut, and M. Schneider (2018). Uncertainty Shocks, Asset Supply and
  Pricing over the Business Cycle. Review of Economic Studies 85 (2), 810­854.

Bianchi, J. and E. G. Mendoza (2018). Optimal Time-Consistent Macroprudential
  Policy. Journal of Political Economy 126 (2), 588­634.

Binning, A. and J. Maih (2015). Sigma Point Filters for Dynamic Nonlinear Regime
  Switching Models. Working Paper 2015/10, Norges Bank.

Binning, A. and J. Maih (2017). Modelling Occasionally Binding Constraints Using
  Regime-Switching. Working Paper 2017/23, Norges Bank.

Bocola, L. (2016). The Pass-Through of Sovereign Risk. Journal of Political Econ-
  omy 124 (4), 879­926.

Boissay, F., F. Collard, and F. Smets (2016). Booms and Banking Crises. Journal of
  Political Economy 124, 489­538.

Calvo, G. A., A. Izquierdo, and E. Talvi (2006). Sudden Stops and Phoenix Miracles
  in Emerging Markets. American Economic Review 96 (2), 405­410.



                                        43
Campello, M., J. R. Graham, and C. R. Harvey (2010). The Real Effects of Fi-
  nancial Constraints: Evidence from a Financial Crisis. Journal of Financial Eco-
  nomics 97 (3), 470­487.

Cerra, V. and S. C. Saxena (2008). Growth Dynamics: The Myth of Economic
  Recovery. American Economic Review 98 (1), 439457.

Chodorow-Reich, G. and A. Falato (2017). The Loan Covenant Channel: How Bank
 Health Transmits to the Real Economy. Working Papers 23879, NBER.

Cuba-Borda, P., L. Guerrieri, M. Iacoviello, and M. Zhong (2019). Likelihood Evalu-
 ation of Models with Occasionally Binding Constraints. Journal of Applied Econo-
 metrics 34 (7), 1073­1085.

Davig, T. and E. Leeper (2007). Generalizing the Taylor Principle. American Eco-
  nomic Review 97 (3), 607­635.

Davig, T. and E. M. Leeper (2008). Endogenous Monetary Policy Regime Change.
  In NBER International Seminar on Macroeconomics 2006, NBER Chapters, pp.
  345­391. National Bureau of Economic Research, Inc.

Davig, T., E. M. Leeper, and T. B. Walker (2010). "Unfunded Liabilities" and
  Uncertain Fiscal Financing. Journal of Monetary Economics 57 (5), 600­619.

Del Negro, M. and F. Schorfheide (2008). Forming Priors for DSGE Models (and
  how it Affects the Assessment of Nominal Rigidities). Journal of Monetary Eco-
  nomics 55 (7), 1191­1208.

Devereux, M. B., E. Young, and C. Yu (2019). Capital Controls and Monetary Policy
  in Sudden-stop Economies. Journal of Monetary Economics 103, 52­74.

Eichenbaum, M., S. Rebelo, and M. Trabandt (2020). The Macroeconomics of Epi-
  demics. Working Paper 26882, National Bureau of Economic Research.

Farmer, R., D. Waggoner, and T. Zha (2011). Minimal State Variable Solutions to
  Markov-Switching Rational Expectations Models. Journal of Economic Dynamics
  and Control 35 (12), 2150­2166.

Fernandez, A. and A. Gulan (2015). Interest Rates, Leverage, and Business Cycles
  in Emerging Economies: The Role of Financial Frictions. American Economic
  Journal: Macroeconomics 7 (3), 153­188.

Fernandez-Villaverde, J., P. Guerron-Quintana, J. Rubio-Ramirez, and M. Uribe
  (2011). Risk Matters: The Real Effects of Volatility Shocks. American Economic
  Review 101 (6), 2530­61.



                                        44
Fernandez-Villaverde, J., P. Guerron-Quintana, and J. F. Rubio-Ramirez (2015). Es-
  timating Dynamic Equilibrium Models with Stochastic Volatility. Journal of Econo-
  metrics 185 (1), 216­229.

Fernandez-Villaverde, J. and J. F. Rubio-Ramirez (2007). Estimating Macroeconomic
  Models: A Likelihood Approach. Review of Economic Studies 74 (4), 1059­1087.

Foerster, A. (2015). Financial Crises, Unconventional Monetary Policy Exit Strate-
  gies, and Agents Expectations. Journal of Monetary Economics 76 (C), 191­207.

Foerster, A., J. F. Rubio-Ramirez, D. F. Waggoner, and T. Zha (2016). Perturbation
  Methods for Markov-switching Dynamic Stochastic General Equilibrium Models.
  Quantitative Economics 7 (2), 637­669.

Fostel, A. and J. Geanakoplos (2015). Leverage and Default in Binomial Economies:
  A Complete Characterization. Econometrica 83 (6), 2191­2229.

Gabriel, G. (2008). Hechos estilizados del ciclo economico en mexico. Working Paper
 2008-14, Banco de Mexico.

Garcia-Cicco, J., R. Pancrazi, and M. Uribe (2010). Real Business Cycles in Emerging
 Countries? American Economic Review 100 (5), 2510­2531.

Gertler, M. and P. Karadi (2011). A Model of Unconventional Monetary Policy.
 Journal of Monetary Economics 58 (1), 17­34.

Gertler, M. and N. Kiyotaki (2015). Banking, Liquidity, and Bank Runs in an Infinite
 Horizon Economy. American Economic Review 105 (7), 2011­2043.

Greenwald, D. (2019). Firm Debt Covenants and the Macroeconomy: The Interest
  Coverage Channel. Working Paper 5909-19, MIT Sloan.

Guerrieri, L. and M. Iacoviello (2015). OccBin: A Toolkit for Solving Dynamic
 Models with Occasionally Binding Constraints Easily. Journal of Monetary Eco-
 nomics 70 (C), 22­38.

Gust, C., E. Herbst, D. Lopez-Salido, and M. Smith (2017). The Empirical Impli-
 cations of the Interest-Rate Lower Bound. American Economic Review 107 (7),
 1971­2006.

Iacoviello, M. (2005). House Prices, Borrowing Constraints, and Monetary Policy in
  the Business Cycle. American Economic Review 95 (3), 739­764.

Ivashina, V. and D. Scharfstein (2010). Bank Lending During the Financial Crisis of
  2008. Journal of Financial Economics 97 (3), 319­338.



                                        45
Jermann, U. and V. Quadrini (2012). Macroeconomic Effects of Financial Shocks.
  American Economic Review 102 (1), 238­271.

Jorda, O., M. Schularick, and A. Taylor (2013). When Credit Bites Back: Leverage,
  Business Cycles, and Crises. Journal of Money, Credit and Banking 45 (S2), 3­28.

Julier, S. J. and J. K. Uhlmann (1999). A New Extension of the Kalman Filter to
  Nonlinear Systems. In Proc. SPIE, Volume 3068, pp. 182­193.

Kim, C.-J. and C. R. Nelson (1999). State-Space Models with Regime Switching:
  Classical and Gibbs-Sampling Approaches with Applications, Volume 1. The MIT
  Press.

Kiyotaki, N. and J. Moore (1997).      Credit Cycles.   Journal of Political Econ-
  omy 105 (2), 211­248.

Kumhof, M., R. Rancire, and P. Winant (2015). Inequality, Leverage, and Crises.
 American Economic Review 105 (3), 1217­1245.

Lind, N. (2014). Regime-Switching Perturbation for Non-Linear Equilibrium Models.
  Working Paper.

Liu, Z., P. Wang, and T. Zha (2013). Land-Price Dynamics and Macroeconomic
  Fluctuations. Econometrica 81 (3), 1147­1184.

Maih, J. (2015). Efficient Perturbation Methods for Solving Regime-Switching DSGE
 Models. Working Paper 2015/01, Norges Bank.

Mendoza, E. G. (2010). Sudden Stops, Financial Crises, and Leverage. American
 Economic Review 100 (5), 1941­1966.

Miyamoto, W. and T. L. Nguyen (2017). Business Cycles in Small Open Economies:
 Evidence from Panel Data between 1900 and 2013. International Economic Re-
 view 58 (3), 1007­1044.

Neumeyer, P. A. and F. Perri (2005). Business Cycles in Emerging Economies: the
  Role of Interest Rates. Journal of Monetary Economics 52 (2), 345­380.

Otrok, C. (2001). On Measuring the Welfare Cost of Business Cycles. Journal of
  Monetary Economics 47 (1), 61­92.

Reinhart, C. M. and K. S. Rogoff (2009). This Time is Different: Eight Centuries of
  Financial Folly. Princeton University Press.

Schmitt-Grohe, S. and M. Uribe (2003). Closing Small Open Economy Models. Jour-
  nal of International Economics 61 (1), 163­185.


                                        46
Schmitt-Grohe, S. and M. Uribe (2016). Downward Nominal Wage Rigidity, Currency
  Pegs, and Involuntary Unemployment. Journal of Political Economy 124, 1466­
  1514.

Schmitt-Grohe, S. and M. Uribe (2018). How Important are Terms of Trade Shocks?
  International Economic Review 59 (1), 85­111.

Schorfheide, F. (2000). Loss Function-based Evaluation of DSGE Models. Journal of
  Applied Econometrics 15 (6), 645­670.

Smets, R. and F. Wouters (2007). Shocks and Frictions in US Business Cycles: a
  Bayesian DSGE Approach. American Economic Review 97 (3), 586­606.

Uribe, M. and V. Z. Yue (2006). Country Spreads and Emerging Countries: Who
  Drives Whom? Journal of International Economics 69 (1), 6­36.



Appendix A               Model and Competitive Equilibrium
                         Definition
This Appendix derives the model's equilibrium conditions and defines a competitive
equilibrium.


A.1     Derivation of Equilibrium Conditions
The household-firm maximizes the utility function

                                                             1-
                                             1          Ht
                      U  E0         dt  t        Ct -               ,                 (A.1)
                              t=0
                                            1-          

subject to

                                                                      1
 Ct + It = At Kt-1 Ht Vt1-- - Pt Vt - rt (Wt Ht + Pt Vt ) - Et -             Bt + Bt-1 (A.2)
                                                                   (1 + rt )

where gross investment follows

                                                        Kt - Kt-1
                  It = Kt-1 + (Kt - Kt-1 ) 1 +                                        (A.3)
                                                   2      Kt-1



                                            47
In the binding regime, the collateral constraint is given by

                      1
                             Bt -  (1 + rt ) (Wt Ht + Pt Vt ) = -qt Kt                  (A.4)
                   (1 + rt )

with the corresponding multiplier denoted t . In the non-binding regime, the collat-
eral constraint disappears, and the multipler is t = 0. The first-order conditions of
this problem are the following:
                                                     -
                                             Ht
                                   dt   Ct -              = µt                          (A.5)
                                             

                                                                   t
            (1 -  -  ) At Kt-1 Ht Vt-- = Pt 1 + rt +                   (1 + rt )        (A.6)
                                                                   µt

                                                           t
              At Kt-1 Ht-1 Vt1-- = Wt rt +                    (1 + rt ) + Ht-1          (A.7)
                                                           µt

                              µt = t +  (1 + rt ) Et µt+1                               (A.8)



                                    2
                                                
                            Kt+1            
              1-+       2    Kt
                                        -   2                        Kt
  Et µt+1                                        = µt 1 -  +                  - t qt    (A.9)
                                                                    Kt-1
              +At+1 Kt-1 Ht     1- -
                           +1 Vt+1


Market prices for capital and labor satisfy the following two conditions:

                                                 Kt - Kt-1
                               qt = 1 +                                                (A.10)
                                                   Kt-1


                                            Wt = Ht-1 .                                (A.11)
                                 
Defining the borrowing cushion, Bt , as the difference between the amount of borrow-
ing and the debt limit

                          1
                Bt =             Bt -  (1 + rt ) (Wt Ht + Pt Vt ) + qt Kt ,            (A.12)
                       (1 + rt )




                                                48
the regime-switching slackness condition is given by

                               
     (st ) Bss +  (st ) (Bt - Bss ) = (1 -  (st )) ss + (1 -  (st )) (t - ss )   (A.13)

where  (st ) and  (st ) are regime-switching parameters controlling the level and the
                                           
dynamics of the economy, respectively, Bss   and ss are the regime-switching steady-
                 
state values of Bt and t .
    As we discussed in the text, the country interest rate and the exogenous processes
are given by
                                                   ¯
                           rt = rt + r r,t + r eB -Bt - 1                      (A.14)

where
                          
                         rt            ¯ + r rt
                            = (1 - r ) r      
                                                -1 + r r ,t                      (A.15)


                             log At = A log At-1 + A A,t                         (A.16)


                   log Et = (1 - E ) log E  + E log Et-1 + E E,t                 (A.17)


                    log Pt = (1 - P ) log P  + P log Pt-1 + P P,t                (A.18)


                              log dt = d log dt-1 + d d,t ,                      (A.19)

where the errors terms ·,t are i.i.d N (0, 1).
  In the paper, we also use a number of auxiliary variables defined as as

                        GDP: Yt = At Kt-1 Ht Vt1-- - Pt Vt                       (A.20)


                                                         Bt
                            Debt-to-GDP Ratio: b
                                               t =                               (A.21)
                                                         Yt

                                                              Bt - Bt-1
                 Current Account-to-GDP Ratio: ca
                                               t =                               (A.22)
                                                                  Yt

                                                       Yt - Et - Ct - It
               Trade Balance-to-GDP Ratio: tb
                                           t =                                   (A.23)
                                                               Yt

                                           49
                                                                           t
          External Financing Premium on Debt: EF P Dt =                           .         (A.24)
                                                                          Et µt+1

A.2      Regime-Switching Equilibrium Definition
A competitive equilibrium of our economy is a sequence of quantities {Kt , Bt , Ct ,
                                                
Ht , Vt , It , At , Et , Bt } and prices {Pt , rt , rt , qt , wt , µt , t } that, given the 5 exoge-
nous processes (A.16)-(A.15), satisfy the first-order conditions for the representative
household-firm (A.5)-(A.9), the market price equations (A.10)-(A.11), the market
clearing conditions (A.2)-(A.3), the debt cushion definition (A.12), regime-switching
slackness condition (A.13), and the equation for the interest rate (A.14).


Appendix B                  Details of the Perturbation Solution
                            Method
This Appendix provides details about two aspects of the solution method: (1) the
definition of, and solution for, the steady state of the endogenous regime-switching
economy; and (2) the perturbation method that generates second order Taylor ex-
pansions to the solution of the economy around the steady state.


B.1      Regime Switching Equilibrium
Write the 23 equilibrium conditions above as

                        Et f (yt+1 , yt , xt , xt-1 , t+1 , t , t+1 , t ) = 0.               (B.1)

Here yt denotes the non-predetermined variables, xt predetermined variables, t the
exogenous shocks, t the regime-switching parameters, and  the perturbation pa-
rameter.
   There are 7 predetermined variables

                                                                        
                      xt-1 = Kt-1 , Bt-1 , At-1 , Pt-1 , Et-1 , dt-1 , rt -1                 (B.2)




                                                 50
and 16 non-predetermined variables

                                                              
       yt = Ct , Ht , Vt , It , kt , rt , qt , Wt , µt , t , Bt , Yt , b   ca  tb
                                                                       t , t , t , EF P Dt ,    (B.3)

with 6 exogenous shocks

                               t = [A,t , E,t , P,t , d,t , r,t , r ,t ] ,                      (B.4)

and 2 regime-switching parameters

                                        t = [ (st ) ,  (st )] .                                 (B.5)

In general, these variables are partitioned into those that affect the steady state, 1,t ,
and those that do not, 2,t . In the case of our specific application, the partition is

                               1,t = [ (st )]             2,t = [ (st )] .                      (B.6)

   In order to solve the model, we assume the functional forms

                     1,t+1 = ¯1 + ^1 (st+1 ) ,                1,t = ¯1 + ^1 (st )               (B.7)



                             2,t+1 = 2 (st+1 ) ,              2,t = 2 (st )                     (B.8)


                                        xt = hst (xt-1 , t , )                                  (B.9)


                   yt = gst (xt-1 , t , ) ,             yt+1 = gst+1 (xt , t+1 , )             (B.10)

and
                                      Pst ,st+1 ,t = st ,st+1 (yt ) .                          (B.11)

   Now, substituting these functional forms in the 23 equilibrium conditions and
being more explicit about the expectation operator, given (xt-1 , t , ) and st , we




                                                   51
have:
                                                                                                  
                                                                gst+1 (hst (xt-1 , t , ) ,  , ) ,
                                                                        gst (xt-1 , t , ) ,
                                                                                                  
                         1                                                                        
                                                                                                  
Fst (xt-1 , t , ) =            st ,s   (gst (xt-1 , t , )) f            hst (xt-1 , t , ) ,        dµ .
                                                                                                  
                        s =0
                                                                           xt-1 ,  , t ,
                                                                                                  
                                                                                                  
                                                                    ¯      ^       ¯
                                                                     +  (s ) ,  +  (st ) ^
                                                                                               (B.12)
where dµ denotes the joint pdf of the shocks.
  Finally, stacking all conditions by regime yields:

                                                  Fst =0 (xt-1 , t , )
                        F (xt-1 , t , ) =                                = 0.                (B.13)
                                                  Fst =1 (xt-1 , t , )

B.2      Steady State Definition and Solution
The model has two features that make defining a steady state challenging. First, as
it is common in a regime-switching framework, some structural parameters may be
switching. In the case of our application, there is only one switching parameter that
affects the steady state,  (st ). Nonetheless, in principle, one could allow for regime
switching also in the parameters of the exogenous processes, a (st ) and p (st ), or
the structural parameter  (st ), which would affect the level of the economy and the
steady state calculations.28 Following Foerster et al. (2016), we define the steady
state in terms of the ergodic means of these parameters across regimes. To define the
steady state, we set t = 0 and  = 0, which implies that the steady state is given by

                      f yss , yss , xss , xss , 0, 0, ¯1 , 2 (s ), ¯1 , 2 (s) = 0            (B.14)

for all s , s.
    In our case, the transition matrix evaluated at steady state Pss is endogenous,
since it depends on variables that in turn depend on the steady state value of the
transition matrix. To find a solution for the steady state, we proceed in two steps.
  28
    As is well known, over finite periods of time, unit root processes and processes with structural
break or regime changes are observationally equivalent from a statistical standpoint. Allowing
for regime changes in the process for At , therefore, would be a way to accommodate permanent
productivity shocks as in Aguiar and Gopinath (2007). Similarly, stochastic volatility could be
allowed for by introducing regime switching in the some or all of the shock variances.



                                                   52
First, we assume the steady state transition matrix is known and solve for all the
steady state prices and quantities. Second, we use the steady state values of the
                     
borrowing cushion Bss  and multiplier ss from Step 1 to update the steady state
transition matrix. We then iterate to convergence.

Step 1: Solve steady state using a given steady state transition matrix.
                                                                        (i)
First, assume that the steady state transition matrix at iteration i, Pss , is known.
                                                    (i)
Next, let  = [0 , 1 ] denote the ergodic vector of Pss . Then, as noted in the paper,
define the ergodic means of the switching parameters as

                                 ¯ = 0  (0) + 1  (1) .

The steady state of the regime-switching economy depends on these ergodic means,
and we can now solve for the steady states of all variables. First, we can partially
solve for some of the steady state directly

                Ass = 1, dss = 1, Ess = E  , Pss = P  , qss = 1, rss
                                                                  
                                                                      ¯
                                                                     =r       (B.15)

Suppose now that we knew rss . Then, we can obtain:
                       1--
            Ass Kss Hss Vss   1 + rss +  (1 + rss ) (1 -  (1 + rss ))
      v                     =                                                 (B.16)
                  Pss Vss                 1--

                      1--
            Ass Kss Hss Vss   1 +  (rss + (1 + rss ) (1 -  (1 + rss )))
      h                     =                                                 (B.17)
                 Wss Hss                        
                       1--
             Ass Kss Hss Vss   1         1 -  (1 -  (1 + rss ))
       k                     =                                  -1+           (B.18)
                     Kss                          
                                                          1
                                                         ( -1)
                                           Ass
                         Hss =                                                (B.19)
                                     
                                   k h   (Pss v )1--

                                           h     
                                   Vss          Hss                           (B.20)
                                          Pss v

                                             h 
                                     Kss =    H                               (B.21)
                                             k ss


                                          53
                                     
                            Yss = h Hss - Pss Vss                                (B.22)


                                         -1
                                 Wss = Hss                                       (B.23)


                                    Iss = Kss                                    (B.24)


                                    kss = Kss                                    (B.25)


                             ¯ - log 1 +          rss - r
                       Bss = B                                                   (B.26)
                                                     r


                                                                1
Css = Yss - rss (Wss Hss + Pss Vss ) - Ess + Bss 1 -                     - Iss   (B.27)
                                                            (1 + rss )

                                                     -
                                             Hss
                            µss =    Css -                                       (B.28)
                                              

                          ss = (1 -  (1 + rss )) µss                             (B.29)


                    1
        Bss =              Bss -  (1 + rss ) (Wss Hss + Pss Vss ) + Kss          (B.30)
                (1 + rss )

                                            Bss
                                    b
                                    ss =                                         (B.31)
                                            Yss

                                     ca
                                     ss = 0                                      (B.32)

                                Yss - Ess - Css - Iss
                         tb
                         ss =                                                    (B.33)
                                         Yss

                                             ss
                              EF P Dss =         .                               (B.34)
                                             µss



                                       54
The variable rss can then be derived as the solution of

                                   
                                 B
                                 ¯ ss = (1 - ¯) ss .                                   (B.35)


                                                                                
Step 2: Updating the transition matrix. Step 1 yields the variables Bss           and
ss , and hence provides a new value of the transition matrix for iteration i + 1:

                                             exp(-0 Bss )                  )
                                                                  exp(-0 Bss
       (i+1)     p00,ss p01,ss         1-   1+exp(-0 Bss )                   )
                                                                 1+exp(-0 Bss
      Pss    =                   =         exp(-1 ss )               exp(-1 ss )   ,   (B.36)
                 p10,ss p11,ss            1+exp(-1 ss )
                                                             1   - 1+exp(-1 ss )

which can be checked against the guess in Step 1. We then iterate to convergence
until
                             (i+1)    (i)
                           Pss     - Pss  < tolerance,

where in our application we use a tolerance of 10-10 .


B.3     Generating Approximations
To compute a second order approximation to the endogenous regime-switching model
solution, we largely follow Foerster et al. (2016), adapting to the case with endogenous
probabilities.
    We take the stacked equilibrium conditions F (xt-1 , t , ), and differentiate with
respect to (xt-1 , t , ). The first-order derivative with respect to xt-1 produces a
complicated polynomial system denoted

                                     Fx (xss , 0, 0) = 0.                              (B.37)

In Foerster et al. (2016), when the transition probabilities are exogenous and fixed,
this system needs to be solved via Gr¨  obner bases, which finds all possible solutions
in order to check them for stability. In our case with endogenous probabilities, the
standard stability checks fail, so we will focus on finding a single solution and ignore
the possibility of indeterminacy, a common simplification in the regime-switching
literature with and without endogenous switching (e.g. Farmer et al., 2011; Foerster,
2015; Maih, 2015; Lind, 2014). Ignoring the possibility of multiple equilibria is also
common in models with occasionally binding constraints. Global solution methods
of models with occasionally binding constraint also do not guarantee uniqueness, and

                                             55
the focus typically is on checking robustness of the solution to initial conditions (for
example, Mendoza, 2010; Benigno et al., 2013; Bianchi and Mendoza, 2018).
    To find a model solution, we guess a set of policy functions for regime st = 1, which
reduces the equilibrium conditions Fx (xss , 0, 0; st = 0) to a fixed-regime eigenvalue
problem, and solve for the policy functions for st = 0. Then, using this initial solution
as a guess, we solve for regime st = 0 under the fixed-regime eigenvalue problem, and
iterate to convergence. After solving the iterative eigenvalue problem, the remaining
systems to solve are

                                     F (xss , 0, 0) = 0                            (B.38)
                                     F (xss , 0, 0) = 0,                           (B.39)

and the second order systems of the form

                              Fi,j (xss , 0, 0) = 0, i, j  {x, ,} .                (B.40)

   Recalling now that the decision rules have the form

                                     xt = hst (xt-1 , t , )                        (B.41)



                                    yt = gst (xt-1 , t , ) ,                       (B.42)

the second-order approximation are

                                    (1)     1 (2)
                         xt  xss + Hs t
                                        St + Hs   (St  St )                        (B.43)
                                            2 t

                                            1 (2)
                          yt  yss + G(1)
                                     st St + Gst (St  St )                         (B.44)
                                            2

where St =    (xt-1 - xss )     t 1      , with xss denoting the value of the steady-state
variables.




                                               56
B.4       Proposition 1: Irrelevance of Endogenous Switching in
          the First-Order Solution
To prove Proposition 1, take the first-order derivatives of (B.13) with respect to its
arguments, evaluated at the steady state. This yields:

                                                    s   st ,s ,y (yss ) gx,st fss (s , st )
   Fx,st (xss , 0, 0) =                                 fyt+1 (s , st ) gx,s hx,st + fyt (s , st ) gx,st
                            +    s   st ,s (yss )
                                                            +fxt (s , st ) hx,st + fxt-1 (s , st )
                                                                                                           (B.45)



                                                    s   st ,s ,y (yss ) g,st fss (s , st )
      F,st (xss , 0, 0) =                               fyt+1 (s , st ) gx,s h,st + fyt (s , st ) g,st
                            +    s   st ,s (yss )
                                                             +fxt (s , st ) h,st + ft (s , st )
                                                                                                           (B.46)
and

                                         st ,s ,y (yss ) g,st fss (s , st )
                                               s                                           
                                         fyt+1 (s , st ) gx,s h,st + fyt (s , st ) g,st
  F,st (xss , 0, 0) =                                                                       .
                      + s st ,s (yss )                 +fxt (s , st ) h,st
                                       
                                                                                           
                                        +ft+1 (s , st )   ^ (st+1 ) + ft (s , st ) ^ (st )
                                                                                           (B.47)
Note now that, by definition of a steady state, fss (s , st ) = 0, and so the first term
of each of these expressions equals zero. Hence, we are left with the expressions for
the exogenous transition probabilities as in Foerster et al. (2016), given by Pss =
st ,s (yss ). QED.


Appendix C                      Accuracy of the Solution
We assess accuracy of the solution by checking the Euler equation error (EEE), where

                                                    t                  µt+1
                                EEEt = 1 -             -  (1 + rt ) Et                                      (C.1)
                                                    µt                  µt




                                                        57
and the policy functions can be denoted by

                                                                            
   t = st (xt-1 , t ) , µt = µst (xt-1 , t ) , rt = rst (xt-1 , t ) , Bt = Bs t
                                                                                (xt-1 , t ) .
                                                                                         (C.2)
So, given (xt-1 , t )

                                  st (xt-1 , t )  (1 + rst (xt-1 , t ))
    EEEst (xt-1 , t ) = 1 -                       -                                                (C.3)
                                  µst (xt-1 , t )   µst (xt-1 , t )
                                  1
                            ×             pst ,t+1 (xt-1 , t )       µst+1 (xt , t+1 ) µ (t+1 ) dt+1(C.4)
                                                                                                     ,
                                st+1 =0                          R


where xt-1 denotes the predetermined variables and t denotes the shocks.
    We simulate the model for 10,000 periods, after a 1,000 burn-in period to get
sequences of st and (xt-1 , t ). For each simulation period, we draw 10,000 values of
t+1 to compute the integral above. We then average the absolute values, finding
errors of approximately $1 per $1,000 of consumption.
    To compare our perturbation-based solution method with global methods we
solved a smaller-scale occasionally bonding constraint model, i.e., the model in Jer-
mann and Quadrini (2012), using three different methods. First, we replicate the
results in that paper solving the inequality-constraint version of the model with a
global projection method. Second, we solve the endogenous regime-switching formu-
lation of that model via the same global projection methods. Third, we solve the
endogenous regime-switching formulation with our proposed perturbation method.

Table C.1: Comparing Solution Accuracy: Global vs. Perturbation Meth-
ods

                                                  Inequality           Endo Switch
              Comparison                          Constraint         Global Perturb.
              Standard Deviations
                  GDP                                   2.38           2.46       2.28
                  Hours                                 1.36           1.46       1.33
              Autocorrelations
                  GDP                                 0.94             0.94       0.94
                  Hours                               0.77             0.76       0.77
              Euler Eqn Errors (log10 )              -10.47           -3.59      -3.41


   Table C.1 reports some of the results and highlights that these three approaches

                                                   58
have nearly identical implications for the standard deviations and autocorrelations
of GDP and hours, which are two key variables in that model. Furthermore, the
Euler equation errors all achieve reasonable levels of accuracy. The traditional in-
equality constraint solved with global method has the smallest Euler equation errors.
However, the endogenous switching model solved globally and the perturbation so-
lution returned accuracy values of -3.6 and -3.4 in log-10 points, respectively.29 The
latter two numbers suggest an approximation error of $2.60 and $3.90 per $10,000
of consumption. The higher accuracy comes at a significant computational cost, as
the global methods solve in minutes, while the perturbation solution takes less than a
second. Moreover, we also note here that when Binning and Maih (2017) investigated
the properties of our framework with simulated data from other structural models,
they found a high degree of accuracy.


Appendix D                 Estimation Procedure
D.1      State Space
For likelihood estimation, the state space representation is

                                     Xt = Hst (Xt-1 , t )                                 (D.1)



                                       Yt = Gst (Xt , Ut )                                (D.2)

where Xt denotes the state, Yt denotes the observation, t denotes the structural
shocks, and Ut denotes the observation errors.
   Recall the second-order approximation takes the form

                                       (1)     1 (2)
                            xt  xss + Hs t
                                           St + Hs   (St  St )                            (D.3)
                                               2 t

                                              1 (2)
                            yt  yss + G(1)
                                       st St + Gst (St  St )                              (D.4)
                                              2
  29
    Note that this value can be driven down further by optimizing the number of gridpoints in our
global solution algorithm.




                                               59
where St =    (xt-1 - xss )      t 1     . Therefore, we can define the state variables as


                             Xt =      xt xt-1 yt yt-1             t   .                     (D.5)

The nonlinear transition equations,

                                     Xt = Hst (Xt-1 , t )                                    (D.6)

can be represented as

                                              (1)            (2)
                                                    1
                                                                                  
                       xt            xss + Hst St + 2 Hst (St  St )
                      xt-1                        xt-1
                                                                                  
                                                                                  
                                            (1)     1 (2)
                                                                                  
                   
                       yt     =
                                     yss + Gst St + 2 Gst (St  St )               .
                                                                                             (D.7)
                      yt-1                        yt-1
                                                                                  
                                                                                  
                       t                           t

   The observation equation
                                       Yt = Gst (Xt , Ut )                                   (D.8)

is given by                               
                                 yt                          
                                                      xt
                                 ct       
                                                     xt-1
                                                             
                                                             
                                 it           
                                                              + Ut
                                                             
                                           = D        yt                                     (D.9)
                                          
                              
                                  rt                         
                                                     yt-1
                                                             
                                                             
                                 Bt /Yt   
                                                      t
                                          
                                 Pt
where D denotes a selection matrix of the form
                                                                   
         yt              0      0       1[yt ] -1[yt ]        0                   
                                                                            xt
       ct   0                   0       1[ct ] -1[ct ]        0    
                                                                           xt-1
                                                                                  
                                                                                  
       i
             t
                   0            0       1[it ] -1[it ]        0    
                                                                                   + Ut .
                                                                                  
                 =                                                          yt              (D.10)
                                                                   
                                                                   
          rt       0            0       1[rt ]  0             0                   
                                                                           yt-1
                                                                                  
       B /Y   0                                                                   
           t   t                0      1[cat ]
                                                0             0    
                                                                            t
                                                                   
         Pt             1[Pt ] -1[Pt ]   0      0             0




                                               60
D.2     Filtering
To filter the likelihood, we use the Unscented Kalman Filter (UKF). The UKF calcu-
lates the state mean and covariance by propagating deterministically chosen sigma-
points through the nonlinear functions. The transformed points are then used to
calculate the mean and covariance matrix. As Julier and Uhlmann (1999) note, the
critical assumption taken to apply the UKF is that the prediction density and the
filtering density are both Gaussian.
     The filtering and smoothing largely follow Binning and Maih (2015). The filter
starts by combining the state vector and exogenous disturbances into a single vector,
Xa t-1 = [Xt-1 , t ] , with the following mean and covariance matrix conditional on Y1:t-1
and regime st-1 :
                                                 Xt-1|t-1 (st-1 )
                                 Xat-1 (st-1 ) =                                   (D.11)
                                                       0

                                             Ptx
                                               -1|t-1 (st-1 ) 0
                            Pta
                              -1 (st-1 ) =                        .                  (D.12)
                                                   0          I
     The sigma-points Xa   i,t-1 (st-1 ) that consist of the sigma-points for state variables
Xxi,t-1 (st-1 ) and the sigma-points for exogenous shocks Xi,t-1 (st-1 ) are chosen as fol-
                                                                 

lows:

        Xa
         0,t-1 (st-1 ) = Xt-1 (st-1 )
                          a
                                                                                     (D.13)
        Xa
         0,t-1 (st-1 ) = Xt-1 (st-1 )
                          a
                                                                                     (D.14)
        Xa
         i,t-1 (st-1 ) = Xt-1 (st-1 ) + (h
                          a
                                               Pta
                                                 -1 (st-1 ))i for i = 1 . . . L      (D.15)

        Xa
         i,t-1 (st-1 ) = Xt-1 (st-1 ) - (h Pt-1 (st-1 ))i-L for i = L + 1 . . . 2L, (D.16)
                          a                  a


          
where h = 3 and L denotes the number of state variables and exogenous shocks.
The weights for the sigma-points are given by:

                                       h-L
                               w0 =                                                  (D.17)
                                         2h
                                        1
                                wi   =     for i = 1 . . . 2L                        (D.18)
                                       2h

  The sigma-points and the assigned weights are used to calculate the expected
mean and covariance by propagating sigma-points through transition equations and

                                              61
taking weighted average:

                                                      i,t-1 (st-1 ), Xi,t-1 (st-1 ))
                        Xi,t|t-1 (st-1 , st ) = Hst (Xx               
                                                                                                    (D.19)


                                                      2L
                              Xt|t-1 (st-1 , st ) =         wi Xi,t|t-1 (st-1 , st )                (D.20)
                                                      i=0

                                                              2L
                                    Ptx                                ~ iX
                                                                    wi X  ~T
                                      |t-1 (st-1 , st )   =                i                        (D.21)
                                                              i=0


                                 Yt|t-1 (st-1 , st ) = DXt|t-1 (st-1 , st )                         (D.22)

where X~ i = Xi,t|t-1 (st-1 , st ) - Xt|t-1 (st-1 , st ). From these conditions, we get the Gaus-
sian approximation predictive density p(Xt |Y1:t-1 , st-1 , st ) = N (Xt|t-1 (st-1 , st ), Ptx
                                                                                             |t-1 (st-1 , st )).
The predictive density is then updated using the standard Kalman filter rule:

                            Pty                      x                 T
                              |t-1 (st-1 , st ) = DPt|t-1 (st-1 , st )D + R                         (D.23)



                                 Ptxy                    x
                                   |t-1 (st-1 , st ) = Pt|t-1 (st-1 , st )D
                                                                            T
                                                                                                    (D.24)


                         Kt (st-1 , st ) = Ptxy                  y
                                             |t-1 (st-1 , st )(Pt|t-1 (st-1 , st ))
                                                                                   -1
                                                                                                    (D.25)


         Xt|t (st-1 , st ) = Xt|t-1 (st-1 , st ) + Kt (st-1 , st )(Yt - Yt|t-1 (st-1 , st ))        (D.26)


                                                                 y
      Ptx                   x                                                      T
        |t (st-1 , st ) = Pt|t-1 (st-1 , st ) - Kt (st-1 , st )Pt|t-1 (st-1 , st )Kt (st-1 , st )   (D.27)

    This updating step gives p(Xt |Y1:t , st-1 , st ) = N (Xt|t (st-1 , st ), Ptx  |t (st-1 , st )). As a
by-product of the filter, we can get the density of Yt conditional on Y1:t-1 , st , and
st-1
             p(Yt |Y1:t-1 , st-1 , st ; ) = N (Yt|t-1 (st-1 , st ), Pty
                                                                      |t-1 (st-1 , st ))           (D.28)

    Since the Unscented Kalman filter with regime switches creates a large number
of nodes at each iteration where the filtered mean and covariance matrix need to be
evaluated, we implement the following collapsing procedure suggested by Kim and

                                                      62
Nelson (1999)

                                             M
                       1
Xt|t (st = j ) =                                 Pr(st-1 = i, st = j |Y1:t )Xt|t (st-1 = i, st = j )(D.29)
                 Pr(st = j |Y1:t )         i=1
                                             M
                           1
  Ptx
    |t (st = j ) =                                 Pr(st-1 = i, st = j |Y1:t )[Ptx
                                                                                 |t (st-1 = i, st = j
                                                                                                    (D.30)
                                                                                                      )
                     Pr(st = j |Y1:t )       i=1

   +(Xt|t (st = j ) - Xt|t (st-1 = i, st = j ))(Xt|t (st = j ) - Xt|t (st-1 = i, st = j ))T ]

where Pr(st , st-1 |Y1:t ) and Pr(st |Y1:t ) are obtained from the following Hamilton filter

                         Pr(st , st-1 |Y1:t-1 ) = Pr(st |st-1 ) Pr(st-1 |Y1:t-1 )                  (D.31)


                                         p(Yt |st , st-1 , Y1:t-1 ) Pr(st , st-1 |Y1:t-1 )
       Pr(st , st-1 |Y1:t ) =                                                                      (D.32)
                                    st    st-1 p(Yt |st , st-1 , Y1:t-1 ) Pr(st , st-1 |Y1:t-1 )



                                   Pr(st |Y1:t ) =           Pr(st , st-1 |Y1:t ).                 (D.33)
                                                      st-1

The resulting conditional marginal likelihood is

         p(Yt |Y1:t-1 ; ) =                  p(Yt |st , st-1 , Y1:t-1 ) Pr(st , st-1 |Y1:t-1 ).    (D.34)
                                   st st-1


D.3      Smoothing
Once we perform the filtering using the UKF for t = 1, . . . , T , we can also obtain
Pr(st , st+1 |Y1:T ), Pr(st |Y1:T ), xt|T (st , sT ), and Ptx
                                                            |T (st , sT ):



                           Pr(st+1 |Y1:T ) Pr(st |Y1:t ) Pr(st+1 |st )
Pr(st , st+1 |Y1:T ) =                                                                             (D.35)
                                       Pr(st+1 |Y1:t )
      Pr(st |Y1:T ) =             Pr(st , st+1 |Y1:T )                                             (D.36)
                           st+1

   Xt|T (st , st+1 ) = Xt|t (st ) + K
                                    ~ t (st , st+1 )(Xt+1|T (st+1 ) - Xt+1|t (st , st+1 ))       (D.37)
   Ptx                   x          ~                 x                x                   ~
     |T (st , st+1 ) = Pt|t (st ) - Kt (st , st+1 )(Pt+1|T (st+1 ) - Pt+1|T (st , st+1 ))Kt (st , st+1 )
                                                                                                         T



   Given the above smoothing algorithm, we implement a collapsing procedure sim-


                                                         63
ilar to those in the filtering step:

                                       M
                         1
 Xt|T (st = j ) =                             Pr(st = i, st+1 = j |Y1:T )Xt|T (st = i, st+1 = j ) ,
                  Pr(st = j |Y1:T )    j =1
                                                                                                (D.38)

                                               M
                            1
   Ptx
     |T (st   = j) =                                 Pr(st = i, st+1 = j |Y1:T )[Ptx
                                                                                   |T (st = i, st+1 = j )
                     Pr(st = j |Y1:T )        j =1

+(Xt|T (st = j ) - Xt|T (st = i, st+1 = j ))(Xt|T (st = j ) - Xt|T (st = i, st+1 = j ))T(D.39)
                                                                                        ] .


Appendix E                Calibrated Parameters
To calibrate the parameters that we do not estimate, we largely follow Mendoza
(2010), targeting the same moments, but adapting the computations to our model
specification. We start by calibrating certain parameters based on the steady state
of the model without working capital and the borrowing constraint­i.e., with  = 0
and  ¯ = 0, which implies ss = 0. In addition, we set

                                         (1 + rss ) = 1,                                         (E.1)

and
                               1      1      1                      1
                    v =          , h = , k =                          -1+ .                      (E.2)
                             1--                                    
The implied factor payment ratios are

                                 Pss Vss      1
                                            =   =1--                                             (E.3)
                              Yss + Pss Vss   v

                              Wss Hss      1                       
                                      =                        =                                 (E.4)
                               Yss      h 1 -              1       +
                                                           v

                         1
                         
                             - 1 +  Kss                1
                                                           -1+          
                                                       
                                               =                    =     .                      (E.5)
                               Yss                   k 1 -     1        +
                                                               v




                                                     64
Using the National Accounts, we obtain

                       1 -  -  = 0.102                         = 0.59268
                           
                                                    =                           .            (E.6)
                          +
                             = 0.66                            = 0.30532

We then set the depreciation rate to an annual value of 8.8 percent, so that

                        (1 -  )4 = 1 - 0.088 =  = 0.022766.                                  (E.7)

The capital-to-(gross annual) output ratio is 1.758, so the capital-to-(gross quarterly)
output ratio, -  1
               k , implies

                                               -1
                        1   1
               - 1
               k =            -1+                   = 4  1.758 =  = 0.97977.                 (E.8)
                            

In turn, this yields an annualized real interest rate of
                                                        4
                                                    1
                                (1 + rss )4 =               = 1.0852,                        (E.9)
                                                    

which is very close to the value used in Mendoza (2010), but it is obtained under
different discounting assumptions. From the resource constraint,

                      Css   Iss   Ess           1                       Bss
                          +     +     =1+ 1-                                ,               (E.10)
                      Yss   Yss   Yss        1 + rss                    Yss

we obtain

                                                            Bss   Bss
               0.65 + 0.172 + 0.11 = 1 + (1 -  )                =     = -3.3605.            (E.11)
                                                            Yss   Yss

This implies
                                     Bss
                                          = -0.840127,                                      (E.12)
                                     4Yss
from which we have
                                                                           (-1)
         +                                 1
 Yss =                                                                              = 1.8202(
                                                                                            , E.13)
                                                                          
                                                                    1-- 
         
           
                   1--      1   1                   1          1
                  Pss           
                                    -1+                      1--




                                                65
and
                              Ess
                       E =        Yss = 0.11  1.8202 = 0.20022,                    (E.14)
                              Yss
as well as
                      Bss = -0.840127  4  1.8202 = -6.11685.                       (E.15)
                                  ¯ is pinned down via
Finally, conditional on r and r , B
                                                
                            ¯ = log 1 + rss - r
                            B                         + Bss .                      (E.16)
                                           r


Appendix F               Data Appendix
National accounts are from the National Statistic Office. The data series used in the
analysis merge two sets of official statistics by updating the level of the accounts based
on 1993 constant prices with the quarterly rate of growth of the accounts based on
2008 constant prices. The merging is necessary as the deflators to splice the accounts
in levels were not available at the time of last download of the data (May 2017). The
two sets of national accounts overlap from 1993:Q1 to 2006:Q4. Over this period, the
difference in annual rate of growth is less than 0.01 percent in absolute value for GDP,
less than 0.05 percent for consumption, less than 2 percent for investment, and less
than 1 and 3 percent for imports and exports, respectively. The correlations between
the series are more than 0.9 for all series except investment that is 0.84, pointing
to possibly larger measurement errors in this variable. The differences are smaller
the closer to the end of the sample. For this reason, we choose to update the 1993
accounts rather than backdate the 2008 ones.
    The specific sources of the data are as follows:

   · 1980:Q1-2006:Q4 (Labeled 1993 accounts)­Supply and demand of goods and
     services. Original Series (not seasonally adjusted). Constant prices, annual
     1993 = 100. We obtained these from the Central Bank of Mexico (Gabriel,
     2008).

   · 2006:Q1-2016:Q4 (Labeled 2008 accounts)­Supply and demand of goods and
     services. Original series (not seasonally adjusted). Constant prices, annual
     2008 = 100 (Oferta y demanda de bienes y servicios. Series originales. A pre-
     cios constantes 2008). Available from http://www3.inegi.org.mx/sistemas/

                                           66
       tabuladosbasicos/tabdirecto.aspx.

The data are not seasonally adjusted and show a strong seasonal pattern. To sea-
sonally adjust all series (assumed to be I(1) processes), we adjust the log-difference
using the X-12 procedure with the additive option in Eviews. We then use the log
of the first observation of the raw series (not seasonally adjusted) and cumulate the
seasonally adjusted log-difference. The net exports to GDP series, used to validate
the model externally but not as an observable variable in estimation, is calculated as
real exports minus real imports divided by real GDP.
    The current account as a percentage of GDP is from the balance of payment statis-
tics, obtained from the OECD Economic Outlook Database (Series MEX.CBGDPR.Q,
OECD-EO-MEX-CBGDPR-Q).
    As a proxy for the relative price of intermediate goods, entered as observable in
estimation, we use a measure of Mexico's terms of trade obtained from Banco de
Mxico (PPI Producer and International Trade Price Indexes, series SP12753).
    Mexico's country interest rate is calculated following Uribe and Yue (2006) as

                                        
                                  rt = rt + spreadt                                    (F.1)

where r is the US real interest rate, and spread is a proxy for Mexico's country risk
or sovereign spread. We compute r as 3-month Treasury Constant Maturity Rate
adjusted for ex post CPI (annualized) quarterly inflation, using period average data.
The source of these data is FRED. For the country spread, as customary, we use the
Mexico's component of the JP Morgan EMBI.
    Unfortunately, the EMBI spread is available only starting from 1993. In order to
estimate the country spread before 1993, we rely on empirical modeling of the rela-
tion between domestic real interest rates and country risk at the Banco de Mexico
(Aportela Rodriguez et al., 2001) that estimates a close and stable relation between a
measure of the domestic real interest rate and the EMBI spread over the period over
which both these variables are available. The only interest series available going back
to 1980 is a three-month nominal short-term rate obtained from Banco de Mexico
(Average monthly yield on 90-days Cetes, series SF3338).30 So we estimate a rela-
tionship between this nominal interest rate, it , and the EMBI during the period over
  30
   There are three missing monthly observations in this series: August and September 1986 and
November 1988. We fill these gaps using July 1986 for 1986Q3 and the average of October and
December 1988 for 1988:Q4.

                                             67
which the EMBI is observable, adjusting for inflation, t , which was an important
source of nominal interest rate variation in the 1980s, and then invert it. Specifically,
we posit the following simplified version of the model that (Aportela Rodriguez et al.,
2001) estimate:

                           it = 0 + 1 t + 2 EM BIt .                               (F.2)

We then solve the fitted equation for the country risk component of the domestic real
interest rate, which we denote as EM  ^BIt . The estimated regression is (t-statistics in
parentheses and R2 = 0.883):

                       ^
                       i                                ^
                         t = -0.00346 + 0.397t + 2.770EM BIt .                     (F.3)
                              (-0.42)    (4.46)    (7.37)



Appendix G               Additional Results
In this appendix we report additional empirical results.


G.1     Estimated Shocks and Transition Probabilities
Figure 8 plots the estimated model implied shocks in standard deviation units, to-
gether with a two-standard deviations band. The figure shows that the model fit
is largely achieved without relying on unusually large shocks, including during crisis
times. Shocks slightly outside the two-standard divisions band are estimated right
before the 1982 debt crisis, possibly do to the limited number of observations before
the peak of that episode. TFP, expenditure, and preference shocks, however, are all
well within the band during the that event.
    Figure 9 plots the pseudo-real-time (i.e. filtered) estimated transition probabili-
ties; panel (a) shows the probability of switching from the non-binding to the binding
regime, while panel (b) shows the probability of switching from the binding to the
non-binding regime. In other words, they plot the estimated counterpart of the transi-
tion probabilities together with the model identified crisis peaks. These probabilities
provide the odds of switching from one regime to the other as the model travels
through the sample. Their behavior is driven by the estimated parameters 0 and 1
and the estimated values of B  and . Both probabilities are time-varying and hence
suggest that a model with exogenous and constant switching probabilities would be

                                           68
                          Figure 8: Model Estimated Shocks
                                        (a) TFP Shock




                                   (b) Expenditure Shock




                                   (c) Import Price Shock




                                    (d) Preference Shock




                           (e) Transitory Interest Rate Shock




                            (f ) Persistent Interest Rate Shock




Notes: The figure plots the estimated model implied shocks, in standard deviation units, together
with a two-standard deviations band (black dashed lines). Red bars indicate model-identified periods
of crisis peak, see text for definition.



                                                69
                           Figure 9: Transition Probabilities
             (a) Transition Probability of Binding Given Non-Binding




             (b) Transition Probability of Non-Binding Given Binding




Notes: The top panel shows the model-implied filtered probability of transitioning into the binding
regime in subsequent period, conditional on being in the non-binding regime in the current period.
The bottom panel shows the filtered probability of transitioning to the non-binding regime, condi-
tional on being in the binding regime. Red bars indicate model-identified crisis peaks defined in the
paper.


misspecified.


G.2      Assessing the Relative Importance of Shocks: A Likelihood-
         based Indicator
To study the importance of shocks before, after and during financial crises episodes,
we construct an indicator of relative importance of each shock. Let LL denote the
maximized log-likelihood over the full sample, and let CLLi,t denote the counterfac-
tual full-sample log likelihood when shock i is set to zero in quarter t (i.e. i,t = 0).
The loss of fit in likelihood points,

                                      i,t = LL - CLLi,t ,                                     (G.1)

can be interpreted as an measure of importance of i,t . Figure 10 shows how this
measure evolves. There is an obvious shortcoming to this measure: since we are
computing the difference in the likelihood over the full sample, earlier observations
tend to have larger values of i,t due to the fact that they impact all subsequent
quarters.
   Hence, we focus on a relative importance measure. The importance of i,t relative

                                                 70
            Figure 10: Historical Importance of Shocks, Log Points




Notes: For each quarter, shows the likelihood contribution (in log points) for each shock, computed
by setting the given shock to zero in the given quarter.


to other shocks at time t can be assessed as

                                                  i,t
                                        i,t =           ,                                   (G.2)
                                                  j j,t


where the denominator of this expression cumulates the the losses across all shocks.
In the paper, we report this measure of relative importance in a given subsample
period of T quarters, (t + T ) - (t), compared to the full sample averages,  ¯ i . Thus,
the subsample measure in the main text can be computed by t                   ¯
                                                                   t=t0 i,t - i . Note
                                                                    1


here that, similar to our variance decomposition results, this calculation ignores the
non-linearities captured by the second-order solution.




                                                71
