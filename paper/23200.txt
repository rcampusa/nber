                             NBER WORKING PAPER SERIES




            OPTIMAL TRANSPORT NETWORKS IN SPATIAL EQUILIBRIUM

                                    Pablo D. Fajgelbaum
                                      Edouard Schaal

                                     Working Paper 23200
                             http://www.nber.org/papers/w23200


                    NATIONAL BUREAU OF ECONOMIC RESEARCH
                             1050 Massachusetts Avenue
                               Cambridge, MA 02138
                          February 2017, Revised July 2019




We thank Costas Arkolakis, Dave Donaldson and Jonathan Eaton for their discussions. We thank
Thomas Chaney, Arnaud Costinot, Don Davis, Manuel Garcia Santana, Cecile Gaubert, Gueorgui
Kambourov, Ezra Oberfield, Stephen Redding, Esteban Rossi-Hansberg and Jonathan Vogel for
helpful comments. Edouard Schaal acknowledges financial support from the Spanish Ministry of
Economy and Competitiveness, through the Severo Ochoa Programme for Centres of Excellence
in R&D (SEV-2015-0563), the Barcelona GSE (grant SG-2017-07) and the European Research
Council Starting Grant 804095. The views expressed herein are those of the authors and do not
necessarily reflect the views of the National Bureau of Economic Research.

NBER working papers are circulated for discussion and comment purposes. They have not been
peer-reviewed or been subject to the review by the NBER Board of Directors that accompanies
official NBER publications.

© 2017 by Pablo D. Fajgelbaum and Edouard Schaal. All rights reserved. Short sections of text,
not to exceed two paragraphs, may be quoted without explicit permission provided that full
credit, including © notice, is given to the source.
Optimal Transport Networks in Spatial Equilibrium
Pablo D. Fajgelbaum and Edouard Schaal
NBER Working Paper No. 23200
February 2017, Revised July 2019
JEL No. F11,O18,R13

                                          ABSTRACT

We study optimal transport networks in spatial equilibrium. We develop a framework consisting
of a neoclassical trade model with labor mobility in which locations are arranged on a graph.
Goods must be shipped through linked locations, and transport costs depend on congestion and on
the infrastructure in each link, giving rise to an optimal transport problem in general equilibrium.
The optimal transport network is the solution to a social planner’s problem of building
infrastructure in each link. We provide conditions such that this problem is globally convex,
guaranteeing its numerical tractability. We also study cases with increasing returns to transport
technologies in which global convexity fails. We apply the framework to assess optimal
investments and inefficiencies in observed road networks in European countries.


Pablo D. Fajgelbaum
Department of Economics
University of California, Los Angeles
Bunche Hall 8283
315 Portola Plaza
Los Angeles, CA 90095
and NBER
pfajgelbaum@gmail.com

Edouard Schaal
Centre de Recerca en Economia Internacional
Universitat Pompeu Fabra
Ramon Trias Fargas, 23-25
08005 Barcelona
Spain
edouard.schaal@gmail.com
1     Introduction
    Trade costs are a ubiquitous force in international trade and economic geography, as they partly
determine spatial distributions of prices, real incomes, and trade flows. Following the pioneering
work of Eaton and Kortum (2002), a standard approach to study the gains from market integration
is to fit a quantitative trade model to data on the geographic distribution of economic activity, and
then ask what would happen if trade costs between specific locations were to change by some
predetermined amount.1
    Trade costs result from a diverse set of forces. Transport infrastructure, in particular, stands
out as an important determinant.2 Specific questions related to transport infrastructure call for a
somewhat different approach to implementing counterfactuals. Consider a problem confronted by
countries at the time of allocating resources: How should infrastructure investments be allocated
across regions? Infrastructure investments may be sensitive to different types of frictions, potentially
leading to suboptimal transport networks that may hinder trade and development.3 How important
are these inefficiencies? To answer these questions, it is necessary to first pinpoint the best set of
infrastructure investments, to then ask what would happen if trade costs were to change in the way
implied by the efficient transport network.
    In this paper, we develop and apply a framework to study optimal transport networks in general
equilibrium spatial models. We solve a global optimization over the space of networks, given any
primitive fundamentals, in a general neoclassical framework. In contrast to the standard approach,
here trade costs are an outcome rather than a primitive, endogenously responding to fundamentals
such as resource endowments and geographic frictions through optimal investments in the transport
network. We apply the framework to European road networks, where we assess the aggregate and
regional impacts of optimal infrastructure growth, the inefficiencies of observed networks, and the
optimal placement of roads as a function of observable regional characteristics.
    The point of departure for the framework is a neoclassical economy with multiple goods, fac-
tors, and locations, nesting standard trade models (such as the Ricardian, Armington, and factor-
endowment models) and allowing for either a fixed spatial distribution of the primary factors (as in
international trade models) or for labor to be perfectly mobile (as in economic geography models).
The key methodological innovation is that locations are arranged on a graph and goods can only
be shipped through connected locations subject to transport costs that depend both on how much
is shipped (e.g., because of congestion or decreasing returns to shipping technologies) and on how
much is invested in infrastructure (e.g., the number of lanes or the quality of the road). We tackle

    1
      Costinot and Rodrı́guez-Clare (2013) review the quantitative gravity literature on changes in trade costs focused
on measuring gains from international trade. Redding and Rossi-Hansberg (2016) review a body of research using
similar frameworks to study counterfactuals involving changes in infrastructure within countries. See Donaldson
(2015) and Redding and Turner (2015) for reviews of empirical analyses of actual changes in transport infrastructure,
as well as the literature review below for additional references.
    2
      See Limao and Venables (2001) and Atkin and Donaldson (2015). For a review of various determinants of trade
costs see Anderson and Van Wincoop (2004).
    3
      See WorldBank (2011) and IADB (2013) for assessments of transport costs and infrastructure in Africa and
Latin-America, respectively.


                                                          1
the planner’s problem of simultaneously choosing the transport network (i.e., the set of infrastruc-
ture investments), the allocation of production and consumption, and the gross trade flows across
the graph.
   Solving this problem may be challenging because of dimensionality—the space of all networks
is large—and interactions—an investment in one link asymmetrically impacts the returns to invest-
ments across the network. It is also complicated by the potential presence of increasing returns due
to the complementarity between infrastructure investments and shipping. We exploit the fact that
the planner’s subproblem of choosing gross trade flows is an optimal flow problem on a network,
a well understood problem in the operations research and optimal transport literatures. A key
insight from these literatures is that the optimal flows derive from a “potential field”—prices in our
context—that can be efficiently solved numerically using duality techniques. We make assumptions
such that the full planner’s problem, involving the general equilibrium allocation and the network
investments alongside the optimal transport, inherits the tractability of optimal flow problems. Our
assumptions, including a continuous mapping from infrastructure investments to trade costs and
curvature in the technology to transport goods, ensure that the full planner’s problem is convex,
and that the set of optimal infrastructure investments can be expressed as a function of equilibrium
prices. As a result, we solve the full planner’s problem while avoiding a direct search in the space of
networks. Instead, we optimize in the space of equilibrium prices applying the numerical methods
typically used for optimal transport problems.
   While strong enough congestion in transport guarantees the convexity of the planner’s problem
and enables the use of a duality approach, our framework can also be used when congestion is weak
or absent—a case that implies increasing returns in the transport technology. We numerically ap-
proximate the global solution in non-convex cases by combining the duality approach to obtain the
optimal flows with global-search numerical methods that build upon standard simulated annealing
techniques. Even though in non-convex cases we only find local optima, the ensuing networks dis-
play the qualitative features that one would expect in the presence of economies of scale, such as
more concentration in fewer links and a larger amount of zeros.
   The framework has enough flexibility to be matched to data on actual transport networks. The
quantification relies on two steps. First, the model’s fundamentals can be calibrated such that the
solution to the planner’s optimal allocation of consumption, production, and gross flows matches
spatially disaggregated data on economic activity given an observed transport network. This step
is enabled by the fact that, given the transport network, the welfare theorems hold assuming
Pigouvian taxes to correct congestion externalities. Second, assuming a specific technology to
build infrastructure makes it possible to undertake counterfactuals involving the optimal network.
   We apply these steps in the context of European road networks. We allow locations to be het-
erogeneous in productivity and in the supply of non-traded goods, and calibrate these fundamentals
such that the model reproduces the observed population and value added at a high spatial resolution
separately for each of 24 countries in our data. We construct a measure of the road infrastructure
linking any two contiguous cells in the data, and entertain different assumptions on labor mobility


                                                  2
and on the returns to infrastructure, encompassing both convex and non-convex cases. We either
assume that the observed road network is the outcome of the full planning problem—allowing us
to back out these costs from the first-order conditions of the planner’s problem—or use existing
estimates for how building costs vary with observable geographic features.
    Our counterfactuals in the benchmark parametrization with convex costs imply that, across
countries, the average welfare gain from an optimal 50% expansion in the observed road networks
and the average welfare loss from road misallocation are on average 2% and range between 0.1% and
7%. The optimal expansion or reallocation of roads reduces regional inequalities in real consump-
tion, reflecting that optimal infrastructure investments reduce dispersion in the marginal utility of
consumption of traded commodities. We illustrate the alternative road investment plans implied
by the different assumptions and counterfactuals by considering two of the largest economies in
our data, France and Spain. We conclude with an exercise involving multiple countries in Western
Europe, which highlights the importance of trade across borders and international coordination in
infrastructure policy.
    The rest of the paper proceeds as follows. Section 2 discusses the connection to the literature.
Section 3 develops the framework, establishes its key properties, and discusses the numerical im-
plementation. Section 4 presents simple illustrative examples. Section 5 applies the model to road
networks in Europe. Section 6 concludes. We relegate proofs, additional derivations, details of the
quantitative exercise, tables, and figures to the appendix.


2       Relation to the Literature
    Our paper is related to a recent quantitative literature in international trade and spatial eco-
nomics that studies the role of trade costs in rich geographic settings. Eaton and Kortum (2002)
and Anderson and Van Wincoop (2003) developed quantitative versions of the Ricardian and Arm-
ington trade models, respectively, allowing counterfactuals with respect to trade costs in a multi-
country competitive equilibrium.
    Recent studies undertake counterfactuals with respect to the cost of shipping across specific
links in models where traders choose least cost routes to ship goods.4 Allen and Arkolakis (2014)
measure the aggregate effect of the U.S. highway system, Donaldson and Hornbeck (2016) calculate
the historical impact of railroads on the U.S. economy, and Redding (2016) compares the impact
of infrastructure changes in models with varying degrees of increasing returns. Alder (2019) sim-
ulates counterfactual transport networks in India, Nagy (2016) studies how the development of
U.S. railways affected city formation, and Sotelo (2016) simulates the impact of highway invest-
ments on agricultural productivity in Peru. Other recent studies allowing for factor mobility and
trade frictions within countries include Bartelme (2015), Caliendo et al. (2014) and Ramondo et al.
(2012).

    4
     Chaney (2014a) studies endogenous networks of traders in contexts with imperfect information. For a review of
recent literature on the role of various types of networks in international trade see Chaney (2014b).


                                                        3
    Some papers feature some form of optimization over transport networks. Alder (2019) applies
a heuristic algorithm that adds or removes links in a specific order based on their contribution
to net aggregate income.5 Felbermayr and Tarasov (2015) study optimal infrastructure invest-
ments by competing planners in an Armington model where locations are arranged on a line.
Allen and Arkolakis (2019) compute the welfare gradient with respect to reductions in the cost of
shipping across specific links in an Armington model with spillovers.6 Their approach is suitable to
compute the first-order welfare impact of infrastructure investments around an initially observed
allocation.
    We solve instead a global optimization over the space of networks in a neoclassical framework.
Both our model and the studies cited above include an optimal transport problem, defined as the
trader’s problem of choosing least-cost routes across pairs of locations.7 In most of the studies
cited above, the optimal transport problem does not include congestion and can therefore be solved
independently from any general-equilibrium outcome. In our context, congestion in transport
renders the infrastructure investment problem convex, enabling the search for the global optimum.
The least-cost route optimization present in the applications of the gravity trade models discussed
before corresponds to the solution of our optimal transport problem in the special case in which
there is no congestion.
    As mentioned in the introduction, the planner’s subproblem of choosing how to ship goods given
demand, supply and infrastructure formally defines a type of optimal transport problem. Optimal
transport problems were studied early on by Monge (1781) and Kantorovich (1942).8 Because we
analyze the optimal route problem instead of just the direct assignment of sources to destinations,
our approach is more closely related to optimal flow problems on a network as studied in Chapter
8 of Galichon (2016).9 Our problem differs from this literature in two important aspects. First,
in our model, consumption and production in every location are endogenous because they respond
to standard general-equilibrium forces. Instead, the aforementioned optimal flows problems are
concerned with mapping sources with fixed supply to sinks with fixed demand.10 Second, our
ultimate focus is on the optimization over the transport network itself and in the application of the
model to optimal network investments in the presence of general-equilibrium forces, whereas this
literature usually takes the transport costs between links as a primitive. In that regard, the problem
that we study is akin to the optimal transport network problems in non-economic environments
analyzed in Bernot et al. (2009).
    Despite these differences, our model inherits key appealing properties of optimal transport
problems. While the optimal transport literature shows that strong duality holds under weak
   5
      See Section D of the Supplementary Material for a comparison with the Alder (2019) algorithm.
   6
      Swisher IV (2015) and Trew (2016) allow for endogenous transport costs in different historical contexts.
    7
      Note that “optimal transport” refers to the optimal shipping of goods throughout the network. This is one of
the subproblems embedded in our framework, alongside the optimal network design problem.
    8
      See Villani (2003) for a textbook treatment of the subject.
    9
      See also Bertsekas (1998) for a survey of algorithms and numerical methods for optimal flow and transport
problems on a network.
   10
      See Beckmann (1952) for an early continuous-space example of such an optimal transport problem in economics.
See Carlier (2010) and Ekeland (2010) for lecture notes on optimal transport and its connection to economics.


                                                        4
conditions in a wide variety of environments, it holds under some conditions in our model as a
special case of convex duality. Hence, our way of embedding an optimal transport problem into a
general neoclassical equilibrium model extended with a network design problem does not preclude
the validity of key earlier insights from the optimal transport literature. The main benefit of duality,
in our context, is a reduction of the search space and substantial gains in computation times.11
    A large body of research estimates how actual changes in transport costs impact economic
activity. For instance, Fernald (1999) estimates the impact of road expansion on productivity
across U.S. industries; Chandra and Thompson (2000), Baum-Snow (2007) and Duranton et al.
(2014) estimate the impact of the U.S. highways on various regional economic outcomes; Donaldson
(2010) estimates the impact of access to railways in India; and Faber (2014) estimates the impact
of connecting regions to the expressway system in China.12 Our application measures the aggregate
country-level welfare gains from optimally expanding current road networks. In the counterfactuals,
we inspect the relationship between infrastructure investment and growth across regions.
    Finally, we also apply the model to measure the potential losses from misallocation of roads.
Therefore the paper is broadly related to the literature on the aggregate effects of misallocation
such as Restuccia and Rogerson (2008) and Hsieh and Klenow (2009). Desmet and Rossi-Hansberg
(2013), Brandt et al. (2013), Asturias et al. (2016), Fajgelbaum et al. (2018) and Hsieh and Moretti
(2019) among others focus on misallocation across geographic units arising from frictions or spatial
policies.


3     Model
3.1    Environment
Preferences       The economy consists of a discrete set of locations J = {1, .., J}. We let Lj be the
number of workers located in j ∈ J , and L be the total number of workers. We entertain cases with
and without labor mobility. Workers consume a bundle of traded goods and a non-traded good in
fixed supply, such as land or housing. Utility of an individual worker who consumes c units of the
traded goods bundle and h units of the non-traded good is

                                                   u = U (c, h) ,                                                 (1)

where the utility function U is homothetic and concave in both of its arguments. In location j,
per-capita consumption of traded goods is cj = Cj /Lj , where Cj is the aggregate demand of the
traded goods bundle in location j.
    There is a discrete set of tradable sectors n = 1, .., N , combined into Cj through a homogeneous

   11
      A network-design and planning literature in operations research studies related network-design problems in
telecommunications and transport without embedding them in general-equilibrium spatial models. See Ahuja et al.
(1989) for a handbook treatment.
   12
      See also Coşar and Demir (2016) and Martincus et al. (2017) for empirical studies of how infrastructure invest-
ments impact international shipments.


                                                          5
of degree 1 and concave aggregator,
                                                                      
                                             Cj = Dj Dj1 , . . . , DjN ,                            (2)

where Djn is sector n’s output used in location j.

Production      The supply-side corresponds
                                               to a standard neoclassical economy. In addition to
                                                       ′
                                       1
labor, there is a fixed supply Vj = Vj , . . . , VjM of primary factors m = 1, .., M in location j.
These factors are immobile across regions but mobile across sectors. The production process may
also use goods from other sectors as intermediate inputs. Output of sector n in location j is:
                                                                     
                                            Yjn = Fjn Lnj , Vjn , Xnj ,                             (3)
                                                             ′
where Lnj is the number of workers, Vjn = Vj1n , . . . , VjM n is the quantity of other primary factors,
                             
and Xnj = Xj1n , . . . , XjN n is the quantity of each sector’s output allocated to the production of
sector n in location j. The production function Fjn is either neoclassical (constant returns to scale,
increasing and concave in all its arguments) or a constant (endowment economy).

Underlying Graph             The locations J are arranged on an undirected graph (J , E), where E de-
notes the set of edges (i.e., unordered pairs of J ). For each location j there is a set N (j) of
connected locations, or neighbors.13 Goods can only be shipped through connected locations; i.e.,
goods shipped from j can be sent to any k ∈ N (j), but to reach any k ′ ∈
                                                                        / N (j) they must transit
through a sequence of connected locations. The transport network design problem will consist of
determining the level of infrastructure linking each pair of connected locations. A natural interpre-
tation is that j is a geographic unit such as county, N (j) are its bordering counties, and shipments
are done by land. More generally, the neighbors in the model do not need to be geographically
contiguous, since it could be possible to ship directly between geographically distant locations by
land, air or sea. The fully connected case in which every location may ship directly to every other
location, N (j) = J for all j, is one special case.

Transport Technology             In the model, goods transit through several locations before reaching
a point where they are consumed or used as intermediate input. We let Qnjk be the quantity of
goods in sector n shipped from j to k ∈ N (j), regardless of where the good was produced. We
adopt two alternative specifications for transport costs: iceberg costs without congestion across
commodities, and a case with cross-goods congestion. For simplicity of exposition, we discuss
the former case here. In section 3.7 we discuss congestion across goods, which will also be the
benchmark specification in our applications. Appendix A presents the model in a general case
encompassing both formulations.


  13
       We adopt the convention that N (j) does not include j.


                                                         6
                                                           n units of the good n itself, so that
    Transporting each unit of good n from j to k requires τjk
     n corresponds to the iceberg cost. This per-unit cost is specified as a function of the total
1 + τjk
quantity Qnjk of good n shipped along the link jk and of the level of infrastructure Ijk :

                                                    n
                                                                       
                                                   τjk = τjk Qnjk , Ijk .                                          (4)

The per-unit cost of shipping is increasing in the quantity of commodities shipped:

                                                     ∂τjk (Q, I)
                                                                 ≥ 0.                                              (5)
                                                        ∂Q

This assumption allows for decreasing returns in the shipping sector. We refer to these decreasing
returns as congestion, with the understanding that this concept encapsulates several real-world
forces whereby an increase in shipping activity leads to higher marginal transport costs. These
forces may include higher travel times or road damage, as well as decreasing returns to scale in
transportation due to land-intensive fixed factors such as warehousing or specialized inputs. In
short, the more is shipped, the higher the per-unit shipping cost.14
    We interpret Ijk as capturing features that lead to reductions in the cost of transporting goods.
For example, when shipping over land, Ijk may correspond to whether a road linking j and k is
paved, its number of lanes or the availability of roadside services. Hence, we assume:

                                                     ∂τjk (Q, I)
                                                                 ≤ 0.
                                                         ∂I

    The transport technology τjk (·) is allowed to vary by jk, capturing variation in shipping costs
across links for the same quantity shipped and infrastructure. This variation may reflect geographic
characteristics such as distance or ruggedness. The per-unit cost function τjk (Q, I) may also depend
on the direction of the flow; e.g., if elevation is higher in j than k and it is cheaper drive downhill
then τjk (Q, I) < τkj (Q, I).

Flow Constraint            In every location there may be tradable commodities being produced, as well
as coming in or out. The balance of these flows requires that, for all locations j = 1, .., J and
commodities n = 1, .., N ,
                               X        ′
                                               X                 n                  X
                       Djn +         Xjnn +                  n
                                                        1 + τjk  Qjk    ≤ Yjn +              Qnij .                (6)
                                n′            k∈N (j)                              i∈N (j)
                       |                      {z                    }        |      {z         }
                           Consumption +Intermediate Use+ Exports           Production + Imports




   14
      For a review of the early literature on production-function estimates of returns to scale in the transport sector
see Winston (1985). Newbery (1988) theoretically studies road damage externalities, whereby the the road damage
caused by one vehicle increases the operating costs of subsequent vehicles. Maibach et al. (2013) lists higher travel
times, higher accident rate, and road damage as reasons why increased road use may impact transport costs. Other
social costs include environmental damage and noise.


                                                             7
The left-hand side of this inequality is location j’s consumption Djn of good n, intermediate-input
        ′
use Xjnn by each sector n′ , exports to neighbors Qnjk and inputs to the transport sector τjk
                                                                                           n Qn .
                                                                                              jk
These flows are bounded by the local production Yjn and imports from neighbors Qnij . In standard
minimum-cost flow problems this restriction is known as the conservation of flows constraint.
   We let Pjn be the multiplier of this constraint. This multiplier reflects society’s valuation of a
marginal unit of good n in location j. In the decentralized allocation, this multiplier will equal the
price of good n in location j. Therefore, we refer to Pjn as the price of good n in location j.

Network Building Technology           We define the transport network as the distribution of infras-
tructure {Ijk }j∈J ,k∈N (j) . The network-design problem will determine this distribution. We assume
that building infrastructure requires a resource (“concrete” or “asphalt”) in fixed aggregate supply
K, which can be freely shipped across locations and cannot be used for other purposes. This as-
sumption represents a situation where an amount of resources has been sunk into network-building
but must still be allocated across the network. When characterizing the planner’s problem, it will
lead to the intuitive property that the opportunity cost of building infrastructure in any location
is only foregoing infrastructure elsewhere.
   The cost of setting up infrastructure may vary across links jk. Specifically, building a level of
                                                             I I
infrastructure Ijk on the link jk requires an investment of δjk  jk units of K. The network-building
constraint therefore is:
                                       X X
                                                         I
                                                        δjk Ijk ≤ K.                              (7)
                                         j    k∈N (j)

We allow the network-design problem to take place when some lower bound for infrastructure I jk
is already in place, and we also allow (but do not require) an upper bound I jk to how much can
be built, possibly representing geographic constraints on the capacity to build on a specific link.
While the graph (J , E) is undirected, there is no need to impose symmetry in investments or costs
between connected locations.
                                                                                               I
   While both the transport technology τjk (Q, I) in (4) and the infrastructure building cost δjk
may vary across links jk, each type of variation reflects different forces. Variation in τjk (Q, I) by
jk captures how features of the terrain impact per-unit shipping costs given quantity shipped and
                         I captures the marginal cost of setting up infrastructure. In the planner’s
infrastructure, whereas δjk
                I will not impact the allocation other than through infrastructure I .
problem below, δjk                                                                  jk


3.2   Planner’s Problem
   We solve the problem of a utilitarian social planner who maximizes welfare under two extreme
scenarios: either labor is immobile or freely mobile. In the former case, we let ωj be the planner’s
weight attached to each worker located in region j. We define each problem in turn.




                                                        8
Definition 1. The planner’s problem with immobile labor is
                                                                                       X
                               W =                            max                           ωj Lj U (cj , hj )
                                                   cj ,hj ,{Ijk }k∈N (j) ,              j
                                         n                                        o
                                                   j ,Vj ,Xj ,{Qjk }
                                             Djn ,Ln   n   n    n
                                                                        k∈N (j)   n



subject to:
    (i) availability of traded commodities,
                                                                                  
                                               cj Lj ≤ Dj Dj1 , .., DjN               for all j;

and availability of non-traded commodities,

                                                          hj Lj ≤ Hj for all j;

    (ii) the balanced-flows constraint,
               X       ′      X                                                                  X
       Djn +        Xjnn +              1 + τjk Qnjk , Ijk             Qnjk ≤ Fjn Lnj , Vjn , Xnj +   Qnij for all j, n;
               n′            k∈N (j)                                                                      i∈N (j)


    (iii) the network-building constraint,
                                                       X X
                                                                         I
                                                                        δjk Ijk ≤ K,
                                                          j   k∈N (j)


subject to a pre-existing network,

                                       0 ≤ I jk ≤ Ijk ≤ I jk ≤ ∞ for all j, k ∈ N (j);

    (iv) local labor-market clearing,
                                                       X
                                                              Lnj ≤ Lj for all j;
                                                          n

and local factor market clearing for the remaining factors,
                                             X
                                                  Vjmn ≤ Vjm for all j and m; and
                                              n


    (v) non-negativity constraints on consumption, flows, and factor use,

                                          Cjn , cj , hj       ≥     0 for all j ∈ N (j) , n
                                                   Qnjk       ≥     0 for all j, k ∈ N (j) , n
                                             Lnj , Vjmn       ≥     0 for all j, m, n.

    If labor is freely mobile then the problem is defined as follows.




                                                                        9
Definition 2. The planner’s problem with labor mobility is

                                          W =                     max                           u
                                                        u,cj ,hj ,{Ijk }k∈N (j) ,Lj ,
                                                 n                                      o
                                                           j ,Vj ,Xj ,{Qjk }
                                                     Djn ,Ln   n   n    n
                                                                              k∈N (j)       n


subject to restrictions (i)-(v) above; as well as:
    (vi) free labor mobility,
                                        Lj u ≤ Lj U (cj , hj ) for all j; and

    (vii) aggregate labor-market clearing,
                                                          X
                                                                Lj = L.
                                                            j

    This formulation restricts the planner’s problem to allocations satisfying utility equalization
across locations, a condition that must hold in the competitive allocation. Since U is strictly
increasing, restriction (vi) implies that the planner will allocate u = U (cj , hj ) across all populated
locations, and cj = 0 otherwise.
    We stop for a moment to discuss the generality achieved in the previous definitions. The
case without labor mobility corresponds to international trade models. The production structure
encompasses neoclassical trade models.15 When labor mobility is allowed, the model nests urban
economics model with a single homogeneous tradeable good in the tradition of Roback (1982).
Since we have assumed neoclassical production functions, this formulation does not encompass
new economic geography models such as Krugman (1991) and Helpman (1998) nor quantitative
extensions with increasing returns (Allen and Arkolakis, 2014; Redding, 2016). In Section 3.7 we
discuss how to implement some cases with increasing returns and provide some examples.
    The planner’s problem from Definition 1 can be expressed as nesting three problems:
                                                                                 X
                            W = max max
                                     n
                                                             max                        ωj Lj U (cj , hj )
                                    Ijk    Qjk   {cj ,hj ,Djn ,Lnj ,Vjn ,Xnj }    j


subject to the constraints. The innermost maximization problem is a standard allocation problem
of choosing consumption and factor use subject to the production possibility frontier and the
availability of goods in each location. In what follows we refer to it as the “optimal allocation”
subproblem. We now discuss some intuitive features of the solution to optimal flows subproblem
over Qnjk and the network design problem over Ijk .

Optimal Flows The optimal flow problem that determines the gross flows Qnjk combines an
optimal transport problem—how to map production sources to destinations—and a least-cost route
problem with congestion. Under the assumption that domestic absorption Djn and production Yjn
are taken as given, this problem is well known in the optimal transport literature (see, for instance,
   15
     The Armington model (Anderson and Van Wincoop, 2003) corresponds to N = J (as many sectors as regions)
and Fjn = 0 for n 6= j, so that Yjj is region j’s output in the differentiated commodity that (only) region j produces.
The Ricardian model corresponds to labor as the only factor of production and linear technologies, Yjn = zjn Ln j . The
specific-factors and Hecksher-Ohlin models are also special cases.


                                                                 10
Chapter 8 of Galichon (2016) or Chapter 4 of Santambrogio (2015)) and in operations research
(Bertsekas, 1998). A general lesson from these literatures is that these problems are well behaved
and admit strong duality. In other words, while the least-cost route and the optimal coupling
of sources to destinations may appear to be high-dimensional problems, the solution boils down
to finding a “potential field”, meaning one Lagrange multiplier (or price) for each location-good
pair, and then expressing the flows as a function of the difference between the multipliers across
locations.
   The optimal flow problem in our model shares these properties as a special case of convex
duality. To understand the solution, remember that Pjn is the multiplier of the flows constraint
(ii), equal to the price of good n in location j in the market allocation according to Proposition
4 below. The first-order condition (A.1) from the planner’s problem in Appendix (A.1) gives the
following equilibrium price differential for commodity n between j and k ∈ N (j):
                                                 n
                                               ∂τjk
                              Pkn         n
                                  ≤ 1 + τ jk +      Qn , = if Qnjk > 0.                           (8)
                              Pjn              ∂Qnjk jk

Condition (8) is a no-arbitrage condition: the price differential between a location and its neighbors
must be less than or equal to the marginal transport cost. From the planner’s perspective, this
marginal cost takes into account the diminishing returns due to congestion. In the absence of
              n /∂Q
congestion, ∂τjk    jk = 0, the price differential would be bounded by the trade cost.
   This expression has a number of intuitive properties. Given the network investment, it identifies
the trade flow Qnjk as a function of the price differential, as long as the right-hand side can be
inverted. The inversion is possible if the total transport cost Qnjk τjk
                                                                      n is convex in the quantity

shipped. In that case, the gross trade flow Qnjk is increasing in the price differential. Condition
(8) also implies that goods in each sector flow in only one direction, although a link may have
flows in opposite directions corresponding to different sectors. In addition, not all goods need to be
shipped, and some links may be unused despite having positive infrastructure. This may occur if
the price gap is not large enough at zero trade to justify shipping. To help visualize the geometric
properties of the problem, Figure 1 illustrates how a price field can implement the optimal flows
given consumption and production in an example with a single traded commodity. In the example,
the good is produced in the location at the origin (blue circle) and demanded in ten locations (red
circles). This example uses the functional form for τjk in (10), which implies that there are some
shipments in every link although they become negligible in regions far away from the points of
production and consumption. The prices, represented on the z-axis, attain their lowest value at
the point of production, and gradually increase with the distance to that point. The optimal flows
follow the price gradient according to equation (8) under equality. The consumption locations are
local peaks of the price field as long as they do not re-ship the good.
   The least-cost route optimization present in the applications of gravity trade models discussed
in the literature review corresponds to the solution to this optimal transport problem assuming
no congestion. In that case, the optimal transport problem can be solved independently from


                                                 11
                      Price P




                                                  y                            x


                 Figure 1: Example of Optimal Flows as a Function of the Price Field
Notes: The picture shows an example of optimal flows in a 15 × 15 square network with uniform infrastructure across
links and one good produced at the origin (blue circle) and consumed in 10 other locations (orange circles). The
price in each location is indicated by the z-axis coordinate, and corresponds to a solution of the optimal flow problem
given production, consumption and population. The density of flows is represented by the thickness of links and their
direction is indicated by the arrows.


the rest of the model. In our case, determining the least-cost routes requires information about
the flows, the supply, and the demand for each good, which are endogenously solved as part of
the allocation. Therefore, the optimal transport problem must be solved jointly with the optimal
allocation problem.

Optimal Network Consider now the outer problem of choosing the transport network Ijk for
all j ∈ J and k ∈ N (j). Letting PK be the multiplier of the network-building constraint (iii) (in
other words, the shadow price of asphalt), and as long as the (possibly infinite) upper bound I jk
is not binding, the planner’s choice for Ijk implies
                                                                                            n    
                                           I
                                                                X                          ∂τjk
                                       PK δjk            ≥              Pjn Qnjk       −              ,            (9)
                                       | {z }                       n
                                                                                           ∂Ijk
                                Marginal Building Cost          |             {z                  }
                                                             Marginal Gain from Infrastructure


with equality if there is actual investment, Ijk > I jk . This condition compares the marginal cost
and benefits from investing on the link jk. The left-hand side is the opportunity cost of building
an extra unit of infrastructure along jk, equal to the marginal value of the scarce resource K in
                                                                                           I at
the economy (the multiplier PK of the the network building constraint (7)) times the rate δjk
which that resource translates to infrastructure. The gain from the additional infrastructure, on
the right hand side of (9), is the reduction in per-unit shipping costs, −∂τjk /∂Ijk , applied to the




                                                               12
value of the goods used as input in the transport technology.16
    Importantly, the network investment problem inherits the properties that make the optimal
transport problem tractable. Substituting the solution for Qnjk as function of the price differentials
Pkn /Pjn into (9) implies that the optimal infrastructure Ijk between locations j and k is only a
function of prices in each location. Hence, rather than searching in the very large space of all
networks, this condition allows us to solve for the optimal investment link by link given the smaller
set of all prices. Similar properties can be attained in a case with cross-goods congestion, as
described in Appendix Section (3.6).

3.3     Properties
Convexity       We establish conditions for the convexity of the planner’s problem, which guarantee
its numerical tractability.

Proposition 1. (Convexity of the Planner’s Problem) (i) Given the network {Ijk }, the joint op-
timal transport and allocation problem in the fixed (resp. mobile) labor case is a convex (resp.
quasiconvex) optimization problem if Qτjk (Q, Ijk ) is convex in Q for all j and k ∈ N (j); and (ii)
if in addition Qτjk (Q, I) is convex in both Q and I for all j and k ∈ N (j), then the full planner’s
problem including the network design problem from Definition 1 (resp. Definition 2) is a convex
(resp. quasiconvex) optimization problem. In either the joint transport and allocation problem, or
the full planner’s problem, strong duality holds when labor is fixed.

    The first result establishes that the joint optimal allocation and optimal transport subproblems,
taking the infrastructure network {Ijk } as given, define a convex problem for which strong duality
holds under the mild requirement that the transport technology Qτjk (Q, Ijk ) is (weakly) convex
in Q. This property ensures that our specific way of introducing an optimal-transport problem
into a general neoclassical economy is tractable. Specifically, it guarantees the existence of La-
grange multipliers that implement the optimal allocation and transport subproblems and ensures
the sufficiency of the Karush-Kuhn-Tucker (KKT) conditions, in turn allowing us to apply a du-
ality approach to solve the model numerically—an approach which, as discussed in Section 3.6,
substantially reduces computation times. Even if the full problem, including the network design,
is not convex due to increasing returns to the network building technology (i.e., if part (ii) of the
proposition fails but part (i) holds), a large subset of the full problem can still be solved using these
efficient numerical methods.
     The second result establishes the convexity of the full planner’s problem, including the network
design, under the stronger requirement that the transport cost function Qτjk (Q, Ijk ) is jointly

   16
     Various papers measure the first-order impact of changes in bilateral trade costs on world welfare
(Atkeson and Burstein, 2010; Burstein and Cravino, 2015; Lai et al. 2015; Allen et al., 2014) or in trade costs in
specific links of a transport network on country-level welfare (Allen and Arkolakis, 2019) around an observed equilib-
rium. The right-hand side of (9) could be used for a similar purpose, given a specific set of changes in trade costs. In
our context, this expression is one part of the full characterization of the global optimum, alongside with the optimal
allocation and optimal flows.


                                                          13
convex in Q and I.17 This condition restricts how congestion in shipping and the returns to
infrastructure enter in the transport technology in each link through τjk (Q, I). In the absence of
congestion (i.e., if ∂τjk /∂Q = 0), convexity fails unless τjk is a constant. The intuition for this
convexity requirement is that the model features two complementarity forces between infrastructure
investments and commodity shipments: the higher the investment in a link, the lower the transport
costs and the higher the flows. In turn, higher shipments lead to more congestion and to more
incentives to develop its infrastructure. The global convexity of the transport cost function ensures
that the congestion forces eventually dominate and that the solution to the investment problem is
interior and stable. Section E of the Supplementary Material develops this point more formally.

Log-Linear Parametrization of Transport Costs A convenient parametrization of (4) is the
constant-elasticity transport technology,

                                                 τ    Qβ
                                   τjk (Q, I) = δjk      with β ≥ 0, γ ≥ 0.                                    (10)
                                                      Iγ
If β > 0, this formulation implies congestion in shipping: the more is shipped, the higher the per-
unit shipping cost; when β = 0, the marginal cost of shipping is invariant to the quantity shipped,
as in the standard iceberg formulation. In turn, γ captures the elasticity of the per-unit cost to
                            τ captures the geographic frictions that affect per-unit transport costs
infrastructure. The scalar δjk
given the quantity shipped Q and the infrastructure I.
    When the transport technology is given by (10), many of the preceding results admit intuitive
closed-form formulations. First, the restriction that Qτjk (Q, I) is convex in both arguments from
Proposition 1 holds if and only if β ≥ γ. This inequality captures a form of diminishing returns
to the overall transport technology: the elasticity of per-unit transport costs to investment in
infrastructure is smaller than its elasticity with respect to shipments.
    Second, from the no-arbitrage condition (8), we obtain the following solution for total flows
from j to k as function of prices:
                                          "       γ
                                                             (             )# 1
                                             1 Ijk               Pkn          β

                                  Qnjk   =        τ max              − 1, 0     .                              (11)
                                           1 + β δjk             Pjn

This solution naturally implies that better infrastructure is associated with higher flows given prices
and geographic trade frictions. It also shows that the total flows fall with congestion β and increase
with the average price differentials. Third, using the log-linear transport technology (10), the



  17
      The proof of Proposition 1 is immediate: given the neoclassical assumptions, the objective function is concave
and the constraints are convex, except possibly for the balanced-flows constraint; convexity of the transport cost
Qτjk (Q, Ijk ) ensures convexity of that constraint as well. In the case with labor mobility, the planner’s problem
can only be recast as a quasiconvex optimization problem, but the Arrow-Enthoven theorem for the sufficiency of
the Karush-Kuhn-Tucker conditions under quasiconvexity, requiring that the gradient of the objective function is
different from zero at the optimal point, is satisfied (Arrow and Enthoven, 1961).


                                                        14
optimal level of infrastructure is
                                                   ∗
                                                                   
                                     Ijk = min max Ijk , I jk , I jk ,                              (12)

       ∗ is the optimal infrastructure (9) arising from the unconstrained optimal-network problem
where Ijk
(I jk = 0 and I jk = ∞) ,
                                      "                                  !#    1
                                           τ
                                ∗       γ δjk     X               1+β        1+γ

                               Ijk   =     I
                                                       Pjn Qnjk                     .               (13)
                                       PK δjk     n

Given the prices at origin, the optimal infrastructure increases with gross flows. Given these flows,
infrastructure also increases with prices at origin, as a higher sourcing cost implies a higher marginal
                                                                                      τ , reflecting
saving from investing. Conditioning on these outcomes, infrastructure increases with δjk
                                                                                    I , reflecting that
that the optimal investments offset geographic trade frictions, and decreases with δjk
the investment is smaller where it is more costly to build. Because it satisfies the Inada condition,
the log-linear specification (10) implies that the solution to the planner’s problem features a positive
investment whenever the price of any good varies between neighboring locations, Pjn 6= Pkn for any
n.
     Combining (11) with (9), we reach an explicit characterization of the optimal infrastructure in
each link as function of prices, elasticities and geographic frictions:
                                                                                  β
                                                                            ! 1+β  β−γ
                                                                               β
                    ∗              γ        1
                                                       X              Pkn
                                                                Pjn
                                                                                 
                   Ijk =                                                 −1           .           (14)
                                I
                                    1 1 + β
                                      τ  β                            Pjn
                            PK δjk   δjk           n:Pkn >Pjn


where the multiplier PK is such that the network-building constraint (7) is satisfied.

Proposition 2. (Optimal Network in Log-Linear Case) When the transport technology is given
by (10), the full planner’s problem is a convex (resp. quasiconvex) optimization problem if β ≥ γ.
The optimal infrastructure is given by (12) implying that, in the absence of a pre-existing network
(I jk = 0), then Ijk = 0 ⇔ Pkn = Pjn for all n.

     Under a general formulation of the transport technology τjk (Q, I) and in the absence of a
pre-existing network (I jk = 0), then the solution to the full planner’s problem may feature no
infrastructure (and therefore no trade) in some links, even if prices vary between the nodes con-
nected by those links. However, when the transport technology takes the loglinear form (10), this
possibility arises if and only if there are no incentives to trade (Pjn = Pkn for all n) due to the Inada
condition on Ijk in the transport technology (10) and the property that the marginal shipping costs
are zero when no shipping is done as long as β ≥ 0, respectively.

Other Convex Transport Technologies               We provide two additional tractable transport tech-
nologies and the conditions that satisfy their convexity.
                                    τ max (exp (βQ − γI) − 1, 0), convex for all β ≥ 0, γ ≥ 0;
     1. Exponential: Qτjk (Q, I) = δjk

                                                      15
                                            1
                         τ max Qβ − ζI γ , 0 γ , ζ ≥ 0, convex for 0 ≤ γ ≤ 1 and β ≥ γ.
  2. CES: Qτjk (Q, I) = δjk

Non-Convexity: the Case of Increasing Returns to Transport                     When the condition guar-
anteeing global convexity in Proposition 1 fails, the constraint set in the planner’s problem is not
convex, and the sufficiency of the first-order conditions is not guaranteed. We may nonetheless
implement these cases numerically, as we discuss in Section 3.6. Focusing on the log-linear spec-
ification (10) introduced above, such nonconvexities arise when the transport technology features
economies of scale, γ > β. We now show in a simple special case how the qualitative properties of
the optimal network are affected by such economies of scale. In particular, increasing returns to
investment in infrastructure create an incentive for the planner to concentrate flows on few links.
As a result, the optimal network may take the form of a tree, a property already highlighted in
other applications of optimal transport such as formation of blood vessels, irrigation or electric
power supply systems (Banavar et al., 2000; Bernot et al., 2009).

Proposition 3. In the absence of a pre-existing network (i.e., I jk = 0, I jk = ∞), if the transport
technology is given by (10) and satisfies γ > β, and if there is a unique commodity produced in a
single location, the optimal transport network is a tree.

   A tree is a connected graph without loops. Intuitively, under the conditions of the proposition,
it is always better to remove alternative paths linking pairs of nodes and concentrate infrastructure
investments in fewer links. As a result, in the optimal network a single path connects any two
locations, a defining characteristic of a tree. This property is guaranteed to hold when there is only
one source for one commodity. In the general case, it may still be optimal to maintain loops but the
incentives to concentrate flows on fewer but larger routes remain. In Section 4 we present examples
with multiple goods and multiple production locations where, if γ > β, the optimal network is
sparser and concentrated on fewer links relative to cases with γ ≤ β.

3.4   Decentralized Allocation Given the Network
   We establish that the planner’s optimal allocation (maxcj ,hj ,Djn ,Lnj ,Vjn ,Xnj ) and optimal transport
(maxQnjk ) subproblems given the network {Ijk } correspond to a decentralized competitive equilib-
rium. For this decentralization, we do not take a stand on whether the network is the result of a
planner’s optimization.
   Given the network, the decentralized economy corresponds to the perfectly competitive equi-
librium of a standard neoclassical economy where consumers maximize utility given their budget,
producers maximize profits subject to their production possibilities, and goods and factor markets
clear. The only less standard feature is the existence of a transport sector with congestion. We
assume free entry of atomistic traders into the business of purchasing goods in any sector at ori-
gin o and delivering at destination d for all (o, d) ∈ J 2 . The traders are price-takers and use a
                                                                                n q n of delivering
constant-returns to scale shipping technology. Each trader has a cost equal to τjk jk




                                                    16
 n units of good n from j to k ∈ N (j) and takes the iceberg trade cost τ n as given, although this
qjk                                                                      jk
trade cost is determined endogenously through (10) as function of the aggregate quantity shipped.
   As long as there is congestion in shipping, the traders will engage in an inefficient amount
of shipping. We assume that the market allocation features policies that correct this externality.
Specifically, the shipments of commodity n over link jk are subject to ad-valorem taxes ετQ,jknτjk
                                                                                                n

on their value at j. Consider then a trader purchasing good n at location o and delivering it to
location d. This company maximizes profits by optimizing over the route r = (j0 , . . . , jρ ) ∈ Rod ,
where j0 , . . . , jr is a sequence of nodes from o to d and Rod is the set of all such routes. The optimal
       n maximizes the per-unit profits:
route rod

                                                                               ρ−1
                                                                               X                          ρ−1
                                                                                                          X
                 n
                πod   =         max             pnd   −        pno         −         pnjk τjnk jk+1   −         pnjk tnjk jk+1 ,   (15)
                          r=(j0 ,...,jρ )∈Rod                 |{z}
                                                          Sourcing Costs       k=0                        k=0
                                                                               |       {z        }        |       {z         }
                                                                               Transport costs                  Taxes


where pnj is the price of good n in location j in the market allocation. A shipper from o to d
purchases each unit at price pno and obtains the price pnd . In addition, shippers must pay the
transport costs pnjk τjnk jk+1 as well as the “toll” pnjk tnjk jk+1 on each segment. In the absence of tolls,
the shipping cost from o to d would equal the total iceberg cost, and the solution would correspond
to a standard least-cost route optimization.
   To define the competitive equilibrium, we must also allocate the returns to factors other than
labor. Under no labor mobility we assume that, in addition to the wage, each worker in location
                                   PJ
j receives a transfer tj such that  j=1 tj Lj = Π, where Π is an aggregate portfolio including
ownership of fixed factors and government transfers. Hence, workers are rebated all tax revenues
and own the primary factors and non-traded goods in the economy. This formulation allows for
trade imbalances, which are needed to implement the planner’s allocation.
   Since it is standard, we relegate the Definition 3 of the competitive allocation with and without
labor mobility to the appendix. Using that definition, we establish that the welfare theorems given
the transport network hold.

Proposition 4. (First and Second Welfare Theorems) If the tax on shipments of product n from
j to k is
                                                           tnjk = ετQ,jknτjk
                                                                          n
                                                                             ,

where ετQ,jkn = ∂ log τjk
                       n /∂ log Qn , then:
                                 jk
   (i) if labor is immobile, the competitive allocation coincides with the planner’s problem under
specific planner’s weights ωj . Conversely, the planner’s allocation can be implemented by a market
allocation with specific transfers tj ; and
   (ii) if labor is mobile, the competitive allocation coincides with the planner’s problem if and only
if all workers own an equal share of fixed factors and tax revenue regardless of their location, i.e.,
       Π
tj =   L.
   In either case, the price of good n in location j, pnj , equals the multiplier on the balanced-flows

                                                                     17
constraint in the planner’s allocation, Pjn .

   These results are useful for bringing our model to the data. Under the assumption that the ob-
served allocation corresponds to the decentralized equilibrium, the first welfare theorem enables us
to calibrate the model using the planner’s solution to the optimal allocation and optimal transport
subproblems given the network. In Section 3.7, we discuss how to calibrate the model assuming
that the observed market allocation does not feature policies correcting the externality.. We note
                                                                              n = pn ετ
that the optimal allocation can be equivalently implemented by per-unit toll θjk             n
                                                                                   jk Q,jkn τjk .


3.5   Decentralization of Network Investments
   We now discuss a market structure that efficiently decentralizes the infrastructure investments.
Consider a decentralized allocation as in Definition 3, including tolls. Suppose that, in addition, Ijk
is endogenously determined by a link-specific builder who is granted the right to build infrastructure
                                          n . Builders can purchase the “asphalt” K at a price p ,
and receives in exchange a per-unit toll θjk                                                    K
the stock of K may be initially owned by the government or by private individuals, and the price
pK adjusts such that the market for K clears. The builders will solve the problem
                                          X
                                  max         Qnjk (Ijk ) θjk
                                                           n        I
                                                              − pK δjk Ijk ,
                                    Ijk
                                          n

where Qnjk (Ijk ) is the quantity of good n consistent with zero profits of shipping companies on the
link jk given infrastructure Ijk , given the prices faced by these shipping companies. The builders
internalize that by adding infrastructure they can increase the flow of goods through their link, but
we assume that they do not internalize general-equilibrium impacts on commodity prices. Now,
the specific transfers tj exhaust a portfolio Π which, in addition to fixed factors and government
transfers, also includes ownership of K and net profits of builders.
   We then obtain the following result.

Proposition 5. If the global convexity condition of Proposition 1 is satisfied and the toll θjk  n is

                                            n = P n ετ
consistent with the optimal Pigouvian tax (θjk            n
                                                 j Q,jkn τjk ), then the decentralized infrastructure
choice implements the optimal network investment.

   This result echoes the self-financing theorem of Mohring and Harwitz (1962) who showed that
revenues from optimal congestion taxes are sufficient to cover capital costs of roads when the
transport cost can be expressed as a function of the ratio Q/I. Our result is not restricted to
the case in which the transport cost function is homogeneous of degree 0. The global convexity
condition of Proposition 1 ensures the sufficiency of the first-order conditions in implementing the
optimal allocation. In this general case, however, lump-sum transfers to builders may be needed to
ensure participation.




                                                     18
3.6    Numerical Implementation
    In this section we broadly discuss our numerical implementation and relegate details to Section
D of the Supplementary Material.

Convex Cases Under the conditions of Proposition 1, the full planner’s problem is a convex
optimization problem and the KKT conditions are both necessary and sufficient. The system of
first-order conditions is, however, a large system of non-linear equations with many unknowns.
Gradient-descent based algorithms make large-scale convex optimization problems like ours numer-
ically tractable, meaning that these algorithms are guaranteed to converge to the unique global
optimum (Boyd and Vandenberghe, 2004).18
    Our problem can be tackled numerically using two equally valid approaches. The first one is
to feed the numerical solver with the primal problem, meaning the full planner’s problem exactly
as written in Definition 1. Specifically,
                                         letting L be the Lagrangian of the planner’s     problem   as
                                          n    n    n    n                                   n
a function of the controls x = cj , hj , Dj , Lj , Vj , Qjk , . . . and the multipliers λ = Pj , . . . , the
primal consists of solving the saddle-point problem

                                              sup inf L (x, λ) .
                                                x λ≥0

The second approach, preferred in the optimal transport literature, is to solve instead the dual
problem obtained by inverting the order of optimization, i.e.,

                                               inf sup L (x, λ) .
                                              λ≥0 x


In our context, the convexity of the full planner’s problem without labor mobility ensures that
the dual coincides with the primal (Proposition 1), i.e., strong duality holds. The advantage of
the dual is that we can use the first-order conditions from the optimal transport and the optimal
investment problems, (8) and (13), as well as those from the neoclassical allocation problem, to
express the control variables as functions of the multipliers, x (λ). The remaining minimization
problem, infλ≥0 L (x (λ) , λ), is a convex minimization problem over fewer variables, subject to
non-negativity constraints only.

Non-Convex Cases When the condition stated in Proposition 1 fails, the full planner’s problem
is no longer globally convex, and the method described above is not guaranteed to find the global
optimum. To solve for such non-convex cases, we exploit the property, stated at the beginning of
Proposition 1, that the joint neoclassical allocation and optimal transport problem nested within
the planner’s problem is convex as long as Qτjk (Q, Ijk ) is convex in Q. This condition is weaker
and holds under the log-linear specification as long as β ≥ 0, including the standard case without

  18
     We use the open-source large-scale optimization package IPOPT (https://projects.coin-or.org/Ipopt) which is
based on an interior point method and is able to handle thousands of variables as long the problem is sufficiently
sparse. The software converges in polynomial time (Nesterov and Nemirovskii, 1994).


                                                       19
congestion (β = 0). We combine the primal and dual approaches to solve for the joint neoclassi-
cal allocation and optimal transport problems with an iterative procedure over the infrastructure
investments. Specifically, starting from a guess on the network investment Ijk , we solve for the
optimum over cj , hj , Djn , Lnj , Vjn and Qnjk , and then use the optimal network investment condition
(9) to obtain a new guess over Ijk , and then repeat until convergence. We then refine the solution
using a simulated annealing method that perturbs the local optimum and gradually reaches better
solutions. Appendix D provides details.

3.7   Alternative Assumptions
Congestion Across Goods We have assumed that congestion only applies within good types.
A natural assumption is that congestion takes place across goods. A simple way to incorporate
                                                                                                n is
this feature while preserving the convexity of the problem is to assume that the per-unit cost τjk
denominated in units of the bundle of traded goods aggregated through Dj (·) rather that in units
of the good itself. We assume that transporting each unit of good n from j to k ∈ N (n) requires

                                         n
                                        τjk = mn τjk (Qjk , Ijk )                                        (16)

units of the traded goods bundle, where mn measures product-specific characteristics such as weight
                       P
or volume, and Qjk = N         n n
                          n=1 m Qjk is the total weight or volume transported from j to k. Then,
the number of units of the traded goods bundle Dj used to transport goods from j to its neighbors
is
                                            X
                                    Tj =             τjk (Qjk , Ijk ) Qjk .
                                           k∈N (j)

After properly adjusting the resource constraints in the definition of the planner’s problem, the
convexity of the full planner’s problem is preserved under the same conditions stated in Proposition
1.
    Appendices A.1 and A.2 present the definition and first-order conditions of the planner problem
in a general case encompassing iceberg costs with own-good congestion, as well as this alternative
formulation with congestion across goods. As it is perhaps more realistic, we adopt the case with
congestion across goods as the benchmark in our application.

Externalities and Inefficiencies in the Market Allocation                     In Section 3.4, we assumed that
the decentralized allocation is efficient. However, in some cases it may be desirable to consider an
inefficient market allocation. For example, a standard formulation
                                                                     with agglomeration
                                                                                          spillovers
is to assume that the production technology is Yjn = Fjn Lnj , Vjn , Xnj ; Lj , where the spillover
from the total number of workers Lj on output Yjn is not internalized in the market allocation.
Another common formulation is to assume externalities in the consumption of amenities entering
through utility, U (cj , hj ; Lj ). Similarly, without the Pigouvian taxes tnjk correcting the congestion
externality in shipping, the market allocation is inefficient. In these cases, it is in principle still


                                                       20
possible to calibrate the model and undertake counterfactuals using a “fictitious” planner who
ignores the dependence of Yjn on Lj or of τjk
                                           n on Qn . For example, in the case of production
                                                 jk
spillovers, the fictitious planner problem is defined exactly as in Definition
                                                                             2 under the assumption
                                                                                           
                                                        
that the vector of aggregate population levels L = Lj in Yjn = Fjn Lnj , Vjn , Xnj ; Lj is taken
as given.19 As long as Fjn (·) is neoclassical given Lj , the statement in part (i) of Proposition
1, establishing convexity of the planner problem given the network, remains the same given Lj .
However, this approach requires solving an additional loop imposing that the vector of population
L = {Lj } that solves the fictitious planner problem coincides with the aggregate distribution L
taken as given by the planner. Every distribution of population L satisfying this fixed point problem
corresponds to a market allocation and vice-versa.20 An important caveat, however, is that we can
no longer establish the general convexity of the problem corresponding to part (ii) of Proposition
1. Section F of the Supplementary Material explains how to implement these cases along with a
method to derive the optimal infrastructure gradient and conduct local optimization.


4        Illustrative Examples
     In this section we implement examples that illustrate the basic economic forces captured by the
framework and its potential uses. All the figures can be found in Section C of the Supplementary
Material. We start with an endowment economy without labor mobility and only one traded and
one non-traded good in a symmetric graph. Then, we progressively move to more complex cases
with multiple locations in asymmetric spaces, multiple sectors, labor mobility, and heterogeneous
building costs due to geographic features. Throughout the examples, we illustrate the contrast
between the globally optimal networks in convex cases, where the congestion forces dominate the
returns to network building, and the approximate optimal networks in cases where global convexity
of the planner’s problem fails. In all the examples, preferences are CRRA over a Cobb-Douglas
                                                     1−ρ
bundle of traded and non-traded goods, U = cα h1−α        / (1 − ρ) with α = 12 and ρ = 2. There is
a single factor of production, labor, and all technologies are linear. We adopt the constant-elasticity
functional forms (10) for the transport and network-building technologies.

4.1      One Good on a Regular Geometry
Comparative Statics over K in a Symmetric Network                                To start we impose β = γ = 1,
which lies at the boundary of the parameter space guaranteeing global convexity. We assume a

    19
                                                                                             
     The fictitious planner problem is defined exactly as in Definition 2 with U cj , hj ; Lj in the case of consumption
                                                         
externalities, taking Lj as given, or with τjk Qnjk , Ijk   in the case of congestion externalities, taking the shipments
     n     o
Q̄ = Qn jk        as given.
            j,k,n
    20
      Whether such a fixed point exists depends on the specifics of the environment. It is beyond the scope of
this paper to determine the conditions under which that is the case, but we note that, given the network {Ikl },
our environment can accommodate the specific parametric assumptions that guarantee existence or uniqueness of an
inefficient decentralized allocation found in the previous literature. E.g., see Allen and Arkolakis (2014) for conditions
that lead to existence and uniqueness in an Armington model with labor mobility and size spillovers.


                                                           21
                                                             τ = δ I = Distance .
single good, no labor mobility and no geographic frictions, δjk   jk           jk
   Figure A.3 presents a network with 9 × 9 locations uniformly distributed in a square, each
connected to 8 neighbors. All fundamentals except for productivity are symmetric: (Lj , Hj ) =
(1, 1). Labor productivity is zj = 1 at the center and 10 times smaller elsewhere.
   Figure A.4 shows the globally optimal network when K = 1 (panel (a)) and when K = 100
(panel (b)). The upper-left figure in each panel displays the optimal infrastructure network Ijk
corresponding to (13). The optimal network investments radiate from the center, and so do ship-
ments. The bottom figures in each panel display the multipliers of the flows constraint (6)—the
prices in the market allocation—and consumption. Because tradable goods are scarcer in the out-
skirts, marginal utility is higher and so are prices. As the aggregate investment grows from K = 1
to K = 100, the network grows into the outskirts and the differences in the marginal utility shrink.
Panels (c) and (d) display the spatial distribution of prices and consumption. As the network
grows, relative prices and consumption converge, and spatial inequalities are reduced.

Randomly Located Cities and Non-Convex Cases We now explore more complex networks
and non-convex cases. Figure A.5 shows 20 “cities” randomly located in a space where each location
has six neighbors. Population is Lj = 1 in each city and 0 otherwise. Productivity is again ten
times larger at the center. The top panel shows the infrastructure and commodity flows in the
optimal network. The optimal network radiates from the center to reach all destinations. Due to
congestion, some destinations are reached through multiple routes. However, to reach some faraway
locations such as the one in the northwest, only one route is built.
   The middle panel inspects the same spatial configuration but assumes γ = 2. Now, the sufficient
condition for global convexity from Proposition 1 fails. We see a qualitative change in the shape
of the network. Due to increasing returns to network building, fewer roads are built but each has
higher capacity. In particular, there is now only one route linking any two destinations, consistent
with the no-loops result in Proposition 3.
    Because in the non-convex network we can only guarantee convergence to a local optimum, we
refine the solution by applying the numerical approach discussed in Supplementary Material Section
D involving simulated annealing. The bottom panel compares the non-convex network before and
after the annealing refinement. The refined network economizes on the number of links, leading to
a welfare increase but preserving the no-loops property.

4.2   Many Sectors, Labor Mobility, and Non-Convexity
   We now further introduce multiple traded goods and labor mobility. We allow for 11 traded
commodities, one “agricultural” good (good 1) that may be produced everywhere outside of “cities”
(zj1 = 1 in all “countryside” locations) and ten “industrial” goods, each produced in one random
city only (zjn = 1 in only one city j and zjn = 0 otherwise). These goods are combined via a constant
elasticity of substitution aggregator with elasticity of substitution σ = 2. Labor continues to be
the sole factor of production, but is now mobile. The supply of the non-traded good is uniform,


                                                 22
Hj = 1 for all j.
   Figure A.6 shows the convex case (β = γ = 1). The first panel shows the optimal network. In
the figure, each circle’s size denotes the population share. The remaining figures show the shipments
of each good, with the circle sizes representing the shares in total production for the corresponding
good. Figure A.7 shows the optimal network with annealing in the nonconvex case when γ = 2.
   In these examples, we observe complex shipping patterns. There are bilateral flows over each
link, now involving several commodities. Overall, the optimal network in the first panel reflects the
spatial distribution of comparative advantages. Since industrial goods are relatively scarce, wages
and population are higher in the cities that produce them. Due to the need to ship industrial
goods to the entire economy and to bring agricultural goods to the more populated cities, the
transport network has better infrastructure around the producers of industrial products. As Panel
(a) of each figure illustrates, the optimal network links the industrial cities through wider routes
branching out into the countryside. The agricultural good, being produced in many locations,
travels short distances and each industrial city is surrounded by its agricultural hinterland.
   The comparison between Figures A.6 and A.7 confirms the intuition that, in the presence of
economies of scale in transportation, the optimal network becomes more skewed towards fewer
but wider “highways”. Note, however, that the tree property from Proposition 3 no longer holds
because there are multiple goods.

4.3   Geographical Features
    We now show how the framework can accommodate geographical features like mountains and
rivers. To highlight the role of these frictions we revert to a case with a single good and no factor
mobility. Panel (a) of Figure A.8 shows 20 cities randomly allocated in a space where each location
is connected to 8 other locations. Population equals 1 in all cities and productivity is the same
everywhere (equal to 0.1) except in the central city, displayed in red, where it is 10 times larger.
Each city’s size in the figure varies in proportion to consumption.
   As implied by condition (13), the optimal infrastructure in a given link depends on the link-
                        I . In panel (a) we show the optimal network under the assumption that the
specific building cost δjk
cost of building infrastructure is proportional to the Euclidean distance:

                                              I
                                             δjk = δ0 Distanceδjk1 .                             (17)

As in our first set of examples, the optimal network radiates from the highest-productivity city to
alleviate differences in marginal utility.
   In panel (b), we add a “mountain” by adding an elevation dimension to each link and re-
configuring the building cost as
                                                                     δ2
                              I
                             δjk = δ0 Distanceδjk1 1 + |∆Elevation|jk     .                      (18)

Because it is more costly to build through the mountain, the optimal network circles around it to

                                                       23
reach the cities in the northeast. Because more resources are invested in that region, the network
shrinks elsewhere.
    In the subsequent figures, we either increase or decrease the cost of building the network in
specific links. Specifically, we allow for the more general specification:
                                                         δ2 CrossingRiver AlongRiver
                  I
                 δjk = δ0 Distanceδjk1 1 + |∆Elevation|jk    δ3            jk
                                                                              δ4       jk
                                                                                          .                  (19)

In panel (c) we include a river and assume that δ3 = δ4 = ∞, so that investing in infrastructure
either across or along the river is prohibitively costly. The optimal network linking cities across
the river can only be built through the one patch of dry land. In that natural crossing there is a
“bottleneck”, and a large amount of infrastructure is optimally built.
    In panel (d) we assume instead that no dry patch exists and that building bridges is feasible,
1 < δ3 < ∞. Now, the planner builds two bridges, directly connecting the pairs of cities across the
river. Panel (e) further allows for water transport by allowing to building transport capacity along
the river (δ4 < ∞). The planner retains the bridges, but now faraway locations in the southeast
are reached by water instead of ground transport.
    Finally, panel (f) moves to the non-convex case, γ = 2 > β, implemented through the combi-
nation of first-order conditions and simulated annealing approach described in Section 3.6. Now, a
unique route links any two cities, water transport is not used, and a single bridge is built.


5     Road Network Expansion and Misallocation in Europe
    We apply the framework for quantitative analysis of road networks in European countries. We
start by describing the steps to represent data on economic activity and road networks in terms of
the graph of our model. Then we choose the fundamentals to match the observed distribution of
economic activity within each country. We conclude by implementing counterfactuals involving the
optimal transport network. We implement the calibrations and counterfactuals country by country.
In a final exercise, we also implement the analysis simultaneously for a connected set of countries
in continental Europe.

5.1    Data
Sources     We combine geocoded data on road networks, population, and income across Euro-
pean countries. The road network data is from EuroGlobalMap (EGM) by EuroGeographics.21
The dataset combines shapefiles on the road network from each European country’s mapping and
cadastral agencies, and it includes all major highways and roads connecting populated areas.22 For

    21
       This product includes Intellectual Property from European National Mapping and Cadastral Authorities and is
licensed on behalf of these by EuroGeographics. Original product is available for free at www.eurogeographics.org.
Terms of the license available at https://eurogeographics.org/services/open-data/topographic-data/
    22
       We use GlobalMap data v8, corresponding to the year 2016, which is the earliest year we have access to. We
only use road segments that are reported as “operational”.


                                                       24
example, the French road network is represented by 38668 segments of active roads connecting
159258 geographic points with a total length of about 130000 km.
    We perform the calibration and counterfactual analysis separately for each of the 24 countries
included in EGM for which data on number of lanes is available. This set includes rich and poor
countries, as well as geographically large and small. Table A.1 in Appendix B reports the list of
countries with summary statistics about the size and average features of their road networks, the
number of cells, and features of their discretized road networks.
    An appealing feature of this dataset is that each segment of a road network has information
about objective measures of road quality including type of road use (national, primary, secondary,
or local), number of lanes, and whether it is paved or includes a median. National roads encompass
each country’s highway system.23 On average across the countries in our data, national roads
represent 10% of the road network, feature twice as many lanes per kilometer as other types
of roads, are always paved (while 94% of the non-national networks are), and are more likely to
include a median (87% relative to 4% of non-national networks). Since the roads labeled as primary,
secondary and tertiary have very similar characteristics along these dimensions, we bundle them
into a single “non-national roads” category.
    We use population data from NASA-SEDAC’s Gridded Population of the World (GPW) v.4,
and value added from Yale’s G-Econ 4.0. Both datasets correspond to the year 2005. The GPW
population data is reported for 30 arc-second cells (approximately 1 kilometer), and the G-Econ
value-added data is reported for 1 arc-degree cells (approximately 100 km). To implement the
model we must take a stand on the geographic units corresponding to each node. To strike a balance
between the high spatial resolution of the EGM and GPW datasets and the coarser resolution of
the G-Econ dataset, in most countries we use 0.5 arc-degree cells (approximately 50 km by 50 km)
as benchmark. We adopt squares as geographic units so that the boundaries of the units in the G-
Econ dataset coincide with ours. We allocate population to each 0.5-degree cell by aggregating the
smaller cells in GPW, and apportion income from the G-Econ cells according to the GPW-based
population measure. In a few countries we use smaller or larger cells in order to allow for either a
significant number of cells or avoid having a very large number.24 We denote the population and
value added observed in each cell j of each country by Lobs
                                                        j   and GDPjobs .
    The resulting number of cells in each country is reported in Table A.1. In the 19 countries where
the NUTS subdivision of geographic units exists, the number of cells is larger than the number of
level-2 NUTS regions. In most countries it is also larger the number of level-3 NUTS.25

  23
      E.g., roads labeled as national in the data include the Autobahn highway system in Germany, autovias and
autopistas in Spain, and the autoroute system in France.
   24
      We use the default 0.5 arc-degree cells in 17 countries (Austria, Belgium, Czech Republic, Denmark, Georgia,
Hungary, Ireland, Latvia, Lithuania, Macedonia, Moldova, Netherlands, Northern Ireland, Portugal, Slovakia, Slove-
nia and Switzerland). Whenever assuming 0.5 arc-degree cells would lead to more than 200 cells, we use 1 arc-degree
cells (Finland, France, Germany, Italy and Spain); and whenever doing so would lead to less than 20 cells, we use
0.25 arc-degree cells (Luxembourg and Cyprus).
   25
      The NUTS (Nomenclature of Territorial Units for Statistics) is a standard developed by the European Union to
divide the territory. The NUTS 2 correspond to “basic regions for the application of regional policies”, and NUTS 3
correspond to “small regions for specific diagnoses” (https://ec.europa.eu/eurostat/web/nuts/background ). Excluding


                                                        25
Underlying Graph            Using these data we construct empirical counterparts to the underlying
geography (J , E) corresponding to the locations and links in the graph of our model, as well as an
                                    obs for each link.
observed measure of infrastructure Ijk
    To define the set of nodes J in each country, we use the GPW data to locate the population
centroid of each cell. The population centroids are usually very close to a node on the road network.
We relocate each population centroid to the closest point on a national road crossing through the
cell, or on other types of roads if no national roads cross through the cell.26 We define the observed
population and income of each node j ∈ J to be equal to the total income GDPjobs and the
population Lobs
            j   of the cell that contains it.
    In turn, we define the set of edges E as all the links between nodes in contiguous cells. This
step defines a set of up to 8 neighbors N (j) for each node j ∈ J : the 4 nodes in horizontal or
vertical neighbors and the 4 nodes along the diagonals.

Discretized Road Network To construct a measure of infrastructure corresponding to Ijk in
our model, we first aggregate the observed attributes of the road network over the actual roads
linking each j ∈ J and k ∈ N (j). We use information on whether each segment s on the actual
road network belongs to a national road and its number of lanes. We define the average number of
lanes and average road type for the link between j and k as follows:
                                                     X
                                        lanesjk =          ωjk (s) lanes (s) ,
                                                     s∈S
                                                     X
                                           natjk =         ωjk (s) nat (s) ,
                                                     s∈S


where lanes (s) is the number of lanes on each segment s on the actual road network S, nat (s)
indicates whether segment s belongs to a national road, and ωjk (s) is the weight attached to the
infrastructure of each segment when computing the level of infrastructure from j to k. The weights
ωjk (s) should be larger on segments of the road network that are more likely to be used when
shipping from j to k, and equal to zero for all s ∈ S if no direct route exists linking j and k. We
define ωjk (s) based on the fraction of the cheapest path P (j, k) from j to k corresponding to that
segment:                                     
                                             P       length(s)
                                                           length(s′ )   s ∈ P (j, k)
                                                  s′ ∈P(j,k)
                                 ωjk (s) =
                                             0                          s∈
                                                                          / P (j, k)

where length (s) is the length of segment s and P (j, k) is the cheapest path from j to k on the
actual road network.27 We follow these steps as long as the cheapest path does not stray from the

overseas territories Spain has 15 level-2 NUTS (autonomous communities) and 47 level-3 NUTS (provinces), whereas
our partition has 61 cells. In France there are 21 level-2 NUTS (regions) and 94 level-3 NUTS (departments), whereas
our partition has 74 cells.
   26
      On average across countries, the relocation across all cells within a country is 5.3 km.
   27
      This step does not use the model. In this step, for each pair of nodes j ∈ J and k ∈ N (j) we ask: what are
the average characteristics (number of lanes and type of road) of the existing route connecting these two locations in


                                                           26
cells containing j and k.28 When that happens, we assume that no direct path from j to k exists
in the actual road network, P (j, k) = , in which case ωjk (s) = 0 for all segments s ∈ S.
                                                      obs for each j ∈ J and k ∈ N (j) by letting
    We define the observed measure of infrastructure Ijk
 obs = lanes                            obs
Ijk          jk for national roads and Ijk = lanesjk × κ for non-national roads, where κ < 1
captures the smaller cost of non-national roads. We set κ = 1/5, which corresponds to the cost of
road construction and maintenance per kilometer on trunk roads relative to federal motorways in
                                                               obs = I obs , implying that infras-
Germany in 2007, as reported by Doll et al. (2008). We impose Ijk     kj
                                                                                                obs
tructure applies equally in either direction. In sum, we construct the observed infrastructure Ijk
as the average number of national road lanes over the path from j to k on the actual road network,
if a direct path exists. Across connected nodes the discretized network, there is a correlation of
              obs and the speed on the quickest path according to GoogleMaps.
0.67 between Ijk

Examples: France and Spain               Figures 2 and 3 represent each of the steps described above for
two large countries in our data, France and Spain. Panel (a) of each panel shows the discretized
map and associated population. Brighter cells are more populated, corresponding to higher deciles
of the population distribution across cells. The (b) panels display the cells, the centroids (light blue
circles) and the edges (red segments) of the underlying graph. The (c) panels show the centroids and
the full road network. Green segments correspond to national roads and red segments correspond
to other roads, and the width of each road is proportional to its number of lanes.
    Finally, the (d) panels show the infrastructure in the discretized road network. Each of the
edges from the (b) panels is now assigned a width depending on the average number of lanes,
lanesjk , and a color ranging from red to green depending on the likelihood of using a national road,
natjk . The width and color scale are the same as in panel (c). When no direct link from j to k is
identified by our procedure, no edge is shown. The resulting discretized networks on the baseline
grids clearly mirror the actual road networks for both countries, but they are now expressed in
terms of the nodes and edges of our model and therefore allow us to quantify it.

5.2    Parametrization
    We discuss the specific parametric assumptions to implement the general model described in
Section 3.

Preferences and Technologies              The individual utility over traded and non-traded goods defined
in (1) is assumed to be Cobb-Douglas,


                                                  U = cα h1−α ,
the real world? To do this, we must choose some route connecting the pair of locations in the real world. We use the
cheapest-route criterion as a way to choose this route. The cheapest path is constructed by weighting each segment
s by its road user cost based on data from Combes and Lafourcade (2005) and other sources. See Appendix B for
details.
   28
      We classify a path from j to k as straying from the cells containing j and k if more than 50% of the path steps
over cells that do not contain j or k.


                                                         27
                           Figure 2: Discretization of the French Road Network

                         (a) Population                                          (b) Nodes and Edges




                   (c) Actual Road Network                                 (d) Discretized Road Network




Notes: Panel (a) shows total population from GPW aggregated into 0.5 arc-degree (approximately 50 km) cells.
Panel (b) shows the nodes J corresponding to the population centroids of each cell in Panel (a), reallocated to their
closest point on the actual road network, and the edges E corresponding to all the vertical and diagonal links between
cells. Panel (c) shows the centroids and the actual road network. Green segments correspond to national roads, red
segments are all other roads, and the width of each segment is proportional to the number of lanes. Panel (d) shows
the same centroids and the edges as the baseline graph in Panel (b), where each edge is weighted proportionally to
the average number lanes on the cheapest path between each pair of nodes on the road network. The color shade
ranges from red to green according to the fraction of the shortest path traveled on a national road.


while the aggregator of traded goods (2) is CES:
                                                                            σ
                                                                         ! σ−1
                                                    N
                                                    X
                                                               n
                                                                  σ−1
                                           Cj =           Cj       σ                                             (20)
                                                    n=1

where σ > 0 is the elasticity of substitution. Labor is the only factor of production and the
production technologies (3) are assumed to be linear:


                                                   Yjn = zjn Lnj .

We assume α = 0.4 to match a standard share of non-traded goods in consumption and σ = 5
which corresponds to a central value of the demand elasticities reported by Head and Mayer (2014)


                                                          28
                          Figure 3: Discretization of the Spanish Road Network

                        (a) Population                                    (b) Nodes and Edges




                   (c) Actual Road Network                           (d) Discretized Road Network




Notes: Panel (a) shows total population from GPW aggregated into 0.5 arc-degree (approximately 50 km) cells.
Panel (b) shows the nodes J corresponding to the population centroids of each cell in Panel (a), reallocated to their
closest point on the actual road network, and the edges corresponding to all the vertical and diagonal links between
cells. Panel (c) shows the centroids and the actual road network. Green segments correspond to national roads, red
segments are all other roads, and the width of each segment is proportional to the number of lanes. Panel (d) shows
the same centroids and the edges as the baseline graph in Panel (b), where each edge is weighted proportionally to
the average number lanes on the cheapest path between each pair of nodes on the road network. The color shade
ranges from red to green according to the fraction of the shortest path traveled on a national road.


across estimates from the international trade literature. As we discuss below, the calibrated model
gives a reasonable prediction for the distance elasticity of trade, which is closely linked to σ.

Labor Mobility         We undertake the entire analysis for the case in which labor is fixed and for the
case in which it is perfectly mobile.

Transport Technology            We adopt the log-linear transport technology (10) with cross-good con-
gestion as described in Section 3.7. We must parametrize the congestion parameter β and the
returns to infrastructure parameter γ. Ideally, we would like to set these parameters to elasticities
of total trade costs with respect to trade flows and infrastructure. Since such elasticities are not
readily available, we narrow the focus to the impact of shipping time on trade costs. Several studies




                                                         29
point to a relevant value of time in international shipping.29 Since the majority of inland shipments
in the EU are done via road, they likely include goods that are time-sensitive.30
    We assume that: i) trade costs are a linear function of shipping time; ii) shipping speed is a log-
linear function of the number of vehicles and road lane kilometers; and iii) the number of vehicles is
a linear function of the quantity shipped. As shown in Appendix B, under these assumptions we can
calibrate β and γ to match the empirical relationship between speed, roads, and vehicles estimated
by Couture et al. (2018) in U.S. data. Their estimates imply β = 0.13 and γ =0.10, suggesting
decreasing returns to scale.31 We use these parameters as benchmark, and also implement the
analysis in a case with increasing returns. Specifically, we consider a higher value of γ such that
the ratio between γ and β is the mirroring case, γ/β = 0.13/0.10 for β = 0.13.

Productivities, Endowments, and Geographic Frictions We must impose values for the
productivities zjn and the endowment of non-traded services Hj . In the case with perfect labor
                                   
mobility we interpret Lobs
                         j , GDPj
                                 obs as outcomes of the planner’s solution for the optimal alloca-

                                                                                      obs as given,
tion and optimal flows problems discussed in Section 3.2 taking the observed network Ijk
                                                               
and use this information to back out the fundamentals zjn , Hj . In the case with fixed labor, we
interpret GDPjobs as the outcome of the planner solution and use this information to back out the
productivities zjn , normalizing non-tradeable consumption per capita Hj /Lobs
                                                                           j   to 1 and setting the
planner’s weights ωj = 1 everywhere.
    Since our data only includes aggregate measures of economic activity for each cell, we assume
that each location produces only one tradable good. We allow for N + 1 different sectors: N
differentiated goods, and one homogeneous good. As a benchmark, we assume that each of the
differentiated goods is produced in each of the N cells with the largest observed population, and
that the homogeneous good is produced by all the remaining cells. We assume 10 different sectors
and explore the robustness to alternative values of N . We also implement an alternative calibration
where the differentiated products are allocated to the N largest level-2 NUTS regions within each
country.
    This approach leaves us with J productivity parameters zj , each corresponding to the produc-
tivity of a different location. We choose each location’s productivity (and supply of non-traded
                                                                                 obs as given, the
goods, when allowing for labor mobility) such that, taking the observed network Ijk
   29
      Anderson and Van Wincoop (2004) calculate 9-percent tax equivalent of the average ocean shipping time cost
in the US over the second half of the 20th century. Hummels and Schaur (2013) quantify that one additional day in
transit is equivalent to 0.6 to 2.1 percent tariff and Djankov et al. (2010) argue that each additional day of delay is
equivalent to a country distancing 70km from its trade partner. Firth (2017) shows that the time delays caused by
congestion of railroads impact firm-level outcomes in India, and Brancaccio et al. (2017) argues, using a structurally
estimated search model of ships and exporters, that congestion in ports leads to costly delays for exporters.
   30
      75% of the tonne-kilometer shipped via inland transport modes (rail, waterways or road) within the EU-28 are
done by road. The share is 50% when considering all transport modes. See https://ec.europa.eu/eurostat/statistics-
explained/index.php/Freight transport statistics - modal split%20.
   31
      Couture et al. (2018) find decreasing returns to scale across all their specification (Tables 5 and 6 of their paper)
using a variety of OLS and IV approaches, although the difference is typically small. They refer to this result as
suggesting “modest decreasing returns to scale”. Their preferred estimate, used for our calibration, is column 6 of
table 5 of their paper.


                                                            30
planner’s solution to the optimal allocation and optimal flows problems from Definition 2 reproduces
the observed value added (and population, when allowing for labor mobility).32
                                                                             τ entering in the
    We must also determine the values of the the geographic trade frictions δjk
transport technology (10). We assume that all goods have the same weight (mn = 1) and that
                               τ = δ τ dist . To calibrate δ τ , we target the level of intra-regional
frictions depend on distance, δjk   0      jk               0
trade in Spain, where regional-level trade data is available. We estimate δ0τ jointly with the other
fundamentals so that the model matches the 44% share of intra-regional trade in intra-national
trade among tradeable sectors across the 15 continental level-2 NUTS regions of Spain from 2001-
2005, according to from Spain’s C-Intereg Dataset (Llano et al., 2010). To generate model-based
regional trade flows, we aggregate the bilateral node-to-node trade flows in differentiated goods to
the bilateral region-to-region level.33 We then use this value of δ0τ in the remaining countries when
calibrating fundamentals.
    Figure A.1 in Appendix B shows the results of the calibration for the convex case of the param-
eters (β = 0.13, γ = 0.10). Similar relationships hold for the non-convex case (β = 0.13, γ = 0.169).
Panels (a) and (b) show the model-implied population and income shares of each location against
the data, over all locations in the 24 countries. Except for a few locations, both population and
income shares are matched with high precision. The internal trade share for Spain is also precisely
matched.34
    Panels (c) and (d) show the calibrated fundamentals (productivity and endowment of non-
traded good) in the vertical axes against income and population shares in the data, respectively,
for the case with labor mobility. Both fundamentals are strongly correlated with observables. A
similar positive relationship between productivity and income shares holds in the calibration of the
model with fixed labor.

Cost of Building Infrastructure               To implement the optimal transport network in counterfac-
                                                                                 I . We follow two
tual scenarios, we must parametrize the cost of infrastructure along each edge, δjk
                                                                             obs as the outcome of
approaches. In the first approach, we interpret the observed infrastructure Ijk
the planner’s problem, under the assumption that it is equally costly to build in either direction.
                                    obs , is consistent with the planner’s first-order condition for
In this case the observed network, Ijk
   32
       To compute GDP, we invoke the second welfare theorem from Proposition 4 to recover the prices in the calibrated
allocation as the multipliers of the various constraints in the planner’s problem. In the solution of the planner’s
                                                                                  n(j)
problem each location’s value added in tradeable and non-tradeable sectors is Pj zj Lj + PjH Hj , where n (j) denotes
                                      n
the good produced by location j, Pj is the price of good n in location j (i.e., multiplier of the flows constraint for
good n in j in the planner’s problem), and PjH is the price of non-traded services in sector j (i.e., the multiplier of
the availability of non-traded goods constraint in the planner’s problem). Value added in the transport sector is not
attached to specific nodes and often corresponds to links connecting near empty locations. For accounting purposes,
we allocate the national value added in the transport sector proportionally to value added in other sectors, so that
regional variation in measured GDP is driven by goods and services.
    33
       The model does not make a prediction for bilateral region level flows of homogeneous goods. Since this good
is produced in every region, most of its production is not traded across region boundaries. In the calibration, the
intra-regional trade share of this sector is 93%.
    34
       Across the 24 countries the average internal trade share is 35%, with a standard deviation of 12%. We calibrate
δ0 = 2.05 × 10−3 and δ0τ = 2.00 × 10−3 in the benchmark convex case with fixed and mobile labor, respectively. In
  τ

the non-convex case we find δ0τ = 2.07 × 10−3 and δ0τ = 2.15 × 10−3 .


                                                          31
Ijk in (13) under the assumption that I jk = 0. Imposing symmetry on that first-order condition
we then recover the cost of infrastructure as function of outcomes from the calibrated model (see
                                                                                       I,F OC
Appendix A.2). We refer to this measure as the “FOC-based” measure of building costs, δjk     .
    Our second approach is agnostic about whether the observed network results from any sort
of optimization, but takes a stand about how the building costs depend on geographic features.
Specifically, we rely on data from Collier et al. (2016), who estimate highway building costs from
World Bank infrastructure investment projects across the world, and then relate these costs to
a host of geographic and non-geographic frictions.35 We assume that δjk
                                                                     I is a function of two

geographic features included in their study, distance and ruggedness of the terrain and refer to this
                                                    I,GEO
building-cost measure as the “geographic” measure, δjk    . We interpret an improvement to the
connection between any pair of nodes in our counterfactuals as an infrastructure project. In our
notation, their estimates imply:

                     I,GEO   !
                    δjk                  
               ln                = ln δ0I − 0.11 × (distjk > 50km) + 0.12 × ln (ruggedjk ) ,                (21)
                    distjk

where distjk is the distance between j and k and ruggedjk is the average over the ruggedness in
locations j and k, constructed as detailed in Appendix (B). Hence, it is more costly to build on
rugged terrain, but less costly per kilometer to build on longer links. We assume that the elasticity
of building costs with respect to features of the terrain is the same across all countries.
                                                      I up to scale in each country. We set K = 1
    These steps give two alternative measurements of δjk
everywhere and choose δ0I to satisfy the network-building constraint with equality in each country.

5.3    Model-Implied Trade Flows and Congestion
    We check the model predictions for bilateral trade flows. We use bilateral trade data across
Spanish regions defined at the level-2 NUTS subdivision from Spain’s C-Intereg Dataset. Excluding
islands, this gives 15 Spanish regions. Panel (a) of Figure 4 shows observed and and model-based
trade flows in differentiated products for the calibration where each differentiated good is allocated
to a different region. Own-region trade flows are shown as red crosses. The model implied bilateral
flows have a correlation of 0.77 with the data.
    Another way to assess the implied trade flows is to look at the gravity implications. The
standard gravity model posits a log-linear relationship between bilateral trade shares and trade
costs. The gravity model typically gives a good fit of the international data (Head and Mayer,
2014), and is often applied within countries (Allen and Arkolakis, 2014). A common approach is
to parametrize bilateral trade costs as a function of geographic frictions. In our parametrization,
bilateral trade costs among locations depend on the distance through the network, but also on the

  35
     The investment projects in their data are concentrated in low- and middle-income countries, of which three
(Lithuania, Georgia, and Macedonia) are in our data. The coefficients from their study introduced in our equation
(21) correspond to the average of the coefficients over the distance dummy and the ruggedness index across the 6
specifications in Tables 4 and 5 of their paper.


                                                       32
                                                                          Figure 4: Actual and Predicted Trade

                                    (a) Bilateral Trade Flows, Model and Data                                                              (b) Trade flows Versus Distance




                                                                                                                        4
                   -2
   Log of Bilateral Trade (Model)
                            -4




                                                                                                              Log of Import Share
                                                                                                                              2
                   -6




                                                                                                               0
       -8          -10




                                                                                                                        -2
                                    -10            -8                    -6             -4               -2                         -1.5     -1       -.5             0            .5   1
                                                        Log of Bilateral Trade (Data)                                                                Log of Distance (KM)

                                     Between-NUTS Flow         Within-NUTS Flow              45 degree                                                  Model               Data



Note: the left panel shows the model-based flows across level-2 NUTS regions of continental Spain against the data
in the calibration assigning a differentiated product to the largest city within each level-2 NUTS region. Correlation
is 0.77. The right panel shows the log of the model-implied and observed import shares against distance as residuals
from exporter fixed effects. Linear regression slope (robust SE) is: -0.905 (0.067) in model and -1.368 (0.058) in data.
Trade flows to the same region appear as red crosses in the first panel.


equilibrium levels of congestion, the observed levels of infrastructure, and the calibrated values of
β and γ. We can compare the relationship between trade flows and distance implied by the model
using the previous aggregation to the level-2 NUTS subdivision in Spain. Panel (b) of Figure 4
shows the bilateral import share among level-2 NUTS and the log of distance in the model and in
the data, after controlling for exporter fixed effects.36 A linear regression yields elasticities of −0.91
in the model and −1.37 in the data. Overall, the figures suggest that the model makes reasonable
predictions for the distribution of trade flows.37
               We examine the level of the congestion taxes needed to implement the allocation. Due to
the log-linear specification of the transport technology, Proposition 4 implies that the taxes are a
fraction β = 13% of the transport costs in every link. Given the total value of transport costs,
we obtain numerically that the mean ad valorem tax across all locations is about 0.5% in the case
with labor mobility (0.6% without) and that the total taxes paid represent 0.3% of GDP in both
cases.38
   36
                                                                                       
      We run, in both model-generated and observed data, the regression ln λNU   jk
                                                                                    TS
                                                                                         = δ ln (distjk ) + ψj + εjk , where
λjk is the import share and distjk is the bilateral distance between the level-2 NUTS divisions. The figure shows
both the import share and distance as residuals from exporter fixed effects. Distance is computed between geographic
centroids. We exclude zero flows and flows to the own region.
   37
      The results are similar in calibrations that assign differentiated products to the largest locations in the country,
with a correlations around 0.8 between model-based non-zero bilateral trade flows and the data. They are also similar
in calibrations that assign one good to each region but assume away the homogeneous product. The relationship
between trade and distance is very similar for France, suggesting that the key gravity properties are dictated by the
common elasticities rather than by the distribution of fundamentals.
   38
      In simulations of the calibration for Spain where we randomly increase capacity in random links, we find an
elasticity of quantity flows Qjk to infrastructure Ijk of 0.53 in the benchmark calibration (γ < β), 0.93 in a calibration


                                                                                                         33
5.4    Optimal Expansion and Reallocation
    We simulate two types of counterfactuals. First, we compute the aggregate gains from an
optimal expansion of the observed road network within each country. We assume that the total
resources K are increased by 50% relative to the observed network, constraining the planner to
                                       obs . In the notation of restriction (iii) in definitions 1 and 2,
build on top of the existing network, Ijk
                        obs . Second, we compute the losses due to misallocation of current roads
this means that I jk = Ijk
within each country.We assume that the total resources K are the same as in the observed network,
                                                                           obs . In the notation
without constraining the planner to build on top of the existing network, Ijk
of restriction (iii) in Definitions 1 and 2, this means that I jk = 0. We set the upper bound on
infrastructure I jk to be 50% above the largest level of infrastructure observed in each country.
    In short, the first “optimal expansion” counterfactual amounts to optimally expanding the
network on top of what is already observed, while the second “optimal reallocation” counterfactual
amounts to optimally reallocating the existing roads. The first counterfactual is more policy-
relevant, as it prescribes where new roads should be built and yields the aggregate gains of those
investments. The second counterfactual is unfeasible in reality, but gives a sense of the losses from
misallocation of existing roads.
    We implement the optimal expansion under the two measures of building costs, the FOC-based
         I,F OC                             I,GEO
measure δjk     and the geographic measure δjk    . The optimal reallocation is only meaningful
                                                                                           I,F OC
under the geographic measure, since the observed network is optimal by construction under δjk     .
We implement each of these counterfactuals for each of the two values of γ, assuming both fixed
and mobile labor, separately for each of the 24 countries. We re-calibrate the model for each value
of γ, assumption on labor mobility, and country.


Regional Impact within Countries We inspect first the within-country regional implications
for two large countries in our data, Spain and France. Figure 5 depicts the pattern of investment
and population change under the geographic measure of building costs δI,GEO . Panels (a) and
(b) show the optimal expansion and panels (c) and (d) show the optimal reallocation under labor
mobility. Panels (e) and (f) reproduce the optimal reallocation assuming that labor is not mobile.
The thickness of each link increases with the absolute value of the investment, defined as the
                                                                        ∗ −I obs . In the reallocation
difference between the counterfactual and the observed infrastructure, Ijk  jk
                                                 ∗ − I obs < 0, are shown in red, while all other links
counterfactual, links with negative investment, Ijk   jk
are shown in green. In turn, with labor mobility, green nodes denote positive population change,
and red nodes denote negative population change. Brighter nodes represent a larger absolute value
of population change.
    In the optimal reallocation counterfactual, we observe positive investments radiating away from
some areas with higher economic activity in the case of France, but a more dispersed investment

that imposes γ = β and 1.38 in the non-convex calibration (γ > β). Duranton and Turner (2011) report IV estimates
of the relationship between total vehicles-kilometers traveled and road capacity across U.S. cities between 0.68 and
1.33 (in their Table 6), with many of these estimates close to 1.


                                                        34
             Figure 5: Optimal Network Reallocation and Expansion: Spain and France

        (a) Optimal Network Expansion with Labor              (b) Optimal Network Expansion with Labor
        Mobility, France                                      Mobility, Spain




        (c) Optimal Network Reallocation with Labor           (d) Optimal Network Reallocation with Labor
        Mobility, France                                      Mobility, Spain




        (e) Optimal Network Reallocation with Fixed           (f) Optimal Network Reallocation with Fixed
        Labor, France                                         Labor, Spain




Notes: All counterfactuals use the geographic measure of building costs, δ I,GEO and the benchmark parametrization
of β and γ. The width and brightness of each link is proportional to the difference between the optimal counterfactual
                                     ∗     obs
network and the observed network, Ijk   − Ijk  , for each link jk ∈E shown in panel (b) of Figures 2 and 3. The color
scale is the same as in Figure 2. Red links represent negative investment. With labor mobility, brighter green (red)
nodes represent larger population increase (decrease).


pattern in Spain. As we compare panels (a) and (b) with panels (c) and (d), we recognize similar
investment patterns in the optimal reallocation and expansion counterfactuals within each country:
the links identified as having too much infrastructure, shown in red in panels (c) and (d), typically


                                                         35
feature no expansion in panels (a) and (b). The comparison between panels (c)-(d) and panels (e)-
(f) reveals that allowing labor mobility does not fundamentally affect the optimal infrastructure
investments.
    Despite the different investment patterns, in the cases of optimal expansion and optimal real-
location population is reallocated to the same set of regions within each country. Due to the labor
mobility constraint in the planner’s problem, changes in labor are perfectly correlated with changes
in consumption of traded commodities per worker, cj .39 For the cases without labor mobility,
there is a similar consistency across the counterfactuals in the changes in consumption of traded
commodities per capita cj across locations.
    We inspect, across the 24 countries, how a few typically observable regional outcomes map to
infrastructure investment. Panel (a) of Table 1 reports results from regressions of infrastructure
growth on each location’s initial population and tradeable income per capita. We report here results
corresponding to the case with labor mobility and the benchmark parametrization of γ and β, but
the qualitative features we discuss are similar under the alternative value of γ, or assuming fixed
labor and using the change in consumption per capita instead of population as dependent variable.
Optimal road investments are directed to locations with initially lower levels of infrastructure,
reflecting decreasing returns to infrastructure at the link level.
    Under the geographic measure of building costs in columns (1) and (2), the investments are
also more intensely directed to locations with initially higher levels of population and income per
worker. However, this is not true under the FOC-based measure of building costs. In that case,
the observed allocation of roads is efficient and therefore the welfare impact of infrastructure is
equalized across links regardless of the fundamentals reflected in income and population. Since
the model implies a complex mapping from the fundamentals to the investments, these observable
outcomes guide only a fraction of the optimal investment decisions (R2 in the order of 20-30%).
    In Panel (b), the dependent variable is population growth. To understand the patterns of
optimal reallocation of population, in addition to the variables from the previous regression we also
include infrastructure growth, consumption per capita, and a dummy for whether a location is a
differentiated producer.40 The handful of variables in the regression explain between 25% and 50%
of the population changes. Infrastructure growth in a location has a positive impact on population
growth only in the misallocation counterfactual, but the effect is not significant and its explanatory
power on the distribution of population changes is very small. This lack of correlation reflects that,
when the optimal investment plan is implemented, growth in a location depends on investments in
other locations in potentially complex ways. If we randomly improve individual links, population
growth does appear correlated with infrastructure growth.41

  39
      The labor mobility constraint (vi) from Definition 2 implies α∆ ln cj = (1 − α) ∆ ln Lj + ∆ ln u, where ∆ ln x
denotes the difference in the log of variable x between the counterfactual and calibrated allocation.
   40
      When included in the regressions of Panel (a), consumption per capita and the index for being a differentiated
producer are not significant and have a very small effect on the R2 . Because consumption and income are highly
correlated, in that case income per capita is also not significant.
   41
      Using the benchmark calibration for Spain, we ran 100 counterfactuals where we improved infrastructure in
one randomly chosen link by a uniform draw between 0% and 10%. In 73% of cases, the nodes connected by the


                                                        36
      Table 1: Optimal Infrastructure Investment, Population Growth and Local Characteristics

                                    (a) Dependent Variable: Infrastructure Growth

 Counterfactual                   Reallocation (δ = δI,GEO )    Expansion (δ = δI,GEO )     Expansion (δ = δI,F OC )
                                               (1)                          (2)                         (3)
 Population                                0.358***                      0.136***                     0.003
 Tradeable Income per Capita               0.335***                      0.164***                     -0.003
 Infrastructure                            -0.439***                    -0.242***                   -0.082***


 R2                                           0.32                         0.27                        0.21


                                     (b) Dependent Variable: Population Growth

 Counterfactual                   Reallocation (δ = δI,GEO )     Expansion (δ = δI,GEO )     Expansion (δ = δI,F OC )
                                               (1)                          (2)                         (3)
 Population                                  0.000                       -0.001**                     -0.000
 Tradeable Income per Capita                0.026***                     0.020***                    0.004***
 Consumption per Capita                    -0.074***                    -0.062***                   -0.011***
 Infrastructure                             -0.001**                     -0.001**                     -0.000
 Infrastructure Growth                       0.001                         0.000                      -0.000
 Differentiated Producer                    0.008**                      0.001***                    0.001***


 R2                                           0.47                         0.50                        0.25
Each column corresponds to a different regression pooling all locations across the 24 countries in the benchmark
parametrization of γ and β, assuming mobile labor and N=10. All regressions include country fixed effects. Standard
errors are clustered at the country level. ***=1% significance, **=5%, *=10%. Dependent variables: population
growth is defined as ∆ ln Lj , where ∆x = x′ −x denotes the difference between variable x in the counterfactual (x’) and
                                                                                                                      
in the calibrated allocation (x). Investment growth is defined as the difference over the average, ∆Ij / 21 Ij + Ij′ ,
                                                             P
where total infrastructure at the node level defined as Ij = k∈N (j) Ijk . Independent variables correspond to the log
of the level of each variable in the calibrated model. Population and income per capita are the two outcomes matched
by the calibration. Consumption per capita corresponds to traded goods, cj in the calibrated model. Differentiated
producer is a dummy for whether the location is a producer of differentiated goods in the calibration.


      Consumption of traded goods per capita is a strong determinant, with a negative elasticity
of population growth with respect to initial consumption in the order of 1%-7%. If consumption
per capita was excluded, then the coefficient on income per capita would become negative and
significant, with a negative elasticity of growth with respect to income per capita of 1% across the
three counterfactuals. Hence, the impact of initial income on population growth in the optimal
investment plan operates through the level of consumption.
      This reallocation pattern reflects that the goal of the optimal investments is to reduce variation
in the marginal utility of consumption of traded commodities across locations. Since changes
in population and consumption per capita between the counterfactual and initial allocation are

improved link grew. A regression of population growth on infrastructure growth across these 100 observations gives
an elasticity of 0.2% with standard error of 0.04%.


                                                          37
                            Table 2: Average Welfare Gains Across Countries

                           Returns to Scale:           Benchmark          Non-Convex
                           Labor:                    Fixed    Mobile     Fixed    Mobile
                           Optimal Reallocation
                                  δ = δ I,GEO         1.6%     1.5%      2.4%      1.9%
                           Optimal Expansion
                                  δ = δ I,GEO         1.7%     1.6%      2.8%      2.2%
                                        I,F OC
                                  δ=δ                 0.3%     0.3%      0.9%      1.0%
Each element of the table shows the average welfare gain in the corresponding counterfactual across the 24 countries.


perfectly correlated, the optimal investment plan leads to an increase in consumption of traded
commodities in locations where consumption per capita is initially low. We conclude that the
optimal investment in infrastructure reduces spatial inequalities, although different assumptions
on building costs imply different ways of achieving this goal by changing the optimal placement of
infrastructure, as implied by our previous discussion.

Aggregate Impact Across Countries We now show the aggregate welfare effects. Table 2
shows the average welfare gain for each counterfactual across the 24 countries in our data. Tables
A.2 and A.3 in Appendix B show the results for each country with fixed and mobile labor, respec-
tively. In the benchmark parametrization of γ and β, using the geographic measure of building
costs we find average welfare gains across countries of around 1.5% − 1.7%. The effects are much
smaller under the FOC-based measure, because in that case the optimal expansion does not ad-
dress a suboptimal placement of existing roads. The average gains are increasing in the returns
to scale γ, with the average welfare gains increasing to between 1.9% and 2.8% under geographic
measure of building costs. These effects vary considerably across countries, ranging from around
0.5% to 5%. There is no clear relationship between misallocation and country size or income.
Some Eastern European countries such as Georgia, Lithuania, and Latvia appear with relatively
high misallocation in the benchmark case (2.2% to 2.7% relative to a mean of 1.6%), and so do
Denmark (4.4%), France (2.2%) and Spain (3.5%). Belgium, Luxembourg and Macedonia appear
as the least misallocated countries.
    This distribution of welfare gains across countries is in general stable regardless of the parametriza-
tion of γ, the assumption on labor mobility, the parametrization of the building costs δI , or the
type of counterfactual. For example, across the parametrizations of γ and labor mobility, the corre-
lation between the gains from optimally expanding the network under the two measures of building
costs, δI,GEO and δI,F OC , is between 0.76 and 0.88. Therefore, the answers to the questions of
which countries would gain more from optimally expanding their current road networks and which
countries suffer larger losses from misallocation of current roads is robust across these cases.




                                                         38
Alternative Assumptions               The analysis was implemented assuming N = 10 sectors. We also
implement the calibration and counterfactuals, under both mobile and fixed labor, assuming either
that N = 5 or N = 15, for the benchmark calibration of β and γ. We find that both the regional
impact within countries and the aggregate impact across countries are very similar to the benchmark
with N = 10. Table A.4 in Appendix B reports the coefficients from columns (3) and (4) of Table 1,
corresponding to the optimal expansion under calibrations that assume N = 5 or N = 15. In these
alternative cases, the patterns described above remain unchanged, and the magnitude of most of
the coefficients does not exhibit large variation.
    Similarly, Table A.5 reproduces Table 2 for the benchmark and for N = 15. The aggregate gains
change little with the number of sectors. The correlation between the aggregate welfare effects across
countries under N = 15 and under N = 10 is above 0.9 for each possible type of counterfactual
and assumptions on labor mobility and value of γ. The table also reports average welfare effects
under an alternative calibration where each of the largest N regions in each country, defined as
level-2 NUTS political subdivisions, is assigned a differentiated product.42 In the misallocation
and expansion counterfactuals under the geographic measure of costs, the correlation in welfare
gains between the benchmark case and this alternative allocation is between 0.88 and 0.97 across
assumptions of labor mobility, convexity of the parameter space, and number of goods; and between
0.65 and 0.79 in the expansion counterfactual under the FOC measure of costs.
    Finally, Table A.6 replicates the benchmark case under the assumption of no congestion across
goods. We find very similar average welfare effects in the two cases.

5.5     Application to Multiple Countries within Europe
    Our previous applications considered each country in isolation. We now implement the analysis
for a region of western Europe.43 Appendix Figure A.2 shows the baseline map and the discretized
network for this connected set of countries. We assume that each country produces a country-
specific differentiated product, in addition to a homogeneous good and use the same parameters as
in the benchmark. We re-calibrate the fundamentals assuming that the 5 largest locations in terms
of observed population within each country produce the differentiated product of that country,
while the remaining locations produce the homogeneous product. We now also implement a case
with partial mobility where labor is mobile within countries but not across countries, recalibrating
the fundamentals each time.
    Figure 6 shows the optimal network expansion under different assumptions of labor mobility.
The counterfactuals highlight the areas where European investments would be more profitable. The
investments are concentrated in Benelux countries, France, Germany, and Northern Italy. Within
Spain, the optimal expansion looks quite different from what we found in panel (b) of Figure

   42
      Within each region, the differentiated product is allocated to the largest location by population in the calibration.
We implement this version for the 15 countries in our data where the NUTS classification is available and there are
at least 4 level-2 NUTS regions.
   43
      We include 11 countries: Austria, Belgium, Switzerland, Germany, Denmark, Spain, France, Italy, Luxembourg,
Netherlands, and Portugal. We use 1 degree by 1 degree cells, resulting in 261 cells.


                                                            39
5, reflecting the European planner’s incentives to deal with international trade. The European
planner prioritizes two corridors connecting Spain to the North of Portugal and the center of Spain
to France, whereas the Spain-level planner chose a higher density of investment in the South of
the country. Within France, the pattern of investments radiating from Paris is similar to the case
in (a) of Figure 5, but now we see optimal investments in the connection with Spain, as well as
investments in the Northeast to connect with neighboring countries.

                             Figure 6: Optimal Network Expansion: Europe

                       (a) Full Mobility                         (b) Labor Mobility within Countries




                        (c) No Mobility                             (d) Discretized TEN-T Network




Notes: All counterfactuals use the geographic measure of building costs, δ I,GEO and the benchmark parametriza-
tion of β and γ. The width and brightness of each link is proportional to the difference between the optimal
                                                      ∗     obs
counterfactual network and the observed network, Ijk    − Ijk   , for each link jk ∈E shown in panel (b) of Figure
A.2. The color scale is the same as in Figure 2. Red links represent negative investment. With labor mobility,
brighter green (red) nodes represent larger population increase (decrease). Panel (d) shows a discretized version of
the TEN-T Core Network Corridors of the Trans-European Transport Network, based on information available at
http://ec.europa.eu/transport/infrastructure/tentec/tentec-portal/site/en/maps.html.


    The optimal network expansion is very similar in the three cases of labor mobility and the welfare
gains are very close to 2% in the three cases. When labor is mobile across Europe, the optimal
network investment reallocates workers to southern Spain and Portugal, much like in the country-

                                                        40
by-country analysis we found reallocation to areas with relatively lower income per worker. As in
the previous cases, these changes in population do not correlate very strongly with the investments.
     To conclude, we ask whether these patterns are approximately comparable with the Trans-
European Transport Network (TEN-T), a European Commission policy that supports the develop-
ment of Europe-wide transport networks. The network includes roads, air and inland waterways.
The TEN-T defines a core network of “strategic importance” for future investments based on cri-
teria such as eliminating bottlenecks or following suggestions from member states.44 Panel (d)
of Figure 6 shows these corridors for the area of Europe covered by our counterfactual. Broadly
speaking, our planning problem identifies some priorities for investment which appear to be sim-
ilar to what real-world planners have decided, such as the high density of investment in Benelux
countries and Germany; the international corridor from Paris to the Southwest of France, North
of Spain and Portugal; and the connection between Germany and Denmark. However, we also see
some differences, as the solution to our planning problem does not identify the need to invest in
roads connecting the Southeast of France to the South of Spain and Portugal.


6        Conclusion
     In this paper, we develop a framework to study optimal transport networks in spatial equilibrium
models. The framework combines a neoclassical environment where each location is a node in a
graph, an optimal transport problem subject to congestion in shipping across commodities, and an
optimal network design. It nests commonly used neoclassical trade models and it allows for either
fixed or mobile factors across space. We provide conditions such that the full planner’s problem,
involving the optimal flow of goods as well as the general-equilibrium and network-design problems,
is globally convex and numerically tractable using standard numerical methods typically applied
to tackle optimal transport problems.
     In the application, we match the model to data on road networks and economic activity across
European countries. Using the calibrated model, we compute the gains from road expansion and
losses from misallocation. Across countries, we find real consumption losses in the order of 2%
associated with misallocation of roads.
     Our approach using a global planner is particularly well suited for environments where agglom-
eration spillovers may not be too strong. We have also shown how in principle the model could be
used in cases with spillovers. Due to current limitations in computing power and given the level of
geographic detail that we handle, we have only applied the model to cases with a limited number
of commodities.
     We expect the framework to serve as basis for future work. It could be used to study political-
economy issues associated with infrastructure, such as spatial competition among planning author-
ities. We have refrained from explaining the sources of misallocation, but it would be interesting to
    44
     See https://ec.europa.eu/transport/themes/infrastructure/ten-t-guidelines/maps en. The planning guidelines
are mentioned in the European Commission working document, available in https://eur-lex.europa.eu/legal-
content/EN/TXT/PDF/?uri=CELEX:52013SC0542&from=EN.


                                                      41
know the role of regional characteristics such as institutional quality. Our application was limited
to European countries, but low-income economies are likely to benefit more from infrastructure
investment and are perhaps more prone to inefficient investments due to their institutional envi-
ronments.
   The persistence of transport networks also raises interesting issues. The model could be ex-
tended to study inefficient network lock-in due to existing investments corresponding to dated
economic fundamentals. Relatedly, we have abstracted from decision-making under uncertainty,
but it would be interesting to study a planner who decides in anticipation of changing conditions
about technology or fundamentals. In the spirit of Barjamovic et al. (2017), who use the prediction
of gravity models to infer the location of cities, one could also envision applications where the model
is used to infer the location of roads in historical data.
   Finally, the empirical literature mentioned in Section 2 relies on exogenous sources of variation
for the placement of infrastructure investments; the framework may be used to construct instru-
ments for investments in transport infrastructure as function of observable regional characteristics.
Finally, a number of forces such as commuting or dynamic adjustment were left out of our analysis.
We believe these are all interesting avenues to pursue in future research.

References
Ahuja, R. K., T. L. Magnanti, and J. B. Orlin (1989). Chapter iv network flows. Handbooks in operations
  research and management science 1, 211–369.
Alder, S. (2019). Chinese roads in india: The effect of transport infrastructure on economic development.
  Manuscript, Univ. North Carolina, Chapel Hill .
Allen, T. and C. Arkolakis (2014). Trade and the topography of the spatial economy. Quarterly Journal of
  Economics 1085, 1139.
Allen, T. and C. Arkolakis (2019). The welfare effects of transportation infrastructure improvements.
  Manuscript, Dartmouth and Yale.
Allen, T., C. Arkolakis, and Y. Takahashi (2014). Universal gravity. NBER Working Paper (w20787).
Anderson, J. E. and E. Van Wincoop (2003). Gravity with gravitas: a solution to the border puzzle. the
  american economic review 93 (1), 170–192.
Anderson, J. E. and E. Van Wincoop (2004). Trade costs. Journal of Economic literature 42 (3), 691–751.
Arrow, K. J. and A. C. Enthoven (1961). Quasi-concave programming. Econometrica: Journal of the
  Econometric Society, 779–800.
Asturias, J., M. Garcı́a-Santana, and R. Ramos Magdaleno (2016). Competition and the welfare gains from
  transportation infrastructure: Evidence from the golden quadrilateral of india.
Atkeson, A. and A. T. Burstein (2010). Innovation, firm dynamics, and international trade. Journal of
  political economy 118 (3), 433–484.
Atkin, D. and D. Donaldson (2015). Who’s getting globalized? the size and implications of intra-national
  trade costs. Technical report, National Bureau of Economic Research.
Banavar, J. R., F. Colaiori, A. Flammini, A. Maritan, and A. Rinaldo (2000). Topology of the fittest
  transportation network. Physical Review Letters 84 (20), 4745.
Barjamovic, G., T. Chaney, K. A. Coşar, and A. Hortaçsu (2017). Trade, merchants, and the lost cities of
  the bronze age. Technical report, National Bureau of Economic Research.

                                                   42
Bartelme, D. (2015). Trade costs and economic geography: Evidence from the U.S. Technical report,
  University of Michigan.
Baum-Snow, N. (2007). Did highways cause suburbanization? The Quarterly Journal of Economics, 775–
  805.
Beckmann, M. (1952). A continuous model of transportation. Econometrica: Journal of the Econometric
  Society, 643–660.
Bernot, M., V. Caselles, and J.-M. Morel (2009). Optimal transportation networks: models and theory,
  Volume 1955. Springer Science & Business Media.
Bertsekas, D. P. (1998). Network optimization: continuous and discrete models. Citeseer.
Boyd, S. and L. Vandenberghe (2004). Convex optimization. Cambridge university press.
Brancaccio, G., M. Kalouptsidi, and T. Papageorgiou (2017). Geography, search frictions and endogenous
  trade costs. Technical report, National Bureau of Economic Research.
Brandt, L., T. Tombe, and X. Zhu (2013). Factor market distortions across time, space and sectors in China.
  Review of Economic Dynamics 16 (1), 39–58.
Burstein, A. and J. Cravino (2015). Measured aggregate gains from international trade. American Economic
  Journal: Macroeconomics 7 (2), 181–218.
Caliendo, L., F. Parro, E. Rossi-Hansberg, and P.-D. Sarte (2014). The impact of regional and sectoral pro-
  ductivity changes on the U.S. economy. Technical Report 20168, National Bureau of Economic Research.
Carlier, G. (2010). Optimal transportation and economic applications. Technical report, IMA.
Chandra, A. and E. Thompson (2000). Does public infrastructure affect economic activity?: Evidence from
  the rural interstate highway system. Regional Science and Urban Economics 30 (4), 457–490.
Chaney, T. (2014a). The network structure of international trade. The American Economic Review 104 (11),
  3600–3634.
Chaney, T. (2014b). Networks in international trade. In The Oxford Handbook of the Economics of Networks.
Collier, P., M. Kirchberger, and M. Söderbom (2016). The cost of road infrastructure in low-and middle-
  income countries. The World Bank Economic Review 30 (3), 522–548.
Combes, P.-P. and M. Lafourcade (2005). Transport costs: measures, determinants, and regional policy
  implications for france. Journal of Economic Geography 5 (3), 319–349.
Coşar, A. K. and B. Demir (2016). Domestic road infrastructure and international trade: Evidence from
  turkey. Journal of Development Economics 118, 232–244.
Costinot, A. and A. Rodrı́guez-Clare (2013). Trade theory with numbers: Quantifying the consequences of
  globalization, vol. 4 of handbook of international economics.
Couture, V., G. Duranton, and M. A. Turner (2018). Speed. Review of Economics and Statistics 100 (4),
  725–739.
Desmet, K. and E. Rossi-Hansberg (2013).        Urban accounting and welfare.      American Economic Re-
  view 103 (6), 2296–2327.
Djankov, S., C. Freund, and C. S. Pham (2010). Trading on time. The Review of Economics and Statis-
  tics 92 (1), 166–173.
Doll, C., H. van Essen, et al. (2008). Road infrastructure cost and revenue in europe. Produced within the
  study Internalisation Measures and Policies for all external cost of Transport (IMPACT) P Deliverable 2.
Donaldson, D. (2010). Railroads of the raj: Estimating the impact of transportation infrastructure. Technical
  report, National Bureau of Economic Research.


                                                     43
Donaldson, D. (2015). The gains from market integration. Annual Review of Economics 7 (1), 619–647.
Donaldson, D. and R. Hornbeck (2016). Railroads and american economic growth: A market access approach.
  The Quarterly Journal of Economics, qjw002.
Duranton, G., P. M. Morrow, and M. A. Turner (2014). Roads and trade: Evidence from the us. The Review
  of Economic Studies 81 (2), 681–724.
Duranton, G. and M. A. Turner (2011). The fundamental law of road congestion: Evidence from us cities.
  The American Economic Review 101 (6), 2616–2652.
Eaton, J. and S. Kortum (2002). Technology, geography, and trade. Econometrica 70 (5), 1741–1779.
Ekeland, I. (2010). Notes on optimal transportation. Economic Theory 42 (2), 437–459.
Faber, B. (2014). Trade integration, market size, and industrialization: evidence from china’s national trunk
  highway system. The Review of Economic Studies, rdu010.
Fajgelbaum, P. D., E. Morales, J. C. Suárez Serrato, and O. Zidar (2018). State taxes and spatial misallo-
  cation. The Review of Economic Studies 86 (1), 333–376.
Felbermayr, G. J. and A. Tarasov (2015). Trade and the spatial distribution of transport infrastructure.
Fernald, J. G. (1999). Roads to prosperity? assessing the link between public capital and productivity.
  American Economic Review , 619–638.
Figueroa, C., B. Fotsch, S. M. Hubbard, and J. Haddock (2013). Assessment procedures for paved and gravel
  roads. Technical report, Purdue University School of Civil Engineering.
Firth, J. (2017). I’ve been waiting on the railroad: The effects of congestion on firm production.
Galichon, A. (2016). Optimal Transport Methods in Economics. Princeton University Press.
Head, K. and T. Mayer (2014). Gravity equations: Workhorse, toolkit, and cookbook. Handbook of Inter-
  national Economics, Vol. 4 .
Helpman, E. (1998). The size of regions: transport and housing as factors in agglomeration. In D. Pines,
  E. Sadka, and I. Zilcha (Eds.), Topics in Public Economics, pp. 33–54. Cambridge University Press
  Cambridge.
Hsieh, C.-T. and P. J. Klenow (2009). Misallocation and manufacturing TFP in China and India. Quarterly
  Journal of Economics 124 (4), 1403–1448.
Hsieh, C.-T. and E. Moretti (2019). Housing constraints and spatial misallocation. American Economic
  Journal: Macroeconomics 11 (2), 1–39.
Hummels, D. L. and G. Schaur (2013). Time as a trade barrier. American Economic Review 103 (7), 2935–59.
IADB (2013). Too far to export: Domestic transport costs and regional export disparities in latin america
  and the caribbean.
Kantorovich, L. V. (1942). On the translocation of masses. In Dokl. Akad. Nauk SSSR, Volume 37, pp.
  199–201.
Krugman, P. (1991). Increasing returns and economic geography. Journal of Political Economy 99 (3),
  483–499.
Lai, E. L.-C., H. Fan, and H. S. Qi (2015). Global gains from reduction of trade costs.
Limao, N. and A. J. Venables (2001). Infrastructure, geographical disadvantage, transport costs, and trade.
  The World Bank Economic Review 15 (3), 451–479.
Llano, C., A. Esteban, J. Pérez, and A. Pulido (2010). Opening the interregional trade black box: The
  c-intereg database for the spanish economy (1995–2005). International Regional Science Review .


                                                     44
Maibach, M., C. Schreyer, D. Sutter, H. Van Essen, B. Boon, R. Smokers, A. Schroten, C. Doll, B. Pawlowska,
 and M. Bak (2013). Handbook on estimation of external costs in the transport sector.
Martincus, C. V., J. Carballo, and A. Cusolito (2017). Roads, exports and employment: Evidence from a
 developing country. Journal of Development Economics 125, 21–39.
Mohring, H. and M. Harwitz (1962). Highway benefits: An analytical framework. Technical report, North-
 western University.
Monge, G. (1781). Mémoire sur la théorie des déblais et des remblais. De l’Imprimerie Royale.
Nagy, D. (2016). City location and economic development. Manuscript, CREI .

Nesterov, Y. and A. Nemirovskii (1994). Interior-point polynomial algorithms in convex programming. SIAM.
Newbery, D. M. (1988). Road damage externalities and road user charges. Econometrica: Journal of the
  Econometric Society, 295–316.
Ramondo, N., A. Rodrı́guez-Clare, and M. Saborı́o-Rodrı́guez (2012). Trade, domestic frictions, and scale
  effects. Technical report, National Bureau of Economic Research.
Redding, S. J. (2016). Goods trade, factor mobility and welfare. Journal of International Economics 101,
  148–167.
Redding, S. J. and E. Rossi-Hansberg (2016). Quantitative spatial economics. Technical report, National
  Bureau of Economic Research.
Redding, S. J. and M. A. Turner (2015). Transportation costs and the spatial organization of economic
  activity, vol. 5 of handbook of regional and urban economics.
Restuccia, D. and R. Rogerson (2008). Policy distortions and aggregate productivity with heterogeneous
  establishments. Review of Economic Dynamics 11 (4), 707–720.
Riley, S., S. DeGloria, and R. Elliot (1999). A terrain ruggedness index that quantifies topographic hetero-
  geneity. Intermountain Journal of Sciences 5 (1–4), 23–27.
Roback, J. (1982). Wages, rents, and the quality of life. The Journal of Political Economy, 1257–1278.
Santambrogio, F. (2015). Optimal transport for applied mathematicians. Birkäuser, NY .
Sotelo, S. (2016). Domestic trade frictions and agriculture. Manuscript, University of Michigan.
Swisher IV, S. (2015). Reassessing railroads and growth: Accounting for transport network endogeneity.
  Technical report, mimeo.
Takayama, A. (1985). Mathematical economics. Cambridge University Press.
Tay, R. and A. Churchill (2007). Effect of different median barriers on traffic speed. Canadian Journal of
  Transportation 1 (1).
Trew, A. W. (2016). Endogenous infrastructure development and spatial takeoff.
Villani, C. (2003). Topics in optimal transportation. Number 58. American Mathematical Soc.
Winston, C. (1985). Conceptual developments in the economics of transportation: an interpretive survey.
 Journal of Economic Literature 23 (1), 57–94.
WorldBank (2011). Africa’s Transport Infrastructure: Mainstreaming Maintenance and Management. World
 Bank Publications.




                                                     45
Online Appendix




      46
A      Appendix to Section 3 (Model)
A.1       Planner’s Problem
     In this section we present the first-order conditions to the planner’s problem. We refer to these conditions in some
of the characterizations in the text and in the proofs below. We present the problem adopting a formulation of the
transport technology that nests the approach with own-good congestion in which the transport cost is denominated
in units of the good being shipped, as well as the approach with congestion across goods in which the transport cost
is denominated in units of the bundle of traded goods (discussed in Section 3.7). In the formulations below, the
parameter χ ∈ {0, 1} takes a value of 0 in the case with own-good congestion, and the value of 1 with cross-good
congestion. The case χ = 0 corresponds to the equations presented in the body of the paper.


Immobile Labor
   The Lagrangian of the problem in Definition 1 is
                                                                                            
      X                       X D             X                                               X H
  L =    ωj Lj U (cj , hj ) −  Pj cj Lj + χ        τjk (Qjk , Ijk ) Qjk − Dj Dj1 , .., DjN  −  Pj (hj Lj − Hj )
           j                                      j                             k∈N (j)                                                                  j
                                                                                                                                                            
          XX                                 X                                                                                        n
                                                                                                                                                   X
      −               Pjn Djn +                      Qn             n   n         n     n
                                                       jk + (1 − χ) τjk Qjk , Ijk Qjk − Fj Ln    n
                                                                                            j , Vj , Xj −                                                Qn
                                                                                                                                                          ij
                                                                                                                                                             
           j      n                         k∈N (j)                                                                                            i∈N (j)
                      "                       #                         "                             #
          X            X                              XX                 X
      −        Wj             Ln
                               j − Lj −                             Rjm
                                                                                  Vjmn − Vjm
           j              n                           j     l                 n
                           
            X X I               X I             X I             
      − PK     δjk Ijk − K  +  ζjk Ijk − I jk + ζjk I jk − Ijk
                      j   k∈N (j)                                   j,k                               j,k
          X        Q
                                      X                   X                           X                       X                 X              X
      +           ζjkn Qn
                        jk        +          L
                                            ζjn Ln
                                                 j    +              V
                                                                    ζjnl Vjln     +            X
                                                                                              ζjnl Xjln   +          D
                                                                                                                    ζjn Djn +       ζjc cj +       ζjh hj
          j,k,n                       j,n                 j,n,l                       j,n,l                   j,n               j              j

                   PN                                                      Q
where Qjk = n=1 mn Qn                    D    H    N       l         I            L     V      C     c    h
                         jk and where Pj , Pj , Pj , Wj , Rj , PK , ζjk , ζjkn , ζjn , ζjnl , ζjn , ζj , ζj are the multipliers
of all constraints implied by (i)-(v) in Definition 1. The first-order conditions with respect to consumption and
production are:

                                                                     [cj ]        ωj Lj UC (cj , hj ) + ζjc = PjD Lj
                                                                 [hj ]            ωj Lj UH (cj , hj ) + ζjh = PjH Lj
                                                                 n                     ∂Dj
                                                                 Dj               PjD            D
                                                                                              + ζjn = Pjn
                                                                                         ∂Djn
                                                                                      ∂Yjn
                                                                    Ln
                                                                     j            Pjn           L
                                                                                             + ζjn = Wj
                                                                                        ∂Lnj
                                                                                      ∂Yjn
                                                                    Vjn           Pjn            V
                                                                                              + ζjnl = Rjl
                                                                                        ∂Vjln
                                                                                      ∂Yjn
                                                                    Xjn           Pjn            X
                                                                                              + ζjnl = Pjl
                                                                                        ∂Xjln

The first-order condition with respect to flows is:
                                                        n                   
                 n                                  ∂τjk (Qjk , Ijk )
                 Qjk      − χPjD τjk n
                                       (Qjk , Ijk ) +                   Qjk
                                                           ∂Qjk
                                                                                   !
                                                               n
                                      n     n     n      ∂τjk      Qnjk , Ijk
                          − (1 − χ) Pj τjk Qjk , Ijk +                           Qjk + Pkn − Pjn + ζjkn
                                                                                  n                 Q
                                                                                                        =0                                                       (A.1)
                                                                  ∂Qn  jk




                                                                                                 47
which, along with the complementary slackness condition for Qn      jk , implies (8) in the main text.
    Finally, the first order condition with respect to the network investment is
              N                                            N                n
                                                                                            ! 
             X      D n
                                n
                              ∂τjk (Qjk , Ijk )             X    n n       ∂τjk   Qn
                                                                                   jk , Ijk       I    I
                                                                                                          
                                                                                                                  I
 [Ijk ]    χ     Pj Qjk −                         + (1 − χ)     Pj Qjk −                      + ζjk − ζjk   = PK δjk (A.2)
             n=1
                                   ∂Ijk                     n=1
                                                                                 ∂Ijk

                                                             n
which, along with the complementary slackness condition for Ijk , implies (9) in the text.


Mobile Labor
    The Lagrangian of the problem in Definition 2 is
                                                                                                        !
                      X                                                     L
                                                                                  X
       L =u−                   ω̃j Lj (u − U (cj , hj )) − W                               Lj − L
                       j                                                              j
                                                                                                        !                                      
              X                                   N
                                                  X X                       N
                                                                            X                                                                       X
          −        PjD cj Lj + χ                                 n
                                                                 τjk              mn Qn
                                                                                      jk , Ijk               Qn        1        N 
                                                                                                              jk − Dj Dj , .., Dj   −                         PjH (hj Lj − Hj )
               j                                  n=1 k∈N (j)               n=1                                                                           j
                                                                                                                                                                          
              XX                                   X                                                                                                           X
          −                Pjn Djn +                       Qn             n   n         n     n
                                                             jk + (1 − χ) τjk Qjk , Ijk Qjk − Fj Ln    n
                                                                                                  j , Vj , Xj −
                                                                                                                                                    n
                                                                                                                                                                        Qn
                                                                                                                                                                         ij
                                                                                                                                                                            
               j      n                           k∈N (j)                                                                                                     i∈N (j)
                           "                        #                         "                         #
              X                X                          XX                      X
          −        Wj               Ln
                                     j      − Lj −                      Rjl               Vjn   − Vj
               j                n                           j     l               n
                               
                X X I               X I             X I             
          − PK     δjk Ijk − K  +  ζjk Ijk − I jk + ζjk I jk − Ijk
                           j    k∈N (j)                                 j,k                                   j,k
              X        Q
                                            X                   X                             X                       X                 X                 X
          +           ζjkn Qn
                            jk          +          L
                                                  ζjn Ln
                                                       j    +            V
                                                                        ζjnl Vjln         +            X
                                                                                                      ζjnl Xjln   +          D
                                                                                                                            ζjn Djn +       ζjc cj +              ζjh hj
              j,k,n                         j,n                 j,n,l                         j,n,l                   j,n               j                     j


where, in addition to the previous notation for the multipliers, in the first line we have defined ω̃j and W L as the
multipliers of constraints (vi) and (vii) in Definition 2.
                                                                                  
    The first-order conditions with respect to consumption of traded services Cjn , factor allocation within locations
 n  n                                    
 Lj , Vj and Xjn , optimal transport Qn       jk , and optimal investment [Ijk ] are the same as in the problem without
labor mobility. The first-order conditions with respect to u and Lj are:
                                                                      X
                                                   [u]          1=            Lj ω̃j
                                                                        j

                                                  [Lj ]         PjD cj + PjH hj − ω̃j [U (cj , hj ) − u] = Wj − W L

where from monotonicity of U (cj , hj ) it follows that
                                                                                       
                                                                                       u                   if Lj > 0,
                                                                        U (cj , hj ) =
                                                                                       0                   if Lj = 0.

In addition, the first-order conditions with respect to consumption of traded and non-traded services, [cj ] and [hj ],
are the same as in the problem without labor mobility replacing the planner’s weights ωj with the multipliers of the
mobility constraint ω̃j . Combining [Lj ] with [cj ] and [hj ] gives the multiplier on the labor-mobility constraint. For
populated locations:
                                                            Wj − W L
                                          ω̃j =                                     .
                                                UC (cj , hj ) cj + UH (cj , hj ) hj




                                                                                                  48
A.2        Symmetry in Infrastructure Investments
    For the applications in Section 5 we impose symmetry in infrastructure levels as an additional restriction in the
planner’s problem, i.e., Ijk = Ikj . This section provides the first-order condition for Ijk in that case. The first-order
condition with respect to Ijk is

                   N             n                            n            
                  X             ∂τjk (Qjk , Ijk )     D n ∂τkj (Qkj , Ijk )
  [Ijk ]      −χ        PjD Qn
                             jk                   + Pk  Q kj
                  n=1
                                     ∂Ijk                        ∂Ijk
                         N              n      n
                                                                   n    n
                                                                                ! 
                                n n ∂τjk Qjk , Ijk           n n ∂τkj Qjk , Ijk
                        X                                                                                    
                                                                                     I     I          I     I
              − (1 − χ)       Pj Qjk                    + Pk Qkj                  + ζjk − ζjk   = PK δjk + δkj   . (A.3)
                        n=1
                                            ∂Ijk                      ∂Ijk

Assuming symmetry leaves all the remaining first-order conditions presented in Section A.1 unchanged. Under
the log-linear
               specification (10) of the transport technology, the optimal infrastructure investment, conditional on
                
         I   I
Ijk ∈ ζjk , ζjk   , is


                                                                                                                                                              1
                                                                                     N
                                                                                                                                                           ! 1+γ
                 γ                                                                 X                                1+β                     1+β   
 ∗                                    τ
Ijk   =                   χ       δjk PjD Q1+β
                                              jk       +     τ
                                                            δkj PkD Q1+β
                                                                     kj         +          (1 − χ)        τ
                                                                                                         δjk Pjn   Qn
                                                                                                                    jk        +    τ
                                                                                                                                  δkj Pkn   Qn
                                                                                                                                             jk
                                                                                                                                                                 .
               I     I
           PK δjk + δkj                                                              n=1

                                                                                                                  (A.4)
                                       I,F OC                                             I      I            ∗     obs
As discussed in Section 5.2, to build δjk     we use (A.4) under the symmetry assumption δjk = δkj . Setting Ijk = Ijk
   I,F OC                                                                                   OBS
, δjk     can be backed out as function of calibrated parameters, the observed network Ijk      , and the equilibrium
prices generated by the calibrated model. Note that, to generate these prices, we use the model calibrated given the
           OBS
network Ijk    , as discussed in Section 5.2.


A.3        Proofs of the Propositions
Proposition 1. (Convexity of the Planner’s Problem) (i) Given the network {Ijk }, the joint optimal transport
and allocation problem in the fixed (resp. mobile) labor case is a convex (resp.quasiconvex) optimization problem if
Qτjk (Q, Ijk ) is convex in Q for all j and k ∈ N (j); and (ii) if in addition Qτjk (Q, I) is convex in both Q and I for
all j and k ∈ N (j), then the full planner’s problem including the network design problem from Definition (1) (resp.
Definition (2)) is a convex (resp. quasiconvex) optimization problem. In either the joint transport and allocation
problem, or the full planner’s problem, strong duality holds when labor is fixed.

Proof. Consider the planner’s problem from Definition 1. We can write it as
                                                                                                                       
                                                                                           X                   Cj H j
                                                        max o                        f=         ωj Lj U          ,
                                                   n
                                           Cj , Djn , Qn ,I
                                                                           
                                                                                            j
                                                                                                               Lj Lj
                                                       jk jk     k∈N (j)        ∀j


subject to: (i) availability of traded commodities,
                                                   X                                              
                            gj1 = Cj + χ                    τjk (Qjk , Ijk ) Qjk − Dj Dj1 , .., DjN 6 0 for all j;
                                                  k∈N (j)


(ii) the balanced-flows constraint,

            2
                          X                                                          X
           gjn ≡ Djn +             Qn                   n
                                    jk 1 + (1 − χ) τjk Qjk , Ijk    − Fjn Ln    n    n
                                                                           j , Vj , Xj −   Qn
                                                                                            ij ≤ 0 for all j, n;
                         k∈N (j)                                                                                    i∈N (j)


(iii) the network-building constraint,
                                                                X X              I
                                                                                δjk Ijk ≤ K;
                                                                 j   k∈N (j)

and conditions (iv)-(v) in the text. Since constraints (iii)-(v) are linear, we need f to be concave and gj1 and gjn
                                                                                                                  2
                                                                                                                     to


                                                                               49
                                                                                       
be convex. Since U is jointly concave in both its arguments, f is concave. Dj Djn is concave, hence gj1 is convex.
                                     2
If Qτjk (Q, I) is convex in then gjn    is the sum of linear and convex functions, hence it is convex. To show that this
problem admits strong duality, a constraint qualification is required. Note first that constraints gj1 and gjn
                                                                                                            2
                                                                                                               must hold
with equality at an optimum and therefore can be substituted into the objective function. The remaining constraints
(iii)-(v) are all linear and thus satisfy the Arrow-Hurwicz-Uzawa qualification constraint (Takayama (1985), Theorem
1.D.4). Hence, the global optimum must satisfy the KKT conditions and the duality gap is 0.45
      Consider now the planner’s problem with labor mobility from Definition 2. Because U is homothetic, we can
express it as U = G (U0 (c, h)), where G is an increasing continuous function and U0 is homogeneous of degree 1.
Therefore, imposing the change of variables ũ = G−1 (u), the planner’s problem can be restated as

                                                               max ũ

subject to the convex constraints (i)-(v) and Lj ũ 6 U0 (Cj , Hj ).n Toomake the latter constraint convex, let us denote
Uj = Lj ũ and replace ũ in the objective function by minj|Lj >0 Ljj ,46 so that the problem becomes
                                                                      U


                                                                                                                 
                                                                                                             Uj
                                                        max                                      min
                                        
                                     Cj , Djn ,Ln
                                                      n
                                                  ,Vjn , Qn ,I n
                                                                   o             
                                                                                     ,Uj ,Lj
                                                                                               j|Lj >0       Lj
                                                j         jk jk        k∈N (j)


subject to the convex restrictions (i)-(v) above as well as

                                                  Uj ≤ U0 (Cj , Hj ) for all j.

The objective function is quasiconcave because Uj /Lj is quasiconcave and the minimum of quasiconcave functions is
quasiconcave. In addition, all the restrictions are convex. Arrow and Enthoven (1961) then implies that the Karush-
Kuhn-Tucker conditions are sufficient if the gradient of the objective function is different from zero at the candidate
for an optimum, and here the gradient never vanishes.



Proposition 2. (Optimal Network in Log-Linear Case) When the transport technology is given by (10), the full
planner’s problem is a convex (resp. quasiconvex) optimization problem if β ≥ γ. The optimal infrastructure is given
by (12) implying that, in the absence of a pre-existing network (i.e., if I jk = 0), then Ijk = 0 ↔ Pkn = Pjn for all n.

Proof. First, note that if β ≥ γ then Qτ (Q, I) ∝ Q1+β I −γ is convex in Q ∈ R+ and I ∈ R+ . To see that, note that
the determinant of the Hessian of Q1+β I −γ is (1 + β) γ (β − γ) Q2β I −2(γ+1) , which is positive for Q ∈ R+ and I ∈ R+
if β ≥ γ ≥ 0. Next, from the first-order condition for optimal infrastructure (9), if the solution to the planning problem
implies Ijk = I jk , so that there is no investment, then:
                                                               n
                                            1 X n n ∂τjk
                                    PK ≥ −   I
                                                   Pj Qjk
                                           δjk n            ∂Ijk             Ijk =I jk
                                               P    n
                                                             1+β
                                            τ
                                          δjk    n Pj   Qnjk
                                        ≥γ I
                                          δjk        I γ+1
                                                       jk
                                                                                                         1+β
                                                               P                                 Pkn        β
                                            γ (1 + β)  − 1+β
                                                          β            n:Pkn >Pjn      Pjn       Pjn
                                                                                                       −1
                                        ≥          1                                   β−γ
                                                                                                                      ,
                                                       β
                                               I
                                              δjk   τ
                                                   δjk                                 I jkβ

where the second line follows from (10) and the third line follows from (11). Note that the last inequality is equivalent

   45
     Despite having substituted constraints gj1 and gjn   2
                                                             into the objective function, the multipliers for these constraints,
PjD and  Pj , can be recovered from the above KKT conditions such that ωj UC (cj , hj ) = PjD and PjD ∂CjT /∂Cjn = Pjn .
           n
   46
     Since the objective function is strictly increasing in ũ and because ũ only shows up in the constraints Lj ũ 6
U0 (Cj , Hj ) for all j, it is necessarily the case that ũ = minj|Lj >0 Uj /Lj .


                                                                       50
           ∗        ∗                                         ∗                             ∗
to I jk ≥ Ijk  for Ijk defined in (14). Therefore, if I jk < Ijk then Ijk > I jk and Ijk = Ijk . Moreover, if there is any n
              n      n       ∗
such that Pk 6= Pj then Ijk > 0.



Proposition 3. (Tree Property) Assume that lim UC (c, h) = ∞. In the absence of a pre-existing network (i.e.,
                                                               c→0+
I jk = 0), if the transport technology is given by (10) and satisfies γ > β, and if there is a unique commodity produced
in a single location, then the optimal transport network is a tree.

Proof. See Section G of the Supplementary Material.

                                                                                                                                                      
Definition 3. The decentralized equilibrium without labor mobility consists of quantities cj , hj , Dj , Djn , Lnj , Vjn , Xnj , Qnjk                     k∈N (j)
                                                                                                                                                                    ,
                                                                 
goods prices pn       D    H                         m
               j n , pj , pj and factor prices wj , rj                        m
                                                                                  in each location jsuch that:
    (i)(a) consumers optimize:
                                                                                             
                                                             {cj , hj } = arg max U ĉj , ĥj
                                                                                       ĉj ,ĥj

                                                    pD
                                                     j ĉj   +    pH
                                                                   j ĥj      = e j ≡ wj + t j ,
                                                                                                                                      
where ej are expenditures per worker in j and where pD                                          1        N
                                                       j is the price index associated with Dj Dj , .., Dj                                at prices
 n
 pj n and tj is a transfer per worker located in j. The set of transfers satisfy
                                                                         X
                                                                               tj Lj = Π
                                                                          j


where Π adds up the aggregate returns to the portfolio of fixed factors and the government tax revenue,
                                           X                 XX                             X X X
                                   Π=             pH
                                                   j Hj +                     rjm Vjm +                       tn   n n
                                                                                                               jk pk Qjk ;
                                              j               j       m                       j   k∈N (j) n


    (i)(b) firms optimize:
                                                                                       X m mn
                               Ln    n    n
                                j , Vj , Xj = argmax pn  n
                                                      j Fj   L̂n     n     n
                                                               j , V̂j , X̂j   − wj L̂n
                                                                                      j −  rj V̂j ;
                                                    L̂n    n    n
                                                      j ,V̂j ,X̂j                                                  m


    (i)(c) the transport companies optimize,
                                                       ρ−1                                                  Xρ−1
             n
                                                       X
            πod =         max             pn    n
                                           d − po −               χPjDk mn τjk jk+1 + (1 − χ) Pjnk τjnk jk+1 −     pjk+1 tn
                                                                                                                          jk jk+1 ,
                    r=(j0 ,...,jρ )∈Rod
                                                       k=0                                                                   k=0

                                          
for all (o, d) ∈ J 2 , where Rod = (j0 , . . . , jρ ) ∈ J ρ+1 , ρ ∈ N | j0 = o, jρ = d, jk+1 ∈ N (jk ) for all 0 ≤ k < ρ is the
                                                                                                                         n
set of routes from o to d,and there is free entry to delivering products from every source to every destination: πod       ≤0
                  2
for all (o, d) ∈ J , = if good n is shipped from o to d.
     (i)(d) producers of final commodities optimize:
                                        n                         n o X
                                         Dj = argmax Dj              D̂jn    −     pn   n
                                                                                    j D̂j ;
                                                                  D̂jn                               j


    as well as the market-clearing and non-negativity constraints (i), (ii), (iv), and (v) from Definition 1.
    If, in addition, labor is mobile, then the decentralized equilibrium also consists of utility u and employment {Lj }
such that
                                                     u = Uj (cj , hj )

whenever Lj > 0, and the labor market clearing condition (vii) from Definition 2 holds.



                                                                                  51
Proposition 4. (First and Second Welfare Theorems) If the tax on shipments of product n from j to k, denom-
                                                                                                                  
inated in the same unit as transport costs, is tn              n τ                             τ      n    n
                                                    jk = χm εQ,jk τjk (Qjk , Ijk ) + (1 − χ) εQ,jkn τjk Qjk , Ijk   where
εn              n         n
 Q,jk = ∂ log τjk /∂ log Qjk (χ = 0) and εQ,jk = ∂ log τjk /∂ log Qjk (χ = 1), then: (i) if labor is immobile, the
competitive allocation coincides with the planner’s problem under specific planner’s weights ωj and, conversely, the
planner’s allocation can be implemented by a market allocation with specific transfers tj ; and (ii) if labor is mobile,
the competitive allocation coincides with the planner’s problem if and only if all workers own an equal share of fixed
factors and tax revenue, i.e., tj = ΠL
                                       . In either case, the price of good n in location j, pn
                                                                                             j , equals the multiplier on
                                                             n
the balanced-flows constraint in the planner’s allocation, Pj .

Proof. Equivalence of the First-order Conditions. Condition (i)(c) from the definition of the market allocation
implies that the free entry condition of shippers holds for every pair of neighbors; i.e., for every j ∈ J and k ∈ N (j),

                                                    n                   
                        pn    n            n  n            D
                         k ≤ pj + (1 − χ) pj τjk + tjk + χPj mn τjk + tn          n
                                                                       jk , = if Qjk > 0.                           (A.5)

This condition is consistent with the first-order condition (8) from the planner’s problem if and only if the tax scheme
is defined as in the proposition. We must further show that, under this tax scheme, a route is the solution to (i)(c)
if and only if it is used in the solution to the planner’s problem, which we establish at the end of this proof.
     Without labor mobility, the rest of the allocation corresponds to a standard neoclassical economy with con-
vex technologies and preferences where the welfare theorems hold. Specifically, the first-order conditions from the
consumer and firm optimization problems (i)(a) and (i)(b) yield:
                                                      
                                                        1
                                              [ĉj ]         UC (cj , hj ) = pD
                                                                              j
                                                        λj
                                            h i       
                                                        1
                                              ĥj            UH (cj , hj ) = pH
                                                                              j
                                                        λj
                                           h i           ∂Dj
                                            D̂jn     pD
                                                      j       = pnj
                                                         ∂Djn
                                           h i       ∂Yjn n
                                             L̂nj          Pj ≤ wj , = if Ljn > 0
                                                     ∂Ln j
                                        h         i   ∂Yjn n
                                          V̂jmn             Pj ≤ rjm , = if Vjmn > 0.
                                                     ∂Vjmn

Since the market clearing constraints are the same in the market’s and the planner’s allocation, the planner’s allocation
coincides with the market if the planner’s weights are such that the planner’s FOC for cj coincide with the market.
This is the case if the weight ωj from the planner’s problem equals the inverse of the multiplier on the budget
constraint from the consumer’s optimization problem (i)(a) in the market allocation. To find that weight, using that
U is homothetic we can write U = G (U0 (c, h)), where U0 is homogeneous of degree 1. Then, the planner’s allocation
coincide with the market’s under weights
                                                                 ej
                                            ωj =                                    ,
                                                   G′ (U0 (cj , hj )) U0 (cj , hj )

where ej is the expenditure per worker and cj , hj are the consumption per worker of the traded and non-traded
good in the market allocation. If U is homogeneous of degree one, then ωj = PjU , where PjU is the price index
associated with U (cj , hj ) at the market equilibrium prices pD    H
                                                               j , pj . In the opposite direction, given arbitrary weights
ωj , the market allocation implements the planner’s under the transfers tj = PjD cj + PjH hj − Wj constructed using
                                                                                
the quantities {cj , hj } from the planner’s allocation and the multipliers PjD , PjH and Wj corresponding to the
constraints (i) and (iv) of the planner’s problem, respectively.
     For the case with labor mobility, note that, for populated locations, the planner’s first-order condition with
respect to Lj implies:
                                              PjD cj + PjH hj = Wj − W L .

Therefore, the market allocation and the planner’s solution coincide if and only if in the market allocation expenditure


                                                              52
per worker in location j takes the form ej = wj + Constant for all j. The only transfer scheme delivering the same
                                 Π
transfer per capita is tj =      L
                                   .
     Equivalence of Least Cost Routes. We want to establish that any route used in the planner’s problem is a
solution to (i)(c) in Definition 3 under the proposed tax scheme. Fix good n. We introduce the following notation:
for a given route r = (j0 , . . . , jρ ) ∈ Rod , we denote by frn the matrix of flows
                                                 
                                                 1 if ∃l, 0 6 l 6 ρ − 1 and j = jl , k = jl+1
                                    frn (j, k) =                                               .
                                                 0 otherwise

                                                               
Consider an optimal route from o to d, r ∗ = j0∗ , . . . , jρ∗∗ ∈ Rod , i.e., such that Qn
                                                                                         j∗ j∗                                                   > 0 at the optimum of the
                                                                                                                                   k k+1

planner’s problem    (ζjQ∗ j ∗    = 0). We now consider redirecting a marginal amount of goods ε > 0 from r ∗ to some
                         k k+1                                               
other route r = (j0 , . . . , jρ ) ∈ Rod . In other words, denoting Qn = Qnjk j∈J ,k∈N (j) , we consider the perturbation
Qn + εfrn − εfrn∗ . The first-order effect of the deviation around the optimum must reduce the Lagrangian:

                                                        L (Qn + εfrn − εfrn∗ ) − L (Qn ) ≤ 0.

To translate this condition into a minimum cost route problem, we decompose the first-order impact on the Lagrangian
as follows
                          L (Qn + εfrn − εfrn∗ ) − L (Qn ) = ∇Q L (Qn ) · (frn − frn∗ ) ε + o (ε) ,

and we now evaluate each term separately. The first deviation term,
                                           ρ−1                                                                                              
                                                                                                                                  n ∂τjl jl+1
                         n
                                           X
                ∇Q L (Q ) ·      frn   =             −Pjnl    +   Pjnl+1   +   ζjQl jl+1 n   −   χPjDl     n n
                                                                                                          m τjl jl+1 + Qjl jl+1 m
                                                                                                                                   ∂Qjl jl+1
                                           l=0
                                                                                                          !#
                                                                                             ∂τjnl jl+1
                                       − (1 − χ) Pjnl             τjl jl+1 + Qn
                                                                              jl jl+1                            ,
                                                                                             ∂Qn
                                                                                               jl jl+1


simplifies to
                                               "                    ρ−1                      ρ−1 
                                                                    X                        X                                                              
                             n
                 ∇Q L (Q ) ·       frn     = Pdn − Pon +                   ζjQl jl+1 n −              χPjDl mn τjl jl+1 + (1 − χ) Pjnl τjnl jl+1
                                                                     l=0                     l=0
                                               ρ−1
                                                                                                                                                   !#
                                               X                                  ∂τjl jl+1                         ∂τjnl jl+1
                                           −           χPjDl Qjl jl+1 mn                    + (1 − χ) Pjnl Qn
                                                                                                            jl jl+1                                     .
                                               l=0
                                                                                  ∂Qjl jl+1                         ∂Qnjl jl+1


Using the definition of the optimal tax, we have that
                                                                                                    n
                                                                               ∂τjk               ∂τjk
                                                      tn
                                                       jk = χQjk m
                                                                   n
                                                                                    + (1 − χ) Qn
                                                                                               jk      .
                                                                               ∂Qjk               ∂Qn
                                                                                                    jk


Substituting into the previous deviation term, we obtain
                                                          "                     ρ−1 
                                                                                X                                                                  
                                         n
                        ∇Q L (Q ) ·             frn   = Pdn − Pon −                     χPjDl mn τjl jl+1 + (1 − χ) Pjnl τjnl jl+1
                                                                                 l=0
                                                          ρ−1                                                       ρ−1
                                                                                                                                         #
                                                          X                                                         X
                                                      −            χPjDl   + (1 −      χ) Pjnl        tn
                                                                                                       jl jl+1   +         ζjQl jl+1 n       .
                                                          l=0                                                        l=0


By assumption, the total deviation Qn +εfrn −εfrn∗ has a negative impact on the Lagrangian for the feasible deviation




                                                                                       53
ε > 0, so that ∇Q L (Qn ) · (frn − frn∗ ) ≤ 0. Using that ζjQ∗ j ∗                           n   = 0 , we get:
                                                                                   l   l+1


                    ρ∗ −1                                                                 ρ∗ −1                          
                    X                                                                        X
          Pon   +             χPjDl∗ mn τjl∗ jl+1
                                              ∗     + (1 −   χ) Pjnl∗ τjnl∗ jl+1
                                                                             ∗         +              χPjDl∗ + (1 − χ) Pjnl∗ tn
                                                                                                                              jl∗ jl+1
                                                                                                                                   ∗

                    l=0                                                                      l=0
                       ρ−1                                                                 ρ−1                                    ρ−1
                       X                                                                     X                                        X
           ≤ Pon +              χPjDl mn τjl jl+1 + (1 − χ) Pjnl τjnl jl+1 +                          χPjDl + (1 − χ) Pjnl tn
                                                                                                                            jl jl+1 −     ζjQl jl+1 n
                       l=0                                                                      l=0                                      l=0
                       ρ−1                                                                 ρ−1                          
                       X                                                                     X
           ≤ Pon +              χPjDl mn τjl jl+1 + (1 − χ) Pjnl τjnl jl+1 +                          χPjDl + (1 − χ) Pjnl tn
                                                                                                                            jl jl+1 .
                       l=0                                                                      l=0


Hence, the optimal route r ∗ is solution to the least-cost route problem
                                          ρ−1                                                 Xρ−1                      
                                          X
                    min           Pon +             χPjDl mn τjl jl+1 + (1 − χ) Pjnl τjnl jl+1 +       χPjDl + (1 − χ) Pjnl tn
                                                                                                                             jl jl+1 ,
           r=(j0 ,...,jρ )∈Rod
                                          l=0                                                                   l=0


where we recognize condition (i)(c) of Definition 3.
   Finally, that the minimum cost route problem in the case of own-good congestion (χ = 0) is equivalent to
                                                           ρ−1                  ρ−1                ρ−1               
                                                           Y                       X n n             Y
                                      min            Pon           1 + τjnl jl+1 +    Pjl+1 tjl jl+1       1 + τjnk jk+1 ,
                               r=(j0 ,...,jρ )∈Rod
                                                           l=0                             l=0                   k=l

                                 
since Pjnl+1 = 1 + τjnl jl+1 Pjnl + Pjnl+1 tn
                                            jl jl+1 along any used path.




Proposition 5. If the global convexity condition of Proposition 1 is satisfied and the toll is consistent with the
                         n
optimal Pigouvian tax ( θjk = χPjD mn ετQ,jkn τjk + (1 − χ) Pjn ετQ,jkn τjk
                                                                         n
                                                                            ) then the decentralized infrastructure choice
implements the optimal network investment.

Proof. To ease notation we focus on the case with own-good congestion (χ = 0), but the case with cross-goods
congestion (χ = 1) can be derived following similar steps. Consider the problem of a regulated monopoly on link jk
                                   n
allowed to charge a per-unit toll θjk on good n. The monopolist can purchase asphalt at price pK . We assume that
the government forbids entry on unused links or sets a price too low for entry, allowing us to focus on links used at
                                                 
the social optimum Qn jk > 0 for some n, Ijk > 0 . Free-entry of shipping companies on link jk yields

                                                                                           
                                              pn    n      n   n     n
                                               k ≤ pj 1 + τjk Qjk , Ijk
                                                                                                   n
                                                                                                + θjk , = if Qn
                                                                                                              jk > 0.

                           n
Under the assumption that τjk  is strictly increasing in Qn
                                                          jk , the demand for transport at any level of infrastructure
Ijk given prices is                                 n                    
                                                    pk − pn
                                                          j − θjk
                                                                 n
                        Qnjk  (I jk ; p) = inv τ
                                              Q jk                 , I jk   for pn    n    n
                                                                                 k ≥ pj + θjk ,                  (A.6)
                                                         pn
                                                          j

where invQ τ (Q, I) denotes the inverse of function τ with respect to Q.The monopoly solves the profit maximization
problem
                                                                    X     n
                                                           max           θjk Qn               I
                                                                              jk (Ijk ) − pK δjk Ijk
                                                            Ijk
                                                                     n


subject to (A.6). It can be shown that convexity of τ (Q, I) in Q and I is sufficient for the problem to be concave.
The first-order condition over infrastructure is
                                 X ∂              n
                                                   pk − pn    n
                                                         j − θjk
                                                                        
                                                                            n        I
                                           invQ τ         n
                                                                 , I jk    θjk = pK δjk .
                                  n
                                     ∂I jk              p j

                                                                                   h         pn −pn −θn    i
                                                                           ∂                                       ∂τ     ∂τ
From the implicit function theorem, we have that                          ∂Ijk
                                                                                    invQ τjk k pjn jk , Ijk    = − ∂Ijk / ∂Qjk
                                                                                                                             n .In turn, imple-
                                                                                                            j                       jk     jk




                                                                                   54
menting the efficient flows Qn                     n
                             jk requires the toll θjk corresponding to the Pigouvian congestion tax from Proposition
4, that is
                                                                                   n
                                  n                                       n n ∂τjk
                                 θjk = pn  n      n τ          n
                                        j tjk = pj εQ,jkn τjk Qjk , Ijk = pj Qjk      .
                                                                                 ∂Qn
                                                                                   jk

Combining the last two expressions, the monopolist’s first-order condition thus becomes the same as (13), except for
the price of asphalt pK . Imposing market clearing in K, the set of conditions in the decentralized allocation coincide
with the planner, implying that pK equals the Lagrange multiplier PK and other prices equal their corresponding
multipliers, pn     n       D       D
              j = Pj and pj = Pj . Moreover, under the global convexity condition from Proposition 1, first-order
conditions of the builders are sufficient, which demonstrates the result.




B      Appendix to Section 4 (Calibration and Counterfactuals)
Construction of P (j, k) The definition of the weights ωjk (s) assigned to the construction of Ijk
                                                                                                obs
                                                                                                    involves
the cheapest path P (j, k) for all j ∈ J and k ∈ N (j) in every country. To find P (j, k), we first convert the shapefile
with all the road segments from EuroGeographics into a weighted graph, where each edge corresponds to a segment
s on the road network. We define P (j, k) as the shortest path between j and k under the segment-specific weights
                −χ                    1−paveds
lengths ∗ laness lane ∗ χ1−nat
                          use
                                s
                                  ∗ χpaved     ∗ χ1−median
                                                  median
                                                          s
                                                            , where lengths is the length of the segment, laness is the
number of lanes, nats equals 1 if the segment belongs to a national road, paveds equals 1 if the segment is paved,
and medians equals 1 if the segment has a median. When information on number of lanes is missing we assign a
number of lanes equal to the minimum of 1 observed in the data. When the information is missing we define the
road use as non-national. We parametrize χlane , χuse , χpaved , and χmedian based on the extent by which adding a
lane, using a national road, using paved road, or using a road with a median reduces road user costs. Table 4 of
Combes and Lafourcade (2005) reports that, in France, the reference cost per km. in a national road with at least 4
lanes is 25% higher than in other national roads. In our road network data for France, the average number of lanes
in national roads with at least 4 lanes is 4.43, and the average number of lanes in national roads with less than 4
lanes is 1.9. From this, we infer that adding 2.5 lanes on top of 2 lanes, a 125% increase in the number of lanes,
                                                                                                           25%
reduces costs by 25%, implying an elasticity of user costs with respect to number of lanes of χlane = 125%      = 0.2 in
absolute value. In addition, Table 4 in Combes and Lafourcade (2005) reports that the total reference cost is about
7% higher on “secondary roads” relative to “other national roads”, from which we infer χuse = 1.07. According to
Figueroa et al. (2013), road user costs are 35% higher on gravel relative to paved roads, implying χpaved = 1.35, and
according to Tay and Churchill (2007), adding a median increases speed by 5%, implying χmedian = 1.05.


Calibration of β and γ To parametrize β and γ we assume that: i) trade costs are a linear function of
                            distjk
shipping time, τjk = aτjk    Sjk
                                     ; ii) shipping shipping speed is a log-linear function of the number of vehicles and road
lane kilometers,
                                                                        −β
                                                        Sjk = aS   γ
                                                               jk Ijk Vjk ;                                             (A.7)

and iii) the number of vehicles is a linear function of the quantity of goods that is shipped, Vjk = aD   jk Qjk . These
assumptions are consistent with the functional form 10 for τjk (Q, I). To recover the parameters γ and β, one would
ideally like to estimate the relationship between speed, roads, and vehicles in (A.7) across links. This relationship
is estimated by Couture et al. (2018) across cities. Equation (2) in their paper assumes a log-linear relationship
between speed, roads, and vehicle travel time, defined as vehicle-kilometers (i.e., vehicles times distance) over speed.
To measure roads they use the log of lane-kilometers of interstate highways in the U.S., which corresponds to our
measure of Ijk . Assuming that their estimates would hold at the level of a connection between populated areas in




                                                                55
our data, equation (2) of their paper can be written, in our notation:47
                                                                             
                                                                 Vjk ∗ distjk
                                ln Sjk = αCDT ln Ijk − θCDT ln                  + εjk ,                                                            (A.8)
                                                                     Sjk

where we use αCDT and θCDT to refer to α and β in their paper. These parameters translate to ours as follows:
           γ                 β
αCDT ≡ 1+β    and θCDT ≡ 1+β   . When αCDT < θCDT there are decreasing returns to scale in the provision of vehicle
kilometers traveled. Couture et al. (2018) find decreasing returns to scale (αCDT < θCDT →γ < β) across all their
specification (Tables 5 and 6 of their paper) using a variety of OLS and IV approaches. Their preferred estimate
(column 6 of table 5) yields αCDT = 0.09 and θCDT = 0.13, implying γ = 0.10 and β = 0.13.


Construction of Ruggedness Measure We use elevation data from the ETOPO1 Global Relief Model.
The ETOPO1 dataset corresponds to a 1 arc-minute degree grid. We construct ruggedness for each cell as the
average ruggedness across the 900 arc-minute cells from the ETOPO1 dataset contained in each 0.5 arc-degree cell
in our discretized maps. We use the standard ruggedness index by Riley et al. (1999). Letting J etopo (j) be the set
of cells in ETOPO1 contained in each cell j ∈ J of our discretization and N etopo (i) be the 8 neighboring cells to
                                                           P                P                                 1/2
                                                                                                             2
each cell in ETOPO1, this index is defined as: ruggedj =       i∈J etopo (j)   k∈N etopo (i) (elevi − elevk )       ; i.e., it is
the standard deviation of the difference in elevation across neighboring cells. Then, we define ruggedjk in (21) as
ruggedjk = 21 (ruggedj + ruggedk ).

                                              5<%.7:'R17='-"%M10V                                               UE4<0"%EN7%E1#
                                                                                                                                 56"07$"';#2074%0.<%.0"'
        91.#%0P     91=" !"#$%&'()*+,    -.*/"0'12'3"$*"#%4     56"07$"'!7#"4'8"0')*+     -.*/"0'12'9"::4    !"#$%&'()*+,
                                                                                                                                         ;#=">
                              (?,               (@,                      (A,                    (B,              (C,                       (D,
 5.4%0E7            5F          ?G@@H                   D?CD                       @+AD                 BD           HGGG                            ?+CA
 I":$E.*            IJ          ?HDKA                  ?LBG@                       @+BH                 @?           ACAC                            @+?@
 3ME%N"0:7#=        9O!;        ?BBC?                  ??LBA                       @+@D                 @B           CALG                            ?+G?
 9P80.4             9Q            @K?K                   HBG                       @+@H                 @L           @LGG                            L+DH
 9N"<&'R"8./:E<     9S          @KDC?                  ?L?KA                       @+@L                 BK          ?LCHA                            ?+L?
 T"0*7#P            UJ         ??C?GA                  DDB@A                       @+B@                 CB          @G@@G                            @+D?
 U"#*70V            U)          ?CACK                   D@HG                       @+@L                 AL           CB?K                            L+HH
 387E#              J3         ?L?HHL                  ?KLBK                       @+AH                 D?          ALDKD                            ?+KL
 WE#:7#=            W;          GLAHB                   H@@?                       @+LB                 GL          ABLCG                            L+@K
 W07#<"             WR         ?@KGKG                  AKDDK                       @+LC                 GB          AKGCB                            @+?@
 T"10$E7            TJ          @KDK@                   HLLH                       ?+HC                 AH           KB@L                            L+AB
 O.#$70P            OX          A@G@K                   H@AC                       @+?L                 CL          ??CG@                            L+HC
 ;0":7#=            ;J          @BHC@                   B?BB                       @+?L                 BG          ?LDG?                            L+DA
 ;%7:P              ;F          GGCKD                  BB?CC                       @+A@                 AD          ?BGB@                            @+?K
 !E%&.7#E7          !F          ?LDK@                   ?CKD                       @+AH                 BA           HBLK                            L+CH
 !.>"*/1.0$         !X            ?GGK                   KDA                       @+A?                  K            CGB                            L+GA
 !7%6E7             !Y          ??BHC                   @?L@                       @+LA                 BG           HKCG                            L+AA
 Z1:=167            ZU            KC@G                  ?BCG                       @+@?                 @L           BACH                            L+AK
 Z7<"=1#E7          Z)            CCGK                   HLK                       @+?C                 ?A           @@LC                            L+@G
 -10%&"0#';0":7#=   -U            GLKG                  ?KKK                       @+?K                 ?@           ?GKL                            L+DG
 -"%&"0:7#=4        -!          ?BAA?                   KAKA                       @+DK                 @L           AKKB                            @+CC
 [10%.$7:           [F          ?CLAB                   BHAA                       @+?L                 BA          ????D                            ?+BH
 3:16"#E7           3;            GKL?                  @BB?                       @+?H                 ?@           ?C@C                            ?+@C
 3:167VE7           3)          ??BLD                   @DL?                       @+?K                 AL           CKKL                            ?+LB


           Table A.1: Summary Statistics of Actual and Discretized Road Network by Country
Note: Columns (1) to (3) report statistics from EuroGlobalMap, and Columns (4) to (6) report statistics from the
discretization of road networks described in Section 5.1.




   47
     In their notation, vehicle travel time (number of vehicles times time of travel) is V T Ti = V KT
                                                                                                    Si
                                                                                                       i
                                                                                                         where V KT is
vehicle kilometers (number of vehicles times distance) and Si is speed (distance over time of travel). In our notation,
therefore, V KTi = Vjk × distjk .


                                                                      56
                          Figure A.1: Calibration of Population and Income Shares, All Locations and Countries

                                         (a) Population Shares in Model and Data                                                                          (b) Income Shares in Model and Data




                                                                                                                                  .5
                        .4




                                                                                                                                           .4
                                                                                                                       Income Shares (Model)
              Labor Shares (Model)
                              .3




                                                                                                                                    .3
                      .2




                                                                                                                             .2
             .1




                                                                                                                      .1
                        0




                                                                                                                                  0
                                     0                     .1                  .2                      .3        .4                             0                    .1                .2              .3                              .4
                                                                        Labor Shares (Data)                                                                                       Income Shares (Data)

                                                                                  Mobile Labor                                                                                     Mobile Labor           Fixed Labor
                                                                                  45 Degree                                                                                        45 Degree
                                     Linear regression slope (robust SE): Mobile Labor: 1.019 (.004)                                            Linear regression slope (robust SE): Mobile Labor: 1.023 (.019); Fixed Labor: .998 (.004)




        (c) Fundamentals and Income Shares, Mobile Labor                                                              (d) Fundamentals and Population Shares, Mobile Labor
        2




                                                                                                                                  2
              0




                                                                                                                                   0
 Fundamentals




                                                                                                                      Fundamentals
      -2




                                                                                                                           -2
        -4




                                                                                                                                  -4
        -6




                                                                                                                                  -6




                                     -10              -8               -6          -4                       -2   0                                  -10               -8             -6            -4                       -2              0
                                                                Log Income Shares (Data)                                                                                      Log Population Shares (Data)

                                              Log Productivity (z)           Log Non-Traded Endowment                                                         Log Productivity (z)            Log Non-Traded Endowment
                       Linear regression slope (robust SE): Productivity: .05 (.01); Endowment: .79 (.014)                                      Linear regression slope (robust SE): Productivity: .017 (.01); Endowment: .857 (.01)




Notes: All the figures pool the 868 cells across the 24 countries in the convex case of the parameters for the calibration
with 10 differentiated goods. Similar relationships hold for the non-convex case. In the Panels (c) to (e), log-
productivity and log-endowment of the non-traded good per capita are demeaned within each country.




                                                                                                                 57
                                         S(%W/(%R?"                                      /(%R?"
             P//
                        !"#$%&'(%)*+!,- !"#$%&'(%)*.,/- 0'&$11(2$3'(% !"#$%&'(%)*+!,- !"#$%&'(%)*.,/- 0'&$11(2$3'(%
     45&36'$                       789:            ;8<:          78<:            ;87:            <8=:          ;87:
     >?1@'5A                       ;8<:            <89:          <8B:            <8C:            <8=:          <8D:
     /E#65&                        ;89:            <8C:          ;8=:            ;8<:            <8=:          ;8<:
     /F?2G)H?#5I1'2                ;8D:            <8D:          ;8=:            ;8;:            <8=:          ;8;:
     J?%A$6K                       B87:            ;8;:          L8B:            989:            <89:          989:
     .'%1$%M                       D8=:            ;8;:          98L:            =8C:            <89:          =87:
     .6$%2?                        98<:            ;8<:          789:            =8L:            <89:          =8D:
     +?(6@'$                       789:            ;89:          78;:            =8=:            <87:          =8=:
     +?6A$%E                       =8C:            <8N:          =8=:            ;8N:            <87:          ;8L:
     O5%@$6E                       78<:            <8L:          =8L:            ;8L:            <8=:          ;8L:
     P6?1$%M                       =8L:            ;8=:          =87:            ;8B:            <87:          ;8L:
     P3$1E                         =8D:            ;8D:          ;8N:            ;8C:            <89:          ;87:
     Q$3R'$                        78N:            ;8<:          78D:            =8D:            <87:          =8L:
58




     Q'3G5$%'$                     789:            ;8<:          78<:            =89:            <87:          =87:
     Q5"?AI(56@                    <8=:            <8=:          <8;:            <8=:            <8;:          <8;:
     0$2?M(%'$                     ;8<:            <8D:          <8N:            <8D:            <8;:          <8D:
     0(1M(R$                       ;8B:            <8D:          ;8C:            ;8<:            <8=:          <8N:
     S?3G?61$%M&                   ;8C:            <8D:          ;89:            ;8=:            <8=:          ;8;:
     S(63G?6%)P6?1$%M              ;8=:            <8D:          ;8<:            <8N:            <8;:          <8B:
     T(635@$1                      =8C:            <8N:          =8;:            ;89:            <87:          ;8=:
     U1(R$K'$                      =8L:            ;8=:          =87:            ;8N:            <87:          =8<:
     U1(R?%'$                      ;8B:            <8C:          ;8C:            ;89:            <8=:          ;89:
     U#$'%                         D8C:            ;8L:          98L:            78L:            <8D:          78D:
     UV'3F?61$%M                   ;8L:            <8D:          ;89:            ;8<:            <8=:          ;8<:
     4R?6$@?                       =8B:            <8N:          =89:            ;8L:            <87:          ;8C:

     Table A.2: Welfare Gains From Optimal Reallocation or Expansion of Current Networks, Fixed Labor
                                         S(%W/(%R?"                                      /(%R?"
             P//
                        !"#$%&'(%)*+!,- !"#$%&'(%)*.,/- 0'&$11(2$3'(% !"#$%&'(%)*+!,- !"#$%&'(%)*.,/- 0'&$11(2$3'(%
     45&36'$                       789:            ;8;:          <8=:            <8;:            987:          <8;:
     >?1@'5A                       98B:            987:          98C:            98=:            98;:          98D:
     /E#65&                        ;8F:            98D:          ;8<:            98G:            98<:          98G:
     /H?2I)J?#5K1'2                ;8D:            98C:          ;8<:            98G:            98<:          98G:
     L?%A$6M                       C89:            ;89:          =8=:            78C:            987:          78C:
     .'%1$%N                       F89:            <89:          78F:            <8D:            98F:          <8<:
     .6$%2?                        78F:            ;8C:          <8=:            789:            98D:          <8B:
     +?(6@'$                       78;:            ;8=:          <8=:            <8;:            987:          <8<:
     +?6A$%E                       <8D:            98G:          <8;:            ;8C:            98F:          ;8D:
     O5%@$6E                       <8<:            98C:          ;8G:            ;8=:            98<:          ;8=:
     P6?1$%N                       ;8=:            ;8G:          ;89:            ;8F:            98<:          ;87:
     P3$1E                         ;8F:            98=:          98G:            ;87:            98=:          ;89:
     Q$3R'$                        78=:            ;87:          78<:            <87:            987:          <8F:
59




     Q'3I5$%'$                     789:            ;8C:          <8D:            <87:            987:          <87:
     Q5"?AK(56@                    98<:            98<:          98;:            98<:            98;:          98;:
     0$2?N(%'$                     98D:            987:          98F:            98F:            98;:          98F:
     0(1N(R$                       ;8B:            98C:          ;8=:            ;89:            98<:          98G:
     S?3I?61$%N&                   ;8D:            98=:          ;87:            ;8;:            98<:          ;8;:
     S(63I?6%)P6?1$%N              987:            98=:          98F:            98D:            98;:          98D:
     T(635@$1                      <8<:            98G:          ;8B:            ;8<:            987:          ;8;:
     U1(R$M'$                      ;87:            ;8F:          98C:            ;8D:            987:          ;8D:
     U1(R?%'$                      ;8C:            98B:          ;8D:            ;87:            98;:          ;8F:
     U#$'%                         F8F:            <8D:          78G:            78=:            98D:          78F:
     UV'3H?61$%N                   ;8C:            98D:          ;8D:            ;89:            98<:          98G:
     4R?6$@?                       <8<:            ;89:          ;8G:            ;8=:            987:          ;8D:

     Table A.3: Welfare Gains From Optimal Reallocation or Expansion of Current Networks, Mobile Labor
Table A.4: Optimal Infrastructure Investment, Population Growth and Local Characteristics for
Different Number of Sectors

    Number Sectors                             N=5                               N=10                           N=15
    Dependent variable:           Investment     Pop. Growth         Investment    Pop. Growth     Investment      Pop. Growth
                                      (1)              (2)              (3)              (4)             (5)            (6)
    Population                     0.112***          -0.001**         0.136***       -0.001**       0.131***           -0.001
    Tradeable Income per Capita    0.178***          0.022***         0.164***      0.020***        0.186***        0.030***
    Infrastructure                 -0.211***         -0.001**        -0.242***       -0.001**       -0.245***          -0.001
    Consumption per Capita                        -0.064***                         -0.062***                       -0.078***
    Infrastructure Growth                             -0.000                            0.000                          0.001
    Differentiated Producer                          0.001***                       0.001***                        0.009***


    R2                               0.36              0.49             0.27            0.50             0.35          0.51

Each column corresponds to a different regression pooling all 868 locations in the optimal expansion counterfactual
across the 24 countries assuming γ = β, mobile labor, and δ = δ I,GEO . All regressions include country fixed effects.
Standard errors are clustered at the country level. ***=1% significance, **=5%, *=10%. Dependent variables:
population growth is defined as ∆ ln Lj , where ∆x denotes the difference between variable x in the counterfactual
                                                                                                                       
and in the calibrated allocation. Investment growth is defined as the difference over the average, ∆Ij / 21 (Ij + ∆Ij ) ,
                                                             P
where total infrastructure at the node level defined as Ij = k∈N (j) Ijk . Independent variables correspond to the log
of the level of each variable in the calibrated model. Population and income per capita are the two outcomes matched
by the calibration. Consumption per capita corresponds to traded goods, cj in the calibrated model. Differentiated
producer is a dummy for whether the location is a producer of differentiated goods in the calibration.




 Table A.5: Average Welfare Gains for Different Number and Allocation of Differentiated Goods

         Allocation of goods                    Benchmark                                       Within NUTS
          Number of Sectors             N=10                     N=15                    N=10                   N=15
         Labor:                    Fixed       Mobile        Fixed     Mobile      Fixed        Mobile     Fixed    Mobile
         Optimal Reallocation
                 δ = δ I,GEO       1.6%        1.5%           1.5%      1.5%       1.5%         2.2%       1.3%        2.0%
         Optimal Expansion
                 δ = δ I,GEO       1.7%        1.6%           1.6%      1.6%       1.6%         2.3%       1.4%        2.1%
                       I,F OC
                 δ=δ               0.3%        0.3%           0.3%      0.3%       0.2%         0.4%       0.2%        0.4%
Each element of the table shows the average welfare gain in the corresponding counterfactual across the 24 countries
for the convex case.




                                                                60
           Table A.6: Average Welfare Gains with and without Congestion across Goods

                             Congestion           Across Goods        Own Good (Iceberg)
                        Labor:                    Fixed    Mobile     Fixed      Mobile
                        Optimal Reallocation
                               δ = δ I,GEO        1.6%         1.5%   1.5%        1.9%
                        Optimal Expansion
                               δ = δ I,GEO        1.7%         1.6%   1.6%        2.0%
                               δ = δ I,F OC       0.3%         0.3%   0.2%        0.3%
Each element of the table shows the average welfare gain in the corresponding counterfactual across the 24 countries
for the convex case with N=10 goods.




                                                          61
                        Figure A.2: Discretization of the European Road Network

            (a) Population on the Discretized Map                (b) Nodes and Edges in the Baseline Graph




            (c) Nodes in the Actual Road Network               (d) Actual Road Network on the Baseline Graph




Notes: Panel (a) shows total population from GPW aggregated into 1 arc-degree (approximately 100 km) cells. Panel
(b) shows the nodes J corresponding to the population centroids of each cell in Panel (a), reallocated to their closest
point on the actual road network, and the edges E corresponding to all the vertical and diagonal links between
cells. Panel (c) shows the centroids and the actual road network. Green segments correspond to national roads, red
segments are all other roads, and the width of each segment is proportional to the number of lanes. Panel (d) shows
the same centroids and the edges as the baseline graph in Panel (b), where each edge is weighted proportionally to
the average number lanes on the cheapest path between each pair of nodes on the road network. The color shade
ranges from red to green according to the fraction of the shortest path traveled on a national road.




                                                          62
Supplementary Material
(For authors’ websites)




          63
C     Appendix to Section 4 (Illustrative Examples)

                               Figure A.3: A Simple Underlying Geography

                                                   (a) Population




                                                  (b) Productivity




Notes: On panel (a), each circle represents a location. The links represent the underlying network, i.e., links upon
which the transport network may be built. Population and housing are uniform across space, normalized to 1. On
panel (b), the size of the circles represent the productivity of each location.




                                                        64
                       Figure A.4: The Optimal Network for K = 1 and K = 100

                                                  (a) K=1




                                                 (b) K=100




Notes: On each panel, the thickness and color of the segments reflects the level of infrastructure built on a given
link. Thicker and darker colors represent more infrastructure. On the bottom panels, the heat map represents the
level of prices and consumption, normalized to 1 at the center. Lighter color represents higher values for prices and
consumption. Prices and consumption levels are linearly interpolated across space to obtain smooth contour plots.
                                                         65
                      Figure A.5: Optimal Network with Randomly Located Cities

                                        (a) Convex Case: γ = β = 1




                                    (b) Non-Convex Case: γ = 2 > β = 1




            (c) Optimal Network Before and After Annealing Refinement in Non-Convex Case




Notes: On each panel, the thickness and color of the segments reflects the level of infrastructure built or the shipment
sent on a given link. Thicker and darker colors represent higher infrastructure or quantity.


                                                          66
    Figure A.6: Optimal Network with 10+1 Goods, Convex Case (β = γ = 1), Labor Mobility




Notes: On panel (a), the thickness and color of the segments reflects the level of infrastructure built on a given link,
and the size of each circle is the population share. On the other panels, the segments represent the quantity shipped
through each link and the circles represent the location of producers.


                                                          67
Figure A.7: Optimal Network with 10+1 Goods, Nonconvex Case (β = 1,γ = 2), Labor Mobility




Notes: On panel (a), the thickness and color of the segments reflects the level of infrastructure built on a given link,
and the size of each circle is the population share. On the other panels, the segments represent the quantity shipped
through each link and the circles represent the location of producers. This figure represents a local optimum.


                                                          68
           Figure A.8: The Optimal Transport Network under Alternative Building Costs

               (a) Baseline Geography                                          (b) Adding a Mountain




(c) Adding a River and a Bottleneck Access by Land                      (d) Allowing for Endogenous Bridges




          (e) Allowing for Water Transport                      (f) Non-Convex Case (γ = 2; β = 1) with Annealing




Notes: The thickness and color of the segments reflects the level of infrastructure built on a given link. Thicker and
darker colors represent more infrastructure and quantities. The circles represent the 20 cities randomly allocated
across spaces. The larger red circle represents the city with the highest productivity. The different panels vary in
the parametrization of the cost of building infrastructure. In panel (a), it is only a function of Euclidean distance.
In panel (b), we add a mountain and assume that the cost also depend on difference in elevation. In panel (c), we
add a river with a natural land crossing and assume that the cost of building along or across the river is infinite. In
panel (d) there is no natural land crossing but allow for construction of bridges. In panel (e) we additionally allow
for investment in water transport. Panel (d) makes the assumptions as Panel (e) but assumes increasing returns to
network building.

                                                          69
D       Numerical Implementation
   In this section, we provide a more detailed explanation of the numerical algorithms we use to solve the model. A
Matlab toolbox implementing our model with detailed documentation and a few examples is available on the authors’
websites.48


D.1      Resolution method
Convex case and duality approach
     As explained in section 3.6, our preferred approach to solve the model relies on solving the dual Lagrangian
problem of the planner. We provide, here, a simple example of how to solve the joint optimal allocation and
transport problem taking the infrastructure network {Ijk } as given. This example can easily be generalized to the
full problem, including the network design problem, in the convex case, but is also part of our resolution method for
the nonconvex case. We focus on the case studied in the quantitative part of the paper, in which: i) we use the log-
                                                        β −γ                                                             −γ
                                          n
linear specification of transport costs, τjk    τ
                                             = δjk Qnjk   Ijk (own-good congestion, χ = 0) or τjk   n
                                                                                                       = mn δjkτ
                                                                                                                 (Qjk )β Ijk
             PN                                                                                                          
                                                                                                                         n a
with Qjk = n=1 mn Qn      jk (cross-good congestion, χ = 1); ii) labor is the sole production factor, Fj
                                                                                                         n
                                                                                                            Ln     n
                                                                                                             j = zj Lj       ;
           T
and iii) C is a CES aggregator with elasticity of substitution σ. We consider the case with immobile labor.         49

     We write the Lagrangian of the problem
                                                                               !1+β                         ! σ 
                                                                     N
              X                        X D               X τ X             n  n        −γ
                                                                                              X       n
                                                                                                         σ−1 σ−1
        L =       ωj Lj U (cj , hj ) −  Pj cj Lj + χ         δjk       m Qjk         Ijk −        Dj σ            
               j                                 j                            k∈N (j)                   n=1                                         n
                                                                                         
               XX                        X  n                 n 1+β −γ
                                                                         
                                                                               n a
                                                                                    X
           −            Pjn     Djn   +                   τ
                                            Qjk + (1 − χ) δjk Qjk           n
                                                                     Ijk − zj Lj −     n
                                                                                      Qij
               j   n                    k∈N (j)                                                                                               i∈N (j)
                        "                    #
               X            X                          X                      X                             X                  X
           −       Wj            Ln
                                  j − Lj +
                                                               Q
                                                              ζjkn Qn
                                                                    jk +
                                                                                        L
                                                                                       ζjn Ln
                                                                                            j +
                                                                                                                   C
                                                                                                                  ζjn Djn +            ζjc cj .
               j            n                         j,k,n                    j,n                          j,n                    j


Recall that the dual problem consists of solving

                                                                            inf sup L (x, λ) .
                                                                            λ≥0    x

                                                                              
We start by expressing our control variables x = cj , Djn , Qn              n
                                                                      jk , Lj   as functions of the Lagrange multipliers λ =
                                      
   D    n         Q      L     C     c
  Pj , Pj , Wj , ζjkn , ζjn , ζjn , ζj . Using the optimality conditions, one obtains the following expressions:
                                                                                                                 !    1       
                                                                                   X                   1−σ          1−σ
                                                                                                    ′
                                                      cj = Uc−1 ωj−1                        Pjn                            , hj 
                                                                                       n′

                                                                       −σ                                                                                
                                                                                                                             N
                                                                                                                                                  !1+β
                                                     Pjn                                                    X                X                            −γ 
                    Djn =                                                                                            τ
                                                                                                                                   mn Qn
                                                                            cj Lj + χ
                                                                  1                                                 δjk              jk                Ijk
                             P                   
                                                ′ 1−σ             1−σ
                                        n′   Pjn                                                        k∈N (j)              n=1

                                                                                                    1
                                                                                   Pjn zjn          1−a
                                                                  Ln
                                                                   j    = P                                 1    Lj .
                                                                                            ′       ′
                                                                                  n′    Pjn zjn             1−a




   48
      Latest         version         available       at         https://sites.google.com/site/edouardschaal/
OptimalTransportNetworkToolbox.zip.
   49
      In the mobile labor case, we can only show that the planner’s problem is a quasiconvex optimization problem.
Hence, a duality gap may exist. We therefore adopt a (slower) primal approach in that case.


                                                                                        70
In the case of own-good congestion (χ = 0), the flows can be easily inverted,
                                                      "          γ                      # β1
                                                            1 Ijk              Pkn
                                            Qn
                                             jk   =              τ
                                                                    max            − 1, 0      ,
                                                          1 + β δjk            Pjn
                                                                                                                 PN
but in the case of cross-good congestion, one first needs to invert the aggregate flows Qjk =                      n=1    mn Qn
                                                                                                                              jk , which is
sufficient to evaluate the Lagrangian at any point,50
                                                                                            !1
                                                                       Pkn − Pjn              β

                                            Qjk = max                            τ −γ
                                                                                                  .
                                                          n      (1 + β) PjD mn δjk Ijk

As these expressions illustrate, we have been able to eliminate a large number of the multipliers directly, so that
                                                     
the only remaining Lagrange multipliers are λ = Pjn j,n . We may now compute the inner part of the saddle-point
problem:51
                                                                                                            
                  X                              X                               X                    −γ 
L (x (λ) , λ) =       ωj Lj U (cj (λ) , hj ) −       PjD cj (λ) Lj + χ                   τ
                                                                                         δjk Q1+β
                                                                                              jk (λ) Ijk
                  j                                                            k∈N (j)
                                                                                                                                                 
                  XX                        X                                                1+β     −γ
                                                                                                                        a        X
              −           Pjn Djn (λ) +              Qn                 τ   n
                                                       jk (λ) + (1 − χ) δjk Qjk (λ)                   Ijk − zjn Ln
                                                                                                                 j (λ)        −             Qn
                                                                                                                                             ij (λ) .
                                                                                                                                                   
                  j   n                    k∈N (j)                                                                                i∈N (j)


The dual problem then consists of the simple unconstrained, convex52 minimization problem in J × N unknowns:

                                                              min L (x (λ) , λ) .
                                                              λ>0


This problem can be readily fed into a numerical optimization software. Faster convergence can be achieved by
providing the software with an analytical gradient and hessian. Note that, as a direct implication of the envelope
theorem, the gradient of the dual problem is simply the vector of constraints:
                                                                                                                   
                                                                        ..
                                                                       .                                          
                     n           P             n          τ    n
                                                                       1+β −γ      n  n
                                                                                              a P           n
                                                                                                                    
 ∇L (x (λ) , λ) = − 
                       C j (λ) +   k∈N (j)   Q jk (λ) + δ jk Q jk (λ)      I jk − z j Lj (λ)   −  i∈N (j) Q ij (λ) .
                                                                                                                    
                                                                        ..                                         
                                                                          .


Nonconvex cases
     When the conditions for convexity fail to obtain, the full planner’s problem is not a convex optimization problem.
It is, however, easy to find local optima by using the following iterative procedure. We then search for a global
maximum using a simulated annealing method that we describe below.


Finding Local Optima Despite the failure of global convexity for the full planner’s problem, the joint optimal
allocation and transport problems, taking the network as given, is always convex as long as β > 0. We thus use our
                                                  
duality approach to solve for cj , Djn , Qn     n
                                          jk , Lj for a given level of infrastructure Ijk , and then iterate on the (necessary)
first order conditions that characterize the optimal network. The procedure can be summarized in pseudo-code as
follows.

   50
     The specific values Qn
                          jk can be recovered at the end of the optimization by inverting the linear system (for given
                                                                                                P
multipliers λ) which corresponds to the balanced-flows constraints, the constraints Qjk (λ) = N          n n
                                                                                                  n=1 m Qjk and the
                                       Q    n
complementary slackness conditions, ζjkn Qjk = 0.
  51
     Note that, due to complementary slackness, we can drop the constraints that correspond to all the Lagrange
multipliers that we were able to solve by hand. As a result, only the balanced flows constraints remain.
  52
     Dual problems are always convex, by construction, even when the primal problem is not.


                                                                      71
                                                                                 n    o
                                                              (1)
   1. Let l := 1. Guess some initial level of infrastructure Ijk  that satisfies the network building constraint.
                                   n         o                                   
                         (l)
   2. Given the network Ijk  , solve for cj , Djn , Qn     n
                                                     jk , Lj using a duality approach.

                                                                                                                               1
                                                                                                                τ           1+γ
                                                                                           (l+1)            γ δjk     D 1+β
   3. Given the flows             Qn
                                   jk   and the prices        Pjn ,     get a new guess   Ijk      =       PK δ I
                                                                                                                     Pj Qjk        for χ = 1 (or
                                                                                                               jk
                                                                  1
                              τ   P                            1+γ
                          γ δjk
         (l+1)                                        1+β                                                     P         (l+1)
        Ijk      =       PK δ I         n   Pjn Qn
                                                 jk                     for χ = 0) and set PK such that              I
                                                                                                                    δjk Ijk      = K.
                             jk


           P         (l+1)        (l)
   4. If         Ijk − Ijk 6 ε, then we have converged to a potential candidate for a local optimum. If not, set
               j,k
        l := l + 1 and go back to (2).


Simulated Annealing In the absence of global convexity results, the above iterative procedure is likely to end
up in a local extremum. Unfortunately, there exists to our knowledge few global optimization methods that would
guarantee convergence to a global maximum in a reasonable amount of time.53 We opt for the simple but widely
used heuristic method of simulated annealing, which is a very popular probabilistic method to search for the global
optimum of high dimensional problems such as, for instance, the traveling salesman problem. Simulated annealing
can be described as follows:
                                                        n         o
                                           (1)
   1. Let l := 1. Set the initial network Ijk  to a local optimum from the previous section and compute its welfare
        v (1) . Set the initial “temperature” T of the system to some number.
                                             n o                      n o
                                                                        (l)
   2.   Draw a new candidate network Iˆjk by perturbing Ijk (see below). [Optional: deepen the network.]
                                                                             
        Compute the corresponding optimal allocation and transport cj , Djn , Qn             n
                                                                                       jk , Lj . Compute associated welfare
        v̂.
                                                                                                 h             i
                                                (l+1)
   3.   Accept the new network, i.e., set Ijk         = v̂ and v (l+1) = v̂ with probability min exp v̂ − v (l) /T , 1 , if
                                       n        o n o
                                          (l+1)         (l)
        not keep the same network, Ijk             = Ijk and v (l+1) = v (l) .

   4. Stop when T < Tmin . Otherwise set l := l + 1 and T := ρT T and return to (2),

where ρT < 1 controls the speed of convergence. Note that we improve the algorithm by allowing to “deepen”
the network in step (2), meaning that we additionally apply the n
                                                                iterative
                                                                     o procedure from the previous section for a
                                                                  ˆ
pre-specified number of iterations so that the candidate network Ijk is more likely to be a local optimum itself.


Drawing Candidate Networks The performance of the simulated annealing depends on how new candidate
networks are drawn. Because of the complex network structure, purely random perturbations are likely to be rejected
and the algorithm may easily fail to improve the initial network. We propose the two different perturbation methods
that have consistently produced the best results throughout our simulations.
Algorithm #1 “Rebranching”. This simple algorithm exploits the structure of the problem to make educated
guesses for the candidate networks. The algorithm builds on the idea that, under increasing returns, a welfare
improvement can be achieved by directly connecting locations to more central locations. Since a lower price level
indicates that a location has higher relative availability of goods produced anywhere in the economy, we use the price
level as a proxy for centrality. We thus construct candidate networks where random locations are better connected
to their lowest-price neighbors. The algorithm can be described as follows:

                                (l)
   1. Given an initial network Ijk  , draw a random set of locations I ⊂ J for “random rebranching” or set I = J
        for “deterministic rebranching”.
   53
      Techniques such as the branch-and-bound method are guaranteed to converge to the global optimum, but remain
heavy to implement and computationally intensive.


                                                                               72
   2. For each j ∈ I, identify m (j) as the neighbor with the lowest price index for the bundle of tradable goods,
       m (j) = argmin PkD , and n (j) as the “parent” with the highest level of infrastructure, n (j) =      argmax          Ikj .
                k∈N (j)                                                                                   k∈N (j)|Pkn 6Pjn


                                                    (l+1)
   3. For each j ∈ I, define the candidate network Ijk    by switching the infrastructure levels of m (j) and n (j):
                                             
                                                 (l)
                                             
                                              I        if k = n (j) , j ∈ I
                                              m(j)j
                                             
                                 (l+1)          (l)
                                Ikj      =     In(j)j   if k = m (j) , j ∈ I
                                             
                                             
                                             I (l)
                                             
                                                        if j ∈
                                                             / I or (j ∈ I and k ∈
                                                                                 / {m (j) , n (j)}) ,
                                                kj


       which, by construction, satisfies the network building constraint.

Algorithm #2 “Hybrid Alder-FS”. This algorithm attempts to implement the spirit of the algorithm proposed
in Alder (2019), while exploiting the continuity of infrastructure investments and differentiability of the problem.
The algorithm can be described as follows:

   1. Compute the welfare gradient with respect to infrastructure investments and some given price of asphalt PK .
       Delete the 5% links that correspond to the lowest elements of the gradient.

   2. Compute the new economic allocation given the new network.

   3. Compute the new welfare gradient and add a predefined quantity of asphalt to the link that has the highest
       element in the welfare gradient among inactive links.

   4. Rescale the network so that the total quantity of asphalt is used and make sure that the network is connected
       (otherwise add the most beneficial link).


D.2     Numerical Evaluation of the Nonconvex Algorithm
    We evaluate our simulated annealing approach in the nonconvex case in a range of random economies for which
one can compute or approximate the global optimum.


Brute force approach An important caveat when running this performance evaluation is that infrastructure
investments are continuous, so that the space of feasible networks is infinite. There is, unfortunately, no readily
available brute force algorithm that guarantees to find the global optimum in that case. To circumvent this issue,
we explore every single discrete combination of bilateral links (on/off), which we then use as initial conditions to
iterate on the first-order conditions that characterize optimal infrastructure investment in our model. This brute
force algorithm can, however, only be used for small economies with a limited number of locations, as the number of
combinations 2n(n−1)/2 explodes rapidly.


Alder (2019) We also compare the performance of our algorithm to Alder (2019), who proposes another heuristic
algorithm in a spatial economic model. Since the Alder algorithm is discrete in nature (locations are connected or not,
and there is no intensive aspect to infrastructure investments), there is no obvious way to perform the comparison.
We propose two approaches.
    In the first approach, which we refer to as “Alder”, we implement a simple version of the Alder (2019) algorithm in
our model. Specifically, we restrict infrastructure investments to be discrete (0 or I), where I is constant across links
and chosen such that the asphalt budget constraint is satisfied with equality. Under this constraint, we implement
every step of the Alder algorithm, that is: 1) starting from the full network, 2) compute welfare by removing each link
one by one, 3) remove the 5% least profitable links, 4) add the most profitable link, 5) make sure that the network in
connected, and iterate over (2)-(5) until no further step improves welfare. As a final step, we use the outcome of the



                                                               73
Alder algorithm as initial condition in the first-order condition iteration from our model, making sure that welfare
keeps improving along the way. As a result we obtain a continuous version of the optimal network that is comparable
to ours.
     A caveat in the first approach is that the first part of the algorithm is constrained by the discreteness of invest-
ments. We thus devise a new algorithm that combines the appealing aspects of Alder (2019) with our continuous-
investment approach which relies on differentiation and on the simulated annealing to escape local optima. We refer
to this second approach as “Hybrid Alder-FS”. To be more precise, we modify our simulated annealing algorithm
described in the previous section so that the stage in which we perturb the network is done in the spirit of the
Alder algorithm. Specifically, the network is perturbed in the following way: 1) compute the welfare gradient with
respect to infrastructure investment, 2) remove the 5% links with the lowest welfare gradient, 3) recompute the wel-
fare and welfare gradient in the network after removal, 4) add the link that has the highest welfare gradient among
non-existing links, and 5) make sure that the network is connected. The rest of the algorithm is kept identical to
ours. In particular, the algorithm always iterates on the first-order conditions associated to infrastructure investment
before deciding whether to accept the perturbation or not. In that sense, the intensive dimension of infrastructure
investment is preserved throughout.
     Note finally that the original Alder (2019) algorithm is designed to maximize aggregate income net of the dollar
value of infrastructure investments. In this comparison, we change the objective function so that it maximizes welfare
instead, subject to a fixed asphalt budget.


Simulated annealing There are many ways one can perturb the network in each loop of the simulated annealing
method. To explore the role of the perturbation stage, we experiment with various ways to perturb the network:
1) purely random perturbations, 2) deterministic rebranching, and 3) random rebranching. “Rebranching” refers
to the algorithm that we described in the previous section. In the deterministic version, all nodes are selected for
rebranching every loop (i.e., reconnected to their best neighbors), while they are picked at random in the random
version. This comparison allows us to evaluate the importance of randomness in the perturbation process as a way
to escape local optima.


Small random economies
    To perform the algorithm comparison, we draw random geographies for a given number of replications Nreps .
Specifically, for each geography, we draw n locations from a uniform distribution over [0, 1] × [0, 1]. The underlying
                                                                               τ                                I
network is fully connected. We parametrize the transport cost parameters δjk     and network building costs δjk    to be
the euclidean distance between each pair of locations. To ease comparison with Alder (2019), who uses a gravity
model without labor mobility, we study an Armington version of our model in which each location produces its variety
with fixed labor. The rest of the model is otherwise identical to the one described in section 3. In particular, there is
congestion in the transport technology, that is β > 0 using technology (10). We focus exclusively on nonconvex cases
with γ > β.54
    Table A.7 below reports the performance of the various numerical approaches for several numbers of locations
and replications. Due to the computation time of the brute force algorithm, we must restrict ourselves to 6 locations
at most.
    Before starting the individual comparison of each algorithm, it should be noted that the welfare losses are
overall quite small with numbers in the magnitude of 10−4 in consumption equivalent. This suggests that, all
things considered, each of these algorithms perform quite well for small economies. Looking at their individual
performance, we find that the simple Alder algorithm is the least effective method with a welfare loss of about 0.02-
0.03% in consumption equivalent compared to the brute force algorithm in most cases. A potential reason is that
the discreteness constraint heavily distorts the search for the optimum in an economy with continuous investments.

   54
      In the convex case β ≥ γ, a simple iteration over our model’s first-order conditions or descent along the gradient
suffice to find the global optimum quickly, so the algorithm comparison is irrelevant.


                                                           74
Turning to the other algorithms, our findings suggest that the random version of our “rebranching” algorithm and
the Hybrid Alder-FS algorithm get the best results with average welfare losses of about 0.004% or less. The Hybrid
Alder-FS algorithm does slightly better in our simulations with 5 locations, but the random rebranching algorithm
has the edge in the 6 locations case. In terms of computation time, the Hybrid algorithm requires slightly more time
than the FS algorithm due to an additional evaluation of the equilibrium during the updating process. The Alder
algorithm is the fastest algorithm given the small amount of locations, but the difference quickly reverts when we
increase their number, as we show next.


Large random economies
     We extend our comparison to economies with more locations. Unfortunately, we can no longer use the brute
force algorithm, but we can still compare the performance of the other algorithms. In this last exercise, we focus on
the version of our model used for the European road exercise in Section 5. Namely, we consider w × h rectangular
networks with Moore neighborhood (each location connected to its immediate horizontal, vertical and diagonal
neighbors). Since we study economies with a large number of locations, we limit the number of traded goods to 2.
As we did in the European exercise, we assume that one of the goods is a homogeneous “agricultural” good that can
be produced in any location. The other good is a differentiated variety that can only be produced in a number of
locations Ncities drawn uniformly among all locations. The rest of the model is otherwise identical to the previous
section.
     The results of this exercise, in Table A.8 below, are reported in terms of the welfare gains with respect to the local
optimum that results from iterating over our model’s first-order conditions without using annealing. Our findings
suggest this time larger differences between the algorithms as spatial complexity increases. While the Hybrid Alder-FS
algorithm seems to perform quite well overall (and definitely better than random perturbations), our “rebranching”
algorithm, in its deterministic and random versions, yields the best results in all cases. The random version performs
the best with welfare improvements ranging between 0.01% and 0.1%. The simple (discrete) Alder algorithm yields
does not do as well, most likely for the reason advanced before.




                                                            75
                                              Table A.7: Comparison of the welfare losses for small economies

                                                                                                  Simulated annealing
                 #locations    Nreps            Alder            Random             Rebranching               Rebranching           Hybrid Alder-FS
                                                                                  (deterministic)               (random)

                      4         100           -0.0360%           -0.0036%            -0.0036%                   -0.0020%                -0.0020%
76




                      5         100           -0.1281%           -0.0046%            -0.0047%                   -0.0043%                -0.0032%
                      6         10            -0.0216%           -0.0016%            -0.0019%                   0.0004%                 -0.0019%

     Notes: This table reports welfare in percentage consumption equivalent for the optimal network resulting from each algorithm compared to the brute force
     algorithm. The parameters chosen for the simulation are β = 1, γ = 2, K = 1, σ = 5, uniform amenities, productivity and population, no cross-good congestion,
     Cobb-Douglas utility with share α = 0.5 on traded goods.
                                               Table A.8: Comparison of the welfare gains for large economies

                                                                                                        Simulated annealing
               #locations    Ncities   Nreps       Alder             Random            Rebranching                  Rebranching         Hybrid Alder-FS
                                                                                      (deterministic)                (random)

                   25          10      100        -0.0272%           0.0000%             0.0122%                      0.0153%                0.0035%
                   64          20      100        -0.0133%           0.0000%             0.0378%                      0.0431%                0.0017%
                   64          40      100        -0.0068%           0.0003%             0.0057%                      0.0061%                0.0012%
77




                   100         20      100        -0.0033%           0.0011%             0.0858%                      0.0954%                0.0024%
                   100         40      100        -0.0062%           0.0015%             0.0259%                      0.0303%                0.0018%
                   100         60      100        -0.0048%           0.0005%             0.0042%                      0.0061%                0.0008%

     Notes: This table reports the welfare gain in percentage consumption equivalent compared to the outcome of our approach in non-convex cases without simulated
     annealing, simply obtained by iterating over the first-order conditions of our model starting from a full network. The parameters chosen for the simulation are
     β = 1, γ = 2, K = 1, σ = 5, uniform amenities, productivity and population, no cross-good congestion, and Cobb-Douglas utility with share α = 0.5 on traded
     goods.
E         Intuition for Global Convexity Condition
     We show that the infrastructure investment and shipping decisions can be viewed as the outcome of a game
between a decentralized planning agency and a shipping company. Due to the complementarity between infrastructure
and trade, an investment in infrastructure in a link leads to an increase in commodity flows. These additional flows
in turn encourage further investments. The convexity condition on the transport technology determines whether this
“race” is stable or divergent. When the transport technology is convex, each additional increase in investment or
flow becomes smaller until convergence to a non-trivial interior point.
     For clarity, we focus on the single good case. We focus on a link (o, d) from origin o to destination d. We
first consider the problem of a shipping company who takes prices and infrastructure as given and fully internalizes
the congestion externality. From section 3 that this is equivalent to having the shipping company not internalize
the congestion externality while facing an appropriately defined pigouvian tax. The problem faced by the shipping
company is
                                           max Pd Q − Po Q (1 + τ (Q, I)) ,
                                                    Q≥0

where Pi , i = o, d, is the price in each location. The first-order condition is

                                                          ∂ (Qτ )
                                      Pd − Po − Po                ≤ 0 with equality if Q > 0.                                                    (A.9)
                                                            ∂Q

This first-order condition is identical to (8) from the full planning problem. Denote Q∗ (I) the optimal amount of
commodity flow Q that solves equation (A.9).55 Consider now the problem of a myopic decentralized agency. It
is myopic in the sense that it takes the trade flow Q as given and does not internalize the fact that Q responds to
infrastructure in equilibrium, and decentralized in the sense that it solely invests in link (o, d), taking as given the
price PK of asphalt (that is, the Lagrange multiplier of the asphalt budget constraint in the full planning problem)
and the price of commodities. The objective of the planning agency is to minimize the sum of the market value of
transport costs and the cost of asphalt. We write the problem as follows

                                                     min Po Qτ (Q, I) + PK δ I I,
                                                      I≥0


where δ I is the marginal cost of investing infrastructure in the link. We obtain the following first-order condition,

                                                ∂ (Qτ )
                                         Po             + PK ≥ 0 with equality if I > 0.                                                        (A.10)
                                                  ∂I
This condition is identical to equation (9) in the main text. We denote I ∗ (Q) the optimal infrastructure investment
that solves equation (A.10).56
     Figure A.9 shows the two best response functions Q∗ (I) and I ∗ (Q) for the convex and nonconvex cases using
the functional form τ (Q, I) = δ τ Qβ I −γ .57 As the figure illustrates, there are two equilibria: the null equilibrium and
an interior equilibrium with I > 0 and Q > 0. The reason why the game features two equilibria even in the convex
case is that the planning agency is myopic and takes the commodity flow Q as given. In the full model and in the
convex case, the social planner internalizes the response in Q and never chooses the the null equilibrium under the
Inada conditions.
     The curve Q∗ (I) crosses I ∗ (Q) from above in the convex case (β ≥ γ) and from below otherwise. In the convex
case, only the interior equilibrium is stable, as a small increase (resp. decrease) in infrastructure prompts an increase


    55                                                                                                                               ∂(Qτ )
         Under the requirement that Qτ is convex in Q and satisfies some Inada conditions lim                                         ∂Q
                                                                                                                                              = 0 and
                                                                                                                               Q→0
lim ∂(Qτ )     = ∞, the solution Q∗ (I) exists and is unique.
Q→∞ ∂Q
    56                                                                                                           ∂(Qτ )                        ∂(Qτ )
         Under the assumption that Qτ is convex in I and satisfies the Inada conditions lim                        ∂I
                                                                                                                          = −∞ and lim           ∂I
                                                                                                                                                        =
                                                                                                       I→0                               I→∞
    ∗
0, I (Q) exists and is unique.
                                                               1    γ
                                                                                                              1
                                                                                                                       β+1
                                                     1 Pd −Po    β                            γ δτ             1+γ
    57
         In this case we obtain: Q∗ (I) =        1
                                                1+β δ τ  Po
                                                                     I β and I ∗ (Q) =       PK δ I
                                                                                                      Po             Q γ+1 .


                                                                      78
                      Figure A.9: Nash equilibria of the infrastructure investment game

                         (a) Convex case β ≥ γ                                                    (b) Nonconvex case γ > β

          Q∗ (I)                                                                    Q∗ (I)
          I ∗ (Q)                                                                   I ∗ (Q)
 Q




                                                                         Q
     0                                                                       0
                                   I                                                                         I

                    Note: Stable equilibria indicated by a black dot, unstable equilibria by a white dot.


(resp. decrease) in Q, but the response is limited due to the strong congestion forces. In turn, the moderate increase in
flows justifies reducing (resp. increasing) the level of infrastructure back to the interior equilibrium. In the nonconvex
case, the interior equilibrium is no longer stable but the null equilibrium is.
    This discussion shows that the convexity property on the transport technology controls the complementarities
between the planning agency and the private economy. In the nonconvex case, complementarities are strong. The
convex case corresponds to weak complementarities: a deviation by one player is accompanied by a deviation by the
other player in the same direction (they remain complements) but the response is too weak to push the economy
away from the interior equilibrium. The interior equilibrium is stable when Q∗ (I) crosses (I ∗ )−1 (I) from above, that
is                                                             ∗ −1
                                                     ∂Q∗        ∂I
                                                           ≤            .                                           (A.11)
                                                      ∂I        ∂Q
                                                                                              2        2                     2       2
                                                                                  ∂Q∗                            ∂I ∗
Differentiating the first-order conditions (A.9) and (A.10), we have               ∂I
                                                                                        = − ∂∂Q∂I
                                                                                              (Qτ ) ∂ (Qτ )
                                                                                                   / (∂Q)2 and   ∂Q
                                                                                                                        = − ∂∂Q∂I
                                                                                                                              (Qτ ) ∂ (Qτ )
                                                                                                                                   / (∂I)2 .
The stability condition (A.11) is thus equivalent to

                                                    ∂ 2 (Qτ )       ∂ 2 (Qτ )
                                                     ∂Q∂I            ∂Q∂I
                                                    ∂ 2 (Qτ )
                                                                ·   ∂ 2 (Qτ )
                                                                                 ≤ 1.                                               (A.12)
                                                     (∂Q)2           (∂I)2


In turn, (A.12) is equivalent to det (Hess (Qτ )) ≥ 0, which along with the maintained assumption that Qτ is convex
                                 2
                                                  ∂ 2 (Qτ )
in each individual argument, ∂(∂Q) (Qτ )
                                     2 ≥ 0 and     (∂I)2
                                                            ≥ 0, is equivalent to requiring that the total transport costs
Qτ (Q, I) is jointly convex over Q and I.



F        Dealing with Inefficiencies
    We show how to extend our approach to deal with cases with externalities in which Pigouvian taxes are not
available or incorrectly set. We provide an example with partially internalized congestion externality in transport as
well as agglomeration/congestion externalities in production and amenities.




                                                                    79
F.1     Environment
    We modify the environment by introducing agglomeration externalities or spillovers in production
                                                                                  
                                                     Yjn = F Ln    n    n
                                                              j , Vj , Xj ; Lj


where Lj captures the production spillovers. Lj is taken as given by firms and equals total employment in the
location,
                                                      X n
                                                 Lj =     Lj .
                                                                    n

We continue assuming that Fjn (·) has constant returns to scale in its first three arguments, and is increasing and
concave in each. Similarly, we allow for externalities in amenities by assuming that utility is given by
                                                                         
                                                           U cj , hj ; Lj .

Finally, we assume that the congestion externalities in transport are only partially internalized by shipping companies.
We focus on the convex case studied in our numerical exercise with mobile labor and cross-good congestion, but the
analysis can be easily applied to the other cases. Specifically, we assume that the transport technology is given by

                           n
                                                          β−β̃           −γ
                          τjk Qjk , Ijk ; Qjk = mn δjk
                                                    τ
                                                       Qjk       (Qjk )β̃ Ijk , β ≥ γ, β ≥ β̃ ≥ 0,
              P
where Qjk = N          n n
                 n=1 m Qjk . In this specification, the total congestion externalities amount to a total exponent of
β, but shipping companies only internalize them up to exponent β̃, taking the aggregate flow Qjk as given.58 In
equilibrium, the perceived flow on a given link Qjk is required to satisfy Qjk = Qjk .


F.2     Fictitious planning approach
                                                                         n
     Solving for the economic allocation cn       n
                                             j , Lj , ... and trade flows Qjk given an infrastructure network {Ijk } is
an important step in the optimization. The method described in the main text involves solving for the allocation
and flows jointly using a planning approach. Unfortunately, the presence of externalities does not allow us to invoke
the First Welfare Theorem directly. We nonetheless propose an approach in which a “fictitious planner” does not
internalize the effect of her decisions on Lj and Qjk .
     The fictitious planning problem for our economy can be characterized as the solution of a fixed-point problem.
                                                                      
We first define the problem faced by the fictitious planner given Lj , Qjk :
                                                                     
                             W        Lj , Qjk   j∈J ,k∈N (j)
                                                              ; {I jk }  =             max               u        (A.13)
                                                                               u, cj , hj , Lj , Djn ,
                                                                             Ln    n      n
                                                                              j , Vj , Xj , Qjk , Qjk
                                                                                                       n


subject to (i) availability of traded commodities,
                                      X                                                   
                          cj Lj +             τjk Qjk , Ijk ; Qjk Qjk 6 Dj Dj1 , . . . , DjN for all j,
                                    k∈N (j)

              PN
where Qjk =     n=1   mn Qn
                          jk , and non-traded commodities,


                                                        hj Lj 6 Hj for all j;




   58
      This example is akin to having congestion taxes set to a fraction β̃/β of the efficient Pigouvian taxes relative to
unit transport costs.


                                                                  80
(ii) the balanced-flows constraint,
                              X       ′      X                                    X
                      Djn +        Xjnn +             Qn     n
                                                       jk 6 Fj Ln    n    n
                                                                j , Vj , Xj ; Lj +   Qn
                                                                                      ij for all j, n;
                              n′            k∈N (j)                                         i∈N (j)


(iii) local factor market clearing,
                                                           X
                                                               Ln
                                                                j 6 Lj for all j;

and
                                                      X
                                                           Vjmn 6 Vjn for all j, m;
                                                       n

(iv) free labor mobility,
                                                                           
                                                Lj u 6 Lj U cj , hj ; Lj       for all j;

(v) aggregate labor market clearing,
                                                                X
                                                                     Lj = L;
                                                                 j

and (vi) non-negativity constraints on consumption, flows and factors.
    For a given Lj and Qjk , the above fictitious planning problem is a well-behaved convex problem under the same
conditions as in the main text and can be efficiently solved using a convex solver. Imposing that Lj = Lj and
Qjk = Qjk in equilibrium, the first-order conditions of this planning problem are identical to that of the competitive
equilibrium. We are now ready to define a solution to the fictitious planning problem.
                                            
Definition 4. An allocation Ω = u, cj , hj , Lj , Djn , Lnj , Vjn , Xnj , Qjk , Qnjk
                                                                               j∈J ,k∈N (j),1≤n≤N
                                                                                                     is a solution to the
fictitious planning problem of this economy for a given infrastructure network {Ijk } if it is a solution of the problem
(A.13),
                                                                          
                                         Ω ∈ argmax W Lj , Qjk ; {Ijk }

and satisfies

                                                  Lj = Lj for all j,
                                                 Qjk = Qjk for all j, k ∈ N (j) .

A fictitious planning allocation is thus the solution of a fixed point problem over Lj and Qjk , which can be solved
using an iterative procedure.59 This solution yields the competitive equilibrium of an economy with spillovers. In
cases where uniqueness of the competitive equilibrium is guaranteed, there is an equivalence between the competitive
equilibrium and the fictitious planning economy. In cases when uniqueness is not guaranteed, the fictitious planning
approach remains a tractable way to compute candidate equilibria.


F.3     Infrastructure gradient
     After solving for the economic allocation and trade flows given a certain infrastructure network {Ijk }, we are now
ready to compute the welfare gradient with respect to infrastructure investments from the point of view of an overall
planner who internalizes that the allocation corresponds to the solution to the fictitious planning problem and is
therefore not generically efficient. To achieve this, we use the fact the competitive equilibrium is locally characterized
as the solution to the fictitious planner’s first-order conditions. We then differentiate these first-order conditions to
evaluate the local impact of infrastructure changes.
     We consider the case studied in our numerical exercise from section 5 with (i) labor as the only factor of production,
(ii) Dj is a CES aggregator with elasticity of substitution σ, (iii) a unique good produced in each location (there is

   59
                                             
    In practice, we start with a guess on Lj , Qjk , solve problem (A.13), update our guess and repeat until
convergence. We do not have any proof guaranteeing the convergence of this procedure, but our experience has
shown that it converges most of the time for reasonable externality parameters.


                                                                     81
                                       n(j)                                                                                           ε
at most a unique n (j) such that zj    > 0 for each j) and the production function is given by Yjn = zjn Ln
                                                                                                          j Lj where
ε governs the production externality and and (iv) partially internalized transport externality (0 ≤ β̃ < β). In that
case, the fictitious planning problem described in (A.13) simplifies to

                                                                     max              u
                                                             Ω= u,cj ,hj ,Lj ,Djn ,Qn
                                                                                    jk


subject to
                                        
                Lj u 6 Lj U cj , hj ; Lj , ∀j               [×ωj ]                                                                        (A.14)
                                                                     !1+β                                  !    σ
                            X                     X                                   X                        σ−1          h     i
                                     τ      β−β                              −γ
                                                                                                    σ−1
                cj Lj +             δjk Qjk                 mn Qn
                                                                jk          Ijk 6            Djn     σ
                                                                                                                     , ∀j    ×PjD         (A.15)
                          k∈N (j)                  n                                   n
                                   h     i
                hj Lj 6 Hj , ∀j     ×PjH                                                                                                  (A.16)
                       X                    ε
                                                X                                           n
                Djn +         Qn      n
                                jk 6 zj Lj Lj +   Qn
                                                   kj , ∀ (j, n)                           ×Pj                                            (A.17)
                       k∈N (j)                               k∈N (j)
                 X
                      Lj = 1      [×W ]                                                                                                   (A.18)
                  j
                                                       
                Qn
                 jk > 0, Lj > 0
                                              n
                                            ×νjk , ξj

where the variables in brackets denote the associated Lagrange multipliers. Constraints (A.14)-(A.18) will bind in
equilibrium and define a system of 2 + 3J + J × N equations that we summarize as
                                                                               
                                                        Gcons Ω; Qjk , Lj , Ijk = 0.

The first-order conditions of the above problem are
                                       X
                           [u]    1−         ωj Lj = 0
                                        j
                                                       
                          [cj ]   ωj Lj Uc cj , hj ; Lj − PjD Lj = 0
                                                       
                          [hj ]   ωj Lj Uh cj , hj ; Lj − PjH Lj = 0
                                                                                             n(j) n ε
                        [Lj ]     − ωj (u − U (cj , hj )) − PjD cj − PjH hj + Pj                 zj Lj     − W + ξj = 0
                                        1    − 1
                      [Djn ]      PjD Djσ Djn σ − Pjn = 0
                       n                                       −γ  β−β
                       Qjk        − PjD mn (1 + β) δjk
                                                    τ
                                                       Qjk Qβjk Ijk − Pjn + Pkn + νjk
                                                                                   n
                                                                                      =0

along with the complementary slackness conditions

                                                                      n
                                                                     νjk Qn
                                                                          jk = 0


                                                                       ξj Lj = 0.

Together with the complementary slackness conditions, the first-order conditions define a system of 1 + 4J + J × N +
4 × nlinks × N equations, which we denote by
                                                                               
                                                        GF OC Ω; Qjk , Lj , Ijk = 0.

Imposing Qjk = Qjk and Lj = Lj , the constraints and first-order conditions jointly define the system
                                                                                                   !
                                                                         Gcons (Ω; Qjk , Ijk )
                                        G (Ω; Qjk , Ijk ) =                                            =0
                                                                         GF OC (Ω; Qjk , Ijk )

of 2 + 7J + 2J × N + 4 × nlinks × N equations in 2 + 4J + 2J × N + 4 × nlinks × N unknowns (more precisely, the


                                                                           82
allocation u, cj , hj , Lj , Djn , Qn                            D    H    n        n
                                    jk and the multipliers ωj , Pj , Pj , Pj , W , νjk , ξj ).
     By differentiating our equilibrium conditions around a solution to the fictitious planning problem described above,
we can now compute how each element of the allocation Ω is affected by a change in infrastructure. Using the implicit
function theorem, we obtain
                                                JI (Ω) = − [JΩ (G)]−1 JI (G) ,

where JX (F ) denotes the Jacobian of some function F with respect to some vector of variables X. Since welfare
u is one of the variables in the allocation Ω, the gradient of welfare with respect to a change in infrastructure Ijk
assuming a shadow value PK for asphalt/concrete is simply given by

                                                        du     I
                                                            − δjk PK .
                                                       dIjk

    Provided with this welfare gradient, it is possible to optimize on the infrastructure network using a simple
gradient-descent algorithm. There are, however, two new caveats in comparison to the efficient case covered in the
main text: i) the computations can be quite time-consuming since the fictitious planning problem needs to be solved
at every step of the optimization, ii) Proposition 1 on the convexity of the overall planning problem no longer applies
and the resulting network has no guarantee to be the global optimum.


F.4        Numerical comparison
     To quantitatively evaluate the importance of inefficiencies, we return to the benchmark case of Spain in our main
quantitative exercise.60 We put aside agglomeration externalities in production and consumption to focus on partially
internalized congestion in transport as the only source of inefficiency. The model parameters are those estimated in
the calibration and we simply vary the perceived congestion parameter β̃ while keeping the overall level of congestion
β constant. We consider three cases: β̃ = 0.25β, 0.5β and 0.75β,which correspond to having the Pigouvian taxes set
to 25%, 50% and 75% of what would be their optimal level relative to transport costs.
     Table A.9 reports some summary statistics. Unsurprisingly, overall welfare resulting from the fictitious planner is
lower compared to the efficient planner the less shipping companies internalize congestion (lower β̃). The difference is
nonetheless quite small with welfare differences in the order of 10−4 in consumption equivalent terms. Similarly, we
find that the resulting equilibrium trade flows Qjk and infrastructure gradients are almost identical, with correlations
close to 1 between the efficient and inefficient allocations.

                                                                                           efficient dW inefficient
                         β̃      Welfare    corr(Qefficient
                                                  jk        ,Qinefficient
                                                              jk          )         dW
                                                                              corr( dIjk
                                                                                                    , dIjk          )

                     Efficient      0                     1                                      1
                      0.75β      -0.0048%              0.9999                                0.9975
                       0.5β      -0.0198%              0.9998                                0.9948
                  0.25β     -0.0462%             0.9996                        0.9917
Notes: dW/dIjk denotes the welfare gradient. Welfare is stated in percentage deviation from the efficient benchmark
in consumption equivalent.

               Table A.9: Statistical comparison between efficient and inefficient allocations

    Since shipping companies fail to internalize their impact on congestion, we find that the inefficient allocation
tends to feature larger trade flows the less the externality is internalized in comparison to the efficient one (Figure
A.10). The left panel of Figure A.12 shows that the difference in flows are especially important around Madrid,
Barcelona and Valencia. The discrepancies between the welfare gradients in infrastructure do not show a systematic
pattern, as Figure A.11 illustrates. The right panel of Figure A.12 shows nonetheless a tendency for the planner to

   60
        More precisely, we consider the case β = 0.13, γ = 0.10 with labor mobility and cross-good congestion.


                                                              83
invest in infrastructure, in the inefficient case, in alternative routes around the most congested centers in order to
alleviate congestion on the main axes. This is most easily seen in the cases of Madrid and Valencia.

                                                                                            10 -3
  0.12                                                                              8

                                                                                    7
   0.1
                                                                                    6

  0.08                                                                              5

                                                                                    4
  0.06
                                                                                    3

  0.04                                                                              2

                                                                                    1
  0.02
                                                                                    0

     0                                                                             -1
         0     0.02     0.04         0.06         0.08       0.1    0.12                0           0.02   0.04   0.06   0.08   0.1   0.12



             Figure A.10: Comparison of trade flows Qjk between efficient and inefficient cases


   1.4                                                                          0.15


   1.2
                                                                                  0.1

     1
                                                                                0.05

   0.8
                                                                                    0
   0.6

                                                                                -0.05
   0.4

                                                                                 -0.1
   0.2


     0                                                                          -0.15
         0    0.2     0.4      0.6          0.8          1    1.2   1.4                 0           0.2    0.4     0.6    0.8    1     1.2




     Figure A.11: Comparison of infrastructure gradients between efficient and inefficient cases




                                                                           84
Notes: The differences are plotted in green when higher in the inefficient allocation and in red when higher in the
efficient allocation. The figure displays the case β̃ = 0.5β.

     Figure A.12: Comparison of infrastructure gradients between efficient and inefficient cases


G      Supplementary Material to Proposition 3
G.1      Definitions
     Let G = (I, E ) be an undirected graph. We say that a path of length n ∈ N∗ from a node a ∈ I to b ∈ I is a
finite sequence of nodes (i1 , . . . , in ) such that ik ∈ I for 1 ≤ k ≤ n, i1 = a and in = b and {ik , ik+1 } ∈ E . A simple
path is a path that contains no repeated node, i.e., ik 6= il for all 1 ≤ k, l ≤ n and k 6= l. A cycle of length n is a
path p = (i1 , . . . , in ) such that i1 = in . A simple cycle of length n is a cycle that contains no repeated node other
than the starting and ending nodes, i.e., ik 6= il for 1 6 k, l 6 n − 1 and k 6= l. A tree is a connected graph such that
has no simple cycle. Equivalently, in a tree, there is a unique simple path connecting any two nodes.


G.2      Propositions and Lemmas
Proposition 3. (Tree Property) Assume that lim UC (c, h) = ∞. In the absence of a pre-existing network (i.e.,
                                                   c→0+
I jk = 0), if the transport technology is given by (10) and satisfies γ > β, and if there is a unique commodity produced
in a single location, then the optimal transport network is a tree.

Proof. To establish the result, we focus on the case with fixed labor.61 Note further that in the case with a unique
traded commodity the own-good and cross-good congestion cases are identical. We assume WLOG that production
Yj is exogenous (endowment economy) since there is only one commodity and factors are immobile. To fix ideas, let
us assume that I = {0, 1, . . . , J − 1} and Y0 > 0 but Yj = 0 for j ≥ 1. We write down the Lagrangian of the problem
                                                                                   !                        
                                                                                 β
                    X                         X                 X           τ
                                                                               Q jk
                                                                                                   X
              L =      ωj Lj U (cj , hj ) −       Pj Lj cj +          1 + δjk   γ    Qjk − Yj −         Qkj 
                     j                          j
                                                                                Ijk
                                                              k∈N(j)                              k∈N(j)
                                                   
                          X X I                          X Q           X I            Q        I
                  − PK                 δjk Ijk − K  +      ζjk Qjk +     ζjk Ijk , ζjk > 0, ζjk > 0.
                            j   k∈N(j)                 j,k            j,k


Despite being a nonconvex optimization problem, there must exist a vector of Lagrange multipliers such that the
KKT conditions hold.62 As a preliminary step, we eliminate the infrastructure investment Ijk using (13), so that
                      1
           δτ     1+β
                       γ+1
Ijk = PγK δjk
            I Pj Qjk       whenever Qjk > 0, otherwise Ijk = 0. Solving for the multiplier PK such that (7) is
             jk


   61
      In the labor mobility case, an identical argument can be made by taking the optimal allocation of Lj as given
and replacing the Pareto weights ωj with the Lagrange multipliers of the constraints Lj u ≤ Lj U (cj , hj ).
   62
      The resource constraint can be substituted in the objective function to yield Pj = ωj UC (cj , hj ). The Arrow-
Hurwicz-Uzawa theorem (Takayama (1985), Theorem 1.D.4) implies that, the remaining constraints being affine,
there must exist a vector of Lagrange multipliers such that the KKT conditions hold.


                                                             85
satisfied, we reformulate the problem with allocation and flows only as follows
                                                                                      
                            X                       X             X              X
                      L =      ωj Lj U (cj , hj ) −   Pj Lj cj +     Qjk − Yj −   Qkj 
                                j                               j                       k∈N(j)                        k∈N (j)
                                                                                             γ+1
                                         X                    γ                      1               X
                            − K −γ              I    τ        γ+1
                                                                          Pj Q1+β
                                                                                        γ+1                      Q              Q
                                                δjk /δjk                      jk
                                                                                                    +          ζjk Qjk ,      ζjk > 0.              (A.19)
                                         j,k                                                              j,k




                                                                                        γ                     1    γ+1
                                                               P                       γ+1                     γ+1
    The source of nonconvexities is the term                        j,k
                                                                            I
                                                                           δjk   τ
                                                                               /δjk               Pj Q1+β
                                                                                                      jk                      , which is convex when β ≥ γ,
but neither convex nor concave when γ > β. Let us now assume that (c∗ , Q∗ ) with c∗ = (c∗0 , . . . c∗J −1 )′ and Q∗ =
     
 Q∗jk j,k∈N (j) is a local optimum, i.e., it satisfies the FOCs and SOCs of the Lagrangian (A.19). We are going to
show that the graph associated with Q∗ is a tree. Define the (undirected) graph associated to Q∗ as the tuple (I, E ∗ )
such that E ∗ ⊂ E is a subset of the edges of the underlying geography such that
                                                           
                                                      E ∗ = {j, k} ∈ E | Q∗jk > 0 .

Note that since Ijk is non-zero whenever Qjk > 0 or Qkj > 0, the support of graph (I, E ∗ ) coincides with that of the
transport network {Ijk }. After this preparatory work, we now refer the reader to the Proposition 6 that follows.

Proposition 6. E ∗ is a tree.
Proof. Because node 0 is the unique productive center and there is an Inada condition in consumption, there must
exist a path connecting each node to 0. Hence, E ∗ must be connected. It remains to show that E ∗ cannot have simple
cycles. We proceed by contradiction. Assume there exists a simple cycle p = (i1 , . . . , in ).Figure A.13 illustrates the
different types of cycles that can arise. Case (i) is a cycle with circular flows that run in only one direction. Lemma 1
tells us that such cycle cannot arise if (c∗ , Q∗ ) is locally optimal, as they inefficiently waste goods in transportation.
Cases (ii) and (iii) correspond to cycles along which flows run into different directions. Lemma 3 establishes that
whenever there is a cycle of type (iii), then there must exists a cycle of type (ii). We conclude with Lemma 4
by showing that cycles of type (ii) cannot arise if (c∗ , Q∗ ) is locally optimal. The reason is that one is better off
redirecting flows into one of the two branches because of economies of scale in the transport technology when γ > β.
Hence, simple cycles may not exist and E ∗ is a tree.

                                                                                                                              0



                                 a                                   a                                a               c



                                                 b                                      b                                 b



                                     Case (i)                              Case (ii)                       Case (iii)



                                     Figure A.13: Different types of simple cycles



Lemma 1. If (c∗ , Q∗ ) is a local optimum with (I, E ∗ ) its associated graph, then there exists no simple cycle
p = (i1 , . . . , in ) such that Q∗ik ,ik+1 > 0 for all 1 6 k 6 n − 1.


                                                                              86
Proof. Case (i) in Figure A.13 presents the type of cycle with circular flows that cannot exist in a local optimum.
By contradiction, assume that there exists such a cycle p = (i1 , . . . , in ). Then, for ε > 0 small, consider the allocation
of flows                      
                              Qjk − ε if ∃l, 1 6 l 6 n − 1, such that j = il and k = il+1
                       Qεjk =                                                                       .
                               Q∗         elsewhere
                                     jk
                                           
If ε 6    min Qik ,ik+1 , then {cj } , Qεjk   is a feasible allocation that is strictly preferable to ({cj } , Q∗ ) since it
         16k6n−1
yields the same utility at a lower transport cost. Hence, the gradient of the Lagrangian with respect to ε is strictly
greater than 0 (recall that Pj = uc (cj , hj ) > 0), contradicting the assumption that (c∗ , Q∗ ) is a local optimum.



Lemma 2. For every node a ∈ I distinct from the productive center 0 ∈ I and such that La > 0, there exists a
simple path p = (i1 , . . . , in ) that connects 0 to a and such that Qik ,ik+1 > 0 for 1 6 k 6 n − 1.

Proof. The proof is constructive. We build a simple path p = (i1 , . . . , in ) with i1 = a, ik 6= il for all 1 6 k, l 6 n and
k 6= l and such that Qik ,ik−1 > 0. We proceed by recursion on the length of path p, which we denote by |p| = n. We
start the recursion by setting i1 = a. Because of the Inada conditions in the utility function and La > 0, we know
that ca La > 0. The balanced flow constraint in a,
                                                                 "            #
                                                                            β
                                                                       τ Qak
                                          X            X
                                  ca La =      Qka −         Qak 1 + δak γ      > 0,
                                                                          Iak
                                             k∈N (a)            k∈N (a)


tells us that location a must be a net recipient of goods from its neighbors. Hence, there exists k ∈ N (a) such that
Qka > 0. Let i2 = k. If i2 = 0, then we have found a simple path connecting a to 0 with positive flows from 0 to a.
If not, we now have a path p2 = (i1 , i2 ) of length 2 such that i1 = a, i1 6= i2 6= 0 and Qi2 i1 > 0. Assume now that
n > 2 and, by recursion hypothesis, that we have a path pn = (i1 , . . . in ) with i1 = a, ik 6= il 6= 0 for all 1 6 k, l 6 n
and k 6= l and such that Qik ,ik−1 > 0. Consider location in . The balanced flow constraint at in tells us that
                                                                                 "                           #
                                            X                     X                                Qβin ,k
                              cin Lin =               Qk,in −               Qin ,k 1 +   δiτn ,k                 > 0.
                                                                                                   Iiγn ,k
                                          k∈N (in )             k∈N (in )

Since we know by recursion hypothesis that Qin ,in−1 > 0, then there exists a k ∈ N (in ) such that Qk,in > 0. We
know that k 6= il for all 1 6 l 6 n because otherwise there would exists a cycle with circular flows, which is ruled
out by Lemma 1. If k = 0, then we have found a path pn+1 = (i1 , . . . , in , 0) that connects a to 0 with only positive
flows from 0 to a. If not, then set in+1 = k. We then have a path pn+1 = (i1 , . . . in+1 ) with i1 = a, ik 6= il 6= 0 for all
1 6 k, l 6 n + 1 and k 6= l and such that Qik ,ik−1 > 0.
     We conclude as follows. Since I is finite, the above recursion must finish in a finite number of iterations. Since
the recursion only stops after finding a path that ends in 0, then there must exists a simple path p of size n < |I|
with p = (i1 , . . . , in ) such that i1 = a, in = 0 and Qik ,ik+1 > 0 for 1 6 k 6 n − 1. By construction, the path
p̃ = (in , in−1 , . . . , i1 ) proves the statement.



Lemma 3. Assume there exists a simple cycle p = (i1 , . . . , in ). Then, there exists (a, b) ∈ I 2 , a 6= b, such that
                                                                                        
there exists two distinct simple paths from a to b, p1 = i1k 1≤k≤n and p2 = i2k 1≤k≤n with i11 = i21 = a and
                                                                        1                       2
i1n1 = i2n2 = b, such that the flows are strictly positive from a to b along both paths, i.e., Q∗il ,il > 0 for l ∈ {1, 2}
                                                                                                  k k+1
and 1 ≤ k ≤ nl − 1.

Proof. The objective of this lemma is to establish that if there exists a simple cycle, then there must exist a cycle
of type (ii) as illustrated on Figure A.13.
      Consider the simple cycle p = (i1 , . . . , in ). For convenience of notation, denote i0 = in−1 and in+1 = i2 . Denote
Q̃ik ,ik+1 = Q∗ik ,ik+1 − Q∗ik+1 ,ik the net flow from ik to ik+1 for 0 6 k 6 n, which can be either strictly positive or



                                                                    87
strictly negative. We know from Lemma 1 that the net flows Q̃ik ,ik+1 cannot have the same sign, otherwise we would
have a cycle with circular flow, violating the local optimality condition of (c∗ , Q∗ ). Hence, there must exist 1 6 k 6 n
such that Q̃ik−1 ,ik > 0 and Q̃ik ,ik+1 < 0. Node k is a location that receives goods from its two neighbors on the
cycle, as illustrated by node c in case (iii) of Figure A.13. Set a = 0 and b = ik . We know from Lemma 2 that there
                                      
exists a path p1 = j11 , . . . , jn1 1 such that j11 = a = 0, jn1 1 = ik−1 and Q̃j 1 ,j 1 > 0 for all 1 6 l 6 n1 . Similarly, there
                                                                                            l l+1
                                      
exists a path p2 = j12 , . . . , jn2 2 such that j12 = a = 0, jn2 2 = ik+1 and Q̃j 2 ,j 2 > 0 for all 1 6 l 6 n2 . We now argue
                                                                                           l l+1
that the paths p̃1 = j11 , . . . , jn1 1 , b and p̃2 = j12 , . . . , jn2 2 , b are two distinct simple paths from a to b with strictly
positive flows. By construction, we know that Q̃jn1 ,ik > 0 and Q̃jn2 ,ik > 0 so that the flows are strictly positive
                                                                1                        2
along both paths. We must only check that they are simple paths, i.e., that the nodes are not repeated. Let us treat
the case of p̃1 . The other one follows symmetrically. We must show in particular that there is no l with 1 6 l 6 n1
                                                                                    
such that jl1 = b. If this was the case, then b, , jl+1     1
                                                                   . . . , jn1 1 , b would be a cycle with circular flows running in the
same direction, which Lemma 1 rules out. Hence, p̃1 is a simple path.


                                                                                                            
Lemma 4. For all (a, b) ∈ I 2 , a 6= b, if there are two simple paths p1 and p2 connecting a to b, i.e., p1 = i1k
                                                                                                             1≤k≤n1
            
and p2 = i2k 1≤k≤n with i11 = i21 = a and i1n1 = i2n2 = b, such that Qil ,il > 0 for l ∈ {1, 2} and 1 ≤ k ≤ nl , then
                  2                                                    k k+1
p1 = p2 .

Proof. The objective of this lemma is to show that cycles of the type (ii) in Figure A.13 cannot exist. Assume
by contradiction that such a cycle exists and that p1 6= p2 . Note that we can assume WLOG that i1k 6= i2l for all
                                                      1          2
                                                                                                  1    2
1 < k < n1 and 1 < l < n2 . To see this, let k = min k|i k+1 6= ik+1
                                                                     and k 1 =
                                                                               min k >k|∃l > k, ik = il and k2  ′
be such that i1k = ik2 . By construction, the path p′1 = i1k , . . . , i1k                               and p2 = i2k , . . . , i2k       are two paths such that
                              1         2                                                            1                                2

i1k   =   i2k ,   i1k1   =   i2k2 ,   and   i1k   6=   i2l   for all k < k < k1 and k < l < k2 .



                                                                a                               a
                                                                                                          Q∗ − ε
                                                                                          Q∗ + ε
                                                                               b                              b



                                                                (a) Initial                     (b) After redirection



                                                        Figure A.14: Redirecting the flows to one branch

     We are now going to show that p1 6= p2 leads to a contradiction. The idea behind the proof is illustrated in
Figure A.14 below. We are going to show that if there exists two distinct simple paths with positive flows going from
a to b, then it would be strictly preferable to redirect the flows from one branch to the other due to the non-concavity
                                                                                              
of the Lagrangian, violating the local optimality of (c∗ , Q∗ ). Consider the allocation Qε = Qεjk for ε ∈ R such that
                                                                     
                                                                     
                                                                     Q∗ + ε       if ∃l such that j = i1l and k = i1l+1
                                                                      jk
                                                                     
                                                             Qεjk   = Q∗jk − ε     if ∃l such that j = i2l and k = i2l+1
                                                                     
                                                                     
                                                                     
                                                                     Q∗
                                                                          jk       elsewhere.

In other words, Qεjk corresponds to the pattern of flows Q∗jk where a volume ε of the flows going through path 2
are redirected through path 1. By construction, Qεjk is feasible (we are redirecting a fraction of flows that were
running through locations on path 2 but not serving any of these locations). In particular, it leaves the value of the
                                                                 γ          1 γ+1
                                                        P
                                                                     Pj Q1+β
                                                                γ+1           γ+1                      I   τ
Lagrangian (A.19) unchanged except through the term       j,k δ̂jk       jk            where δ̂jk = δjk  /δjk .



                                                                                         88
    Consider the derivative of the Lagrangian with respect to ε:
                                              γ                                                                                                     
                             γ            1                 γ        1   1+β                                            γ         1       1+β
   ∂L                X                              X                           −1                       X                                        −1
                                 Pj Q1+β
                                           γ+1
       = − (1 + β)        γ+1
                         δ̂jk        jk
                                                        δ̂iγ+1
                                                             1 i1  Piγ+1
                                                                     1   Qi1+γ
                                                                           1 i1    −                               δ̂    γ+1
                                                                                                                        i2 i2
                                                                                                                                 Pγ+1
                                                                                                                                 i2
                                                                                                                                        Q   1+γ
                                                                                                                                            i2 i2
                                                                                                                                                       
   ∂ε                                                        k k+1   k     k k+1                                         k k+1    k          k k+1
                             j,k                              16k6n1 −1                                16k6n2 −1


                  ∂L
which satisfies    ∂ε
                        = 0 by assumption (local optimum). Let us examine the second order condition:
                                                                                   γ
                                                      X γ 
                          ∂2L                 1+β               γ+1     1+β
                                                                               1
                                                                                γ+1
                              = − (1 + β)          −1        δ̂jk  Pj Qjk           ×
                          ∂ε2                 1+γ         j,k
                                                                                               
                                 X          γ      1   1+β          X         γ        1 1+β
                                           γ+1    γ+1  1+γ
                                                           −2                γ+1     γ+1 1+γ
                                                                                             −2
                                       δ̂i1 i1 Pi1 Qi1 i1     +          δ̂i2 i2 Pi2 Qi2 i2 
                                                k k+1   k        k k+1                     k k+1   k      k k+1
                                    16k6n1 −1                                  16k6n2 −1
                                                                           γ−1
                                                 γ     X γ+1γ          1
                                   − (1 + β)2                  Pj Q1+β
                                                                        γ+1
                                                       δ̂jk       jk
                                                                                ×
                                                γ+1     j,k
                                                                                                                  2
                                                γ      1  1+β                      γ       1 1+β
                                                                                                     
                                    X          γ+1    γ+1 1+γ
                                                                −1       X         γ+1    γ+1 1+γ
                                                                                                  −1 
                                   
                                            δ̂i1 i1 Pi1 Qi1 i1    −            δ̂i2 i2 Pi2 Qi2 i2   .
                                   16k6n1 −1 k k+1 k      k k+1
                                                                      16k6n2 −1
                                                                                   k k+1  k   k k+1
                                                                                                     
                                    |                              {z                              }
                                                                          =0

                         2
Hence, we see that ∂∂εL2 > 0 when γ > β. Therefore, the point under consideration cannot be a local maximum. A

tiny deviation in either direction for ε would increase welfare, thereby yielding a contradiction.




                                                                     89
