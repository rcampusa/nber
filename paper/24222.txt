                               NBER WORKING PAPER SERIES




         LIQUIDITY REGIMES AND OPTIMAL DYNAMIC ASSET ALLOCATION

                                      Pierre Collin-Dufresne
                                          Kent D. Daniel
                                         Mehmet Sa lam

                                       Working Paper 24222
                               http://www.nber.org/papers/w24222


                     NATIONAL BUREAU OF ECONOMIC RESEARCH
                               1050 Massachusetts Avenue
                                 Cambridge, MA 02138
                           January 2018, Revised October 2018




For valuable comments and suggestions, we thank Darrell Duffie, Hui Guo, Ron Kaniel, an
anonymous referee, and seminar participants at Princeton University, UCLA, University of
Cincinnati and the 2018 Zurich Workshop on Asset Pricing. The views expressed herein are those
of the authors and do not necessarily reflect the views of the National Bureau of Economic
Research.

At least one co-author has disclosed a financial relationship of potential relevance for this
research. Further information is available online at http://www.nber.org/papers/w24222.ack

NBER working papers are circulated for discussion and comment purposes. They have not been
peer-reviewed or been subject to the review by the NBER Board of Directors that accompanies
official NBER publications.

© 2018 by Pierre Collin-Dufresne, Kent D. Daniel, and Mehmet Sa lam. All rights reserved.
Short sections of text, not to exceed two paragraphs, may be quoted without explicit permission
provided that full credit, including © notice, is given to the source.
Liquidity Regimes and Optimal Dynamic Asset Allocation
Pierre Collin-Dufresne, Kent D. Daniel, and Mehmet Sa lam
NBER Working Paper No. 24222
January 2018, Revised October 2018
JEL No. D53,G11,G12

                                         ABSTRACT

We solve a portfolio choice problem when expected returns, volatilities and trading-costs follow
a regime-switching model. The optimal policy trades towards an aim portfolio given by a
weighted-average of the conditional mean-variance portfolios in all future states. The trading
speed is higher in more persistent, riskier and higher-liquidity states. It can be optimal to
overweight low Sharpe-ratio assets such as Treasury bonds because they remain liquid even in
crisis states. We illustrate our methodology by constructing an optimal US equity market timing
portfolio based on an estimated regime-switching model and on trading costs estimated using a
large-order institutional trading dataset.

Pierre Collin-Dufresne                         Mehmet Salam
Ecole Polytechnique Federale de Lausanne       Assistant Professor of Finance
CDM SFI SFI-PCD                                Carl H. Lindner College of Business
EXTRA 209                                      University of Cincinnati
CH-1015 Lausanne                               408 Lindner Hall
Switzerland                                    Cincinnati, OH 45221
pierre.collin-dufresne@epfl.ch                 mehmet.saglam@uc.edu

Kent D. Daniel
Graduate School of Business
Columbia University
3022 Broadway, Uris Hall 421
New York, NY 10027
and NBER
kd2371@columbia.edu
1        Introduction
Mean-variance efficient portfolio optimization, introduced by Markowitz (1952), is still widely used
in practice and taught in business schools. When either expected returns or the covariance matrix
of returns changes over time then so will the conditional mean-variance efficient ‘Markowitz’ port-
folio. In the presence of transaction costs however, it will generally not be optimal for investors to
constantly rebalance to perfectly track the Markowitz portfolio. In recognition of this fact, practi-
tioners generally employ ad-hoc adjustments to Markowitz optimization, but it is recognized that
these approaches are not optimal (Grinold and Kahn 1999).
        In a recent paper, Gârleanu and Pedersen (2013, GP) show that in the presence of quadratic
transaction costs,1 an investor with mean-variance preferences should adopt a trading rule that
only partially rebalances from her current position towards an aim portfolio at a fixed trading
speed.2 They derive closed-form expressions for both the optimal aim portfolio and the trading
speed that depend on the dynamics of expected returns, the quantity of and aversion to risk, and
the magnitude of price impact. However, the GP model assumes that both the covariance matrix of
price changes and the price-impact parameters are constant. In this paper we derive a closed-form
solution for the optimal portfolio trading rule in a similar setting but where, in addition to expected
returns, volatilities and transaction costs may be stochastic. This is consistent with considerable
empirical evidence that stock return volatilities are stochastic and that transaction costs covary
with the level of stock volatility (going back at least to Rosenberg (1972) for the former and to
Stoll (1978) for the latter).
        Here, we develop a closed-form solution for the optimal dynamic portfolio when expected re-
turns, covariances, and price impact parameters follow a multi-state Markov switching model.3
Consistent with GP, we assume that the investor’s objective function is ‘dynamic’ mean-variance:
investors maximize the expected discounted sum of portfolio returns net of trading costs, minus
a penalty for the variance of portfolio returns. While this objective function is frequently used
in practice and in academic papers, to our knowledge it lacks decision-theoretic foundations. In
Appendices D-G, we show that the resulting optimal strategy corresponds to that of an agent who
is risk-neutral to the regime-switching risk associated with variation in the investment opportunity
set, while remaining risk-averse to the diffusion risk associated with return shocks. In Appendix E,
we formalize this argument by defining a set of ‘source-dependent’ recursive (stochastic differen-
tial) utility preferences which result in the same objective function, building on Skiadas (2008),
and Hugonnier, Pelgrin, and St-Amour (2012).4
        In this setting, and for an agent with these preferences, we show that the optimal trading
    1
      Quadratic transaction costs emerge with a linear price impact model, i.e., trading ∆ shares of a stock move its
average price by λ∆ for a given constant λ.
    2
      Litterman (2005) makes a similar point in an unpublished note.
    3
      One additional advantage of this approach, which we discuss more below, and develop fully in Section 4, is that
it allows us to specify a process for return volatility as opposed to price-change volatility in each state, consistent
with the observed log-normality of prices.
    4
      We thank the anonymous referee for encouraging us to provide decision-theoretic foundations to this objective
function.



                                                          2
rule is similar to that derived in GP, namely to partially trade from the current position towards
an aim portfolio. In GP the aim portfolio and trading speed are static. Here, when risk and
trading costs can change, both the aim portfolio and the trading speed are conditional on the state.
Specifically, the aim portfolio is a weighted average of the state-contingent Markowitz portfolios in
all possible future states, where the weight on each conditional-Markowitz portfolio is a function of
the likelihood of transitioning to that state, the state persistence, and the risk and transaction costs
faced in that state relative to the current one. Similarly, the optimal trading speed depends on
the relative magnitude of the transaction costs in various states and their transition probabilities.
Moreover, while we solve the model in a discrete-time setting in the body of the paper, Appendices B
and C solve a continuous time version of the model, and obtain consistent solutions.
      To develop some of the intuition underlying the model, consider a simple setting with a single
risky asset, and with two states: a low volatility state L where transaction costs are zero, and a
high volatility state H where transaction costs are positive. When the economy is in the L-state,
it is clearly optimal to trade (at infinite speed) all the way to the aim portfolio because transaction
costs in that state are zero. In contrast, trading speed will be finite in the H-state. Further, the aim
portfolio in the H-state will equal the conditional Markowitz portfolio in that state.5 Intuitively, in
the H-state the investor should put zero-weight on the L-state Markowitz portfolio, because when
the economy enters that state she will face no cost to rebalance (to the optimal aim portfolio) in
that state. However, the aim portfolio in the L-state will be a weighed average of both H- and
L-conditional Markowitz portfolios, and where the weight on the H-conditional Markowitz portfolio
increases with the likelihood of transitioning from L to H, the persistence of the state H, and with
the ratio of the volatilities in the H- and L-states.
      One immediate implication of our model is that the aim portfolio will deviate significantly
from the Markowitz benchmark in anticipation of possible future shifts in relative risk and/or
transaction costs. Consider two assets, which can be thought of as a “Treasury” and a “Corporate”
bond portfolio. Suppose that in the low-volatility state (state L), the Corporate portfolio has a far
higher Sharpe ratio than the Treasury portfolio, so that the conditional Markowitz portfolio has
most of its weight on Corporates. However, if the economy transitions to state H, then risk and
trading costs will dramatically increase for Corporates, but will remain unchanged for Treasuries. In
anticipation of this, the aim portfolio in the L-state will have a large Treasury position. Intuitively,
if the economy transitions from the L to the H state, then the volatility of the Corporate portfolio
will increase, its Sharpe ratio will fall, and it will become illiquid and costly to trade out of. Thus,
the optimal dynamic “aim” portfolio preemptively reduces the position of the Corporate portfolio
in the L-state.
      A related implication of the model relates to the trading speed in the L state. When the
current portfolio deviates from the aim portfolio, it may become optimal to trade the less liquid
Corporate portfolio more aggressively than the Treasury portfolio. Intuitively, if the economy does
transition to the H state, the Corporate portfolio will become much more expensive to trade, while
  5
      That is, the aim portfolio in the H-state puts zero weight on the L-state Markowitz portfolio.




                                                           3
the Treasury portfolio will remain relatively liquid.
      Our model also has implications for the popular (among practitioners) “risk-parity” strategy,
which weights each asset class in such a way that each contributes an equal amount of volatility to
the overall fund (see, e.g., Bridgewater (2011) and Asness, Frazzini, and Pedersen (2012)). Risk-
parity can be thought of as the mean-variance efficient portfolio, when all asset classes have equal
expected return and the correlations across asset classes are zero.6 Interestingly, even if it were
optimal to hold a risk-parity portfolio at all times in the absence of transaction costs, we show that,
when transaction costs and volatilities of various asset classes move over time in a correlated fashion,
then it is optimal to deviate significantly from the risk-parity portfolio and that this deviation is
larger in the low-risk regime. This is because the optimal portfolio in the low-risk regime, where
transaction costs tend to be lowest, needs to put some weight on the optimal risk-parity portfolio
in the high-risk regime, where high transaction costs will make it much more costly to delever out
of the higher risk asset classes.
      We present an empirical application of our framework in which a fund moves in and out of a
stock market index, taking into account time varying expected returns, volatility and transaction
costs. While our analytical results are all derived in the context of a regime-switching model of
price changes (e.g., a “normal” model for prices), we show that our model remains tractable for
a regime switching model of dollar returns (i.e., a “log-normal” model of prices). Since the latter
model fits the data empirically better, we use this framework for the empirical implementation. We
estimate a four state Markov regime switching model of returns and find, both in-sample and out
of sample, evidence of time variation in first and second moments. To estimate the transaction cost
parameters, we use a proprietary data set on realized trading costs incurred by a large financial
institution trading on behalf of clients, as measured by the implementation shortfall of their trades
(Perold 1988). We show that trading costs vary significantly across regimes, identified using the
(highest) smoothed probabilities of the regimes. Not surprisingly, trading costs are higher for higher
volatility regimes.
      We test our trading strategy both in-sample and out-of-sample. For the out-of-sample test, the
regime shifting model and the state probabilities are estimated using only data in the information
set of an agent on the day preceding the trading date. We compare the performance of our optimal
dynamic strategy to three alternatives: a constant dollar investment in the risky asset, correspond-
ing to an unconditional estimate of the sample mean and variance of returns, a buy-and-hold policy
that never trades and a myopic one-period mean-variance problem optimized for current transaction
costs, but that ignores the future dynamics of the Markov regime switching model.
      Our results show that the dynamic trading strategy significantly outperforms the other three
strategies in the presence of transaction costs. To determine the source of the outperformance,
we examine what source of time-variation leads to the biggest gains for the dynamic strategy.
Specifically, we compare the gains obtained from timing changes in expected returns, in volatility,
and in transaction costs. In this out-of-sample experiment, we find that the biggest benefits arise
  6
      These assumptions are sometimes justified based on the difficulty to reliably estimate means and correlations.




                                                           4
from taking into account for time variation in market volatility and transaction costs, while the
benefits from timing (estimated) variation in mean returns is more mixed. This reflects the fact
that mean returns move less than one-for-one with variances. Our findings here are consistent with
Moreira and Muir (2017), who show that there are gains to moving out of the market in response to
an increase in market variance because the conditional market risk-premium moves less than one-
for-one with its variance. Thus, since our model captures the time-variation in volatilities and the
corresponding changes in transaction costs more accurately, it is able to manage the risk-exposure
and the incurred transaction costs more reliably, which directly contributes to increasing the net
performance.
       There is large academic literature on portfolio choice that has extended Markowitz’s one period
mean-variance setting to dynamic multiperiod setting with a time-varying investment opportunity
set and more general objective functions.7 This literature has largely ignored realistic frictions such
as trading costs, because introducing transaction costs and price impact in the standard dynamic
portfolio choice problem tends to make it intractable. Indeed, most academic papers studying
transaction costs focus on a very small number of assets (typically two), limited predictability, and
typically no time-variation in second moments or transaction costs.8
       Balduzzi and Lynch (1999) and Lynch and Balduzzi (2000) investigate the impact of fixed and
proportional transaction costs on the utility costs and the optimal rebalancing rule of a single risky
asset with time-varying expected return, using dynamic programming. Lynch and Tan (2010) use a
numerical procedure to solve for the optimal portfolio choice of an investor with access to two risky
assets under return predictability and proportional transaction costs. Brown and Smith (2011)
discuss the high-dimensionality of the problem and provide heuristic trading strategies and dual
bounds for a general dynamic portfolio optimization problem with transaction costs and return
predictability that can be applied to larger number of stocks. Longstaff (2001) studies a numerical
solution to the one risky asset case with stochastic volatility when agents face liquidity constraints
that force them to trade absolutely continuously.
       Our paper is also related to the large literature on asset allocation under regime shifts. For
example, Ang and Bekaert (2002) apply regime switching model to an international asset allo-
cation problem to account for time-varying first and second moments of asset returns. Ang and
Timmermann (2012) survey this literature in detail. One common observation in empirical papers
estimating regimes is the low expected returns in high volatility states. Thus, these models would
often suggest that the mean-variance investors should scale down their equity exposure in times
of market stress. Our paper complements this literature by accounting for high transaction costs
during these volatile periods. Jang, Keun Koo, Liu, and Loewenstein (2007) extend the models
of Constantinides (1986) and Davis and Norman (1990) (e.g., one risky asset and one risk-free as-
   7
     Merton (1969), Merton (1971), Brennan, Schwartz, and Lagnado (1997), Kim and Omberg (1996), Campbell and
Viceira (2002), Campbell, Chan, and Viceira (2003), Liu (2007), Detemple and Rindisbacher (2010) and many more.
See Cochrane (2007) for a survey.
   8
     Constantinides (1986), Davis and Norman (1990), Dumas and Luciano (1991), Shreve and Soner (1994) study
the two-asset (one risky-one risk-free) case with i.i.d. returns. Liu (2007) studies the multi-asset case under CARA
preferences and i.i.d. returns. Cvitanić (2001) surveys this literature.



                                                         5
set) with regime-switching fundamental parameters. They consider a small investor with no price
impact and illustrate that proportional transaction costs may have first-order effect on liquidity
premia. In comparison, we consider a regime switching model in which an investor with price
impact can trade multiple risky assets.
        As noted earlier, our paper is most closely related to Litterman (2005) and Gârleanu and
Pedersen (2013, GP). They obtain a closed-form solution for the optimal portfolio choice in a model
where: (1) expected price change per share for each security is a linear, time-invariant function of
a set of autoregressive predictor variables; (2) the covariance matrix of price changes is constant;
(3) trading costs are a quadratic function of the number of shares traded, and (4) investors have
a linear-quadratic objective function. Their approach relies heavily on linear-quadratic stochastic
programming (see, e.g., Ljungqvist and Sargent (2004)). Our approach uses a similar objective
function, but allows for time-variation in means, volatilities, and transaction costs, albeit within
a regime-switching framework. Moreover, in contrast with the GP framework, our framework is
equally tractable when expected-price changes are constant in each state of the regime switching
model (i.e., prices follow arithmetic Brownian motion) or when expected returns, conditional on
the state, are constant (i.e., prices follow geometric Brownian motion). Since the latter is a more
realistic description of historical returns, it is the one we use for our empirical implementation.


2        A Regime Switching Model for Price Changes
We begin with a setting with N risky assets, in which the N -dimensional vector of price changes
from period t to t + 1, dSt , follows the process:

                                                                   E[dSt ] = µ(st )
                                    E[(dSt − µ(st ))(dSt − µ(st ))> ] = Σ(st )

µ(st ) and Σ(st ) are, respectively, the N -vector of expected price changes and the N × N covariance
matrix of price changes. Both µ and Σ are a function of a state variable st which follows a Markov
chain with transition probabilities πs,s0 . In Section 4, we will solve for the optimal dynamic strategy
when returns, rather than price change, follow this process.
        We consider the optimization problem of an agent with the following objective function:9

                                   ∞
                               "                                                              #
                                   X                         1 >            1
                       max E             ρt       n>                           >
                                                   t µ(st ) − γnt Σ(st )nt − ∆nt Λ(st )∆nt                            (1)
                        nt                                   2              2
                                   t=0

The agent chooses her holdings nt in each period t so as to maximize this objective function.
    9
    In the appendix, we provide two ways to micro-found this objective function. First, it corresponds to an agent who
maximizes her expected terminal wealth E[Wτ ] at some random horizon τ , drawn from an exponential distribution
with intensity − ln ρ, and who faces quadratic holding costs that are proportional to the variance of the position as well
as quadratic trading costs. Second, this corresponds to the certainty equivalent of an agent with source dependent
stochastic differential utility who has CARA aversion with risk-aversion coefficient γ towards return shocks and
vanishing risk-aversion γ2 → 0 towards regime-shifts.



                                                               6
Specifically, at the end of period t − 1, the agent hold nt−1 shares of the N assets. At this point the
agent observes the state st , and trades ∆nt = nt −nt−1 shares. As noted earlier, consistent with GP
we specify a linear price impact model. Λ(st ) is the price impact matrix, so the N -vector of price
concessions is Λ(st )∆nt and the total (dollar) cost of trading in period t is therefore 21 ∆n>
                                                                                              t Λ(st )∆nt .
We assume that Σs and Λs are real symmetric positive-definite matrices.10
       This objective function in equation (1) is the same as that considered by GP, namely that of an
investor who maximizes a discounted sum of mean-variance criterion in every period, net of trading
costs. In the absence of transaction costs (when Λs = 0), the optimal solution would be to hold the
conditionally mean-variance optimal Markowitz portfolio ms = (γΣs )−1 µs at all times. Further, if
there were no time-variation in the investment opportunity set (that is if µs and Σs were constant),
then it would be always optimal to hold the mean-variance efficient Markowitz portfolio. However,
when there are transaction costs and the opportunity set is time-varying, it becomes optimal for
the investor to rebalance the portfolio, and deviate from the conditionally mean-variance efficient
portfolio.
       In the GP framework, the conditional mean of stock price changes (µs ) follows an AR(1) process,
but the covariance matrix Σ and the matrix of transaction cost parameters Λ are required to be
time invariant. In our framework Σ and Λ vary across states. Using a Markov regime switching
model allows us to obtain tractable solutions even though the model is not in the standard linear
quadratic framework.
       For simplicity we begin by considering only a two-state Markov chain model, with states H
and L, but we generalize this to more states in Section 2.4. We will use the following notation
throughout: for all t where st = s ∈ {H, L}, st+1 = z ∈ {H, L} and s0 = {H, L} \ s. Then, using
the dynamic programming principle, the value function V (nt−1 , s) satisfies
                                                                                     
                                       >     1  >         γ >
              V (nt−1 , s) = maximize nt µs − ∆nt Λs ∆nt − nt Σs nt + ρE [Vt (nt , z)] .
                                nt           2            2

We guess the following quadratic form for our value functions:

                                                   1
                                       V (n, s) = − n> Qs n + n> qs + cs ,
                                                   2

where Qs is a symmetric N × N matrix and qs , cs are N dimensional vectors of constants for
s ∈ {H, L}. We now define the expectation conditional on state s for any matrix Ms to be
M s = πs,s Ms + πs,s0 Ms0 . With this notation, the right hand side of the HJB equation we are
optimizing can be rewritten as a quadratic objective:

                                               1
                                              − n> J s nt + n>
                                                             t js + ks
                                               2 t
  10
    Naturally we want θ> Λθ > 0 ∀ θ 6= 0. Further, we have θ> Λθ = 12 θ> Λθ + 21 (θ> Λθ)> = θ> ( 12 Λ + 21 Λ> )θ. So if Λ
is not symmetric we can replace it with 12 (Λ + Λ> ) which is.




                                                           7
where

                                      Js = γΣs + Λs + ρQs
                                      js = µs + Λs nt−1 + ρq s
                                             1
                                      ks = − nt−1 Λs nt−1 + ρcs
                                             2

This is optimized for nt = Js−1 js , that is :
                                                    −1
                            nt = γΣs + Λs + ρQs           (µs + ρq s + Λs nt−1 )

Further, the optimized value is simply 21 js> Js−1 js + ks . Thus matching coefficients we find that the
matrices Qs , qs for s = H, L must satisfy the system of equations:
                                                        −1
                               Qs = −Λs γΣs + Λs + ρQs      Λs + Λ s ,                              (2)
                                                      −1
                               qs = Λs γΣs + Λs + ρQs     (µs + ρq s ) .                            (3)

Note that given a solution for QH and QL , we can obtain qH and qL in closed-form as a matrix
weighted average of µH and µL . While we are not aware of a closed-form solution for QH and
QL in general, it is straightforward to obtain a numerical solution to the coupled Riccatti matrix
equation, as we discuss in Lemma 2 below. Further, for a variety of special cases we consider below,
it is possible to obtain closed-form solutions.
     With a solution in hand, we can define the conditional aim portfolio as the portfolio that
maximizes the value function at any time t conditional on the state. We can now characterize the
optimal trading rule and the aim portfolios.

Theorem 1 The optimal trade at time t in state s is a matrix weighted average of the current
position vector and the conditional aim portfolio:

                                       nt = (I − τs )nt−1 + τs aims                                 (4)

where the trading speed τs = I (and Qs = 0) if Λs = 0, and else τs = Λ−1
                                                                      s Qs ∀s = {H, L} where
(QH , QL ) solve a system of coupled equations:

                       I − Λ−1       −1                               −1
                            s Qs = [Λs (γΣs + ρπss0 Qs0 ) + I + ρπss Λs Qs ]
                                                                            −1
                                                                                                    (5)

     The aim portfolio, which maximizes the value function conditional on the current state, is given
by
                                                          −1
                                   aims = γΣs + ρQs             (µs + ρq s )                        (6)

     Further, the aim portfolio is a weighted average of the conditional Markowitz portfolios (ms =
(γΣs )−1 µs ):
                                aims = (I − αs )ms + αs ms0 ∀s = H, L                               (7)


                                                    8
where
                           αs = {(γ + ρπs0 s Qs0 Σ−1     −1
                                                                      0  0
                                                                           −1
                                                  s0 Qs Qs0 )Σs + ρπss Qs } ρπss Qs
                                                                                0   0



Proof. Optimizing the value function with respect to nt gives:

                                         aims = (Qs )−1 (qs ) ∀s = H, L

Substituting from the definitions in equations (2) and (3) we obtain:
                                       −1            −1                    −1              
            aims = −Λs γΣs + Λs + ρQs         Λs + Λ s       Λs γΣs + Λs + ρQs     (µs + ρq s )
                                     −1         −1                  −1
                 = − γΣs + Λs + ρQs        Λs + I       γΣs + Λs + ρQs     (µs + ρq s )
                             −1
                 = γΣs + ρQs     (µs + ρq s )

where the last equality obtains by noting that if we define the matrix
                                                    −1             −1                        −1
                        M = − γΣs + Λs + ρQs               Λs + I            γΣs + Λs + ρQs

then
                                                                         −1         
                 M −1 = γΣs + Λs + ρQs
                                                                                                   
                                                 − γΣs + Λs + ρQs                Λs + I = γΣs + ρQs ,
                                                           −1
which immediately implies that M = γΣs + ρQs                     .
      We then expand the expression for aims :

                     aims = (γΣs + ρπss Qs + ρπss0 Qs0 )−1 µs + ρQs
                                                                                 

             ⇒       (γΣs + ρπss Qs + ρπss0 Qs0 ) aims = (γΣs ms + ρπss Qs aims + ρπss0 Qs0 aims0 )
             ⇒       (γΣs + ρπss0 Qs0 ) aims = (γΣs ms + ρπss0 Qs0 aims0 )
             ⇒       aims = (γΣs + ρπss0 Qs0 )−1 (γΣs ms + ρπss0 Qs0 aims0 )

      We then substitute for aims0 = (γΣs0 + ρπs0 s Qs )−1 (γΣs0 ms0 + ρπs0 s Qs aims ) and obtain after
dividing by γ
                                                  
        ρ        
    Σs + πss0 Qs0 I − (γΣs0 + ρπs0 s Qs ) ρπs0 s Qs aims = Σs ms + ρπss0 Qs0 (γΣs0 + ρπs0 s Qs )−1 Σs0 ms0 .
                                         −1
        γ

Using the simple identity I − (F + G)−1 G = (F + G)−1 F , with F = γΣs0 and G = ρπs0 s Qs , we
finally obtain

           Σs + ρπss0 Qs0 [γΣs0 + ρπs0 s Qs ]−1 Σs0 aims = Σs ms + ρπss0 Qs0 [γΣs0 + ρπs0 s Qs ]−1 Σs0 ms0 .
       


Thus, this shows that we can write aims = (I − αs )ms + αs ms0 where

                                                                     −1
                 αs = Σs + ρπss0 Qs0 [γΣs0 + ρπs0 s Qs ]−1 Σs0            ρπss0 Qs0 [γΣs0 + ρπs0 s Qs ]−1 Σs0
                     



                                                           9
which can be further simplified to αs = {(γ + ρπs0 s Qs0 Σ−1     −1
                                                                              0  0
                                                                                   −1
                                                          s0 Qs Qs0 )Σs + ρπss Qs } ρπss Qs .
                                                                                        0  0




    Equation (4) shows that this optimal dynamic strategy is to trade to a portfolio with shares
nt that is a linear combination of the current portfolio nt−1 and of the aim portfolio aims . τs is
the matrix that specifies how quickly the investor should trade towards the aim portfolio. τs = I
means that, in state s, the investor should immediately and fully trade to aims . τs = 0 means that
the investor should not trade.
    The state-contingent aim portfolio aims is defined as the portfolio that would maximize the
value function in that state. Another interpretation of the aim portfolio is as the no-trade portfolio,
i.e., the portfolio for which the optimal trade is zero, as long as the state does not change.11 The
speed at which we trade towards the aim portfolio is, in general, dependent on the state. That is,
it is typically increasing in variance and decreasing in the transaction costs, which may be state
dependent in our framework. In the case (similar to GP) where only expected returns are stochastic
(and covariances and transaction costs are constant) the trading speed is constant as well. Further,
the aim portfolio is state dependent. When either a state is absorbing (πss = 1) or transaction
costs are zero (Λs = 0) then the aim portfolio is equal to the conditional mean-variance Markowitz
portfolio (ms ). But in general, the aim portfolio is a weighted average of the conditional mean-
variance portfolio across states, where the weight on each state is typically higher, if the variance
of returns or the transaction cost is higher in that state.
    We now consider a few special cases to gain further insights into the optimal trading rule.

2.1    The case where only µs changes with the state (GP)
If only µs changes with the state (i.e., if Σs = Σ and Λs = Λ for all s) then the solution Qs = Q is
independent of the state and satisfies:


                                     I − Λ−1 Q = [γΛ−1 Σ + I + ρΛ−1 Q]−1

This equation has an explicit solution as we show in the following lemma.12

Lemma 1 Consider the diagonalization of the matrix Λ−1 Σ = F diag(`i ) F −1 in terms of its
eigenvalues `i ∀i = 1, . . . , n. Then note that

                            I − F −1 Λ−1 QF = [γ diag(`i ) + I + ρF −1 Λ−1 QF ]−1
  11
     Note that, because the vector of security holdings n has units of shares, and because the price change process is
a function only of the state, the optimal portfolio will not change when prices change.
  12
     We note that since Σ, Λ are assumed to be symmetric matrices with (strictly) positive real eigenvalues, then
  −1
Λ Σ is diagonalizable. First, note that since Λ is real symmetric positive definite then so is its inverse. This implies
                              1   1                     1     1                                              1     1
we can decompose Λ−1 = M 2 M 2 . It follows that M 2 ΣM 2 is symmetric and positive definite (as x> M 2 ΣM 2 x =
    1         1
(M 2 x)> Σ(M 2 x) > 0 ∀x 6= 0 since Σ is positive definite) and therefore has positive real eigenvalues. In turn, it is
                                1   1                                 1     1
easy to show that Λ−1 Σ = M 2 M 2 Σ has the same eigenvalues as M 2 ΣM 2 .




                                                          10
It follows that Q = ΛF diag(ηi )F −1 such that the ηi solve the quadratic equations (∀i = 1, . . . , n):

                                        1 − ηi = [γ`i + 1 + ρηi ]−1

that is:                                             p
                                    ρ − 1 − `i γ +       (ρ − 1 − `i γ)2 + 4`i γρ
                             ηi =                                                 .
                                                           2ρ
    This implies that the trading speed τs = Λ−1
                                              s Qs = F diag(ηi )F
                                                                  −1 is independent of the state.

That is, investors trade at a constant speed towards their aim portfolio independent of the state.
The speed of trading for specific stock i is increasing in the agent’s time discount rate and in the
agent’s risk-aversion. Furthermore, for the special case where Λ and Σ are diagonal matrices, then
the speed of trading stock i is increasing in `i = Σii /Λii , that is the ratio of a stock’s variance to
its cost of trading.
    While the trading speed is constant, the aim portfolios differ across states. Indeed, using
Theorem 1, the aim portfolio in state s can be computed as:

                                       aims = (I − αs )ms + αs ms0

where

                              αs = {γΣ + ρπs0 s Q + ρπss0 Q}−1 ρπss0 Q
                                   = (γQ−1 Σ + (ρπs0 s + ρπss0 )I)−1 ρπss0
                                                                      
                                                       ρπss0
                                   = F diag                              F −1
                                              γ`i /ηi + ρπs0 s + ρπss0

The state s aim portfolio is a weighted average of the conditional Markowitz portfolios in the
current state (s) and in the alternative state (s0 ), where the weight on the current state Markowitz
portfolio is increasing in the persistence of that state πs,s and in risk-aversion γ, but decreasing in
the time discount factor ρ, and the persistence of the other state πs0 ,s0 . Furthermore, the weight is
also stock-specific and increasing for stock i in `i , which captures the notion that the more risky
a stock is relative to its trading cost the more weight we should put on the conditional Markowitz
portfolio for computing the aim portfolio.
    To a large extent these results are consistent with the findings of GP, albeit with a different
model of the time-variation in expected returns. The more interesting case is when we also allow
covariances and transaction costs to change across states. In that case, both trading speed and aim
portfolios change across states.

2.2     The case where ΛL = 0 and ΛH > 0
When transaction costs are zero in state L, then the solution implies QL = 0, and that QH solves
a one-dimensional equation:



                                                     11
                           I − Λ−1        −1               −1
                                H QH = [γΛH ΣH + I + ρπHL Λ QH ]
                                                                −1


   We note that this equation is identical to that obtained in the previous section with an adjusted
time discount rate (ρπHL ). It follows that the solution is

                                    QH = ΛH FH diag(ηH,i )FH−1 ,

where (`H,i , FH ) diagonalize the matrix Λ−1                    −1
                                           H ΣH = FH diag(`H,i )FH and the ηH,i are given by:
                                                p
                          ρπHL − 1 − `H,i γ +    (ρπHL − 1 − `H,i γ)2 + 4`H,i γρπHL
                 ηH,i =                                                             .
                                                   2ρπHL
   We can calculate the optimal trading speeds and the aim portfolios in both states. As discussed
earlier, in the L state where transaction costs are zero, it is optimal to move instantaneously to
the aim portfolio, that is τL = I. In contrast, in the high transaction cost state H, it is optimal
to trade slowly, with a trading speed τH = FH diag(ηH,i )FH−1 , towards the aim portfolio. The
aim portfolio in the high transaction cost state H is the conditional Markowitz portfolio, that is
aimH = mH = (γΣH )−1 µH . Intuitively, in the state H, the aim portfolio does not take into
account the investment opportunity set in the zero-transaction cost state L, because when the
economy transitions to state L the investor can immediately rebalance to the first best position at
zero cost. However, in the zero transaction cost state, the aim portfolio is a linear combination of
the two Markowitz portfolios mH and mL : aimL = (I − αL )mL + αL mH , where the weight put on
the H-state Markowitz portfolio is αL = [γΣL + ρπLH QH ]−1 ρπLH QH . To summarize, when there
are no transaction costs in the low state the optimal trading strategy is:



                                nH,t = (I − τH )nt−1 + τH mH
                                 τH = FH diag(ηH,i )FH−1
                                nL,t = aimL = (I − αL )mL + αL mH
                                 αL = [γΣL + ρπLH QH ]−1 ρπLH QH

2.3   The case with ΛL > 0 and ΛH = ∞
We now consider the polar case, where transaction costs are infinite in the H-state. Clearly, it is
then optimal not to rebalance in the high state. Following the derivation of our model, with no
rebalancing in the H-state, we see that the equation for QH simplifies to:

                                         QH = γΣH + ρQ̄H

In turn, this implies that the equation for QL becomes:




                                                   12
                                                         ρπLH
                      I − Λ−1        −1
                           L QL = [γΛL (ΣL +                    ΣH ) + I + ρL Λ−1
                                                                               L QL ]
                                                                                      −1
                                                       1 − ρπHH
                         ρπLH
with ρL = ρ(πLL +       1−ρπHH )   This equation admits an explicit solution as before, in terms of the
diagonalization of the matrix Λ−1
                               L (ΣL +
                                                 ρπLH
                                                1−ρπHH ΣH )    = FL diag(`L,i )FL−1 .
       It follows that the solution is QL = ΛL FL diag(ηL,i )FL−1 where the ηL,i are given by:
                                                       p
                                   ρL − 1 − `L,i γ +     (ρL − 1 − `L,i γ)2 + 4`L,i γρL
                          ηL,i =
                                                           2ρL
       Then the optimal trading strategy is:

                                 nH,t = nt−1
                                 nL,t = (I − Λ−1            −1
                                              L QL )nt−1 + ΛL QL aimL

                               aimL = (1 − αL )mL + αL mH
                                   αL = {(1 − ρπHH )Σ−1           −1
                                                     H ΣL + ρπLH } ρπLH


       To summarize, when transaction costs are infinite in state H it is clearly optimal to not rebalance
in that state. Instead, in state L, both the speed of trading and the aim portfolio depend on
the investment opportunity set in the H state. The aim portfolio puts more weight on the H-
conditional Markowitz portfolio the higher the probability to transition to that state (πLH ), the
more persistent the state is (πHH ), and the higher the variance of returns in that state relative to
the L-state (Σ−1
              H ΣL ). The trading speed on the other hand increases in both ΣH and ΣL as well
as the persistence of the low and high states.

2.4       The general case
For the general case, we need to solve the system of coupled matrix equations (5) for (QH , QL ):

                         I − Λ−1       −1                               −1
                              s Qs = [Λs (γΣs + ρπss0 Qs0 ) + I + ρπss Λs Qs ]
                                                                               −1



While we cannot solve the system in general, we observe that in the special case where the eigen-
vectors of the covariance and transaction cost matrices remain identical across states and only the
eigenvalues change, the system does admit a simple explicit solution. This is a ‘knife-edge case’ in
the general space of unconstrained matrices.13 Still, it is an interesting parametrization, as it nests
the special case where both the transaction cost and covariance matrices are diagonal with arbitrary
coefficients in all states. It also nests the special case considered in GP where the transaction cost
  13
    To understand the parameter restrictions, note that given that both transaction cost and covariance matrices
are symmetric positive definite they each would have n(n + 1)/2 free parameters (subject to the restriction that they
are positive definite). When we constrain all 4 (i.e., 2 in each state) matrices to have the same eigenvectors, then
the total number of free parameters become n(n + 1)/2 parameters for one matrix and only n parameters for the
other 3 matrices. Indeed, since the latter matrices inherit the eigenvectors of the first matrix, each has only n free
parameters, corresponding to their positive eigenvalues.




                                                         13
matrix is proportional to the covariance matrix, but here with possible state-dependent constants
of proportionality (i.e., where Λs = λs Σs and Σs0 = βΣs for some positive scalars β, λs , λs0 ). Also,
for the general case of unconstrained matrices that can be solved numerically, we propose a simple
and efficient algorithm to compute the solution.
    We summarize these results in the following

Lemma 2 If Λs = F diag(λi,s )F −1 and Σs = F diag(υs,i )F −1 ∀s = H, L then the solution of
the system of matrix equations (5) is Qs = Λs F diag(ηs,i )F −1 where ∀i = 1, . . . , n the constants
(ηH,i , ηL,i ) solve the system of coupled quadratic equations:

                            λi,s
                                   = γυi,s + ρπss0 ηi,s0 λi,s0 + λi,s + ρπss ηi,s λi,s
                          1 − ηi,s
    In general, when Σs , Λs do not have identical eigenvectors across states, then the solution to the
system of matrix equations (5) can be obtained by the following recursion.
    Given an initial (Qn−1  n−1                                                          −1
                       H , QL ), perform the eigenvalue decomposition (for s = H, L) of Λs (γΣs +
ρπss0 Qn−1                   −1            n                     −1 where the η
       s0 ) = Fs diag(`i,s )Fs . Then set Qs = Λs Fs diag(ηi,s )Fs              i,s solve the equation


                                     1 − ηi,s = [`i,s + 1 + ρπss ηi,s ]−1 ,

    that is:                                        p
                                ρπss − 1 − `i,s +       (ρπss − 1 − `i,s )2 + 4`i,s ρπss
                       ηi,s =                                                            ,
                                                          2ρπss
and iterate until convergence. It is natural to use as an initial guess for Q0s either the zero matrix,
or the solution corresponding to πss = 1.

We conjecture that the algorithm will be especially useful for large number of stocks, where iterating
over the N (N + 1) elements of the QL and QH matrices should be less efficient than iterating over
the 2N diagonal ηi,s elements. In our applications, we found that only three to five iterations are
sufficient to achieve convergence. Given a numerical solution of the QH and QL matrices, we can
analyze the optimal trading rule and aim portfolios.


3    Implications of the Model
In this section, we illustrate the insights of our model using two simple numerical experiments.
In the first application, we have two assets differing in their ranking of Sharpe ratios across two
states of the economy. We analyze the aim portfolio and trading speeds when each asset’s trading
cost is also state-dependent. In the second experiment, we analyze the sensitivity of the risk-parity
allocation strategy to stochastic trading costs.




                                                        14
Table 1: Parameter Values for Numerical Experiments 1 and 2. This table reports the parameter values
used in the numerical experiments described in Section 3.1 and 3.2. Trading is daily, and reported values of
µ and Σ are annualized.
                  Experiment 1 (Corporate Bonds)           Experiment 2 (Risk-parity)
                  Parameter         Value                 Parameter        Value
                         γ               10−8                  γ              10−8
                         ρ              0.9996                 ρ             0.9996
                     πLL                 0.95                πLL              0.95
                     πHH                  0.9                πHH               0.9
                                                                             
                                          10                                    1
                      µL                                       µL
                                         8                                  1 
                                          12                                    1
                      µH                                     µH
                                      16                                     1    
                                       100 50                              100 0
                      ΣL                                     ΣL
                                      50 100                             0 900 
                                       900 450                             400     0
                      ΣH                                     ΣH
                                       450 900                              0 3600
                                  1.25 × 10−8
                                                     
                                                  0
                      ΛL                                      ΛL          5 × 10−8 ΣL
                                      0       10−8 
                                    Variable    0
                      ΛH                                     ΛH         (Variable) ηΣH
                                       0      10−8



3.1    Corporate Bonds vs. Treasuries
To illustrate the implications of the model, we consider a case with two assets and two states: Low-
risk (L) and High-risk (H). In the low-risk state, Asset 1 (e.g., “Corporate”) has higher Sharpe
ratio than Asset 2 (e.g., “Treasury”). However, in the high-risk state, Asset 2 has higher Sharpe
ratio. In both states, Asset 2 is cheaper to trade than Asset 1. We assume that both assets are
positively correlated.
   Table 1 shows a simple calibration for this example. We assume that the initial price for the
assets are $100, e.g., Asset 1 has an annual expected price change of $10 in the L-state and its
volatility is $10 in this state. Trading frequency is daily.
   In the right panel of Figure 1 we plot the conditional Markowitz portfolios. In the left panel,
we plot the aim portfolios in both states as we vary the transaction costs of the first asset in the
high-risk state. The minimum value is 1.25 × 10−8 and can go up to 2 × 10−7 . We see that the aim
portfolio in the high state is always very close to the Markowitz portfolio. Intuitively, since price
impact is very small in the low-risk state, the aim portfolio in the high-risk state needs not take
into account the investment opportunity set in the low-risk state. Instead, in the low-risk state,
as we increase price impact of Asset 1 in the high-risk state, the aim portfolio varies dramatically.
It weighs more and more heavily the Markowitz portfolio in the high-risk state, thus lowering the


                                                    15
                               8000                                                                                               8000
                                                                    Asset 1, High Risk                                                                  Asset 1, High Risk
                               7000                                 Asset 2, High Risk                                            7000                  Asset 2, High Risk




                                                                                              Markowitz Portfolio ('000 Shares)
                                                                    Asset 1, Low Risk                                                                   Asset 1, Low Risk
 Aim Portfolio ('000 Shares)


                                                                    Asset 2, Low Risk                                                                   Asset 2, Low Risk
                               6000                                                                                               6000

                               5000                                                                                               5000

                               4000                                                                                               4000

                               3000                                                                                               3000

                               2000                                                                                               2000

                               1000                                                                                               1000

                                 0                                                                                                  0
                                      0       0.5         1         1.5                   2                                              0   0.5   1    1.5                   2
                                                         TC                              -7                                                        TC                        -7
                                                                                    10                                                                                  10


                                          Figure 1: Aim and Conditional Markowitz Portfolios for Numerical Experiment 1



desired position in Asset 1 and increasing the desired position in Asset 2. Eventually, for high
enough expected trading costs of Asset 1 in the H-state it becomes optimal to hold more of Asset 2
even in the low-risk state. That is, it is optimal to hold more of the asset that appears dominated
in Sharpe ratio terms in the L-state preemptively to anticipate the future desired deleveraging in
the H-state.
                               Figure 2 plots the corresponding trading speeds in both assets in both regimes.14 Intuitively,
we see that the trading speed is generally higher in the high-risk regime due to the higher tracking
error cost. However, as it becomes more costly to trade Asset 1 in that regime, its trading speed
drops rapidly. Interestingly, the trading speed of Asset 1 actually increases in the Low-risk regime
in response to the increase of its trading cost in the high-risk regime. That is even though Asset
1 has a marginally higher trading cost than Asset 2 in the low-risk regime, it is optimal to trade
it more aggressively than Asset 2 in the low-risk regime in anticipation of its much higher trading
cost in the high-risk regime.
                               This example captures some salient features of the Corporate versus Treasury bond returns.
Like Asset 1, Corporate bonds typically offer higher expected rates of returns in expansions (good
states) than Treasury bonds (Asset 2). However, during recessions (bad states) their risk increases
dramatically and the higher probability of default leads to lower returns.15 Further, it is also a fact
that corporate bonds become a lot costlier to trade in bad states than Treasuries, whose liquidity
remains very high. As the stylized example demonstrates, because it is optimal to reduce the
position in the Corporates in the high-risk state when these are very costly to trade, it can be
optimal to hold a larger share of the Treasuries already in the good state even though in that state
  14
     For simplicity, we only plot the diagonal values of the trading speed matrix Λ−1s Qs , which is actually not diagonal
in this example.
  15
     Of course, it is arguable whether the expected return is actually lower, since expected returns are hard to measure.
For illustration we assume that in the bad states the risk of Asset 1 is higher and its Sharpe ratio is lower than that
of Asset 2.



                                                                                         16
                                               0.9


                                               0.8


                                               0.7




                               Trading Speed
                                               0.6


                                               0.5


                                               0.4
                                                         Asset 1, High Risk
                                                         Asset 2, High Risk
                                               0.3
                                                         Asset 1, Low Risk
                                                         Asset 2, Low Risk
                                               0.2
                                                     0          0.5                1   1.5         2
                                                                               TC                 -7
                                                                                             10


                                Figure 2: Trading Speed for numerical experiment 1



the conditional Sharpe ratio of Corporates dominates that of Treasuries. Further, even though
Corporates may be more costly to trade than Treasuries in the good state, it may be optimal to
trade them more aggressively in the good state in anticipation of the high-risk regime with much
higher relative trading costs.
      This example helps also to think about the question: in a portfolio with liquid and illiquid assets,
which one should one liquidate first because of a liquidity shock? Our analysis gives the following
answer. First and foremost, one should trade the illiquid asset more aggressively in anticipation
of the future liquidity crisis and steer the portfolio to a position that overweights liquid assets,
possibly deviating from the unconditional optimal portfolio to take into account the future possible
risk and liquidity shocks. Second, once the crisis hits, one should trade less aggressively the more
costly assets and more aggressively the liquid assets to steer the portfolio towards the conditional
mean-variance efficient portfolio.

3.2      Risk-parity Allocation Strategy
The risk-parity allocation strategy has received a lot of attention among practitioners, not the least
because it is applied in the very successful “All-weather” fund of Bridgewater. As a rational for
such a strategy, it is sometimes argued that such a strategy reflects the difficulty in measuring
expected returns of and correlations between asset classes. With all expected price changes equal
and constant (e.g., µ = 1) and all correlation coefficients equal to zero, the mean-variance efficient
Markowitz portfolio becomes an risk-parity portfolio in the sense that every asset contributes an
identical amount of volatility to the overall portfolio (ms = (γΣs )−1 1 = diag( γυ1i,s )).16 Here we
illustrate that it is actually optimal to deviate from the risk-parity allocation under these same
assumptions, if transaction costs of various asset classes move predictably with their volatility.
 16
      See (Asness, Frazzini, and Pedersen 2012) for further discussion.



                                                                              17
                               1000                                                                                                      1000
                                                                     Safe Asset, High Risk                                                                            Safe Asset, High Risk
                               900                                   Risky Asset, High Risk                                              900                          Risky Asset, High Risk




                                                                                                   All-weather Portfolio ('000 Shares)
                                                                     Safe Asset, Low Risk                                                                             Safe Asset, Low Risk
                               800                                                                                                       800
 Aim Portfolio ('000 Shares)


                                                                     Risky Asset, Low Risk                                                                            Risky Asset, Low Risk

                               700                                                                                                       700

                               600                                                                                                       600

                               500                                                                                                       500

                               400                                                                                                       400

                               300                                                                                                       300

                               200                                                                                                       200

                               100                                                                                                       100

                                 0                                                                                                         0
                                      0   0.2      0.4         0.6           0.8               1                                                0   0.2   0.4   0.6           0.8               1
                                                                                              -6                                                                                               -6
                                                                                         10                                                                                               10


                                                         Figure 3: Aim portfolios for numerical experiment 2



With Σs = diag(υi,s ) and Λs = diag(λi,s ) and µs = 1, we can solve for the optimal aim portfolio in
closed-form from Lemma 3 with F = diag(1).
                               We illustrate in Figure 3 how the aim portfolio in state s can deviate from the equal risk portfolio
as transaction costs in state s0 increase. Comparing the left panel to the right panel, we see that in
the high-risk state, the aim portfolio remains very close to the risk-parity portfolio. This is because
the risk-parity portfolio is the conditional Markowitz portfolio in state s under our assumptions
and we need not take into account the low-risk state, since rebalancing is expected to be much less
costly then. However, in the low-risk state, it is optimal to deviate dramatically from the equal-risk
weights. Indeed, we need to lower considerably the target position in both assets, but especially
in the high-risk asset, in anticipation of the future increase in volatility and in the cost of trading
that asset, in case of a switch to the high-risk state.
                               Trading speeds for all assets are plotted in Figure 4. As we can see, trading speed decreases
in the high-risk state and increases in the low-risk state when transaction costs in the high-risk
state are increasing. That is the more costly it becomes to trade assets in the H-state, the more
aggressively we have to trade assets in the low-risk state. We note that trading speeds are not
security specific in this experiment, because we assume that the price impact matrix is a constant
multiple of the covariance matrix.


4                                A Regime Switching Model for Returns
Following much of the literature (e.g., GP, Litterman), the model in the earlier section assumes
that conditional on a state, the expectation and covariance matrix of price changes are constant.
This leads to a very tractable solution, because in a mean-variance framework the only motive
to rebalance the portfolio conditional on holding the mean-variance efficient portfolio, is if there
is a change in the state, that is if there is a change in the expectation or covariance matrix of


                                                                                              18
                                             0.6


                                             0.5


                                             0.4




                             Trading Speed
                                                                                   Safe Asset, High Risk
                                                                                   Risky Asset, High Risk
                                             0.3
                                                                                   Safe Asset, Low Risk
                                                                                   Risky Asset, Low Risk

                                             0.2


                                             0.1


                                              0
                                                   0   0.2      0.4          0.6           0.8               1
                                                                                                            -6
                                                                                                       10


                             Figure 4: Trading Speeds for numerical experiment 2



price changes. Unfortunately, it is not a very plausible model for returns empirically, as it assumes
counterfactual dynamics for the return covariances. Mei, DeMiguel, and Nogales (2016) document
that the assumption of stationary price changes is reasonable with short-term horizons of up to
one year. Empirically, the “conditional log-normal” model of price changes is preferable to the
“conditional normal” model assumed in this section. Interestingly, in our framework the “log-
normal” model, which assumes that the expectation and covariance matrix of dollar returns is
constant in a given state, is very tractable as well.
    In this section, we present a regime switching model formulated in dollars and returns as opposed
to price changes and number of shares. In our empirical analysis in Section 5 we apply this model
to timing the market portfolio while accounting for time-varying transaction costs and stochastic
volatility.

4.1    Formulation
We have N risky assets and collect the N -dimensional vector of returns from period t to t + 1 in
         dSt
rt+1 ≡    St .   The net return vector has the following state-dependent mean and covariances:

                                                                           E[rt+1 ] = µ(st )
                                              E[(rt+1 − µ(st ))(rt+1 − µ(st ))> ] = Σ(st )

µ(st ) and Σ(st ) are, respectively, the N -vector of expected returns and the N ×N covariance matrix
of returns. Both µ and Σ are a function of a state variable st which follows a Markov chain with
transition probabilities πs,s0 .
    Since the model is set-up in dollars, the investor rebalances at the end of each period again in
dollars. If the dollar trade vector is given by ut , then, the dollar holdings of the investor has the



                                                                      19
following dynamics:

                                          xt+1 = diag(1 + rt+1 )xt + ut+1                                         (8)
                                                    = diag(Rt+1 )xt + ut+1                                        (9)

where the gross returns are given by Rt+1 .
       We consider the optimization problem of an agent with the following objective function with
an infinite investment horizon:17
                          "∞                                                  #
                            X
                                  t−1    >         1 >            1 >
                    max E       ρ       xt µ(st ) − γxt Σ(st )xt − ut Λ(st )ut                                   (10)
                     xt                            2              2
                                    t=1

The agent chooses her dollar holdings xt in each period t so as to maximize this objective function.
Specifically, at the end of period t−1, the agent holds xt−1 dollars. At this point the agent observes
the state st , and trades ut dollars to bring his dollar holdings to diag(Rt )xt + ut . We again consider
a linear price impact model. The total (dollar) cost of trading ut is 21 u>
                                                                          t Λ(st )ut .


4.2       Value Functions and Optimal Portfolio
For simplicity, we consider a two-state Markov chain model, with states H and L. The model
is straightforward to generalize to multiple states. In our empirical application in Section 5 we
consider two-state and four-state models. Using the dynamic programming principle, the value
function V (xt−1 , Rt , st ) satisfies
                                                                                              
                                     >    1 >        γ >
           V (xt−1 , Rt , s) = max xt µs − ut Λs ut − xt Σs xt + ρEt [V (xt , 1 + µs + s , z)] ,
                                xt        2          2

where E [s ] = 0 and E s >
                             
                            s = Σs . We guess the following quadratic form for our value functions:

                                        1
                         V (x, R, s) = − x> diag(R)Qs diag(R)x + x> diag(R)qs + cs ,
                                        2

where Qs is a symmetric N × N matrix and qs , cs are N dimensional vectors of constants for
s ∈ {H, L}. We can now simplify Et [V (xt , 1 + µs + s , z)] using the assumed structure for the
value functions and write it in the form of − 21 x>          >
                                                  t As xt + xt bs + ds where


                       Zs = E[(1 + µs + s ) (1 + µs + s )> ] = Σs + (1 + µs ) (1 + µs )> ,
                       As = πs,s (Zs ◦ Qs ) + πs,s0 (Zs ◦ Qs0 ),
                        bs = πs,s (µs ◦ qs ) + πs,s0 (µs ◦ qs0 ),
                       ds = πs,s cs + πs,s0 cs0 ,
  17
       In the appendix, as discussed in footnote 9 we provide two ways to micro-found this objective function.




                                                             20
and ◦ denotes element-wise multiplication. Using this expression for Et [V (xt , 1 + µs + s , z)], we
obtain
                              n        1                                                   γ
      V (xt−1 , Rt , s) = max x>t µs −    (xt − diag(Rt )xt−1 )> Λs (xt − diag(Rt )xt−1 ) − x> Σs xt
                           xt          2                                                   2 t
                          ρ                        o
                        − x>  As xt + ρx>
                                        t bs + ρds ,
                          2 t

Thus, we maximize the quadratic objective − 12 x>          > s
                                                t Js xt + xt jt + ks where we define


                             Js = γΣs + Λs + ρAs
                             js = Λs diag(Rt )xt−1 + µs + ρbs
                                    1
                             k s = − x>   diag(Rt )Λs diag(Rt )xt−1 + ρds
                                    2 t−1

Then, the optimal xt when the state is s is given by Js−1 js . That is to say

                       xt = (γΣs + Λs + ρAs )−1 (Λs diag(Rt )xt−1 + µs + ρbs ) .                       (11)

The value achieved at the optimal solution is given by 12 js> Js−1 js + ks and we obtain the following
coupled matrix equations:

                       Qs = −Λs (γΣs + Λs + ρAs )−1 Λs + Λs ,                                          (12)
                       qs = Λs (γΣs + Λs + ρAs )−1 (µs + ρbs ) ,                                       (13)
                            1
                       cs = (µs + ρbs )> (γΣs + Λs + ρAs )−1 (µs + ρbs ) + ρds .                       (14)
                            2

Overall, these equations are very similar to those obtained in the previous section for the regime
switching model of price changes. The main difference is the need to introduce the matrices As
and bs which are non-linear transformations of Qs and qs . We solve for Qs and qs iteratively from
equations (12) and (13) respectively. We use the zero matrix for Qs and the zero vector for qs as
initial guesses. Convergence is obtained very rapidly in all of our implementations.

4.3      Aim Portfolio and Trading Speed
Following our analysis in the previous section, we define the aim portfolio in each state, aims , as
the portfolio at which it would be optimal not to rebalance given the current state s. The following
lemma characterizes the aim portfolio and the trading speed.

Lemma 3 The conditional aim portfolio aims at which it is optimal not to rebalance is given by

                                   aims = (γΣs + ρAs )−1 (µs + ρbs )

It maximizes the value function V (xt−1 , Rt , s) with respect to xt−1 diag(Rt ).



                                                   21
   The optimal trading rule is to “trade partially towards the aim” at the trading speed τs = Λ−1
                                                                                               s Qs :


                                xs = (I − τs ) diag (Rt ) xt−1 + τs aims

Proof. Maximizing the value function at time V (xt−1 , Rt , s) with respect to diag (Rt ) xt−1 we
obtain:
                                              aims = Q−1
                                                      s qs

Substituting from the definitions in equations (12) and (13) we obtain:
                                                 −1                                     
          aims = −Λs (γΣs + Λs + ρAs )−1 Λs + Λs        Λs (γΣs + Λs + ρAs )−1 (µs + ρbs )
                                             −1
               = − (γΣs + Λs + ρAs )−1 Λs + I     (γΣs + Λs + ρAs )−1 (µs + ρbs )

               = (γΣs + ρAs )−1 (µs + ρbs )

where the last equality obtains by noting that if we define the matrix
                                                     −1
                     M = − (γΣs + Λs + ρAs )−1 Λs + I     (γΣs + Λs + ρAs )−1

then                                                              
              M −1 = (γΣs + Λs + ρAs ) − (γΣs + Λs + ρAs )−1 Λs + I = (γΣs + ρAs ) ,

which immediately implies that M = (γΣs + ρAs )−1 .
   To prove the second part of the lemma, we start from the definition of the optimal position xt
given in equation (11). It is straightforward to obtain the optimal trade

                          xt − diag(Rt )xt−1 = Λ−1
                                                s (γΣs + ρAs )(aims − xt ).


Using the definition of matrix M above and equation (12), we obtain the formula for the trading
speed.

4.4      Difference between Two Models
Figure 5 compares aim portfolios and trading speeds in models set-up in shares and dollars. We
calibrate the model to a share price worth one dollar so that the y-axis represents the dollar
investment of both strategies (that is number of shares invested equal number of dollars invested).
Table 2 displays all of the model parameters. We see that the aim portfolio in the regime switching
model of price changes always invests a larger position in the risky asset than the aim portfolio
for the regime switching model of returns. The difference is larger the larger the expected return
on the stock. The intuition is that when we rebalance at time t in the return model, the dollar
position will be affected by the risky return (see equation (8)), before we get to rebalance. Thus,
the aim portfolio in dollars reflects the expected dollar position after the risky one period return is



                                                   22
                          10 9
                 18
                                                                                                0.16
                                 Shares
                                                                                                           Shares
                 16              Dollars
                                                                                                           Dollars
                                                                                                0.15
                 14

                 12                                                                             0.14
 Aim Portfolio




                                                                                Trading Speed
                 10
                                                                                                0.13
                  8

                  6                                                                             0.12

                  4
                                                                                                0.11
                  2

                  0                                                                              0.1
                      0            0.01     0.02      0.03      0.04     0.05                          0     0.01    0.02      0.03    0.04          0.05
                                            Expected Return                                                          Expected Return


                                 Figure 5: Aim portfolios and trading speeds in models set-up in shares and dollars.



realized.
                 We also observe that the trading speed is higher for the regime-switching-model of returns than
for that of price changes. This is because, in the regime-switching model of returns, there is an
additional “rebalancing motive” for trading, as dollar positions drift away from their target as a
result of return shocks (even in the absence of any change in the investment opportunity set).


5                     Empirical Application
In this section, we implement our methodology using the modeling framework in dollars and il-
lustrate that there are economically significant benefits using our approach both in-sample and
out-of-sample.

5.1                       Model Calibration
We use daily value weighted CRSP market returns from 1967 Q3 to 2017 Q2 (50 years) to estimate
a regime switching model. The data is downloaded from Ken French’s data library.
                 Guidolin and Timmermann (2006) consider a range of values for the number of states and find
that a four-state regime model performs better in explaining bond and stock returns. Following
this study, we estimate a Markov switching model with four states to describe the dynamics of
market returns:

                                                              rt+1 = µ(st ) + σ(st )t+1                                                      (15)

where st = {1, 2, 3, 4} and t+1 are serially independent and drawn from standard normal distribu-
tion. State transitions occur according to a Markov chain and we denote by Pij the probability of



                                                                         23
                                           Table 2: Parameter Values
                                          Parameter           Value
                                               γ             5 × 10−8
                                               ρ              0.9996
                                              πLL              0.98
                                             πHH               0.9
                                                                
                                              µL                0
                                              µH           (Variable)
                                                          0.40 × 10−4
                                                                        
                                              ΣL
                                                          3.33 × 10−4
                                                                        
                                              ΣH
                                                             2 × 10−10
                                                                      
                                              ΛL
                                                             3 × 10−10
                                                                      
                                              ΛH




switching from state i to state j.18
    Table 3 displays the estimates of the model. All coefficients are statistically significant at 1%
level. Overall, we observe that the rank correlation between the estimated expected returns and
volatilities is not equal to 1. We observe that the expected return can be lower in a high volatility
state. This pattern has been found since the initial applications with regime switches on equity
returns (see e.g., Hamilton and Susmel (1994)).
    The top two panels in Figure 6 illustrate the corresponding smoothed probabilities for each
regime and the bottom panel in Figure 6 illustrates the color-coded regimes by using the maximum
smoothed probability for identification. The first regime (green) highlights the good states of the
return data with high return and low volatility corresponding to the highest Sharpe ratio. This
regime has also the highest expected duration with roughly 51 trading days. The transition from
this state usually occurs to the second state (blue) with slightly lower expected return and higher
volatility. The expected duration for this state is 30 trading days. The third state (yellow) is a
distressed state with low expected return and high volatility. This state has the lowest Sharpe ratio
and has an expected duration of approximately 33 trading days. The final state covers the crisis
periods with very high expected return and very high volatility. We observe that it covers trading
days around the 1987 crash, the dot-com bubble and the financial crisis. This state is relatively
short-lived with an expected duration of roughly 15 trading days.
  18
     To restrict the number of parameters, we have also tried fitting a four-state model that constrains the general
model to having only two mean and volatility coefficients (i.e., mean or volatility may remain unchanged after a
transition) as opposed to four but this constrained model can be rejected with a likelihood test.




                                                        24
Table 3: Parameter estimates for a four-state regime switching model using daily market return data from
1967 Q3 and 2017 Q2.
                              Parameter   Estimate        Parameter   Estimate
                                  µ1      0.0864%            σ1       0.5512%

                                  µ2      0.0340%            σ2       0.9372%

                                  µ3      0.0069%            σ3       1.6032%

                                  µ4      0.2939%            σ4       3.9178%

                                 P11       0.9804            P12       0.0196

                                 P13       0.0000            P14       0.0000

                                 P21       0.0250            P22       0.9670

                                 P23       0.0080            P24       0.0000

                                 P31       0.0000            P32       0.0233

                                 P33       0.9693            P34       0.0074

                                 P41       0.0016            P42       0.0000

                                 P43       0.0635            P44       0.9350




5.2   Calibration of the Transaction Costs
To calibrate the transaction cost multipliers of our model realistically, we use proprietary execution
data from the historical order databases of a large investment bank. The orders primarily originate
from institutional money managers who would like to minimize the costs of executing large amounts
of stock trading through algorithmic trading services. The data consists of two frequently used
trading algorithms, volume weighted average price (VWAP) and percentage of volume (PoV). The
VWAP strategy aims to achieve an average execution price that is as close as possible to the volume
weighted average price over the execution horizon. The main objective of the PoV strategy is to
have constant participation rate in the market along the trading period.
   The execution data covers S&P 500 stocks between January 2011 and December 2012. Execution
duration is greater than 5 minutes but no longer than a full trading day. Total number of orders
is 81,744 with an average size of approximately $1 million. The average participation rate of the
order, the ratio of the order size to the total volume realized in the market, is approximately 6%.
Table 4 reports further summary statistics on the large-order execution data.
   According to our quadratic transaction cost model, trading q dollars in state j would cost the
investor λj q 2 . Since each of our executions are completed in a day, we can uniquely label each
execution originating in one of the four states by setting it to the state with maximal smoothed
probability. With this methodology, we find that 22,946 executions are in regime 1, 41,898 execu-



                                                     25
Table 4: Summary statistics for the main attributes in the execution data. Participation rate is equal to the
ratio of the executed volume to total volume during the lifetime of the order. The volatility of the asset is
estimated using the mid-quote prices. Order duration is expressed as a fraction of full trading day (i.e., 6.5
hours).
         Statistic              Mean        Min        Pctl(25)      Median    Pctl(75)      Max
         Order Value ($ M)      0.967      0.001           0.094      0.396     1.102      158.300
         Participation Rate     0.061     0.00001          0.002      0.013     0.102       1.000
         Volatility             0.014      0.0002          0.008      0.011      0.016      0.344
         Order Duration         0.384      0.013           0.041      0.153      0.851      1.000
         IS (bps)               4.095    -1006.000        -16.440     4.075     25.080     996.600



tions in regime 2, 14,502 executions in regime 3 and 2,398 in regime 4. Compared to other states,
regime 4 has relatively small number of executions due to its short-lived nature. At first sight, it
is surprising that we have the largest number of executions in regime 2. But, during the 2011-2012
period, the volatility was relatively high so there are actually fewer trading days in regime 1 (see
Figure 6).
   Our execution data has information on both the order size and total trading cost. Total trading
cost is computed by comparing the average price of the execution to the prevailing price in the
market before the execution starts. This is usually referred to as implementation shortfall (IS)
(Perold 1988). Formally, IS of the ith execution is given by

                                                          Piavg − Pi,0
                                        ISi = sgn (Qi )                ,                                 (16)
                                                              Pi,0

where Qi is the dollar size of the order (negative if a sell order), Piavg is the volume-weighted
execution price of the parent-order and Pi,0 is the average of the bid and ask price at the start-time
of the execution. Thus, total trading cost in dollars is equal to ISi × Qi . According to our model,
this is given by λm(i) Q2i where m(i) maps the ith execution to the state of the trading day. Thus,
we can estimate λj for each state by fitting the following model:

               ISi = λ1 Qi 1{m(i)=1} + λ2 Qi 1{m(i)=2} + λ3 Qi 1{m(i)=3} + λ4 Qi 1{m(i)=4} + εi

   Table 5 illustrates the estimated coefficients. The reported standard errors are clustered at
the stock and calendar day level. We observe that λ estimates are all highly significant (except in
state 4 where we observe fewer executions in our data-set) and vary a lot across regimes and tend
to increase with volatility. We find that λ3 is the largest across all states. Recall that this state
has the lowest Sharpe ratio and thus can be interpreted as the distressed state. Using Wald tests
pairwise, we find that the estimate of transaction costs in this distressed state, λ3 , is statistically
higher than all other coefficients at a 10% significance level.
   To better understand the variation in transaction costs across our states, we present in Table 6
the average values of various liquidity proxies in each state. We find that bid-ask spreads, mid-quote



                                                     26
Table 5: Transaction cost estimates in each regime labeled from the four-state regime switching model.
λn denotes the transaction cost multiplier in regime n. The second column reports the results from a
liquid subset in which we only include executions from stocks within the top 10% in market capitalization.
Estimated values are multiplied by 1010 . Standard errors are double-clustered at the stock and calendar day
level.
                                                         Dependent variable: IS
                                                      All Stocks       Liquid
                                      λ1              1.688∗∗∗                0.501∗∗
                                                       (0.459)                (0.217)

                                      λ2              1.725∗∗∗                0.793∗∗∗
                                                       (0.195)                 (0.189)

                                      λ3              3.037∗∗∗                1.506∗∗∗
                                                       (0.418)                 (0.352)

                                      λ4                   2.274               0.935
                                                          (1.927)             (1.329)


                                                      ∗            ∗∗             ∗∗∗
                                      Note:               p<0.1;        p<0.05;         p<0.01


volatility and turnover are increasing across states, i.e., volatility. However, the Amihud illiquidity
proxy returns similar ranking to the estimated λ coefficients with state 3 being more illiquid than
state 4. Since volume is much larger in that state, it may act as a mitigating factor on trading
costs (see e.g., Admati and Pfleiderer (1988) and Foster and Viswanathan (1993)).
   Since we would like to estimate the price impact of trading the market portfolio, our estimates
may be overestimating the cost as it is based on the complete set of S&P 500 stocks. In order to
address this issue, we rerun our regressions only using data corresponding to the top 10% of stocks
with respect to market capitalization. We believe that this universe of stocks reflect a more natural
comparison to the market portfolio.
   The second column of Table 5 illustrates the estimated coefficients for this liquid universe. We
observe that the coefficients are lower by a factor between two and three but preserve the same
ranking across states. In this case, λ3 is statistically different than the coefficients of the first and
second state at 10% significance level. The second panel of Table 6 illustrates the average values
of each liquidity proxy in each regime using this universe of large-cap stocks.

5.3    Objective function
We use the regime switching model based on dollar holdings and returns presented in Section 4 as
the investment horizon is very long. Formally, the investor’s objective function is:

                                    ∞
                                "                                                               #
                                    X                         1           γ
                            E             ρt       xt µ(st ) − λ(st )u2t − σ 2 (st )x2t                (17)
                                                              2           2
                                    t=0




                                                                    27
Table 6: Average liquidity proxies in each regime. The second column reports the averages from a liquid
subset in which we only include executions from stocks within the top 10% in market capitalization. Standard
errors are double-clustered at the stock and calendar day level.

                                        All Stocks                                               Liquid
             Spread            Volatility        Turnover   Amihud          Spread    Volatility     Turnover       Amihud
                                                                   −8
              (bps)               (%)                       (×10        )   (bps)        (%)                        (×10−8 )
   1         3.80∗∗∗            1.11∗∗∗           3.51∗∗∗   1.37∗∗∗         2.89∗∗∗    1.01∗∗∗        2.93∗∗∗       0.47∗∗∗
              (0.04)             (0.02)            (0.12)    (0.06)          (0.03)     (0.02)         (0.11)        (0.02)

   2         3.95∗∗∗            1.23∗∗∗           3.58∗∗∗   1.59∗∗∗         2.98∗∗∗    1.13∗∗∗        3.02∗∗∗       0.55∗∗∗
              (0.04)             (0.02)            (0.13)    (0.06)          (0.03)     (0.02)         (0.10)        (0.02)

   3         4.95∗∗∗            1.92∗∗∗           4.27∗∗∗   1.97∗∗∗         3.52∗∗∗    1.77∗∗∗        3.63∗∗∗       0.67∗∗∗
              (0.09)             (0.06)            (0.20)    (0.08)          (0.07)     (0.06)         (0.19)        (0.04)

   4         5.62∗∗∗            2.84∗∗∗           7.37∗∗∗   1.80∗∗∗         3.97∗∗∗    2.59∗∗∗        6.42∗∗∗       0.59∗∗∗
              (0.39)             (0.28)            (2.07)    (0.34)          (0.27)     (0.25)         (1.07)        (0.12)


             ∗            ∗∗             ∗∗∗
   Note:         p<0.1;        p<0.05;         p<0.01


where xt = xt−1 (1 + rt ) + ut and st ∈ {1, 2, 3, 4}. We calibrate ρ so that the annualized discount
rate is 1%. We set γ = 1 × 10−10 which we can think of as corresponding to a relative risk aversion
of 1 for an agent with $10 billion dollars under management. We assume that the investor starts
from zero holdings and rebalances daily.
   The optimal portfolio policy of the investor is given by

                                            Q(st )                  Q(st )
                  xopt
                   t (st ) = (1 −                  )(1 + rt )xopt
                                                              t−1 +        aim(st )         ∀st ∈ {1, 2, 3, 4}                 (18)
                                            λ(st )                  λ(st )

   where q and Q solve the following system of equations ∀s ∈ {1, 2, 3, 4}:
                                                                                       −1
             Q(st ) = −λ(st )2 γσ 2 (st ) + λ(st ) + ρ σ 2 (st ) + (1 + µ(st ))2 Q(st )
                                                                                
                                                                                           + λ(st ),                           (19)
                                                           
                                                    Q(st )
             q(st ) = (µ(st ) + ρµ(st )q(st )) 1 −            ,                                                                (20)
                                                     λ(st )
           aim(st ) = Q(st )−1 q(st ).                                                                                         (21)

                                                                                                          Q(st )
Since we have only one asset, the trading speed is one-dimensional and given by                           λ(st )   in each state.

5.4    Aim Portfolios and Trading Speed
Using the estimated model coefficients, we first study the aim portfolios across states in the presence
and absence of transaction costs. Figure 7 illustrates the aim portfolios for the optimal policy
in these cases. We also compare this optimal policy with a simple unconditional mean-variance
                                                                                                            µavg
benchmark, in which the portfolio rule holds a constant dollar amount equal to                                2
                                                                                                            γσavg
                                                                                                                    in the risky



                                                                   28
                       2
asset. Here, µavg and σavg are the sample mean and variance of the market returns between 1967
Q3 and 2017 Q2.
   In the top panel, the red solid line illustrates the aim portfolios in the absence of transaction
costs. Without transaction costs, aim portfolios are simply the conditional mean-variance optimal
Markowitz portfolios. Compared to the unconditional mean-variance constant benchmark portfolio,
the conditional Markowitz portfolio is very aggressive in regime 1 and holds a smaller amount than
the constant portfolio in all other states. In regime 3, the holdings are very close to a risk-free
position.
   In the bottom panel, we plot the aim portfolios when there are stochastic trading costs. We
use the estimated transaction cost multipliers from the liquid subset as provided in Table 5. Sur-
prisingly, regime 4 has the smallest aim portfolio whereas regime 3, the lowest Sharpe ratio state,
has slightly higher holdings. This is due to differences in trading costs, as well as to the tran-
sition probabilities, across states. For example, trading costs are largest in Regime 3, thus the
optimal aim portfolio, which will determine trading in that state, should depend on the average
positions expected in states that it will transition from, essentially Regime 4 (probability of ≈ 6%)
and Regime 2 (probability of ≈ 1%), as well as from states it will transition too, again Regime 2
(probability of ≈ 2%) and Regime 4 (probability of ≈ 1%). These considerations make the desired
holdings in Regime 3 higher. Interestingly, the aim portfolios in regime 3 and regime 4 hold a larger
position in risky assets than the corresponding conditional Markowitz portfolios, whereas the aim
portfolio in regime 1 actually holds a much smaller position than the conditional Markowitz port-
folio. This emphasizes the impact of transaction costs and potential transitions between states on
desired holdings.
   Finally, we plot the trading speeds in each regime in Figure 8. Due to high volatility, regime 4
has the highest trading speed. Regime 1 has the lowest trading costs so we find that the trading
speed is relatively larger compared to regime 2 and regime 3. However, the difference is not very
large as these other states have higher volatilities. Regime 3 has the lowest trading speed potentially
due to its highest trading costs.

5.5   In-sample Analysis
In this section, we evaluate the performance of the optimal policy using the in-sample estimates
from our four-state regime switching model. We compare it to various benchmark policies in the
presence and absence of transaction costs to quantify the potential benefits of this methodology.
   In order to evaluate the performance of the policies, we need to assign each trading day to a
regime state so that we can determine the appropriate values of σ 2 (st ) and λ(st ). For this purpose,
we use the smoothed probabilities from the regime switching model and assign the regime of each
trading day to the state with the highest smoothed probability.
   We also skip a day to implement the optimal and myopic policies without any forward-looking
bias. That is to say, to determine the position on day t, we use the smoothed probabilities from
day t − 1.


                                                  29
    Let xopt
         t   be the optimal policy as computed from Equation (18) and the above implementation
methodology. We break down the realized objective function into two terms, wealth and risk
penalties:

                                       T =12600                                                       
                                                                           1                     2
                           WTopt                                xopt      − λ(st ) xopt − xopt
                                         X
                                                        t
                                   =                ρ            t rt+1             t      t−1 Rt                  (22)
                                                                           2
                                          t=1
                                       T =12600
                                                    1 t h opt     i2
                         RPTopt =
                                         X
                                                      ρ xt σ(st )                                                  (23)
                                                    2
                                           t=1

Here, t = 12600 corresponds to the final trading day of 2017 Q2.

5.5.1     Benchmark Policies

As described earlier, the first benchmark policy is the constant-dollar rule in which the investor
                   cµavg
chooses xcon
         t   =       2 .
                   γσavg
                                                     2 , are obtained using the full in-sample data.
                           The parameters, µavg and σavg
We choose c so that the policy has the same risk exposure as the optimal policy, i.e., the discounted
sum of risk penalties from this policy equals RPTopt . In the presence of trading costs, getting into
a large constant position in the first period may result in large trading costs so to minimize this
effect we allow this policy to build the constant position in the first 10 trading days with equal-sized
trades.
    The second benchmark policy is the buy-and-hold portfolio in which the investor invests x0
dollars into the market portfolio at the beginning of the horizon.19 We provide slight advantage to
this benchmark policy by assuming that he builds this position with no trading costs. The investor
never trades till the end of the investment horizon. We again optimally choose x0 so that the policy
has the same risk exposure as the optimal policy.
    The third benchmark policy is the myopic policy with transaction cost multiplier, a widely used
practitioner approach. This approach solves a myopic mean-variance problem, that is given some
initial position (xt−1 ) and the state st , rt , it solves maxut xt µ(st ) − 21 γσ(st )2 x2t − 21 hu2t λ(st ) subject
to the dynamics xt = xt−1 (1 + rt ) + ut . The myopic policy with transaction cost multiplier h is
given by

                                                                                µ(st )
                  xmy                               my
                   t (st ) = (1 − τ (st ))(1 + rt )xt−1 + τ (st )                           ∀st ∈ {1, 2, 3, 4}     (24)
                                                                               γσ 2 (st )
                                       1
                     τ (st ) =         hλ(st )
                                                                                                                   (25)
                                 1+    γσ 2 (st )

Note that this policy, like the optimal one, trades partially towards an aim portfolio. However,
since it takes the current state as given and ignores the implications of any future transitions in
the state, the aim portfolio is the conditional mean-variance efficient Markowitz portfolio and the
  19
     We assume that the investor shorts the risk-free asset to generate this initial capital so he also starts from zero
wealth.




                                                                      30
                                 hλ(st )
trading inertia, 1 − τ (st ) ≈   γσ 2 (st )
                                            ,   only depends on the ratio between current state’s transaction
costs and the variance. We choose h so that the myopic policy uses the optimal trading speed
τ ∗ (st ) in each regime. Note that in this case, the risk penalties will not be the same. Further, in
the absence of transaction costs, the myopic policy is optimal, thus, we compare it to the optimal
one only in the presence of transaction costs.

5.5.2   Comparison between Portfolio Policies

Figure 9 compares the optimal policy to the constant portfolio in the absence of trading costs.
Both policies have the same risk penalty by construction (see bottom-right panel), thus the wealth
dynamics are direct measures of performance. The top-left panel illustrates that the optimal policy
has a much higher performance. We observe that this is achieved by trading more and timing
the regimes of the return data. This confirms that there is predictability and that, at least in the
absence of transaction costs, there is value to rebalancing across the estimated regimes.
   Figure 10 compares the optimal policy to the buy-and-hold portfolio in the absence of trading
costs. Both policies again have the same risk penalty by construction. In the top-right panel, the
starting position for the buy-and-hold policy is roughly $3 × 109 . Since this policy never trades,
the position becomes very large at the end of the horizon which causes this policy to take much
higher risk. This policy performs worse than the constant portfolio for that reason. Since there are
no trading costs, the constant portfolio maintains the same level of position costlessly and manages
the risk exposure better.
   Figure 11 compares the optimal policy to the constant portfolio in the presence of trading costs.
Both policies again have the same risk penalty by construction. Top-left panel illustrates that the
difference in performance is more pronounced in the presence of trading costs. One reason for this
is the excessive trading of the constant portfolio policy as illustrated in the medium-left and bottom
panel. Compared to the previous case, we note that optimal policy trades much more slowly as
shown in medium-right panel. The constant policy trades a lot after large return shocks in order
to keep a constant dollar amount invested in the market portfolio. Therefore, the constant-dollar
policy incurs much larger cumulative transaction costs than the optimal policy as we see in the
bottom panel, which contributes a significant portion of the observed wealth difference between the
two strategies.
   Figure 12 compares the optimal policy to the buy-and-hold portfolio in the presence of trading
costs. They both have the same risk penalty by construction. In the top-right panel, the starting
position for the buy-and-hold policy is roughly $1.4 × 109 . This policy performs better than the
constant portfolio in this case as it never incurs trading costs. We note that the buy-hold policy is
very slowly moving in building the position as it can never get out of the position to manage risk.
This becomes the main driver of underperformance compared to the optimal policy.
   Finally, Figure 13 compares the optimal policy to the myopic policy with transaction cost
multiplier. Both policies have the same trading speeds but different aim portfolios. Since the
risk penalties are not the same, wealth dynamics are not the main performance metric in this


                                                           31
case. For this reason, we also include the cumulative objective value which equals the difference
between wealth and risk penalties. The performance difference as illustrated by objective values
in the bottom-right panel is again substantial. The main driver seems to be excessive trading of
the myopic policy. Since the myopic portfolio uses the conditional Markowitz portfolio as its aim
position, it ends up trading a lot especially in the good state. Taking large positions, it also induces
large risk penalties. This example shows the importance of accounting for the future dynamics of
the state variables as this generates the difference between the aim portfolios of both policies.

5.6     Large vs. Small Portfolios
Managing transaction costs effectively will be very important when the portfolio size is large. In
the absence of transaction costs, we know that the myopic portfolio, i.e., the conditional Markowitz
portfolio, is optimal. Therefore, when the portfolio size is small, the difference between the optimal
policy in the presence of transaction costs and the myopic portfolio may be very small. Since we are
using realistic parameters, our model can also speak to the level of portfolio size at which managing
transaction costs would provide significant benefits. For example, with γ = 1 × 10−10 we observe
that our aim portfolios range from approximately $20 billion to $85 billion dollars.
   Figure 14 compares the optimal policy to the myopic policy when γ = 1 × 10−5 . In this case,
the top-right panel tells us that the maximum aim portfolio across states is roughly $2.8 million
and in this case, there is no significant difference between performances.
   Figure 15 compares the optimal policy to the myopic policy when γ = 2.5 × 10−8 . With this
calibration, the aim portfolios range from approximately $20 million to $900 million dollars. We
observe that the myopic policy diverges a lot from the optimal policy by trading a lot and taking
too much risk. It returns negative objective value and near-zero wealth levels. Thus, this simple
exercise suggests that when the portfolio size is on the order of hundred millions, taking price
impact into account is crucial.

5.7     Out-of-sample Analysis
The in-sample analysis was useful in studying the expected properties and benefits of a fully dynamic
portfolio policy, but to better assess the value of the regime switching model, we perform an out-
of-sample analysis. We implement a two-state regime switching model in this section for faster
estimation of the parameters as we need to estimate a regime switching model every day from 1967
to 2017, roughly 12,600 estimations.

5.7.1    Calibration

First, we estimate the model parameters to determine the parameters of the objective function. We
use all the available market return data from 1926 Q1 to 2017 Q2. Table 7 illustrates the estimated
coefficients. We again observe that the expected return is lower in the high volatility state. The
“good” state with higher expected return and low volatility is again more persistent.



                                                  32
Table 7: Parameter estimates for a two-state regime switching model using daily market return data from
1926 Q1 and 2017 Q2.
                            Parameter          Estimate              Parameter       Estimate
                                µ1             0.0841%                  σ1           0.6110%

                                µ2             -0.0955%                 σ2           1.8886%

                                P11             0.9866                  P12           0.0134

                                P21             0.0431                  P22           0.9569




Table 8: Transaction cost estimates in each regime labeled from the two-state regime switching model.
λn denotes the transaction cost multiplier in regime n. The second column reports the results from a
liquid subset in which we only include executions from stocks within the top 10% in market capitalization.
Estimated values are multiplied by 1010 . Standard errors are double-clustered at the stock and calendar day
level.
                                                Dependent variable: IS
                                                All Stocks    Liquid
                                      λ1         1.772∗∗∗               0.579∗∗∗
                                                 (0.255)                (0.166)

                                      λ2         2.299∗∗∗               1.254∗∗∗
                                                 (0.311)                (0.335)
                                       *** p   < 0.01,   ** p   < 0.05, * p < 0.10




                                                                33
   We estimate the transaction cost regimes using the same methodology, but now with two
regimes. We again use the estimates from the liquid subset, i.e., the 50 stocks with largest market
capitalizations. Formally, we run the following regression:

                              ISi = λ1 Qi 1{m(i)=1} + λ2 Qi 1{m(i)=2} + εi

Table 8 illustrates the estimated coefficients. We observe that λ estimates are all highly significant.
We find that λ2 is greater than λ1 and this difference is statically significant. Regime 2 has the
lowest Sharpe ratio and thus can be interpreted as the distressed state.

5.7.2   Objective Function

The estimated two-state regime switching model and the calibrated transaction costs will determine
the parameters of the out-of-sample objective function. Let x be any given policy. We will compute
the out-of-sample performance of this policy by W (x) − RP (x) where

                                   T =12600                                      
                                     X
                                               t         1                      2
                         W (x) =              ρ xt rt+1 − λ(st ) (xt − xt−1 Rt )                  (26)
                                                         2
                                      t=1
                                   T =12600
                                     X        1 t 2 2
                        RP (x) =                ρ xt σ (st ),                                     (27)
                                              2
                                     t=1

and st will equal to the state with the larger smoothed probability at time t, and σ and λ will be
given by the calibrations in Table 7 and Table 8 (the liquid column), respectively.
   The investor is not aware of the true parameters of the model and uses only information up to
trading day t in order to make a trading decision for day t + 1, i.e., no policy will be able to use
any forward looking data.

5.7.3   Optimal Policy

We construct our policy based on our theoretical analysis as follows. We will label this policy as
the “optimal” policy as it is based on our dynamic model. First, we estimate a two-state regime
switching model using the market return data from 1926 Q1 to 1967 Q2 (inclusive). We use these
estimated parameters to construct a trading policy as formulated by Lemma 3. To apply our trading
rule, we need to the predict the regime of the next trading day. To accomplish this, we re-estimate
a two-state regime switching model using return data from 1926 Q1 to the decision date. This
estimation will provide smoothed probabilities for every trading day including the decision date.
We will predict the next trading day’s regime using the state with the larger smoothed probability.
For example, suppose that Regime 1’s smoothed probability for decision date is 0.52 and Regime
2’s smoothed probability for decision date is 0.48. We will predict the next trading day to be of
Regime 1.




                                                       34
5.7.4   Benchmark Policies

We will use the constant portfolio and buy-and-hold portfolio as the benchmark policies.
   We construct the constant portfolio policy in the out-of-sample data as follows. First, we
estimate µavg and σavg using the market return data from 1926 Q1 to 1967 Q2. These parameters
are held fixed throughout the investment horizon. The investor then constructs the following
                             cµavg
constant portfolio: xcon
                     t   =     2 .
                             γσavg
                                     We choose c so that the policy has the same risk exposure as the
optimal policy.
   The buy-and-hold portfolio is constructed similarly to its in-sample counterpart. The investor
invests x0 dollars (borrowed at the risk-free rate) into the market portfolio at the beginning of the
investment horizon, i.e., on the first trading day of 1967 Q3, and then never trades but cumulates
returns from its risky and risk-free asset positions. We choose x0 so that the policy has the same
total risk exposure as the optimal policy.
   Figure 16 compares the optimal policy to the constant portfolio in the absence of trading costs
in the out-of-sample data. The top-left panel illustrates that the optimal policy has higher per-
formance in terms of terminal wealth. The results show that the regime-switching model captures
predictability out-of sample and that it is valuable, absent transaction costs, to rebalance to time
these regimes.
   Figure 17 compares the optimal policy to the buy-and-hold portfolio in the absence of trading
costs in the out-of-sample data. It confirms that the optimal policy outperforms the buy-and-hold
portfolio out-of-sample in the absence of transaction costs.
   Figure 18 compares the optimal policy to the constant portfolio in the presence of trading costs
in the out-of-sample data. The top-left panel illustrates that the difference in performance is more
pronounced in the presence of trading costs. The constant policy again trades a lot after large
return shocks which reduces its overall performance. We can see that the difference in cumulative
transaction costs paid by both strategies is very large and that this difference contributes substan-
tially to the difference in wealth generated by both strategies. This hints to an interesting insight
we confirm below. Even if expected return regimes are difficult to measure leading to a smaller
out-of-sample performance in the absence of transaction costs, if transaction cost regimes are more
accurately measured, which is plausible since t-costs vary with second moments, then optimally
accounting for the variation in volatility and transaction costs leads to a sizable improvement in
performance.
   Figure 19 compares the optimal policy to the buy-and-hold portfolio in the presence of trading
costs in the out-of-sample data. We find that the outperformance of the optimal policy is again
substantial. Here the myopic policy again builds the position very slowly but ends-up with a very
large a position at the end of the sample which increases the total risk. In the top-right panel, the
starting position for the buy-and-hold policy is roughly $4.7 × 109 . This is substantially lower than
the aim portfolio of the optimal policy in the low-volatility state.
   Overall, this out-of-sample analysis illustrates that the outperformance of the optimal policy is
robust to parameter uncertainty of the regime switching model.


                                                   35
5.8   Which parameter should you time?
In this section, we investigate the value of timing each switching parameter of the general model.
The switching parameters are µ, σ and λ. It is well-known, at least since Merton (1980), that
expected returns are estimated less precisely than volatilities. Further, Moreira and Muir (2017)
have shown that there are gains to scaling down the risky asset exposure in response to an increase in
the market’s variance, which suggests that the conditional mean of the market moves less than one-
for-one with its variance. One might thus expect that out-of-sample the benefits of timing changes
in volatility could be larger than timing changes in expected returns. We show some evidence to
that effect below. Further, since transaction costs vary with volatilities, we also provide quantitative
evidence about the value of timing transaction cost regimes.
   We use the the implementation of the optimal policy from the out-of-sample analysis to account
for the potential bias introduced by imprecisely estimated parameters. First, we study the value of
timing the switches in either volatility or expected returns in the absence of trading costs. In this
analysis, if the investor times volatility, he takes into account that the volatility is time-varying
between two states but assumes that expected return is constant throughout the investment horizon
and is given by µavg (as in the case of the constant portfolio rule). Similarly, if the investor times
expected returns, he models them as time-varying between high and low states and internalizes
the potential switches in the expected return in his trading rule but he assumes that the volatility
stays constant at a level of σavg (as in the case of the constant portfolio rule). We scale the policies
so that they take the same risk.
   Figure 20 compares these two timing approaches in the absence of trading costs using an out-
of-sample trading approach. We scale both policies so that they both have the same risk exposure
as the optimal policy that times both parameters. We find that timing volatility provides much
higher performance. The terminal wealth of the policy that only times volatility is actually higher
than the terminal wealth of the optimal policy that times both parameters as shown in Figure
16. This illustrates that trying to time expected returns may be actually detrimental in an out-
of-sample trading strategy. The top-right panel shows that the µ-timing policy has a wider range
of positions compared to the range observed in the σ-timing policy. In the absence of t-costs the
strategies switch to their conditional mean-variance Markowitz portolios in every state. Recall
that the estimated mean in the state 2 is negative and the volatility is high. This implies that
the µ-timing strategy, which underestimates the volatility in that regime, takes a very large short
position in the risky asset. This hurts the out-of-sample performance of the strategy relative to
the volatility timing strategy, probably because the negative expected return in those states is not
precisely estimated.
   If there are trading costs in the model, then λ will be switching through time between high and
low transaction cost regimes. If an investor does not time the switches in λ, then the investor uses
an unconditional average of λavg which is estimated from running following regression in the liquid
subset:
                                          ISi = λavg Qi + εi


                                                  36
where Qi is the dollar size of the order. We estimated λavg to be 0.766 × 10−10 which is between
λ1 and λ2 , as expected.
         Now we consider combined timing strategies: Timing σ and µ, timing σ and λ or timing µ and
λ. In all three timing strategies, the left-out parameter is set to its unconditional average. We
consider the comparison across these policies in two different assumptions of γ: high risk-aversion
and low risk-aversion.20 Figure 21 compares these three policies in the presence of transaction costs
in the high risk-aversion case. We observe that the top performing policy times σ and λ and the
worst performing policy times σ and µ.
         Figure 22 compares these three policies in the low risk-aversion case. We again observe that
the worst performing policy times σ and µ but the underperformance is economically smaller. This
underscores that the benefits from timing volatility and transaction costs become more important
when the size of the portfolio is large.


6         Conclusion
In this paper, we develop a closed-form solution for the dynamic asset allocation when expected
returns, covariances, and price impact parameters follow a multi-state regime switching model.
Under mean-variance objective function, we compute the optimal trading rule of the investor an-
alytically by characterizing the trading speed and aim portfolio. Specifically, the aim portfolio is
a weighted average of the conditional Markowitz portfolios in all potential states. The weight on
each conditional Markowitz portfolio depends on the likelihood of transitioning to that state, the
state’s persistence, the risk, and transaction costs faced in that state compared to the current one.
Similarly, the optimal trading speed is a function of the relative magnitude of the transaction costs
in various states and their transition probabilities. One of the significant implications of our model
is that the optimal portfolio can deviate substantially from the conditional Markowitz portfolio in
anticipation of possible future shifts in relative risk and/or transaction costs.
         We show that the model is equally tractable when price changes or returns follow a regime-
switching model. The latter aligns better with the empirical dynamics of asset returns. We utilize
this framework to optimally time the broad value-weighted market portfolio, accounting for time-
varying expected returns, volatility, and transaction costs. We use a large proprietary data on
institutional trading costs to estimate the price impact parameters. We find that trading costs
vary significantly across regimes and tend to be higher as market volatility increases.
         We test our trading strategy both in-sample and out-of-sample and find that there are sub-
stantial benefits to the use of our approach. For the out-of-sample test, the state probabilities
are estimated using only data in the information set of an agent on the day preceding the trading
date. We compare the performance of our optimal dynamic strategy to various benchmarks: a
constant dollar investment in the risky asset, a buy-and-hold portfolio, and a myopic policy with
    20
    Note that in the absence of trading costs, changing risk aversion would not matter, as the wealth values will just
be scaled by the ratio of the risk-aversion parameters.




                                                         37
optimal trading speeds borrowed from the optimal solution. Our dynamic strategy outperforms all
of these alternatives significantly. Out-of-sample, the benefits of timing volatility and transaction
costs dominate those of timing expected returns, especially when assets under management are
sizable.




                                                 38
References
Admati, Anat, and Paul Pfleiderer, 1988, A theory of intraday patterns: Volume and price vari-
  ability, Review of Financial Studies 1, 3–40.

Ang, Andrew, and Geert Bekaert, 2002, International asset allocation with regime shifts, The
  Review of Financial Studies 15, 1137–1187.

Ang, Andrew, and Allan Timmermann, 2012, Regime changes and financial markets, Annu. Rev.
  Financ. Econ. 4, 313–337.

Asness, Clifford, Andrea Frazzini, and Lasse Pedersen, 2012, Leverage aversion and risk parity,
  Financial Analysts Journal 68, 47–59.

Balduzzi, Pierluigi, and Anthony W Lynch, 1999, Transaction costs and predictability: Some utility
  cost calculations, Journal of Financial Economics 52, 47–78.

Brennan, Michael J., Eduardo S. Schwartz, and Ronald Lagnado, 1997, Strategic asset allocation,
  Journal of Economic Dynamics and Control 21, 1377–1403.

Bridgewater, 2011, Risk parity is about balance, Bridgewater Associates Research Note.

Brown, David B, and James E Smith, 2011, Dynamic portfolio optimization with transaction costs:
  Heuristics and dual bounds, Management Science 57, 1752–1770.

Campbell, John Y, Yeung Lewis Chan, and Luis M Viceira, 2003, A multivariate model of strategic
  asset allocation, Journal of Financial Economics 67, 41–80.

Campbell, John Y, and Luis M Viceira, 2002, Strategic asset allocation: portfolio choice for long-
  term investors. (Oxford University Press Oxford).

Cochrane, John H, 2007, Portfolio theory, University of Chicago Working Paper.

Constantinides, George M., 1986, Capital market equilibrium with transaction costs, The Journal
  of Political Economy pp. 842–862.

Cvitanić, Jaksa, 2001, Theory of portfolio optimization in markets with frictions, in Elyès Jouini,
  Jaksa Cvitanic, and Marek Musiela, eds.: Option Pricing, Interest Rates and Risk Management
  (Cambridge Univ Press, Cambridge, UK ).

Davis, M. H. A., and A. R. Norman, 1990, Portfolio selection with transaction costs, Mathematics
  of Operations Research 15, 676–713.

Detemple, Jérôme, and Marcel Rindisbacher, 2010, Dynamic asset allocation: Portfolio decompo-
  sition formula and applications, Review of Financial Studies 23, 25–100.




                                                  39
Du, Songzi, and Haoxiang Zhu, 2017, What is the optimal trading frequency in financial markets?,
  The Review of Economic Studies 84, 1606–1651.

Duffie, Darrell, and Haoxiang Zhu, 2017, Size discovery, The Review of Financial Studies 30, 1095–
  1150.

Dumas, Bernard, and Elisa Luciano, 1991, An exact solution to a dynamic portfolio choice problem
  under transactions costs, Journal of Finance 46, 577–595.

Foster, F Douglas, and Subramanian Viswanathan, 1993, Variations in trading volume, return
  volatility, and trading costs; evidence on recent price formation models, The Journal of Finance
  48, 187–211.

Gârleanu, Nicolae, and Lasse H. Pedersen, 2013, Dynamic trading with predictable returns and
  transaction costs, The Journal of Finance 68, 2309–2340.

Grinold, Richard C., and Ronald N. Kahn, 1999, Active portfolio management: a quantitative
  approach for providing superior returns and controlling risk. (McGraw-Hill Companies New York,
  NY).

Guidolin, Massimo, and Allan Timmermann, 2006, An econometric model of nonlinear dynamics
  in the joint distribution of stock and bond returns, Journal of Applied Econometrics 21, 1–22.

Hamilton, James D, and Raul Susmel, 1994, Autoregressive conditional heteroskedasticity and
  changes in regime, Journal of econometrics 64, 307–333.

Hugonnier, Julien, Florian Pelgrin, and Pascal St-Amour, 2012, Health and (other) asset holdings,
  The Review of Economic Studies 0, 1–48.

Jang, Bong-Gyu, Hyeng Keun Koo, Hong Liu, and Mark Loewenstein, 2007, Liquidity premia and
  transaction costs, The Journal of Finance 62, 2329–2366.

Kim, Tong Suk, and Edward Omberg, 1996, Dynamic nonmyopic portfolio behavior, Review of
  Financial Studies 9, 141–161.

Litterman, Robert, 2005, Multi-period portfolio optimization, working paper.

Liu, Jun, 2007, Portfolio selection in stochastic environments, Review of Financial Studies 20, 1–39.

Ljungqvist, Lars, and Thomas J. Sargent, 2004, Recursive Macroeconomic Theory. (The MIT press
  Cambridge, MA).

Longstaff, Francis A., 2001, Optimal portfolio choice and the valuation of illiquid securities, The
  Review of Financial Studies 14, 407–431.

Lynch, Anthony W, and Pierluigi Balduzzi, 2000, Predictability and transaction costs: The impact
  on rebalancing rules and behavior, The Journal of Finance 55, 2285–2309.


                                                 40
Lynch, Anthony W, and Sinan Tan, 2010, Multiple risky assets, transaction costs, and return pre-
  dictability: Allocation rules and implications for us investors, Journal of Financial and Quanti-
  tative Analysis 45, 1015–1053.

Markowitz, Harry M., 1952, Portfolio selection, Journal of Finance 7, 77–91.

Mei, Xiaoling, Victor DeMiguel, and Francisco J Nogales, 2016, Multiperiod portfolio optimization
  with multiple risky assets and general transaction costs, Journal of Banking & Finance 69,
  108–120.

Merton, Robert C, 1969, Lifetime portfolio selection under uncertainty: The continuous-time case,
  The review of Economics and Statistics 51, 247–257.

Merton, Robert C., 1971, Optimum consumption and portfolio rules in a continuous-time model,
  Journal of Economic Theory 3, 373–413.

Merton, Robert C., 1980, On estimating the expected return on the market, Journal of Financial
  Economics 8, 323–361.

Moreira, Alan, and Tyler Muir, 2017, Volatility-managed portfolios, The Journal of Finance 72,
  1611–1644.

Perold, Andre F., 1988, The implementation shortfall: Paper versus reality, The Journal of Portfolio
  Management 14, 4–9.

Rosenberg, Barr, 1972, The behavior of random variables with nonstationary variance and the
  distribution of stock prices, Working paper University of California Berkeley.

Shreve, Steven E, and H. Mete Soner, 1994, Optimal investment and consumption with transaction
  costs, The Annals of Applied Probability 4, 609–692.

Skiadas, Costis, 2008, Dynamic portfolio choice and risk-aversion, in J. R. Birge, and V. Linetsky,
  eds.: Handbooks in Operations Research and Management Science (Elsevier B.V., Amsterdam ).

Stoll, Hans R., 1978, The supply of dealer services in securities markets, The Journal of Finance
  33, 1133–1151.




                                                41
                                      1                                                                                 1

   Regime 1 - Smoothed Probability   0.9                                                                               0.9




                                                                                     Regime 2 - Smoothed Probability
                                     0.8                                                                               0.8

                                     0.7                                                                               0.7

                                     0.6                                                                               0.6

                                     0.5                                                                               0.5

                                     0.4                                                                               0.4

                                     0.3                                                                               0.3

                                     0.2                                                                               0.2

                                     0.1                                                                               0.1

                                      0                                                                                 0
                                           1970   1980   1990     2000   2010                                                1970   1980   1990     2000   2010
                                                           Time                                                                              Time
                                      1                                                                                 1

                                     0.9                                                                               0.9
   Regime 3 - Smoothed Probability




                                                                                     Regime 4 - Smoothed Probability
                                     0.8                                                                               0.8

                                     0.7                                                                               0.7

                                     0.6                                                                               0.6

                                     0.5                                                                               0.5

                                     0.4                                                                               0.4

                                     0.3                                                                               0.3

                                     0.2                                                                               0.2

                                     0.1                                                                               0.1

                                      0                                                                                 0
                                           1970   1980   1990     2000   2010                                                1970   1980   1990     2000   2010
                                                           Time                                                                              Time




Figure 6: Regimes. The first four plots illustrate the corresponding smoothed probabilities for each regime.
We use the following color codes: Green represents regime 1, blue represents regime 2, yellow represents
regime 3, and red represents regime 4. The fifth plot illustrates the color-coded regimes vertically by using
the maximum smoothed probability for identification. Market returns are in black.

                                                                                42
                                     300
                                                                               Aim
                                                                               Constant
                                     250


                                     200
                         Billion $




                                     150


                                     100


                                      50


                                       0
                                     Regime 1   Regime 2            Regime 3         Regime 4
                                                           States
                                     90
                                                                               Aim
                                                                               Constant
                                     80


                                     70
                         Billion $




                                     60


                                     50


                                     40


                                     30


                                20
                               Regime 1         Regime 2            Regime 3         Regime 4
                                                           States


Figure 7: Unconditional Markowitz portfolio and aim portfolios in the absence and presence of trading costs.
In the top panel, trading costs are assumed to be zero, thus the aim portfolio is equal to the conditional
Markowitz portfolio. We also plot the unconditional Markowitz portfolio which we label as the “Constant”
portfolio. In the bottom panel, trading costs are set according to Table 5 using executions from the liquid
subset. Coefficient of risk aversion is given by γ = 1 × 10−10 (can be thought as corresponding to a relative
risk aversion of 1 for an agent with $10 billion dollars under management.).




                                                            43
                                0.035



                                 0.03
                Trading Speed




                                0.025



                                 0.02



                                0.015



                                 0.01
                                 Regime 1   Regime 2            Regime 3        Regime 4
                                                       States

Figure 8: Trading speed across different regimes. Trading costs are set according to Table 5 using execu-
tions on very large-cap stocks. Coefficient of risk aversion is given by γ = 1 × 10−10 (can be thought as
corresponding to a relative risk aversion of 1 for an agent with $10 billion dollars under management.).




                                                       44
                 10 11                                                                              10 11
            16                                                                                 3

            14
                                                                                           2.5
            12

            10                                                                                 2




                                                             Position
   Wealth




             8
                                                                                           1.5
             6

             4                                                                                 1

             2
                                                                                           0.5
             0                                   Optimal                                                                             Optimal
                                                 Constant                                                                            Constant
            -2                                                                                 0
                 1970    1980   1990     2000   2010                                                1970    1980   1990      2000   2010
                                  Time                                                                                Time
                 10 11                                                                             10 11
            3                                                                              8

                                                                                           7
            2
                                                                 Cumulative Risk Penalty




                                                                                           6

            1
                                                                                           5
   Trades




            0                                                                              4

                                                                                           3
            -1
                                                                                           2

            -2
                                                 Optimal                                   1                                         Optimal
                                                 Constant                                                                            Constant
            -3                                                                             0
                 1970    1980   1990     2000   2010                                               1970     1980   1990      2000   2010
                                  Time                                                                               Time



Figure 9: This figure compares the in-sample performance of the optimal policy with a constant-dollar
portfolio in the absence of trading costs. Both strategies start from zero-wealth. Constant portfolio is equal
to the scaled unconditional Markowitz portfolio so that the policy has the same risk exposure as the optimal
policy (as shown in the bottom-right panel). Top-left panel shows the cumulative wealth of each policy which
is the main comparison metric. Top-right panel shows the each strategy’s dollar position in the market fund.
Bottom-left panel illustrates the change in position due to the rebalancing of the strategy.




                                                            45
                 10 11                                                                              10 11
            16                                                                                 4

            14
                                                                                           3.5

            12
                                                                                               3
            10
                                                                                           2.5




                                                             Position
   Wealth




             8
                                                                                               2
             6
                                                                                           1.5
             4

                                                                                               1
             2

             0                                   Optimal                                   0.5                                       Optimal
                                                 Buy-Hold                                                                            Buy-Hold
            -2                                                                                 0
                 1970    1980   1990     2000   2010                                                1970    1980   1990      2000   2010
                                  Time                                                                                Time
                 10 11                                                                             10 11
            3                                                                              8

                                                                                           7
            2
                                                                 Cumulative Risk Penalty




                                                                                           6

            1
                                                                                           5
   Trades




            0                                                                              4

                                                                                           3
            -1
                                                                                           2

            -2
                                                 Optimal                                   1                                         Optimal
                                                 Buy-Hold                                                                            Buy-Hold
            -3                                                                             0
                 1970    1980   1990     2000   2010                                               1970     1980   1990      2000   2010
                                  Time                                                                               Time



Figure 10: This figure compares the in-sample performance of the optimal policy with a buy-and-hold
portfolio in the absence of trading costs. Both strategies start from zero-wealth. Buy-and-hold portfolio
invests x0 dollars into the market fund at the beginning of the horizon. We scale x0 so that the policy has
the same risk exposure as the optimal policy (as shown in the bottom-right panel). Top-left panel shows
the cumulative wealth of each policy which is the main comparison metric. Top-right panel shows the each
strategy’s dollar position in the market fund. Bottom-left panel illustrates the change in position due to the
rebalancing of the strategy.




                                                            46
                            11                                                                                                     10 10
                      10                                                                                                      10
            3.5
                                                                                                                               9
                 3
                                                                                                                               8
            2.5
                                                                                                                               7

                 2                                                                                                             6




                                                                                                  Position
   Wealth




            1.5                                                                                                                5

                                                                                                                               4
                 1
                                                                                                                               3
            0.5
                                                                                                                               2
                 0                                                                  Optimal                                    1                                   Optimal
                                                                                    Constant                                                                       Constant
            -0.5                                                                                                               0
                      1970       1980   1990                     2000          2010                                                1970    1980   1990     2000   2010
                                          Time                                                                                                      Time
                     10 9                                                                                                          10 10
            10                                                                                                                18

             8                                                                                                                16

             6                                                                                                                14
                                                                                                    Cumulative Risk Penalty
             4                                                                                                                12
   Trades




             2                                                                                                                10

             0                                                                                                                 8

            -2                                                                                                                 6

            -4                                                                                                                 4

            -6                                                                                                                 2                                   Optimal
                                                                                                                                                                   Constant
            -8                                                                                                                 0
                     1970        1980   1990                     2000          2010                                                1970    1980   1990     2000   2010
                                          Time                                                                                                      Time
                                                                 10 11
                                                            2
                                                                         Optimal
                                                           1.8           Constant

                                                           1.6

                                                           1.4
                                           Cumulative TC




                                                           1.2

                                                            1

                                                           0.8

                                                           0.6

                                                           0.4

                                                           0.2

                                                            0
                                                                 1970         1980             1990                                 2000   2010
                                                                                                 Time
Figure 11: This figure compares the in-sample performance of the optimal policy with a constant-dollar portfolio
in the presence of trading costs. Both strategies start from zero-wealth. Constant portfolio is equal to the scaled
unconditional Markowitz portfolio so that the policy has the same risk exposure as the optimal policy (as shown
in the center-right panel). Top-left panel shows the cumulative wealth of each policy which is the main comparison
metric. Top-right panel shows the each strategy’s dollar position in the market fund. Center-left panel illustrates
the change in position due to the rebalancing of the strategy and the bottom panel illustrates the cumulative cost of
these trades.



                                                                                               47
                        11                                                                                                    10 10
                   10                                                                                                    18
            3.5

                                                                                                                         16
              3
                                                                                                                         14
            2.5
                                                                                                                         12
              2




                                                                                             Position
                                                                                                                         10
   Wealth




            1.5
                                                                                                                          8
              1
                                                                                                                          6

            0.5
                                                                                                                          4

              0                                                                Optimal                                    2                                   Optimal
                                                                               Buy-Hold                                                                       Buy-Hold
            -0.5                                                                                                          0
                   1970      1980   1990                     2000         2010                                                1970    1980   1990     2000   2010
                                      Time                                                                                                     Time

                   10 9                                                                                                       10 10
            1.5                                                                                                          18

                                                                                                                         16
              1
                                                                                                                         14
                                                                                               Cumulative Risk Penalty
            0.5                                                                                                          12

                                                                                                                         10
   Trades




              0
                                                                                                                          8

            -0.5                                                                                                          6

                                                                                                                          4
             -1
                                                                               Optimal                                    2                                   Optimal
                                                                               Buy-Hold                                                                       Buy-Hold
            -1.5                                                                                                          0
                   1970      1980   1990                     2000         2010                                                1970    1980   1990     2000   2010
                                      Time                                                                                                     Time
                                                            10 9
                                                       16
                                                                    Optimal
                                                       14           Buy-Hold


                                                       12
                                       Cumulative TC




                                                       10

                                                        8

                                                        6

                                                        4

                                                        2

                                                        0
                                                            1970         1980             1990                                2000    2010
                                                                                            Time
Figure 12: This figure compares the in-sample performance of the optimal policy with a buy-and-hold portfolio in the
presence of trading costs. Both strategies start from zero-wealth. Buy-and-hold portfolio invests x0 dollars into the
market fund at the beginning of the horizon. We scale x0 so that the policy has the same risk exposure as the optimal
policy (as shown in the center-right panel). Top-left panel shows the cumulative wealth of each policy which is the
main comparison metric. Top-right panel shows the each strategy’s dollar position in the market fund. Center-left
panel illustrates the change in position due to the rebalancing of the strategy and the bottom panel illustrates the
cumulative cost of these trades.



                                                                                          48
                             10
                                   11                                                                                  10 11
                        4                                                                                        3.5

                   3.5
                                                                                                                  3
                        3
                                                                                                                 2.5
                   2.5

                        2




                                                                                   Position
                                                                                                                  2
   Wealth




                   1.5
                                                                                                                 1.5
                        1

                   0.5                                                                                            1

                        0
                                                                                                                 0.5
                                                                        Optimal                                                                         Optimal
                   -0.5
                                                                        Myopic                                                                          Myopic
                    -1                                                                                            0
                             1970             1980   1990      2000   2010                                             1970    1980   1990     2000   2010
                                                        Time                                                                            Time
                            10 9                                                                                       10 11
                    4                                                                                            10

                    3                                                                                             9

                                                                                                                  8

                                                                                       Cumulative Risk Penalty
                    2
                                                                                                                  7
                    1
                                                                                                                  6
   Trades




                    0                                                                                             5

                                                                                                                  4
                   -1
                                                                                                                  3
                   -2
                                                                                                                  2
                   -3                                                   Optimal                                                                         Optimal
                                                                                                                  1
                                                                        Myopic                                                                          Myopic
                   -4                                                                                             0
                            1970             1980    1990      2000   2010                                             1970    1980   1990     2000   2010
                                                       Time                                                                             Time
                             10 11                                                                                     10 11
                     5                                                                                            2
                                        Optimal
                   4.5                  Myopic                                                                    1

                     4                                                                                            0

                   3.5
                                                                                                                 -1
   Cumulative TC




                     3
                                                                                       Objective




                                                                                                                 -2
                   2.5
                                                                                                                 -3
                     2
                                                                                                                 -4
                   1.5
                                                                                                                 -5
                     1

                                                                                                                 -6                                     Optimal
                   0.5
                                                                                                                                                        Myopic
                     0                                                                                           -7
                            1970              1980   1990      2000   2010                                             1970    1980   1990     2000   2010
                                                       Time                                                                             Time

Figure 13: This figure compares the in-sample performance of the optimal policy with a myopic policy in the presence
of trading costs. Both strategies start from zero-wealth. We adjust the myopic policy so that it has the same trading
speed as the optimal policy. Top-left panel shows the cumulative wealth of each policy. Top-right panel shows the
each strategy’s dollar position in the market fund. Center-left panel illustrates the change in position due to the
rebalancing of the strategy and the bottom-left panel illustrates the cumulative cost of these trades. Bottom-right
panel shows the realized objective value of each strategy, which is the main comparison metric, by subtracting the
risk penalty from the wealth generated.



                                                                                  49
                         10 6                                                                                            10 6
                   16                                                                                               3

                   14
                                                                                                                2.5
                   12

                   10                                                                                               2




                                                                                  Position
   Wealth




                    8
                                                                                                                1.5
                    6

                    4                                                                                               1

                    2
                                                                                                                0.5
                    0                                            Optimal                                                                                Optimal
                                                                 No-TC Optimal                                                                          No-TC Optimal
                   -2                                                                                               0
                         1970         1980       1990     2000      2010                                                 1970   1980   1990      2000      2010
                                                   Time                                                                                   Time
                         10 6                                                                                           10 6
                   3                                                                                            8

                                                                                                                7
                   2

                                                                                      Cumulative Risk Penalty
                                                                                                                6

                   1
                                                                                                                5
   Trades




                   0                                                                                            4

                                                                                                                3
                   -1
                                                                                                                2

                   -2
                                                                 Optimal                                        1                                       Optimal
                                                                 No-TC Optimal                                                                          No-TC Optimal
                   -3                                                                                           0
                         1970         1980       1990     2000      2010                                                1970    1980   1990      2000      2010
                                                   Time                                                                                  Time
                          10 4                                                                                          10 6
                   3.5                                                                                           6
                                 Optimal
                                 No-TC Optimal                                                                   5
                    3


                   2.5                                                                                           4
   Cumulative TC




                                                                                      Objective




                    2                                                                                            3


                   1.5                                                                                           2


                    1                                                                                            1


                   0.5                                                                                           0
                                                                                                                                                        Optimal
                                                                                                                                                        No-TC Optimal
                    0                                                                                           -1
                         1970         1980       1990     2000      2010                                                1970    1980   1990      2000      2010
                                                   Time                                                                                  Time

Figure 14: This figure compares the in-sample performance of the optimal policy with a conditional Markowitz
portfolio for a small investor (γ = 1 × 10−5 ) in the presence of trading costs. Recall that conditional Markowitz
portfolio is optimal in the absence of trading costs. Both strategies start from zero-wealth. Top-left panel shows
the cumulative wealth of each policy. Top-right panel shows the each strategy’s dollar position in the market fund.
Center-left panel illustrates the change in position due to the rebalancing of the strategy and the bottom-left panel
illustrates the cumulative cost of these trades. Bottom-right panel shows the realized objective value of each strategy,
which is the main comparison metric, by subtracting the risk penalty from the wealth generated.



                                                                                 50
                               9                                                                                           10 8
                          10                                                                                      12
                     4

                   3.5
                                                                                                                  10
                     3

                   2.5                                                                                             8




                                                                                    Position
   Wealth




                     2
                                                                                                                   6
                   1.5

                     1                                                                                             4

                   0.5
                                                                                                                   2
                     0                                             Optimal                                                                                 Optimal
                                                                   No-TC Optimal                                                                           No-TC Optimal
                   -0.5                                                                                            0
                          1970           1980      1990     2000      2010                                                 1970    1980   1990      2000      2010
                                                     Time                                                                                   Time
                          10 9                                                                                             10 9
                   1.5                                                                                             3



                     1                                                                                            2.5


                                                                                        Cumulative Risk Penalty
                   0.5                                                                                             2
   Trades




                     0                                                                                            1.5



                   -0.5                                                                                            1



                    -1                                                                                            0.5
                                                                   Optimal                                                                                 Optimal
                                                                   No-TC Optimal                                                                           No-TC Optimal
                   -1.5                                                                                            0
                          1970           1980      1990     2000      2010                                                 1970    1980   1990      2000      2010
                                                     Time                                                                                   Time
                          10 9                                                                                              10 9
                     5                                                                                            1.5
                                   Optimal
                   4.5             No-TC Optimal                                                                       1
                     4
                                                                                                                  0.5
                   3.5
                                                                                                                       0
   Cumulative TC




                     3
                                                                                        Objective




                                                                                                                  -0.5
                   2.5
                                                                                                                   -1
                     2
                                                                                                                  -1.5
                   1.5

                     1                                                                                             -2

                   0.5                                                                                            -2.5                                     Optimal
                                                                                                                                                           No-TC Optimal
                     0                                                                                             -3
                          1970          1980       1990     2000      2010                                                  1970   1980   1990      2000      2010
                                                     Time                                                                                    Time


Figure 15: This figure compares the in-sample performance of the optimal policy with a conditional
Markowitz portfolio for a medium-size investor (γ = 2.5 × 10−8 ) in the presence of trading costs. Re-
call that conditional Markowitz portfolio is optimal in the absence of trading costs. Both strategies start
from zero-wealth. Top-left panel shows the cumulative wealth of each policy. Top-right panel shows the
each strategy’s dollar position in the market fund. Center-left panel illustrates the change in position due
to the rebalancing of the strategy and the bottom-left panel illustrates the cumulative cost of these trades.
Bottom-right panel shows the realized objective value of each strategy, which is the main comparison metric,
by subtracting the risk penalty from the wealth generated.

                                                                                   51
                 10 11
            12                                                                                    10 11
                                                                                           3.5

            10                                                                               3


             8                                                                             2.5

                                                                                             2
             6




                                                             Position
   Wealth




                                                                                           1.5
             4
                                                                                             1
             2
                                                                                           0.5

             0
                                                 Optimal                                     0                                    Optimal
                                                 Constant                                                                         Constant
            -2                                                                             -0.5
                 1970    1980   1990     2000   2010                                              1970    1980   1990     2000   2010
                                  Time                                                                             Time
                 10 11                                                                            10 12
            4                                                                                3

            3
                                                                                           2.5
            2
                                                                 Cumulative Risk Penalty




                                                                                             2
            1
   Trades




            0                                                                              1.5

            -1
                                                                                             1
            -2

                                                                                           0.5
            -3                                   Optimal                                                                          Optimal
                                                 Constant                                                                         Constant
            -4                                                                               0
                 1970    1980   1990     2000   2010                                              1970    1980   1990     2000   2010
                                  Time                                                                             Time


Figure 16: This figure compares the out-of-sample performance of the optimal policy with a constant-dollar
portfolio in the absence of trading costs. Both strategies start from zero-wealth. Constant portfolio is equal
to the scaled unconditional Markowitz portfolio so that the policy has the same risk exposure as the optimal
policy (as shown in the bottom-right panel). Both strategies are constructed using only backward-looking
data. Top-left panel shows the cumulative wealth of each policy which is the main comparison metric. Top-
right panel shows the each strategy’s dollar position in the market fund. Bottom-left panel illustrates the
change in position due to the rebalancing of the strategy.




                                                            52
                 10 11                                                                           10 11
            12                                                                             6


            10                                                                             5


             8                                                                             4




                                                             Position
             6                                                                             3
   Wealth




             4                                                                             2


             2                                                                             1


             0                                                                             0
                                                 Optimal                                                                          Optimal
                                                 Buy-Hold                                                                         Buy-Hold
            -2                                                                             -1
                 1970    1980   1990     2000   2010                                             1970     1980   1990     2000   2010
                                  Time                                                                             Time
                 10 11                                                                            10 12
            4                                                                               3

            3
                                                                                           2.5
            2
                                                                 Cumulative Risk Penalty




                                                                                            2
            1
   Trades




            0                                                                              1.5

            -1
                                                                                            1
            -2

                                                                                           0.5
            -3                                   Optimal                                                                          Optimal
                                                 Buy-Hold                                                                         Buy-Hold
            -4                                                                              0
                 1970    1980   1990     2000   2010                                             1970     1980   1990     2000   2010
                                  Time                                                                             Time


Figure 17: This figure compares the out-of-sample performance of the optimal policy with a buy-and-hold
portfolio portfolio in the absence of trading costs. Both strategies start from zero-wealth. Buy-and-hold
portfolio invests x0 dollars into the market fund at the beginning of the horizon. We scale x0 so that the
policy has the same risk exposure as the optimal policy (as shown in the bottom-right panel). Both strategies
are constructed using only backward-looking data. Top-left panel shows the cumulative wealth of each policy
which is the main comparison metric. Top-right panel shows the each strategy’s dollar position in the market
fund. Bottom-left panel illustrates the change in position due to the rebalancing of the strategy.




                                                            53
                 10 10                                                                                                      10 10
            18                                                                                                         5
                         Optimal                                                                                                     Optimal
            16           Constant                                                                                  4.5               Constant

            14                                                                                                         4

            12                                                                                                     3.5

            10                                                                                                         3




                                                                                         Position
   Wealth




             8                                                                                                     2.5

             6                                                                                                         2

             4                                                                                                     1.5

             2                                                                                                         1

             0                                                                                                     0.5

            -2                                                                                                         0
                 1970         1980   1990                    2000          2010                                             1970           1980   1990      2000   2010
                                       Time                                                                                                          Time
                 10 9                                                                                                      10 10
            6                                                                                                      7
                                                                                                                                    Optimal
            5                                                                                                                       Constant
                                                                                                                   6
            4

            3                                                                            Cumulative Risk Penalty   5

            2
                                                                                                                   4
   Trades




            1
                                                                                                                   3
            0

            -1                                                                                                     2

            -2
                                                                                                                   1
            -3

            -4                                                                                                     0
                 1970         1980   1990                    2000          2010                                            1970          1980     1990      2000   2010
                                       Time                                                                                                         Time
                                                            10 10
                                                        7
                                                                    Optimal
                                                                    Constant
                                                        6


                                                        5
                                        Cumulative TC




                                                        4


                                                        3


                                                        2


                                                        1


                                                        0
                                                            1970         1980     1990                                      2000           2010
                                                                                    Time

Figure 18: This figure compares the out-of-sample performance of the optimal policy with a constant-dollar portfolio
in the presence of trading costs. Both strategies start from zero-wealth. Constant portfolio is equal to the scaled
unconditional Markowitz portfolio so that the policy has the same risk exposure as the optimal policy (as shown in
the center-right panel). Both strategies are constructed using only backward-looking data. Top-left panel shows the
cumulative wealth of each policy which is the main comparison metric. Top-right panel shows the each strategy’s
dollar position in the market fund. Center-left panel illustrates the change in position due to the rebalancing of the
strategy and the bottom panel illustrates the cumulative cost of these trades.


                                                                                   54
                 10 10                                                                                               10 10
            18                                                                                                   9
                         Optimal                                                                                             Optimal
            16           Buy-Hold
                                                                                                                 8           Buy-Hold

            14                                                                                                   7

            12                                                                                                   6
            10




                                                                                     Position
                                                                                                                 5
   Wealth




             8
                                                                                                                 4
             6
                                                                                                                 3
             4
                                                                                                                 2
             2

             0                                                                                                   1

            -2                                                                                                   0
                 1970          1980   1990                    2000         2010                                      1970         1980     1990     2000   2010
                                        Time                                                                                                 Time
                 10 8                                                                                                10 10
            6                                                                                                    7
                         Optimal                                                                                             Optimal
                         Buy-Hold                                                                                            Buy-Hold
                                                                                                                 6
            4

                                                                                       Cumulative Risk Penalty   5
            2

                                                                                                                 4
   Trades




            0
                                                                                                                 3

            -2
                                                                                                                 2

            -4
                                                                                                                 1


            -6                                                                                                   0
                 1970         1980    1990                    2000         2010                                      1970         1980     1990     2000   2010
                                        Time                                                                                                 Time
                                                              10 9
                                                         12
                                                                     Optimal
                                                                     Buy-Hold
                                                         10


                                                          8
                                         Cumulative TC




                                                          6


                                                          4


                                                          2


                                                          0
                                                              1970        1980    1990                                2000          2010
                                                                                    Time


Figure 19: This figure compares the out-of-sample performance of the optimal policy with a buy-and-hold portfolio
in the presence of trading costs. Both strategies start from zero-wealth. Buy-and-hold portfolio invests x0 dollars
into the market fund at the beginning of the horizon. We scale x0 so that the policy has the same risk exposure as
the optimal policy (as shown in the center-right panel). Both strategies are constructed using only backward-looking
data. Top-left panel shows the cumulative wealth of each policy which is the main comparison metric. Top-right
panel shows the each strategy’s dollar position in the market fund. Center-left panel illustrates the change in position
due to the rebalancing of the strategy and the bottom panel illustrates the cumulative cost of these trades.


                                                                                  55
                 10 11                                                                              10 11
            14                                                                                4
                         Timing                                                                                                           Timing
            12           Timing                                                                                                           Timing
                                                                                              3

            10
                                                                                              2

             8




                                                                Position
                                                                                              1
   Wealth




             6
                                                                                              0
             4

                                                                                              -1
             2

             0                                                                                -2


            -2                                                                                -3
                 1970         1980   1990     2000   2010                                           1970          1980   1990     2000   2010
                                       Time                                                                                Time
                 10 11                                                                               10 12
            4                                                                                  3
                                                      Timing                                                 Timing
            3                                         Timing                                                 Timing
                                                                                              2.5
            2
                                                                    Cumulative Risk Penalty




                                                                                               2
            1
   Trades




            0                                                                                 1.5

            -1
                                                                                               1
            -2

                                                                                              0.5
            -3

            -4                                                                                 0
                 1970         1980   1990     2000   2010                                           1970          1980   1990     2000   2010
                                       Time                                                                                Time


Figure 20: This figure compares the out-of-sample performance of timing strategies in the absence of trading costs.
σ-timing policy takes into account that the volatility is time-varying between two states but assumes that expected
return is constant throughout the investment horizon. µ-timing policy internalizes the potential switches in the
expected returns but it assumes that the volatility stays constant at an unconditional average. Both strategies start
from zero-wealth. We scale both policies so that they have the same risk exposure as the optimal policy (as shown
in the bottom-right panel). Top-left panel shows the cumulative wealth of each policy which is the main comparison
metric. Top-right panel shows the each strategy’s dollar position in the market fund. Bottom-left panel illustrates
the change in position due to the rebalancing of the strategy.




                                                               56
                            10                                                                                                       10 9
                      10                                                                                                        8
            2.5
                                                                                                                                                                            Timing    and
                                 Timing   and
                                                                                                                                                                            Timing    and
                                 Timing   and                                                                                   6
                                                                                                                                                                            Timing    and
                 2               Timing   and

                                                                                                                                4
            1.5




                                                                                                      Position
                                                                                                                                2
   Wealth




                 1
                                                                                                                                0

            0.5
                                                                                                                                -2

                 0                                                                                                              -4


            -0.5                                                                                                                -6
                      1970            1980      1990                     2000           2010                                         1970        1980       1990     2000      2010
                                                   Time                                                                                                       Time
                     10 8                                                                                                            10 9
             4                                                                                                                  12
                                                                                                                                            Timing    and
             3
                                                                                                                                            Timing    and
                                                                                                                                10          Timing    and
             2

             1                                                                                        Cumulative Risk Penalty
                                                                                                                                 8
             0
   Trades




            -1                                                                                                                   6

            -2
                                                                                                                                 4
            -3

            -4
                                                                                                                                 2
            -5

            -6                                                                                                                   0
                     1970            1980       1990                    2000            2010                                         1970        1980       1990     2000      2010
                                                  Time                                                                                                        Time
                                                                       10 9
                                                                   9
                                                                               Timing   and
                                                                   8           Timing   and
                                                                               Timing   and
                                                                   7

                                                                   6
                                                   Cumulative TC




                                                                   5

                                                                   4

                                                                   3

                                                                   2

                                                                   1

                                                                   0
                                                                       1970         1980       1990                                  2000            2010
                                                                                                 Time

Figure 21: This figure compares the out-of-sample performance of timing strategies in the presence of trading costs.
Timing σ and λ policy takes into account that the volatility and trading costs are time-varying between two states
but assumes that expected return is constant at its unconditional average. Timing µ and λ policy internalizes the
potential switches in the expected returns and transaction costs but it assumes that the volatility stays constant at
an unconditional average. Finally, timing σ and µ policy takes into account that the volatility and expected returns
are time-varying between two states but assumes that trading costs are constant at its unconditional average. Risk
aversion level is at 1 × 10−9 .



                                                                                                57
                 10 10                                                                                                    10 10
            18                                                                                                        6
                         Timing   and                                                                                                                             Timing    and
            16           Timing   and                                                                                                                             Timing    and
                         Timing   and                                                                                 5                                           Timing    and
            14

            12                                                                                                        4
            10




                                                                                          Position
   Wealth




             8                                                                                                        3

             6
                                                                                                                      2
             4

             2
                                                                                                                      1
             0

            -2                                                                                                        0
                 1970         1980      1990                    2000            2010                                      1970         1980       1990     2000      2010
                                          Time                                                                                                      Time
                 10 8                                                                                                     10 10
            6                                                                                                         7
                                                                                                                                  Timing   and
                                                                                                                                  Timing   and
            4                                                                                                         6
                                                                                                                                  Timing   and


            2                                                                               Cumulative Risk Penalty   5


            0                                                                                                         4
   Trades




            -2                                                                                                        3


            -4                                                                                                        2


            -6                                                                                                        1


            -8                                                                                                        0
                 1970         1980      1990                    2000            2010                                      1970         1980       1990     2000      2010
                                          Time                                                                                                      Time
                                                                10 9
                                                           18
                                                                       Timing    and
                                                           16          Timing    and
                                                                       Timing    and
                                                           14

                                                           12
                                           Cumulative TC




                                                           10

                                                            8

                                                            6

                                                            4

                                                            2

                                                            0
                                                                1970        1980       1990                                2000            2010
                                                                                         Time


Figure 22: This figure compares the out-of-sample performance of timing strategies in the presence of trading costs.
Timing σ and λ policy takes into account that the volatility and trading costs are time-varying between two states
but assumes that expected return is constant at its unconditional average. Timing µ and λ policy internalizes the
potential switches in the expected returns and transaction costs but it assumes that the volatility stays constant at
an unconditional average. Finally, timing σ and µ policy takes into account that the volatility and expected returns
are time-varying between two states but assumes that trading costs are constant at its unconditional average. Risk
aversion level is at 1 × 10−10 .


                                                                                       58
A        Appendix
We begin by solving a continuous-time version of the model presented in Section 2 and show
that the model implications and insights are consistent with its discrete time counterpart. Finite-
and infinite-horizon versions of the continuous-time model are presented in Appendices B and C,
respectively.
       In Appendix D we solve the problem of a CARA investor and show that its solution coincides
with the solution of our model only if one makes a linear approximation of a jump-related term in
the HJB equation. Thus, the solution of our model is only an approximation to that of an investor
with CARA preferences. However, we show that this approximation has a meaningful economic
interpretation. Indeed, it corresponds to making the agent risk-neutral to regime-switching risk
while remaining risk-averse to diffusion return-risk. In Appendix E, we formalize this argument by
defining a set of ‘source-dependent’ recursive utility functions in which agents would have different
aversion to jump risk and diffusion risk, building on Skiadas (2008), and Hugonnier, Pelgrin, and
St-Amour (2012).
       In Appendix F we construct these preference specifications in a recursive framework, and show
in Appendix G, that these preferences provide a micro-foundation to our objective functions for
both the models in Section 2 and Section 4. Specifically our objective function is that of a recursive
utility agent with source-dependent preferences that has constant absolute risk aversion towards
return shocks, but has vanishing risk aversion to shocks driving the investment opportunity set
(i.e., shocks to expected returns, variances, and transaction costs). We note that this ‘source-
dependent’ utility function provides a micro-foundation to the objective function used both here
and in (Gârleanu and Pedersen 2013, GP). Effectively, the GP objective function is consistent with
a preference-specification in which agents exhibit constant absolute risk aversion to the diffusion
shocks driving stock returns, but are risk-neutral to shocks driving the return predicting factors.


B        Continuous-Time model of Price Changes: Infinite Horizon
We begin with a setting with N risky assets, in which the N -dimensional vector of price processes
St , follows the process:
                                          dSt = µ(st )dt + σ(st )dZt                                         (28)

driven by a K-dimensional vector of Brownian motions Zt . The diffusion matrix σ(st ) is (N, K).
µ(st ) and Σ(st ) = σ(st )σ(st )> are, respectively, the N -vector of expected price changes and the
N × N covariance matrix of price changes. Both µ and Σ are a function of a state variable st which
follows a continuous-time Markov chain with transition intensities πs,s0 . For simplicity, we assume
that the risk-free rate is zero, that there are only two states, and that the covariance matrix is
full-rank.21
  21
     In our continuous time formulation, the price process is continuous despite the fact that there may be unpre-
dictable jumps in means and covariances. While this type of price process can be supported in general equilibrium
(e.g., in a Lucas-Breeden exchange economy with a representative log-investor and an aggregate output process that



                                                       59
    We consider the optimization problem of an agent with the following objective function:
                                  Z    ∞                                                    
                                                              1 >            1 >
                       max E                     n>
                                                  t µ(st )
                                                                                           −ρt
                                                             − γnt Σ(st )nt − θt Λ(st )θt e dt                       (29)
                        θt             t=0                    2              2

where nt is the number of shares held by the investor and θt is the trading rate, that is to say,
dnt = θt dt. We assume that Σs , Λs are real, symmetric, positive-definite matrices.22
    We interpret this as an investor who maximizes his expected wealth, E[Wτ ] evaluated at a
random time τ that is exponentially distributed with arrival intensity ρ. The wealth is accumulated
capital gains net of quadratic trading and holding costs. Quadratic holding costs are standard in
many papers (e.g, Duffie and Zhu (2017) and Du and Zhu (2017)). In these papers, holding costs
are constant. In our framework, we assume that holding costs are proportional to the variance of
the position held. For example, one can think of these holding costs as fees charged by a prime
broker or as disutility perceived by a risk-averse investor for holding risky position. In the next
section, we compare this set-up to that of a CARA investor facing quadratic transaction costs.
    So with quadratic transaction and holding costs, the wealth dynamics are given by

                                                1                 1
                                  dWt = nt dSt − θt> Λ(st )θt dt − γn> Σ(st )nt dt,                                  (30)
                                                2                 2 t
                                   dnt = θt dt.                                                                      (31)
                       R∞                              R∞
Note that E[Wτ ] =       0    ρe−ρt Wt dt =             0   e−ρt dWt if the transversality condition limT →∞ E[e−ρT WT ] =
0 holds. We solve this problem using dynamic programming. Define the value function:

                         Z   ∞                                                                          
                                   −ρ(u−t)                          1 >            1 >
      s
     J (nt ) = max E               e                   n>
                                                        u µ(su )   − γnu Σ(su )nu − θu Λ(su )θu du | st = s .        (32)
                  θu         u=t                                    2              2

    The HJB equation is
                                                                             
                           1 >>      1 >          s >            s0  s      s
             0 = max n µs − γn Σs n − θ Λs θ + (∇J ) θ + πs,s0 (J − J ) − ρJ ,
                  θ        2         2

where ∇J s is the gradient of J s (n) and we use the subscript notation to denote the ‘realization’ of
the matrix valued process in a particular state, i.e., M (st )|st =s = Ms . The first order condition is
given by

                                                              θ = Λ−1  s
                                                                   s ∇J .

follows such a process), it would be interesting to consider an extension to the case where the stock prices can also
experience jumps in their levels upon a regime shift. We leave such an extension for future research.
   22
      Naturally we want θ> Λθ > 0 ∀ θ 6= 0. Further, we have θ> Λθ = 12 θ> Λθ + 21 (θ> Λθ)> = θ> ( 12 Λ + 21 Λ> )θ. So if Λ
is not symmetric we can replace it with 12 (Λ + Λ> ) which is.




                                                                     60
Plugging this back into the HJB equation we get:

                           1          1                         s0
                 0 =n> µs − γn> Σs n + (∇J s )> Λ−1  s              s
                                                 s ∇J + πs,s0 (J − J ) − ρJ
                                                                            s
                                                                                                  (33)
                           2          2

We guess that the value function is of the form:

                                                 1
                                      J s (n) = − n> Qs n + n> qs + cs
                                                 2

for some symmetric positive-definite matrix Qs , a vector qs and a scalar cs .
    Plugging this guess into the HJB equation gives

              1
         0 = − n> {Qs Λ−1
                       s Qs + γΣs − ρQs + πs,s0 (Qs0 − Qs )}n
              2
                                                           1 > −1
           + n> {µs − Qs Λ−1
                          s qs − ρqs + πs,s0 (qs0 − qs )} + qs Λs qs − ρcs + πs,s0 (cs0 − cs ),
                                                           2

which is verified if Qs , qs , and cs solve the following set of matrix equations:

                             0 = Qs Λ−1
                                     s Qs + γΣs − ρQs + πs,s0 (Qs0 − Qs )

                             0 = µs − Qs Λ−1
                                          s qs − ρqs + πs,s0 (qs0 − qs )
                                 1
                             0 = qs> Λ−1
                                      s qs − ρcs + πs,s0 (cs0 − cs ).
                                 2

    To interpret the optimal trading strategy, note that the value function is maximized at the
optimal aim portfolio aims = Q−1             s
                              s qs . Since ∇J = −Qs n + qs the optimal trading rate can be
written as:
                                      θ = Λ−1  s   −1
                                           s ∇J = Λs Qs (aims − n)

So with the definition of trade intensity τs = Λ−1
                                                s Qs we get the optimal position:


                                              dnt = τs (aims − nt )dt

    with the same interpretation as in the discrete case.


C     Continuous time model of price changes: Finite horizon
To simplify the comparison to the expected utility framework provided in Appendix D, we consider
now the finite horizon optimization problem. In this case, the agent has the following objective
function:                    Z   T                                               
                                                       1 >            1 >
                     max E                n>
                                           t µ(st )   − γnt Σ(st )nt − θt Λ(st )θt dt             (34)
                       θt      t=0                     2              2
where nt are the number of shares held by the investor and θt is the trading rate, that is dnt = θt dt.
    We interpret this as an investor who maximizes his expected wealth, E[WT ] evaluated at a fixed
time T and faces quadratic transaction costs and holding costs, so that her wealth dynamics are


                                                          61
given by:

                                             1                 1
                               dWt = nt dSt − θt> Λ(st )θt dt − γn> Σ(st )nt dt                            (35)
                                             2                 2 t
                                dnt = θt dt                                                                (36)

   Define the value function:
                                 Z      T                                                           
                                                                1 >            1 >
             s
            J (nt , t) = max E                     n>
                                                    u µ(su )   − γnu Σ(su )nu − θu Λ(su )θu du | st = s    (37)
                        θu               u=t                    2              2
   The HJB equation is

                                                                                     .
                                                                                                   
                            1          1                                 0
                           >
              0 = max n µs − γn> Σs n − θ> Λs θ + (∇J s )> θ + πs,s0 (J s − J s ) + J s
                   θ        2          2
                                                                                    .
where ∇J s is the gradient of J s (n, t) with respect to n and J s is the time derivative.
   The first order condition is

                                                              θ = Λ−1
                                                                   s ∇J
                                                                        s



   Plugging back into the HJB equation we get:

                             1          1                         s0
                                                                            .s
                   0 =n> µs − γn> Σs n + (∇J s )> Λ−1  s              s
                                                   s ∇J + πs,s0 (J − J ) + J                               (38)
                             2          2

   We guess that the value function is of the form:

                                      1
                        J s (n, t) = − n> Qs (T − t)n + n> qs (T − t) + cs (T − t)
                                      2

for some symmetric positive-definite matrices Qs , and a vector qs and scalar cs that are deterministic
functions of time to maturity.
   Plugging into the HJB equation we obtain

                 1                        .
            0 = − n> {Qs Λ−1
                          s Qs + γΣs − Qs + πs,s0 (Qs0 − Qs )}n                                            (39)
                 2
                                    .                        1 > −1      .
              + n> {µs − Qs Λ−1
                             s qs − qs + πs,s0 (qs0 − qs )} + qs Λs qs − cs + πs,s0 (cs0 − cs )
                                                             2

   We see that the guess is verified if Qs , qs , cs solve the following set of ODE:


                                 .
                               Qs = Qs Λ−1
                                        s Qs + γΣs − Qs + πs,s0 (Qs0 − Qs )                                (40)
                                 .
                                 qs = µs − Qs Λ−1
                                               s qs − qs + πs,s0 (qs0 − qs )                               (41)
                                 .    1
                                 c = q > Λ−1 q − c + π 0 (c 0 − c )
                                     s           s    s   s      s        s,s   s   s                      (42)
                                             2



                                                                     62
    subject to boundary conditions Qs (0) = 0, qs (0) = 0, and cs (0) = 0.
    To interpret the optimal trading strategy, note that the value function is maximized at the
optimal aim portfolio aims (t) = Q−1                           s
                                  s (T − t)qs (T − t). Since ∇J = −Qs n + qs the optimal trade
can be written as:
                                   θ = Λ(s)−1 ∇J s = Λ−1
                                                      s Qs (aims − n)

So with the definition of trade intensity τs (t) = Λ−1
                                                    s Qs (T − t) we get the optimal position:


                                       dnt = τs (t)(aims (t) − nt )dt

    with the same interpretation as in the discrete case.


D     The expected utility CARA investor
Instead of assuming a risk-neutral investor with quadratic holding costs for the risky position, here
we assume a CARA investor with wealth dynamics given by:

                                                    1
                                      dWt = nt dSt − θt> Λ(st )θt dt                                  (43)
                                                    2
                                       dnt = θt dt                                                    (44)

    We consider the optimization problem of an agent with the following objective function:

                                              max E −e−γWT
                                                          
                                                                                                      (45)
                                               θt


    Define the ‘value’ function:
                                                    h    RT             i
                                J s (nt , t) = max E −e−γ t dWu | st = s                              (46)
                                               θu
                                         Rt
    We seek a process θ such that e−      0   γdWu
                                                     J s (nt ) is a supermartingale and a martingale at the
optimal θ, that is:


                                                                                      .
                                                                                               
                            1          1                                  0
         0 = max −γJ (n µs − γn> Σs n − θ> Λs θ) + (∇J s )> θ + πs,s0 (J s − J s ) + J s
                        s   >
              θ             2          2
                                                            .
where ∇J s is the gradient w.r.t n of J s (n, t) and J s denotes the time derivative.
    The first order condition is

                                                                ∇J s
                                               θ = −Λ−1
                                                     s
                                                                γJ s




                                                       63
   Plugging back into the ‘HJB equation’ we get:

                                   1           1             ∇J s             0           .
                0 = − γJ s (n> µs − γn> Σs n) − (∇J s )> Λ−1
                                                          s     s
                                                                  + πs,s0 (J s − J s ) + J s
                                   2           2             γJ
                                                                   s (n,t)
   To solve we first do the transformation J s (n, t) = −e−γj                to obtain:

                                                                                     s0 −j s )
                           1          1                       (1 − e−γ(j                         )     .
                       >
                  0 =n µs − γn> Σs n + (∇j s )> Λ−1  s
                                                 s ∇j + πs,s0                                        + js
                           2          2                              γ

   This system of equation needs to be solved numerically. But, by using the approximation
(1−e−γx )
   γ        ≈ x (valid for small γ) the equation simplifies to:

                               1          1                         s0       .s
                     0 =n> µs − γn> Σs n + (∇j s )> Λ−1  s              s
                                                     s ∇j + πs,s0 (j − j ) + j
                               2          2

   Comparing with the HJB equation in (38) obtained in the previous section, we see that the two
equations are identical. Thus, the solution to the approximated HJB equation is identical to that
obtained in the previous section, namely:

                                         1
                           j s (n, t) = − n> Qs (T − t)n + n> qs (T − t) + cs (T − t)
                                         2

for some symmetric positive-definite matrices Qs , and a vector qs and scalar cs all deterministic
functions of time to maturity that solve the same system of ODEs given in equations (40)-(42)
previously.
   We note that as in the previous section, the value function is maximized at the aim portfolio
                                                                 ∇J              s
given by aims (t) = Qs (T − t)−1 qs (T − t) and that, since −Λ−1        −1  s   −1
                                                              s γJ s = Λs ∇j = Λs Qs (T −
t)(aims (t) − n) we can rewrite the optimal trading rule, with τs (t) = Λ−1
                                                                         s Qs (T − t) as:


                                         dnt = τs (t)(aims (t) − nt )dt

   So we see a ‘rationalization’ for our previous model. Essentially, the approximation in the
CARA framework, boils down to making the agent risk-neutral with respect to regime shift shocks,
while making her risk-averse with respect to the Brownian shocks. It turns out we can formalize this
and derive a set of recursive preferences that are consistent with this behavior. These preferences
belong to the source-dependent risk-aversion preferences developed in Hugonnier, Pelgrin, and St-
Amour (2012), as we formalize next. The difference relative to their setting is that they work with
recursive utility of a consumption flow and relative risk-aversion, whereas we develop the model for
consumption at one final date and arbitrary utility functions (that include the absolute risk-aversion
and relative risk-aversion case).




                                                      64
E     Stochastic Differential Utility of Terminal Wealth
Consider an agent with a wealth process Wt who trades in a financial market, where the uncertainty
is generated by a Brownian motion Zt and a Poisson process Nt with intensity λt , and who has
expected utility of terminal wealth with twice-differential, increasing and concave utility function
U (WT ). Note that by definition Mt = Et [U (WT )] is a martingale and therefore we may write:

                                  dMt = σM dZt + ηM (dNt − λt dt)

Now define the certainty equivalent process Ht = U −1 (Mt ) which satisfies the boundary condition
HT = WT . Defining

                               dHt = µH dt + σH dZt + ηH (dNt − λt dt)                            (47)

    Then we have

                1
    dU (Ht ) = [ U 00 (H)σH
                          2
                            + U 0 (H)(µH − ληH )]dt + U 0 (H)σH dZt + (U (H + ηH ) − U (H))dNt
                2

Since Mt = U (Ht ) comparing the two processes we get:

                                 1 U 00 (H) 2          U (H + ηH ) − U (H)
                        µH = −        0
                                           σH + λ(ηH −                     )                      (48)
                                 2 U (H)                     U 0 (H)

It follows that we can define the certainty equivalent of an investor who has expected utility of
terminal wealth as the solution (Ht , σH , ηH ) of a backward-stochastic differential equation:
                                                Z    T
                                Ht = Et [WT −            µH (Ht , σH , ηH )dt]                    (49)
                                                 t

where the driver of the BSDE is given in equation (48) above.
    To summarize, we have shown that, for an agent with an arbitrary wealth process Wt (driven
by Brownian and Poisson shocks) who has expected utility of terminal wealth E[U (WT )], we can
define his certainty equivalent Ht in two different ways. First, the traditional definition Ht =
U −1 (Et [U (WT )]). Second, as the solution of the BSDE given in (48-49) above. Both are perfectly
equivalent definitions. It turns out the BSDE definition lends itself naturally to a generalization
where the agent has source-dependent risk-aversion in that she attaches different risk-aversion to
different sources of risk (in our case, to diffusion versus jump risk).
    Specifically, we define the certainty equivalent of our “source-dependent stochastic differential




                                                     65
utility” agent who consumes only at maturity T , as the solution (Ht , σH , ηH ) of the following BSDE:
                                          Z     T
                         Ht = Et [WT −       µH (Ht , σH , ηH )dt]                                         (50)
                                            t
                                1 U100 (H) 2
                                                                                 
                                                            U2 (H + ηH ) − U2 (H)
                        µH   =−           σ + λ ηH −                                                       (51)
                                2 U10 (H) H                        U20 (H)

where two different (twice-differential, strictly increasing and concave) utility functions Ui i =
1, 2 apply to the different sources of (e.g., diffusion versus jump) risk. In the next section we
provide a heuristic derivation of this recursive utility based on a specific source-dependent certainty
equivalent. This is similar to Skiadas (2008) and Hugonnier, Pelgrin, and St-Amour (2012).23


F      Recursive Construction of the ‘Source-Dependent’ Stochastic
       Differential Utility of Terminal Wealth
Following Skiadas (2008) and Hugonnier, Pelgrin, and St-Amour (2012), we consider a local ap-
proximation argument to show heuristically how to construct recursively the certainty equivalent
Ht of our agent who consumes only at maturity T and has source-dependent risk-aversion. Since
wealth is driven by Zt and Nt , we assume that prior to t, the certainty equivalent has dynamics as
in (47). At any time t < T the certainty equivalent is defined by the following recursion

                        W (Ht , 0, 0) = Et [W (Ht + µH dt, σH dZt , ηH (dNt − λ)dt)]                       (52)

with the boundary condition WT = HT , for some source-dependent risk-aversion function W (z0 , z1 , z2 ).
Note that if W (z0 , z1 , z2 ) = U (z0 +z1 +z2 ) we obtain the same recursive definition as in the previous
section. Instead, here we assume the following function:

                                                            U10 (z0 )
                      W (z0 , z1 , z2 ) = U1 (z0 + z1 ) +             (U2 (z0 + z2 ) − U2 (z0 ))
                                                            U20 (z0 )
Using this we can rewrite the recursion (52), using the Itô rule for the right-hand side as:
                                                                                                  
                                        1                                 U2 (Ht + ηH ) − U2 (Ht )
  U1 (Ht ) = U1 (Ht ) + U10 (Ht )µH dt + U100 (Ht )σH
                                                    2
                                                      dt − U10 (Ht ) ηH −                            λdt
                                        2                                         U20 (Ht )

Simplifying and rewriting we obtain the driver µH of the BSDE which defines the source-dependent
SDU in equation (50) above.
  23
    The only difference is that we do not have any intermediate consumption, and do not restrict to CRRA utility
functions.




                                                        66
G     Source-Dependent SDU with Vanishing Jump Risk
We will now show that our objective function in Appendix C (that is the continuous-time version
of our discrete-time model in Section 2) arises from source-dependent SDU with Ui (x) = −e−γi x
for i = 1, 2 and letting γ2 → 0. Indeed, from the definition in (50) the certainty equivalent of such
an agent is the solution (H, σH , ηH ) of the BSDE:

                                                  T
                                                                           1 − e−γ2 ηH
                                           Z                                           
                                                          1     2
                         Ht = Et WT −                       γ1 σH + λ(ηH −             ) du
                                              t           2                    γ2

    Now, if we let γ2 → 0 then the certainty equivalent is the solution (H, σH ) of the BSDE:

                                                    Z                     T             
                                                                               1     2
                                        Ht = Et WT −                             γ1 σH du
                                                                       t       2

    Further, with Wt dynamics given in (43) above, we guess that the solution is of the form
Ht = Wt + J s (nt , t). Plugging this guess into the BSDE we find it is indeed a solution if J s (nt , t)
satisfies (note that this guess also implies that the diffusion of H is equal to the diffusion of W ,
that is σH = σW ):
                                   Z   T                                                
                     s                                  1    >           1 >
                 J (nt , t) = Et            (nu µ(su ) − γ1 nu Σ(su )nu − θu Λ(su )θu )du
                                    t                   2                2

This is the objective function we considered in Appendix C.

G.1    Random horizon
We can extend our analysis to the case of a random horizon τ with intensity ρ and define the
certainty equivalent utility index for our source-dependent risk-averse investor (who has vanishing
aversion to jump risk) as the solution (Ht , σH ) of the BSDE:
                                                          Z   τ
                                                   1 2
                              Ht = Et [Wτ −         γσH du]
                                                t 2
                                              Z τ
                                                          1 2
                                   = Et [Wt +     {dWu − γσH  }du]
                                                          2
                                              Zt ∞
                                                              1 2
                                   = Wt + Et [     e−ρu {dWu − γσH }du]
                                               t              2

subject to the appropriate transversality condition. The solution to this expression is a continuous
time version of the models we consider in Section 2 and Section 4 of the paper depending on the
assumption we make on the stock price process. Specifically if we assume wealth dynamics of the
form dWt = nt dSt − 12 θ> Λθ we obtain a continuous-time version of our model of price changes in
                                             1 >
Section 2, and if we consider dWt = xt dS
                                        St − 2 u Λu we obtain a continuous-time version of the
                                          t


model of dollar returns considered in Section 4.


                                                                  67
