                              NBER WORKING PAPER SERIES




      MEASURING SUBSTITUTION PATTERNS IN DIFFERENTIATED-PRODUCTS
                              INDUSTRIES

                                          Amit Gandhi
                                      Jean-François Houde

                                      Working Paper 26375
                              http://www.nber.org/papers/w26375


                     NATIONAL BUREAU OF ECONOMIC RESEARCH
                               1050 Massachusetts Avenue
                                 Cambridge, MA 02138
                          October 2019, Revised November 2020




his research has bene ted from the nancial support of the NSF (SES-1530788). We thank the
many seminar participants who have provided feedback on this paper. The paper also greatly
bene ted from discussions with Nikhil Agarwal, Steve Berry, Chris Conlon, Robert Clark,
Joachim Freyberger, Paul Greico, Panle Jia Barwick, Robin Lee, Aviv Nevo, Ariel Pakes, Amil
Petrin, Katja Seim, and Chris Sullivan. The views expressed herein are those of the authors and
do not necessarily reflect the views of the National Bureau of Economic Research.

NBER working papers are circulated for discussion and comment purposes. They have not been
peer-reviewed or been subject to the review by the NBER Board of Directors that accompanies
official NBER publications.

© 2019 by Amit Gandhi and Jean-François Houde. All rights reserved. Short sections of text, not
to exceed two paragraphs, may be quoted without explicit permission provided that full credit,
including © notice, is given to the source.
Measuring Substitution Patterns in Di erentiated-Products Industries
Amit Gandhi and Jean-François Houde
NBER Working Paper No. 26375
October 2019, Revised November 2020
JEL No. C35,C36,L13

                                          ABSTRACT

We study the estimation of substitution patterns within the discrete choice framework developed
by Berry (1994) and Berry, Levinsohn, and Pakes (1995). Our objective is to demonstrate the
consequences of using weak instruments in this non-linear GMM context, and propose a new
class of instruments that are designed to avoid weak IV and can be used to estimate a large family
of models with aggregate data. We argue that strong instruments should reflect the (exogenous)
degree of differentiation of each product in a market (Differentiation IVs), and provide a series of
examples to illustrate the performance of simple instrument functions.


Amit Gandhi
University of Pennsylvania
akgandhi@sas.upenn.edu

Jean-François Houde
Department of Economics
University of Wisconsin-Madison
1180 Observatory Dr
Madison, WI 53706
and NBER
houde@wisc.edu
Introduction
The extent to which competing products are substitutable is central to empirical In-
dustrial Organization (IO) because it is informative about magnitude of market power
and consumer welfare in differentiated-product industries. The econometric frame-
work proposed by Berry (1994) and Berry, Levinsohn, and Pakes (1995) is the lead-
ing approach for estimating demand in this context, and is increasingly popular as
a revealed-preference method to measure quality and value-added in other empirical
microeconomics fields.1 This class of models can approximate very rich substitution
patterns by relaxing the Independence of Irrelevant Alternatives (IIA) assumption un-
derlying logit/CES type demand structures, while at the same time also accounting for
the presence of product-level unobservable attributes (to the econometrician).
    This flexibility however complicates the identification and estimation of substitution
patterns, since the introduction of non-IIA preferences creates a simultaneity problem
associated with the joint determination of market shares and unobserved attributes.
For instance, in a Nested-Logit model (special case of the random-coefficient model),
the price and market shares of products in the same nest are correlated with the model
residual; hence the need for separate Instrumental Variables (IV) (Berry 1994). In
the random-coefficient model, market-shares enter the model non-linearly, and the pa-
rameters governing substitution patterns are estimated using non-linear IV estimators.
This class of estimators is notoriously sensitive to the presence of weak identification;
a problem that is difficult to diagnose (e.g. Stock and Wright 2000).
    The problem of weak identification has received little attention in the demand es-
timation literature, and a review of the empirical literature suggests that it is a poten-
tially a pervasive problem. For instance, there are very few direct applications (known
to us) that have found statistically and/or economically significant departures from
IIA preferences relying solely on demand restrictions.2 In addition, commonly used
moment conditions often lead to numerical optimization problems; another symptom
of weak identification in non-linear models.3
   1
     Examples include models of residential and school sorting (e.g. Bayer, Ferreira, and McMillan
2007, Nielson 2017), and models of adverse selection in insurance markets (e.g. Starc 2014).
   2
     For instance, it is common to impose additional "cross-equation" restrictions originating from
equilibrium supply assumptions (see Berry et al. 1995, Berry, Levinsohn, and Pakes 1999, Eizenberg
2014), micro moments (see Petrin (2002) and Berry, Levinsohn, and Pakes (2004)), or by using more
restrictive models of product differentiation such as the nested-logit or GEV models (e.g. Verboven
1996, Bresnahan, Stern, and Trajtenberg 1997).
   3
     See Metaxoglou and Knittel (2014) and Dube, Fox, and Su (2012) for a discussion of numerical


                                                1
    Our goal in this paper is to develop a new class of strong instruments for estimating
substitution patterns of demand. Strong instruments are relevant instruments that can
flexibly estimate substitution patterns while also circumventing the weak identification
challenges above.4
    In order to build strong instruments, we first theoretically examine the source of
weak identification. Weak identification in non-linear problems arises when the residual
function is weakly correlated with the instruments away from the true parameter value.
As with linear models, the strength of this correlation is measured by regressing the
residual function (endogenous variables) on the instruments. We refer to this regression
as the "reduced form" of the model.
    The main challenge for empirical work is that the strength of the reduced form rela-
tionship cannot be evaluated empirically without knowing the values of the parameters,
e.g., there is no clear analogue of a first-stage regression that is typically employed for
linear models in the non-linear context. In the demand estimation setting, this is com-
pounded by the fact that the number of exogenous variables grows with number of
products in a market, and therefore with the sample size.
    Our main theoretical contribution is to show that this curse of dimensionality can
be solved using implicit restrictions that the demand structure places on the reduced-
form. In particular we show that the reduced-form is a vector symmetric function of
the distribution observed characteristics differences between a given product and the
other products available in the same market. This property is rooted in the symmetry
of the underlying demand function, which is valid in any linear random-utility model
with linear preferences and exchangeable errors.
    This result has important implications: an approximation to the reduced-form can
be obtained using basis functions that summarize the distribution of characteristic
differences (i.e. exogenous measures of differentiation). This implies that relevant
instruments should measure the degree of differentiation of a product relative to others
available in the market. Importantly the number of basis functions necessary to explain
the (unknown) reduced-form is invariant to the number of products in the market. We
propose a series of instrument functions that satisfy this property, and label them
problems/solutions in this context.
   4
     An alternative approach to deal with weak instruments is to estimate the model using estimators
that are robust to weak identification (e.g. Stock and Wright (2000)). Conlon (2013) for instance
describes the properties of an Empirical Likelihood-based estimator applied to BLP, and demonstrates
a weak identification problem associated with commonly used instruments.



                                                 2
Differentiation IVs.
    Our second contribution is to the detection of weak instruments. We show that
an instrument is weak if it fails to reject the null hypothesis of IIA preferences. This
hypothesis can be tested by estimating the (linear) reduced-form of the model under
Logit preferences. This reduced-form is also a symmetric function of the distribution
of characteristics differences, and Differentiation IVs can therefore be used to test
the IIA hypothesis. Importantly this test is not accompanied by a statistical criteria
to determine when an instrument function is "too weak". However, it provides a
useful approach the analyze empirically the sign and strength of the reduced-form
relationships; despite the presence of a large number of endogenous variables, and the
non-linearity of the model.
    These two results suggest a sequential approach estimation. First, the theory can
be used to construct candidate instruments; the form of which can vary depending the
structure of the data. Second, researchers can evaluate the strength of the proposed
instruments by testing the IIA hypothesis. We illustrate this approach empirically
using Monte-Carlo simulations, and by estimating a model of demand for new cars.
    Our simulation results show that the proposed instruments, by eliminating the
weak IV problem, can improve substantially the precision of the estimates (by a fac-
tor of 10 in some cases), and the numerical performance and speed of the non-linear
optimization algorithms used to estimate the parameters. We discuss how to adapt
our identification strategies to settings with correlated random-coefficients, endogenous
product attributes and large dimension problems. We also compare our results with
the Optimal IV approximation proposed by Berry, Levinsohn, and Pakes (1999), and
a model with endogenous attributes identified using quasi-experiment variation.
    We then illustrate the IIA test by revisiting the car application first studied by
Berry et al. (1995). We find statistically significant deviations from IIA along (at
least) three dimensions: price, car size (doors), and air-conditioning. Using measures
of differentiation along these three dimensions as instruments, and show that it is
possible to precisely estimate the random-coefficient parameters (controlling for brand
and market fixed-effects), without relying on restrictions external to the demand model
(e.g. supply-side or external survey data). This is important, since ability to identify
substitution patterns without relying on an equilibrium model of supply is central to
the analysis of firm conduct in Industrial Organization (Bresnahan 1982, Berry and
Haile 2014).


                                           3
     A growing number of papers using our instruments confirm these results. The
Differentiation IVs introduced in this paper have now been used to obtain precise
estimates of substitution patterns in a variety of applied contexts, ranging from demand
for cars (Miravete, Moral, and Thurk 2018, and Co¸      sar, Grieco, and Tintelnot 2018),
scanner data (Miller and Weinberg (2017), Sullivan (2020), Dube, Hortacsu, and Joo
(2020)), and school choice (Singleton 2019). See also Conlon and Gortmaker (2019)
for additional Monte-Carlo simulation results.
     Our paper is related to a set of recent papers that have also raised concerns about
the efficiency of instruments used in standard practice and explored alternative instru-
mental variable strategies for differentiated product demand models. Many of these
papers are focused on approximating the optimal instruments for GMM under the
conditional moment restrictions of the model in the sense of Amemiya (1977) and
Chamberlain (1987). For example, Reynaert and Verboven (2013) discussed the loss of
efficiency associated with commonly used instruments, and analyze the small sample
performance of the approximation to the optimal instruments proposed by Berry et al.
(1999). Salanie and Wolak (2019) propose an estimation and specification selection
procedure based on the Gauss-Newton regression, which also rely on the Jacobian of
the residual function.
     The challenge with these approaches is that they require a starting value for the
non-linear parameters that are in a reasonable vicinity of the true value, which itself
requires an initial choice of instruments by the researcher to determine an initial value.
If the initial instrumental variable are weak, these optimal IV refinements will have a
difficult time escaping the weak-IV regime.
     Our approach is ultimately complementary to these methodologies by focusing on
the weak instruments problem directly. Differentiation IVs can be used as in input to
these procedures by obtaining initial estimates that are not subject to the weak IV
problems. An approximation to the Optimal IV using these approaches can be used to
obtain further efficiency gains. As discussed in Conlon and Gortmaker (2019), this is
now considered the empirical "best practice" for estimating this class of models. How-
ever Differentiation IV's have applications beyond sheer efficiency of estimation and
can be used to estimate, test, and compare different models of product differentiation.
This arises because a key advantage of our approach is that our characterization of the
reduced-form does not depend on the distribution of the random-coefficient, or on the
value of the parameters. Having instruments that are agnostic to the parametrization


                                            4
of demand heterogeneity allows researchers to to test alternative specifications and gain
applied insights into the appropriate structure of demand for the data at hand.
    The instruments that we propose are also similar to the instruments commonly
used to identify nested-logit and spatial differentiation models.5 A key contribution of
our paper is to show that the intuition underlying these instruments for the particular
differentiation structure they apply generalizes to the broader family family of charac-
teristics models with random coefficients. We also derive an instrument function that
can exploit variation in demographic characteristics across markets, similar to the one
proposed by Romeo (2010).
    The rest of the paper proceeds as follows. In the next section, we describe the
model, and formally define the weak-identification problem. Sections 2 and 3 present
our main theory results. We first derive our main theoretical result, and illustrate
its implication for parametric and non-parametric estimation of the model. We then
present a series of Monte-Carlo simulations in section 4 to analyze the finite-sample
properties of the instruments. Section 5 applies the instruments to the estimation of
a mixed-logit model of demand for new cars. The appendix include the proof of the
main propositions, and computation details related to the Monte-Carlo simulations
and application.


1       Description of the model
In this section we introduce the general notation that we will use throughout the paper.
We also describe the identifying assumptions and the GMM estimator.


1.1     Model assumptions
Consider a panel data-set summarizing the characteristics and demand of differentiated
products in T independent markets. Each market t is composed of Jt products, and
each product j is characterized by a vector of observed (to the econometrician) product
characteristics xjt  RK and an unobserved characteristic jt . We will refer to xt =
(x1t , . . . , xJt ,t ) as a summary of the observed market structure - the entire menu of
observed product characteristics available to consumers in market t (i.e. Jt × K matrix).
The vector of prices for market t are denoted by pt = {p1t , . . . , pJt }. Similarly, st =
    5
    See in particular Berry (1994), Bresnahan, Stern, and Trajtenberg (1997), Pinkse, Slade, and
Brett (2002), Davis (2006), Thomadsen (2007), and Houde (2012).

                                               5
{s1t , . . . , sJt } is the vector of observed market shares, which is defined such that 1 -
   Jt
   j =1 sjt = s0t is the market share of the "outside" good available to all consumers in
market t. We normalize the characteristics of the outside good such that x0t = 0.6 We
impose three assumptions on the model and data-generating process.
     Our first assumption, refers to the shape of the indirect utility function generating
choices. We assume that the preference of consumers can be summarized by a linear-
in-characteristics random-utility model with a single-index unobserved quality.

Assumption 1. Each consumer i has linear preferences for products j = 0, 1, . . . , Jt :

                                                        K2
                                                                  (2)
                               uijt = jt + ip pjt +           ik xjt,k +    ijt                              (1)
                                                        k=2

                                                                                          (2)
where jt = xjt  + jt is labelled as the "mean utility" of product j , xjt is a sub-vector
of xjt (i.e. non-linear attributes), ijt is an IID random-utility shock for product j , and
 i = {ip , i2 , . . . , iK2 } is the vector of random-coefficients for consumer i.

   When ijt is distributed according to a T1EV distribution, the aggregate demand
function for product j can be written as follows:
                                                                        (2)
                                             exp ip pjt +        k vik xjt,k   + jt
                   (2)
        j     t , xt , pt ;    =                                                                dF ( i ; )   (2)
                                             Jt                                (2)
                                      1+     j =1 exp   ip pj t +       k vik xj t,k   + j t

 where F ( i ; ) denotes the joint distribution of the random-coefficient vector in market
           (2)      (2)      (2)
t, where xt = x1t , . . . , xJt ,t and  t = (1t , . . . , Jt ,t ). We maintain the mixed-logit
parametric functional-form in our simulations below, since it is the workhorse model
used in the literature. However, our theoretical results do not depend on this particular
distributional assumption, and are relevant for a broader family of characteristic mod-
els; including the pure-characteristic and semi-parametric demand models with linear
preferences (e.g. Berry and Pakes 2007 and Compiani 2019).
    Our second assumption is related to the conditional distribution of the model resid-
ual. Following Berry et al. (1995) and Berry and Haile (2014), we assume that jt vary
independently of the choice-set that consumers face, and vector of price instruments
wt . Assumption 2 formalizes this identifying restriction.

  6
      Thus each characteristic can be interpreted in terms of differences relative to the outside good.



                                                    6
Assumption 2. The unobserved quality of products has mean zero conditional on the
observed menu of characteristics xt and price instruments wt ,

                                        E [jt | xt , wt ] = 0.                                           (3)

    Two broad sources of variation have been proposed in the literature to construct
valid price instruments: (i) markup-shifters, and (ii) cost-shifters. See Berry and Haile
(2016) for a review. In this paper we assume the researcher has access to excluded
price instruments, and focus instead on constructing instrumental variables for market-
shares.
    Finally, our third assumption further restricts the joint distribution of the error
term {1t , . . . , Jt ,t }.

Assumption 3. The joint distribution of the unobserved quality of products is ex-
changeable in the identity of products:

              Pr(j,t < c|1,t , . . . , j -1,t , j,t , . . . , Jt ,t ) = Pr(j,t < c|(-j ),t )

for any ordering function ().

    In economics terms, this assumption implies that the identity of rival products is
not important to predict the distribution of unobservable attributes. This assumption
is not novel in the literature, and allow us to pool moment conditions across products.
See discussion in Berry et al. 1995 (section 5.1). This assumption does not rule out
the possibility that brand or product fixed-effects are relevant for consumers' decisions,
and enter the indirect utility function linearly (e.g. Nevo (2001)).
    Following Berry (1994), the inverse demand function is used to define the residual
function of the model:

                      (2)
      sjt = j xt , pt ,  t ;              j = 1, . . . , Jt
                                       -1                     (2)
                j (st , xt , pt ;  ) = j  st , xt , pt ;  - xjt                      j = 1, . . . , Jt   (4)

where  = ( , ) is the full parameter vector of dimension m. The inverse-demand
function assigns quality levels to each product in order to matches the observed market-
shares, for a given guess of the parameter . Existence and uniqueness of this inverse



                                                    7
mapping follows directly from Berry et al. (1995).7 A simultaneity problem arises
because market shares (and prices) of rival products enter the inverse-demand non-
linearly, and are correlated with the model residual. Importantly, even with exogenous
prices, non-linear least square leads to a biased estimator of (,  ).8
    Theorem 1 in Berry and Haile (2014), shows that the parameters can be identified
by imposing the following conditional-moment restrictions (CMR):

           rjt ( ) = E j (st , xt ;  ) xt , wt
                            -1              (2)
                        = E j  st , xt , pt ;  |xt , wt - xt  = 0                iff  =  0 .        (5)

The second term calculates the expectation of product j 's inverse-demand, conditional
on the menu of product characteristics available in t. This expectation is taken over
the endogenous variables of the model: the vector of market shares and prices.


1.2     Instrument relevance and the curse of dimensionality
The standard approach to estimate  is to form L  m unconditional moment restric-
tions, consistent with the CMRs defined in equation (5):

                            E j st , pt , xt ;  0 · z jt = 0 If  =  0                               (6)

where z jt = {xjt , Aj (xt , wt )}. The instrument function, Aj (xt , wt ), defines the set of
excluded instruments characterizing the menu of characteristics in market t.
   How should the instrument function be chosen? In linear models, excluded instru-
ments are relevant if they exhibit a strong reduced-form correlation with the endoge-
nous variables of the model. In non-linear models, the role of the instruments is to
   7
     See also Berry, Gandhi, and Haile (2013) for a general proof that does not rely on the type-1
extreme-value distribution assumption.
   8
     To see this, consider a model without prices. In this case, the first-order condition of non-linear
least-square with respect to  is not satisfied at the true value of the parameters because the market
               -1
shares enter j    (·):

                       -1        (2)                              -1       (2)
             1         j  (st , xt ; 0 )                          j  (st , xt ; 0 )
                                         · jt (st , xt ;  0 ) p E                   · jt = 0.
             n   j,t
                                                                       

This echoes the discussions in Jorgensen and Laffont (1974) and Amemiya (1974).




                                                      8
approximate rj ( ) from equation (5):

                     rj ( )  L j (st , xt ;  ) xt , wt = l(z jt ;  ),

                                             (2)
where l(z jt ;  ) is a projection of jt (st , xt , pt ;  ) onto z jt . The GMM identification
condition can be restated in terms of a zero function:

                                l(z jt ;  ) = 0 if  =  0 .

Weak identification arises when this condition is nearly satisfied in the population away
from true parameter value:

                                l(z jt ;  )  0 if  =  0 .

This leads to an empirical problem: In finite sample it is difficult to detect departures
from  =  0 and the confidence intervals become large (Stock and Wright 2000).
    The avoid this problem, researchers need to find a vector of excluded instruments,
Aj (xt , wt ), that can explain the residual function at an arbitrary parameter  . The
upper bound on the strength of the instruments is given by rj (xt , wt ; ). Ideally, the
chosen instrument function can approximate the function arbitrarily well. Formally,
Donald, Imbens, and Newey (2008) show that an instrument function is efficient if it
satisfies a "spanning condition": it can approximate any function aj (xt , wt ) arbitrarily
well as the dimensionality of Aj (·) goes to infinity.
    As discussed in Donald et al. (2008), "low-order approximating functions (e.g.
linear or quadratic) often provide the most information". Without imposing further
restrictions, this is not the case in the differentiated product context, since even low di-
mension basis functions suffer from a curse of dimensionality problem. Formally, a curse
of dimensionality exists because the reduced-form of the model is a product-specific
function of the entire menu of product characteristics available in the market. Recall
that the number of exogenous variables (xt , wt ) is equal to K × Jt , and the number
of endogenous variables in the structural equation is equal to 2 × Jt . In many appli-
cations the number of products is at least as large as the number of markets/periods.
Unless the number of products is assumed to be constant and small relative to the
number of markets, the number of terms necessary to approximate the function grows



                                              9
exponentially.9
    Therefore, in most settings, it is impossible to approximate the conditional moments
without additional restrictions. This is an important problem for empirical work,
since there is a very large number of valid potential instrument functions satisfying
Assumption 2, most of which weakly identify model.


2       Exchangeability and the choice of instruments
The previous discussion highlights the role of the instruments in approximating the
conditional moment restrictions. In order to derive a class of relevant instrument
functions, it is useful to decompose the expectation of the residual function in two
components:

                                rjt ( ) = j (xt , wt ) - xjt 

                             -1                 (2)
We refer to j (xt , wt ) = E j  st , xt , pt ;  |xt , wt as the reduced-form of the
             -1
model. Let j    (st , pt ; ) = xjt  0 + j () + jt denotes the inverse demand function
evaluated at parameter , expressed as function of the quality gap relative to jt :

                            -1            (2)      -1            (2)
                    jt () = j  (st , xt , pt ; ) - j  (st , xt , pt ; 0 ).

Using this notation, the reduced form is approximated by the instruments via a linear
projection:

                    jt (xt , wt ; ) = E xjt  0 + j () + jt xt , wt
                                      xjt  1 + Aj (xt , wt ) 2 + 0,                           (7)

and l(z jt ;  ) = z jt  - xjt  is the linear projection approximating the conditional
moments.
    The reduced-form parameters  2 determines the strength of the correlation between
the excluded instruments, and the quality gap evaluated at parameter . An instru-
ment function is relevant if  2 is jointly different from zero in the population. For
instance, at   0 = 0 , the model exhibits IIA preferences, and jt () is positive
    9
    Note that this does not affect the identification result in Berry and Haile (2014), since they
consider data-generating processes with infinitely many products (i.e. T  ).


                                                  10
for products with few substitutes. In contrast, products that are undifferentiated along
                (2)
the price or xjt dimensions are assigned a negative quality gap. When  2 is (jointly)
close to zero in the population, the instruments are unable to explain this type of
deviations in the assignment of product quality. This leads to a weak identification
problem since the linear projection is not statistically different from zero away from
the true parameters.
    Our objective in this section is to develop a theory-driven approach to constructing
instruments that can approximate the reduced-form function j (xt , wt ), while circum-
venting the curse of dimensionality problem. We show that the symmetry of the
demand system implies that the reduced-form can be written as a symmetric function
of the distribution of characteristic differences; a property that breaks the curse of
dimensionality.
    We first illustrate this result in the context of a model without endogenous prices.
Section 2.2 relaxes this assumption. Section 2.3 introduces two classes of instrument
functions that satisfy the symmetry property.


2.1     Exogenous characteristics
With exogenous characteristics, we can write the conditional-moment restrictions as a
function of the menu of characteristics xt (dropping wt ):

                             E [j (st , xt ;  ) |xt ] = j (xt ; ) - xjt  = 0.

    Let us define djt,k = xjt - xkt to be the vector of characteristic differences between
product j and product k in market t, and let djt = (djt,0 , . . . , djt,j -1 , djt,j +1 , . . . , djt,Jt )
                                                                 (2)
be the matrix of differences relative to product j . Similarly, djt is a matrix of non-linear
                                                                      (2)
characteristic differences. Furthermore, let  jt,k = skt , djt,k denotes an ordered pair
associated with each product k = 0, . . . , Jt in the market (including the outside good)
for a given inside product j > 0, and let  jt = { jt,k }k=0,...,Jt . We now have the
following result which is proven in Appendix A.

Proposition 1. Under the linear in characteristics random utility model the inverse-
demand
               -1       (2)
              j   st , xt ;  = f ( jt ; ) + Ct (), j = 1, . . . , Jt             (8)

where Ct is a market-specific constant and f is a symmetric function of  jt .

                                                   11
    The proof can be sketched as follows. We first recognize that the identity of products
or the level of product attributes is irrelevant to predict consumers' discrete choice.
Therefore, we can abstract from the identity of products by expressing the demand
function in terms of characteristics differences relative to product j . Furthermore,
rather than normalizing the quality index of the outside good to zero, we rescale the
quality index to be between zero and one: jt = exp(jt )/ 1 + j t exp(j t ) for all
j = 0, . . . , Jt . This new normalization has the advantage of treating the outside option
symmetrically with respect to the other options, and explains the presence of a market-
specific intercept in equation (8).10 These two normalizations imply that the demand
function for product j is a fully exchangeable function of the structure of the market
                                     (2)
relative to product j : mjt = (djt,k , 0t )          . The inverse mapping associated with
                                                   k=0,...,Jt
this demand representation maintains the same symmetry and anonymity properties.
    There are two key implications of Proposition 1. The first is that the inverse-demand
            -1        (2)
function j      st , xt ;  is no longer indexed by product j , once we condition on a
vector of state variables  jt of the products competing with j in a market.11 The second
implication is that f (·) is a symmetric function of the states of the competing products.
Proposition 1 can be viewed as an extentension of the the partial-exchangeability result
obtained in Pakes (1994) to reduce the dimensionality of equilibrium strategies in
differentiated product markets (e.g. investment and pricing).
    The following proposition constitutes our main theoretical result, and state that
the reduced-form of the model can be written as symmetric functions of the vector of
characteristic differences.

Proposition 2. If the distribution of {1t , . . . , Jt ,t } is exchangeable, the conditional ex-
pectation of the inverse-demand is a symmetric function of the matrix of characteristic
differences:
                             j (xt ; ) = g (djt ; ) + ct ()

where ct is a market specific constant.

   The proof can be sketched as follows. Recall the expectation operator defining the
reduced-form function in equation (5) is taken over the market shares vector; which cor-
                                                                                         -1
  10
       The market intercept corresponds to: Ct () = ln          1-   j 1   D-1 (jt ; )        , where D(jt ; )
is the (symmetric) demand function for product j .
   11
      Observe that the state ,  jt,k of a rival k = j does not contain its own product characteristic , xkt
but rather the difference, xkt - xjt , relative to j .


                                                    12
responds to the demand functions. Since the demand for each product is symmetric,
the density of shares can be re-written as a function of the entire vector of charac-
teristics differences and the joint density of unobservable quality jt . This involves
re-ordering the vector of characteristic differences to predict the marginal distribution
of each product's market share, and does not require knowing the identity of each in-
dividual product (under Assumption 3). This establishes that the expectation of the
inverse-demand is a symmetric function of the matrix djt , because the joint distribu-
tion of market shares and the integrand itself are symmetric functions of characteristic
differences.


Relevant instrument function: Differentiation IVs
Proposition 2 is important because it allows us to allows us to use low order approxi-
mations of the reduced form without the problems of curse of dimensionality discussed
above. A relevant instrument is a function that satisfies the symmetry property, while
summarizing the distribution of characteristics differences relative to product j . Since
these functions measure the degree of differentiation, we label them Differentiation
IVs.
    To understand why the symmetry of the reduced-form solves the curse of dimension-
ality problem, consider a special case of the model with a single attribute, xjt . In this
case, the state space is given by a Jt × 1 vector with element k given by: djt,k = xkt - xjt .
If we use a monomial basis to approximate  , the first order polynomial can written
as follows:


                            g (djt ; )             j djt,j = 1 ·          djt,j
                                            j =j                   j =j


The equality follows directly from the symmetry of the reduced-form function. Since
we can re-order the products without changing the inverse-demand, g (djt,-j ; ) =
g (djt,(-j ) ; ), the coefficients of the polynomial function must be equal across products.
The second order polynomial approximation takes a similar form:
                                                                                                             2
                                                                                     2
g (djt ; )               j ,k djt,k djt,j = 1 ·       djt,j  + 2 ·           djt,j       + 3 ·           djt,j 
              j =j k=j                         j =j                 j =j                          j =j




                                                      13
    The symmetry property restricts the number of basis-functions to at most three.
The first and last terms exhibit little variation across products within a market, es-
pecially when the number of products per market is large. We therefore focus on the
sum of square of characteristic difference as the relevant term to construct the instru-
ment function (Donald et al. 2008). Importantly, this instrument has an economic
interpretation since it measures the (square of) Euclidian distance of product j along
dimension x.
    Another common class of basis functions that exploit the symmetry of the function
is the spline. Consider for instance a linear B-Spline. The basis function over sequence
of knots c1 , . . . , cM is:
                                    
                                    1 If c < d
                             m            m   jt,j < cm+1
                            Bjt,j                                                          (9)
                                    0 Else.

This would lead to the following approximation function:

                                          M                      M
                                                 m                      m
                       g (djt ; )               Bjt,j   j ,m =         Njt,j m            (10)
                                     j =j m=1                    m=1

                                                                          m             m
Where the last equality imposed the symmetry of the function, and Njt,j       = j =j Bjt,j
is the number of rival products located with the neighborhood (cm , cm+1 ) of product
j . Again this instrument function correspond to a commonly used measure of product
differentiation in the literature.
    In summary, Proposition 1 and 2 solve the curse of dimensionality in two ways.
First, by expressing the state of the industry in differences (rather than in levels), it
is no longer necessary to condition on the identity of products to express the inverse-
demand function. This allows us too "pool" observations within and across markets
since the same inverse-demand equation is used to explain the data on all products (j, t).
Second, under Assumption 3, the expectation of the inverse demand is an exchangeable
function of the vector of characteristics difference. This implies that the inverse-demand
is function of the magnitude of characteristic differences, not the identity of competing
products. As the previous example illustrates, this leads to a substantial reduction in
the number of basis functions necessary to approximate the reduced-form.12
  12
   See Altonji and Matzkin (2005) and Farias, Saure, and Weintraub (2012) for a related uses of
symmetric functions.


                                                 14
2.2     Endogenous attributes
Incorporating endogenous characteristics, such as prices or advertising, adds an addi-
tional simultaneity problem: in equilibrium these characteristics are correlated with
the unobserved quality of products (Berry, Levinsohn, and Pakes 1995).
    To see how this changes the reduced-form function, consider the following inverse-
demand with endogenous prices:

                         -1       (2)
                         j  st , xt , pt ;  = f ( jt ; ) + Ct ().

                                                           (2)
Element k of the state vector  jt now includes: {skt , djt,k , dp              p
                                                                jt,k }, where djt,k is the price
differences between product j and k . This inverse demand is generated from a model
in which consumers have heterogenous price coefficients (as in Bresnahan (1987) for
instance).
    As before, f (·) is a symmetric function of the industry state vector  jt . Although
the conditional expectation of this function is also symmetric, the conditional mean
restriction used in equation (5) to identify the model is no longer satisfied at  0 :

                   (2)
      -1
    E j  s t , x t , pt ;  0    xt , pt - xjt  0 = g (djt , dp    0        0        0
                                                             jt ;  ) + ct ( ) - xjt  = 0.


    The challenge is that the reduced-form of the model cannot be written as a sym-
metric function of the distribution of characteristics differences {djt , dwjt }. To see this,
recall that the symmetry of the reduced-form arises from the symmetry of the demand
function itself. With endogenous prices, the conditional expectation of the inverse de-
mand is taken with respect to the joint distribution of (st , pt ) given (xt , wt ), which
is determined endogenously by the conduct of the industry. Except in special cases
such as monopoly or single-product Bertrand-Nash, this distribution is not a symmet-
ric function of characteristic differences. This is because the identity/ownership of
products plays an important role in determining the distribution of markups.
    Importantly, this does not mean that it is infeasible to construct valid/relevant
instruments. It simply means that we cannot solve the curse of dimensionality problem
without relying on a heuristic approximation. We proceed in two steps.
               ^jt  E (pjt |xt , wt ) denotes an estimate of the reduced-form pricing equa-
    First, let p
tion constructed from observed characteristics. This exogenous price measure can be
constructed using regressions exploiting random variation from cost and/or ownership


                                              15
shocks (as in Reynaert and Verboven (2013)), or by solving an equilibrium pricing
game after setting jt = 0 (as in Berry, Levinsohn, and Pakes (1999)). The choice of
the approach is application/data specific. For instance, when using a regression ap-
proach, p^ can be estimated using flexible functional forms or non-parametric regression
techniques to improve the quality of the fit. Since p  ^jt is constructed from (xjt , wjt ),
the following conditional moment restriction is satisfied:

                                    E [jt |xt , p
                                                ^ t ] = 0.

   Second, following Berry, Levinsohn, and Pakes (1999), we use the following heuristic
approximation of the reduced-form:

            -1          (2)                      -1            (2)
          E j  s t , x t , pt ;    xt , w t    E j            ^ t; 
                                                    st , xt , p                ^t
                                                                          xt , p

                                              = g djt , dp
                                                         ^
                                                         jt ;  + ct ()                 (11)

The idea behind the heuristic is to distribute the expectation operator over prices
                                  -1
inside of the non-linear function j  (·). The second equality follows from the fact that
after replacing pjt with predicted value p^jt , we obtain a reduced-form representation
of the reduced-form that is symmetric in {d, dp   ^
                                                  jt }. In what follows, we will construct
instrument functions that exploit the symmetry of this function.


2.3    Practical implications
In this section, we propose two classes of low-order instrument functions that satisfy
the symmetry property, and exhibit variation across products. Depending on the data
and richness of the model, more or less complicated functions can be used. As we
alluded to earlier, the key is to select instrument functions that predict differences in
the inverse-demand of products (within a market) as we vary the main parameters of
the model.
    Our first example uses the leading terms of a second-order symmetric polynomial




                                              16
basis function (focussing only on the binary interaction terms):
                           
                           wjt
                           
                                                                         Price IVs
                                                2
                           
                                        dp
                                         ^
                                                        ,   k            Isolation j in price
                           
                                j =j     jt,j
         Aj (xt , wt ) =                                                                               (12)
                                                2
                           
                           
                           
                                j =j    dk
                                         jt,j       ,       k            Isolation j in xk
                           
                                       dk       l
                           
                                        jt,j × djt, ,            k = l   Interaction: k and l
                           
                                j =j


 where dk jt,j = xj t,k - xjt,k measures the difference between product j and j along
dimension k . Note that one dimension refers to the price. The interaction terms for
which l = k , capture the covariance between two dimensions of differentiation, while
the sum of square measure the isolation of products in the characteristic space.
    Our second instrument function is based on the linear B-spline example discussed
above; considering only the characteristics of "close" rivals when summarizing the
market structure facing each product. In most models of product differentiation (e.g.
quality-ladder, hotellling, nested-logit etc), the demand for each product is most heavily
influenced by a small number of alternatives with similar characteristics, which is why
to focus only on the fist Spline segment. For instance in a "mixed-logit quality-ladder"
model, as the variance of the logit shock goes to zero, the inverse demand of product j
is only a function of the characteristics of products located to the right and left in the
quality rank.
    This feature suggests the following instrument vector:
                    
                     wjt                                                     Price IVs
                    
                              1 |dp
                                  ^
                                  jt,j | < 
                                           p^
                                              ,              k               Isolation of j in price
                    
                       j =j
  Aj (xt , wt ) =                                                                                      (13)
                                l        k
                       j =j 1 |djt,j | <   ,                 k               Isolation j in xk
                    
                              1 |dl        k
                                             × dl
                    
                                  jt,j | <      jt, ,               k = l    Interaction: k and l
                    
                       j =j


 where k is a proximity threshold (e.g. standard-deviation of xjt,k across all markets).
The second element measures the number of "close-by" rivals along each dimension
of differentiation. The interaction of the indicator function with djt,j captures the
correlation in characteristics between firms that are direct competitors. When charac-
teristics are discrete, the indicator variables can be replaced by 1(dk
                                                                      jt,j = 0); which can
be thought of as a product-segment indicator. Moreover, additional neighborhoods can


                                                            17
be constructed to impose additional restrictions on the model (e.g. 0 < |djt,j |  1 ,
1 < |djt,j |  2 , etc.)
    The two formulations of the Differentiation IVs in equations (33) and (13) can
include a large number of terms depending on the number of characteristics. In general,
it is advisable to select a subset based on the amount of variation across products
and/or markets. For instance, it is common for some product characteristics to exhibit
very little variation across markets. In Nevo (2001), the non-linear characteristics vary
                                 (2)     (2)
only at the product level (i.e. xjt = xj j = 1, . . . , 25), while prices vary both at the
product and the market level. Using exogenous variation in prices across markets, we
can construct instruments as follows:


      Aj (xt , wt ) =   wjt ,          1 |d1
                                           j,j | < 
                                                   1
                                                     dp
                                                      ^
                                                      jt,j , . . . ,          1 |dK
                                                                                  j,j | < 
                                                                                          K
                                                                                            dp
                                                                                             ^
                                                                                             jt,j   .   (14)
                                j =j                                   j =j


According to this formulation, the magnitude of the heterogeneity associated with
market-invariant characteristic k is identified from (exogenous) variation in the rela-
tive prices of products that are more or less differentiated from product j along that
particular dimension.
    Incorporating demographic characteristics in the instrument function is straight-
forward. Appendix A.3 provides an example in which a random coefficient is an ad-
ditive function of income (yit ). If the distribution of income can be standardized (i.e.
yit = mt + sdt eit , where eit   (eit )), the reduced-form of the model can be written
as a symmetric function of characteristics differences and moments of the demographic
distribution:
                                                     (2)
                         jt (xt ; ) = g djt , sdt · djt ;  + ct ()                  (15)
                                                                                                         (2)
In addition, the average utility index (jt ) includes an interaction variable: mt · xjt .
This variable can be used as an excluded instrument (as in Miller and Weinberg (2017)).
Therefore, in this example the instrument vector includes the full vector of products'
                                        (2)
own characteristics (including mt · xjt ), as well as moments of the distribution of
characteristics differences interacted with the standard-deviation of yit in market t.
   The takeaway is that market-specific moments of the distribution of demographics
should enter the instrument function as interaction terms with product characteristics
and differentiation measures, rather than as stand-alone variables.13
 13
      See Romeo (2010) for a similar argument and simulation results showing the importance of ac-


                                                        18
    How does this formulation differ from the existing literature? Interestingly, the
basis function for the first-order polynomial formulation corresponds to the suggestion
in Berry et al. 1995 of using the sum of product characteristics as instruments. The
logic of using exogenous measures of differentiation has been used in other settings.
However, the relevance of exogenous measures of differentiation is most often justified
by their ability to predict prices (or markups), rather than to identify the non-linear
parameters. There exist two important exceptions: the nested-logit model (e.g. Berry
1994, Bresnahan, Stern, and Trajtenberg (1997)), and models of spatial differentia-
tion (e.g. Pinkse, Slade, and Brett 2002, Davis 2006, Thomadsen 2007, Houde 2012,
Singleton 2019). In both literatures, the standard instruments correspond to different
versions of the proximity measures described in equation (13). From this perspective,
an important contribution of our approach is to formally show that the intuition devel-
oped in these prior literatures remains relevant in the more general random-coefficient
model.


3     Additional implications for estimation and test-
      ing
In this section we discuss three additional implications of the exchangeability results
from Section 2 for the identification and estimation of the model. We start by discussing
approximation to the optimal instruments, and the non-parametric estimation of the
model. We then propose a test of instrument relevance that can be used in the case of
the multinomial Logit model with random coefficients.


3.1     Optimal IV approximation
A direct implication of Proposition 2 is that the optimal instruments introduced by
Amemiya (1977) and Chamberlain (1987) can be written as symmetric functions of the
distribution of characteristic differences relative to product j . The following corollary
establishes a direct connection between product differentiation and optimal instru-
ments.

counting for interactions between product characteristics and the mean of demographic attributes in
the instrument vector.



                                                19
Corollary 1. If the distribution of {1t , . . . , Jt ,t } is exchangeable, the conditional ex-
pectation of the derivative of the residual function is a symmetric function of the matrix
of characteristic differences:

              jt (st , xt | )
          E                   xt = gk (djt ; ) + ct,k (),     k = 1, . . . , dim()
                  k

where ct,k is a market-specific constant.

    This implies that it is feasible to find basis-functions that can approximate the
optimal instruments, while avoiding the curse of dimensionality problem. Therefore, a
valid strategy to improve the efficiency of the estimates is to obtain first-stage estimates
using the instruments proposed in this paper, and then construct an approximation
to the optimal IV. The second-stage can be conducted using non-parametric regres-
sions as discussed in Newey (1993), or the heuristic approximation discussed in Berry,
Levinsohn, and Pakes (1999) and Reynaert and Verboven (2013).
    This later approach relies on the following instrument function:

                     (2)                            (2)
     j (st , pt , xt ;  )                   ^ t , xt ;  )
                                    j (st , p
   E                      xt , w t                                      = Aj (xt , wt | ).   (16)
                                                            jt =0,j,t


Since the instrument vector depends on  , users must first obtain an estimate of the
parameters, denoted by  1 . This leads to a two-step estimator: (i) estimate  1 by
GMM using instrument vector z jt , and (ii) construct Aj (xt , wt | 1 ) and estimate ^ by
GMM.
    Although this approach works well in practice (Reynaert and Verboven 2013), the
performance of the estimator depends on using strong IVs in the first-stage estimates.
This suggests a strong complementarity between the two approaches as discussed in
Conlon and Gortmaker (2019). The second-stage estimates are more precisely esti-
mated when the Differentiation-IVs are used in the first-stage. In other words, using
stronger instruments in the first stage lead to more precise results in the second stage.


3.2    Non-parametric estimation
Another implication of Propositions 1 and 2 is that it is feasible to construct a consistent
semi-parametric estimator of the linear-in-characteristics random-coefficient model. To


                                             20
see this, consider the following quasi-linear indirect utility:

                                                          (2)
                             uijt = xjt  - pjt + jt + xjt i +      ijt                        (17)

where ( i , i )  F ( i , i ), and jt = xjt  - pjt + jt . We treat the distribution of hetero-
geneity as non-parametric, and focus on the semi-parametric estimation the demand
model.
   The inverse demand function of this model can be written as:

                                          -1
                             pjt = xjt  - j  st , x(2) + jt .

This corresponds to a partial linear regression model with an endogenous non-parametric
function. This is one of the two examples studied in Ai and Chen (2003), and the con-
ditional moment restriction can be used to construct a Sieve minimum distance (SMD)
estimate for  and b. This requires approximating the structural (inverse-demand)
and reduced-form equations using two linear Sieves.14 This estimator breaks the curse
of dimensionality in the number of products by using basis functions that satisfy the
exchangeability conditions implied by Proposition 1 and 2.
    Compiani (2019) demonstrates that Bernstein polynomial can be used in this con-
text. In small sample, the inverse demand can also be approximated using the "distance-
metric" approach proposed by Pinkse, Slade, and Brett (2002).


3.3     Testing for instrument relevance
One important challenge when evaluating the strength of the excluded instruments is
that the reduced-form function depends on an unknown parameter vector . To get
around this problem, we propose a more practical measure of relevance, based on the
ability of the instruments to reject the Independence of Irrelevance Alternative (IIA)
hypothesis. This test relies on the assumption that ijt is distributed according to a
T1EV distribution.
    With data on individual choices, Hausman and McFadden (1984) propose the fol-
lowing IIA test: estimate the model by including characteristics of rival products in the
indirect utility of consumers, and test the exclusion restriction implied by the multi-
  14
    When the price enters the inverse-demand non-linearly, the same reduced-form representation can
be used, but it would rely on the heuristic discussed in Section 2.2.



                                                21
nomial logit model. A similar exclusion restriction can be tested using the aggregate
inverse-demand function at  = 0 (Berry 1994):

        -1
        j  s t , pt , x t ;  0 ,  = 0    = ln sjt /s0t
                                                                                 (2)
                                         = xjt  0 + pjt + j (st , pt , xt ;  = 0) + jt

 Where, as in Section 1.2, j (·) measures deviations from IIA in the true model (i.e.
quality-gap). We construct an "IIA-regression" by taking expectation of shares and
prices, conditional on the menu of product characteristics. This leads to a reduced-form
regression relating the log of the odds-ratio to the matrix of product characteristics.

Definition 1 (IIA-test). If Assumption 2 is valid, the IIA hypothesis can be tested by
estimating the following regression:

                                                                             (2)
   E [ln sjt /s0t |xt , wt ] = xjt  + E [pjt |xt , wt ] + E j (st , xt , pt ;  = 0)|xt + 0
                                                        ^jt + A-
                             Aj (xt , wt ) = xjt  0 + p p        w
                                                               j (xt , w t ) 2 ,                     (18)

where A-  w
        j (xt , w t ) is a partition of the instrument vector that excludes product j 's price
IV (wjt ). The null hypothesis of IIA preferences correspond to: H0 :      ^ 2 = 0.15

   Note that the IIA regression corresponds to the reduced-form of the model evalu-
ated at  = 0, and therefore suffers from a curse of dimensionality problem. Using
Proposition 2 we can express this conditional expectation as a symmetric function of
the distribution of characteristic differences. Corollary 2 formalizes this result.

Corollary 2. If the distribution of {1t , . . . , Jt ,t } is exchangeable and the price heuris-
tic defined in equation (11) provides a good approximation to the reduced-form, the
IIA regression can be written as a symmetric function of the matrix of characteristic
differences:

                                                                           (2)
         E [ln sjt /s0t |xt , wt ] = xjt  + p
                                            ^jt + E j (st , pt , xt ;  = 0)|xt , wt
                                                             p
                                                             ^
                                              ^jt + h(dx
                                   xjt  1 + p p                      0
                                                       jt , djt ) + ht                               (19)
   15
      Without controlling for the characteristics of rival products available in market t, the IIA regres-
sion suffers from an omitted variable bias. When the instrument is a rich enough control function,
                                    (2)
in the sense that E j (st , pt , xt ; 0 )|xt , wt  A-      x
                                                         j (xt , w t ) 1 , the omitted variable bias disap-
pears and  ^ 0 is a consistent estimate of the parameters determining the average willingness to pay of
consumers ( 0 ).

                                                    22
where h0
       t is a market-specific intercept.


   The key implication of this corollary is that the IIA hypothesis can be tested by
measuring the strength of the correlation between market shares and measures of prod-
uct differentiation. There exists several ways of testing the exclusion restriction that
product differentiation is independent of demand.
   Perhaps the most intuitive approach is to estimate the multinomial Logit model by
2SLS while controlling for the Differentiation IVs:

                 ln sjt /s0t = xjt ^1 + ^p pjt + A- w
                                                  j (xt , w t ) 2 + error,


where the cost shifters wjt are used as an excluded instrument for price. In this
case, the IIA-test corresponds to the null hypothesis H0 :        ^ 2 = 0. This test can be
implemented without solving for the non-linear demand function using standard Wald
or F tests, and is therefore robust to mis-specification of the demand model. As we
show below, the sign of the coefficient  2 is informative about the nature substitution
patterns under the true underlying model. This regression can therefore be used to
guide the specification of the random-coefficient model (e.g. which characteristic should
be interacted with a random-coefficient).
    An equivalent approach to test the IIA hypothesis is to estimate a mis-specified
model using both wjt and A-    j
                                 w
                                   as instruments. In this case, the IIA-test corresponds
to an over-identification test measuring the validity of the exclusion restrictions formed
by the price instruments and the Differentiation IVs. This can be done using the
Sargan-Hansen J-test. We discuss both approaches in the application below.
    In both cases a rejection of the null hypothesis implies that the excluded instru-
ments detect statistically significant differences between the true and the multinomial
Logit inverse-demand functions. We interpret this as a measure of the relevance of
the instrument function. The predicted value A-       w
                                                     j (xt , w t )^
                                                                  2 quantifies the expected
deviations from IIA under the true model by estimating a (potentially) mis-specified
model. As we discussed in Section 1.2, failure to reject the IIA hypothesis when 0 = 0
is consistent with weak-identification.
    Of course, the instruments can be "strong" and fail to reject the IIA hypothesis. If
that is the case, the researcher should infer that the underlying data-generating process
is well approximated by a model with IIA preferences (0 = 0). Alternatively, if the
the data does not exhibit enough variation in product characteristics, either within or


                                            23
across markets, it might not be feasible to find statistically significant deviations from
IIA. In this case, the previous discussion suggests that the non-linear model will be
weakly identified, and inference methods robust to weak identification should be used.
    The previous discussion suggests a sequential approach to estimation. First, re-
searchers should evaluate the strength of the proposed instrument function by testing
the IIA hypothesis. If the null hypothesis cannot be rejected, the analysis should pro-
ceed with the Logit model. Otherwise, the instrument function can be used to estimate
a richer model, and test the validity of the over-identifying restrictions.


4       Monte-Carlo simulations
In this section, we analyze the finite sample properties of the Differentiation IVs de-
scribed in the previous section. We consider two random-coefficients models with exoge-
nous characteristics: (i) independent random-coefficients: and (ii) correlated random-
coefficients. Appendix B provides more details on the data-generating process and the
numerical algorithm used for estimation. We use an iterative nested-fixed-point Gauss-
Newton Regression (GNR) algorithm, combined with a Newton-Raphson non-linear
equation solver, to solve the non-linear GMM problem. This procedure is very robust
in settings with strong instruments. We perform all numerical integrations by discretiz-
ing the distribution of the random coefficients, and use the same grid and weights in
the monte-carlo and estimation steps; therefore avoiding any mis-specification due to
simulation errors. We provide a pseudo-code description of our approach in Appendix
B.2. We also provide sample Phython and Ox codes on our website.16


4.1       Independent random-coefficients
In this section we illustrate the weak IV problems associated with a commonly used
instrument function, and validate the IIA test as a measure of the relevance of the
instrument function. We then illustrate how the Differentiation IVs can alleviate the
problem.
    Consider the following IID random-coefficient model with exogenous characteris-
 16
      The codes are available here: https://jfhoude.wiscweb.wisc.edu/research-in-progress/




                                                  24
                 Figure 1: IIA test with weak and strong instruments
              (a) Weak IV: Sum                               (b) Strong IV: Euclidian distance




tics:
                                          K2
                                (1)                              (2)
               uijt = 0 +    1 xjt    +         (2,k + k ik ) · xjt,k + jt +    ijt                        (20)
                                          k=1


where sjt is the observed aggregate market share of product j in market t, and ik 
N (0, 1). Using the previous notation,  = {1 , . . . , K2 } denotes the vector of K2
non-linear parameters. We assume that the number of products is fixed (J = 15), and
the number of market is equal to T = 100.
   We compare the performance of three instrument functions:
                                                            
                                                   J        
Sum of characteristics IV:      Aj (xt ) = xjt ,      xj ,t
                                                            
                                                 j =j
                                                                                              
                                                                                              
                                                                2                         2
        Quadratic Diff IV:      Aj (xt ) = xjt ,       d1
                                                        jt,j      ,...,     dK jt,j
                                                                                              
                                                  j                     j
                                                                                                                 
                                                                                                                 
            Local Diff IV:      Aj (xt ) = xjt ,      1 |d1 jt,j | < sd1 , . . . ,            1 |d1
                                                                                                  jt,j | < sdK
                                                                                                                 
                                                         j                            j


 where K is the number of characteristics (excluding the intercept), and sdk is the
standard-deviation of xjt,k .
   Figure 1a illustrates the IIA-test graphically in the single-dimensional model with
weak instruments. Each dot represents a product/market combination, and the line



                                                    25
corresponds to a linear regression of r^jt on the instrument.17 As the figure illustrates,
the sum of rival characteristics is uncorrelated with the inverse demand evaluated at
 = 0, even though the true model exhibits substantial deviations from IIA (0 = 4).
The R2 and the slope of the regression are both indistinguishable from zero. In other
words, the moment conditions are (nearly) satisfied away from the true parameter
value (0 = 4), implying that the model is weakly identified. Importantly, this weak
identification problem is not caused by a small sample problem (N = 1500). Also the
DGP leads to substantial variation in the instrument across markets and products,
since we intentionally used a small number of products in our example, J = 15. See
Armstrong (2016) for discussion of the weak instrument problem for prices when J is
large. In contrast, the performances of the Differentiation IVs is nearly identical when
using a large number of products, since the IVs exhibit substantial variation across
products within the same market even when Jt grows large.
    Figure 1b illustrates the correlation between the residual function at  = 0 (Logit)
and the Euclidian distance of product j (i.e. strong instrument) for same model.18
Unlike the sum of rival characteristics, the Euclidian distance is strongly correlated
with the model residual evaluated at  = 0; the R2 of the regression removing the
effect of xjt is over 0.35 (compared to 0.0006 in Figure 1a). The Euclidian distance
is therefore a good predictor of the inverse-demand function away from the true pa-
rameter. Importantly, the sign of the correlation is an important indicator of the
model specification. A positive coefficient on distance indicates that the availability
of close substitutes reduces the probability of buying j , or equivalently that products
with similar attributes are close substitutes. In contrast, a negative coefficient would
be inconsistent with the random-coefficient model of demand (i.e. presence of similar
rivals increase demand). If that was the cause, it would likely indicate a violation of
the conditional independence assumption.19 Misspecification of this type would lead
to an estimate of the random-coefficient parameter equal to zero (corner), since the
model cannot rationalize this reduced-form relationship (see Houde (2012) for a dis-
cussion of mis-specification in the context of a model of spatial differentiation). It
is therefore important in applied work to measure the strength and the sign of the
  17
    To represent the test graphically we project the instrument onto the product characteristics, and
plot the residual on the x-axis.
                                                                                           2
                                                                   15      (2)       (2)
  18
       The Euclidian distance instrument is defined as: IVdist
                                                          jt =     j =j   xj ,t   - xjt        .
  19
    For instance, this correlation can be explained by an (unobserved) increase in the willingness-to-
pay for a certain attribute that cause entry of products with the same attributes.


                                                  26
reduced-form correlation between differentiation and demand prior to estimating the
structural model.
    This positive relationship between differentiation (or distance) and the inverse de-
mand at  = 0 is captured by the differentiation instrument used in Figure 1b. In
other words, products located in denser areas of the product space have relatively
small market shares. The inverse demand evaluated at  = 0 rationalizes this feature
by assigning high quality to products that are relatively isolated, and low quality to
products with many substitutes. A clear violation of the moment conditions.
    The results of 1, 000 Monte-Carlo replications with weak instruments are summa-
rized in Table 1a. We estimate the log of k in equation (20), instead of k directly,
to account for the strictly positive support of the parameter space. The table reports
the mean bias and RMSE for the transformed parameters, averaged across parameters
(0 k = 4 for all k ). Table 2 summarizes the small-sample performance for the two IVs
across all specifications, and calculates the average asymptotic standard-errors. Tables
3a and 3b summarize the full set of simulation results, including the weak identification
and IIA tests, and the local minimum statistics.
    To demonstrate the ability of the IIA-regression to detect the presence of weak
instruments, we compare the distribution of the IIA-test with a formal local identi-
fication test evaluating the rank of matrix E j st , xt ;  0 /  T · z jt . We use the
rank-test proposed by Cragg and Donald (1993) to test the null hypothesis of under-
identification under homoskedastic errors. The bottom panel of Table 1a reports the
results of the two tests.
    We test the null-hypothesis of IIA preferences by testing the joint null hypothesis
that  ^ 1 = 0. As the figures suggest, we cannot reject the hypothesis of IIA preferences
across all four specifications. We reach the same conclusions using the rank-test results.
The null hypothesis of under-identification (i.e. rank less than m), cannot be rejected
with probabilities ranging between 60% and 92% on average across the specifications.20
    Next, we look at the finite-sample performance of the GMM estimator under weak
identification. Note that in 8.4% of the samples, of    ^ 1 are estimated to be less than
0.001, which can be interpreted as a corner solution to the GMM optimization prob-
lem. This is a robust feature of weak instruments that has been documented by other
researchers analyzing the BLP model (e.g. Reynaert and Verboven (2013)). Weak
  20
     We use a 10% confidence level calculated using Stock-Yogo critical values to calculate the rejection
probabilities (Stock and Yogo (2005)).



                                                   27
Table 1: Monte-Carlo simulation results for exogenous characteristics model with weak
and strong instruments
                                          (a) Weak instruments
                                    K2 = 1            K2 = 2             K2 = 3          K2 = 4
                                  bias  rmse        bias rmse          bias rmse       bias  rmse

       k                          0.136     2.643   0.06      2.46     0.09    2.25    0.12      2.301

       1(Local-min)               0.189             0.514             0.594            0.661
       Range(J-stat p-value)      0.167             0.189             0.212            0.210
       Rank-test                  1.265             0.464             0.259            0.178
          p-value                 0.615             0.813             0.886            0.919
       IIA-test                   1.327             1.296             1.486            1.944
          p-value                 0.426             0.422             0.356            0.237

                                          (b) Strong instruments
                         bias    rmse           bias    rmse          bias   rmse        bias   rmse
                           K2 = 1                  K2 = 2               K2 = 3             K2 = 4

   k                     0.002      0.122      -0.003      0.1275    0.0015    0.129    -0.003      0.142

   1(Local)              0.000                 0.000                  0.000              0.000
   Rank-test ­ F (1)   1202.104               564.033                330.399            206.417
      p-value            0.000                 0.000                  0.000              0.000
   IIA-test ­ F (K )    359.409               363.224                321.730            276.135
      p-value            0.000                 0.000                  0.000              0.000


    Data generating process: J = 15 and T = 100, xk
                                                  jt  N (0, 1) for k = 1, . . . , K and jt  N (0, 1).
The parameter values are given by: 0 = -3, 1 = 1, 2 = 1, k = 4 for all k . Number of simulations:
1,000. The bias and RMSE are averaged across parameters: k = {1 , . . . , K }.


instruments imply that the normal distribution is a poor approximation of the finite-
sample distribution of the parameter estimates, and causes the presence of frequent
outliers (leading to corner solutions).
     Another consequence of weak instruments is the lack of precisions in the estimates.
The RMSEs range from 2.2 to 2.6 across specifications; or more than 50% of the true
parameter value (i.e. k = 4 for all k 's). The precision of the estimates is poor across
all four specifications, and remains constant as we increase the complexity of the model.
     A third consequence of weak instruments is the presence of numerical optimization
problems. To illustrate this point, for each simulated sample, we launched the opti-
mization routine at 10 random starting values (centered around the truth), and use a
Nelder-Mead (or Simplex) algorithm to find the local minimum. The indicator variable

                                                    28
Table 2: Simulation results for the exogenous characteristic model with Differentiation
IVs

                            Diff   IV: Quadratic             Diff IV: Local
                          bias      rmse asym-se         bias    rmse asym-se
              K2   =1    0.000      0.030   0.031       -0.000 0.032     0.032
              K2   =2    -0.001     0.032   0.031       -0.001 0.033     0.032
              K2   =3    -0.000     0.032   0.033       -0.000 0.033     0.034
              K2   =4    -0.001     0.035   0.035       -0.002 0.037     0.036
              K2   =5    0.000      0.039   0.039       -0.000 0.040     0.040
              K2   =6    -0.001     0.045   0.044       -0.001 0.046     0.045
              K2   =7    0.002      0.048   0.050       -0.003 0.051     0.052

    Data generating process: J = 15 and T = 100, xk
                                                  jt  N (0, 1) for k = 1, . . . , K and jt  N (0, 1).
The parameter values are given by: 0 = -3, 1 = 1, 2 = 1, k = 4 for all k . Number of simulations:
1,000.


1(Local-min) is equal to one if the algorithm converged to more than one solution.
    Using this procedure, we find large number of "local minima". The frequency of this
problem is increasing with the dimensionality of the parameter space. When K2 = 4,
66% of the samples exhibit multiple minima out of 10 starting values, compared to
19% when K2 = 2. The link between weak instruments and numerical problems is
easy to understand. Weak identification implies that the moment conditions are almost
satisfied away from the true parameter, which leads to non-convexities and flat GMM
objective function. This makes it difficult for Newton and quasi-Newton algorithms to
find the global minimum when instruments are weak.
    The next row of Table 1a illustrates the magnitude of the differences between these
different local solutions. The average differences in the J-statistic p-values imply that
the over-identifying restrictions are rejected with a p-value of roughly 20% on average
using the largest local minimum, compared to 40% with the global minimum solu-
tion. These differences are consistent with the numerical problems documented by
Metaxoglou and Knittel (2014).
    We now turn to the simulation results obtained with the quadratic Differentiation
IVs. We obtain similar results with the Local Differentiation IVs. Table 1b presents the
average bias and RMSE across parameter (k ). Both specifications allow us to reject
the null hypothesis of under-identification (rank-test), as well as the IIA hypothesis.
In addition, the frequency of local optima is equal to zero across all specifications;
meaning that the Newton optimization algorithm always converges to the same solution

                                                 29
Table 3: Monte-Carlo simulation results for exogenous characteristics model with
strong instruments
                                (a) Differentiation IV: Quadratic
                       bias    rmse       bias    rmse            bias   rmse         bias   rmse
                         K2 = 1              K2 = 2                 K2 = 3              K2 = 4

 k                    0.002     0.122    -0.003    0.1275        0.0015    0.129     -0.003    0.142

 1(Local)              0.000             0.000                0.000                  0.000
 Rank-test ­ F (1)   1202.104           564.033              330.399                206.417
    p-value            0.000             0.000                0.000                  0.000
 IIA-test ­ F (K )    359.409           363.224              321.730                276.135
    p-value            0.000             0.000                0.000                  0.000

                                 (b) Differentiation IV: Local
                       bias     rmse      bias     rmse      bias         rmse      bias      rmse

 k                    0.002     0.126    -0.0003    0.13     0.002        0.133    -0.003     0.148

 1(Local-min)          0.000             0.000               0.000                  0.000
 Rank-test ­ F (1)   1050.015           523.760             322.288                204.402
    p-value           0.000              0.000               0.000                  0.000
 IIA-test ­ F (K )   297.544            298.073             262.636                222.932
    p-value           0.000              0.000               0.000                  0.000



irrespectively of the starting values. The precision and bias of the parameter estimates
are also small across all specifications. The average RMSEs of        ^ k are roughly 17
times smaller with the two instruments defined above, compared with the sum of rival
characteristics used in Table 1a.
    We also find that minimal loss in precision from adding random-coefficients. The
average RMSEs increase from 0.03 to 0.05 when we vary the number of random-
coefficients from one to seven. This is encouraging since the sample size is fairly small:
15 products × 100 markets.
    Finally, Table 4 compares the bias and precision of the estimates between non-linear
least-square and GMM. The first two specifications reproduces the bias and RMSE
results from the specification with four random-coefficients. The non-linear least-square
(NLS) estimates correspond to a specification where the parameters are obtained by
minimizing the sum of square residuals. This specification leads to biased estimates

                                              30
            Table 4: Monte-Carlo simulation results with NLS and GMM
                              Diff. IV   (quad.)   Sum Characteristics          NLS
              Parameter        Bias        SE       Bias      SE             Bias   SE
              1               -0.003      0.142     0.218   2.348            .227 .0238
              2               -0.004      0.141     0.099   2.297            .225 .0239
              3               -0.001      0.137     0.113   2.378            .226 .0238
              4               -0.005      0.146    -0.075   2.207            .225 .0239


arising because of the simultaneity of market shares. Column (3) shows that this leads
to an average downward bias of roughly 10% (i.e. 0     k = 2). The main advantage
of least-square is the precision of the estimates. The asymptotic standard errors are
equal to 0.023; significantly smaller than the RMSE with GMM. This highlights the
tradeoff between bias and precision induced by the choice of instruments. With weak
instruments researchers should put a lot more importance of least-square results, given
the large mean-square error associated with GMM.


4.2    Correlated random-coefficients
Next, we consider a model with correlated random-coefficients:
                     K2
              (1)                           (2)
uijt = 0 + 1 xjt +         (2,k + ik ) · xjt,k + jt +    ijt ,   j = 1, . . . , 50 and t = 1, . . . , 100,
                     k=1


 where  i  N (0, ), and K2 = 4. We use a larger sample for this example: Jt = 50
instead Jt = 15. This reflects the fact that the number of non-linear parameters is
substantially larger with correlated random-coefficients: from 4 to 10.
    To generate the data, we set the diagonal element of  equal to 4; the same value
used in the previous simulations. The covariance terms are chosen such that there is
an equal number of positive and negative parameters, equal to either -0.5 or 0.5. See
Table 13 in the Appendix.
    Note that we estimate Choleski decomposition of  = C C , rather than  directly.
This allows us to write indirect utility of consumers as a linear function of parameters
and K2 standard-normal random-variables:  i = C  i where  i  N (0, I ). To ensure
that  is positive semidefinite, we constraint the diagonal elements of C to be posi-
tive by estimating the log of Ck,k . Let  denotes the lower-diagonal elements of this
transformed matrix.
    To construct our instrument function, we use the second-order polynomial form of


                                                   31
           Table 5: Simulation results for the correlated random-coefficient model

                                                                          ·,1             ·,2         ·,3          ·,4


                   Estimates
                       1,·                                               4.003
                       2,·                                              -1.997           4.000
                       3,·                                               1.997           -1.996      3.991
                       4,·                                               2.010           -2.000      2.006         4.010
                       1,·                                               0.228
                   RMSE


                       2,·                                               0.132           0.232
                       3,·                                               0.156           0.145       0.217
                       4,·                                               0.156           0.143       0.154         0.217
                   IIA test (F)                                        157.637
                   Cragg-Donald statistic (F)                          474.053
                   Nb endogenous variables                                 10
                   Nb IVs                                                  15

    Data generating process: J = 50 and T = 100, xk jt  N (0, 1) for k = 1, . . . , K and jt  N (0, 1).
The parameter values are given by: 0 = -3, 1 = 1, k = 1 for all k . Table 13 in the Appendix
presents the variance-covariance matrix of ik . Number of simulations: 1,000.


the Differentiation IVs with additional interaction terms between each characteristics
pairs:21
                                                                                                                                          
                                                                                                                                          
                                                                                                  l+1
Aj (xt ) = xjt ,               d1       1
                                jt,j × djt,j , . . . ,          dl       l
                                                                 jt,j × djt,j ,          d1
                                                                                          jt,j × djt,j , . . . ,          dK       K
                                                                                                                           jt,j × djt,j      .
                                                                                                                                          
                   j =j                                  j =j                     j =j                             j =j


 This results in 15 excluded restrictions: (i) five quadratic differentiation measures
along each dimension (one special regressors and four non-linear characteristics), and
(ii) ten unique interaction pairs.
     The simulation results are summarized in Table 5. The top panel reports the
average estimated parameters (transformed) of the variance-covariance matrix, the
middle panel reports the RMSE associated with each parameter, and the bottom panel
reports the averages of the IIA-test and the Cragg-Donald rank test statistics. Both
tests confirm that the instruments are strong, and that the IIA hypothesis is easily
rejected. The average bias and RMSE are also small, despite the richness of the
model. The differentiation IVs are able to accurately identify both the magnitude
and correlation in taste heterogeneity across consumers.
  21
   Similar interactions can be constructed with the local differentiation instruments: j 1(|dl
                                                                                             jt,j | <
l )dk  . The results are similar using this specification of the instruments, but we find that the
    jt,j
quadratic form tends to be more stronger.



                                                                        32
        Figure 2: Distribution of estimated price random-coefficient parameter




                         .15




                                                                                                                  1.5
                         .1




                                                                                                                                1
                                                                                                                   Kernel density
              Fraction
                         .05




                                                                                                                  .5
                         0




                                                                                                                  0
                                -15                    -10                  -5                              0
                                                    Random coefficient parameter (Price)

                                              IV: Sum                       IV: Local             IV: Quadratic
                                Dash vertical line = True parameter value




   It is worth noting that this specification is substantially richer than any random-
coefficient model that has previously been studied with aggregate data by researchers,
both in empirical applications and Monte-Carlo simulations. Although we obtain these
results in a "controlled" environment, this result confirms the ideas in Berry et al. 1995
and Berry and Haile (2014) that it is feasible to estimate very flexible substitution
patterns using aggregate data on market shares and product characteristics.


4.3     Endogenous prices
To analyze the performance of the Differentiation IVs when prices are endogenous we
consider a model with a single random-coefficient on price:

                               (1)
 uijt = 0 + 1 xjt + (p + p i ) · pjt + jt +                                    jt ,     j, = 1, . . . , 15 and t = 1, . . . , 100. (21)

where ln i  N (0, 1).22
   To generate a second simultaneity problem, we generate prices using a Bertrand-
Nash pricing game with single-product competitors. Prices are determined by the
  22
    Unlike the previous examples, we approximate the distribution of i using a fixed sample of 100
pseudo random-numbers.



                                                                             33
         Table 6: Monte-Carlo simulation results for endogenous price specification
                                 (a) Distribution of parameter estimates
                  (1)            (2)                       (3)                         (4)
                 True     Diff. IV = Local       Diff. IV = Quadratic           Diff. IV = Sum
                         bias     se  rmse       bias     se   rmse          bias      se    rmse

            p    -4.00   0.02    0.27     0.28   0.02      0.53      0.55     1.03   158.25    2.10
            p    -0.20   0.01    0.37     0.37   0.01      0.31      0.32    -0.67   201.29     1.38
            0    50.00   -0.26   3.92     3.92   -0.28     7.36      7.45    -9.82    26.41    20.65
            x     2.00   -0.02   0.46     0.45   -0.02     0.47      0.47     0.34    1.11     0.83

                                         (b) Weak identification tests
                                                        (1)               (2)                 (3)
                                                    IV = Local       IV=Quadratic         IV = Sum
              Frequency conv.                            1                 1                 0.94
              IIA-test                                109.48             53.90               1.88
                 p-value                                 0                 0                 0.34
              1st-stage F-test: Price                 191.80            442.10              138.94
              1st-stage F-test: Jacobian              214.60            58.40               27.85
              Cond. 1st-stage F-test: Price           252.23            479.96               7.92
              Cond. 1st-stage F-test: Jacobian        280.31             82.44               6.19
              Cragg-Donald statistics                 170.19             54.45               4.09
                 Stock-Yogo size CV (10%)              16.87             13.43               13.43
              Nb. endogenous variables                   2                 2                   2
              Nb. IVs                                    4                 3                   3


     Data generating process: J = 15 and T = 100, 0 = 50, x = 2, p = -0.2 and p = -4. Number
of simulations: 1,000.


following vector of first-order conditions:
                                                                                     -1
                                                                  j ( t , pt ; p )
                              p                    
                               jt = cjt - j ( t , pt ; p )                
                                                                     pjt

                                        (1)
The marginal cost, cjt = 0 + xjt x + wjt , is constant, and the cost-shock wjt is observed
by the econometrician. We use this variable below to construct a price instrument. The
data is generated by finding a solution to equation (22) for 1000 × 100 independent
markets.23 This leads to 1,000 simulated panels of market shares and characteristics.
    We follow the steps described above to construct the instrument function. We
first construct an exogenous price index, p ^jt , using the predicted values from a linear
  23
       The data-generating process for the marginal cost and characteristics is given by: jt  N (0, 1),
 (1)
xjt     N (0, 1), wjt  N (0, 0.1).


                                                      34
regression of pjt on the exogenous characteristic and the cost shifter wjt :

                                                          (1)
                                      p
                                      ^jt = ^0 + ^1 xjt + ^2 wjt .                                                         (22)

We use a linear functional form for expositional purposes. In applications, richer
functional forms might lead to further efficiency gains by improving the fit of the
reduced-form regression (see Reynaert and Verboven (2013) for a discussion).
    We then construct the Differentiation IVs using the empirical distribution of differ-
                   (1)
ences in p^jt and xjt . In particular, as before, we consider two alternative measures of
differentiations:

                                                                            2                       2
                                                                (1)
  Quadratic Diff IV:         z jt =     xjt , jt ,         djt,j                ,       dp
                                                                                         ^
                                                                                         jt,j
                                                     j                              j

                                                                      (1)
      Local Diff IV:         z jt =     xjt , jt ,        1 |djt,j | < sd1 ,                            1 |dp
                                                                                                            ^
                                                                                                            jt,j | < sdp
                                                                                                                       ^
                                                     j                                          j


        (1)     (1)    (1)
where djt,j = xj t - xjt and dp   ^
                                  jt,j = p^j t - p
                                                 ^jt . Note that jt is added to the list of
instruments since we need two independent sources of variation to identify p and p
(i.e. own cost shifters, and cost and characteristics of rival products).
    The simulation results are reproduced in Figure 2 and Table 6. In addition to the
two sets of instruments defined above, we also report the results using the "sum of
rival characteristics" in order to illustrate effect weak instruments. The bottom panel
reports the results of the weak identification and IIA tests.
    Table 6b confirms the weak identification results obtained in the models with exoge-
nous characteristics. In this example, the "Local Differentiation IV" tends to perform
better than the "Quadratic Differentiation IV". The two measures of weakness, the
IIA-test and the Cragg-Donald statistic, are on average roughly 2.5 times larger in
column (1) than in column (2).
    To illustrate the dual role of the instruments in this context, Table 6b also report
the results of two first-stage F tests: (i) one that simply regresses price and the Jaco-
bian on the exogenous variables, and (ii) one that first "projects-out" the exogenous
variation induced by the other endogenous variable before computing the first-stage
F test. The second test was proposed by Angrist and Pischke (2009) and Sanderson
and Windmeijer (2016) to adjust the standard first-stage tests for cases with multiple



                                                     35
endogenous variables.24
    In our example, the standard F-tests conducted using the sum of rival characteristics
incorrectly suggest that weak instruments is not a concern (i.e. 138.94 and 27.85). This
is because one of the instrument is very strong (i.e. cost shifter jt ). However, once we
account for the fact that we have more than one parameters to identify with a single
strong instrument, the conditional first stage F-tests are in line with the results of the
Cragg-Donald and the IIA tests; both F-tests are significantly below the Stock-Yogo
critical values on average.
    Table 6a summarizes the distribution of the estimated parameters across the three
IV specifications. Looking first at specification (3), we see again that using weak
instruments lead to substantial loss in precision and large biases. The RMSE for p is
equal 2.10, and the average bias is significantly above zero (1.03). This upward bias is
partially offset by a "downward" bias in p (i.e. -0.67), but the net effect is positive:
weak instruments in this example biases the slope of the demand towards zero.
    This bias is eliminated in panel (2) and (3) when we use the stronger differentiation
IVs. The RMSEs are also substantially reduced. Relative to the sum of rival charac-
teristics specification, we obtain a 7.5 times improvement in precision for   ^p with the
local differentiation IV, and a 4 times improvement with the quadratic differentiation
IV. Figure 2 illustrates this point graphically by plotting the distribution of ^p for the
three specifications. As with the exogenous characteristics, weak instruments lead to
a non-Gaussian distribution of the parameters, characterized by large outliers and a
mass around zero. The two other distributions are symmetric and bell-shape, centered
around the true parameter, and do not exhibit outliers.


4.4     Natural Experiments
An often expressed criticism of the main identifying assumption in Berry et al. 1995,
is that firms endogenously choose product characteristics (observed and unobserved).
This violates Assumption 2 either because of the endogenous selection of products,
and/or because of a contemporaneous correlation between jt and the attributes of own
  24
    We use weak-identification tests designed to test the relevance in linear IV models, by evaluating
the Jacobian of the residual function at the true value of the parameters. In practice we obtain similar
results when constructing the tests at the GMM estimates instead, but there are no critical values
available in the literature for this test. Deriving the limiting distribution of these statistics under
weak-identification is beyond the scope of this paper.



                                                  36
and rival products.25 This invalidates the use of the entire distribution of characteristic
differences to identify substitution patterns.
    An alternative approach is to look for natural experiments that exogenously change
the menu of product characteristics available to consumers. Such experiments can
be induced directly by researchers (e.g. Conlon and Mortimer (2015)), caused by
technology changes that induce market-structure changes (e.g. Houde (2012)), or by
government regulations that generate suboptimal product offering (e.g. zoning). To
illustrate this, consider the following mixed-logit Hotelling demand model:
                                  
                                  
                                      jmt   - (i - xjmt )2 +   ijmt   If j > 0,
                      uijmt =
                                  
                                     ijmt                             If j = 0.

where j = 1, . . . , 15 indexes products, m = 1, . . . , 100 indexes markets, and t = 0 or 1
indexes the pre/post natural experiment periods. In this example, the non-linear char-
acteristic of products, xjmt , measures their location in the product space, and the
random-coefficient, i , measures the "ideal" address of consumers. We assume that
both variables are uniformly distributed between 0 and 10. The goal is to estimate the
travel cost of consumers: .
   We consider a natural experiment associated with the entry of a new product in each
market at location x = 5 in the post-period (i.e. t = 1). Within each market, distance
to x measures the strength of the "treatment". The characteristics of incumbent
products are constant across periods (i.e. xjmt = xjm ).
   We introduce a correlation between jmt and xm as follows:

                           E (jmt ) = 0 and corr(jmt , EDjm ) = a < 0

                                     2
where EDjm =          j (xjm - xj m ) is the Euclidian distance of incumbent product
j . The parameter a creates a standard simultaneity problem: products facing close
substitutes have higher unobserved quality. Since characteristics are constant across
the two periods, this correlation can be absorbed by conditioning on product/market
fixed-effects. Assumption 4 formalizes this quasi-experimental design assumption.

Assumption 4. The change in the unobserved quality of products is mean zero con-
 25
      See Ciliberto, Murry, and Tamer (2016) for a recent examination of this problem.




                                                  37
ditional on the observed menu of characteristics and product/market fixed-effects µmt :

                                     E [jm |µjm , xmt ] = 0,

where jm = jm1 - jm0 and jm1 = µjm + jm

    To construct the instruments, we consider two distance measures similar to the
Differentiation IVs discussed above:

                                    1
                                   wjm = 1(|xjm - x | < )
                                    2
                                   wjm = (xjm - x )2

where the threshold  is defined as the standard deviation of xjm across all prod-
                              1     2
ucts/markets. Let z jm = {1, wjm , wjm } denotes the instrument vector. This leads to
the following moment condition:

                   1
       mn () =                 [j (sm1 , xm1 ; ) - j (sm0 , xm0 ; )] · z jm = ()T z /n
                   n   m   j


where n is the number of unique market/product observations. Using this specification,
the structural parameters of the model are identified solely from the quasi-experimental
variation. In particular, the reduced-form is approximated by a difference-in-difference
regression, in which the "control" group is defined as the set of products located rela-
tively far from the exogenous new entrant.
    Figure 3 illustrates the ability of this identification strategy to eliminate the simul-
taneity bias associated with the endogenous location of products. The dash curves
correspond to the Kernel density of the parameters estimated using the "difference-in-
difference" moment conditions (3a), or the full "Differentiation IVs" moments (3b).26
    The data generating process is designed so that the correlation between jmt and
the Euclidian distance between rival products is a = -0.25. As Figure 3b illustrates,
this leads to an attenuation bias in the estimate of the travel cost parameter obtained
using standard instruments (   ^  1.89, compared to 0 = 4). Since products located in
"denser" regions of the product space have higher quality, the GMM specification that
exploits variation in the distance to all products wrongly infer that consumers have
  26
   The Differentiation IVs specification combines the sum of square of characteristic differences (i.e.
quadratic IV), and the number of competing products within one standard-deviation (i.e. local IV).


                                                  38
Figure 3: Monte-Carlo simulated distribution of the travel cost parameter estimates
with endogenous product locations
                  (a) Difference-in-Difference Moments                                                              (b) Full Differentiation Moments




                                                                                                      2
      1
      .8




                                                                                                      1.5
         .6
  Density




                                                                                                   Density
                                                                                                     1
      .4




                                                                                                      .5
      .2
      0




                                                                                                      0
              1                    2                   3               4             5                       1                        2                     3                     4             5
                                                     Parameter estimates                                                                            Parameter estimates

                                       Kernel density estimate               Normal density                                          Kernel density estimate                   Normal density
              Average bias = .027. RMSE = .406. Standard-deviation = .405.                                   Average bias = -2.113. RMSE = 2.123. Standard-deviation = .206.




    Data generating process: xjm  U [0, 2], jmt = ¯jm +jmt , where  ¯jm = -0.25 EDjm - EDm +
jm , jm  N (0, 0.5) and jmt  N (0, 0.25). Consumer addresses: i  U [0, 2] approximated using
100 equally spaced grid points. Number of Monte-Carlo replications: 1,000. Sample size: M = 100,
Jm0 = 15 for all m, Jm1 = 16 for all m, T = 2.


a small disutility from distance. Figure 3b illustrates that the difference-in-difference
moment conditions eliminate this bias. The distribution is centered around 0 = 4,
and the average bias is less than 1% of the parameter value.
    Comparing the two distributions, it is important to note that by exploiting solely
the variation created by the entry of a new product, the difference-in-difference GMM
estimator is less precise, and the distribution of  ^ is less well approximated by the
normal density than the specification that uses the larger set of instruments. In Figure
3b the p-value associated with Shapiro-Wilk normal test is 11%, compared to less than
1% in Figure 3a. This suggests that the asymptotic approximation used to conduct
inference on  is less likely to be valid when the model is estimated solely using quasi-
experimental variation; therefore requiring larger sample sizes or inference methods
that are robust to weak identifications. Alternatively, additional equilibrium restric-
tions can be used to solve the simultaneity problem (as in Ciliberto, Murry, and Tamer
(2016)).




                                                                                              39
4.5       Comparison with other approaches
Finally, we conclude this section by comparing the performance of the Differentiation
IVs, with the approximation to the optimal IV proposed by Berry, Levinsohn, and
Pakes (1999) and Reynaert and Verboven (2013).
    Recall that, abstracting away from concerns related to heteroskedasticity, the in-
strument vector that minimizes the asymptotic variance of the parameter estimates is
given by the conditional expectation of the Jacobian of the residual function (Amemiya
(1977), Chamberlain (1987)):

                                                                  -1                 (2)
                         j (st , xt ;  )                          j  (st , xt ; )
          Aj (xt )   = E                 xt =            -xjt , E                 xt
                                                                       

This is very intuitive: Because the asymptotic distribution of (,  ) is derived from
a first-order approximation of the residual function, the most efficient instruments
correspond to the best-predictor of the slopes of that function with respect to each of
the parameters.27
    This efficiency bound cannot be achieved in practice since the model is semi-
parametric in jt . Rather than using non-parametric regression techniques to esti-
mate A  j (xt ) (as in Newey (1990)), Berry, Levinsohn, and Pakes (1999) proposed the
following heuristic approximation to the optimal IV:

                              (2)                        (2)
                     j (st , xt ;  )     j (st , xt ;  )                          ~j (xjt | ).
               E                     xt                                          =A                       (23)
                                                                     jt =0,j,t


Since the instrument vector depends on  , users must first obtain an estimate of the
parameters, denoted by  1 . This leads to a two-step estimator: (i) estimate  1 by
GMM using instrument vector z jt , and (ii) construct A ~j (xjt | 1 ) and estimate ^ by
GMM. The second step corresponds to a just-identified system of moment conditions.
   When prices enter non-linearly in the model, a similar heuristic can be used to
avoid taking an expectation over the second set of endogenous variables:

         -1             (2)              -1                    (2)
         j  (st , pt , xt ;  )           j  (st , pt , xt ;  )
  E                            xt , w t                                                         ~j (xjt | ),
                                                                                               =A
                                                                              pjt ,jt =0,j,t
                                                                         pjt =^
                                                                                                          (24)
 27
      See Newey (1993) for an illuminating discussion.


                                                  40
     Table 7: Optimal IV approximation with alternative initial parameter values

                                              Normal RC                        Hotelling
                                         1                           1
                                               bias   rmse                     bias      rmse
           Optimal IV approx.:
               (1)                   0.5       0.001   0.027 4                  -0.003         0.140
               (2)                   1.5       0.001   0.026 2                 -0.004          0.126
               (3)                    2       0.001    0.026 0                  -0.079         0.509
               (3)                   2.5       0.001   0.026 -1                 -0.344         1.687
               (4)                    3        0.002   0.028 -2                 -0.282         1.254
           Differentiation IV        --        0.001   0.031 --                  0.017         0.310

    Data generating process: J = 15 and T = 100, xk
                                                  jt  N (0, 1) for k = 1, . . . , K and jt  N (0, 1).
The parameter values are given by: 0 = -3, 1 = 1, k = 1,  = 2 for all k . Number of simulations:
1,000.


where p ^jt  E (pjt |xt , wt ) is a "reduced-form" model for prices independent of jt .
    Reynaert and Verboven (2013) conducted a series of Monte-Carlo simulations to
illustrate that this heuristic leads to substantial efficiency gains over the standard
instruments proposed in Berry et al. 1995 (i.e. sum of rival characteristics). One
remaining question however is to what extent the approximation remains valid when
the first-stage estimates are not consistent, which is the case for instance with weak
instruments. To illustrate when consistency is likely to matter, we first study two
simple mixed-logit models: (i) normal random-coefficient, and (ii) Hotelling. These
two models satisfy our "linear-in-characteristic" random-coefficient assumption and
have the following indirect-utility function:

                                                            (2)
                     Normal RC:              uijt = jt + i xjt +         ijt
                                                                               2
                                                                   (2)
                        Hotelling:           uijt = jt -  i - xjt                  +   ijt .


                              (2)
where i  N (0, 1) and xjt  N (0, 1). For our purpose, the key distinction between
these two models is that the value of  in the "Normal RC" model only affects the
magnitude of the elasticity of substitution, and not the relative ranking of each prod-
ucts' cross-elasticty (which is function only of x's). In contrast, in the Hotelling model,
when  goes from positive to negative, the identity of the "closest" competitor changes
from the "closest" x to the "furthest" x. It is easy to see that this Hotelling model is
a special case of the linear-in-characteristics random-coefficient model.


                                                  41
    Table 7 summarizes the results of 1,000 Monte-Carlo replication simulations. The
first five rows correspond to different values of the initial parameter used to evaluate the
Jacobian. In both specifications, the true value of parameter is 0 = 2. The numbers
in bold correspond to GMM results obtained by setting the first-stage parameter equal
to the true parameter value . The rest of the rows correspond to different levels of
inconsistencies. For the "Normal RC" mode, we consider a grid between 0.5 and 3.
For the Hotelling model, we consider grid between -2 (wrong sign) and 4.
    Looking first at the "Normal RC" model, the performance of the optimal IV approx-
imation estimator is remarkably robust to inconsistencies in the first-stage parameter
values. The efficiency gains from using the "true" parameter value are fairly small (i.e.
0.026 vs 0.028). This is consistent with the results presented in Reynaert and Verboven
(2013).
    The results from the "Hotelling" specification are quite different. The first two rows
show that using using an inconsistent first-stage parameter with the correct sign does
not reduce dramatically the precision of the estimates (i.e. 0.14 vs 0.126). However,
using first-stage values that are inconsistent and have the wrong sign leads to large
attenuation biases and very imprecise estimates. The RMSE in the last two rows are
more than 10 times larger than in specification (2) (i.e. true ). This suggests that
the consistency of the first-stage estimate is important for the validity of the heuristic
approximation approach, especially when the substitution patterns depend on the sign
of the parameter values.
    The last row of Table 7 reports the results obtained with the Differentiation IVs.
To obtain these results we combine the sum of square of characteristic difference,
and the number of local competitors. When using an unbiased first-stage parameter,
the optimal IV approximation improves the precision of the estimates by 60% in the
Hotelling model, and by 17% in the Normal RC model. However, these efficiency gains
are quickly eliminated when the first-stage parameter is set far from  0 . This is an
important advantage of the Differentiation IVs, since their exact structure does not
depend on the availability of consistent estimates, or on prior the knowledge of the
model of differentiation (e.g. Hotelling versus normal).
    The previous examples are very stylized. Another setting in which the sign and
magnitude of  determines substitution patterns is the correlated random-coefficient
model studied in Section 4.2. To illustrate the importance of using consistent estimates
in the first-stage, we implement the optimal IV approximation using pseudo-random


                                            42
Table 8: Monte-Carlo simulation results for correlated random-coefficient specification
with optimal IV approximation and inconsistent initial parameter values

 Choleski         Opt. IV:  1  N (0, 1) Opt. IV:  1  N (0, 4)    Diff.      IV: Quad.
 matrix     True bias rmse        se     bias rmse     se      bias         rmse se
             (1)   (2)   (3)     (4)     (4)   (5)    (6)       (7)           (8)  (9)
 log c11    0.69 0.00 0.22      5.42     0.01 1.22   11.92    -0.00          0.03 0.03
 log c22    0.55 -0.01 0.19     2.50    -0.16 2.36 192.70 -0.00              0.04 0.04
 log c33    0.49 -0.02 0.15     0.46    -0.44 2.69    ++      -0.00          0.04 0.04
 log c44    0.46 -0.22 1.83     ++      -1.78 5.57    ++      -0.00          0.04 0.04
 c21        -1.00 0.01 0.47     4.51     0.03 0.77 781.85 0.00               0.06 0.06
 c31        1.00 0.00 0.33      0.86    -0.02 0.63   23.48    -0.00          0.07 0.07
 c32        -0.58 0.02 0.27     2.69     0.03 0.56 285.80 0.00               0.07 0.08
 c41        1.00 0.00 0.23      1.37     0.00 0.58 333.93 0.00               0.07 0.07
 c42        -0.58 0.01 0.23     2.69     0.04 0.50 484.88 0.00               0.08 0.08
 c43        0.41 0.00 0.23      1.59     0.03 0.52    ++       0.00          0.08 0.08


values that are not centered around the truth. The point here is not to replicate the
results from Reynaert and Verboven (2013), but rather to highlight the importance of
using consistent estimates in the first stage.
    The results are summarized in Table 8. In columns (2)-(4), each element of  1 is
drawn from a standard-normal distribution, while in columns (4)-(6) they are drawn
from a normal distribution with a standard-deviation of 2. The results are in line
with the single-address Hotelling example. Using inconsistent parameter estimates to
approximate the optimal instruments leads to a weak identification problem, associated
with very noisy and often biased parameter estimates. In addition, as we increase the
variance of  1 , the precision and bias of  ^ both increase substantially. The contrast
with the Differentiation IVs is quite striking: the average RMSEs are roughly 5 times
smaller with the Differentiation IVs than with the less noisy optimal IV approximation.
    A valid strategy to improve the efficiency of the estimates is to obtain first-stage
estimates using the instruments proposed in this paper, and then construct an ap-
proximation to the optimal IV. The second-stage can be conducted using the heuristic
approximation discussed in Berry, Levinsohn, and Pakes (1999) and Reynaert and
Verboven (2013), or using non-parametric regressions as discussed in Newey (1993) for
instance.
    We illustrate the performance of the former approach using the model with en-
dogenous prices studied in Section 4.3. Table 9 summarizes the results. The top-panel


                                          43
Table 9: Monte-Carlo simulation results for endogenous price specification and optimal
IV approximation

                         Diff. IV = Local Diff. IV = Quadratic      Diff. IV = Sum
                  True   bias    se rmse bias     se    rmse      bias     se   rmse

              p    -4     0.02 0.27   0.28   0.02 0.53    0.55    1.01   2.66     2.09
  1st-stage




              0    50    -0.26 3.92   3.92   -0.28 7.36   7.45   -9.63   26.48   20.46
              x     2    -0.02 0.46   0.45   -0.02 0.47   0.47    0.34   1.11     0.83
              p   -0.2   0.01 0.37    0.37    0.01 0.31   0.32   -0.66    1.76   1.37

              p    -4     0.00 0.24   0.23   0.00 0.24    0.23    0.01   0.26    0.31
  2nd-stage




              0    50    -0.07 3.99   3.84   -0.06 3.72   3.65    0.05   4.32    4.61
              x     2    -0.01 0.48   0.47   -0.01 0.41   0.41    0.03   0.52    0.51
              p   -0.2   0.01 0.36    0.36    0.00 0.31   0.32   -0.03   0.40    0.40


corresponds to the GMM estimates obtained using three alternative Differentiation
IV: (i) local competition, (ii) sum of square of characteristic differences, and (iii) sum
of rival characteristics. In each specification we use the residual cost-shock, jt , as
a price instrument. In the bottom-panel, we use the GMM results from the corre-
sponding specification to construct an approximation to the optimal IV, as described
in equation (23). Each entry is averaged over 1,000 Monte-Carlo replications.
    The results suggest that the Berry, Levinsohn, and Pakes (1999) approximation
successfully corrects the weak identification problem. For instance, the sum of rival
characteristics specification is associated with very noisy estimates of p in the top
panel, but the average bias and RMSE are mostly comparable across columns in the
bottom panel. Similarly, the RMSE of p estimated with the quadratic Differentiation
IVs is roughly 50% smaller in the second-stage. The efficiency gains are much smaller in
the first specification (17%), mostly because the local Differentiation IVs are stronger
instruments in this case.
    Importantly, the simulation results illustrate a strong complementarity between
the two approaches. The second-stage estimates are more precisely estimated when
the Differentiation-IVs are used in the first-stage. In other words, using stronger in-
struments in the first stage lead to more precise results in the second stage. This
should be thought of as a lower bound on the efficiency gains of using strong versus
weak first-stage instruments. As we saw in the "Hotelling" vs "Normal RC" examples
above (see Table 7) the efficiency loss from using inconsistent initial parameter values

                                               44
is small in the multiplicative random-coefficient specification. Also, Reynaert and Ver-
boven (2013)'s simulation results suggest that the heuristic approximation is becoming
weaker as the the number of random-coefficients increases beyond four. It is likely that
the complementarity between the two approaches would increase with the number of
non-linear parameters, since the performance of the Differentiation-IVs is very stable
across different dimensions of consumer heterogeneity.


5     Application: Demand for new cars
In this section, we apply our testing and identification strategy to study demand for new
cars between 1971 and 1990. Our objective is twofold. First, we use this application to
illustrate our suggested approach to select instruments, and conduct inference. Second,
we use the car application to demonstrate that it is feasible to identify the model solely
using demand restrictions, and without relying on external moment conditions coming
from a pricing model (as in Berry et al. (1995)) or survey data (Petrin (2002), and
Berry et al. (2004)).
    We use the panel data-set analyzed first by Berry et al. (1995). We enrich the
model used in Berry et al. (1995) by controlling for market and brand fixed-effects (as
in Nevo (2001)). In particular, we consider the following payoff function:

                                                                  K
 uijt = xjt  + p pjt + Make FE + Year FE + jt + p pjt /yi +            k xjt,k ik +   ijt   (25)
                                                                 k=1


 where yi  LN (µy        y
                     t , t ), and ik  N (0, 1). We use 25 brands to construct our make
variable; grouping smaller European and Asian brands together. The distribution
of household income is approximated by a log-normal distribution with time-varying
location and spread parameters. The other random coefficients assumed to be IID
normally distributed. We use 500 Halton draws to integrate the random coefficients
(see Train 2009).
    We use a sequential approach to determine the set of instruments and the random
coefficient specification. We first conduct a series of reduced-form specification tests to
evaluate the the strength of price and differentiation instruments, and then estimate
the model by non-linear GMM. Note that we use the reduced-form specification tests
to guide the specification of the random-coefficient model estimated in the second step.


                                            45
              Table 10: Multinomial Logit demand for cars and IIA tests
                                    (1)         (2)         (3)        (4)        (5)
       VARIABLES

       Price (x1000)             -0.153***   -0.152***   -0.127***    -0.009     0.000
                                   (0.040)     (0.039)     (0.034)   (0.012)    (0.011)
       Distance: Pred. price      0.016***    0.016***    0.014***
                                   (0.004)     (0.004)     (0.004)
       Distance: Nb. doors                    0.027**       0.022
                                               (0.014)     (0.013)
       # same attribute: Air                              0.009**
                                                           (0.004)

       Observations                2,217       2,217       2,217       2,217      2,217
       Weak IV (K-P)               34.82       35.88       57.79       59.49      37.76
       J-test                      0.891       0.894       3.202       19.23      29.96
       J-test (p-value)            0.345       0.344      0.0736     0.000709   0.000870
       Degree of over-id.             1          1           1           4          10
       Joint test: k = 0 (chi2)    16.19       17.41       17.56
       Joint test (p-value)       5.74e-05   0.000166    0.000542
                             Robust standard errors in parentheses
                                *** p<0.01, ** p<0.05, * p<0.1


   We approximate the reduced-form model of price using cost shifters wjt :

                       pjt = xjt 1 + wjt 2 + Make FE + Year FE + ujt .                     (26)

Let p^jt denotes the OLS predicted price. We use this variable to measure the quality
differentiation of cars in the market.
    We use two cost-shifters as instrument for prices. We use the weight of the car
interacted with ratio of steel and bauxite prices to approximate the cost differential
associated with this strategy. Our second price instrument is an indicator variable
equal to one after a model started to be produced in the U.S.. By 1990, 10% of cars
sales were produced by foreign brands established in the US.28 The first-stage F-test
associated with these two instruments is reported in the first three columns of Table
10. Depending on the controls, the Kleibergen-Paap statistics ranges from 34 to 57,
confirming that the two variables are strong predictors of prices.
    Next we analyze the reduced-form model by estimating the multinomial Logit model
(i.e. µij = 0). Recall that we can test the null hypothesis of IIA preferences by
  28
     We use the following list of off-shored models and dates: VW Rabbit (1979), Honda Accord
(1981), VW Golf (1985), Honda Civic (1986), VW Jetta (1986), and Toyota Camry (1989).


                                              46
evaluating the validity of the exclusion restrictions implied by the assumption that the
characteristics of rival products are independent of the unobserved product attributes
jt (conditional on own characteristics fixed-effects). We implement two versions of
this test.
    First, we estimate the model under the null while controlling for differentiation
                          dist
variables (denoted by zjt      ):

                                             dist
             ln sjt /s0t = p pjt + xjt  x + zjt    + Make FE + Year FE + ejt .              (27)

This equation is estimated by (linear) GMM using wjt as instruments for price. This
approach is feasible only because the two IVs (material price and offshoring) are con-
structed independently of our measures of differentiation. Price instruments that are
constructed from the characteristics of rival firms would be invalid if the true model is
not Logit, leading to a biased estimate of p .
    We use measures of product isolation among selected car attributes to construct
 dist
zjt   . For continuous variables, we measure differentiation along dimension k using the
Euclidian distance.29 For price, distance is calculated using p^jt . For discrete attributes
(e.g. domestic or air) we use the number of products with the same attribute as a
measure of differentiation.
    In this application we focus on three attributes: price, number of doors, and air con-
ditioning. We use these three variables as Differentiation IVs, and we assign random-
coefficients to each characteristic. Other attributes were analyzed as well (e.g. mileage,
HP, car size, etc), but we find that differentiation along other dimensions are not cor-
related with the inverse-demand under Logit.
    Columns (1)-(3) in Table 10 test the hypothesis that  = 0 using three sets of the
differentiation variables. The IIA-tests are reported at the the bottom of the table. The
test evaluates the joint hypothesis that   ^ gmm = 0. In this case the p-value measures
the ability of the instruments to identify deviations from IIA (i.e. lower p-value =
stronger instruments).
    We find strong evidence that product isolation along the price dimension leads to
higher market shares; a clear violation of the IIA hypothesis. The positive reduced-
form coefficient p is consistent with a quality-ladder model of demand, in which the
price is inversely proportional to quality (as in Bresnahan (1987)). Differentiation in
  29
    We obtain similar results using the number of nearby products. However the Euclidian distance
is more strongly correlated with demand in this application.


                                               47
                       Table 11: Mixed-logit car demand results

         VARIABLES               NLS                         GMM
                                 (1)        (2)        (3)         (4)       (5)

         p                     -0.722    -2.267     -2.525     -0.768     -0.854
                                (0.38)    (1.00)     (1.17)     (0.31)     (0.34)
         door                   0.318    0.594      0.631      0.458      0.456
                                (0.19)    (0.19)     (0.18)     (0.17)     (0.15)
         air                    0.733               1.833                   0.977
                                (1.14)               (0.66)                (0.72)
         Intercept              1.817                           7.167       7.563
                                (2.63)                           (3.36)    (6.20)
         price                 0.052     0.109       0.143      0.064     0.059
                                (0.02)    (0.03)      (0.05)     (0.01)    (0.01)

         Overid. test (J)                    0.221       0.119       12.599 14.142
         Overid test (p-value)               0.638       0.730        0.006 0.000
         Overid. restrictions                1.000       1.000        3.000 5.000
                         Robust-clustered standard errors in parenthesis
                                *** p<0.01, ** p<0.05, * p<0.1
                        Additional controls: Year fixed-effects, Firm FE.
             Additional characteristics: Air, Doors, HP/WT, DPM, Size, Weight.


terms the number of doors is also positively correlated demand, although the reduced-
form parameter is less precisely estimated. Similarly the number of cars with the same
"Air" attribute is positively correlated with demand. The joint hypothesis test that
the effect of differentiation on demand is zero is rejected with a p-value less than 1%.
    An equivalent approach is to test the over-identification restrictions associated with
the combined set of instruments: cost-shifter and differentiation. Columns (4)-(5)
implement this test by estimating the model under the null that k = 0 without
                  dist
controlling for zjt    . Column (5) uses the same differentiation measures as in Column
(3), which leads to four restrictions. Column (6) uses a richer set of differentiation
measures (see below). The results of the Sargan-Hansen J-test are reported in the
bottom panel.
    Both sets of moment restrictions are clearly violated, confirming the strenght of
the instruments. Importantly, this violation is not caused by the cost-shifters, since
we cannot reject the validity of the exclusion restrictions in columns (1)-(3). Note also
that the estimated price coefficient is no longer different from zero; consistent with
the idea that the differentiation instruments are correlated with prices and the average
willingness-to-pay of consumers under the multinomial Logit specification.


                                             48
   Table 12: Definition on the differentiation variables used in the car application
                                                                                         Specifications
    VARIABLES                                  Definitions                         (1)     (2) (3) (4)

     dist
    zjt,p^                                      j            ^jt )2
                                                      pj t - p
                                                     (^
     dist
    zjt,door                              j   (xj   t,door   - xjt,door )2
     dist
    zjt,air                             j Jt   1(xj    t,air   = xjt,air )

     cov
    zjt,1                        j Jt (^
                                       pj t  -p^jt )(xj t,door - xjt,door )
     cov
    zjt,2                      j Jt   (^
                                       p j t - ^
                                               p jt )(xj t,door - xjt,door )
     cov                                             2
    zjt,3                       j Jt  (^
                                       p j t - ^
                                               p jt ) 1(xj t,air = xjt,air )
     cov                                                  2
    zjt,4                 j   Jt (xj t,door - xjt,door ) 1(xj t,air = xjt,air )


     int
    zjt,1                           ^jt ×
                                    p               j Jt (^
                                                          pj t   -p
                                                                  ^jt )
     int
    zjt,2                 xjt,door ×           j Jt )xj t,door      - xjt,door )

    Number of Diff. IV                                                             2       3    7    9


     The GMM results from the mixed-logit model are presented in Table 11. The first
column reproduces the results obtained from non-linear least-square. As discussed
above, those results are biased, but the precision of the parameters is not affected by
the choice of instruments. The comparison with GMM is a useful indicator of validity
and relevance of the instruments.
     Table 12 formally defines the differentiation measures used as instruments in each
specification. The first column uses the Euclidian distance. The second add the num-
ber of products with the same Air attribute. The third and fourth column add ad-
ditional interactions between product characteristics differences. We augment the set
of instruments to identify a random-coefficient on the intercept. We use the sum of
product characteristics interacted with each product' own attribute as instruments (i.e.
p
^jt , doors). This captures the fact that in a quality ladder model, low quality cars are
closer substitutes with the outside option than higher quality cars. We also incorporate
the interaction of product characteristics differences to impose additional restrictions.
Table 14 in the Appendix confirms the strenght of these instruments using a series of
Sanderson and Windmeijer (2016)'s conditional F-tests associated with each of the five
endogenous variables of the model. See Appendix C for more details.
     The random coefficient on door and prices are the most precisely estimated co-
efficients. Note that the overall price coefficient is the sum of p and p /yi . This


                                                       49
coefficient is negative across all consumer types, except households above the 99th in-
come percentile. In 1990, the product-level price elasticity ranges from -0.3 to -3, with
a median equal to -1.2. The fact that a large number of products exhibit inelastic
residual demand suggest that the model is still mis-specified.
    The coefficient on doors and air imply a larger degree of horizontal differentiation.
Some consumers strongly prefer two-doors car, while others need the largest number of
doors possible (given prices). There is exists a similar amount of heterogeneity across
consumers in the taste for air conditioning.
    The variance of the random-coefficient on the intercept measures substitution to-
wards the outside good. The point estimate associated with intercept is large in mag-
nitude, suggesting that consumers who are in the market for a new car (i.e. high
i,intercept ) are more likely to substitute to another model if their first choice is not
available (rather than not buying a car). The coefficient is less precisely estimated
however, given the fact that the panel is fairly short (20 years).
    The comparison between column 1 (NLS) and (5) (GMM) confirms that the in-
struments correct for an attenuation bias in the random-coefficient parameters. In all
cases, the asymptotic standard errors from NLS and GMM are comparable, consistent
with the idea that the instruments are strong.


Conclusion
In this paper, we have analyzed the theoretical and small-sample properties of a new
family of instruments used to estimate substitution patterns: the Differentiation IVs.
We demonstrate that exogenous measures of differentiation (or proximity in character-
istics) solves the weak identification problem associated with commonly used moment
conditions.
    Importantly, these instruments are derived from two common assumptions on the
primitives of the demand model: (i) linear-in-characteristics indirect utility function,
and (ii) exchangeability of the residual demand shocks. We use these two restrictions
to establish that the reduced-form of the model is a vector-symmetric function of
characteristic differences; a property that solves the curse-of-dimensionality problem
in the reduced-form.
    Our approach to identification and estimation also suggest a natural methodology to
conduct empirical work and report results when estimating demand for differentiated-


                                           50
products. Prior to estimating the model, researchers should first conduct an analysis
of the reduced-form of the model, by estimating the IIA regression described in Section
1. Our simulation results demonstrate that the model is weakly identified if the IIA
hypothesis cannot be rejected (only weakly rejected). This test is easy to implement,
and can be useful to help identifying strong moment restrictions. Furthermore, after
estimating the model, Differentiation IVs can be used to conduct specification tests
evaluating the validity of alternative modeling choices. In particular, the relevance of
the instruments is independent of the assumptions regarding the distribution for the
random-coefficients (e.g. normal, log-normal, correlated), or the functional form of
the utility function (e.g. vertical form vs Hotelling). This feature allow researchers to
conduct non-nested specification tests, based on the validity of the over-identification
restrictions.


References
  Ai, C. and X. Chen (2003, November). Efficient estimation of models with conditional
      moment restrictions containing unknown functions. Econometrica 71 (6), 1795­
      1843.
  Altonji, Joseph, G. and L. Matzkin, Rosa (2005, July). Cross section and panel
     data estimators for nonseparable modesl with endogenous regressors. Economet-
     rica 73 (4), 1053­1102.
  Amemiya, T. (1974). The non-linear two-stage least-square estimator. Journal of
    Econometrics 2, 105­110.
  Amemiya, T. (1977). The maximum-likelihood and non-linear three-stage least-
    squares estimator in the general nonlinear simultaneous equation model. Econo-
    metrica 45, 955­968.
  Angrist, J. and J.-S. Pischke (2009). Mostly harmless econometrics: An Empiricist's
    companion. Princeton University Press.
  Armstrong, T. (2016). Large market asymptotics for differentiated product demand
    estimators with economic models of supply". Econometrica 84 (5), 1961­1980.
  Bayer, P., F. Ferreira, and R. McMillan (2007). A unified framework for measuring
     preferences for schools and neighborhoods. Journal of Political Economy 115 (5),
     588­638.
  Berry, S. (1994). Estimating discrete choice models of product differentiation. Rand
     Journal of Economics 25, 242­262.
  Berry, S., J. Levinsohn, and A. Pakes (1995). Automobile prices in market equilib-
     rium. Econometrica: Journal of the Econometric Society 63 (4), 841­890.

                                           51
Berry, S., J. Levinsohn, and A. Pakes (1999). Voluntary export restraints on auto-
   mobiles: Evaluating a trade policy. American Economic Review 89 (3), 400­430.
Berry, S., J. Levinsohn, and A. Pakes (2004, Feb). Differentiated products demand
   systems from a combination of micro and macro data: The new car market. The
   Journal of Political Economy 112 (1), 68.
Berry, S. and A. Pakes (2007). The pure characteristics demand model. International
   Economic Review 48 (4), 1193­1225.
Berry, S. T., A. Gandhi, and P. Haile (2013). Connected substitutes and invertibility
   of demand. Econometrica 81 (5), 2087­2111.
Berry, S. T. and P. Haile (2014). Identification in differentiated products markets
   using market level data. Econometrica 82 (5), 1749­1798.
Berry, S. T. and P. Haile (2016). Identification in differentiated products markets.
   Annnual Review of Economics 8, 27­52.
Bresnahan, T. (1982). The oligopolistic solution concept is identified. Economic Let-
   ters .
Bresnahan, T. F. (1987). Competition and collusion in the american automobile
   industry: The 1955 price war. The Journal of Industrial Economics 35 (4, The
   Empirical Renaissance in Industrial Economics), 457­482.
Bresnahan, T. F., S. Stern, and M. Trajtenberg (1997). Market segmentation and the
   sources of rents from innovation: Personal computers in the late 1980s. RAND
   Journal of Economics 28 (No. 0, Special Issue in Honor of Richard E. Quandt),
   S17­S44.
Chamberlain, G. (1987). Asymptotic efficiency in estimation with conditional mo-
  ment restrictions. Journal of Econometrics 34 (305--334).
Ciliberto, F., C. Murry, and E. Tamer (2016, May). Market structure and competi-
    tion in airline markets. working paper, University of Virginia.
Co¸
  sar, K. A., P. L. Grieco, and F. Tintelnot (2018). What drives home market
   advantage. Journal of International Economics 110, 135­150.
Compiani, G. (2019). Market counterfactuals and the specification of multi-product
  demand: A nonparametric approach. working paper, Berkeley University.
Conlon, C. (2013, September). The empirical likelihood mpec approach to demand
  estimation. working paper, Columbia University.
Conlon, C. and J. Gortmaker (2019, May). Best practices for differentiated products
  demand estimation with pyblp. working paper, NYU-Stern.
Conlon, C. and J. H. Mortimer (2015, April). Efficiency and foreclosure effects of
  vertical rebates: Empirical evidence. working paper, Columbia University.



                                        52
Cragg, J. G. and S. G. Donald (1993). Testing identifiability and specification in
   instrumental variable models. Econometric Theory 9, 222­240.
Davidson, R. and J. G. MacKinnon (2001). Artificial Regressions, Chapter 1. A
  Companion to Theoretical econometrics. Blackwell, Oxford.
Davis, P. (2006, Winter). Spatial competition in retail markets: Movie theaters.
  Rand Journal of Economics .
Donald, S. G., G. W. Imbens, and W. K. Newey (2008). Choosing instrumental
  variables in conditional moment restriction models. Journal of Econometrics 152,
  28­36.
Doornik, J. A. (2007). Ox - An Object-Oriented Matrix Programming Language.
  Timberlake Consultants.
Doraszelski, U. and A. Pakes (2007). A framework for applied dynamic analysis in
   io. In M. Armstrong and R. Porter (Eds.), Handbook of Industrial Organization,
   Volume 3, Chapter 30, pp. 1557­2440. Elsevier.
Dube, J.-P., J. Fox, and C.-L. Su (2012, September). Improving the numerical per-
  formance of blp static and dynamic discrete choice random coefficients demand
  estimation. Econometrica .
Dube, J.-P., A. Hortacsu, and J. Joo (2020, February). Random-coefficients logit
  demand estimation with zero-valued market shares. working paper, University of
  Chicago.
Eizenberg, A. (2014). Upstream innovation and product variety in the u.s. home pc
   market. Review of Economic Studies .
Farias, V., D. Saure, and G. Y. Weintraub (2012, Summer). An approximate dynamic
   programming approach to solving dynamic oligopoly models. Rand Journal of
   Economics 43 (2), 253­282.
Hausman, J. A. and D. McFadden (1984). Specification tests for the multinomial
  logit model. Econometrica 52 (5), 1219­1240.
Houde, J.-F. (2012, August). Spatial differentiation and vertical mergers in retail
  markets for gasoline. American Economic Review 102 (5), 2147­2182.
Jorgensen, D. W. and J.-J. Laffont (1974). Efficient estimation of nonlinear simul-
   taneous equations with additive disturbances, Volume 3 of Annals of Economic
   and Social Measurement, pp. 615­640. NBER.
Metaxoglou, K. and C. R. Knittel (2014, October). Estimation of random coefficient
  demand models: Two empirisists' perspectives. The Review of Economic and
  Statistics 96 (1).
Miller, N. and M. C. Weinberg (2017). Understanding the price effects of the miller-
   coors joint venture. Econometrica 85 (6), 1763­1791.


                                       53
Miravete, E., M. Moral, and J. Thurk (2018, Fall). Fuel taxation, emissions policy,
   and competitive advantage in the diffusion of european diesel automobiles. Rand
   Journal of Economics , 504­540.
Miravete, E., K. Seim, and J. Thurk (2018). Market power and the laffer curve.
   Econometrica 86 (5), 1651­1687.
Nevo, A. (2000). A practitioner's guide to estimation of random-coefficients logit
   models of demand. Journal of Economics and Management Strategy 9 (4), 513­
   548.
Nevo, A. (2001). Measuring market power in the ready-to-eat cereal industry. Econo-
   metrica 69 (2), 307.
Newey, W. K. (1990). Efficient instrumental variables estimation of nonlinear models.
  Econometrica 58 (809-837).
Newey, W. K. (1993). Efficient estimation of models with conditional moment re-
  strictions. In G. S. Maddala, C. R. Rao, and H. D. Vinod (Eds.), Handbook of
  Statistics, Volume 11. Elsevier.
Nielson, C. (2017). Targeted vouchers, competition among schools, and the academic
   achievement of poor students. Working paper, Princeton University.
Pakes, A. (1994). Dynamic structural models, problems and prospects: mixed con-
   tinuous discrete controls and market interactions. In J.-J. Laffont and C. A. Sims
   (Eds.), Advances in Econometrics: The sixth world congress of the econometric
   society, Volume 2. Cambridge University Press.
Petrin, A. (2002). Quantifying the benefits of new products: The case of the minivan.
   Journal of Political Economy 110, 705.
Pinkse, J., M. E. Slade, and C. Brett (2002). Spatial price competition: A semipara-
   metric approach. Econometrica 70 (3), 1111­1153.
Reynaert, M. and F. Verboven (2013). Improving the performance of random coef-
   ficients demand models: The role of optimal instruments. Journal of Economet-
   rics 179 (1), 83­98.
Romeo, C. J. (2010). Filling out the instrument set in mixed logit demand systems
  for aggregate data. working paper, US Department of Justice.
Salanie, B. and F. A. Wolak (2019, April). Fast, "robust", and approximately correct:
   Estimating mixed demand systems. NBER working paper 25726.
Sanderson, E. and F. Windmeijer (2016). A weak instrument f -test in linear iv
   models with multiple endogenous variables. Journal of Econometrics 190, 212­
   221.
Singleton, J. D. (2019). Incentives and the supply of effective charter schools. Amer-
   ican Economic Review 109 (7), 2568­2612.


                                        54
Starc, A. (2014). Insurer pricing and consumer welfare: evidence from medigap.
   RAND Journal of Economics 45 (1), 198­220.
Stock, J. H. and J. Wright, Jonathan H. (2000). Gmm with weak identification.
   Econometrica 68 (5), 1055­1096.
Stock, J. H. and M. Yogo (2005). Testing for Weak Instruments in Linear IV Re-
   gression, pp. 80­108. Identification and Inference for Econometric Models.
Sullivan, C. (2020, March). The ice cream split: Empirically distinguishing price and
   product space collusio. Working paper, University of Wisconsin-Madison.
Thomadsen, R. (2007). The effect of ownership structure on prices in geographically
  differentiated industries. Rand Journal of Economics .
Train, K. (2009). Discrete Choice Methods with Simulation (Second edition ed.).
   Cambridge University Press.
Verboven, F. (1996). International price discrimination in the european car market.
   Rand Journal of Economics 27 (2), 240­268.
Wright, J. H. (2003). Detecting lack of identification in gmm. Econometric The-
   ory 19 (2), 322­330.




                                        55
ONLINE APPENDIX - NOT FOR PUBLICATION

A      Proofs and additional derivations
A.1      First Proposition
Proposition 1 can be restated as follows. For simplicity we remove the t subscript
associated with each matrix, and drop the parameter vector from the conditioning
variables.

Proposition 1. In the linear characteristics model the market inverse function can be
expressed as

                 -1                                           (2)
                 j  (s0 , s1 , . . . , sJ ; x) = G sj , sk , djk          +C
                                                                    k=j


where djk = xk - xj and C is a constant that is common to all products j = 1, . . . , J .

   The proposition implies that all the cross sectional variation in the inverse function
comes from the component

                       G sj , {sk , djk }k=j = G sj , F j s, d(2)

where we have equivalently expressed the second argument as the empirical distribution
          (2)
of sk , djk among products k = j (which includes the outside good 0 in this sample).
It is important to note that from this empirical distribution, we can only recover the
set of the differences djk but cannot isolate the difference with respect to any particular
product, and also cannot recover xj itself from this distribution (because we cannot
identify the outside good in this set). This brings to light that the cross sectional
variation in the inverse function does not actually depend on a product's level of own
xj , but rather the distribution of differences djk for k = j this product faces.
     We will spend the rest of this section proving the result.

Step 1

The first step is to re-parameterize the demand function j 1 , . . . , J , x(2) in terms
of
                                          exp (j )
                                  tj = J               .
                                          l=0 exp (l )


                                             56
The advantage of this re-parameterization is that it is an alternative location normaliza-
tion (requiring that all products t's to sum to one) that does not create an asymmetry
between the outside good 0 and the inside goods j > 1. This will be analytically more
convenient than the standard normalization of 0 = 0. But they are mathematically
identical. In particular observe that

                                        Tj = log (tj ) = j + C

where C is a constant that is common to all products in a market (that can be solved
by recognizing log t0 = -C ).
     Let  i = (vi1 , . . . , viK2 , i0 , . . . , iJ ) denotes the vector consumer taste parameters
with joint CDF (·). We can thus express demand in terms of this re-parameterization,
i.e.,
                                                           K2
                                                                     (2)
                                u (tj , xj ,  i ) = Tj +         vik xjk +    ij
                                                           k=1

and

  Dj (t0 , . . . , tJ ) =   1 [u (tj , xj , )  u (tk , xk , ) k = 0, . . . , J, k = j ] d () .   (28)

We then have that

                            Dj t0 , . . . , tJ , x(2) = Dj 1 , . . . , J , x(2) .

This is because preferences are translation invariant. Moreover we have that

                          -1                               -1
                     log Dj  s0 , . . . , sJ , x(2) + C = Dj  s0 , . . . , sJ , x(2) .

Our strategy moving forward is to show that

                         -1                                                  (2)
                        Dj  s0 , . . . , sJ , x(2) = D-1 sj , sk , djk                   .       (29)
                                                                                   k=j


Then defining G = log D-1 will give us the Theorem.




                                                     57
Step 2

We now establish 3 properties of Dj t1 , . . . , tJ , x(2) : symmetry, anonymity, and trans-
lation invariance. Each of these properties will then be preserved by the inverse map-
        -1
ping Dj    . To establish these properties let us define a product j 's state  j as

                                         j = (tj , xj )

and note that
                        Dj t0 , . . . , tJ , x(2) = Dj  j ,  -j , x(2) .

The following two properties are relatively straightforward to show using the definition
of demand (28) and the symmetry of the idiosyncratic errors ( ij ). The first property
is

Definition 2. The function Dj  j ,  -j , x(2) is symmetric if Dj  j ,  -j , x(2) =
Dk  j ,  -j , x(2) for any k = j .

   This implies we can write Dj  j ,  -j , x(2) = D  j ,  -j , x(2) .

Definition 3. The function D  j ,  -j , x(2) is anonymous if D  j ,  (-j ) , x(2) where
(·) is any permutation of the indices -j .

   We note that symmetry and anonymity are the same properties that Doraszelski
and Pakes (2007) use to reduce the dimensionality of value functions in dynamic games.
These properties can be established for the demand functions Dj .
   There is one last property of demand we will exploit which is the following:

Definition 4. The function D  j ,  -j , x(2) is translation invariant if for any c  RK
we have that

                 D  j + (0, c) ,  -j + (0, c), x(2) = D  j ,  -j , x(2)


where (0, c) is the J dimensional vector consisting of elements (0, c).

    This property can be established using the linearity of the characteristics utility uij
in xj . It is important to note that the second argument in D includes the outside good.




                                              58
Step 3

Now define the relevant state for the inverse mapping as

                                            mj = (sj , xj ) .

Then
                              -1                           -1
                             Dj  s0 , . . . , sJ , x(2) = Dj  (mj , m-j ) .

Using the above properties of the demand function D, we can establish precisely the
                     -1
same properties for Dj  , namely symmetry, anonymity, and translation invariance.
Thus we have that

            -1                                                  (2)                      (2)
           Dj  (mj , m-j ) = D-1 mj + 0, -xj                           , m-j + 0, -xj
                                                          (2)
                                  = D-1 sj ,         sj , djk
                                                                      k=j


where the first equality follows from symmetry and translation invariance, and the
second equality follows from anonymity. We have thus succeeded in establishing (29)
and hence Theorem 1.


A.2      Second Proposition
Let x = (x0 , . . . , xJ ) be the entire market menu of product characteristics. We assume
here for simplicity that x is fully independent of  = 1 , . . . , J . Consistent with the
symmetry of the model, the distribution F is assumed to have a symmetric distribu-
tion. Then we have the following result which suffices to establish Proposition 2 in the
paper.

Proposition 2. The conditional expectation of interest in the model can be expressed
as

                       (2)                                                       (2)
 E D-1 sj ,       sj , djk             |x      = E D-1 sj ,                 sj , djk           | {djk }k=j
                                 k=j                                                   k=j

                                                                                 (2)
                                               = E D-1 sj ,                 sj , djk           | Fj (d)
                                                                                       k=j


where Fj (d) is the empirical distribution of the sample of differences {djk }k=j .


                                                   59
    Assume that the djk can be canonically ordered (based on some complete ordering
                                                      ~ j1  · · ·  d
in RK , such as the lexicographic ordering) such that d            ~ jK where d
                                                                              ~ jl is the
lth largest from the {djk }k=k . Then we can express


           D-1 sj ,
                                  (2)
                            sj , djk                 = D-1 s
                                                           ~j 0 , s
                                                                  ~j 1 , . . . , s     ~ (2) , . . . , d
                                                                                                       ~ (2)
                                                                                 ~jJ ; d j1              jJ
                                           k=j


where s
      ~j 0 is sj and s
                     ~ji is the market share corresponding to the product with difference
  (2)
~ . Now it can be shown that the distribution
d ji


                               Fs
                                ~j 0 ,s
                                      ~j 1 ,...,s
                                                ~jJ |x = Fs     ~j 1 ,...,s
                                                          ~j 0 ,s              ~ j 1 ,...,d
                                                                          ~jJ |d          ~ jJ .


That is d~ j1, . . . , d
                       ~ jJ is a sufficient statistic of the market menu x to determine the
distribution of the shares (~     sj 0 , . . . , s
                                                 ~jJ ). We then have that


E D-1 sj ,
                      (2)
                sj , djk                |x         = E D-1 s
                                                           ~j 0 , s
                                                                  ~j 1 , . . . , s     ~ (2) , . . . , d
                                                                                                       ~ (2) | x
                                                                                 ~jJ ; d j1              jJ
                               k=j

                                                   = E D-1 s
                                                           ~j 0 , s
                                                                  ~j 1 , . . . , s     ~ (2) , . . . , d
                                                                                                       ~ (2) | d
                                                                                 ~jJ ; d                                     ~ jJ
                                                                                                               ~ j1, . . . , d
                                                                                         j1              jJ

                                                                                              (2)
                                                   = E D-1 sj ,                       sj , djk            | Fj (d)
                                                                                                    k=j


A.3     Derivation of example with demographic differences
Consider the following single dimension example (Nevo 2001):

                                                     (2)
                           uijt = jt + bit xjt + ijt ,                   bit = y yit + i .                           (30)

The random coefficient is composed of a demographic component yit that is distributed
according to (known) CDF Dt (y ), and a residual component i that is normally dis-
tributed with mean zero and variance 2  . The vector of non-linear parameters contains
two elements:  = {y ,  }.
    Assume that the distribution of demographic characteristics can be well approxi-
mated using the following affine transformation of random variable ei :

                      yit = mt + sdt ei such that Pr(ei < x) = e (x).

where {mt , sdt }t=1,...,T and e (x) are known transformation of the observed distribution


                                                             60
Dt (y ).
    We can use this standardization to express the aggregate demand function:

                                                           (2)               (2)
                                     exp jt + y yit xjt +  i xjt
          (2)
jt ( t , xt ; )   =                                                                       (di ;  )de (yit ; mt , sdt )
                                      Jt                            (2)            (2)
                              1+      j =1   exp j t + y yit xj t +  i xj t
                                      ~jt +       K2         (2)
                                  exp             k=1   vik x
                                                            ~jt,k
                  =                                                           (v i ; )dv i
                                   Jt         ~j t +      K2          (2)
                            1+     j =1   exp             k=1    vik x
                                                                     ~jt,k
                  = j (     ~ (2)
                        ~t, x t ; ).                                                                              (31)

         (2)          (2)   (2)
where x  ~ jt = sdt xjt , xjt is an expanded vector of non-linear characteristics, v i =
{ei , i }, and is the joint density of v i defined from  (·) and e (·).
     Note that the change of variables allows us to eliminate the t subscript from the
demand function, and expand the state space by adding two new interactions: (i) the
                      (2)                                               (2)
mean of yit times xjt , and (ii) the standard-deviation of yit times xjt .
     Under this new parametrization of the model, we can use directly Proposition 2 to
write the reduced-form of the model as follows:

                                                             (2)
                            jt (xt ; ) = g djt , sdt · djt ;  + ct ()                                    (32)

   The argument can easily be extended to multiple dimensions of heterogeneity, as
long as the distribution of demographic characteristics can be standardized across mar-
kets. For instance, the quadratic basis function becomes:
               
                            (2)
                wjt , Mt · xjt                           Own excluded characteristics
                                 2
                          k
               
                         d         , k                   Isolation of product j along dimension k
               
                j =j jt,j
               
                                      2
Aj (xt , wt ) = Mt · j =j dk     jt,j   , k              Product isolation × demographics                       (33)
                        k          l
                  j =j djt,j × djt, ,     k = l          Interaction between dimension k and l
               
               Mt ·            k        l
                        j =j djt,j × djt,   k = l        Characteristics interaction × demographics
               


 where Mt is now a vector of moments characterizing the joint distribution of demo-
graphic characteristics in market t. Focussing on the quadratic term, the added instru-
ments capture how product differentiation asymmetrically impacts the inverse-demand
of product j depending on the distribution of demographic attributes of consumers. See


                                                   61
Miravete, Seim, and Thurk (2018) for an example of this type of instrument function.


B       Monte Carlo Simulation Designs and Algorithms
B.1      Monte Carlo Simulations
We use the following parametrization for the independent random-coefficients specifi-
cations:

    · k,k =  = 4 for all k = 1, . . . , K2

    · ik  N (0, 1) for all k = 1, . . . , K2

    ·   ij    T1EV(0, 1)

    We use the following covariance matrix for the correlated random-coefficient exam-
ple:

                    Table 13: Random Coefficient Covariance Matrix

                                   c1     c2         c3      c4
                            r1   4.000
                            r2   -2.000 4.000
                            r3   2.000 -2.000       4.000
                            r4   2.000 -2.000       2.000   4.000


    The data-generating process for all numerical exogenous characteristics examples
in Sections 4 and 4.3 is described as:

    · Number of products (Jt ): 15

    · Number of market (T ): 100

    · Observed characteristics: xjt,k  N (0, 1) for all k = 1, . . . , K

    · Cost shifter: jt  N (0, 1)

    · Unobserved quality: jt  N (0, 1)




                                               62
B.2     Computational Procedure
All numerical simulations and optimizations were done using the matrix programming
language Ox (Doornik 2007). We use a nested fixed-point algorithm to solve the non-
linear GMM problem:

                                  min ngn ( )W n gn ( )T                                   (34)

where W n is an L × L efficient weighing matrix, and gn ( ) = ( )T Z /n is the empirical
counterpart of the moment conditions defined in equation (6).
    The residual function is obtained by inverting the demand function for a candidate
parameter vector . We use the following Newton-Raphson method root-finding algo-
rithm to solve this problem separately for each market t. Following Berry et al. 1995,
the algorithm solves the following non-linear system of equation:

                  fj ( ) = ln sjt - ln j ( t , x(2) ; ) = 0 j = 1, . . . , J.              (35)

    We discretize the distribution of random coefficients to approximate the demand
function. To avoid creating an estimation bias, we use the same grid points when
simulating and estimating the model. In the multi-dimensional models, we use the
quartiles of the standard-normal along each dimension. With a single dimension, this
leads to S = 4 consumer types. With two dimensions, S = 16. Etc. The weights
assigned to each consumer type sum to one, and are proportional to the normal density.

Algorithm 1 (Demand Inversion). Initiate the algorithm at vector of quality  1
                                                                             t (e.g.
solution evaluated at last iteration parameter's guess). Iteration l:

  1. Evaluate the predicted demand via Monte-Carlo simulation:
                                                      l
                                                 exp(jt + k k ik xij,k )
                  j ( k    (2)
                      t , x ; )    =        i            l
                                        i
                                              1 + j exp(j  t+ k k ik xij ,k )



  2. Use the implicit theorem to calculate the J × || Jacobian matrix of the zero-
     function f ( ) above:

                                                                   -1
              l               l      ( l , x(2) ; )
                                  (2)                                     ( l , x(2) ; )
          F ( ) = -1/ ( , x ; )  -
                                       T                                     


                                               63
  3. Updating:
                                          
                                           l + f ( l )             If ||f ( l )|| >   1
                                l+1
                                      =
                                           l + F ( l )-1 f ( l )   If ||f ( l )||     1




  4. If ||f ( l )|| <   2
                            , stop. Else repeat step 1-3.

    This root-finding algorithm use two tolerance variables ( 1 and 2 ). The first one
determines the threshold after which the algorithm starts to use Newton-Raphson
steps. We set 1 = 0.1. When this value is increased, the algorithm is equivalent to
the contraction-mapping algorithm proposed by Berry et al. 1995. The advantage of
the Newton-Raphson steps is that it converges at a faster rate than the contraction-
mapping. However, it can diverge when the starting values are too far from the truth.
We set the overall convergence criteria equal to: 2 = 10-16 . Note also that this algo-
rithm is easily parallelizable, since a fixed-point vector needs to be calculate separately
for each market.
    Since the GMM objective function is a quadratic form, the Gauss-Newton Regres-
sion (GNR) algorithm is a computationally efficient method for finding the minimum
(see for instance Newey (1993)). Each optimization step is obtained by estimating a
linear GMM problem corresponding to a linear approximation of the residual function.

Algorithm 2 (Gauss-Newton Regression). Initiate the algorithm at parameter  1 .
Iteration k :
                                                   -1                           (2)
  1. Invert demand system at  k : j st , xt ;  k = j  st , xt ; k - xjt  k

  2. Evaluate the Jacobian of the residual-function using the implicit function theorem:
                                                                       (2)
                                                                             
                                                              -1
                   j st , xt ;            k                   j  st , xt ; k 
                                              =      -xjt ,                           = Y jt ( k )
                              T                                     T            


  3. Compute the Guass-Newton step using linear GMM:

                                                                                 -1
                                        ^ = (Y T Z )W n (Z T Y )
          jt ( k ) = Y jt ( k )b + ejt  b                                             (Y T Z )W n (Z T )


  4. Update parameter vector:
                                                                  ^
                                                       k+1 =  k + b

                                                          64
               ^|| < . Else repeat steps 1-5.
  5. Stop if ||b

    The Gauss-Newton algorithm has good convergence properties when the moments
are strong. This is because strong instruments imply a lot of curvature in the GMM
objective function, which is therefore well approximated by a quadratic function. In
contrast, weak instruments are associated with little or no curvature in the objective
function, which leads to convergence problems. We use the GNR algorithm in all
specifications using Differentiation IVs. To estimate the model with weak instruments,
we use a Nelder-Mead (or Simplex) algorithm to find the local minimum
    The Gauss-Newton algorithm also highlights the fact the model can be represented
by a linear GMM problem. Step (3) corresponds to a Gauss-Newton regression. The
solution,  ^ , is implicitly defined by setting the linear parameters of Gauss-Newton
regression to zero: b^ (^ ) = 0. This defines a linear (local) reduced-form for the GMM
problem:

                                 (^ ) = Zb + v 1                                    (36)
                                 J (^ ) = Z + v 2                                   (37)

where J (^ ) is a n ×|| matrix containing the slopes of the inverse demand with respect
                                                           -1        (2)
to each of the non-linear parameters (i.e. Jjt,k ( ) = j       st , xt ; k /k ),  is a
K ×|| matrix of reduced-form parameters, and (v 1 , v 2 ) are the reduced-form residuals.
Standard rank conditions for local identification of the model requires that the moment
conditions contain enough excluded instruments correlated with the slope of the inverse
demand (i.e. the endogenous variables of the model).


C     Gauss-Newton regression and weak IV tests
We analyze the weakness of the instruments by estimating a Gauss-Newton (GN)
regression. The GN regression is most often used to minimize GMM or non-linear
least-square problem. The solution to the non-linear GMM problem can be obtained as
a sequence of linear GMM regressions obtained from a quadratic approximation of the
moments. Salanie and Wolak (2019) uses this property to construct a "fast" estimator
of the mixed-logit model. The GN regression can also be used to conduct inference on
^gmm , since the variance-covariance matrix of 
                                                ^gmm is the same as linear coefficients
from the GN regression. See Davidson and MacKinnon (2001) for a discussion of the

                                           65
usefulness of "artificial regressions" for testing and inference in econometrics.
    Conditional of a vector of parameters ( = , ), the GN regression is given by
linear structural and reduced-form equations:

                                     ( ) = J ( )b + v 1                                           (38)
                                        J ( ) = Z + v 2                                           (39)

where J ( ^ ) is a n ×| | matrix containing the slopes of the inverse demand with respect
                                                                   -1        (2)
to each of the non-linear parameters. That, is Jjt,k ( ) = j           st , xt ; k /k if
k = k (non-linear parameter), and Jjt,k ( ) = -xjt,k if k = k (linear parameter).
This system of equations contains || +1 endogenous variables: the Jacobian associated
with each of the random coefficient parameter and price. The solution to the non-linear
GMM problem is defined as ^     b(gmm ) = 0, since ^b is the score of the GMM problem.
We use the GN regression evaluated at      ^gmm
                                                 to conduct inference on the parameters,
and test the rank condition of the non-linear GMM problem.
    Table 14 reports the Sanderson and Windmeijer (2016)'s conditional F-tests associ-
ated with each of the five endogenous variables of the model. We construct these weak
IV tests using the Jacobian function of the residual evaluated at the GMM estimates.30
The statistics are all above standard levels for first-stage F-tests, consistent with the
idea that the instruments generate enough independent variation in the moments to
identify all five parameters.
    Note that we do not report the p-values associated with each test. This is because
the F-tests are evaluated at the estimated parameters, rather than at the true.31 This
implies that standard statistical significance tables are not necessarily applicable. Our
simulations results however show that statistics evaluated at 0 and     ^ are highly corre-
lated, even in the presence of weak instruments. We therefore interpret the magnitude
of the tests as measure of strength.
    Below is a sample STATA code to estimate the Gauss-Newton regression to con-
duct inference and tests for weak instruments. The code uses two input files. "Re-
sults gnr $spec.dta" is a spreadhseet containing the product characteristics, instru-
ments, and Jacobian functions. "Results wmatrix $spec.dta" is a square matrix con-
taining the (inverse) weighing matrix used for the minimization of the GMM problem.
  30
    See Appendix C for more details.
  31
    In general, the distribution of the test is sensitive to the weakness of the instruments, since the
Jacobian function depends on the unknown 0 . See Wright (2003) for a discussion.


                                                  66
               Table 14: First-stage Weak IV tests using the car data

                                                         Variables
      Specifications   Test statistics   price   doors    air intercept   price

      (1)              SW   -   F        19.32   111.88                   34.35
      (2)              SW   -   F        12.04    77.98 81.55             20.70
      (3)              SW   -   F        20.50    66.49          90.19    185.68
      (4)              SW   -   F        14.73    61.89 41.22    36.44    116.12

The code uses the user-written ado file "ivreg2" which estimates linear GMM model,
and runs a battery of specification tests. The Jacobian functions of the inverse demand
are calculated analytically using the implicit function theorem (see Nevo (2000)).

#delimit;

use "Results_gnr_$spec.dta", clear;

reshape long diffiv_, i(model year) j(iv);
sum iv;
global nb_diffiv=r(max);
global diffiv;
forvalues i=0/$nb_diffiv {;
global diffiv $diffiv diffiv_`i';
};
global iv $priceiv $diffiv;

/* Weighting matrix */
use "Results_wmatrix_$spec",clear; /* Load weighting matrix */

mkmat $x Intercept $iv , matrix(A); /* Create matrix type */
mat rownames A=$x _cons $iv ;
mat colnames A=$x _cons $iv;
mat W=invsym(A);

/* Load residual, characteristics, jacobian and IVs */
use "Results_gnr_$spec", clear;

                                            67
format * %9.6g;

/* GN IV regression with weighting matrix W */
ivreg2 xi $x ($endovar =$iv), r wmatrix(W) cluster(model) ffirst;
mat V=diag(vecdiag(e(V)));
mat se_$spec=vecdiag(cholesky(V))';
mat colnames se_$spec=se_$spec;
mat spec_test_$spec=(e(idstat),e(idp),e(j),e(jp),e(jdf))';
mat rownames spec_test_$spec= KP_test KP_pv J_test J_pv J_df;



/* Save weak IV tests */
clear;
mat F=e(first);
svmat2 F, rnames(stats) names(col);
keep if stats=="SWF" | stats=="SWFp";
gen spec="$spec";
list;
mat list F;
save results/WeakIV_test_$spec, replace;

use results/Car_demand_estimates_$spec, clear;
rename Var1 est_$spec;
mkmat est;
mat rownames est_$spec= $endovar $x _cons;



/* Save GMM results to spreadsheet */
clear;
svmat2 est_$spec, rnames(param);
svmat2 se_$spec;
local nparam=_N;
local N=_N+5;
set obs `N';


                                  68
svmat2 spec_test_$spec, rnames(stats);
local i=1;
local row=`nparam'+1;
foreach var in KP_lm KP_pv J_test J_pv J_df {;
replace est_$spec=spec_test_$spec1[`i'] if _n==`row';
replace param=stats[`i'] if _n==`row';
local row=`row'+1;
local i=`i'+1;
};
drop stats;
drop spec_test_$spec1;
save "results/GMM_results_$spec", replace;




                                  69
