                               NBER WORKING PAPER SERIES




   IDENTIFICATION AND ESTIMATION IN DISCRETE CHOICE DEMAND MODELS
        WHEN ENDOGENOUS VARIABLES INTERACT WITH THE ERROR

                                           Amit Gandhi
                                           Kyoo il Kim
                                           Amil Petrin

                                       Working Paper 16894
                               http://www.nber.org/papers/w16894


                     NATIONAL BUREAU OF ECONOMIC RESEARCH
                              1050 Massachusetts Avenue
                                Cambridge, MA 02138
                                    March 2011




We thank Arthur Lewbel, Rosa Matzkin, and numerous seminar participants for many helpful suggestions.
This paper previously circulated under the title “The Interaction of Observed and Unobserved Demand
Factors in Discrete Choice Demand Models.” The views expressed herein are those of the authors
and do not necessarily reflect the views of the National Bureau of Economic Research.

NBER working papers are circulated for discussion and comment purposes. They have not been peer-
reviewed or been subject to the review by the NBER Board of Directors that accompanies official
NBER publications.

© 2011 by Amit Gandhi, Kyoo il Kim, and Amil Petrin. All rights reserved. Short sections of text,
not to exceed two paragraphs, may be quoted without explicit permission provided that full credit,
including © notice, is given to the source.
Identification and Estimation in Discrete Choice Demand Models when Endogenous Variables
Interact with the Error
Amit Gandhi, Kyoo il Kim, and Amil Petrin
NBER Working Paper No. 16894
March 2011
JEL No. C25,L0

                                              ABSTRACT

We develop an estimator for the parameters of a utility function that has interactions between the unobserved
demand error and observed factors including price. We show that the Berry (1994)/Berry, Levinsohn,
and Pakes (1995) inversion and contraction can still be used to recover the mean utility term that now
contains both the demand error and the interactions with the error. However, the instrumental variable
(IV) solution is no longer consistent because the price interaction term is correlated with the instrumented
price. We show that the standard conditional moment restrictions (CMRs) do not generally suffice
for identification. We supplement the standard CMRs with new moments that we call “generalized”
control function moments and we show together they are sufficient for identification of all of the demand
parameters. A major advantage of our setup is that it requires little more than the existence of the same
instruments used in this standard IV setting. We run several monte carlos that show our approach works
when the standard IV approaches fail because of non-separability. We also test and reject additive
separability in the original Berry, Levinsohn, and Pakes (1995) automobile data, and we show that
demand becomes significantly more elastic when the correction is applied


Amit Gandhi                                           Amil Petrin
University of Wisconsin                               Department of Economics
1180 Observatory Drive                                University of Minnesota
Madison, WI 53706-1393                                4-101 Hanson Hall
agandhi@ssc.wisc.edu                                  Minneapolis, MN 55455
                                                      and NBER
Kyoo il Kim                                           petrin@umn.edu
Department of Economics
University of Minnesota
4-129 Hanson Hall
1925 4th Street South
Minneapolis, MN 55455
kyookim@umn.edu
1        Introduction
        Demand estimation is a critical issue in many policy problems and correlation between unob-
served demand factors and prices arising from market equilibration can confound estimation. In
discrete choice settings the problem is complicated by the fact that the unobserved demand factor
enters non-linearly into the demand equation, making standard Instrumental Variables (IV) tech-
niques invalid. A major contribution of Berry (1994) and Berry, Levinsohn, and Pakes (1995) is to
show how to invert from market shares the mean utility term. As long as the unobserved demand
factor enters mean utility additively, standard IV techniques can be applied to recover the demand
parameters subsumed in it.
        Restricting the unobserved demand factor to enter utility additively is not always innocuous.
Separability rules out several important aspects of economic behavior. For example, separability
does not allow unobserved advertising to affect the marginal utility derived from observed character-
istics or from the composite commodity index (typically given by residual income), even though this
is often the purpose of advertising. Similarly, if the demand error represents unobserved physical
characteristics, a separable setup does not allow the marginal utility derived from observed charac-
teristics or the composite commodity index to depend on the level of the unobserved characteristic.
Empirically, allowing for the possibility of a non-separable error may be important because the set
of product characteristics observed by the practitioner is often limited, leaving a large role for the
unobserved demand factor in explaining realized demand.
        Our main contribution is to show how to consistently estimate demand parameters while allowing
for observed endogenous and exogenous variables to interact with the unobserved factor. We begin
by showing when endogenous variables interact with the demand error, the Berry (1994)/Berry,
Levinsohn, and Pakes (1995) inversion and contraction can still be used to recover the mean utility
term. However, the IV approach is no longer consistent for the parameters embedded in the mean
utility term. The instrumented price is correlated with the interaction term between price and the
unobserved demand factor, which is now in the estimation equation’s error.
        We then show in Section 3 that the conditional moment restrictions (CMR) used in the Berry/BLP
setup are no longer sufficient for identification. While higher-order moments of the standard CMRs
solve the identification problem if only exogenous variables interact with the demand unobservable,
they do not help with identification when one (or more) endogenous variables interacts with the
demand unobservable. Our non-separable setup thus provides a simple example of the failure of
identification using CMRs in settings with non-separable errors (see Blundell and Powell (2003) and
Hahn and Ridder (2008)).
        Our setup is closest to a model of multiplicative heteroskedasticity with both exogenous and en-
dogenous variables interacting with the error.1 We achieve identification by coupling the Berry/BLP
CMRs with new moment conditions based on insights from Kim and Petrin (2010d), who revisit
the early control function literature (see Section 4). We develop a control function that conditions
    1
        Our approach can be generalized somewhat (see Kim and Petrin (2010b)).



                                                          2
out the correlation between the unobserved demand factor and price. We then construct the new
moments conditions based on a specification that includes the control function as an addtional
explanatory variable for mean utility. For identification the control function must not have argu-
ments that are perfectly collinear with price and other characteristics entering mean utility. We
show the CMR conditions from BLP put shape restrictions on the control function that ensure this
collinearity does not occur.
      We prove identification for the random coefficients case using a high-level condition from Berry,
Linton, and Pakes (2004) (see the Appendix). In Section 5 we provide a proof for the case without
random coefficients that more clearly illustrates how combining the two types of moments achieves
identification. This proof shows that we require little beyond the standard conditions for identifi-
cation with valid instruments. Specifically, just as in Berry/BLP, if price is the only endogenous
variable then we only require one instrument that shifts price around and is excluded from utility.
      We develop a semiparametric sieve estimator for our non-separable demand model and prove
consistency in Section 6. In a setting without random coefficients our estimator inverts market
shares to recover mean utility and then reduces to three simple steps. With random coefficients for
each evaluation of the objective function we use the BLP contraction to solve for the mean utility
term and then carry out the same simple steps.2
      In Section 7 we run three sets of Monte Carlos to illustrate implementation of our estimator
and to show the possible impact of interaction terms on estimated demand elasticities. In all of the
Monte Carlos both ordinary least squares (OLS) and two-stage least squares (2SLS) are significantly
biased while our estimator is consistent.
      We then return to the original Berry, Levinsohn, and Pakes (1995) automobile data to investigate
whether allowing for interaction terms changes the estimated demand elasticities (see Section 8).
In our most general specification where we include interactions terms and random coefficients, we
reject at the 5% level that the coefficients on all of the interaction terms are zero, and demand
elasticities increase on average by 60% relative to 2SLS.
      We are aware of three other approaches that can allow for some form of non-separability with
endogenous prices in discrete choice settings.3 In the case where an observed characteristic exists
that is perfectly substitutable (i.e. separable) with the unobserved demand factor, Berry and Haile
(2010) show the Berry/BLP CMRs are sufficient for identification. Bajari and Benkard (2005) and
Kim and Petrin (2010a) - which are based on Imbens and Newey (2009) - invert out from the pricing
function a vector of controls that are exactly one-to-one functions with unobserved factors. The
benefit of inverting out the unobserved factors is they are then observed, and one can allow for
much more flexible non-separable settings than our setup. The drawback is that they require strong
conditions on the demand and supply setting to get existence of the inverse. We provide a more
detailed comparison with all three approaches in Section 4.
  2
    Code is available from the authors for Stata.
  3
    Also see a recent nonparametric bounds (partial identification) approach by Chesher, Rosen, and Smolinski
(2011).




                                                     3
2    Utility Specification
    We use a standard discrete choice model with conditional indirect utility uij given as a function
of observed and unobserved product j and consumer i characteristics. We decompose utility into
three components
                                              uij = δj + µij + ij                                     (1)

where first component, δj is a product-specific term common to all consumers, the µij term captures
heterogeneity in consumer tastes for observed product characteristics and can be a function of
demographics, and ij is a “love of variety” taste term that is assumed to be independent and
identically distributed across both products and consumers. Consumer i is assumed to choose the
product j out of J +1 choices that yields maximal utility, and market shares obtain from aggregating
over consumers.
    The utility component common to all consumers, δj , is usually given as

                                           δj = c + β 0 xj − αpj + ξj ,

where we normalize the mean utility derived from the outside good be zero (δ0 = 0), xj =
(xj1 , . . . , xjK )0 and β are, respectively, the vector of observed (to the econometrician) product
characteristics and the population average taste parameters associated with those characteristics,
α is the marginal utility of income and pj denotes the price of good j, and ξj is the characteristic
observed to consumers and producers but unobserved to the econometrician. It may represent other
physical attributes of the product or advertising that is not conditioned upon in the estimation, and
it is usually found to be positively correlated with price, biasing elasticities in the positive direction.
    µij is parameterized as

                                    K
                                    X          XR                      K
                                                                       X
                            µij =         xjk (   τrk zir ) + σc νic +   σk νik xjk
                                    k=1       r=1                    k=1

where zi = (zi1 , . . . , ziR ) is a vector of consumer specific demographics which may include income
and τk = (τ1k , . . . , τRk ) with τrk the taste parameter associated with demographic characteristic
r and product characteristic k. τrk zir is then the marginal utility derived from a unit of the kth
characteristic for a consumer with demographic zir . νi = (νic , νi1 , . . . , νiK ) are mean-zero standard
normal idiosyncratic taste shocks for each consumer-characteristic pair and σ = (σc , σ1 , . . . , σK ) are
the standard deviation parameters associated with the taste shocks.
    We write the vector of induced tastes for each product for individual i as µi = (µi1 , . . . , µiJ ).
Letting f (µi ) be the induced density and assuming ij is independent and identically distributed
extreme value, the market share of product j is




                                                        4
                                                           eδj +µij
                                                      Z
                                           sj (δ) =       J
                                                                        f (µ)dµ
                                                               δ   +µ
                                                          P
                                                             e   k   ik
                                                          k=0


Letting τ = (τ1, . . . , τK ), Berry (1994) shows under certain conditions that a unique δ(σ, τ ) =
(δ1,..., δJ ) exists that exactly matches observed to predicted markets shares,

                                               s(σ, τ, δ(σ, τ )) = sData ,

and Berry, Levinsohn, and Pakes (1995) provide a contraction mapping that locates it conditional
on any values of (σ, τ ). Together these results are critical for addressing the endogeneity of price.
2.1      Non-Separable Demand
       Our main contribution is to extend this utility framework to a setup where we allow the mean
utility term to include interactions between observed and unobserved product attributes

                                                                K
                                                                X
                            δj = c + β 0 xj − αpj + ξj +              γk xjk ξj + γp (ȳ − pj )ξj .                    (2)
                                                                k=1

(γ, γp ) is the new vector of parameters, y is representative income, and the interaction terms between
the observed variables are included in xj . Theory readily accommodates this extension (e.g. see
McFadden (1981)). The γk ’s allow unobserved advertising or an unobserved product characteristic
to impact the marginal utility from observed characteristics. Similarly, γp allows the marginal utility
of income to depend on the amount of unobserved quality or unobserved advertising. Thus if γp is
negative consumers become less price sensitive as the demand error increases.
       We can continue to use the same result from Berry (1994) to establish the existence and unique-
ness of a δ(σ, τ ) = (δ1,..., δJ ) that exactly matches observed to predicted markets shares.4 However,
if γp 6= 0 the standard two stage least squares estimator (or GMM estimator) that recovers the
parameters contained in δ is inconsistent.
2.2      Standard 2SLS Inconsistent with Non-Separable Demand
       Let the instrumented value of pj be given by p̂j and rewrite (2) as

                                                      K
                                                      X
                                0
                   δj = c + β xj − αp̂j + [ξj +             γk xjk ξj + γp (ȳ − pj )ξj − α(pj − p̂j )]                (3)
                                                      k=1

with the new error in brackets. There are several new components to the error but only (ȳ − pj )ξj
presents an econometric problem. ξj is not correlated with the fitted price, p̂j asymptotically and
   4
     If we allow the interaction term with residual income - (yi − pj ) instead of (y − pj ) - Berry (1994)’s existence and
uniqueness result no longer hold. We are working to extend Gandhi (2009)’s inversion result to this setting. This
also requires us to develop a new contraction to locate δ(σ, τ ) = (δ1,..., δJ ). Once we have done so we can also allow
for random coefficients on both ξ and on the interactions between ξ and the observed characteristics and price. This
work is well beyond the scope of the current paper.



                                                              5
PK
    k=1 γk xjk ξj   is also uncorrelated with p̂j asymptotically as long as the instrument(s) include xj
and they are valid. By construction (pj − p̂j ) is uncorrelated with p̂j .
     The problem arises because p̂j is correlated with ȳ − pj , leading to the possibility that p̂j and
γp (ȳ − pj )ξj are correlated conditional on xj . The sign of the bias depends on the sign of γp and the
sign of the conditional correlation of p̂j and (ȳ − pj )ξj . In the Berry, Levinsohn, and Pakes (1995)
automobile data our estimate of γp is negative and the standard IV estimate is biased down, which
would imply a negative correlation between p̂j and (ȳ − pj )ξj conditional on xj .
3      Conditional Moment Restrictions Alone Insufficient for Identifi-
       cation
     We consider identification using the Berry, Levinsohn, and Pakes (1995) (BLP) conditional
moment restrictions (CMR). We collect the model parameters into θ = (c, β 0 , α, γ 0 , γp )0 and denote
its true value by θ0 . A set of instruments zj is presumed to exist such that

                                                     E[ξj (θ0 )|zj ] = 0.

We follow BLP and assume zj includes all observed product characteristics and income. Letting
ξj = ξj (θ0 ), the CMR restriction leads to the moments BLP use for identification, given as


                                  E[ξj |zj ] = E[δj − (c0 + β00 xj − α0 pj )|zj ] = 0.

xj and the intercept are included in zj and thus are valid instruments for themselves. If a valid
instrument for price exists then E[pj |zj ] can replace pj and all parameters are identified.
     Once we generalize the model to the non-separable setting the same CMR leads to the moments

                    E[ξj |zj ] = E[δj − (c0 + β00 xj − α0 pj + ξj (γ00 xj + γp0 (ȳ − pj )))|zj ] = 0.     (4)

xj and pj can be treated as in the separable case, and since xj and ȳ are in the conditioning set
E[xj ξj |zj ] = xj E[ξj |zj ] = 0 and E[ȳξj |zj ] = ȳE[ξj |zj ] = 0. However, pj is not generally known
given zj , so E[pj ξj |zj ] 6= pj E[ξj |zj ], and the CMR alone fails to identify any of the parameters.
     (4) is an example of simple nonseparable setting that illustrates a more general point regarding
non-separable errors and the failure of identification using CMRs (see Blundell and Powell (2003)
and Hahn and Ridder (2008)). We have valid conditional moment restrictions and our setting is one
where we can explicitly solve for ξ for any candidate value of θ. However, these together are not be
sufficient for identification. One can see this by solving for ξj as a function of the other arguments
and expressing the CMR as

                                                 δj − c0 − β00 xj + α0 pj
                                                                               
                                  E[ξj |zj ] = E                             |zj = 0.
                                                 1 + γ00 xj + γp0 (ȳ − pj )

These moment conditions are satisfied for multiple values of the parameters (e.g. any γk0 = ∞)


                                                              6
and thus do not identify the model parameters.
    One approach is to add further restrictions that allow the practitioner to calculate and thus
control for E[pj ξj |zj ]. However, calculating the value of this expectation with ξj unknown is virtu-
ally impossible without fully specifying how pj is determined in equilibrium. Researchers may be
reluctant to do so because pj may be a function of all observed and unobserved characteristics of
vehicles in the market, in addition to other cost and demand shifters. An advantage of our solution
is that we will add controls to the conditioning set zj such that price will be known, so we avoid
the problem of having to resolve this exact relationship between pj and ξj conditional on zj .
4    Adding Moments with Control Functions
    We add new moment conditions to the CMRs to solve this non-uniqueness problem. We develop
a control function that has as arguments new controls and zj which together condition out the
correlation between the demand error ξj and price. For identification the control function must not
have arguments that are perfectly collinear with (xj , pj ). The CMR conditions from BLP put shape
restrictions on the control function that ensure this collinearity does not occur.
    A major advantage of our approach is that our moments require nothing beyond the standard
conditions for identification with valid instruments. Specifically, just as in Berry (1994) and Berry,
Levinsohn, and Pakes (1995) we require no new instruments beyond those from their setup, and we
only require - as they do - that the instruments shift price around while being excluded from the
utility function.
    Each product j may have its own set of controls that we denote Vj . The control function is the
conditional expectation of the error given zj and Vj , which we write as

                                         f (zj , Vj ) = E[ξj |zj , Vj ].

It is well-defined and (almost surely) unique as long as the unconditional expectation E[ξj ] exists.
    Vj must satisfy the next condition in order to address the endogeneity problem.
Condition 1. (CF) Any bounded function of (zj , pj ) is uncorrelated with ξj given f (zj , Vj ).

    While Vj = pj would trivially satisfy this condition, if we include prices in Vj we will not be
identified because the controls will leave no variation to identify α0 . We look for controls Vj 6= pj
such that the control function f (zj , Vj ) removes the dependence between pj and ξj and leaves some
remaining (causal) variation of pj .
    In order to resolve the difficulty associated with E[pj ξj |zj ] 6= pj E[ξj |zj ], we require that pj is
known conditional on (zj , Vj ), which allows us to write E[pj ξj |zj , Vj ] = pj E[ξj |zj , Vj ] and leads
to the CF condition being satisfied.

Theorem 1. If there exists control(s) Vj such that pj is known conditional on (zj , Vj ), then the
condition CF is satisfied.

Proof. For any bounded function of (zj , pj ), say h(zj , pj ), we have E[h(zj , pj )(ξj − f (zj , Vj ))] = 0


                                                       7
due to the law of iterated expectation, because E[h(zj , pj )(ξj − f (zj , Vj ))|zj , Vj ] = h(zj , pj )E[ξj −
f (zj , Vj )|zj , Vj ] = 0 because pj is known given (zj , Vj ) and f (zj , Vj ) = E[ξj |zj , Vj ].


    We propose two variants of controls that both satisfy the CF condition. Here we discuss using

                             Vj    = pj − E[pj |zj ] = pj − Π(zj ), j = 1, . . . , J,                        (5)

with Π(zj ) ≡ E[pj |zj ], the expected value of pj given zj . In subsection 4.3 we consider an idea
proposed in Matzkin (2003) as an alternative way to generate Vj . The controls for good j are then
given by Vj = gj (V1 , . . . , VJ ), for some known (vector) function gj (·) of (V1 , . . . , VJ ) chosen by the
researcher. Vj satisfies the CF condition by Theorem 1 as long as Vj is an element of Vj . In
the simplest case Vj = Vj , which is sufficient for identification and consistency. However, since
f (zj , Vj ) is a new regressor in our setup, for efficiency purposes one may want to include Vk k 6= j
as they may also “explain” ξj , leading to more variation in f (zj , Vj ).
    Having determined Vj = gj (V1 , . . . , VJ ), we can then exploit the moment condition:

             0 = E [δj − {c0 + β0 xj − α0 pj + f (zj , Vj )(1 + γ0 xj + γp0 (ȳ − pj ))}|zj , Vj ] ,         (6)

where without loss of generality we let xj be scalar. Letting ξej = (1 + γxj + γp (ȳ − pj )) ξj we now
obtain

                E[ξej |z, Vj ] = E[ξj |zj , Vj ] + γE[xj ξj |zj , Vj ] + γp E[(ȳ − pj )ξj |zj , Vj ]
                               = E[ξj |zj , Vj ](1 + γxj + γp (ȳ − pj ))
                               = f (zj , Vj )(1 + γxj + γp (ȳ − pj )),

because xj ∈ zj and pj is also known conditional on zj and Vj . The choice of the control function
coupled with (6) thus allows us to circumvent the problem of specifying the exact relationship
between pj and ξj .
    The structural parameters would all be identified from (6) if no linear functional relationship
existed between 1, xj , pj , f (zj , Vj ), f (zj , Vj )xj , and f (zj , Vj )(ȳ − pj ). However, f (zj , Vj ) may
contain linear functions of xj or be collinear with pj , in which case one will not be able to separate
the coefficients (c0 , β0 , α0 ) from the function f (zj , Vj ). We reintroduce the conditional moment
restrictions to rule out this possible collinearity.

Condition 2 (CMR). E[ξj |zj ] = 0.

    The CMR condition imposes

                            0 = E[ξj |zj ] = E[E[ξj |zj , Vj ]|zj ] = E[f (zj , Vj )|zj ].

CMR imposes that the mean of f (zj , Vj ) is equal to zero for any value of zj . Thus while f (zj , Vj )


                                                          8
can depend on a function of Vj and its interaction with zj , it cannot be an additive function of zj
only, so functions of xj only are also ruled out. Also, since Vj 6= pj , as long as zj includes a variable
not included in xj , f (zj , Vj ) will not be perfectly collinear with (xj , pj ) because f (zj , Vj ) cannot
be an additive function of zj . Thus the generalized control function moments combined with the
implied shape restrictions from CMR on f (zj , Vj ) will suffice for identification of the structural
parameters θ0 . Section 4.1 provides a simple example and Section 5 proves identification formally.
    Together CF and CMR can be written as a set of moment conditions

                 0 = E δj − {c0 + β00 xj − α0 pj + f (zj , Vj )(1 + γ00 xj + γp0 (ȳ − pj ))}|zj , Vj
                                                                                                     
                                                                                                                                  (7)

with f (zj , Vj ) restricted to satisfy
                                                     E[f (zj , Vj )|zj ] = 0.                                                     (8)

We use a multi-step least squares estimator based on the moment conditions from (7) and (8) to
estimate θ0 and the nonparametric function f (zj , Vj ), which we approximate with sieves. In the
first-step we obtain consistent estimates of Vj = gj (V1 , . . . , VJ ) using a consistent estimator for
Π(zj ) j = 1, . . . , J and Vj = pj − Π(zj ). In the second step we construct the approximation of
f (zj , Vj ) that it satisfies (8). For example, we can approximate f (zj , Vj ) as

                 ∞
                 X                                           X∞                 X
f (zj , Vj ) =           πl1 ,0 (ϕl1 (Vj )−E[ϕl1 (Vj )|zj ])+                                    πl1 ,l2 φl2 (zj )(ϕl1 (Vj )−E[ϕl1 (Vj )|zj ])
                 l1 =1                                          l=2 l1 ≥1,l2 ≥1 s.t. l1 +l2 =l


where ϕl1 (Vj ) and φl2 (zj ) denote approximating functions of Vj and zj (e.g., tensor products
polynomials or splines), with plug-in consistent estimates of E[ϕl1 (Vj )|zj ]. In the final step we
estimate θ0 and f (zj , Vj ) simultaneously using non-linear least squares.5 Kim and Petrin (2010c)
provide conditions for the consistency and the asymptotic normality of the general sieve multi-step
estimator.



4.1     Example
    While our general approach allows f (zj , Vj ) to come from any class of functions that can be
consistently approximated by sieves, here we consider a simple example to illustrate how the CMR
restriction yields identification. For some parameter values π = (π0 , π10 , π2 , π30 )0 we assume f (zj , Vj )
can be written as
                                        f (zj , Vj ) = π0 + π10 zj + π2 Vj + π30 zj Vj
    5
      Alternatively
                P∞ one can estimatePthe        model parameters in two steps using the unconstrained approximation
˜                                          ∞ P
f (zj , Vj ) =    l1 =1 πl1 ,0 ϕl1 (Vj ) + l=2  l1 ≥1,l2 ≥1 s.t. l1 +l2 =l πl1 ,l2 φl2 (zj )ϕl1 (Vj ). If one wanted an estimate of
f (zj , Vj ) one would use a standard estimator to approximate E[f˜(zj , Vj )|zj ] and then calculate

                                           f (zj , Vj ) = f˜(zj , Vj ) − E[f˜(zj , Vj )|zj ].




                                                                   9
with zj = (xj , z2j )0 . Letting π30 zj = π31 xj + π32 z2j the CMR in this case implies

        f (zj , Vj ) = f (zj , Vj ) − E[f (zj , Vj )|zj ]                                                                            (9)
                      = (π0 +      π10 zj   + π2 Vj +      π30 zj   Vj ) − (π0 +   π10 zj   + π2 E[Vj |zj ] +   π30 zj E[Vj |zj ])
                      = π2 Vj +        π30 zj   Vj ,

because Vj = pj − Π(zj ) so E[Vj |zj ] = 0. Thus f (zj , Vj ) is a function of Vj and its interaction with
zj , but conditional on these terms is not an additive function of pj nor zj alone.
    Identification follows from plugging (9) in (7) and rearranging to obtain

0 = E[δj − {c0 + β0 xj − α0 pj + π2 Vj + (π2 γ0 + π31 )xj Vj + π2 γp0 Vj (ȳ − pj )
         +π31 γ0 x2j Vj + π31 γp0 xj Vj (ȳ − pj ) + π32 z2j Vj + π32 γ0 z2j xj Vj + π32 γp0 z2j Vj (ȳ − pj )}|zj , Vj ].

The unconstrained regression of δj on 1, xj , pj , Vj , xj Vj , Vj (ȳ −pj ), x2j Vj , xj Vj (ȳ −pj ), z2j Vj , z2j xj Vj ,
and z2j Vj (ȳ −pj ) then identifies the coefficients (c0 , β0 , α0 , π2 ) and the composite coefficients (π2 γ0 +
π31 , π2 γp0 , π31 γ0 , π31 γp0 , π32 , π32 γ0 , π32 γp0 ) unless the regressors are “multicollinear”. (γ0 , γp0 , π31 , π32 )
are then identified by the composite coefficients.
4.2     Identification and Higher-order CMRs
    If γp 6= 0 then the higher order moments of ξj conditional on zj do not help with identifica-
tion. The problem is the same as that encountered with the conditional mean, where moment
conditions are satisfied for multiple values of the parameters. For example, consider the conditional
homoskedasticity assumption where E[ξj2 |zj ] = σ 2 . Rewritten we have

                                               δj − c0 − β00 xj + α0 pj 2
                                                                               
                         E[ξj2 |zj ]        2
                                       −σ =E (                             ) |zj − σ 2 = 0,
                                               1 + γ00 xj + γp0 (ȳ − pj )
which is satisfied for any γk0 = ∞ and σ = 0.
    If γp = 0 then only exogenous variables interact with the demand error. The conditional moment
restrictions E[ξj |zj ] = 0 are sufficient to identify (c0 , β0 , α0 ) because the CMR implies

                                  K
                                  X
                        E[ξj +           γk xjk ξj | zj ] = E[δj − (c0 + β00 xj − α0 pj )|zj ] = 0.
                                  k=1


Given (c0 , β0 , α0 ), the entire multiplicative heteroskedastic error ξ˜j = ξj + K
                                                                                 P
                                                                                  k=1 γk xjk ξj is identified.
    ˜
The ξj can be used with a higher-order moment restriction on ξj conditional on zj to identify γ.
    We illustrate assuming conditional homoskedasticity holds and (without loss of generality) there
is only one exogenous characteristic, so the entire identified error is ξ˜j = ξj (1 + γxj ). Taking the
conditional expectation of this squared error yields

                                            E[ξ˜j2 |zj ] = σ 2 + 2σ 2 γxj + σ 2 γ 2 x2j .



                                                                     10
If we consider the regression model

                                              ξ˜j2 = π0 + π1 xj + π2 x2j + ηj

with E[ηj |zj ] = 0 by construction, then γ is overidentified because γ 2 = π2 /π0 and γ = π1 /2π0 .
4.3     Matzkin (2003) Controls
    We can also use the controls proposed in Matzkin (2003), as done in Florens, Heckman, Meghir,
and Vytlacil (2008) and Imbens and Newey (2003). Assuming pj is continuous, we can always
rewrite pj as a function of zj and a continuous single error term Ṽj - pj = h̃(zj , Ṽj ) - such that Ṽj
is independent of zj and h̃(zj , Ṽj ) is increasing in Ṽj .6 Normalizing Ṽj to be uniform over the unit
interval [0, 1] we obtain the new control

                                                    Ṽj = Fpj |zj (pj |zj )

where Fpj |zj denotes the conditional cumulative distribution function of pj given zj . The con-
trol Ṽj satisfies the requirement in Theorem 1 because conditional on (zj , Ṽj ), pj is known, given
as pj = Fp−1
          j |zj
                (Ṽj |zj ) ≡ h̃(zj , Ṽj ). One can then proceed as described above constructing Ṽj =
g̃j (Ṽ1 , . . . , ṼJ ). Identification also holds for Ṽj (see Kim and Petrin (2010c) for the latter case).
4.4     Alternative Approaches
    We are aware of three other approaches that allow for some form of non-separable demands with
endogenous prices in discrete choice settings. Bajari and Benkard (2005) and Kim and Petrin (2010a)
use the structure from Imbens and Newey (2009) and place restrictions on demand and supply such
that it is possible to invert out from the pricing equations the demand errors. Once the demand
errors have been recovered from the inversion, they can enter utility in any non-separable fashion
that the practitioner desires because the variable is now observed. The tradeoff is that they require
the controls (V1 , . . . , VJ ) to be one-to-one with ξ = (ξ1 , . . . , ξJ ) conditional on Z = (z1 , . . . , zJ ), and
they also need full independence of ξ and Z, two important features of the econometric setup from
Imbens and Newey (2009). We require neither assumption but our non-separable setup is not fully
general.
    In the case where a special type of characteristic exists, Berry and Haile (2010) show how to
use it in conjunction with conditional moment restrictions to achieve identification in differentiated
                                                                                                  (1)
products models with market level data. This special characteristic - call it xj                        - must be perfectly
substitutable with ξj , and the coefficient on the special characteristic must be known.7 The approach
                                                                              (1)         (2)
allows for non-parametric identification in the variables ((xj + ξj ), xj , pj ).
    We show how in our parametric setup from (2) identification using the CMRs is achieved when
this special characteristic exists. Substituting in the special characteristic to the mean utility we
   6
     This does not imply that pj and ξj are independent given Ṽj nor that pj and ξj are independent given (Ṽ1 , . . . , ṼJ )
even if ξj is independent of zj .
   7
     This characteristic is related to but not the same as the special regressor from Lewbel (2000).




                                                              11
have
                           (1)      (2)0 (2)                         (2)    (1)                           (1)
              δj = c0 + xj + β0 xj − α0 pj + ξj + γ00 xj (xj + ξj ) + γp0 (ȳ − pj )(xj + ξj ),
                                               (2)
with the other regressors given as xj                and where for transparency we suppress interactions between
 (2)
xj      and (ȳ − pj ). Solving for ξj and taking expectations conditional on zj , we obtain

                                                                                 (2)0 (2)
                                                   (1)          δj − c0 − β0 xj + α0 pj
                             0 = E[ξj |zj ] =    −xj     + E[              (2)
                                                                                              |zj ],
                                                                1 + γ00 xj + γp0 (ȳ − pj )

                                                             (1)
so this setup rules out any γk0 = ±∞ unless xj                     = 0. Note that if we did not know the coefficient
on the special characteristic we would have to estimate it and the moment condition would become

                                                                                   (2)0 (2)
                                                 (1) (1)           δj − c0 − β0 xj + α0 pj
                           0 = E[ξj |zj ] =    −β0 xj      + E[              (2)
                                                                                                 |zj ],
                                                                   1 + γ00 xj + γp0 (ȳ − pj )

                              (1)
which is satisfied for β0 = 0 and any γk0 = ±∞ , leading to failure of identification.
5        Identification
        In this section we show global identification for the model with µij = 0. In the next section we
provide conditions under which our sieve estimator is consistent. In the appendix we provide the
consistency proof for the random coefficients setup with µij 6= 0.
        We study identification using the moment conditions (7) and (8). We use controls Vj that both
satisfy the CF condition and are possibly a function of (pj − Π(zj )) for j = 1, . . . , J. We write this
function Vj = gj (p1 − Π(z1 ), . . . , pJ − Π(zJ )) = gj (V1 , . . . , VJ ).8 Vj is identified from the first step
regression of (5), and we treat Π(zj ) and Vj as known throughout the discussion.9
    If θ0 and f0 (zj , Vj ) are identified they must be the unique solution to (7) and (8). E [δj |zj , Vj ]
is unique with probability one, which implies if there exists any other function θ̄ and f¯(zj , Vj ) that
satisfies (7) and (8) it must be that

Pr{c0 +β00 xj −α0 pj +f0 (zj , Vj )(1+γ00 xj +γp0 (ȳ−pj )) = c̄+β̄ 0 xj −ᾱpj +f¯(zj , Vj )(1+γ̄ 0 xj +γ̄p (ȳ−pj ))} = 1.
                                                                                                 (10)
                                                                         ¯
Therefore, identification means we must have θ0 = θ̄ and f0 (zj , Vj ) = f (zj , Vj ) with probability
one whenever (10) holds.
        Our proof uses the unconstrained version of the moment condition (7)

          0 = E δj − {c0 + β00 xj − α0 pj + f0 (zj , Vj ) + fx (zj , Vj )0 xj + fp (zj , Vj )(ȳ − pj )}|zj , Vj
                                                                                                                

    8
     It is possible to modify this proof to allow for more general Vj as defined in Matzkin (2003) (see Kim and Petrin
(2010c)).
   9
     While we proceed assuming price pj is endogenous this is not necessary. We can allow for settings where the
practitioner does not know whether the variable is exogenous or endogenous (see Kim and Petrin (2010b)).




                                                                12
from which we will show (c0 , β0 , α0 ), f0 (zj , Vj ), fx (zj , Vj ) = γ0 f0 (zj , Vj ), and fp (zj , Vj ) =
γp0 f0 (zj , Vj ) are identified, and thus so are (γ0 , γp0 ). Working with differences κ(zj , Vj ) = f0 (zj , Vj )−
f¯(zj , Vj ), κx (zj , Vj ) = fx (zj , Vj )− f¯x (zj , Vj ), and κp (zj , Vj ) = fp (zj , Vj )− f¯p (zj , Vj ) we can write
(10) as

             Pr{ψ0 + ψ10 xj + ψ2 pj + κ(zj , Vj ) + κ0x (zj , Vj )xj + κp (zj , Vj )(ȳ − pj ) = 0} = 1.           (11)

If (11) holds, for identification we must have ψ0 = 0, ψ1 = 0, ψ2 = 0, κ(zj , Vj ) = 0, κx (zj , Vj ) = 0,
and κp (zj , Vj ) = 0 with probability one. We formalize this identification statement in Theorem 2.
Theorem 2 (Identification). Let

           Ψ(xj , pj , ·; ψ) = ψ0 + ψ10 xj + ψ2 pj + κ(zj , Vj ) + κ0x (zj , Vj )xj + κp (zj , Vj )(ȳ − pj ),

and assume the CF condition holds. If (xj , pj ) and (zj , Vj ) do not have a functional relationship of
the form
                          Pr {Ψ(xj , pj , κ(zj , Vj ), κx (zj , Vj ), κp (zj , Vj ); ψ) = 0} = 1                   (12)

then the structural parameters θ0 = (c0 , β00 , α0 , γ00 , γp0 )0 are identified.

Proof. The CF condition allows one to move from equation (2) to equation (7) (and thus to equation
(12)). If there exists an additive functional relationship between 1, xj , pj , κ(zj , Vj ), xj1 κx1 (zj , Vj ),
. . ., xjK κxK (zj , Vj ), and (ȳ − pj )κp (zj , Vj ) then (12) must be satisfied. The contrapositive proves
the statement.

       We now use Theorem 2 to show global identification when Π(zj ) and f (zj , Vj ) are differentiable.
Let zj = (x0j , z2j
                 0 )0 and let subscripts with (2), (p ), and (v ) denote partial differentiation with
                                                     j         j
respect to z2j , pj , and Vj . The proof uses differentiability and completeness (from Newey and
Powell (2003)) to show that equation (12) implies κ(zj , Vj ) is only a function of (pj , xj ). Writing
κ(zj , Vj ) = κ̃(pj , xj ) and using the CMR implies E[κ(zj , Vj )|zj ] = E[κ̃(pj , xj )|zj ] = 0. The
completeness condition then implies κ(zj , Vj ) = κ̃(pj , xj ) = 0 almost surely. The same logic yields
κx (zj , Vj ) = 0 a.s., κp (zj , Vj ) = 0 a.s., and (ψ0 , ψ1 , ψ2 ) = 0.10

Theorem 3. Assume Π(zj ) and f (zj , Vj ) are differentiable and the one-sided derivatives are con-
tinuous at the boundary of the support of (zj , Vj ). Assume the CF and CMR conditions hold. If
for all functions B(pj , xj ) with finite expectation, E[B(pj , xj )|zj ] = 0 a.s. implies B(pj , xj ) = 0 a.s.
(completeness condition), then θ0 is identified.

Proof. Given differentiability, it suffices to consider differentiable κ· (zj , Vj ) where κ· (zj , Vj ) is
generic notation for κ(zj , Vj ), κx (zj , Vj ), or κp (zj , Vj ). Taking derivatives of Ψ(xj , pj , ·; ψ), we
  10
    We also maintain that the one-sided derivatives of Ψ(xj , pj , ·; ψ) are continuous at the boundary of the support
of (zj , Vj ), although instead one may alternatively assume that the boundary of the support of (zj , Vj ) has zero
probability (this may require a trimming device to deal with the boundary of the support in the estimation).




                                                           13
obtain

  Ψ(2) (·; ψ) = Π(2) (zj )(ψ2 − κp (zj , Vj )) + κ(2) (zj , Vj ) + κ0x,(2) (zj , Vj )xj + κp,(2) (zj , Vj )(ȳ − pj )
 Ψ(vj ) (·; ψ) = ψ2 − κp (zj , Vj ) + κ(vj ) (zj , Vj ) + κ0x,(vj ) (zj , Vj )xj + κp,(vj ) (zj , Vj )(ȳ − pj ).

If there is an additive functional relationship then Ψ(·; ψ) = 0 with probability one, and also

                                             Ψ(2) (·; ψ) = 0 and Ψ(vj ) (·; ψ) = 0.

    Premultiplying Ψ(vj ) (·; ψ) by Π(2) (zj ) and combining Ψ(2) (·; ψ) = 0 and Π(2) (zj )×Ψ(vj ) (·; ψ) = 0,
we obtain

                    Π(2) (zj ){κ(vj ) (zj , Vj ) + κ0x,(vj ) (zj , Vj )xj + κp,(vj ) (zj , Vj )(ȳ − pj ) − κp (zj , Vj )}   (13)
            = κ(2) (zj , Vj ) + κ0x,(2) (zj , Vj )xj + κp,(2) (zj , Vj )(ȳ − pj ) − Π(2) (zj )κp (zj , Vj ).

Letting
                                 η(·) = κ(zj , Vj ) + κ0x (zj , Vj )xj + κp (zj , Vj )(ȳ − pj )
            ∂η(·)
we have     ∂z2j     equal to the right hand side of equation (13). Vj = gj (p1 − Π(z1 ), . . . , pJ − Π(zJ ))
      ∂Vj
and   ∂pj   = 1 imply
                                               κ·,(vj ) (zj , Vj ) = κ·,(pj ) (zj , Vj ),

Using (13) it follows that

      ∂η(·)
               = Π(2) (zj ){κ(pj ) (zj , Vj ) + κ0x,(pj ) (zj , Vj )xj + κp,(pj ) (zj , Vj )(ȳ − pj ) − κp (zj , Vj )}
      ∂z2j
                       ∂pj ∂η(·)   ∂η(·) ∂pj
               =                 =
                       ∂z2j ∂pj     ∂pj ∂z2j

implying (a) z2j affects η(·) and thus κ· (zj , Vj ) only through pj . We also know that for all j 0 6= j,
κ· (zj , Vj ) is not a function of z2j 0 , so

                                 ∂κ· (zj , Vj )/∂z2j 0 = Π(2) (zj 0 )κ·,(vj 0 ) (zj , Vj ) = 0.

Completeness implies the full rank of Π(2) (zj 0 ), which then implies that κ·,(vj 0 ) (zj , Vj ) = 0 for all
j 0 6= j so (b) κ· (zj , Vj ) is not a function of Vj 0 for j 0 6= j. Combining these two findings (a) and
(b), we conclude

                                     κ· (zj , Vj ) = κ· (zj , Vj ) = κ· (zj , pj − Π(zj ))
                                                     = κ̃· (pj , zj ) = κ̃· (pj , xj )

for some function κ̃· (·), where the first equality holds by (b) and the last equality holds by (a).
    The CMR condition then implies E[κ· (zj , Vj )|zj ] = E[κ̃· (pj , xj )|zj ] = 0 and from the complete-


                                                                  14
ness condition, it follows that 0 = κ̃· (pj , xj ) = κ· (zj , Vj ) with probability one. η(·) = 0 coupled with
Ψ(·; ψ) = 0 implies ψ0 + ψ10 xj + ψ2 pj = 0. In the special case where we condition on zj , we obtain
E[ψ0 + ψ10 xj + ψ2 pj |zj ] = 0. Full rank of Π(2) (zj ) implies ψ0 = 0, ψ1 = 0, and ψ2 = 0.11 Therefore,
ψ0 = 0, ψ1 = 0, ψ2 = 0, κ(zj , Vj ) = 0, κx (zj , Vj ) = 0, and κp (zj , Vj ) = 0 with probability one.
This completes the proof.


         A simple example for a non-linear parametric setup may help to illustrate the mechanism of
identification. Consider the model

                                           δj = c0 − α0 pj + ξj + γp0 ξj (ȳ − pj )

with E[ξj |zj , Vj ] = π0 Vj . Then one can use the unconstrained moment given by E[δj − (c0 −
α0 pj + π0 Vj + γp0 π0 Vj (ȳ − pj ))|zj , Vj ] = 0 for identification. Specifically, c0 , α0 , %0 ≡ γp0 π0 , and
π0 are globally identified from unconstrained least squares by the uniqueness of the conditional
expectation as long as 1, pj , Vj , and Vj (ȳ − pj ) do not have a linear relationship. γp0 is also identified
from γp0 = %0 /π0 as long as π0 6= 0. The theorem shows that for this non-linear model the global
identification condition coincides with the local identification condition for parametric non-linear
models given in Rothenberg (1971), which says the vector of derivatives with respect to parameters
must not be collinear.12
         We can also generalize the identification result to more flexible specifications of utility. Consider
mean utility
                                         δj = h1 (xj , pj ) + ξj (1 + h2 (xj , ȳ − pj ))

where h1 (xj , pj ) and h2 (xj , ȳ − pj ) are nonparametric, and we normalize h2 (x̃j , ȳ − p̃j ) = c for some
known constant c at some (x̃j , p̃j ).

Theorem 4 (Nonparametric Identification with CMR). Assume Π(zj ), h1 (xj , pj ), h2 (xj , ȳ − pj ),
and f (zj , Vj ) are differentiable and the one-sided derivatives are continuous at the boundary of the
support of (zj , Vj ). Assume the CF and CMR conditions hold. If for all functions B(pj , xj ) with
finite expectation, E[B(pj , xj )|zj ] = 0 a.s. implies B(pj , xj ) = 0 a.s., then (h10 (xj , pj ), h20 (xj , ȳ −
pj )) is identified up to a normalization of h2 (x̃j , ȳ − p̃j ) = c for some known constant c at some
(x̃j , p̃j ).

         The proof strategy is essentially the same as the parametric case (see Kim and Petrin (2010c)).



6         Sieve Estimation and Consistency
         We show consistency of our multi-step sieve estimator for the case when µij = 0 (see appendix
    11
     The full rank of Π(2) (zj ) is equivalent to Π(2) (zj ) 6= 0 since pj is scalar.
     In this example the vector of first derivatives w.r.t. (c0 , α0 , γp0 , π0 )0 is given by (1, −pj , π0 Vj (ȳ − pj ), γp0 Vj (ȳ −
    12

pj ) + Vj )0 , and they are not collinear as long as π0 6= 0 and 1, pj , Vj , and Vj (ȳ − pj ) do not have a linear relationship.


                                                                 15
for µij 6= 0). In the first stage we estimate Π(zj ) and obtain V̂j = pj − Π̂(zj ) for j = 1, . . . , J
and construct V̂j = gj (V̂1 , . . . , V̂J ). In the second step, we construct approximating basis functions
using V̂j and zj , where we subtract out conditional means of underlying basis functions (conditional
on zj ) to approximate f (·) that satisfies (8). In the final step we estimate θ0 and f0 (·) using a sieve
method.
    Let F denote a space of functions that includes the true function f0 , endowed with k·kF a
pseudo-metric on F. We first write the infeasible basis functions (and we replace them with their
estimates below) for f (·) when Vj is known as


                                           ϕ̃l (Vj , zj ) = ϕl (Vj , zj ) − ϕ̄l (zj )

where ϕ̄l (zj ) = E[ϕl (Vj , zj )|zj ] and {ϕl (Vj , zj ), l = 1, 2, . . .} denotes a sequence of approximating
basis functions of (Vj , zj ) such as power series or splines. By subtracting out the conditional means
from the underlying basis functions, we let any function f (·) in the sieve space defined below satisfy
the requirement (8).
    Let J = M
            P
              m=1 Jm be the sample size where Jm denotes the number products in market m and
M denotes the number of markets and define the (infeasible) sieve space FJ as the collection of
functions
                                                       X
                                  FJ = {f : f =               al ϕ̃l (Vj , zj ), kf kF < C̄}
                                                     l≤L(J)

for some bounded positive constant C̄ and coefficients (a1, . . . , aL(J) ), with L(J) → ∞ and L(J)/J →
0 such that FJ ⊆ FJ+1 ⊆ . . . ⊆ F, so we use more flexible approximations as the sample size grows.
      We then replace the sequence of the infeasible basis functions ϕ̃l (Vj , zj ) with their estimates as
ˆ
ϕ̃l (V̂j , zj ) = ϕl (V̂j , zj ) − ϕ̄ˆl (zj ). We then define the sieve space constructed using the estimated
basis functions as
                                                         X
                                    F̂J = {f : f =              al ϕ̃ˆl (·, ·), kf kF < C̄}.              (14)
                                                       l≤L(J)

Under weak regularity conditions F̂J → FJ (in the Hausdorff metric defined on the metric space
(F, k·kF )) as Π̂(·) → Π(·) and ϕ̄ˆl (·) → ϕ̄l (·) (in a pseudo-metric k·ks ).
    Denote a sample criterion function QJ (δ, z, p, V̂; θ, f ) for estimation based on the moment con-
dition of (7). If we use nonlinear sieve least squares estimation, then the sample criterion function
becomes
                                 M Jm
                               1 XX
   QJ (δ, z, p, V̂; θ, f ) =          {δmj − (c + β 0 xmj − αpmj + f (·)(1 + γ 0 xmj + γp (ȳm − pmj )))}2
                               J
                                 m=1 j=1


subject to (θ, f ) ∈ Θ × F̂J . We define the corresponding population criterion function as

                              M Jm
                            1 XX
Q0J (δ, z, p, V; θ, f )   =        E[{δmj −(c+β 0 xmj −αpmj +f (zj , Vj )(1+γ 0 xmj +γp (ȳm −pmj )))}2 ].
                            J
                               m=1 j=1



                                                              16
Note that below we do not require Q0J (δ, z, p, V; θ, f ) converges when J → ∞.
    Then we obtain our estimator as

                                  ˆ fˆ) = arginf
                                 (θ,            (θ,f )∈Θ×F̂J QJ (δ, z, p, V̂; θ, f ).                             (15)

We derive the consistency of our estimator under the following assumptions based on the results
in Newey and Powell (2003), Chen, Linton, and van Keilegom (2003), and Chen (2006).13 Here
we abstract from the sampling error in the market shares although we allow for it in the proof
of consistency with random coefficients.14 The following assumptions are commonly imposed and
standard in the sieve estimation literature, so we minimize our discussion.
    We first assume identification (see Section 5):
Assumption 1 (A1). (θ0 , f0 ) ∈ Θ × F is the only (θ, f ) ∈ Θ × F 15 satisfying the moment condition
(7) and (8) and Q0J (δ, z, p, V; θ0 , f0 ) < ∞.

    Next we assume that our extremum estimator solves (15).

Assumption 2 (A2). QJ (δ, z, p, V̂; θ̂, fˆ) ≤ inf(θ,f )∈Θ×F̂J QJ (δ, z, p, V̂; θ, f ) + op (1)

    Denote the true functions of Π(·) and ϕ̄l (·) as Π0 (·) and ϕ̄0l (·), respectively, and assume Π(·)
and ϕ̄l (·) are endowed with a pseudo-metric k·ks . Assumption A3 says that both Π0 (·) and ϕ̄0l (·)
can be approximated by the first stage and the middle stage series approximations. For example,
this is known to be satisfied for power series and splines approximation if Π0 (·)’s and ϕ̄0l (·)’s are
smooth and their derivatives are bounded (e.g., belong to a Hölder class of functions).

Assumption 3 (A3).           Π̂(·) − Π0 (·)       = op (1) and ϕ̄ˆl (·) − ϕ̄0l (·)   s
                                                                                         = op (1) for all l.
                                              s

Assumption 4 (A4). The sieve space FJ satisfies FJ ⊆ FJ+1 ⊆ . . . ⊆ F for all J ≥ 1; and for
any f ∈ F there exists πJ f ∈ FJ such that kf − πJ f kF → 0 as J → ∞.

    We maintain the following continuity conditions, which are easy to show for our objective func-
tion.

Assumption 5 (A5). Q0J (δ, z, p, V; θ, f ) is continuous in (θ, f ) ∈ Θ × F.

Assumption 6 (A6). Q0J (δ, z, p, V; θ, fJ ) is continuous in Π(·) and ϕ̄l (·) uniformly for all (θ, fJ ) ∈
Θ × FJ .

    Next we impose compactness on the sieve space.
  13
     Our problem is different from Newey and Powell (2003)’s Theorem 4.1 because we use estimated regressors
                      ˆl (·)) in the main estimation. Our problem is also different from Chen, Linton, and van Keilegom
(functions, Π̂(·) and ϕ̄
(2003) because we estimate the parametric component (θ0 ) and the nonparametric component (f0 ) simultaneously
in the main estimation.
  14
     See Berry, Levinsohn, and Pakes (1995) and Berry, Linton, and Pakes (2004) for explicit treatments of this
sampling error. The contribution of this sampling error to the variance of the estimator will be negligible when the
market size is large.
  15
     The parameter space does not need to be a product space. We use “ · × ·” for ease of notation throughout the
paper.


                                                            17
Assumption 7 (A7). The parameter space Θ is compact and the sieve space, FJ , is compact under
the pseudo-metric || · ||F .

          A sufficient condition for compactness is that the sieve space be based on power series or splines.
          The last condition we add is that in the neighborhoods of Π0 (·) and ϕ̄0l (·), the difference between
the sample criterion function and the population criterion function is small enough when J is large.
16


Assumption 8 (A8). For all positive sequences J = o(1), we have

                                   sup                          QJ (δ, z, p, V; θ, f ) − Q0J (δ, z, p, V; θ, f ) = op (1)
              (θ,f )∈Θ×FJ ,kΠ−Π0 ks ≤J ,kϕ̄l −ϕ̄0l ks ≤J ∀l


where Vmj = gj (pm1 − Π(zm1 ), . . . , pmJm − Π(zmJm )).

Theorem 5. Suppose Assumptions A1-A8 are satisfied. Then θ̂ →p θ0 .

          See appendix for the proof. Kim and Petrin (2010c) also develop the asymptotic distribution
of θ̂ in the context of the sieve estimation where both Π(·) and ϕ̄l (·) are nonparametrically esti-
mated. The formulas for standard errors of θ̂ developed there can be also used for the parametric
estimation case when the truncated semiparametric model (i.e., with fixed length of sieves) is the
true parametric model.



7          Monte Carlo Evidence
          We demonstrate our estimator’s performance using Monte Carlo studies on simple demand/pricing
models. We first consider the following demand function (i.e., mean utility of one inside good) where
the endogenous price p interacts with the unobserved demand shock ξ:

                                                       q = c − αp + γpξ + ξ.

Before turning to a single product monopolist setting we consider two reduced form pricing equations

                                            [1] p = 2 + Z + (5 + Z 2 + 5Z)ξ + ς
                                            [2] p = Z + (5 + 5Z + ς)ξ.

Here the instrument Z is an observed supply shifter and ς is an unobserved cost shock. In the first
design [1], the instrument and the demand error are not additively separable. In the second design
[2] the demand error is not additively separable from the instrument nor the supply-side error.
     16
     Note that Assumption A8       Pcan be PJeasily    satisfied by applying
                                                                         PM a P proper law of large numbers (e.g., Chebychev’s
weak LLN). Define W̄J = J1 M           m=1
                                                m
                                               j=1 W mj   and  µ̄ W
                                                                  J = J
                                                                       1
                                                                            m=1
                                                                                  Jm
                                                                                  j=1 E[Wmj ] for a random vector Wmj . Then
                                                                           W                                   0
it is not difficult to see that Assumption A8 holds if ||W̄J − µ̄J || = op (1) with Wmj = vec(wmj wmj             ) and wmj =
           0                                         0                               0
(δmj , 1, xmj , pmj , f (zmj , Vmj ), f (zmj , Vmj )xmj , f (zmj , Vmj )(ȳm − pmj )) for all f ∈ FJ such that kΠ − Π0 ks ≤ J
and kϕ̄l − ϕ̄0l ks ≤ J .


                                                                     18
       We generate a simulation data based on these designs with the following distributions: ξ ∼
U[−1/2,1/2] , ς ∼ U[−1/2,1/2] , Z = 2 + 2U[−1/2,1/2] , and they are independent where U[−1/2,1/2] denotes
the uniform distribution supported on [−1/2, 1/2]. Note that in these designs, the control V =
p − E[p|Z] is not independent of Z. We set the true parameter values (c0 , α0 , γ0 ) = (1, 1, 0.5). The
data is generated with the sample sizes: M = 1, 000 and M = 10, 000. We take one reasonable
sample size and one large sample size because we are interested both in a finite sample performance
and the consistency of our proposed estimator.
       In our third design we consider a single product monopolistic pricing model with a demand
function (i.e., mean utility in the logit demand)

                      q(X, p, ξ; c, β, α, γ) = ln s − ln(1 − s) = c + βX − αp + γpξ + ξ and

                                                              exp(q(X, p, ξ; c, β, α, γ))
                                 p = argmaxp (p − mc)
                                                            1 + exp(q(X, p, ξ; c, β, α, γ))
where s is the share of the inside good, X is an observed demand shifter, and we let the marginal cost
be mc = 2+0.5Z2 +(2+2Z2 )ς. In this design we draw a demand shock ξ ∼ U[−1/2,1/2] , a supply-side
shock ς ∼ ξ + U[−1/2,1/2] , X = U[−1/2,1/2] , and an observed supply shifter Z2 = X + 2 + 2U[−1/2,1/2] .
We set the true parameter values (c0 , β0 , α0 , γ0 ) = (−2, 1, 1, 0.5). The data is generated with the
sample sizes: M = 2, 000 and M = 10, 000. We let Z = (X, Z2 )0 .
       We estimate the models using three methods: OLS, 2SLS, and our estimator (CMRCF). Our
estimator is implemented in three steps. First we estimate V̂ = p − (π̂0 + π̂10 Z + π̂20 Z 2 + π̂30 Z 3 ) using
OLS and construct approximating functions Ṽ1 = V̂ , Ṽ2 = V̂ 2 − Ê[V̂ 2 |Z], and others are defined
similarly where Ê[·|Z] is implemented by the OLS estimation on (1, Z, Z 2 , Z 3 ).17 In the last step
we estimate the model parameters using nonlinear least squares:
                                 XM                                   XLM             XLM
 (ĉ, β̂, α̂, γ̂, â) = argmin            {qm − (c + βXm − αpm + γpm (    al Ṽml ) +     al Ṽml )}2 /M
                                    m=1                                              l=1                 l=1

where we let β = 0 in designs [1] and [2].
       For the design [1] we use the controls (Ṽ1 , Z Ṽ1 , Z 2 Ṽ1 ) when M = 1, 000 and use (Ṽ1 , Z Ṽ1 , Z 2 Ṽ1 , Z 3 Ṽ1 , Ṽ2 )
when M = 10, 000. For the design [2] we use (Ṽ1 , Z Ṽ1 , Z 2 Ṽ1 ) with M = 1, 000 and use (Ṽ1 ,
Z Ṽ1 , Z 2 Ṽ1 , Ṽ2 ) with M = 10, 000. Finally we use (Ṽ1 , Z Ṽ1 , Z 2 Ṽ1 ) for the design [3] with both
sample sizes.18
       We report the biases and the RMSE based on 100 repetitions of the estimations: OLS, 2SLS,
and our estimator. The simulation results (Tables I-III) clearly show that OLS is biased in all
designs. 2SLS is also biased. Our estimator is robust regardless of different designs for the price.
       In the designs [1]-[3], 2SLS estimates for the constant term (c) are biased (-69%, 21%, -18%
respectively). In the designs [1]-[3] the 2SLS estimates for the coefficient on the price (α) are
severely biased (38%, 21%, and -16%). The 2SLS estimates for the coefficient on the exogenous
  17
    In the third design Z l = (X l , Z2l )0 for l = 2, 3 with abuse of notation.
  18
    One can choose an optimal set of controls among alternatives based on the cross validation (CV) criterion,
although the validity of CV may be compromised due to the presence of the first and the second step in our estimation.


                                                              19
demand shifter (β) in the design [3] seem not biased.
   From other Monte Carlos (not reported here) we find higher coefficients on ξ in the pricing
equation create larger biases for the 2SLS estimates of c and higher coefficients on the interaction
term Zξ in the pricing equation generate larger biases for the 2SLS estimates of α.


    Table I: Design [1], c0 = 1, α0 = 1, γ0 = 0.5, Controls: Ṽ1 , Z Ṽ1 , Z 2 Ṽ1 , Z 3 Ṽ1 , Ṽ2
                      mean          bias       RMSE        mean          bias           RMSE
                                M = 1, 000                           M = 10, 000
      OLS        c   1.2081       0.2081        0.2119    1.2037        0.2037          0.2040
                α    1.1501       0.1501        0.1503    1.1506        0.1506          0.1506
      2SLS       c   0.3584       -0.6416       0.7461    0.3054       -0.6946          0.7007
                α    1.3634       0.3634        0.3765    1.3752        0.3752          0.3760
    CMRCF        c   1.0118       0.0118        0.0523    1.0024        0.0024          0.0245
                α    0.9982       -0.0018       0.0132    0.9998       -0.0002          0.0058
                γ    0.5063       0.0063        0.1276    0.4975       -0.0025          0.0549
     Table II: Design [2], c0 = 1, α0 = 1, γ0 = 0.5, Controls: Ṽ1 , Z Ṽ1 , Z 2 Ṽ1 , Ṽ2
                      mean          bias       RMSE        mean          bias         RMSE
                                M = 1, 000                           M = 10, 000
      OLS        c   1.3596       0.3596        0.3603    1.3580        0.3580        0.3581
                α    1.1333       0.1333        0.1335    1.1337        0.1337        0.1337
      2SLS       c   1.2038       0.2038        0.2195    1.2062        0.2062        0.2072
                α    1.2117       0.2117        0.2163    1.2096        0.2096        0.2099
    CMRCF        c   1.0097       0.0097        0.0388    1.0018        0.0018        0.0162
                α    0.9960       -0.0040       0.0202    0.9995       -0.0005        0.0083
                γ    0.5089       0.0089        0.1499    0.5014        0.0014        0.0626
    Table III: Design [3], c0 = −2, β0 = 1, α0 = 1, γ0 = 0.5, Controls: Ṽ1 , Z Ṽ1 , Z 2 Ṽ1
                      mean           bias       RMSE        mean           bias           RMSE
                                 M = 2, 000                           M = 10, 000
      OLS        c   -2.7465       -0.7465       0.7469    -2.7484       -0.7484          0.7485
                β     0.9438       -0.0562       0.0777     0.9453       -0.0547          0.0587
                α     0.7496       -0.2504       0.2505     0.7487       -0.2513          0.2513
      2SLS       c   -2.2934       -0.2934       0.3561    -2.3637       -0.3637          0.3778
                β     1.0007       0.0007        0.0673     0.9955       -0.0045          0.0274
                α     0.8617       -0.1383       0.1470     0.8437       -0.1563          0.1583
    CMRCF        c   -1.9316       0.0684        0.2472    -2.0092       -0.0092          0.0978
                β     1.0048       0.0048        0.0735     1.0024        0.0024          0.0261
                α     1.0143       0.0143        0.0600     0.9942       -0.0058          0.0245
                γ     0.4929       -0.0071       0.2274     0.5067        0.0067          0.1464



                                                          20
8          Non-separability in the BLP Automobile Data
          We revisit the original Berry, Levinsohn, and Pakes (1995) automobile data to investigate
whether interaction terms are important for own- and cross-price elasticities. There are 2217
market-level observations on prices, quantities, and characteristics of automobiles sold in the 20
U.S. automobile markets indexed m beginning in 1971 and continuing annually to 1990. We let
Jm denote the number products in market m and include the same characteristics: horsepower-
to-weight, interior space, a/c standard, and miles per dollar. We do not use a supply side model
when we estimate the demand side model so our point estimates only exactly match their estimated
specifications for the cases they examine without the supply side.19
          We decompose utility into three components as in equation (1), with the utility common to all
consumers δmj given as

                                                          4
                                                          X
                     δmj = c + β 0 xmj − αpmj + ξmj +           γk xmjk ξmj + γp (ȳm − pmj )ξmj .
                                                          k=1

When (γ1 , γ2 , γ3 , γ4 , γp ) 6= 0 either characteristics or price are not separable from the demand error.
We parameterize µij (σ) as
                                                              4
                                                              X
                                          µij = σc νic +            σk νik xjk
                                                              k=1

with νi = (νic , νi1 , . . . , νi4 ) mean-zero standard normal and σ = (σc , σ1 , . . . , σ4 ) the standard devia-
tion parameters associated with the taste shocks. The induced vector of tastes for each car j for con-
sumer i is given as µi (σ) = (µi1 (σ), . . . , µiJ (σ)) with density f (µi (σ)). Letting δm = (δm1 , . . . , δmJm )
the market share of product j is then

                                                          eδmj +µij
                                                    Z
                                      smj (δm ) =       J
                                                                      f (µ)dµ,
                                                          m
                                                            eδmk +µik
                                                        P
                                                        k=0


and we approximate this integral with standard simulation techniques.
8.1         Controls
          We use the mean projection residuals for price as the starting point for controls. Following
Berry, Levinsohn, and Pakes (1995) we assume all observed product characteristics are exogenous
and denote these variables for market m as Zm . The mean projection residual is given as an estimate
of
                                          ξ˜mj = pmj − E[ pmj | Zm ].

          There are many instruments so we follow Berry, Levinsohn, and Pakes (1995) and Pakes (1996),
reducing this set to 15 instruments for each good j that we denote z̃mj . These instruments include
     19
    We focus on the demand side for three reasons: it makes the comparison more transparent, most researchers do
not impose a supply side model when estimating demands, and the results are easier to replicate.


                                                         21
j’s product characteristics, the sum of each of the product characteristics across all goods in market
m produced by the same firm producing j, and the sum in market m of each of the product
characteristics across all other firms not producing j. Our first control is then given as

                                         ξ˜mj = pmj − E[ pmj | z̃mj ],

and we estimate the expectation using ordinary least squares.
   The control function in our setup is given as f (zj , Vj ) = E[ξj |zj , Vj ] and for consistency setting
Vj = ξ˜mj is sufficient. However, f (zj , Vj ) is a new regressor in our setting, and more variation
in this regressor can help to improve precision of the parameter estimates. We add two additional
controls that may lead to an increase in the variation of E[ξj |zj , Vj ] . Following the logic used in
refining the instrument set, we use
                                                          X
                                            ξ˜(1)mj =               ξ˜mk
                                                        k6=j,k∈Jf


and
                                                          X
                                              ξ˜(2)mj =          ξ˜mk ,
                                                          k∈J
                                                           / f

where Jf is the set of products produced by the firm that produces the product j. These controls
are respectively the sum of all of the other residuals of the products made by the same firm, given
by ξ˜(1)mj , and the sum of all the residuals of all the products made by other firms, given by ξ˜(2)mj .
   Based on these ξ˜mj , ξ˜(1)mj , and ξ˜(2)mj , we generate the following nine controls that we use for
our estimation:

          V1mj     = ξ˜mj , V2mj = ξ˜mj
                                     2
                                        − E[ξ˜mj
                                              2
                                                 |z̃mj ], V3mj = ξ˜mj
                                                                   3
                                                                      − E[ξ˜mj
                                                                            3
                                                                               |z̃mj ],
          V4mj     = ξ˜(1)mj , V5mj = ξ˜(1)mj
                                        2
                                              − E[ξ˜(1)mj
                                                    2
                                                          |z̃mj ], V6mj = ξ˜(1)mj
                                                                            3
                                                                                  − E[ξ˜(1)mj
                                                                                        3
                                                                                              |z̃mj ],
          V7mj     = ξ˜(2)mj , V8mj = ξ˜(2)mj
                                        2
                                              − E[ξ˜(2)mj
                                                    2
                                                          |z̃mj ], V9mj = ξ˜(2)mj
                                                                            3
                                                                                  − E[ξ˜(2)mj
                                                                                        3
                                                                                              |z̃mj ].

Our model for δmj then becomes

                  δmj = c + β 0 xmj − αpmj + f (z̃mj , V̂mj )(1 + γ 0 xmj + γp (ȳm − pmj )),
                                             P9
where we approximate f (z̃mj , V̂mj ) =         l=1 πl V̂lmj   with parameters π = (π1 , . . . , π9 ) to be esti-
mated.
8.2    Estimation
   Letting θ = (c, β 0 , α, γ 0 , γp )0 we have three sets of parameters to identify given by (σ, θ, π).
Estimation proceeds as in Berry, Levinsohn, and Pakes (1995). Given a value of σ, we use the
contraction mapping to solve for the vector δ̃m (σ) that satisfies s(σ, δ(σ)) = sData . δ̃m (σ) then
becomes the regressand in the non-linear least squares objective function given as



                                                        22
                           M Jm
                         1 XX
QJ (θ(σ), π(σ); σ) = min        {δ̃mj (σ)−(c+β 0 xmj −αpmj +f (z̃mj , V̂mj )(1+γ 0 xmj +γp (ȳm −pmj )))}2
                     θ,π J
                                 m=1 j=1

             PM                                   P9
with J =       m=1 Jm    and f (z̃mj , V̂mj ) =     l=1 πl V̂lmj .   This procedure is used iteratively to minimize
QJ (θ(σ), π(σ); σ) over σ, yielding parameter estimates (σ̂, θ̂, π̂) = (σ̂, θ̂(σ̂), π̂(σ̂)) such that σ̂ =
argminσ QJ (θ(σ), π(σ); σ) .
8.3       Results
       The first three columns of Table 1 report results for different specifications in the case where
µij = 0, so the dependent variable is δmj = ln(smj ) − ln(sm0 ), where smj and sm0 denote respectively
the observed market shares in market m for good j and for the outside good. Column 4 reports
results with µij 6= 0, with the market vector δm then recovered from matching observed to predicted
market shares conditional on all parameters not entering into mean utility. Table 2 reports the
implied demand elasticities.
       The results for the separable error and exogenous price case are in Column 1 of Table 1 and
they replicate those results from the first column of Table III in BLP. The price coefficient increases
from -0.088 to -0.136 when we move from OLS to 2SLS, suggesting prices are endogenous, as noted
in Berry, Levinsohn, and Pakes (1995).20
       Column 3 includes our CMRCF results where we do not impose (γ, γp ) = 0. The additively
separable specification is rejected at 5% as the p-value for H0 :(γ0 , γp0 ) = 0 is 0.019, although no
single interaction term is significant on its own. The point estimate on the interaction term for price
is negative but not significant, and thus only suggestive that the marginal utility of income declines
as the demand error increases.
       Most relevant for estimates of price elasticities is the bias in the 2SLS price coefficient estimate
induced by the correlation between the instrumented price and the interaction term in the error.
The price coefficient α increases from -0.136 to -0.232 and is also significantly different from the
coefficient from 2SLS. The sign of the bias coupled with a negative estimate for the interaction term
on price suggests that there is positive correlation between −p̂j and (ȳ − pj )ξj conditional on xj in
the automobile data.
       Column 4 allows for random coefficients in the non-separable specification. Horsepower/weight
and miles-per-dollar have significant σk0 s, but with the exception of the point estimate for βk on
Horsepower/weight, all of the other point estimates from Column 3 are largely the same. The
  20
     While it does not change the substance of either their findings or our findings, we were not able to exactly
replicate the results for their 2SLS estimator using the optimal instruments described in their paper. We find a price
coefficient that is somewhat smaller than their original reported finding of -0.21. While we can only speculate as to
the source of the difference, we suspect it lies in the instruments they used for these results, as we are able to replicate
the OLS point estimates and standard deviations in their paper. Also consistent with this hypothesis is the fact that
our estimate of -0.13 falls well within +/- two standard deviations of their estimate, as their standard deviation was
-0.12. The significantly smaller standard deviation on our price coefficient also suggests the instruments they used
for that specification - whatever they might of been - were not nearly as “optimal” as the instruments they propose
in the paper, for which we find a much smaller standard deviation on the price coefficient.


                                                            23
                       Table 1: Estimated Parameters for Automobile Demand
     No Correction, 2SLS, CMRCF (w/ Interactions), RandomCoefficient-CMRCF (w/ Interactions)
                                     Dependent Variable is δbmj
                                          No              2SLS         CMRCF      RC-CMRCF
 Parameter             Variable            Correction∗      (No Interactions)      (w/ Interactions)      (w/Interactions)
 Term on Price         price                      -0.088                -0.136                 -0.232                 -0.233
                                                 (0.004)               (0.011)                (0.019)                (0.019)
 Mean                  Constant                  -10.071                -9.915                 -9.661                 -9.332
 Parameters                                      (0.252)               (0.263)                (0.290)                (0.317)
                       HP/Weight                  -0.122                 1.226                  2.813                  1.019
                                                 (0.277)               (0.404)                (0.527)                (1.074)
                       Air                        -0.034                 0.486                  1.384                  1.410
                                                 (0.072)               (0.133)                (0.179)                (0.186)
                       MP$                         0.265                 0.172                  0.104                  0.121
                                                 (0.043)               (0.049)                (0.054)                (0.056)
                       Size                        2.342                 2.292                  2.365                  2.409
                                                 (0.125)               (0.129)                (0.140)                (0.148)
 Interaction           (ȳ-price)·ξ                                                            -0.043                 -0.042
 Parameters                                                                                   (0.041)                (0.044)
                       HP/Weight·ξ                                                              1.158                  1.258
                                                                                              (1.809)                (2.071)
                       Air·ξ                                                                    0.514                  0.627
                                                                                              (0.636)                (0.814)
                       MP$·ξ                                                                   -0.096                 -0.145
                                                                                              (0.116)                (0.153)
                       Size·ξ                                                                   0.262                  0.368
                                                                                              (0.728)                (0.993)
 Std. Deviations       Constant                                                                              0.042   (0.228)
                       HP/Weight                                                                             2.214   (0.792)
                       Air                                                                                   0.034   (0.578)
                       MP$                                                                                   0.083   (0.014)
                       Size                                                                                  0.001   (0.181)
 Control Ftns          V1                                                                       2.605                  2.388
                                                                                              (2.683)                (2.702)
                       V2                                                                      -0.898                 -0.716
                                                                                              (1.606)                (1.453)
                       V3                                                                       0.114                  0.087
                                                                                              (0.774)                (0.689)
                       V4                                                                      -0.530                 -0.485
                                                                                              (0.533)                (0.536)
                       V5                                                                       0.063                  0.067
                                                                                              (0.132)                (0.132)
                       V6                                                                       0.799                  0.740
                                                                                              (0.805)                (0.820)
                       V7                                                                      -0.062                 -0.062
                                                                                              (0.099)                (0.099)
                       V8                                                                       0.216                  0.214
                                                                                              (0.233)                (0.248)
                       V9                                                                      -0.081                 -0.083
                                                                                              (0.192)                (0.187)
The data are identical to BLP (1995). Column 1 replicates estimates for the model of their first column of results in their Table
III. The second column uses the same instruments from BLP and estimates 2SLS for the characteristics used in Column 1.
The third column reports estimates of our CMRCF approach. The last column reports the CMRCF estimates of the random
coefficients model with interactions. We do not impose a supply side model during estimations. Standard errors reported for
our CMRCF and RC-CMRCF estimators are robust to heteroskedasticity and account for the “first and second-stage estimates”
following Kim and Petrin (2010c). The p-value for H0 :all the interaction parameters equal to zero is 0.019 for the CMRCF
and is 0.036 for the RC-CMRCF.
                                                               24
presence of the random coefficients does not change the fact that H0 :(γ0 , γp0 ) = 0 is rejected at 5%
as the p-value is 0.036, and the coefficient on the price coefficient changes from 0.232 to 0.233 and
the price interaction term from -0.043 to -0.042.
       Table 2 translates these estimates into elasticities. Berry, Levinsohn, and Pakes (1995) report
elasticities for selected automobiles from 1990, so we do the same, choosing every fourth automobile
from their Table III, in which vehicles are sorted in order of ascending price. The first column
uses the uncorrected logit specification from Column 1 of Table III in BLP (1995).21 Ignoring price
endogeneity severely biases price elasticities towards zero. As we control the endogeneity using the
2SLS the price elasticities change significantly and become more elastic, as the median elasticity
moves from -0.77 to -1.18. However, biggest change comes when we move from 2SLS to our CMRCF
approach allowing for interactions, as the median elasticity increases from -1.18 to -2.05, and the
mean elasticity increases from -1.60 to -2.65. Adding the random coefficients to the non-separable
specification has very little effect on the elasticities reported in Table 2, as is clear from examining
columns three and four.
                                                    Table 2
                       Automobile Elasticities: No Correction, 2SLS (without Interactions),
                           CMRCF, and RandomCoefficient-CMRCF (with Interactions)
                                                No Correction1   2SLS CMRCF RC-CMRCF
                 Interactions                               No     No         Yes             Yes
                 Results for 1971-1990
                    Median                                -0.77 -1.18       -2.05           -2.04
                    Mean                                  -0.75 -1.60       -2.65           -2.65
                    Standard Deviation                     0.34   1.17       1.69            1.70
                    No. of Inelastic Demands               68%    21%         4%              4%

                 Elasticities from 1990
                    Median                                      -0.93   -1.43        -2.80            -2.79
                    Mean                                        -0.91   -1.90        -3.23            -3.24
                    Standard Deviation                           0.46    1.28         1.85             1.87
                    No. of Inelastic Demands                     53%     12%           2%               2%

                 1990 Models (from BLP, Table VI):
                    Mazda 323                                   -0.44   -0.69        -1.61            -1.61
                    Honda Accord                                -0.81   -1.26        -1.42            -1.47
                    Acura Legend                                -1.67   -2.57        -4.17            -4.20
                    BMW 735i                                    -3.39   -5.09        -7.14            -7.26

The uncorrected specification is that from Table III of BLP (1995). 1990 is the year BLP focus
on for the individual models; we choose every fourth automobile from their Table VI (the other
elasticities were also very similar).



  21
       Because the data sets are the same, these are the same elasticities that result from the coefficients of their Table
III.




                                                             25
9    Conclusion
    We show how to allow for interactions in the utility function between the unobserved demand
factor and observed factors including price in a discrete choice demand setting. We start by noting
that when endogenous variables interact with the demand error the inversion and contraction from
Berry (1994) and Berry, Levinsohn, and Pakes (1995) can still be used to recover mean utility.
However, the standard IV approach is no longer consistent because the price interaction term is
correlated with the instrumented price. Furthermore, the conditional mean restrictions (CMR) used
for identification in Berry (1994) and Berry, Levinsohn, and Pakes (1995) are no longer sufficient
for identification.
    We show how to consistently estimate demand parameters while allowing for both endogenous
and exogenous variables to interact with the error. We couple the standard CMRs with new moment
conditions that we call “generalized control function moments.” We require only the use of the
exact same instruments used in the separable setting. Our approach thus extends the non-separable
demand literature as we do not require that our controls be one-to-one with the unobserved factors,
as in Bajari and Benkard (2005) or Kim and Petrin (2010a).
    We develop a sieve semiparametric estimator for the nonseparable demand models. Given mean
utility it is a simple three-step estimator to recover the parameters subsumed in the mean utility
term, including those parameters on the interaction terms. Monte Carlos suggest standard IV
estimators in the non-separable setting perform poorly, while our approach is consistent. Using the
same automobile data as was used in Berry, Levinsohn, and Pakes (1995), our estimates reveal that
the interactions terms are significant and the demand elasticities become 60% more elastic relative
to the standard IV estimator, primarily because the coefficient on price changes substantially when
the interaction terms are included.




                                                26
A      Proof of Consistency (Theorem 5)
We prove the consistency by extending Chen (2006)’s consistency proof for sieve extremum estima-
tors allowing for pre-step estimates. We first show that any (infeasible) estimator, (θ̃, f˜) defined as
any sequence that satisfies the following is consistent:

                          QJ (δ, z, p, V̂; θ̃, f˜) ≤ inf(θ,f )∈Θ×FJ QJ (δ, z, p, V̂; θ, f ) + op (1).                           (16)

   Let ε > 0 be any small real numbers. Any estimator (θ̃, f˜) that satisfies (16) also satisfies that
with probability approaching to one (w.p.a.1), QJ (δ, z, p, V̂; θ̃, f˜) < QJ (δ, z, p, V̂; θ, fJ ) + ε for all              6
(θ, fJ ) ∈ Θ × FJ . From the fact that θ0 ∈ Θ and πJ f0 ∈ FJ , it follows that QJ (δ, z, p, V̂; θ̃, f˜) <
QJ (δ, z, p, V̂; θ0 , πJ f0 ) + 6ε . Then by Assumption A8 and the consistency of the pre-stage estimators
(A3), we have w.p.a.1, Q0 (δ, z, p, V̂; θ̃, f˜) − QJ (δ, z, p, V̂; θ̃, f˜) < ε and Q0 (δ, z, p, V̂; θ0 , πJ f0 ) −
                                      J                                                           6           J
QJ (δ, z, p, V̂; θ0 , πJ f0 ) >      − 6ε .    It follows that w.p.a.1,

                                  ε
      Q0J (δ, z, p, V̂; θ̃, f˜) −             < QJ (δ, z, p, V̂; θ̃, f˜)
                                  6
                                                                                   ε                                   ε ε
                                              < QJ (δ, z, p, V̂; θ0 , πJ f0 ) +      < Q0J (δ, z, p, V̂; θ0 , πJ f0 ) + + .
                                                                                   6                                   6 6

Next we note that by the continuity assumption (A6) and the consistency of the pre-stage estimators
(A3), we have w.p.a.1, Q0 (δ, z, p, V; θ̃, f˜) − Q0 (δ, z, p, V̂; θ̃, f˜) < ε and Q0 (δ, z, p, V; θ0 , πJ f0 ) −
                                      J                              J                            6           J
Q0J (δ, z, p, V̂; θ0 , πJ f0 )   >   − 6ε .    It follows that w.p.a.1,

                                                     ε                                 ε 3ε
                           Q0J (δ, z, p, V; θ̃, f˜) − < Q0J (δ, z, p, V; θ0 , πJ f0 ) + + .
                                                     6                                 6 6

By A1 and A5 (continuity) and the fact that kf0 − πJ f0 kF → 0 as J → ∞, for all J > J0 large
enough we have Q0J (δ, z, p, V; θ0 , πJ f0 ) < Q0J (δ, z, p, V; θ0 , f0 ) + 6ε . It follows that

                                       Q0J (δ, z, p, V; θ̃, f˜) < Q0J (δ, z, p, V; θ0 , f0 ) + ε.                               (17)

Next note that for any  > 0, by A4, A5(continuity), A7 (compactness),

                                                          inf                   Q0J (δ, z, p, V; θ, f )
                                     {(θ,f )∈Θ×FJ :||θ−θ0 ||+||f −f0 ||F ≥}


exists (it can vary by J). Then by A1 (identification) and the fact that FJ ⊂ F, it must be that

                  Q0J (δ, z, p, V; θ0 , f0 ) <                            inf                    Q0J (δ, z, p, V; θ, f ).
                                                       {(θ,f )∈Θ×FJ :||θ−θ0 ||+||f −f0 ||F ≥}


Take ε small enough that inf {(θ,f )∈Θ×FJ :||θ−θ0 ||+||f −f0 ||F ≥} Q0J (δ, z, p, V; θ, f )−Q0J (δ, z, p, V; θ0 , f0 ) ≥
ε. Then from (17) it follows that w.p.a.1, Q0 (·; θ̃, f˜) < inf {(θ,f )∈Θ×F :||θ−θ ||+||f −f || ≥} Q0 (·; θ, f ).
                                                                J                                  J      0         0 F     J
Then by A5 (continuity) and the fact that (θ̃, f˜) ∈ Θ × FJ , we conclude ||θ̃ − θ0 || + ||f˜ − f0 ||F < .
This proves any estimator, (θ̃, f˜) that satisfies (16) is consistent. Next we note that our estimator


                                                                         27
(θ̂, fˆ) satisfies the following, so is consistent:

                    QJ (δ, z, p, V̂; θ̂, fˆ) ≤ inf(θ,f )∈Θ×F̂J QJ (δ, z, p, V̂; θ, f ) + op (1)
                                            = inf(θ,f )∈Θ×FJ QJ (δ, z, p, V̂; θ, f ) + op (1)

where the first inequality holds by Assumption A2 (extremum estimator) and the second equality
holds because F̂J → FJ by Assumption A3 and QJ (δ, z, p, V̂; θ, f ) is continuous in f .


B     Consistency Theorem for Random Coefficients Logit Models
We extend Berry, Linton, and Pakes (2004)’s consistency theorem to the case of our estimator.
In proofs of consistency for estimators of random coefficients models, when the asymptotics are
in the number of products Berry, Linton, and Pakes (2004) argue against maintaining uniform
convergence of the objective function and our proof accordingly avoids it. We heavily borrow
notation and regularity conditions from Berry, Linton, and Pakes (2004). The key complication is
that our estimator is a multi-step estimator, so we need to control the approximation errors from
pre-step estimators together with two other sources of errors, the sampling error in the observed
shares and the simulation error in the simulated distribution of the random coefficients.
    For transparency here we suppress the market index and assume the data is from a single market,
M = 1. The theorem naturally extends to the data of the multiple markets.
    Let ν(x, p, ξ, λ, θ, θλ ) be a J × 1 share function specific to a household type λ and P (λ) be the
distribution of λ that represents household heterogeneity. Then the vector of aggregate market
shares predicted by the random coefficients model at given values of the parameters θ in the mean
utility, the parameter θλ in P (λ), x,p, ξ, and P are
                                                             Z
                         σ(δ(x, p, ξ, θ), x, p, θλ , P ) =       ν(x, p, ξ, λ, θ, θλ )dP (λ).

Note that our notation allows for random coefficients on (x, p) but not ξ, so ξ appears only in the
mean utility. The function σ(·) maps the appropriate product space to the J + 1 dimensional unit
simplex for shares,

                                                                                     J
                                                                                     X
                   SJ = {(s0 , . . . , sJ )0 |0 ≤ sj ≤ 1 for j = 0, . . . , J, and         sj = 1}.
                                                                                     j=0


The actual market shares in the population are given by evaluating σ(δ(·, θ), x, p, θλ , P ) at (θ0 ,θλ0 ,P 0 ),
the true value of θ,θλ , and P .
    As the first source of error in the implementation of the random coefficients model we approxi-
mate P 0 by simulating it with P R , the empirical measure of some i.i.d. sample λ1 , . . . , λR such that




                                                         28
(e.g.)
                                               Z                                               R
                                                                                         1 X
             σ(δ(·, θ), x, p, θλ , P R ) =          ν(x, p, ξ, λ, θ, θλ )dP R (λ) =          ν(x, p, ξ, λr , θ, θλ ).
                                                                                         R
                                                                                             r=1

The second source of error is the sampling error in observed market shares sn , typically constructed
from n i.i.d. draws from the population of consumers. We denote by s0 , the population market
shares. We assume Berry, Linton, and Pakes (2004)’s Assumption A1 that regulates the simulation
errors and the sampling errors.
                                                              1   Pn
Assumption 9. The market shares snj =                         n    i=1 1(Ci      = j), where Ci is the choice of the i-th
consumer, and Ci are i.i.d. across i. For any fixed (x, p, ξ, θ,θλ ),

                                                                                         R
                                                                                     1 X
                σj (δ(·, θ), x, p, θλ , P R ) − σj (δ(·, θ), x, p, θλ , P 0 ) =          εj,r (δ(·, θ), x, p, θλ ),
                                                                                     R
                                                                                         r=1

where εj,r (δ(·, θ), x, p, θλ ) is bounded, continuous, and differentiable in δ(·, θ), θ, and θλ .

    The following regularity conditions on σ(δ(·, θ), x, p, θλ , P ) are from Assumption A2 of Berry,
Linton, and Pakes (2004) but the key difference is that we require some conditions to hold in terms
of the mean utility δ(·, θ) rather than ξ. As consequences, our assumption can be weaker than
Assumption A2 of Berry, Linton, and Pakes (2004) because we allow that δj (·, θ) is not necessarily
monotonic in ξj (so σj (δ(·, θ), x, p, θλ , P ) does not need to be monotonic in ξj ) in our models with
interactions. But note that we specifically consider the random coefficients logit model while Berry,
Linton, and Pakes (2004) is applicable to other models too.

Assumption 10. (i) For every finite J, for all finite δ and θλ ∈ Θλ , and for all P in a neighborhood
         ∂σj (δ,·,θλ ,P )                                                                                       ∂σj (δ,·,θλ ,P )
of P 0 ,      ∂δk         exists, and is      continuously differentiable in both δ and θλ , with                    ∂δj         >   0,
                      ∂σj (δ,·,θλ ,P )                        ∂σ(δ,·,θλ ,P )
and   for k 6= j,          ∂δk         ≤ 0.   The matrix          ∂δ 0         is invertible for all J; (ii)   s0j > 0 for all       j;
(iii) For every finite J, for all θ ∈ Θ, δ(·, θ) is continuously differentiable in θ.

    We outline our estimation procedure for which we show the consistency specifically. We first
obtain the mean utility δ ∗ = δ ∗ (x, p, θλ , s, P ) that solves

                                                     s − σ(δ ∗ , x, p, θλ , P ) = 0

and this solution is unique under the conditions outlined in BLP (1995), which we maintain here.
Therefore s and δ ∗ are in one-to-one relation for any θλ and P . Then by the implicit function
theorem, Dieudonne (1969)(Theorem 10.2.1), and Assumption 9, the mapping δ ∗ (x, p, θλ , s, P ) is
continuously differentiable in θλ ,s, P , in some neighborhood. Moreover, Assumption 10 above allows
us to expand the inverse map from (x, p, θλ , sn , P ) to δ ∗ (·) around s0 , which in turn facilitates
controlling the sampling error to show the consistency. As the convention, we let the true value of
δ ∗ , δ ∗0 = δ ∗ (x, p, θλ0 , s0 , P 0 ) be the solution to

                                                   s0 − σ(δ ∗ , x, p, θλ0 , P 0 ) = 0.

                                                                   29
Note that in the additive models where ξj enters additively in δj (·, θ), inverting ξ is equivalent to
inverting δ ∗ but in non-additive models it is convenient to characterize the inversion in term of
the mean utility. First some regularity conditions below regarding δ ∗ (·) does not depend on θ, the
parameters in the mean utility. Given θλ , i.e., δ ∗ (·, θλ , ·) the estimation procedure of the mean
utility parameters is identical to that of the model (in Section 6) without random coefficients when
we treat δ ∗ (·, θλ , ·) as the actual mean utility.
    We need to specify the mean utility for estimation (e.g.)

                     δj∗ = δj (xj , pj , ξj , θ) = c + β 0 xj − αpj + ξj + γ 0 xj ξj + γp (ȳ − pj )ξj .

Then the moment condition (that corresponds to (7) for the model without random coefficients) we
use becomes

   0 = E δj∗ (xj , pj , θλ0 , s0 , P 0 ) − {c0 + β00 xj − α0 pj + f0 (zj , Vj )(1 + γ00 xj + γp0 (ȳ − pj ))}|zj , Vj
                                                                                                                     


for j = 1, . . . , J where f0 (zj , Vj ) = E[ξj |zj , Vj ]. In the estimation we replace s0 with sn and
δ ∗ (·, s0 , P 0 ) with δ ∗ (·, sn , P R ). We also approximate Vj with V̂j and approximate f0 with a function
in the sieve space F̂J defined in (14). Therefore we obtain the estimator (θ̂, θ̂λ , fˆ(·)) that minimizes
the sample criterion function such that

                       ˆ θ̂λ , fˆ) = arginf                          ∗          n   R
                      (θ,                  (θ,θλ ,f )∈Θ×Θλ ×F̂J QJ (δ (·, θλ , s , P ), z, p, V̂; θ, f )              (18)

where we define (e.g.) in the case of the sieve least squares estimation

                                            J
                                          1X ∗
QJ (δ ∗ (·, θλ , s, P ), ·, V; θ, f ) ≡       {δj (xj , pj , θλ , s, P )−(c+β 0 xj −αpj +f (zj , Vj )(1+γ 0 xj +γp (ȳ−pj )))}2 .
                                          J
                                            j=1


Also define the population criterion function Q0J (δ ∗ (·, θλ , s, P ), ·, V; θ, f ) = E[QJ (δ ∗ (·, θλ , s, P ), ·, V; θ, f )].
    To obtain the consistency theorem we need to add further assumptions (Assumption 11 below)
that control the way in which sn approaches s0 and σ(δ ∗ (·), ·, θλ , P R ) approaches to σ(δ ∗ (·), ·, θλ , P 0 )
(corresponding to Assumption A3 in Berry, Linton, and Pakes (2004)) and add identification con-
ditions (Assumption 17 and 18 below, corresponding to Assumptions A3-A6 in Berry, Linton, and
Pakes (2004)). We also add restrictions on the rate at which s0j approaches to zero (Condition S in
Berry, Linton, and Pakes (2004)).

Condition 3 (S). There exist positive finite constants c and c such that with probability one

                                             c/J ≤ s0j ≤ c/J, j = 0, 1, . . . , J.

    In the following we work on the product space Θ×Θλ ×F ×SJ ×P where P is the set of probability
measures and endow the marginal spaces with (pseudo) metrics: ρP (P, P̃ ) = supB∈B |P (B)− P̃ (B)|,
where B is the class of all Borel sets on Rdim(λ) , the Euclidean metric ρE (·, ·) on Θ and Θλ , the

                                                               30
pseudo metric || · ||F on F, and a metric ρs0 on SJ , defined by

                                                                         sj − s̃j
                                                ρs0 (s, s̃) = max                 .
                                                                 0≤j≤J      s0j

The same metric is used for σj (·) in place of sj .
   We also use the metric ρδ (δ ∗ , δ̃ ∗ ) = J −1 Jj=1 (δj∗ −δ̃j∗ )2 . Lastly define for each  > 0, the following
                                                 P

neighborhoods of θ0 , θλ0 , f0 , P 0 , and s0 : Nθ0 () = {θ : ρE (θ, θ0 ) < }, Nθλ0 () = {θλ : ρE (θλ , θλ0 ) <
}, Nf0 ,J () = {f : ||f − f0 ||F < , f ∈ FJ }, NP 0 () = {P : ρP (P, P 0 ) < }, and Ns0 () = {s :
ρs0 (s, s0 ) < }. Also for each θλ and  > 0, define Nδ∗0 (θλ , ) = {δ ∗ : ρδ (δ ∗ , δ ∗ (·, θλ , s0 , P 0 )) < }.
We further denote NΠ0 () = {Π : kΠ − Π0 ks < } and Nϕ̄0l () = {ϕ̄l : kϕ̄l − ϕ̄0l ks < } for the
pseudo metric || · ||s .

Assumption 11. The random sequences sn and σ R (θλ ) are consistent with respect to the corre-
sponding metrics,

                           (a) ρs0 (sn , s0 ) →p 0; (b) sup ρσ(θλ ) (σ R (θλ ), σ(θλ )) →p 0
                                                                θλ ∈Θλ


where σ R (θλ ) = σ(δ ∗ (·, θλ , s0 , P 0 ), ·, θλ , P R ) and σ(θλ ) = σ(δ ∗ (·, θλ , s0 , P 0 ), ·, θλ , P 0 ). Furthermore
suppose that the true market shares satisfy

                          J                                    J
                        1 X s0j (1 − s0j )                   1 X σj (θλ )(1 − σj (θλ ))
                 (c)                       →p 0; (d)  sup                               →p 0.
                       nJ
                           j=0
                                (s0j )2              θλ ∈Θλ RJ        (σj (θλ ))2
                                                                           j=0


    Next we assume that our estimator is an extremum estimator that solves (18).

Assumption 12. QJ (δ ∗ (·, θ̂λ , sn , P R ), ·, V̂; θ̂, fˆ) ≤ inf(θ,θλ ,f )∈Θ×Θλ ×F̂J QJ (δ ∗ (·, θλ , sn , P R ), ·, V̂; θ, f )+
op (1).

    The next condition is that in the small neighborhoods of Π0 (·) and ϕ̄0l (·), the difference between
the sample criterion function and the population criterion function is small enough when J is large.

Assumption 13. For any C > 0 there exists  > 0 such that

                  lim Pr{                           sup                          |QJ (δ ∗ (·, θλ , s0 , P 0 ), ·, V; θ, f )
                 J→∞         (θ,θλ ,f )∈Θ×Θλ ×FJ ,Π∈NΠ0 (),ϕ̄0l ∈Nϕ̄0l ()∀l

                 −Q0J (δ ∗ (·, θλ , s0 , P 0 ), ·, V; θ, f )|   > C} = 0

where Vj = gj (p1 − Π(z1 ), . . . , pJ − Π(zJ )).

    Although it is obvious, we add the following continuity conditions.

Assumption 14. Q0J (δ ∗ (·, θλ , s, P ), ·, V; θ, f ) is continuous in (θ, θλ , f ) ∈ Θ × Θλ × FJ .

Assumption 15. Q0J (δ ∗ (·, θλ , s, P ), ·, V; θ, fJ ) is continuous in Π(·) and ϕ̄l (·) uniformly for all
(θ, θλ , fJ ) ∈ Θ × Θλ × FJ .

                                                                  31
    We also assume our parameter space is compact.

Assumption 16. The parameter space Θ × Θλ is compact and the sieve space, FJ , is compact
under the pseudo-metric || · ||F .

    The next condition ensures that we can, at least asymptotically, distinguish the δ ∗ that sets the
models predictions for shares equal to the actual shares from other values of δ ∗ .

Assumption 17. For all , there exists C() > 0 such that σ(δ ∗ , x, p, θλ , P )

 lim Pr{ inf              inf          ||J −1/2 log σ(δ ∗ , ·, θλ , P 0 )−J −1/2 log σ(δ ∗ (·, θλ , s0 , P 0 ), ·, θλ , P 0 )|| > C()} = 1.
J→∞         θλ ∈Θλ δ ∗ ∈N
                       / δ∗0 (θλ ,)


    The following is the key condition for the consistency on the limiting behavior of the population
criterion function for (θ, θλ , f ) outside a neighborhood of (θ0 , θλ0 , f0 ).

Assumption 18. (i) Q0J (δ ∗ (·, θλ0 , s0 , P 0 ), ·, V; θ0 , f0 ) < ∞; (ii) For all  > 0, there exists C() > 0
such that

 lim {                  inf                     Q0J (δ ∗ (·, θλ , s0 , P 0 ), ·, V; θ, f )−Q0J (δ ∗ (·, θλ0 , s0 , P 0 ), ·, V; θ0 , f0 )} ≥ C().
J→∞ θ∈N
     / θ0 (),θλ ∈N
                 / θλ0 (),f ∈N
                             / f0 ,J ()


    We now state our consistency theorem.

Theorem 6. Suppose Assumptions 9-18 hold for some n(J), R(J) → ∞. Further suppose Assump-
tions A3 and A4 hold. Then θ̂ →p θ0 and θ̂λ →p θλ0 .

B.1      Proof of General Consistency (Theorem 6)
In proving Theorem 6 we use a strategy very close to Berry, Linton, and Pakes (2004). We first
show that the estimator, (θ̃, θ̃λ , f˜) defined as any sequence that satisfies the following is consistent:

   QJ (δ ∗ (·, θ̃λ , s0 , P 0 ), z, p, V̂; θ̃, f˜) = inf(θ,θλ ,f )∈Θ×Θλ ×FJ QJ (δ ∗ (·, θλ , s0 , P 0 ), z, p, V̂; θ, f ) + op (1).
                                                                                                              (19)
                                                                                        ˜
    Let ε > 0 be any small real numbers. Note that any estimator (θ̃, θ̃λ , f ) satisfying (19)
also satisfies that with probability approaching to one (w.p.a.1), QJ (δ ∗ (·, θ̃λ , s0 , P 0 ), ·, V̂; θ̃, f˜) <
QJ (δ ∗ (·, θλ , s0 , P 0 ), ·, V̂; θ, fJ ) +   ε
                                                6   for all (θ, θλ , fJ ) ∈ Θ × Θλ × FJ . Then from the fact that
(θ0 , θλ0 ) ∈ Θ × Θλ and πJ f0 ∈ FJ , it follows that

                                                                                                                       ε
               QJ (δ ∗ (·, θ̃λ , s0 , P 0 ), z, p, V̂; θ̃, f˜) < QJ (δ ∗ (·, θλ0 , s0 , P 0 ), z, p, V̂; θ0 , πJ f0 ) + .
                                                                                                                       6

Then by Assumption 13 and the consistency of the pre-stage estimators (A3), we have w.p.a.1,
Q0J (δ ∗ (·, θ̃λ , s0 , P 0 ), ·, V̂; θ̃, f˜) − QJ (δ ∗ (·, θ̃λ , s0 , P 0 ), ·, V̂; θ̃, f˜) < 6ε and

                                                                                                                          ε
          Q0J (δ ∗ (·, θλ0 , s0 , P 0 ), z, p, V̂; θ0 , πJ f0 ) − QJ (δ ∗ (·, θλ0 , s0 , P 0 ), z, p, V̂; θ0 , πJ f0 ) > − .
                                                                                                                          6


                                                                     32
It follows that w.p.a.1,

                                                           ε
         Q0J (δ ∗ (·, θ̃λ , s0 , P 0 ), z, p, V̂; θ̃, f˜) − < QJ (δ ∗ (·, θ̃λ , s0 , P 0 ), z, p, V̂; θ̃, f˜)
                                                           6
                                                                 ε                                                    ε ε
         < QJ (δ (·, θλ0 , s , P ), z, p, V̂; θ0 , πJ f0 ) + < Q0J (δ ∗ (·, θλ0 , s0 , P 0 ), z, p, V̂; θ0 , πJ f0 ) + + .
                    ∗             0     0
                                                                 6                                                    6 6

Next we note that by the continuity assumption (Assumption 15) and the consistency of the pre-
stage estimators (A3), we have w.p.a.1, Q0 (δ ∗ (·, θ̃λ , s0 , P 0 ), ·, V; θ̃, f˜)−Q0 (δ ∗ (·, θ̃λ , s0 , P 0 ), ·, V̂; θ̃, f˜) <
                                                             J                                            J
ε
6    and Q0J (δ ∗ (·, θλ0 , s0 , P 0 ), ·, V; θ0 , πJ f0 ) − Q0J (δ ∗ (·, θλ0 , s0 , P 0 ), ·, V̂; θ0 , πJ f0 ) > − 6ε . It follows that
w.p.a.1,

                                                           ε                                                        ε 3ε
          Q0J (δ ∗ (·, θ̃λ , s0 , P 0 ), z, p, V; θ̃, f˜) − < Q0J (δ ∗ (·, θλ0 , s0 , P 0 ), z, p, V; θ0 , πJ f0 ) + + .
                                                           6                                                        6 6

Then by Assumption 18 and Assumption 14 (continuity) and the fact that kf0 − πJ f0 kF → 0 as
J → ∞, for all J > J0 large enough we have

                                                                                                                          ε
                Q0J (δ ∗ (·, θλ0 , s0 , P 0 ), z, p, V; θ0 , πJ f0 ) < Q0J (δ ∗ (·, θλ0 , s0 , P 0 ), z, p, V; θ0 , f0 ) + .
                                                                                                                          6

It follows that

                    Q0J (δ ∗ (·, θ̃λ , s0 , P 0 ), z, p, V; θ̃, f˜) < Q0J (δ ∗ (·, θλ0 , s0 , P 0 ), z, p, V; θ0 , f0 ) + ε.               (20)

Next note that for any  > 0, by A4, Assumption 14 (continuity), 16 (compactness),

                                                inf                   Q0J (δ ∗ (·, θλ , s0 , P 0 ), z, p, V; θ, f )
                              θ∈N
                               / θ0 (),θλ ∈N
                                           / θλ0 (),f ∈N
                                                       / f0 ,J ()


exists (it can vary by J). Then by Assumption 18 and the fact that FJ ⊂ F, it must be that

    Q0J (δ ∗ (·, θλ0 , s0 , P 0 ), z, p, V; θ0 , f0 ) <                   inf                    Q0J (δ ∗ (·, θλ , s0 , P 0 ), z, p, V; θ, f ).
                                                          θ∈N
                                                           / θ0 (),θλ ∈N
                                                                       / θλ0 (),f ∈N
                                                                                   / f0 ,J ()


Take ε small enough that

                     inf                    Q0J (δ ∗ (·, θλ , s0 , P 0 ), ·, V; θ, f ) − Q0J (δ ∗ (·, θλ0 , s0 , P 0 ), ·, V; θ0 , f0 ) ≥ ε.
     θ∈N
      / θ0 (),θλ ∈N
                  / θλ0 (),f ∈N
                              / f0 ,J ()


Then from (20) it follows that w.p.a.1,

     Q0J (δ ∗ (·, θ̃λ , s0 , P 0 ), z, p, V; θ̃, f˜) <                   inf                    Q0J (δ ∗ (·, θλ , s0 , P 0 ), z, p, V; θ, f ).
                                                         θ∈N
                                                          / θ0 (),θλ ∈N
                                                                      / θλ0 (),f ∈N
                                                                                  / f0 ,J ()


Then by Assumption 14 (continuity) and the fact that (θ̃, θ̃λ , f˜) ∈ Θ × Θλ × FJ , we conclude
θ̃ ∈ Nθ0 (), θ̃λ ∈ Nθλ0 (), and f˜ ∈ Nf0 ,J (). Therefore we have shown that any estimator (θ̃, θ̃λ , f˜)
that satisfies (19) is consistent.



                                                                        33
    Next we show that the actual estimator (θ̂, θ̂λ , fˆ) satisfies the following, so is consistent because
it then satisfies (19) :

                   QJ (δ ∗ (·, θ̂λ , s0 , P 0 ), z, p, V̂; θ̂, fˆ) = QJ (δ ∗ (·, θ̂λ , sn , P R ), z, p, V̂; θ̂, fˆ) + op (1)   (21)
              ≤ inf(θ,θλ ,f )∈Θ×Θλ ×F̂J QJ (δ ∗ (·, θλ , sn , P R ), z, p, V̂; θ, f ) + op (1)                                  (22)
                                                        ∗           n        R
              = inf(θ,θλ ,f )∈Θ×Θλ ×FJ QJ (δ (·, θλ , s , P ), z, p, V̂; θ, f ) + op (1)                                        (23)
              = inf(θ,θλ ,f )∈Θ×Θλ ×FJ QJ (δ ∗ (·, θλ , s0 , P 0 ), z, p, V̂; θ, f ) + op (1)                                   (24)

where (22) (the first inequality) holds because (θ̂, θ̂λ , fˆ) is an extremum estimator satisfying (18)
and (23) (the second equality) holds because F̂J → FJ (in the Hausdorff metric defined on the
metric space (F, k·kF )) by Assumption A3 and QJ (·, V̂; θ, f ) is continuous in f . We focus on (21)
(the first equality) and (24) (the last equality). Consider that by applying the Cauchy-Schwarz
inequality twice we obtain

        sup (θ,θλ ,f )∈Θ×Θλ ×(F̂J ∪FJ ) |QJ (δ ∗ (·, θλ , sn , P R ), ·, V̂; θ, f ) − QJ (δ ∗ (·, θλ , s0 , P 0 ), ·, V̂; θ, f )| (25)
                                                   J
                                                   X
   ≤ sup (θ,θλ ,f )∈Θ×Θλ ×(F̂J ∪FJ ) J −1                (δj∗ (·, θλ , sn , P R ) − δj∗ (·, θλ , s0 , P 0 ))2 ×
                                                   j=1

        ×2 sup (θ,θλ ,f )∈Θ×Θλ ×(F̂J ∪FJ ) (QJ (δ ∗ (·, θλ , sn , P R ), ·, V̂; θ, f ) + QJ (δ ∗ (·, θλ , s0 , P 0 ), ·, V̂; θ, f ))
                               J
                               X
   ≤ C · sup θλ ∈Θλ J −1             (δj∗ (·, θλ , sn , P R ) − δj∗ (·, θλ , s0 , P 0 ))2
                               j=1


for some constant C. Here the second inequality holds because any δ ∗ (·) obtained from the con-
traction mapping is bounded (BLP (1995) show the random coefficients logit model satisfies the
contraction mapping property), all the parameter spaces are bounded (Assumption 16), and we
assume zj and pj are (stochastically) bounded, so sup (θ,θλ ,f )∈Θ×Θλ ×(F̂J ∪FJ ) QJ (·) is bounded. Also
note that δ ∗ (·, θλ , ·) does not depend on (θ, f ).
    Therefore (25) is op (1) if

                                           J
                                           X
                                      −1
                              sup J              (δj∗ (·, θλ , sn , P R ) − δj∗ (·, θλ , s0 , P 0 ))2 = op (1).                 (26)
                           θλ ∈Θλ          j=1

This in turn implies (21) immediately and also implies (24) by the triangle inequality as we argue be-
                        (1)
low. Let QJ (δ ∗ (·, θλ , sn , P R ), z, p, V̂; θ(1) , f (1) ) = arginf(θ,θλ ,f )∈Θ×Θλ ×FJ QJ (δ ∗ (·, θλ , sn , P R ), z, p, V̂; θ, f )
                  (2)
and QJ (δ ∗ (·, θλ , s0 , P 0 ), z, p, V̂; θ(2) , f (2) ) = arginf(θ,θλ ,f )∈Θ×Θλ ×FJ QJ (δ ∗ (·, θλ , s0 , P 0 ), z, p, V̂; θ, f ).
                               (1)                            (2)
The minimizers (θ(1) , θλ , f (1) ) and (θ(2) , θλ , f (2) ) exist because QJ (·) is continuous in (θ, θλ , f )




                                                                        34
and the parameter space Θ × Θλ × FJ is compact (Assumption 16). It follows that

                           (1)                                                    (1)
op (1) = QJ (δ ∗ (·, θλ , sn , P R ), z, p, V̂; θ(1) , f (1) ) − QJ (δ ∗ (·, θλ , s0 , P 0 ), z, p, V̂; θ(1) , f (1) )
                           (1)                                                    (2)
         ≤ QJ (δ ∗ (·, θλ , sn , P R ), z, p, V̂; θ(1) , f (1) ) − QJ (δ ∗ (·, θλ , s0 , P 0 ), z, p, V̂; θ(2) , f (2) )
                           (2)                                                    (2)
         ≤ QJ (δ ∗ (·, θλ , sn , P R ), z, p, V̂; θ(2) , f (2) ) − QJ (δ ∗ (·, θλ , s0 , P 0 ), z, p, V̂; θ(2) , f (2) ) = op (1)

where the first and the last equality hold by (25) and (26). The first inequality holds because
        (2)
(θ(2) , θλ , f (2) ) minimizes QJ (δ ∗ (·, θλ , s0 , P 0 ), z, p, V̂; θ, f ) over Θ×Θλ ×FJ and the second inequal-
                                 (1)
ity holds because (θ(1) , θλ , f (1) ) minimizes QJ (δ ∗ (·, θλ , sn , P R ), z, p, V̂; θ, f ) over Θ×Θλ ×FJ . This
proves (24).
    Finally note that (26) is op (1) by the essentially same proof (page 647-648) in the proof of
Theorem 1 of Berry, Linton, and Pakes (2004) under Assumption 11 and Assumption 17 because
(i) all arguments there in terms of ξ also hold in terms of our δ ∗ and (ii) Assumption 11 replaces
their Assumption A3 and Assumption 17 replaces their Assumption A5.
    This completes the proof.




                                                               35
References
Bajari, P., and L. Benkard (2005): “Demand Estimation with Heterogeneous Consumers and
  Unobserved Product Characteristics: A Hedonic Approach,” Journal of Political Economy, 113,
  1239–1276.

Berry, S. (1994): “Estimating Discrete-Choice Models of Product Differentiation,” The RAND
  Journal of Economics, 25(2), 242–262.

Berry, S., and P. Haile (2010): “Identification in Differentiated Products Markets Using Market
  Level Data,” NBER working paper.

Berry, S., J. Levinsohn, and A. Pakes (1995): “Automobile Prices in Market Equilibrium,”
  Econometrica, 60(4), 889–917.

Berry, S., O. Linton, and A. Pakes (2004): “Limit Theorems for Estimating the Parameters
  of Differentiated Product Demand Systems,” Review of Economic Studies, 71, 613–654.

Blundell, R., and J. Powell (2003): “Endogeneity in Nonparametric and Semiparametric Re-
  gression Models,” Advances in Economics and Econometrics:Theory and Applications, Eighth
  World Congress.

Chen, X. (2006): “Large Sample Sieve Estimation of Semi-Nonparametric Models,” forthcoming in
  Handbook of Econometrics, Volume 6.

Chen, X., O. Linton, and I. van Keilegom (2003): “Estimation of Semiparametric Models
  When the Criterion Function is Not Smooth,” Econometrica, 71, 1591–1608.

Chesher, A., A. Rosen, and K. Smolinski (2011): “An Instrumental Variable Model of Multiple
  Discrete Choice,” Working paper.

Dieudonne, J. (1969): Foundations of Modern Analysis, New York: Academic Press.

Florens, J., J. Heckman, C. Meghir, and E. Vytlacil (2008): “Identification of Treatment
  Effects Using Control Functions in Models with Continuous Endogenous Treatment and Hetero-
  geneous Effects,” Econometrica, 76, 1191–1206.

Gandhi, A. (2009): “Inverting Demand Systems,” Working paper.

Hahn, J., and G. Ridder (2008): “Conditional Moment Restrictions and Triangular Simultaneous
  Equations,” Working Paper.

Imbens, G., and W. Newey (2003): “Identification and Estimation of Triangular Simultaneous
  Equations Models without Additivity,” Working Paper.

Imbens, G., and W. Newey (2009): “Identification and Estimation of Triangular Simultaneous
  Equations Models Without Additivity,” Econometrica, 77, 1481–1512.

                                              36
Kim, K., and A. Petrin (2010a): “Control Function Corrections for Unobserved Factors in Dif-
  ferentiated Product Models,” Working Paper.

         (2010b): “Control Functions for a Class of Non-Separable Models without Independence
  and Monotonicity Conditions,” Working paper.

        (2010c): “Multiplicative Heterogeneity Models with Endogeneity,” Working paper.

         (2010d): “Revisiting Instrumental Variables and the Classic Control Function Approach,
  with Implications for Parametric and Non-Parametric Regressions,” Working paper.

Lewbel, A. (2000): “Semiparametric Qualitative Response Model Estimation With Instrumental
  Variables and Unknown Heteroscedasticity,” Journal of Econometrics, 97, 145–177.

Matzkin, R. (2003): “Nonparametric Estimation of Nonadditive Random Functions,” Economet-
  rica, 71, 1339–1375.

McFadden, D. (1981): “Structural discrete probability models derived from theories of choice,”
  Structural Analysis of Discrete Data and Econometric Applications, pp. 115–178, Edited by
  Charles Manski and Daniel McFadden, The MIT press.

Newey, W., and J. Powell (2003): “Instrumental Variable Estimation of Nonparametric Mod-
  els,” Econometrica, 71, 1565–1578.

Pakes, A. (1996): “Dynamic structural models, problems and prospects: mixed continuous discrete
  controls and market interaction,” in Advances in Econometrics, Sixth World Congress, Volume
  II, ed. by C. Sims, pp. 171–259, New York. Cambridge.

Rothenberg, T. (1971): “Identification in Parametric Models,” Econometrica, 39, 577–591.




                                                37
