                                 NBER WORKING PAPER SERIES




       A THEORY OF THE PERTURBED CONSUMER WITH GENERAL BUDGETS

                                          Daniel L. McFadden
                                           Mogens Fosgerau

                                         Working Paper 17953
                                 http://www.nber.org/papers/w17953


                       NATIONAL BUREAU OF ECONOMIC RESEARCH
                                1050 Massachusetts Avenue
                                  Cambridge, MA 02138
                                      March 2012




Mogens Fosgerau has received support from the Danish Strategic Research Council, and Daniel McFadden
has received support from the E. Morris Cox fund at the University of California, Berkeley, the Presidential
fund at USC, and National Institute on Aging (NIA) grants No. P01 AG005842 to the NBER and No.
RC4 AG039036 to USC The views expressed herein are those of the authors and do not necessarily
reflect the views of the National Bureau of Economic Research.

NBER working papers are circulated for discussion and comment purposes. They have not been peer-
reviewed or been subject to the review by the NBER Board of Directors that accompanies official
NBER publications.

© 2012 by Daniel L. McFadden and Mogens Fosgerau. All rights reserved. Short sections of text,
not to exceed two paragraphs, may be quoted without explicit permission provided that full credit,
including © notice, is given to the source.
A theory of the perturbed consumer with general budgets
Daniel L. McFadden and Mogens Fosgerau
NBER Working Paper No. 17953
March 2012
JEL No. C25,D11

                                             ABSTRACT

We consider demand systems for utility-maximizing consumers facing general budget constraints
whose utilities are perturbed by additive linear shifts in marginal utilities. Budgets are required to be
compact but are not required to be convex. We define demand generating functions (DGF) whose
subgradients with respect to these perturbations are convex hulls of the utility-maximizing demands.
We give necessary as well as sufficient conditions for DGF to be consistent with utility maximization,
and establish under quite general conditions that utility-maximizing demands are almost everywhere
single-valued and smooth in their arguments. We also give sufficient conditions for integrability of
perturbed demand. Our analysis provides a foundation for applications of consumer theory to problems
with nonlinear budget constraints.


Daniel L. McFadden
University of California, Berkeley
Department of Economics
549 Evans Hall #3880
Berkeley, CA 94720-3880
and NBER
mcfadden@econ.berkeley.edu

Mogens Fosgerau
Technical University of Denmark
Bygningstorvet 116B
Building , room 115C
2800 Kgs. Lyngby
Denmark
mf@transport.dtu.dk
1       Introduction
Economic consumer demand analysis traditionally starts from a utility function
that characterizes preferences, maximizes it subject to a budget linear in income
and prices, and obtains demands as functions of these budget parameters. A useful
extension starts from a probability over a field of preferences and obtains a condi-
tional distribution of demands given the budget parameters. A crowning achieve-
ment of neoclassical consumer theory is characterization in terms of expenditure
and indirect utility functions of demands obtained from utility maximization. This
allows development of utility-consistent demand systems for applications without
requiring constructive solution of the constrained optimization problem.1 How-
ever, this characterization depends critically on the envelope/duality properties of
optimization subject to a linear constraint, and is not immediately applicable to
non-linear budget sets. We tackle this problem by introducing utility fields with
linear additive marginal utility perturbations of a base utility function.2 Through
this device, we are able to establish conditions for consistency with utility maxi-
mization of demand systems for nonlinear budget sets, with the perturbation pa-
rameters playing a role analogous to prices in classical consumer theory.
    Section 2 specifies our assumptions and gives an elementary envelope result
that provides a framework for specifying demand generating functions (DGF) for
a general consumer problem. This section also provides some further proper-
ties of DGF and demand that follow from utility maximization. In section 3,
sufficient conditions are given for a candidate DGF to be consistent with utility
    1
      See Mas-Colell et al. (1995, Chap. 3D-H) and Varian (1993, Chap. 7.3-7.5). Diewert
(1974) gives mathematical details and historical references. In a nutshell, if v(t, p, y) is the
indirect utility function and e(t, p, u) is the expenditure function for locally non-satiated util-
ity with prices p, income y, and environment t, then market demand is given by Roy’s identity,
X(t, p, y) = −∂p v(t, p, y)/∂y v(t, p, y), and the net welfare gain from a move from (t0 , p0 , y 0 )
to (t00 , p00 , y 00 ) in money-metric utility at prices p and environment t is e(t, p, v(t0 , p0 , y 0 )) −
e(t, p, v(t00 , p00 , y 00 )).
    2
      Our approach follows Matzkin and McFadden (2011), where payoff tremble induced by per-
turbations is used to establish existence and regularity of Bayes-Nash solutions to continuous
games of imperfect information. These perturbations can be interpreted as translations of the gra-
dients of indifference curves, which may be of independent interest as the dual of the location
shifts of indifference curves associated with Stone-Geary and Gorman demand systems. For re-
lated use of perturbation methods in mathematical programming; see Rockafellar (1970), Birge
and Murty (1994), and Luderer et al. (2002). Where possible, we reference Aliprantis and Border
(2006), hereafter AB, for results that we use from mathematical analysis.

                                                     2
maximization, and some results are provided to assist the derivation of DGF for
applications. Section 4 provides conditions for integrability of demand. Section 5
considers computation of the DGF in the case when utility has the Gorman polar
form. Section 6 concludes. All proofs are given in the Appendix.

            Acronym      Definition
            ACCM         Axiom of Congruent Cyclic Monotonicity
            DGF          Demand Generating Function
            GFFI         Generating Function Fundamental Inequality
                                 Table 1: Acronyms




2    An Envelope Theorem for Perturbed Consumers
Let S denote a convex body (a compact convex set with a non-empty interior) in
Rn+ that includes all possible consumption vectors and let T be a compact metric
space that indexes tastes, beliefs, and other attributes of the consumer’s environ-
ment that are not necessarily finite-dimensional. Consider a base utility function
U (x; t), where x ∈ S is a consumption vector and t ∈ T . Let k · k denote the
Euclidean norm on Rn , and let η(t, t0 ) denote the metric on T .
    We form a utility field by adding a linear perturbation to base utility, U (x; t) +
m · x, where m is a vector of perturbation parameters that can be interpreted as
shifts in the marginal utilities of the commodities. The effect of this perturbation
on demand is not invariant under increasing transformations of U , so that further
analysis is conditioned on a particular ordinal representation of base preferences.
We will assume that m is contained in a closed ball M = {m ∈ Rn |kmk ≤ c}
for some c > 0. We do not assume that U (x; t) + m · x is quasiconcave in
x, but when it is and c is sufficiently large, we show in the Appendix that as a
consequence U (x; t), and hence U (x; t) + m · x, are concave in x.
    Let B denote a subset of the space of non-empty compact sets in S, interpreted
as the family of possible budget sets. Let

           h(B 0 , B 00 ) = max
                            00
                                  min0 kx0 − x00 k + max
                               00 0                  0
                                                          min00 kx0 − x00 k
                                                        0 00
                         x ∈B x ∈B                  x ∈B x ∈B




                                          3
denote the Hausdorff set metric on B; see AB 3.17. Assume that B is compact in
the Hausdorff set metric topology. We do not require the B ∈ B to be convex sets
or linear budget sets. Let [B] denote the convex hull of a set B.
    Consider the problem of maximizing U (x; t) + m · x in x over a budget set
B ∈ B. Term X(m; t, B) = argmaxx∈B (U (x; t) + m · x) the demand mapping,
or when it is non-empty, the demand correspondence, and term V (m; t, B) =
maxx∈B (U (x; t) + m · x) the demand generating function (DGF). Term E(t) =
S
  (m,B)∈M ×B X(m; t, B) the exposed set; it is the set of x ∈ S that are chosen for
some budget and some perturbation m. We call E(t) full if its closure is S. In
the classical case of linear budget sets B(p, y) = {x ∈ S|p · x ≤ y} with strictly
positive prices p and incomes y satisfying minx∈S p · x ≤ y ≤ maxx∈S p · x
let v(m, t, p, y) ≡ V (m, t, B(p, y)), and note that v is a classical indirect utility
function in (p, y). When B contains the classical linear budget sets and utility
is quasiconcave, continuous, and locally non-satiated in the interior of S, E(t)
is full. It may also be full for sufficiently rich families B even if utility is not
quasiconcave; e.g., the extreme case where B contains all singleton budget sets in
S.
    As a consequence of maximization of perturbed utility, if x0 ∈ X(m0 ; t, B 0 )
and x0 ∈ B 1 , then V (m0 ; t, B 0 ) + (m1 − m0 ) · x0 ≡ U (x0 ; t) + m1 · x0 ≤
maxx∈B 1 (U (x; t) + m1 · x) ≡ V (m1 ; t, B 1 ). Rearranging gives

Definition 1 Generating Function Fundamental Inequality (GFFI): If m0 , m1 ∈
M, B 0 , B 1 ∈ B, t ∈ T , and x0 ∈ B 1 ∩ X(m0 ; t, B 0 ), then (m1 − m0 ) · x0 ≤
V (m1 ; t, B 1 ) − V (m0 ; t, B 0 ), with equality if and only if x0 ∈ X(m1 ; t, B 1 ).

    Summing the GFFI over a cycle of perturbations and budget sets gives an
analog for perturbed utility maximization of the conventional axiom of revealed
preference:

Definition 2 Axiom of Congruent Cyclic Monotonicity (ACCM): If mj ∈ M, B j ∈
B, and xj ∈ B j+1 ∩ X(mj ; t, B j ) for j = 1, ..., J, where J ≥ 2 is an arbitrary in-
teger and (mJ+1 , B J+1 , xJ+1 ) = (m1 , B 1 , x1 ), then Jj=1 (mj+1 − mj ) · xj ≤ 0,
                                                         P

with the inequality strict unless xj+1 ∈ X(mj ; t, B j ) for j = 1, ..., J.



                                          4
     When the B j are all the same, the ACCM implies that X(mj ; t, B) satisfies a
cyclic monotonicity condition (Rockafellar, 1970, chap. 24) that guarantees that
it is contained in the subdifferential of a convex function. When the mj are all
the same, the ACCM reduces to the Congruence Axiom of Revealed Preference
(Richter, 1966; Matzkin, 1991; McFadden and Richter, 1990).
     The starting point for our analysis is an elementary theorem that summarizes
properties of perturbed utility maximization; all proofs are given in an appendix.
Theorem 1 (Envelope Theorem) Suppose U : S × T → R is continuous, M is a
closed ball, and budget sets B are contained in a compact (in the Hausdorff set
metric topology) subset B of the space of non-empty compact subsets of S. Then
    [Cond. X] The demand mapping X(m; t, B) is a compact-valued, upper
hemicontinuous correspondence from M × T × B into S that satisfies the ACCM.
The exposed set E(t) is a compact-valued, upper hemicontinuous correspondence
from T into S.
    [Cond. V] The demand generating function V (m; t, B) from M × T × B into
R is continuous in its arguments; and convex, closed, and non-decreasing in m for
each (t, B). Further, V (m; t, B) and X(m; t, B) satisfy the generating function
fundamental inequality (GFFI).
    [Cond. SD] The subdifferential

∂m V (m; t, B) = {x ∈ Rn |∀m0 ∈ M, V (m0 ; t, B) − V (m; t, B) ≥ x · (m0 − m)}

exists for all (m, t, B) ∈ M × T × B, and is a convex-valued, compact-valued,
upper hemicontinuous correspondence satisfying [X(m; t, B)] = ∂m V (m; t, B)
and consequently X(m; t, B) ⊆ B ∩ ∂m V (m; t, B). Then, all extreme points of
∂m V (m; t, B) are in X(m; t, B). If, further, U is quasiconcave, then X(m; t, B) =
B∩∂m V (m; t, B), and if in addition, B is convex, then X(m; t, B) = ∂m V (m; t, B).
For each (t, B) ∈ T × B, the subdifferential is almost everywhere (w.r.t. m) a sin-
gleton, and where it is a singleton, it is continuous and continuously differentiable,
and ∂mm V (m; t, B) = ∂m X(m; t, B) is symmetric and positive semidefinite.
Remark [Cond X] is the standard result that the demand correspondence coming
from continuous utility maximization in a compact budget set is upper hemicon-
tinuous, but here continuity with respect to the budget is characterized in terms

                                        5
of the Hausdorff distance between general budgets rather than Euclidean distance
between price and income parameters determining classical linear budgets. The
condition does not require that U (x)+m·x be nondecreasing in x and locally non-
satiated, but if it is, then X(m; t, B) is northeast exposed; i.e., if x ∈ X(m; t, B),
then x0 ≥ x and x0 6= x imply x0 ∈   / B.
    [Cond. V] corresponds to the definition of an indirect utility function, but now
the dependence of this function on the perturbation vector m is emphasized, and
V is written as a function of the budget set B itself rather than as a function of
parameters that determine B.
    [Cond. SD] establishes that for almost all m, the utility-maximizing demand
is a singleton that is given by the gradient of V with respect to m. Compare
this for a classical linear budget constraint with Shepard’s lemma giving Hicksian
demands as a gradient of the expenditure function with respect to price, and Roy’s
identity, giving market demands as a scaled gradient of the indirect utility function
with respect to price.
   If continuity of U (x; t) is strengthened to Lipschitz continuity, the following
corollary establishes that the demand generating function is Lipschitz in its argu-
ments:

Corollary 1 Suppose S, U, M , and B satisfy the assumptions of Theorem 1, and
U (x; t) is Lipschitz on S × T . Then V (m; t, B) is Lipschitz on M × T × B.

Remark The usual way to define a (nonlinear) budget set B is to specify the
expenditure required to purchase x. Then B = {x ∈ S|R(x; π) ≤ y}, where
y is income and π is a vector characterizing costs that varies with the economic
environment. The neoclassical case is R(x; π) = p · x, with π = p. An impor-
tant application with nonlinear budget sets is study of progressive income taxa-
tion and labor supply; see Burtless and Hausman (1978), Diamond and Mirrlees
(1971), Gan and Ju (2011), Hausman (1985), Moffitt (1990), and tacitly Milgrom
and Segal (2002). In this case, y is the value of endowment income and enti-
tlements when the consumer does not work, R(x; π) gives expenditure on goods
less net after-tax wages, and π describes goods prices, the wage rate, and the in-
come tax schedule. Figure 1 illustrates a typical budget set for this application,


                                          6
with leisure on the horizontal axis, a consumption good on the vertical axis, and
a finite number of income tax brackets so that R(x; π) is piecewise linear and B
is a (non-convex) polytope. Similar budget sets arise under block-rate utility tar-
iffs (McFadden et al., 1978; Nauges and Blundell, 2010), and under tax-qualified
savings programs (Beshears et al., 2010; McFadden, 2010); in the last case, a dis-
crete choice of owning or renting induces distinct nonlinear conditional budget
sets, so B is not necessarily connected. A generalization of the framework above
considers budget sets of the form B(π, q; y) = {x ∈ S|R(x; π) + q · x ≤ y},
where q is a vector of perturbations that behave like prices and can be interpreted
as net commodity-specific excise taxes. The Lagrangian for utility maximization
is L = U (x, t) + m · x + µ[y − q · x − R(x; π)], with a first-order condition
(for an interior maximum when U is differentiable) ∂x U − µ∂x R = µq − m.
The demand generating function V (m; t; q; y; π) is the optimized value of this
Lagrangian. Then singleton market demands satisfy X = ∂m V = −∂q V /∂y V ,
and V satisfies Roy’s identity in (y; q) even though there are additional nonlinear
expenditure elements in the budget. Also, from Theorem 1, X continues to satisfy
the subgradient property of V with respect to m.
    Theorem 1 does not establish regularity properties for the demand correspon-
dence X(m; t, B) other than upper hemicontinuity in (m, t, B), the ACCM, and
almost everywhere single-valuedness and continuous differentiability in m. It is
known from the work of Katzner (1968) and Rader (1973a,b) that strong differen-
tiability and strict concavity conditions on utility are needed in the classical case
to ensure that X is everywhere continuously differentiable in the budget param-
eters. However, we establish that X(m; t, B) is almost everywhere Lipschitz in
t and B under much weaker conditions - smooth utility and a class of polytope
budget sets, defined next, that include economic applications such as labor supply
with progressive income taxes and demand given utility block rate tariffs that have
piecewise linear budget frontiers.

Definition 3 A polytope budget set is a finite union B = ∪K     k
                                                           k=1 C , where each C
                                                                                k

is a convex polytope; i.e., a non-empty compact set contained in S that is formed
by the intersection of an affine subspace (which may be the whole space) and a
finite number of half-spaces. Let W k ≡ {x ∈ Rn |Qk x = wk }, where Qk is ik × n,

                                         7
Goods




        B




                                          Leisure

        Figure 1: A polytope budget set




                      8
denote the affine subspace spanned by C k , and assume that redundant equality
constraints are eliminated so that Qk is of full rank ik . Let {x ∈ Rn |P k x ≤
y k }, where P k is jk × n, denote the intersection of half-spaces that complete the
definition of C k Ck, and exclude from P k any column that is redundant because
the associated half-space contains W k . Then C k has a non-empty interior relative
to W k ; i.e., there exists an x ∈ W k such that P k x < y k . Let β = (β 1 , ..., β K )
denote the finite-dimensional vector with components β k = (Qk , wk , P k , y k ); then
the polytope budget set B is finitely parameterized by β.

     In the classical case of a single linear budget constraint, B is simply the non-
empty intersection of the non-negative orthant and a half-space in which positive
income determines the inequality constraint bound. Hence, in the inequality con-
straints P k x ≤ y k in the definition of C k , y k can be interpreted as a vector of
”generalized income” bounds. Assume that if the inequality constraint bounds y k
define a non-empty polytope C k , then strictly larger vectors y 0k are also econom-
ically possible. Then, the set Y k of economically possible generalized income
bounds has a non-empty interior in Rjk . The role of the assumption that Y k has a
non-empty interior will be to ensure that the constraints Qk x = wk and P k x ≤ y k
fail to satisfy a linear independence constraint qualification for y k on a set of at
most Lebesgue measure zero. In specific applications, it will often be possible to
satisfy this requirement with some components of y k fixed, such as non-negativity
constraints x ≥ 0.
     Polytope budget sets B need not be convex, and if some commodities are
discrete, they need not be connected. The convex polytopes C k that are elements
of B need not be disjoint.
     Any compact budget set B can be approximated arbitrarily closely (in the
Hausdorff set metric topology) by a polytope budget set B 0 . The argument is triv-
ial. A compact set has a finite covering by open neighborhoods of arbitrarily small
diameter. Just take these neighborhoods to be hypercubes. Then, their closures
are convex polytopes, and the closure of the covering is then a polytope budget set
B 0 that contains B.

Corollary 2 Suppose S, U, M , and B satisfy the assumptions of Theorem 1, U (x; t)
is twice continuously differentiable in x, ∇x U (x; t) is Lipschitz in t and ∇xx U (x; t)

                                           9
is continuous in t. Suppose the B ∈ B are polytope budget sets, B = ∪K            k
                                                                             k=1 C ,
with C k a non-empty convex polytope spanning W k ≡ {x ∈ Rn |Qk x = wk },
where Qk is ik × n matrix of rank ik , and P k x ≤ y k with y k in a set Y k ⊆ Rjk
that has a non-empty interior, and let β denote the finite parameterization of B.
Then for almost all (m, y 1 , ..., y K ) ∈ M × Y 1 × · · · × Y K , the demand corre-
spondence X(m, t, β) is a singleton that is continuously differentiable in (m, β)
and locally Lipschitz in t.

Remark We give an elementary direct proof of this corollary in the Appendix.
When U (x, t) is concave in x, a stronger assumption than we have used, the
methods of convex analysis can be applied to establish generic, but not almost
everywhere, regularity without our restriction to polytope budget sets; see Aubin
(1984), Dontchev (1998), Dontchev and Rockafellar (1996), Henrion (1992), Levy
(2001), Klatte and Tammer (1990), Magaril-Il’aev (1978), Robinson (1980), and
Scholtes and Stohr (2001).
    Hausman (1985) discusses the stochastic specification and estimation of econo-
metric models with non-convex budgets, in particular those where the budget can
be represented as a finite union of convex sets. Blomquist and Newey (2002) pro-
pose a nonparametric estimation approach for the case of convex preferences and
convex and piecewise linear budget. Milgrom and Segal (2002) prove a general
envelope theorem and relate that to a range of economic models.


3    Demand generating functions
To guarantee that a demand system derived from a candidate demand generating
function is consistent with utility maximization, one must verify that the candidate
satisfies sufficient conditions to be derivable from maximization of some utility
function. The following result provides such conditions.

Theorem 2 (Converse envelope) Let V (m; t, B) be a continuous function on
M × T × B, that is convex, closed, and nondecreasing in m, where M is a
compact ball and B is a compact subset of the space of non-empty compact
sets in a convex body S ⊆ Rn+ . Define X(m; t, B) = B ∩ ∂m V (m; t, B) and

                                        10
E(t) = ∪(m,B)∈M ×B X(m; t, B). Assume that B ∩ ∂m V (m; t, B) is non-empty,
and that X(m; t, B) and V (m; t, B) satisfy the generating function fundamental
inequality (GFFI).
    Then the function U (x; t) = inf{V (m; t, B)−m·x|(m, B) ∈ M ×B, x ∈ B}
for x ∈ E(t), and U (x; t) = −∞ for x ∈ / E(t), is defined on S × T and continu-
ous on {(x, t)|t ∈ T, x ∈ E(t)}, and satisfies V (m; t, B) = maxx∈B (U (x; t) +
m·x), with X(m; t, B) as its demand correspondence. If E(t) is full, then U (x; t)
is continuous on S × T .

Remark The assumptions of Theorem 2 are conclusions of Theorem 1 when U is
quasiconcave. However, Theorem 2 does not guarantee that E(t) is full or that the
utility it constructs from a candidate demand generating function is quasiconcave,
so these assumptions are not quite necessary and sufficient.
    Lack of a palette of known functions V and composition rules for these func-
tions are a practical limitation to the use of this theorem to construct utility-
consistent demand systems for nonlinear budget sets. For the current general
case, the following results will be somewhat useful in applications such as demand
for goods with block rate tariffs, and labor supply in response to progressive tax
rates. For B ∈ B, define the support function s(p, B) = maxx∈B p · x. Then
for 0 6= p ∈ Rn , {x ∈ Rn |p · x ≤ s(p, B)} is a supporting half-space. If B is
convex, then it is the intersection of its supporting half-spaces. Let w(t, p, y) =
maxx {U (x; t)|p · x ≤ y} denote the indirect utility function of the base utility
function U (x; t). The following corollaries relate demand generating functions to
conventional indirect utility functions; establish that V exhibits a quasiconvexity
property with respect to unions of sets in B which in the case of linear budget
constraints implies the conventional quasiconvexity of the indirect utility function
in income and prices; and give further composition rules.

Corollary 3 Suppose U (x; t) is non-decreasing and locally nonsatiated in x, and
w(t, p, y) is its indirect utility function. The indirect utility function of U (x; t) +
m · x for m ≥ 0 is
                      (                                       !                                          )
                                           X                            X                       X
v(m, t, p, y) = max min
                     0
                        w t, p0 , y ·            θj p0j /pj       +y·       θj mj /pj θj ≥ 0,       θj = 1 .
                          p
                                             j                          j                       j


                                          11
    If U is homogeneous of degree one, and e(t, p) = min{p·x|U (t, x) ≥ 1} is its
unit expenditure function, then v(m, t, p, y) = y ·minp0 maxj (p0j /e(p0 )+mj )/pj .

Corollary 4 If B ∈ B is convex with support function s(p, B), then for m ≥
0, V (m; t, B) ≤ minp∈Rn+ v(m, t, p, s(p; B)). If in addition, U (x; t) is non-
decreasing, locally nonsatiated, and quasiconcave in x, then

                      V (m; t, B) = minn v(m, t, p, s(p; B)).
                                       p∈R+


Corollary 5 (Composition) Demand generating functions combine under the fol-
lowing rules.
    (1) If B, B 0 , B 00 ∈ B and B ⊆ B 0 ∪B 00 , then V (m, t, B) ≤ max{V (m, t, B 0 ), V (m, t, B 00 )}.
    (2) If B j ∈ B for j in an arbitrary index set J, and B = ∪j∈J B j ∈ B, then
V (m, t, B) = supj∈J V (m, t, B j ).
    (3) Suppose Mi is compact ball in Rn+i and Bi is a subset of the family of non-
empty compact sets in Rni for i = 1,2. Suppose that Vi : Mi × T × Bi → R are
demand generating functions. Then, V (m1 , m2 ; t, B1 × B2 ) = V1 (m1 , t, B1 ) +
V2 (m2 , t, B2 ) is a demand generating function on M1 × M2 × T × B1 × B2 .
    (4) If B ∈ B is written as a union over an index set J of convex subsets Bj that
are also in B and if U is non-decreasing, locally non-satiated, and quasiconvex,
then V (m; t, B) = supj∈J V (m; t, Bj ) = supj∈J minp v(m, t, p, s(p; Bj )).

Remark Corollary 3 gives the relationship between the indirect utility functions
of the base utility and the perturbed utility. While this is not in general useful
for construction, it reduces to a practical formula in the special case of homoth-
etic preferences with a utility representation that is homogeneous of degree one.
In Corollary 4, if B is a convex polytope, then it is sufficient in the definition
of V (m; t, B) to consider only convex combinations of the vectors p that are
outward normals to maximal facets of B. An example of a demand generating
function of closed form that might be utilized in Corollary 4 is v(m, t, p, y) =
1
2
  m> Cm − 12 (max(0, p> Cm − y))2 /p> Cp, where C is a positive definite ma-
trix; this is associated with the quadratic utility m · x − 12 x> C −1 x, and range
restrictions on m and y are required for the utility function to be nondecreasing
and locally nonsatiated and for demands to be non-negative.

                                           12
Remark The demand generating function can be used in welfare calculus to de-
termine the net benefit from a policy change, with the net welfare gain (in utiles)
from a move from (t0 , B 0 ) to (t00 , B 00 ) equal to V (m, t00 , B 00 ) − V (m, t0 , B 0 ). Nor-
malizing the utile difference by a marginal utility of money gives a measure that
corresponds to Hicksian consumer surplus.



4       Integrability of demand
We now seek conditions on the demand correspondence X(m; t, B) that guaran-
tee that it can be rationalized by utility U (x; t) + m · x maximized over the set
B.
    If X is the demand correspondence of a utility maximizing consumer and
X (m; t, B) ∩ B 0 6= ∅ then budget B 0 may be revealed preferred to budget B.
Define then for any given demand correspondence a set L consisting of all finite
sequences of (m, x) that connect in a finite number of steps from a given pair
                                    
(ma , B a ) to another pair mb , B b with xj ∈ X (mj ; t, B j ) ∩ B j+1 in each step.

          L ma , B a , mb , B b
                                
          (                                                                 )
            x0 , ..., xJ−1 , m0 , ..., mJ−1 |1 ≤ J < ∞, m0 = ma , mJ = mb ,
        =
              B 0 = B a , B J = B b , ∀j < J : xj ∈ X (mj ; t, B j ) ∩ B j+1

The sets L are convenient in the formulation of the following result.

Theorem 3 (Integrability of demand) Let X (m; t, B) : S × T × B be an up-
per hemicontinuous compact-valued correspondence satisfying the ACCM and
with X (m; t, B) ⊆ B. Assume there exists (m∗ , B ∗ ) ∈ M × B such that
B = {B ∈ B|∃m ∈ M : L (m∗ , B ∗ , m, B) ∪ L (m, B, m∗ , B ∗ ) 6= ∅} . Define
                           ( J−1                                                                                     )
                            X
V 1 (m; t, B) = sup                 mj+1 − m     j
                                                         · xj | x0 , ..., xJ−1 , m0 , ..., mJ−1 ∈ L (m∗ , B ∗ , m, B) ,
                                                                                              
                              j=0
                           ( J−1                                                                                            )
                            X
    2                                  j+1       j          j    0          J−1      0       J−1                   ∗   ∗
                                                                                                  
V (m; t, B) = sup                   m        −m          · x | x , ..., x         , m , ..., m         ∈ L (m, B, m , B )
                              j=0




                                               13
and V (m; t, B) = max{V 1 (m; t, B), −V 2 (m; t, B)}. Then V (m; t, B) > −∞,
and X (m; t, B) ⊆ B ∩ ∂m V (m; t, B). Assume further that X (m; t, B) = B ∩
∂m V (m; t, B) and that V is continuous on M × T × B. Then V satisfies the
conditions of Theorem 2.

Remark Recall that Theorem 2 establishes the existence of perturbed utility hav-
ing V is its DGF and hence rationalizing the demand X. As was also remarked
after Theorem 2, the condition that X (m; t, B) = B ∩ ∂m V (m; t, B) is a con-
clusion of Theorem 1 when U is quasiconcave.
    Theorem 3 supposes that for any B ∈ B there is an m ∈ M and a path in L
connecting (m, B) to (m∗ , B ∗ ). This condition may be relaxed, for example if
B can be divided into subsets where the budgets only overlap within subsets and
where the subsets may be separated by open sets. In such a case, the Theorem
could be used to construct DGF separately for each subset with corresponding
utilities for each of these islands.



5    Example - Gorman polar form
Suppose base preferences are described by a Gorman (1961) polar form: U (x; t)
is obtained from a neoclassical indirect utility function

                                           y − C (p; t)
                           v(p, y, t) =                 ,
                                             A(p; t)

where committed expenditure C(p; t) and the price index A(p; t) are concave,
non-decreasing, and linear homogeneous in p. Then,
                                                            
                                           x · p − C(p; t)
                      U (x; t) = min                             .
                                  p            A(p; t)




                                       14
From this base utility, and for a convex compact budget B the perturbed consumer
DGF is

         V (m; t, B) = max{U (x; t) + m · x}
                       x∈B
                                                             
                                             p         C (p; t)
                     = max min x · m +               −            .
                       x∈B p               A(p; t)     A(p; t)
                                
                             p
But the function x · m + A(p;t)    − C(p;t)
                                     A(p;t)
                                            is linear, hence concave, in x and so
long as p · x > C(p; t), quasi-convex in p. Then by the Sion (1958) saddle point
theorem, the max and min can be reversed, giving
                                                                        
                                               p                C (p; t)
          V (m; t, B) = min R m +                    ;B       −                ,
                             p               A(p; t)            A(p; t)

where R(p; B) = maxx∈B {p · x} is the convex linear homogeneous maximum
revenue function for B.
     Then, a practical way to generate the demand systems from nonlinear budgets
is to first specify the Gorman committed expenditure function C(p; t), and second
to calculate the revenue function R(p; B). The next step is to compute V (m; t, B)
by minimizing R(m + p/A(p; t); B) − C(p/A(p; t); t) in p. If the committed
expenditure function is piecewise linear, the price index A(p) is linear, and B is
a convex polytope budget set, then the third stage is a finite (linear programming)
calculation. Finally, for budgets that are unions of convex budgets, B = ∪j Bj ,
the DGF is the maximum of the DGF over the convex budgets V (m; t, B) =
maxj V (m; t, Bj ) (Corollary 5).


6    Conclusion
This paper has contributed by characterizing demands and demand generating
functions that are consistent with maximization of linearly perturbed utility under
general compact, not necessarily convex budgets. Results are provided to assist
the development of such models for applications.
    The demand generating function defined and characterized in this section takes
a particularly simple form in applications with discrete budget sets. Suppose S is

                                        15
the set of vertices of the unit simplex in Rn , and B is any non-empty subset of
these points. Suppose U (x; t) : S × T → R is a continuous utility function
that is random, reflecting unobserved heterogeneity across consumers. Consider
the demand generating function V (m; t, B) = maxx∈B {U (x; t) + m · x}. If
the distribution of utilities is absolutely continuous, so that the probability of ties
is zero, then with probability one, its subdifferential ∂m V (m; t, B) is a unique
utility-maximizing vertex of B. Hence, the expected demand generating function
EV (m; t, B) has a differential ∂m EV (m; t, B) whose components are the prob-
abilities that each of the alternatives in B will be chosen. Fosgerau et al. (2010)
elaborates the properties of such choice probability generating functions.


References
Alexandroff, A. D. (1939) Almost everywhere existence of the second differential
  of a convex function and surfaces connected with it Leningrad State University
  Annals, Mathematics Series 6, 3–35.

Aliprantis, C. D. and Border, K. C. (2006) Infinite Dimensional Analysis: A Hitch-
  hiker’s Guide 3rd. edn Springer-Verlag Berlin Heidelberg.

Aubin, J. P. (1984) LIPSCHITZ BEHAVIOR OF SOLUTIONS TO CONVEX
  MINIMIZATION PROBLEMS Mathematics of Operations Research 9(1), 87–
  111.

Beshears, J., Choi, J., Laibson, D. and Madrian, B. (2010) The Impact of Em-
  ployer Matching on Savings Plan Participation under Automatic Enrollment
  Research findings in the economics of aging The University of Chicago Press
  Chicago pp. 311–327.

Birge, J. R. and Murty, K. G. (1994) Mathematical programming: State of the art
  1994 Univ. of Michigan Ann Arbor, MI (United States).

Blomquist, S. . and Newey, W. (2002) Nonparametric Estimation with Nonlinear
  Budget Sets Econometrica 70(6), 2455–2480.



                                          16
Burtless, G. and Hausman, J. (1978) The Effect of Taxation on Labor Supply:
  Evaluating the Gary Negative Income Tax Experiment Journal of Political
  Economy 86, 1103–1130.

Crouziex, J.-P. and Lindberg, P. (1986) Additively Decomposed Quasiconvex
  Functions Mathematical Programming 35, 42–57.

Diamond, P. A. and Mirrlees, J. A. (1971) Optimal Taxation and Public Production
  II: Tax Rules The American Economic Review 61(3), 261–278.

Diewert, E. (1974) Applications of Duality Theory in M. Intriligator and
  D. Kendrick (eds), Frontiers of Quantitative Economics North Holland Ams-
  terdam.

Dontchev, A. (1998) A Proof of the Necessity of Linear Independence Condi-
  tion and Strong Second-Order Sufficient Optimality Condition for Lipschitzian
  Stability in Nonlinear Programming Annals of Optimization Theory and Appli-
  cations pp. 467–473.

Dontchev, A. and Rockafellar, R. T. (1996) Characterizations of Strong Regular-
  ity for Variational Inequalities over Polyhedral Convex Sets SIAM Journal on
  Optimization 6(4), 1087–1105.

Eustaquiro, R., Karas, E. and Ribeiro, A. (2007) Constraint Qualifications for
  Nonlinear Programming Working Paper .

Fosgerau, M., McFadden, D. L. and Bierlaire, M. (2010) Choice probability gen-
  erating functions Munich Personal RePEc Archive .

Gan, L. and Ju, G. (2011) Nonparametric estimation of Structural Labor Supply
  and Exact Welfare Change under Non-Convex Piecewise Linear Budget Sets
  Working Paper .

Gorman, W. M. (1961) On a Class of Preference Fields Metroeconomica
  13(2), 53–56.

Hausman, J. A. (1985) The Econometrics of Nonlinear Budget Sets Econometrica
  53(6), 1255–1282.

                                      17
Henrion, R. (1992) On constraint qualifications Journal of Optimization Theory
  and Applications 72(1), 187–197.

Howard, R. (1998) Alexandrov’s theorem on the second derivatives of convex
  functions via Rademacher’s theorem on the first derivatives of Lipschitz func-
  tions On-line lecture note Department of Mathematics, University of South Car-
  olina, Columbia, South Carolina.

Katzner, D. (1968) A Note on the differentiability of Demand Functions Econo-
  metrica 36, 415–418.

Klatte, D. and Tammer, K. (1990) Strong stability of stationary solutions and
  Karush-Kuhn-Tucker points in nonlinear optimization Annals of Operations
  Research 27(1), 285–307.

Levy, A. B. (2001) Lipschitzian Multifunctions and a Lipschitzian Inverse Map-
  ping Theorem Mathematics of Operations Research 26(1), 105–118.

Luderer, B., Minchenko, L. and Satsura, T. (2002) Multivalued Analysis and Non-
  linear Programming Problems with Perturbations Kluwer Academic Publish-
  ers.

Magaril-Il’aev, G. (1978) The Implicit Function Theorem for Lipschitz Maps Rus-
 sian Math.Surveys 33(1), 209–210.

Mas-Colell, A., Whinston, M. and Green, J. (1995) Microeconomic Theory Ox-
 ford Press Oxford.

Matzkin, R. L. (1991) Axioms of Revealed Preference for Nonlinear Choice Sets
 Econometrica 59(6), 1779–1786.

Matzkin, R. L. and McFadden, D. L. (2011) Trembling payoff market games
 Working Paper .

McFadden, D. (2010) The Impact of Employer Matching on Savings Plan Partic-
 ipation under automatic Enrollment: Comment Research Findings in the Eco-
 nomics of Aging, pp. 327–335.


                                      18
McFadden, D. L. and Richter, M. (1990) Stochastic Rationality and Revealed
 Stochastic Preference in J. Chipman, D. L. McFadden and M. Richter (eds),
 Preferences, Uncertainty, and Optimality: Essays in honor of Leonid Hurwicz
 Westview Press Boulder and Oxford pp. 161–186.

McFadden, D., Puig, C. and Kirschner, D. (1978) Determinants of the Long-Run
 Demand for Electricity Proceedings of the American Statistical Association .

Milgrom, P. and Segal, I. (2002) Envelope Theorems for Arbitrary Choice Sets
 Econometrica 70(2), 583–601.

Moffitt, R. (1990) The Econometrics of Kinked Budget Constraints The Journal
 of Economic Perspectives 4(2), 119–139.

Nauges, C. and Blundell, R. (2010) Estimating Residential Water Demand Under
  Block Rate Pricing: A Nonparametric Approach Working Paper .

Rademacher, H. (1919) ber partielle und totale differenzierbarkeit von Funktionen
  mehrerer Variabeln und ber die Transformation der Doppelintegrale Mathema-
  tische Annalen 79(4), 340–359.

Rader, T. (1973a) Absolutely continuous Constrained Maximizers Journal of Op-
  timization Theory and Applications 12, 107–128.

Rader, T. (1973b) Nice Demand Functions Econometrica 41, 913–935.

Richter, M. (1966) Revealed Preference Theory Econometrica 34, 635–645.

Robinson, S. M. (1980) Strongly Regular Generalized Equations Mathematics of
  Operations Research 5(1), 43–62.

Rockafellar, R. (1970) Convex analysis Princeton University Press Princeton, N.J.

Scholtes, S. and Stohr, M. (2001) How Stringent Is the Linear Independence
  Assumption for Mathematical Programs with Complementarity Constraints?
  Mathematics of Operations Research 26(4), 851–863.

Sion, M. (1958) On general minimax theorems. Pacific Journal of Mathematics
  8(1), 171–176.

                                       19
Varian, H. (1993) Microeconomic Analysis Norton New York.



A     Proofs
Lemma 1 Let m be contained in the closed ball M = {m ∈ Rn |kmk ≤ c} for
some c > 0. If U (x; t) + m · x is quasiconcave in x for all m and c is sufficiently
large, then U (x; t) and U (x; t) + m · x are concave in x.

Proof. Suppose U (x; t) + m · x is quasiconcave in x for all m ∈ M . For x0 6= x00
and θ ∈ (0, 1), define xθ = θx0 + (1 − θ)x00 . Then



        U (xθ , t) + m · xθ ≥ min{U (x0 ; t) + m · x0 , U (x00 ; t) + m · x00 },

implying

      U (xθ , t) − θU (x0 , t) − (1 − θ)U (x00 , t)
  ≥ min{(1 − θ)(U (x0 , t) − U (x00 , t) + m · (x0 − x00 )), θ(U (x00 , t) − U (x0 , t) + m · (x00 − x0 ))}.

Take m = −(x0 − x00 )(U (x0 , t) − U (x00 , t))/kx0 − x00 k2 to obtain U (xθ , t) −
θU (x0 , t) − (1 − θ)U (x00 , t) ≥ 0. When the ball M is of sufficient radius to
contain all such m, the inequality proves that U (x, t) is concave in x. Since the
sum of concave functions is concave, U (x, t) + m · x is concave in x.
    For more general theory of quasiconcave sums, see Crouziex and Lindberg
(1986).

Proof of Theorem 1. The conclusions of this theorem are well-known with
standard proofs in the linear budget case, and the extension to demand generating
functions in the case of nonlinear budgets is straightforward. However, for com-
pleteness we give a full proof. It has already been shown, in the text preceding the
statement of this theorem, the [Cond. V] claim that V and X satisfy GFFI, and
hence the [Cond. X] claim that X satisfies the ACCM.



                                           20
    Since B is a metric space with the Hausdorff set metric, the Berge maximum
theorem (AB 17.31) and AB 17.35(2) establish that X(m; t, B) is a compact-
valued, upper hemicontinuous correspondence from M × T × B into S and that V
is continuous in its arguments. The correspondence E(t) is compact-valued (AB
17.8) and upper hemicontinuous.
    Suppose m0 = θm0 + (1 − θ)m00 for some 0 < θ < 1, x0 ∈ X(m0 ; t, B).
Then V (m0 ; t, B) ≥ U (x0 ; t) + m0 · x0 and V (m00 ; t, B) ≥ U (x0 ; t) + m00 · x0 ,
implying θV (m0 ; t, B)+(1−θ)V (m00 ; t, B) ≥ U (x0 ; t)+m0 ·x0 = V (m0 ; t, B),
proving convexity. If mj → m0 and xj ∈ X(mj ; t, B), by upper hemicontinu-
ity there exists a subsequence (retain notation) xj → x0 ∈ X(m0 ; t, B). Then
V (mj ; t, B) ≥ U (x0 ; t, B) + mj · x0 → V (m0 ; t, B), proving that the epi-
graph of V is closed. If m0 ≥ m00 and x00 ∈ X(m00 ; t, B), then V (m0 , t, B) ≥
U (x00 ; t) + m0 · x00 ≥ U (x00 ; t) + m00 · x00 = V (m00 ; t, B), proving that V is
nondecreasing in m, completing the proof of [Cond. V].
    The convexity and closure of V in m implies that the subdifferential ∂m V (m; t, B)
exists and is non-empty, convex-valued, and compact-valued (AB 7.13). If (mj ; tj , B j ) →
(m0 ; t0 , B 0 ), xj ∈ ∂m V (mj ; tj , B j ), and xj → x0 , then for each m0 , V (m0 ; tj , B j )−
V (mj ; tj , B j ) ≥ xj · (m0 − mj ), implying by continuity that V (m0 ; t0 , B 0 ) −
V (m0 ; t0 , B 0 ) ≥ x0 · (m0 − m0 ); then ∂m V is upper hemicontinuous. If x ∈
X(m; t, B), then V (m0 ; t, B) ≥ U (x; t)+m0 ·x and V (m; t, B) = U (x; t)+m·x
imply V (m0 ; t, B) − V (m; t, B) ≥ x · (m0 − m), and hence X(m; t, B) ⊆
∂m V (m; t, B). Since ∂m V (m; t, B) is convex, [X(m; t, B)] ⊆ ∂m V (m; t, B).
    Suppose x∗ ∈ ∂m V (m; t, B) \ [X(m; t, B)]. Then there exists a separating
hyperplane with normal q satisfying q · x∗ > q · x for all x ∈ X(m; t, B).
Also, V (m + λq; t, B) − V (m; t, B) ≥ λq · x∗ . Consider λ ↓ 0, and xλ ∈
X(m+λq; t, B). Then, V (m; t, B)−V (m+λq; t, B) ≥ −λq·xλ . Adding these
inequalities, 0 ≥ λq · (x∗ − xλ ). There exists a subsequence (retain notation) of
xλ that converges to a point x0 , which by upper hemicontinuity of X is contained
in X(m; t, B). Then, q · x∗ ≤ q · x0 , a contradiction. Hence, ∂m V (m; t, B) =
[X(m; t, B)]. Then x ∈ [X(m; t, B)]∩B can be written as a convex combination
       Pn           j            j                             j              j
x =        j=0 θj x of points x ∈ X(m; t, B), so U (x ; t) + m · x is the same
for all j. If U is quasiconcave, then U (x; t) + m · x ≥ minj (U (xj ; t) + m ·
          Pn
xj ) ≡                   j                j
             j=0 θj (U (x ; t) + m · x ), implying x ∈ X(m; t, B). Finally if, in


                                           21
addition to quasiconvexity of U , B is convex, then [X(m; t, B)] ⊆ B, implying
that [X(m; t, B)] = X(m; t, B)) = ∂m V (m; t, B).
    The almost everywhere twice continuous differentiability of V in m, with a
symmetric positive semidefinite second derivative, is established by Alexandroff
(1939); see also Rockafellar (1970), Howard (1998, Theorem 7.1), and AB 7.25
& 7.28. Then, X(m; t, B) is almost everywhere (in m) a singleton that is contin-
uous and continuously differentiable with ∇m X(m; t, B) symmetric and positive
semidefinite.


Proof of Corollary 1. Let λ be the Lipschitz constant for U , and let it also bound
S. If B k → B 0 , tk → t0 , mk → m0 , xk is a maximand of U (x, tk ) + mk · x
on B k , xk0 is a point in B k closest to x0 , and x0k is a point in B 0 closest to
xk , then V (mk ; tk , B k ) = U (xk ; tk ) + mk · xk ≥ U (xk0 ; tk ) + mk · xk0 ≥
U (x0 ; t0 ) + m0 · x0 − λ(η(tk , t0 ) + h(B k , B 0 ) + kmk − m0 k) = V (m0 , t0 , B 0 ) −
λ(η(tk , t0 )+h(B k , B 0 )+kmk −m0 k) and V (m0; t0 , B 0 ) = U (x0 , t0 )+m0 ·x0 ≥
U (x0k , t0 ) + m0 · x0k ≥ V (mk ; tk , B k ) − λ(η(tk , t0 ) + h(B k , B 0 ) + kmk − m0 k).
Then V is Lipschitz in its arguments.

Proof of Corollary 2. For each (t, β), Theorem 1 applied to a single convex poly-
tope C k in the union that forms B establishes that the maximand correspondence
X k (m, t, β k ) is for almost every m ∈ M , say m0 , a singleton that is continuous
and continuously differentiable in m at m0 . Define the Lagrangian

 L(x, t, m, β k , λ, µ) = U (x, t) + m0 · x + (wk − Qk x)> λk + (y k − P k x)> µk .

    By the Karush-Kuhn-Tucker Theorem applied to maximization of a continu-
ously differentiable function subject to linear constraints, at (x0 , m0 , t, β k ) there
exist multipliers λk0 and µk0 such that the following Lagrangian necessary (local
KKT) conditions hold; see Eustaquiro et al. (2007, Theorem 3.3), for a simple




                                            22
polar cone proof of this standard result.

                  ∇x U (x0 , t) + m0 − Qk> λk0 − P k> µk0 = 0
                                                  wk − Qk x0 = 0
                                                   y k − P k x0 ≥ 0
                                                           µk0 ≥ 0
                                           (y k − P k x0 )> µk0 = 0

The convex polytope C k is the union of a finite number of facets, each defined as
                                                                                      .
the set of x satisfying Qk x = wk , P1k x = y1k , and P2k x < y2k , where P k = [P1k ..P2k ]
is a partition of the columns of P k , y k is partitioned commensurately, Qk is ik n,
                                                                                  .
and P1k is rk × n. By construction, Qk> is of full column rank. If [Qk> ..P1k> ] is
                                                                         . k> .. k>
not of full column rank, then there exists a further partition [Qk> ..P11      .P12 ] such
           .
that [Qk> ..P11
              k>
                 ] is of full column rank and P12 k>
                                                     = Qk> Λ + P11   k>
                                                                        Γ for some linear
                                                            >
combinations Λ, Γ. Pre-multiply this equality by x for any x in the relative
                                    k>     k>       k>
interior of the facet to obtain y12    = w12  Λ + y11  Γ. Then, the set of y k ∈ Y k such
           .
that [Qk> ..P k> ] is not of full column rank is contained in an affine subspace of Rjk
             1
of dimension less than jk , and hence of Lebesgue measure zero. This is true for
each facet, implying that except for a set of y k ∈ Y k of Lebesgue measure zero,
the active constraints Qk x = wk and P1k x = y1k at any x ∈ C k will satisfy the
                                                        .
linear independence constraint qualification that [Qk> ..P1k> ] is of full column rank
                                                                   .           .
ik +rk . Then the system of equations ∇x U (x0 ; t)+m0 = [Qk> ..P k> ][λk0> ..µk0> ]>
has a unique solution λk0 = Λk (m; t, β k ) and µk0 = Γk (m; t, β k ), with µk0 2 = 0,
in a neighborhood of m0 , and this solution is locally continuously differentiable
in m. Then, the KKT conditions are differentiable in m at m0 and satisfy
                                                                            
   ∇xx U (X k (m; t, β k ); t) −Qk> −P1k>        ∇m X k (m; t, β k )      −Inn
            −Qk                0 ik ik 0ik rk   ∇m Λk (m; t, β k )  =  0ık n  ,
                                                                            
 
            −P1k               0rk ik  0rk rk     ∇m Γk1 (m; t, β k )      0rk n

where ik is the number of rows of Qk , and rk is the number of rows of P1k . The
existence of the derivatives then implies that the bordered hessian on the left-hand-
side of these linear equalities is non-singular. Therefore, differentiating the KKT

                                            23
conditions with respect to yjk for an active constraint j gives

                                                                     
                                                ∇yjk X k (m; t, β k )
                                                                                  
  ∇xx U (X k (m; t, β k ); t) −Qk> −P1k>                                    0n1
                                                      k         k 
                                                                       
           −Qk                0 ik ik 0ik rk   ∇   k Λ (m; t, β )
                                                                       =  0ık 1  ,
                                                                                  
                                               j y
           −P1k               0rk ik  0rk rk     ∇yk Γk1 (m; t, β k )      −1rk ,j
                                                      j



where 1rk ,j is an rk × 1 unit vector with a one in the jth component, and differen-
tiating with respect to the associated column j in P1k gives
                                                                       
                                                 ∇P1k j X k (m; t, β k )
                                                                                                
 ∇xx U (X k (m; t, β k ); t) −Qk> −P1k>                                     In,j Γk1 ( t, β k )>
                                                       k          k
                                                                         
          −Qk                0 ik ik 0 ik r k   ∇   k Λ (m; t, β )  =          0 ık r k
                                                                                                
                                                1jP                                           
              k                                          k          k        k              k
          −P1                0rk ik  0rk rk       ∇P k Γ1 (m; t, β )       Xj (m; t, β )Irk rk
                                                     1j



Hence, all the derivatives in the linear equalities above exist and are continuous at
m0 . Analogous formulas hold for derivatives with respect to wk and columns of
Qk . The inactive constraints have ∇P2k j X k (m; t, β k ) ≡ 0.
    Finally, consider a shift from t to t0 . The KKT conditions in the two cases are

 ∇x U (x0 ; t) + m0 − Qk> λk0 − P1k> µk0
                                       1    = 0 ∇x U (x0 ; t0 ) + m0 − Qk> λk0 − P1k> µk01    =0
                               k     k 0                                        k      k 0
                            w −Q x          =0                               w −Q x           =0
                             y1k − P1k x0   =0                                y1k − P1k x0    ≥0
                                     µk0
                                       1    ≥0                                          µk0
                                                                                         1    ≥0
                             y2k − P2k x0   <0                         (y1k − P1k x0 )> µk0
                                                                                         1    =0

where P1k corresponds to the active constraints at x0 . For small changes in t,
no previously inactive constraints can become active. Some previously active
constraints can become inactive, but that is accommodated in the KKT conditions
by making the corresponding components of µk0    1 zero. The assumption that ∇x U
is Lipschitz in t implies ∇x U (x; t ) − ∇x U (x; t) = O(η(t0 , t)), where η(t0 , t) is
                                    0

the metric distance between t and t0 . Then, differencing the KKT conditions,
                                                             
            ∇xx U (x00 ; t) −Qk> −P1k>        ∆x      O(η(t0 , t))
               −Qk          0ik ik 0ik rk   ∆λ  =  0ik 1 
                                                             
           
               −P1k         0rk ik 0rk rk    ∆µ1        0rk 1


                                          24
where x00 is between x and x0 . As t0 → t, the upper hemicontinuity of X k (m; t, β k )
implies x0 → x, and hence the bordered hessian remains non-singular for t0 in a
neighborhood of t. Therefore, ∆x = O(η(t0 , t)), and X k is Lipschitz in t.
    Now consider B = ∪K           k                                     k        k
                             k=1 C , and X(m; t, β) = argmaxk {U (X (m; t, β ), t)+
m · X k (m; t, β k )}. From the argument above, the linear independence constraint
qualification is satisfied at each x ∈ C k on a set y k ∈ Y k of full measure. Ap-
plying Theorem 1, to B and to each C k separately, the maximizers X k (m, t, β k )
and X(m, t, β) are all singletons on a set of m ∈ M of full measure. Sup-
pose m0 is a point where all these maximizers are singletons. For each k, ei-
ther U (X k (m0 ; t, β k ); t) + m0 · X k (m0 , t, β k ) < U (X(m0 ; t, β); t) + m0 ·
X(m0 ; t, β), in which case ∇β k X(m0 ; t, β) ≡ 0, or else U (X k (m0 ; t, β k ); t) +
m0 · X k (m0 ; t, β k ) = U (X(m0 ; t, β); t) + m0 · X(m0 ; t, β), in which case
X k (m0 ; t, β k ) = X(m0 , t, β), since X(m0 , t, β) is a singleton. The earlier argu-
ment establishes that each X k (m0 ; t, β k ) satisfying the second case is Lipschitz
in β k and t. Therefore X(m0 ; t, β) is Lipschitz in β k and t, and, by Rademacher
(1919) (see Howard, 1998, Theorem 7.1), is therefore almost everywhere dif-
ferentiable in β. This completes the proof that the maximand correspondence
is continuously differentiable in β and Lipschitz in t, almost everywhere (w.r.t.
M × Y 1 × · · · × Y K ), in the case of a function U (x; t) that is twice continuously
differentiable in x, and a polytope budget set.


Proof of Theorem 2. From the convexity of V , ∂m V (m; t, B) is a convex-
valued upper hemicontinuous correspondence, implying that B ∩ ∂m V (m; t, B)
is an upper hemicontinuous mapping, assumed non-empty, that admits a selection
X(m; t, B) that is an upper hemicontinuous correspondence. The compactness of
M × B implies that E(t) is a compact-valued upper hemicontinuous correspon-
dence. Define U (x; t) = min{V (m; t, B) − m · x|(m, B) ∈ M × B : x ∈ B}
for x ∈ E(t), and U (x; t) = −∞ for x ∈  / E(t). By the Berge maximum theorem
(AB 17.31), U is continuous for x ∈ E(t).
    If x ∈ E(t), then by construction there exist (m, B) ∈ M × B with x ∈ B
such that U (x; t) = V (m; t, B)m · x ≤ V (m00 ; t, B 00 ) − m00 · x for all m00 ∈ M
and all B 00 ∈ B that have x ∈ B 00 . Taking B 00 = B, this inequality implies that


                                         25
x ∈ B ∩ ∂m V (m; t, B) = X(m; t, B). Suppose x00 ∈ B ∩ E(t). Then there
exist (m00 , B 00 ) ∈ M × B such that x00 ∈ X(m00 ; t, B 00 ). By Assumption (ii), if
x00 ∈ X(m; t, B), then U (x00 ; t) = V (m00 ; t, B 00 )−m00 ·x00 = V (m; t, B)−m·x =
U (x; t), and if x00 ∈ / X(m; t, B), then U (x00 ; t) = V (m00 ; t, B 00 ) − m00 · x00 <
V (m; t, B) − m · x = U (x; t). Finally, if x00 ∈ B and x00 ∈    / E(t), then U (x; t) >
U (x ; t) = −∞. Then, U (x ; t)+m·x is maximized in B at x0 ∈ B if and only if
     00                        0          0

x0 ∈ X(m; t, B), and maxx0 ∈B (U (x0 ; t)+m·x0 ) = U (x; t)+m·x = V (m; t, B)
for x ∈ X(m; t, B). Then, V is the demand generating function for U , and
X(m; t, B) is the associated demand correspondence.
    Suppose tj → t0 , xj ∈ E(tj ), and xj → x0 . The definition and upper hemi-
continuity of E imply there exist (mj , B j ) ∈ M ×B with xj ∈ X(mj ; tj , B j ) that
have a convergent subsequence (retain notation) to (m0 , B 0 ) ∈ M × B, and x0 ∈
X(m0 ; t0 , B 0 ). Then U (xj ; tj ) = V (mj ; tj , B j ) − mj · xj → V (m0 ; t0 , B 0 ) −
m0 · x0 = U (x0 ; t0 ) by the continuity of V , and U is continuous on S × T .

Proof of Corollary 3. Define U ∗ (x; t) = inf p6=0 w(t, p, p · x); then U ∗ is the
quasiconvex hull of U ; e.g., the upper contour sets of U ∗ are the convex hulls of
the upper contour sets of U , and U ∗ (x; t) ≥ U (x; t). Define v ∗ (m; t, p, y) =
maxx {U ∗ (x; t) + m · x|p · x ≤ y}, and let x∗ denote a maximizer. Then
v ∗ (m; t, p, y) ≥ v(m; t, p, y), and there exists a linear combination x∗ = nj=0 θj xj
                                                                            P

of points xj (not necessarily all distinct) such that θj > 0, nj=0 θj = 1, and
                                                                  P

U ∗ (x∗ ; t) + m · x∗ = U (xj ; t) + m · xj . For at least one j, p · xj ≤ y.
Then, v(m; t, p, y) ≥ U (xj ; t) + m · xj = v ∗ (m; t, p, y). Then v(m; t, p, y) =
maxx {inf p6=0 w(t, p0 , p0 · x) + m · x|p · x ≤ y}. Rewrite points in the simplex
{x ≥ 0|p · x = y} as linear combinations of the vertices y/pj to obtain the final
form v(m, t, p, y) = max{minp0 w(t, p0 , y · j θj p0j /pj ) + y · mj θj mj /pj |θj ≥
                                                 P
    P
0, j θj = 1}. When U is homogeneous of degree one with unit expenditure
function e(t, p), w(t, p, y) = y/e(t, p), and one obtains the simplified form
v(m, t, p, y) = y · minp0 maxj (p0j /e(p0 ) + mj )/pj , where the order of minimum
and maximum can be reversed since the function is convex in p0 and concave in
x.

Proof of corollary 4. B ⊆ {x ∈ Rn |p · x ≤ s(p, B)} implies V (m; t, B) ≤
v(m; t, p, s(p, B)). If U is locally non-satiated and quasiconcave, any maximizer

                                           26
x∗ in B of U (x; t) + m · x is exposed, and there exists a hyperplane containing x∗
that separates B and the upper contour set of U (x; t)+m·x. If p∗ ≥ 0 is a normal
to this hyperplane, V (m; t, B) = U (x∗ ; t) + m · x∗ = v(m; t, p∗ , s(p∗ , B)).

Proof of Corollary 5. (1) If x ∈ X(m, t, B) and B ⊆ B 0 ∪ B 00 , then x is in
either B 0 or B 00 , implying either V (m, t, B 0 ) ≥ U (x; t) + m · x = V (m, t, B) or
V (m, t, B 00 ) ≥ U (x; t) + m · x = V (m, t, B).
    (2) Evidently, V (m; t, B j ) ≤ V (m; t, B) for all j. The set B is compact such
that V (m; t, B) = U (x; t) + m · x for some x ∈ B. Then there exists j such that
V (m; t, B j ) ≥ U t(x; t) + m · x = V (m, t, B).
    (3)

         sup{U1 (x1 ; t) + m1 · x1 + U2 (x2 ; t) + m2 · x2 |(x1 , x2 ) ∈ B1 × B2 }
  = sup{U1 (x1 , t) + m1 · x1 |x1 ∈ B1 } + sup{U2 (x2 , t) + m2 · x2 |x2 ∈ B2 }.

      (4) This result is an immediate consequence of result (2) and Corollary 4.


Corollary 6 Assume the conditions of Theorem 1. Let utility be written as U (x; t) =
ft (U0 (x; t)), where for each t, ft is differentiable and strictly increasing. Then
U0 rationalizes choices at m = 0 and

(1)      0 = ft0 (U0 (X(m; t, B)))∇x U0 (X(m; t, B); t) · ∇m X(m; t, B)
                 +m · ∇m X(m; t, B) a.e.(m).

Proof. For almost all m, X(m; t, B) is a singleton, ∂m V (m; t, B) = X(m; t, B)
and V (m; t, B) is differentiable at m. Differentiate the identity

              V (m; t, B) = ft (U0 (X(m; t, B); t)) + m · X(m; t, B),

to find that a.e. (m)

X(m; t, B) = ft0 (U0 (X(m; t, B); t))∇x U0 (X(m; t, B); t) · ∇m X(m; t, B)
                     +X(m; t, B) + m · ∇m X(m; t, B).


                                           27
The conclusion follows.

Proof of Theorem 3. Let x ∈ X (m; t, B) and consider any m0 ∈ M ; then
V (m0 ; t, B) ≥ (m0 − m)·x+V (m; t, B) and hence X (m; t, B) ⊆ ∂m V (m; t, B).
It also follows that V (m0 ; t, B) > −∞ if V (m; t, B) > −∞ and by assump-
tion there exists such an m. By Rockafellar (1970, Thm. 24.8) and the fact that
S ⊂ Rn+ , it follows that V is convex, closed, and nondecreasing in m. It re-
mains to show that X (m; t, B) and V (m; t, B) satisfy the GFFI. Consider then
x0 ∈ B 1 ∩ X (m0 ; t, B 0 ) . It must be shown that

                V m1 ; t, B 1 − V m0 ; t, B 0 ≥ m1 − m0 · x0
                                                     


with equality if x0 ∈ X (m1 ; t, B 1 ) . But if x0 ∈ B 1 ∩ X (m0 ; t, B 0 ) then

       V m1 ; t, B 1 − V m0 ; t, B 0
                                    

     = V m1 ; t, B 1 − V m1 ; t, B 0 + V m1 ; t, B 0 − V m0 ; t, B 0
                                                               

     ≥ m1 − m1 · x0 + m1 − m0 · x0 .
                                    


If also x0 ∈ X (m1 ; t, B 1 ) then we obtain the reverse inequality and the desired
conclusion follows.




                                          28
